{"version":3,"sources":["assets\\Script\\Controller\\GraphicsContro.js"],"names":["cc","Class","Component","properties","graphics","line_point","Vec2","onLoad","node","width","height","getComponent","Graphics","currentDrawTime","start","window","PointPos","v2","onTouch","on","Node","EventType","TOUCH_START","touch_start","TOUCH_MOVE","touch_move","TOUCH_END","touch_end","TOUCH_CANCEL","offTouch","off","event","StateForJs","isCanDraw","isToStore","pos","convertToNodeSpaceAR","getLocation","isStartDraw","moveTo","x","y","push","lineTo","updateStrokeColor","stroke","isTouchWall","isDraw","clear","simplifiedPoints","simplifyPath","createRigibody","strokeColor","Color","RED","BLACK","rigibodyLogic","addComponent","RigidBody","gravityScale","physicsLine","lineWidth","points","friction","density","tag","apply","tolerance","length","sqTolerance","undefined","simplifyDouglasPeucker","len","ArrayConstructor","Uint8Array","Array","markers","first","last","stack","newPoints","i","maxSqDist","sqDist","index","getSqSegDist","pop","p","p1","p2","dx","dy","t","checkIsCanDraw","lastPoint","nowPoint","sub","mag"],"mappings":";;;;;;AAAA;;AAEAA,EAAE,CAACC,KAAH,CAAS;AACL,aAASD,EAAE,CAACE,SADP;AAGLC,EAAAA,UAAU,EAAE;AACRC,IAAAA,QAAQ,EAAE,IADF;AAERC,IAAAA,UAAU,EAAE,CAACL,EAAE,CAACM,IAAJ;AAFJ,GAHP;AASLC,EAAAA,MATK,oBASI;AACL,SAAKC,IAAL,CAAUC,KAAV,GAAkB,IAAlB;AACA,SAAKD,IAAL,CAAUE,MAAV,GAAmB,IAAnB;AACA,SAAKN,QAAL,GAAgB,KAAKO,YAAL,CAAkBX,EAAE,CAACY,QAArB,CAAhB;AACA,SAAKC,eAAL,GAAuB,CAAvB;AACH,GAdI;AAiBLC,EAAAA,KAjBK,mBAiBG;AACJC,IAAAA,MAAM,CAACC,QAAP,GAAkBhB,EAAE,CAACiB,EAAH,CAAM,CAAC,EAAP,EAAW,EAAX,CAAlB;AACA,SAAKC,OAAL;AACH,GApBI;AAuBLA,EAAAA,OAvBK,qBAuBK;AACN,SAAKV,IAAL,CAAUW,EAAV,CAAanB,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBC,WAA/B,EAA4C,KAAKC,WAAjD,EAA8D,IAA9D;AACA,SAAKf,IAAL,CAAUW,EAAV,CAAanB,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBG,UAA/B,EAA2C,KAAKC,UAAhD,EAA4D,IAA5D;AACA,SAAKjB,IAAL,CAAUW,EAAV,CAAanB,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBK,SAA/B,EAA0C,KAAKC,SAA/C,EAA0D,IAA1D;AACA,SAAKnB,IAAL,CAAUW,EAAV,CAAanB,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBO,YAA/B,EAA6C,KAAKD,SAAlD,EAA6D,IAA7D;AACH,GA5BI;AA+BLE,EAAAA,QA/BK,sBA+BM;AACP,SAAKrB,IAAL,CAAUsB,GAAV,CAAc9B,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBC,WAAhC;AACA,SAAKd,IAAL,CAAUsB,GAAV,CAAc9B,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBG,UAAhC;AACA,SAAKhB,IAAL,CAAUsB,GAAV,CAAc9B,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBK,SAAhC;AACA,SAAKlB,IAAL,CAAUsB,GAAV,CAAc9B,EAAE,CAACoB,IAAH,CAAQC,SAAR,CAAkBO,YAAhC;AACH,GApCI;AAuCLL,EAAAA,WAvCK,uBAuCOQ,KAvCP,EAuCc;AACf,QAAI,CAACC,uBAAWC,SAAZ,IAAyBD,uBAAWE,SAAxC,EAAmD;AAC/C;AACH;;AAED,QAAIC,GAAG,GAAG,KAAK3B,IAAL,CAAU4B,oBAAV,CAA+BL,KAAK,CAACM,WAAN,EAA/B,CAAV;AACAtB,IAAAA,MAAM,CAACuB,WAAP,GAAqB,IAArB;AACAvB,IAAAA,MAAM,CAACC,QAAP,GAAkBmB,GAAlB;AACA,SAAK/B,QAAL,CAAcmC,MAAd,CAAqBJ,GAAG,CAACK,CAAzB,EAA4BL,GAAG,CAACM,CAAhC;AACA,SAAKpC,UAAL,CAAgBqC,IAAhB,CAAqB1C,EAAE,CAACiB,EAAH,CAAMkB,GAAG,CAACK,CAAV,EAAaL,GAAG,CAACM,CAAjB,CAArB;AACH,GAjDI;AAoDLhB,EAAAA,UApDK,sBAoDMM,KApDN,EAoDa;AACd,QAAI,CAACC,uBAAWC,SAAZ,IAAyBD,uBAAWE,SAAxC,EAAmD;AAC/C;AACH;;AAED,SAAKrB,eAAL,IAAwB,CAAxB,CALc,CAOd;AACA;AACA;AACA;AACA;AACA;;AAEA,QAAIsB,GAAG,GAAG,KAAK3B,IAAL,CAAU4B,oBAAV,CAA+BL,KAAK,CAACM,WAAN,EAA/B,CAAV;AACAtB,IAAAA,MAAM,CAACC,QAAP,GAAkBmB,GAAlB;AACA,SAAK/B,QAAL,CAAcuC,MAAd,CAAqBR,GAAG,CAACK,CAAzB,EAA4BL,GAAG,CAACM,CAAhC;AACA,SAAKpC,UAAL,CAAgBqC,IAAhB,CAAqB1C,EAAE,CAACiB,EAAH,CAAMkB,GAAG,CAACK,CAAV,EAAaL,GAAG,CAACM,CAAjB,CAArB;AAEA,SAAKG,iBAAL;AACA,SAAKxC,QAAL,CAAcyC,MAAd;AACH,GAzEI;AA4ELlB,EAAAA,SA5EK,qBA4EKI,KA5EL,EA4EY;AACb,QAAIhB,MAAM,CAAC+B,WAAX,EAAwB;AACpBd,6BAAWC,SAAX,GAAuB,IAAvB,CADoB,CAEpB;;AACAlB,MAAAA,MAAM,CAACgC,MAAP,GAAgB,KAAhB;AACA,WAAK1C,UAAL,GAAkB,EAAlB;AACA,WAAKD,QAAL,CAAc4C,KAAd;AACA;AACH;;AAED,QAAI,CAAChB,uBAAWC,SAAZ,IAAyBD,uBAAWE,SAAxC,EAAmD;AAC/C;AACH,KAZY,CAcb;;;AACA,QAAIe,gBAAgB,GAAG,KAAKC,YAAL,CAAkB,KAAK7C,UAAvB,EAAmC,CAAnC,CAAvB,CAfa,CAekD;;AAC/D2B,2BAAWC,SAAX,GAAuB,KAAvB;AACAlB,IAAAA,MAAM,CAACgC,MAAP,GAAgB,IAAhB;AACAhC,IAAAA,MAAM,CAAC+B,WAAP,GAAqB,KAArB;AACA,SAAKK,cAAL,CAAoBF,gBAApB;AACA,SAAKpB,QAAL;AACH,GAjGI;AAoGLe,EAAAA,iBApGK,+BAoGe;AAChB,QAAI7B,MAAM,CAAC+B,WAAX,EAAwB;AACpB,WAAK1C,QAAL,CAAcgD,WAAd,GAA4BpD,EAAE,CAACqD,KAAH,CAASC,GAArC;AACH,KAFD,MAEO;AACH,WAAKlD,QAAL,CAAcgD,WAAd,GAA4BpD,EAAE,CAACqD,KAAH,CAASE,KAArC;AACH;AACJ,GA1GI;AA6GLJ,EAAAA,cA7GK,0BA6GUF,gBA7GV,EA6G4B;AAC7B,SAAKO,aAAL,GAAqB,KAAKC,YAAL,CAAkBzD,EAAE,CAAC0D,SAArB,CAArB;AACA,SAAKF,aAAL,CAAmBG,YAAnB,GAAkC,GAAlC;AAEA,SAAKC,WAAL,GAAmB,KAAKH,YAAL,CAAkB,mBAAlB,CAAnB;AACA,SAAKG,WAAL,CAAiBC,SAAjB,GAA6B,CAA7B;AACA,SAAKD,WAAL,CAAiBE,MAAjB,GAA0Bb,gBAA1B,CAN6B,CAMgB;;AAC7C,SAAKW,WAAL,CAAiBG,QAAjB,GAA4B,CAA5B;AACA,SAAKH,WAAL,CAAiBI,OAAjB,GAA2B,CAA3B;AACA,SAAKJ,WAAL,CAAiBK,GAAjB,GAAuB,CAAvB;AACA,SAAKL,WAAL,CAAiBM,KAAjB;AACH,GAxHI;AA2HLhB,EAAAA,YA3HK,wBA2HQY,MA3HR,EA2HgBK,SA3HhB,EA2H2B;AAC5B,QAAIL,MAAM,CAACM,MAAP,GAAgB,CAApB,EAAuB,OAAON,MAAP;AAEvB,QAAIO,WAAW,GAAGF,SAAS,KAAKG,SAAd,GAA0BH,SAAS,GAAGA,SAAtC,GAAkD,CAApE;AACAL,IAAAA,MAAM,GAAG,KAAKS,sBAAL,CAA4BT,MAA5B,EAAoCO,WAApC,CAAT;AAEA,WAAOP,MAAP;AACH,GAlII;AAqILS,EAAAA,sBArIK,kCAqIkBT,MArIlB,EAqI0BO,WArI1B,EAqIuC;AACxC,QAAIG,GAAG,GAAGV,MAAM,CAACM,MAAjB;AAAA,QACIK,gBAAgB,GAAG,OAAOC,UAAP,KAAsB,WAAtB,GAAoCA,UAApC,GAAiDC,KADxE;AAAA,QAEIC,OAAO,GAAG,IAAIH,gBAAJ,CAAqBD,GAArB,CAFd;AAAA,QAGIK,KAAK,GAAG,CAHZ;AAAA,QAIIC,IAAI,GAAGN,GAAG,GAAG,CAJjB;AAAA,QAKIO,KAAK,GAAG,EALZ;AAAA,QAMIC,SAAS,GAAG,EANhB;AAAA,QAOIC,CAPJ;AAAA,QAOOC,SAPP;AAAA,QAOkBC,MAPlB;AAAA,QAO0BC,KAP1B;AASAR,IAAAA,OAAO,CAACC,KAAD,CAAP,GAAiBD,OAAO,CAACE,IAAD,CAAP,GAAgB,CAAjC;;AAEA,WAAOA,IAAP,EAAa;AACTI,MAAAA,SAAS,GAAG,CAAZ;;AAEA,WAAKD,CAAC,GAAGJ,KAAK,GAAG,CAAjB,EAAoBI,CAAC,GAAGH,IAAxB,EAA8BG,CAAC,EAA/B,EAAmC;AAC/BE,QAAAA,MAAM,GAAG,KAAKE,YAAL,CAAkBvB,MAAM,CAACmB,CAAD,CAAxB,EAA6BnB,MAAM,CAACe,KAAD,CAAnC,EAA4Cf,MAAM,CAACgB,IAAD,CAAlD,CAAT;;AAEA,YAAIK,MAAM,GAAGD,SAAb,EAAwB;AACpBE,UAAAA,KAAK,GAAGH,CAAR;AACAC,UAAAA,SAAS,GAAGC,MAAZ;AACH;AACJ;;AAED,UAAID,SAAS,GAAGb,WAAhB,EAA6B;AACzBO,QAAAA,OAAO,CAACQ,KAAD,CAAP,GAAiB,CAAjB;AACAL,QAAAA,KAAK,CAACrC,IAAN,CAAWmC,KAAX,EAAkBO,KAAlB,EAAyBA,KAAzB,EAAgCN,IAAhC;AACH;;AAEDA,MAAAA,IAAI,GAAGC,KAAK,CAACO,GAAN,EAAP;AACAT,MAAAA,KAAK,GAAGE,KAAK,CAACO,GAAN,EAAR;AACH;;AAED,SAAKL,CAAC,GAAG,CAAT,EAAYA,CAAC,GAAGT,GAAhB,EAAqBS,CAAC,EAAtB,EAA0B;AACtB,UAAIL,OAAO,CAACK,CAAD,CAAX,EAAgB;AACZD,QAAAA,SAAS,CAACtC,IAAV,CAAeoB,MAAM,CAACmB,CAAD,CAArB;AACH;AACJ;;AAED,WAAOD,SAAP;AACH,GA7KI;AAgLLK,EAAAA,YAhLK,wBAgLQE,CAhLR,EAgLWC,EAhLX,EAgLeC,EAhLf,EAgLmB;AACpB,QAAIjD,CAAC,GAAGgD,EAAE,CAAChD,CAAX;AAAA,QACIC,CAAC,GAAG+C,EAAE,CAAC/C,CADX;AAAA,QAEIiD,EAAE,GAAGD,EAAE,CAACjD,CAAH,GAAOA,CAFhB;AAAA,QAGImD,EAAE,GAAGF,EAAE,CAAChD,CAAH,GAAOA,CAHhB;;AAKA,QAAIiD,EAAE,KAAK,CAAP,IAAYC,EAAE,KAAK,CAAvB,EAA0B;AACtB,UAAIC,CAAC,GAAG,CAAC,CAACL,CAAC,CAAC/C,CAAF,GAAMA,CAAP,IAAYkD,EAAZ,GAAiB,CAACH,CAAC,CAAC9C,CAAF,GAAMA,CAAP,IAAYkD,EAA9B,KAAqCD,EAAE,GAAGA,EAAL,GAAUC,EAAE,GAAGA,EAApD,CAAR;;AAEA,UAAIC,CAAC,GAAG,CAAR,EAAW;AACPpD,QAAAA,CAAC,GAAGiD,EAAE,CAACjD,CAAP;AACAC,QAAAA,CAAC,GAAGgD,EAAE,CAAChD,CAAP;AACH,OAHD,MAGO,IAAImD,CAAC,GAAG,CAAR,EAAW;AACdpD,QAAAA,CAAC,IAAIkD,EAAE,GAAGE,CAAV;AACAnD,QAAAA,CAAC,IAAIkD,EAAE,GAAGC,CAAV;AACH;AACJ;;AAEDF,IAAAA,EAAE,GAAGH,CAAC,CAAC/C,CAAF,GAAMA,CAAX;AACAmD,IAAAA,EAAE,GAAGJ,CAAC,CAAC9C,CAAF,GAAMA,CAAX;AAEA,WAAOiD,EAAE,GAAGA,EAAL,GAAUC,EAAE,GAAGA,EAAtB;AACH,GAtMI;AAwMLE,EAAAA,cAxMK,0BAwMUC,SAxMV,EAwMqBC,QAxMrB,EAwM+B;AAChC,WAAOD,SAAS,CAACE,GAAV,CAAcD,QAAd,EAAwBE,GAAxB,MAAiC,EAAxC;AACH;AA1MI,CAAT","sourceRoot":"/","sourcesContent":["import { StateForJs } from \"../Data/StateForJS\";\r\n\r\ncc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        graphics: null,\r\n        line_point: [cc.Vec2],\r\n    },\r\n\r\n\r\n    onLoad() {\r\n        this.node.width = 5000;\r\n        this.node.height = 5000;\r\n        this.graphics = this.getComponent(cc.Graphics);\r\n        this.currentDrawTime = 0;\r\n    },\r\n\r\n\r\n    start() {\r\n        window.PointPos = cc.v2(-60, 65);\r\n        this.onTouch();\r\n    },\r\n    \r\n\r\n    onTouch() {\r\n        this.node.on(cc.Node.EventType.TOUCH_START, this.touch_start, this);\r\n        this.node.on(cc.Node.EventType.TOUCH_MOVE, this.touch_move, this);\r\n        this.node.on(cc.Node.EventType.TOUCH_END, this.touch_end, this);\r\n        this.node.on(cc.Node.EventType.TOUCH_CANCEL, this.touch_end, this);\r\n    },\r\n\r\n\r\n    offTouch() {\r\n        this.node.off(cc.Node.EventType.TOUCH_START);\r\n        this.node.off(cc.Node.EventType.TOUCH_MOVE);\r\n        this.node.off(cc.Node.EventType.TOUCH_END);\r\n        this.node.off(cc.Node.EventType.TOUCH_CANCEL);\r\n    },\r\n\r\n\r\n    touch_start(event) {\r\n        if (!StateForJs.isCanDraw || StateForJs.isToStore) {\r\n            return;\r\n        }\r\n\r\n        let pos = this.node.convertToNodeSpaceAR(event.getLocation());\r\n        window.isStartDraw = true;\r\n        window.PointPos = pos;\r\n        this.graphics.moveTo(pos.x, pos.y);\r\n        this.line_point.push(cc.v2(pos.x, pos.y));\r\n    },\r\n\r\n\r\n    touch_move(event) {\r\n        if (!StateForJs.isCanDraw || StateForJs.isToStore) {\r\n            return;\r\n        }\r\n\r\n        this.currentDrawTime += 1;\r\n\r\n        // if(window.currentLv === 2 && this.currentDrawTime >= 8) {\r\n        //     window.changeEggRigidbodyType = true;\r\n        //     window.stopDrawSound = true;\r\n        //     this.touch_end();\r\n        //     return;\r\n        // }\r\n\r\n        let pos = this.node.convertToNodeSpaceAR(event.getLocation());\r\n        window.PointPos = pos;\r\n        this.graphics.lineTo(pos.x, pos.y);\r\n        this.line_point.push(cc.v2(pos.x, pos.y));\r\n\r\n        this.updateStrokeColor();\r\n        this.graphics.stroke();\r\n    },\r\n\r\n\r\n    touch_end(event) {\r\n        if (window.isTouchWall) {\r\n            StateForJs.isCanDraw = true;\r\n            // window.isTouchWall = false;\r\n            window.isDraw = false;\r\n            this.line_point = [];\r\n            this.graphics.clear();\r\n            return;\r\n        }\r\n\r\n        if (!StateForJs.isCanDraw || StateForJs.isToStore) {\r\n            return;\r\n        }\r\n\r\n        // Rút gọn đường vẽ\r\n        let simplifiedPoints = this.simplifyPath(this.line_point, 4);  // Sử dụng độ tolerance phù hợp\r\n        StateForJs.isCanDraw = false;\r\n        window.isDraw = true;\r\n        window.isTouchWall = false;\r\n        this.createRigibody(simplifiedPoints);\r\n        this.offTouch();\r\n    },\r\n\r\n\r\n    updateStrokeColor() {\r\n        if (window.isTouchWall) {\r\n            this.graphics.strokeColor = cc.Color.RED;\r\n        } else {\r\n            this.graphics.strokeColor = cc.Color.BLACK;\r\n        }\r\n    },\r\n\r\n\r\n    createRigibody(simplifiedPoints) {\r\n        this.rigibodyLogic = this.addComponent(cc.RigidBody);\r\n        this.rigibodyLogic.gravityScale = 0.4;\r\n\r\n        this.physicsLine = this.addComponent(\"MyPhysicsCollider\");\r\n        this.physicsLine.lineWidth = 7;\r\n        this.physicsLine.points = simplifiedPoints;  // Sử dụng điểm đã rút gọn\r\n        this.physicsLine.friction = 0;\r\n        this.physicsLine.density = 0;\r\n        this.physicsLine.tag = 4;\r\n        this.physicsLine.apply();\r\n    },\r\n\r\n\r\n    simplifyPath(points, tolerance) {\r\n        if (points.length < 3) return points;\r\n\r\n        let sqTolerance = tolerance !== undefined ? tolerance * tolerance : 1;\r\n        points = this.simplifyDouglasPeucker(points, sqTolerance);\r\n\r\n        return points;\r\n    },\r\n\r\n\r\n    simplifyDouglasPeucker(points, sqTolerance) {\r\n        let len = points.length,\r\n            ArrayConstructor = typeof Uint8Array !== 'undefined' ? Uint8Array : Array,\r\n            markers = new ArrayConstructor(len),\r\n            first = 0,\r\n            last = len - 1,\r\n            stack = [],\r\n            newPoints = [],\r\n            i, maxSqDist, sqDist, index;\r\n\r\n        markers[first] = markers[last] = 1;\r\n\r\n        while (last) {\r\n            maxSqDist = 0;\r\n\r\n            for (i = first + 1; i < last; i++) {\r\n                sqDist = this.getSqSegDist(points[i], points[first], points[last]);\r\n\r\n                if (sqDist > maxSqDist) {\r\n                    index = i;\r\n                    maxSqDist = sqDist;\r\n                }\r\n            }\r\n\r\n            if (maxSqDist > sqTolerance) {\r\n                markers[index] = 1;\r\n                stack.push(first, index, index, last);\r\n            }\r\n\r\n            last = stack.pop();\r\n            first = stack.pop();\r\n        }\r\n\r\n        for (i = 0; i < len; i++) {\r\n            if (markers[i]) {\r\n                newPoints.push(points[i]);\r\n            }\r\n        }\r\n\r\n        return newPoints;\r\n    },\r\n\r\n\r\n    getSqSegDist(p, p1, p2) {\r\n        let x = p1.x,\r\n            y = p1.y,\r\n            dx = p2.x - x,\r\n            dy = p2.y - y;\r\n\r\n        if (dx !== 0 || dy !== 0) {\r\n            let t = ((p.x - x) * dx + (p.y - y) * dy) / (dx * dx + dy * dy);\r\n\r\n            if (t > 1) {\r\n                x = p2.x;\r\n                y = p2.y;\r\n            } else if (t > 0) {\r\n                x += dx * t;\r\n                y += dy * t;\r\n            }\r\n        }\r\n\r\n        dx = p.x - x;\r\n        dy = p.y - y;\r\n\r\n        return dx * dx + dy * dy;\r\n    },\r\n\r\n    checkIsCanDraw(lastPoint, nowPoint) {\r\n        return lastPoint.sub(nowPoint).mag() >= 20;\r\n    },\r\n});\r\n"]}