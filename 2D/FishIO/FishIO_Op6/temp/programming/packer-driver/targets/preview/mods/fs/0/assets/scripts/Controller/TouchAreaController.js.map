{"version":3,"sources":["file:///D:/PA_2023/2D/FishIO/FishIO_Op6/assets/scripts/Controller/TouchAreaController.ts"],"names":["_decorator","Component","Node","Vec3","Vec2","Camera","Animation","UIOpacity","sp","PlayerController","Constants","GameController","AudioManager","IronSource","ccclass","property","TouchAreaController","start","init","registerEvent","levelPlayer","player","getChildByName","playerSpine","getComponent","Skeleton","playerController","stickPointUIOpacity","stickPoint","tutorialOpacity","tutorial","toStore","hideMask","on","EventType","TOUCH_START","installHandle","onHideMaskTouchStart","TOUCH_MOVE","onHideMaskTouchMove","TOUCH_END","onHideMaskTouchEnd","TOUCH_CANCEL","offEvent","off","event","isLive","isCompleteVideo","flagReplay","isPlayGame","isTouching","isMove","opacity","stop","setAnimation","timeScale","forceReplay","touchPos","getUILocation","localTouch","convertToLocalLocation","positionTouch","x","camera","node","getPosition","y","handleStickPos","move","handleShowTutorialAgain","newStickPos","angleInRadian","Math","atan2","angleCount","PI","setPosition","scheduleOnce","play","HandleAnglePlayer","angle","setScale","value","localX","localY","result"],"mappings":"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","sourcesContent":["import { _decorator, Component, EventTouch, Node, toDegree, Vec3, Vec2, Camera, screen, UITransform, Animation, UIOpacity, sp, tween, Tween, toRadian, log } from 'cc';\nimport { PlayerController } from './PlayerController';\nimport { Constants } from '../Data/Constant';\nimport { GameController } from './GameController';\nimport { AudioManager } from './AudioManager';\nimport { IronSource } from '../Data/IronSource';\nconst { ccclass, property } = _decorator;\n\n@ccclass('TouchAreaController')\nexport class TouchAreaController extends Component {\n  @property(IronSource)\n  IronSource: IronSource = null;\n  @property(AudioManager)\n  AudioManager: AudioManager = null;\n  @property(GameController)\n  GameController: GameController = null;\n  @property(Camera)\n  camera: Camera = null;\n\n\n  @property(Node)\n  player: Node = null;\n  @property(Node)\n  fakeHideMask: Node = null;\n  @property(Node)\n  hideMask: Node = null;\n  @property(Node)\n  tutorial: Node = null;\n  @property(Node)\n  stickPoint: Node = null;\n\n\n  playerController: PlayerController = null;\n  stickPointUIOpacity: UIOpacity = null;\n  tutorialOpacity: UIOpacity = null;\n  levelPlayer: Node = null;\n  playerSpine: sp.Skeleton = null;\n\n  positionTouch: Vec3 = new Vec3(0, 0, 0);\n  localTouch: Vec3 = new Vec3(0, 0, 0);\n  locationPos: Vec2 = new Vec2(0, 0);\n  angleCount: number = null;\n\n\n  protected start(): void {\n    // toStore\n    // Constants.toStore = true;\n\n    this.init();\n    this.registerEvent();\n  }\n\n\n  private init(): void {\n    this.levelPlayer = this.player.getChildByName(\"Body\").getChildByName(\"Level\");\n    this.playerSpine = this.player.getChildByName(\"Body\").getChildByName(\"Spine_Fish\").getComponent(sp.Skeleton);\n    this.playerController = this.player.getComponent(PlayerController);\n    this.stickPointUIOpacity = this.stickPoint.getComponent(UIOpacity);\n    this.tutorialOpacity = this.tutorial.getComponent(UIOpacity);\n  }\n\n\n  public registerEvent(): void {\n    if (Constants.toStore) {\n      this.hideMask.on(Node.EventType.TOUCH_START, this.GameController.installHandle, this);\n      return;\n    };\n\n    this.hideMask.on(Node.EventType.TOUCH_START, this.onHideMaskTouchStart, this);\n    this.hideMask.on(Node.EventType.TOUCH_MOVE, this.onHideMaskTouchMove, this);\n    this.hideMask.on(Node.EventType.TOUCH_END, this.onHideMaskTouchEnd, this);\n    this.hideMask.on(Node.EventType.TOUCH_CANCEL, this.onHideMaskTouchEnd, this);\n  };\n\n\n  public offEvent() {\n    this.hideMask.off(Node.EventType.TOUCH_START);\n    this.hideMask.off(Node.EventType.TOUCH_MOVE);\n    this.hideMask.off(Node.EventType.TOUCH_END);\n    this.hideMask.off(Node.EventType.TOUCH_CANCEL);\n  };\n\n\n  private onHideMaskTouchStart(event: EventTouch) {\n    if(!this.playerController.isLive || !Constants.isCompleteVideo) {\n      return;\n    }\n\n    if(Constants.flagReplay) {\n      this.GameController.installHandle();\n      return;\n    }\n    \n    Constants.isPlayGame = true;\n    Constants.isTouching = true;\n    this.playerController.isMove = true;\n    this.stickPointUIOpacity.opacity = 180;\n    this.tutorialOpacity.opacity = 0;\n    this.tutorial.getComponent(Animation).stop();\n    this.playerSpine.setAnimation(0, \"eat\", true);\n    this.playerSpine.timeScale = 1;\n    // this.IronSource.handleIronSourcePlaySound();\n  }\n\n\n  private onHideMaskTouchMove(event: EventTouch) {\n    if(!this.playerController.isLive || Constants.forceReplay || !Constants.isCompleteVideo) {\n      return;\n    }\n\n    let touchPos = event.getUILocation();\n    this.localTouch = this.convertToLocalLocation(touchPos);\n    this.positionTouch = this.localTouch;\n\n    this.positionTouch.x += this.camera.node.getPosition().x;\n    this.positionTouch.y += this.camera.node.getPosition().y;\n  \n    this.handleStickPos();\n    this.playerController.move();\n  }\n\n\n  private onHideMaskTouchEnd(): void {\n\n    Constants.isTouching = false;\n    this.playerController.isMove = false;\n    this.playerController.stop();\n    this.stickPointUIOpacity.opacity = 0;\n    this.playerSpine.setAnimation(0, \"idle\", true);\n    this.playerSpine.timeScale = 1.5;\n    this.handleShowTutorialAgain();\n  }\n\n\n  // clear fix bug from 14/12/2023\n  // critical bug: Not get the exactly pos of stickPoint in 3D env.\n  // --- update 19/12/2023: Fixed\n  // --- Dev: Hiep\n  private handleStickPos(): void {\n    let newStickPos = new Vec3(\n      this.positionTouch.x -= this.camera.node.getPosition().x,\n      this.positionTouch.y -= this.camera.node.getPosition().y,\n      0\n    );\n\n    // count angle of player\n    let angleInRadian = Math.atan2(newStickPos.y, newStickPos.x);\n    this.angleCount = angleInRadian * (180 / Math.PI);\n    this.stickPoint.setPosition(newStickPos);\n    // --------------------\n  }\n\n\n  private handleShowTutorialAgain(): void {\n    this.scheduleOnce(() => {\n      if (Constants.isTouching) {\n        return;\n      };\n      this.tutorial.getComponent(Animation).play(\"Tutorial_ShowAnim\");\n    }, 3);\n  }\n\n\n  public HandleAnglePlayer(player: Node): void {\n    player.angle = this.angleCount;\n\n    if(this.angleCount >= 90 || this.angleCount <= -90) {\n      player.setScale(new Vec3(-1, -1, 1.2))\n      this.levelPlayer.setScale(new Vec3(0.5, 0.5, 0.5));\n    } else {\n      player.setScale(new Vec3(-1, 1, 1))\n      this.levelPlayer.setScale(new Vec3(-0.5, 0.5, 0.5));\n    }\n  }\n\n\n  public convertToLocalLocation(value: Vec2): Vec3 {\n    const localX: number = value.x - 240;\n    const localY: number = value.y - 160;\n    const result = new Vec3(localX, localY, 0);\n    return result;\n  }\n}\n\n"]}