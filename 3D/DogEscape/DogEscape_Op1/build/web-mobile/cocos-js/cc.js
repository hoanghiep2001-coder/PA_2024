System.register([],(function(e,t){"use strict";return{execute:function(){e({BitMask:ot,CCClass:en,CacheMode:void 0,DebugMode:void 0,EAxisDirection:void 0,ERigidBodyType:void 0,Enum:st,Eventify:nu,ExtrapolationMode:void 0,HorizontalTextAlignment:void 0,InstanceMaterialType:void 0,KeyCode:void 0,Overflow:void 0,PipelineEventType:void 0,QuatInterpolationMode:void 0,RealInterpolationMode:void 0,SystemEventType:void 0,TangentWeightMode:void 0,VerticalTextAlignment:void 0,WorldNode3DToLocalNodeUI:RA,WorldNode3DToWorldNodeUI:IA,absMax:Cn,absMaxComponent:En,approx:cn,assert:b,assertID:B,bezier:L_,bezierByTime:$_,ccenum:ut,clamp:ln,clamp01:un,color:Rn,computeRatioByType:Qk,createDefaultPipeline:PM,debug:E,deserialize:zh,earcut:_0,enumerableProps:An,equals:sn,error:T,errorID:M,find:ED,fragmentText:Uq,getBaselineOffset:function(){return 0},getError:F,getPathFromRoot:function(e,t){for(var n=e,i="";null!==n&&n!==t;)i=n.name+"/"+i,n=n.parent;return i.slice(0,-1)},getSerializationMetadata:function(e){return e[Sc]},getWorldTransformUntilRoot:Mj,instantiate:tf,inverseLerp:bn,isCustomTargetModifier:kj,isDisplayStats:z,isElementModifier:Uj,isPropertyModifier:zj,isUnicodeCJK:Lq,isUnicodeSpace:Bq,isValid:gl,lerp:hn,log:x,logID:R,markAsWarning:void 0,mat4:Yn,murmurhash2_32_gc:xo,nextPow2:xn,pingPong:Tn,pseudoRandom:vn,pseudoRandomRange:gn,pseudoRandomRangeInt:yn,quat:Vn,randomRange:dn,randomRangeInt:mn,rect:oi,removeProperty:void 0,repeat:Sn,replaceProperty:void 0,safeMeasureText:Fq,sampleAnimationCurve:Kk,setDefaultLogTimes:function(e){e>0&&(X=e)},setDisplayStats:U,size:ii,toDegree:_n,toRadian:fn,tween:lCe,tweenUtil:uCe,v2:Jn,v3:Mn,v4:ei,warn:S,warnID:D});var n=2147483647;function i(e){return(e>0)-(e<0)}function r(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function o(e){var t=32;return(e&=-e)&&t--,65535&e&&(t-=16),16711935&e&&(t-=8),252645135&e&&(t-=4),858993459&e&&(t-=2),1431655765&e&&(t-=1),t}function a(e){return--e,e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,1+(e|=e>>>16)}var s=new Array(256);!function(e){for(var t=0;t<256;++t){var n=t,i=t,r=7;for(n>>>=1;n;n>>>=1)i<<=1,i|=1&n,--r;e[t]=i<<r&255}}(s);var c=Object.freeze({__proto__:null,INT_BITS:32,INT_MAX:n,INT_MIN:-2147483648,sign:i,abs:function(e){var t=e>>31;return(e^t)-t},min:function(e,t){return t^(e^t)&-(e<t)},max:function(e,t){return e^(e^t)&-(e<t)},isPow2:function(e){return!(e&e-1||!e)},log2:r,log10:function(e){return e>=1e9?9:e>=1e8?8:e>=1e7?7:e>=1e6?6:e>=1e5?5:e>=1e4?4:e>=1e3?3:e>=100?2:e>=10?1:0},popCount:function(e){return 16843009*((e=(858993459&(e-=e>>>1&1431655765))+(e>>>2&858993459))+(e>>>4)&252645135)>>>24},countTrailingZeros:o,nextPow2:a,prevPow2:function(e){return e|=e>>>1,e|=e>>>2,e|=e>>>4,e|=e>>>8,(e|=e>>>16)-(e>>>1)},parity:function(e){return e^=e>>>16,e^=e>>>8,e^=e>>>4,27030>>>(e&=15)&1},reverse:function(e){return s[255&e]<<24|s[e>>>8&255]<<16|s[e>>>16&255]<<8|s[e>>>24&255]},interleave2:function(e,t){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e&=65535)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t&=65535)|t<<8))|t<<4))|t<<2))|t<<1))<<1},deinterleave2:function(e,t){return(e=65535&((e=16711935&((e=252645135&((e=858993459&((e=e>>>t&1431655765)|e>>>1))|e>>>2))|e>>>4))|e>>>16))<<16>>16},interleave3:function(e,t,n){return e=1227133513&((e=3272356035&((e=251719695&((e=4278190335&((e&=1023)|e<<16))|e<<8))|e<<4))|e<<2),(e|=(t=1227133513&((t=3272356035&((t=251719695&((t=4278190335&((t&=1023)|t<<16))|t<<8))|t<<4))|t<<2))<<1)|(n=1227133513&((n=3272356035&((n=251719695&((n=4278190335&((n&=1023)|n<<16))|n<<8))|n<<4))|n<<2))<<2},deinterleave3:function(e,t){return(e=1023&((e=4278190335&((e=251719695&((e=3272356035&((e=e>>>t&1227133513)|e>>>2))|e>>>4))|e>>>8))|e>>>16))<<22>>22},nextCombination:function(e){var t=e|e-1;return t+1|(~t&-~t)-1>>>o(e)+1}});e("bits",c);var l="undefined"==typeof window?global:window,u=e("cclegacy",{_global:l});u.internal={},l.CC_BUILD=!0,l.CC_TEST=!1,l.CC_EDITOR=false,l.CC_PREVIEW=!1,l.CC_DEV=!1,l.CC_DEBUG=!1,l.CC_JSB=!1,l.CC_BYTEDANCE=!1,l.CC_WECHAT=!1,l.CC_ALIPAY=!1,l.CC_XIAOMI=!1,l.CC_BAIDU=!1,l.CC_COCOSPLAY=!1,l.CC_HUAWEI=!1,l.CC_OPPO=!1,l.CC_VIVO=!1,l.CC_MINIGAME=!1,l.CC_RUNTIME_BASED=!1,l.CC_SUPPORT_JIT=!0;var h=e("VERSION","3.4.2");l.CocosEngine=u.ENGINE_VERSION=h,l.cc=u;var f="https://github.com/cocos-creator/engine/blob/develop/EngineErrorMap.md",_=null,p=console.log.bind(console),d=p,m=p,v=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];console.log("ASSERT: "+y.apply(void 0,[t].concat(i)))}},g=p;function y(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return u.js.formatStr.apply(null,[e].concat(n))}function x(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return p.apply(void 0,[e].concat(n))}function S(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return d.apply(void 0,[e].concat(n))}function T(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return m.apply(void 0,[e].concat(n))}function b(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return v.apply(void 0,[e,t].concat(i))}function E(){return g.apply(void 0,arguments)}function C(e){if(p=d=m=v=g=function(){},e!==N.NONE){if(e>N.ERROR){var t=function(e){if(u.game.canvas){if(!_){var t=document.createElement("Div");t.setAttribute("id","logInfoDiv"),t.setAttribute("width","200"),t.setAttribute("height",u.game.canvas.height);var n=t.style;n.zIndex="99999",n.position="absolute",n.top=n.left="0",(_=document.createElement("textarea")).setAttribute("rows","20"),_.setAttribute("cols","30"),_.setAttribute("disabled","true");var i=_.style;i.backgroundColor="transparent",i.borderBottom="1px solid #cccccc",i.borderTopWidth=i.borderLeftWidth=i.borderRightWidth="0px",i.borderTopStyle=i.borderLeftStyle=i.borderRightStyle="none",i.padding="0px",i.margin="0px",t.appendChild(_),u.game.canvas.parentNode.appendChild(t)}_.value=_.value+e+"\r\n",_.scrollTop=_.scrollHeight}};m=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("ERROR :  "+y.apply(void 0,[e].concat(i)))},v=function(e,n){if(!e){for(var i=arguments.length,r=new Array(i>2?i-2:0),o=2;o<i;o++)r[o-2]=arguments[o];t("ASSERT: "+y.apply(void 0,[n].concat(r)))}},e!==N.ERROR_FOR_WEB_PAGE&&(d=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t("WARN :  "+y.apply(void 0,[e].concat(i)))}),e===N.INFO_FOR_WEB_PAGE&&(p=function(e){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t(y.apply(void 0,[e].concat(i)))})}else console&&(console.error||(console.error=console.log),console.warn||(console.warn=console.log),m=console.error.bind?console.error.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.error.apply(console,[e].concat(n))},v=function(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];var o=y.apply(void 0,[t].concat(i));throw new Error(o)}});if(e!==N.ERROR&&(d=console.warn.bind?console.warn.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.warn.apply(console,[e].concat(n))}),e<=N.INFO&&(p=console.log.bind?console.log.bind(console):function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return console.log.apply(console,[e].concat(n))}),e<=N.VERBOSE&&"function"==typeof console.debug){var n=console.debug.bind(console);g=function(){return n.apply(void 0,arguments)}}}}function A(e){T(e.stack||e)}function w(e){return function(t){for(var n=e+" "+t+", please go to "+f+"#"+t+" to see details.",i=arguments.length,r=new Array(i>1?i-1:0),o=1;o<i;o++)r[o-1]=arguments[o];return 0===r.length?n:n+" Arguments: "+r.join(", ")}}var P=w("Log");function R(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];x(P.apply(void 0,[e].concat(n)))}var I=w("Warning");function D(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];S(I.apply(void 0,[e].concat(n)))}var O=w("Error");function M(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];T(O.apply(void 0,[e].concat(n)))}var N,L=w("Assert");function B(e,t){if(!e){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];b(!1,L.apply(void 0,[t].concat(i)))}}function F(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return O.apply(void 0,[e].concat(n))}function z(){return!!u.profiler&&u.profiler.isShowingStats()}function U(e){u.profiler&&(e?u.profiler.showStats():u.profiler.hideStats(),u.game.config.showFPS=!!e)}!function(e){e[e.NONE=0]="NONE",e[e.VERBOSE=1]="VERBOSE",e[e.INFO=2]="INFO",e[e.WARN=3]="WARN",e[e.ERROR=4]="ERROR",e[e.INFO_FOR_WEB_PAGE=5]="INFO_FOR_WEB_PAGE",e[e.WARN_FOR_WEB_PAGE=6]="WARN_FOR_WEB_PAGE",e[e.ERROR_FOR_WEB_PAGE=7]="ERROR_FOR_WEB_PAGE"}(N||(N=e("DebugMode",{})));var k,G,H,V,W,j,q=Object.freeze({__proto__:null,log:x,warn:S,error:T,assert:b,debug:E,_resetDebugSetting:C,_throw:A,logID:R,warnID:D,errorID:M,assertID:B,get DebugMode(){return N},getError:F,isDisplayStats:z,setDisplayStats:U}),X=10,Y=0,K=new Map;function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t,n){return t&&Q(e.prototype,t),n&&Q(e,n),e}function J(){return(J=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var i in n)Object.prototype.hasOwnProperty.call(n,i)&&(e[i]=n[i])}return e}).apply(this,arguments)}function $(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,te(e,t)}function ee(e){return(ee=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function te(e,t){return(te=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function ne(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}function ie(e,t,n){return(ie=ne()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&te(r,n.prototype),r}).apply(null,arguments)}function re(e){var t="function"==typeof Map?new Map:void 0;return(re=function(e){if(null===e||(n=e,-1===Function.toString.call(n).indexOf("[native code]")))return e;var n;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,i)}function i(){return ie(e,arguments,ee(this).constructor)}return i.prototype=Object.create(e.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),te(i,e)})(e)}function oe(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function ae(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function se(e,t){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,t){if(e){if("string"==typeof e)return ae(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?ae(e,t):void 0}}(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var i=0;return function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}return(n=e[Symbol.iterator]()).next.bind(n)}function ce(e,t,n,i){n&&Object.defineProperty(e,t,{enumerable:n.enumerable,configurable:n.configurable,writable:n.writable,value:n.initializer?n.initializer.call(i):void 0})}function le(e,t,n,i,r){var o={};return Object.keys(i).forEach((function(e){o[e]=i[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=n.slice().reverse().reduce((function(n,i){return i(e,t,n)||n}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}V=function(e,t,n,i,r,o,a){var s=K.get(o);s&&s.logTimes>s.count&&(r("'%s' is deprecated, please use '%s' instead. "+a,e+"."+t,n+"."+i),s.count++)},k=e("replaceProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=Y++;K.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var r=null!=n.target?n.target:e,o=null!=n.newName?n.newName:n.name,a=null!=n.targetName?n.targetName:t,s=r===e,c=n.suggest?"("+n.suggest+")":"";if(null!=n.customFunction)e[n.name]=function(){var e;return V(t,n.name,a,o,S,i,c),(e=n.customFunction).call.apply(e,[this].concat(Array.prototype.slice.call(arguments)))};else if(null!=n.customSetter||null!=n.customGetter){var l=null!=n.customSetter,u=null!=n.customGetter;l&&u?Object.defineProperty(e,n.name,{get:function(){return V(t,n.name,a,o,S,i,c),n.customGetter.call(this)},set:function(e){V(t,n.name,a,o,S,i,c),n.customSetter.call(this,e)},enumerable:!1}):l?Object.defineProperty(e,n.name,{set:function(e){V(t,n.name,a,o,S,i,c),n.customSetter.call(this,e)},enumerable:!1}):u&&Object.defineProperty(e,n.name,{get:function(){return V(t,n.name,a,o,S,i,c),n.customGetter.call(this)},enumerable:!1})}else Object.defineProperty(e,n.name,{get:function(){return V(t,n.name,a,o,S,i,c),s?this[o]:r[o]},set:function(e){V(t,n.name,a,o,S,i,c),s?this[o]=e:r[o]=e},enumerable:!1})}))})),j=function(e,t,n,i,r){var o=K.get(i);o&&o.logTimes>o.count&&(n("'%s' has been removed. "+r,e+"."+t),o.count++)},G=e("removeProperty",(function(e,t,n){null!=e&&n.forEach((function(n){var i=Y++;K.set(i,{id:i,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var r=n.suggest?"("+n.suggest+")":"";Object.defineProperty(e,n.name,{get:function(){return j(t,n.name,T,i,r)},set:function(){j(t,n.name,T,i,r)},enumerable:!1})}))})),W=function(e,t,n,i,r){var o=K.get(i);o&&o.logTimes>o.count&&(n("'%s' is deprecated. "+r,e+"."+t),o.count++)},H=e("markAsWarning",(function(e,t,n){null!=e&&n.forEach((function(n){var i=n.name,r=Object.getOwnPropertyDescriptor(e,i);if(r&&r.configurable){var o=Y++;K.set(o,{id:o,count:0,logTimes:void 0!==n.logTimes?n.logTimes:X});var a=n.suggest?"("+n.suggest+")":"";if(void 0!==r.value)if("function"==typeof r.value){var s=r.value;e[i]=function(){return W(t,i,S,o,a),s.call.apply(s,[this].concat(Array.prototype.slice.call(arguments)))}}else{var c=r.value;Object.defineProperty(e,i,{configurable:!0,get:function(){return W(t,i,S,o,a),c}}),r.writable&&Object.defineProperty(e,i,{set:function(e){W(t,i,S,o,a),c=e}})}else!function(t,n,i,r,o,a){if(t.get){var s=t.get;t.get=function(){return W(n,i,r,o,a),s.call(this)}}if(t.set){var c=t.set;t.set=function(e){W(n,i,r,o,a),c.call(this,e)}}Object.defineProperty(e,i,t)}(r,t,i,S,o,a);Object.defineProperty(e,i,{enumerable:!1})}}))}));var ue=function(){function e(e){this.i=0,this.array=e}var t=e.prototype;return t.remove=function(e){var t=this.array.indexOf(e);t>=0&&this.removeAt(t)},t.removeAt=function(e){this.array.splice(e,1),e<=this.i&&--this.i},t.fastRemove=function(e){var t=this.array.indexOf(e);t>=0&&this.fastRemoveAt(t)},t.fastRemoveAt=function(e){var t=this.array;t[e]=t[t.length-1],--t.length,e<=this.i&&--this.i},t.push=function(e){this.array.push(e)},Z(e,[{key:"length",get:function(){return this.array.length},set:function(e){this.array.length=e,this.i>=e&&(this.i=e-1)}}]),e}();function he(e,t){e.splice(t,1)}function fe(e,t){var n=e.length;t<0||t>=n||(e[t]=e[n-1],e.length=n-1)}function _e(e,t){var n=e.indexOf(t);return n>=0&&(he(e,n),!0)}function pe(e,t){var n=e.findIndex(t);if(n>=0){var i=e[n];return he(e,n),i}}function de(e,t){return e.indexOf(t)>=0}var me=Object.freeze({__proto__:null,removeAt:he,fastRemoveAt:fe,remove:_e,fastRemove:function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=e[e.length-1],--e.length)},removeIf:pe,verifyType:function(e,t){if(e&&e.length>0)for(var n,i=se(e);!(n=i()).done;)if(!(n.value instanceof t))return R(1300),!1;return!0},removeArray:function(e,t){for(var n=0,i=t.length;n<i;n++)_e(e,t[n])},appendObjectsAt:function(e,t,n){return e.splice.apply(e,[n,0].concat(t)),e},contains:de,copy:function(e){for(var t=e.length,n=new Array(t),i=0;i<t;i+=1)n[i]=e[i];return n},MutableForwardIterator:ue}),ve=function(){function e(e){this.id=void 0,this.prefix=void 0,this.id=0|998*Math.random(),this.prefix=e?e+".":""}return e.prototype.getNewId=function(){return this.prefix+ ++this.id},e}();ve.global=new ve("global");var ge=new ve("TmpCId."),ye="undefined"==typeof Symbol?"__aliases__":Symbol("[[Aliases]]"),xe="__cid__";function Se(e){return"number"==typeof e||e instanceof Number}function Te(e){return"string"==typeof e||e instanceof String}function be(e){for(var t in e)return!1;return!0}var Ee,Ce=(Ee={value:void 0,enumerable:!1,writable:!1,configurable:!0},function(e,t,n,i,r){Ee.value=n,Ee.writable=i,Ee.enumerable=r,Object.defineProperty(e,t,Ee),Ee.value=void 0}),Ae=function(){var e={get:void 0,set:void 0,enumerable:!1};return function(t,n,i,r,o,a){void 0===o&&(o=!1),void 0===a&&(a=!1),"boolean"==typeof r&&(o=r,r=void 0),e.get=i,e.set=r,e.enumerable=o,e.configurable=a,Object.defineProperty(t,n,e),e.get=void 0,e.set=void 0}}(),we=function(){var e={get:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.get=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.get=void 0}}(),Pe=function(){var e={set:void 0,enumerable:!1,configurable:!1};return function(t,n,i,r,o){e.set=i,e.enumerable=r,e.configurable=o,Object.defineProperty(t,n,e),e.set=void 0}}();function Re(e){var t=Object.create(null);return e&&(t["."]=1,t["/"]=1,delete t["."],delete t["/"]),t}function Ie(e){if("function"==typeof e){var t=e.prototype;if(t&&t.hasOwnProperty("__classname__")&&t.__classname__)return t.__classname__;var n="";if(e.name&&(n=e.name),e.toString){var i,r=e.toString();(i="["===r.charAt(0)?r.match(/\[\w+\s*(\w+)\]/):r.match(/function\s*(\w+)/))&&2===i.length&&(n=i[1])}return"Object"!==n?n:""}return e&&e.constructor?Ie(e.constructor):""}function De(e,t,n,i){var r=/([^.]+)$/,o=r.exec(t)[0],a=r.exec(n)[0];function s(){return this[a]}i?Ae(e,o,s,(function(e){this[a]=e})):we(e,o,s)}function Oe(e,t,n,i){for(var r in n)De(e,t+"."+r,n[r],i)}var Me=/(%d)|(%s)/,Ne=/%s/;function Le(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(0===arguments.length)return"";if(0===n.length)return""+e;var r="string"==typeof e&&Me.test(e);if(r)for(var o,a=se(n);!(o=a()).done;){var s=o.value,c="number"==typeof s?Me:Ne;if(c.test(e)){var l=""+s;e=e.replace(c,l)}else e+=" "+s}else for(var u,h=se(n);!(u=h()).done;){var f=u.value;e+=" "+f}return e}function Be(){for(var e=arguments.length-1,t=new Array(e),n=0;n<e;++n)t[n]=arguments[n+1];return t}function Fe(e,t){for(;e;){var n=Object.getOwnPropertyDescriptor(e,t);if(n)return n;e=Object.getPrototypeOf(e)}return null}function ze(e,t,n){var i=Fe(t,e);i&&Object.defineProperty(n,e,i)}function Ue(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){M(5402,a);continue}for(var s in a)s in e||ze(s,a,e)}}return e}function ke(e){e=e||{};for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];if(a){if("object"!=typeof a){M(5403,a);continue}for(var s in a)ze(s,a,e)}}return e}function Ge(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e.prototype=Object.create(t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),e}function He(e){var t=e.prototype,n=t&&Object.getPrototypeOf(t);return n&&n.constructor}function Ve(e,t){if(e&&t){if("function"!=typeof e)return!1;if("function"!=typeof t)return!1;if(e===t)return!0;for(;;){if(!(e=He(e)))return!1;if(e===t)return!0}}return!1}function We(e){for(var t=0,n=Object.keys(e);t<n.length;t++)delete e[n[t]]}var je=Re(!0),qe=Re(!0);function Xe(e,t){return function(n,i){if(i.prototype.hasOwnProperty(e)&&delete t[i.prototype[e]],Ce(i.prototype,e,n),n){var r=t[n];r&&r!==i?T("A Class already exists with the same "+e+' : "'+n+'".'):t[n]=i}}}var Ye=Xe("__cid__",je),Ke=Xe("__classname__",qe);function Qe(e,t){if(Ke(e,t),!t.prototype.hasOwnProperty(xe)){var n=e||ge.getNewId();n&&Ye(n,t)}}function Ze(e,t){var n=qe[t],i=je[t],r=!0;if(n&&n!==e&&(T('"'+t+'" has already been set as name or alias of another class.'),r=!1),i&&i!==e&&(T('"'+t+'" has already been set as id or alias of another class.'),r=!1),r){var o=e[ye];o||(o=[],e[ye]=o),o.push(t),qe[t]=e,je[t]=e}}function Je(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0,r=t;i<r.length;i++){var o=r[i],a=o.prototype,s=a.__cid__;s&&delete je[s];var c=a.__classname__;c&&delete qe[c];var l=a[ye];if(l)for(var u=0;u<l.length;++u){var h=l[u];delete qe[h],delete je[h]}}}function $e(e){return je[e]}function et(e){return qe[e]}function tt(e,t){if(t=void 0===t||t,"function"==typeof e&&e.prototype.hasOwnProperty(xe))return e.prototype.__cid__;if(e&&e.constructor){var n=e.constructor.prototype;if(n&&n.hasOwnProperty(xe))return e.__cid__}return""}var nt=function(){var e=t.prototype;function t(e,t){this.count=void 0,this._pool=void 0,this._cleanup=void 0;var n=void 0===t?e:t,i=void 0===t?null:e;this.count=0,this._pool=new Array(n),this._cleanup=i}return e.get=function(){return this._get()},e._get=function(){if(this.count>0){--this.count;var e=this._pool[this.count];return this._pool[this.count]=null,e}return null},e.put=function(e){var t=this._pool;if(this.count<t.length){if(this._cleanup&&!1===this._cleanup(e))return;t[this.count]=e,++this.count}},e.resize=function(e){e>=0&&(this._pool.length=e,this.count>e&&(this.count=e))},t}(),it=me,rt={IDGenerator:ve,Pool:nt,array:me,isNumber:Se,isString:Te,isEmptyObject:be,getPropertyDescriptor:Fe,addon:Ue,mixin:ke,extend:Ge,getSuper:He,isChildClassOf:Ve,clear:We,value:Ce,getset:Ae,get:we,set:Pe,unregisterClass:Je,getClassName:Ie,setClassName:Qe,setClassAlias:Ze,getClassByName:et,get _registeredClassNames(){return J({},qe)},set _registeredClassNames(e){We(qe),Object.assign(qe,e)},get _registeredClassIds(){return J({},je)},set _registeredClassIds(e){We(je),Object.assign(je,e)},_getClassId:tt,_setClassId:Ye,_getClassById:$e,obsolete:De,obsoletes:Oe,formatStr:Le,shiftArguments:Be,createMap:Re};function ot(e){if("__bitmask__"in e)return e;Ce(e,"__bitmask__",null,!0);for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ce(e,a,r)}return e}function at(e,t){t>=0&&e.length,e.length}function st(e){return"__enums__"in e?e:(Ce(e,"__enums__",null,!0),st.update(e))}function ct(e){e.hasOwnProperty("__enums__")}function lt(e){ct(e);var t=e.__enums__||[];for(var n in t.length=0,e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),e.__enums__=t,t}function ut(e){"__enums__"in e||Ce(e,"__enums__",null,!0)}u.js=rt,e("js",Object.freeze({__proto__:null,array:it,js:rt,IDGenerator:ve,Pool:nt,isNumber:Se,isString:Te,isEmptyObject:be,value:Ce,getset:Ae,get:we,set:Pe,createMap:Re,getClassName:Ie,obsolete:De,obsoletes:Oe,formatStr:Le,shiftArguments:Be,getPropertyDescriptor:Fe,addon:Ue,mixin:ke,extend:Ge,getSuper:He,isChildClassOf:Ve,clear:We,_idToClass:je,_nameToClass:qe,_setClassId:Ye,setClassName:Qe,setClassAlias:Ze,unregisterClass:Je,_getClassById:$e,getClassByName:et,_getClassId:tt})),ot.isBitMask=function(e){return e&&e.hasOwnProperty("__bitmask__")},ot.getList=function(e){if(e.__bitmask__)return e.__bitmask__;var t=e.__bitmask__=[];for(var n in e){var i=e[n];Number.isInteger(i)&&t.push({name:n,value:i})}return t.sort((function(e,t){return e.value-t.value})),t},u.BitMask=ot,st.update=function(e){for(var t=-1,n=Object.keys(e),i=0;i<n.length;i++){var r=n[i],o=e[r];if(-1===o)o=++t,e[r]=o;else if("number"==typeof o)t=o;else if("string"==typeof o&&Number.isInteger(parseFloat(r)))continue;var a=""+o;r!==a&&Ce(e,a,r)}return Array.isArray(e.__enums__)&&lt(e),e},st||(st=e("Enum",{})),st.isEnum=function(e){return e&&e.hasOwnProperty("__enums__")},st.getList=function(e){return ct(e),e.__enums__?e.__enums__:lt(e)},u.Enum=st;var ht=e("ValueType",function(){function e(){}var t=e.prototype;return t.clone=function(){return M(100,Ie(this)+".clone"),this},t.equals=function(){return!1},t.set=function(){M(100,Ie(this)+".set")},t.toString=function(){return""+{}},e}());Qe("cc.ValueType",ht),u.ValueType=ht;var ft=e("macro",{SUPPORT_TEXTURE_FORMATS:[".astc",".pkm",".pvr",".webp",".jpg",".jpeg",".bmp",".png"],KEY:{none:0,back:6,menu:18,backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,select:41,insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,a:65,b:66,c:67,d:68,e:69,f:70,g:71,h:72,i:73,j:74,k:75,l:76,m:77,n:78,o:79,p:80,q:81,r:82,s:83,t:84,u:85,v:86,w:87,x:88,y:89,z:90,num0:96,num1:97,num2:98,num3:99,num4:100,num5:101,num6:102,num7:103,num8:104,num9:105,"*":106,"+":107,"-":109,numdel:110,"/":111,f1:112,f2:113,f3:114,f4:115,f5:116,f6:117,f7:118,f8:119,f9:120,f10:121,f11:122,f12:123,numlock:144,scrolllock:145,";":186,semicolon:186,equal:187,"=":187,",":188,comma:188,dash:189,".":190,period:190,forwardslash:191,grave:192,"[":219,openbracket:219,backslash:220,"]":221,closebracket:221,quote:222,dpadLeft:1e3,dpadRight:1001,dpadUp:1003,dpadDown:1004,dpadCenter:1005},RAD:Math.PI/180,DEG:180/Math.PI,REPEAT_FOREVER:Number.MAX_VALUE-1,FLT_EPSILON:1.192092896e-7,ORIENTATION_PORTRAIT:1,ORIENTATION_LANDSCAPE:2,ORIENTATION_AUTO:3,ENABLE_TILEDMAP_CULLING:!0,TOUCH_TIMEOUT:5e3,ENABLE_TRANSPARENT_CANVAS:!1,ENABLE_WEBGL_ANTIALIAS:!0,ENABLE_ANTIALIAS_FXAA:!1,ENABLE_BLOOM:!1,CLEANUP_IMAGE_CACHE:!1,ENABLE_MULTI_TOUCH:!0,MAX_LABEL_CANVAS_POOL_SIZE:20,ENABLE_WEBGL_HIGHP_STRUCT_VALUES:!1,BATCHER2D_MEM_INCREMENT:144});u.macro=ft;for(var _t=/^(?:cc|dragonBones|sp|ccsg)\..+/,pt=new Array(123),dt=0;dt<123;++dt)pt[dt]=64;for(var mt=0;mt<64;++mt)pt["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charCodeAt(mt)]=mt;var vt=pt;function gt(e,t,n){function i(e,t,n,i){var r=Object.getOwnPropertyDescriptor(e,t);if(r)r.get&&(e[n]=r.get),r.set&&i&&(e[i]=r.set);else{var o=e[n];Ae(e,t,o,e[i])}}for(var r,o=e.prototype,a=0;a<t.length;a++){var s=(r=t[a])[0].toUpperCase()+r.slice(1);i(o,r,"get"+s,"set"+s)}for(r in n){var c=n[r];i(o,r,c[0],c[1])}}function yt(e,t,n,i){var r=e[t];r?Array.isArray(r)?i?(r.push(r[0]),r[0]=n):r.push(n):e[t]=i?[n,r]:[r,n]:e[t]=n}function xt(e,t){if("function"==typeof e.contains)return e.contains(t);if("function"==typeof e.compareDocumentPosition)return!!(16&e.compareDocumentPosition(t));var n=t.parentNode;if(n)do{if(n===e)return!0;n=n.parentNode}while(null!==n);return!1}function St(e){return"object"==typeof window&&"function"==typeof Node?e instanceof Node:e&&"object"==typeof e&&"number"==typeof e.nodeType&&"string"==typeof e.nodeName}function Tt(e,t,n){e&&setTimeout((function(){e(t,n)}),0)}function bt(e){return!(!e||e.constructor!==Object)&&be(e)}function Et(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e<n?e:n}function Ct(e){return e*ft.RAD}function At(e){return e*ft.DEG}u.misc={BUILTIN_CLASSID_RE:_t,BASE64_VALUES:vt,propertyDefine:gt,pushToMap:yt,contains:xt,isDomNode:St,callInNextTick:Tt,isPlainEmptyObj_DEV:bt,clampf:Et,degreesToRadians:Ct,radiansToDegrees:At},e("misc",Object.freeze({__proto__:null,BUILTIN_CLASSID_RE:_t,BASE64_VALUES:vt,propertyDefine:gt,pushToMap:yt,contains:xt,isDomNode:St,callInNextTick:Tt,tryCatchFunctor_EDITOR:function(e){return Function("target","try {\n  target."+e+"();\n}\ncatch (e) {\n  cc._throw(e);\n}")},isPlainEmptyObj_DEV:bt,clampf:Et,degreesToRadians:Ct,radiansToDegrees:At}));var wt="$_$";function Pt(e,t){var n=t?Object.create(t):{};return Ce(e,"__attrs__",n),n}function Rt(e){if("function"!=typeof e)return Pt(e,Dt(e.constructor));for(var t,n=u.Class.getInheritanceChain(e),i=n.length-1;i>=0;i--){var r=n[i];r.hasOwnProperty("__attrs__")&&r.__attrs__||Pt(r,(t=n[i+1])&&t.__attrs__)}return Pt(e,(t=n[0])&&t.__attrs__),e.__attrs__}function It(e,t){var n=Dt(e),i=t+wt,r={};for(var o in n)o.startsWith(i)&&(r[o.slice(i.length)]=n[o]);return r}function Dt(e){return e.hasOwnProperty("__attrs__")&&e.__attrs__||Rt(e)}function Ot(e,t,n,i){Dt(e)[t+wt+n]=i}var Mt=function(){function e(e,t){this.name=void 0,this.default=void 0,this.name=e,this.default=t}return e.prototype.toString=function(){return this.name},e}(),Nt=e("CCInteger",new Mt("Integer",0));u.Integer=Nt,u.CCInteger=Nt;var Lt=e("CCFloat",new Mt("Float",0));u.Float=Lt,u.CCFloat=Lt;var Bt=e("CCBoolean",new Mt("Boolean",!1));u.Boolean=Bt,u.CCBoolean=Bt;var Ft=e("CCString",new Mt("String",""));function zt(e,t){return function(n,i){var r='"'+Ie(n)+"."+i+'"',o=It(n,i),a=o.type;if(a===Nt||a===Lt?a="Number":a!==Ft&&a!==Bt||(a=""+a),a===e){if(o.hasOwnProperty("default")){var s=o.default;if(void 0!==s&&!Array.isArray(s)&&!bt(s)){var c=typeof s,l=e.toLowerCase();if(c===l)if("object"===l){if(!s||s instanceof o.ctor)return;D(3605,r,Ie(o.ctor))}else"Number"!==e&&D(3606,t,r,e);else{if("function"===c)return;e===Ft.default&&null==s?D(3607,r):D(3611,t,r,c)}delete o.type}}}else D(3604,r)}}u.String=Ft,u.CCString=Ft;var Ut=Object.freeze({__proto__:null,DELIMETER:wt,createAttrsSingle:Pt,createAttrs:Rt,attr:It,getClassAttrs:Dt,setClassAttr:Ot,PrimitiveType:Mt,CCInteger:Nt,CCFloat:Lt,CCBoolean:Bt,CCString:Ft,getTypeChecker_ET:zt,getObjTypeChecker_ET:function(e){return function(t,n){zt("Object","type")(t,n);var i=Dt(t)[n+wt+"default"],r=u.Class.getDefault(i);if(!Array.isArray(r)&&Ve(e,u.ValueType)){var o=Ie(e),a=Le('No need to specify the "type" of "%s.%s" because %s is a child class of ValueType.',Ie(t),n,o);i?x(a):D(3612,a,o,Ie(t),n,o)}}}}),kt={default:{},serializable:{},editorOnly:{},formerlySerializedAs:{}};function Gt(e,t,n,i){if(!e.get&&!e.set&&e.hasOwnProperty("default")){var r="_N$"+t;e.get=function(){return this[r]},e.set=function(e){var t=this[r];this[r]=e,n.call(this,t)};var o={};for(var a in i[r]=o,kt){var s=kt[a];e.hasOwnProperty(a)&&(o[a]=e[a],s.canUsedInGet||delete e[a])}}}function Ht(e,t,n,i){if(Array.isArray(t)){if(!(t.length>0))return M(5508,n,i);e.type=t=t[0]}"function"==typeof t&&(t===String?e.type=u.String:t===Boolean?e.type=u.Boolean:t===Number&&(e.type=u.Float))}function Vt(e,t,n){var i=e?{_short:!0}:{_short:!0,default:t};return n&&(i.type=n),i}function Wt(e,t){if(!e||e.constructor!==Object){if(Array.isArray(e)&&e.length>0)return Vt(t,[],e);if("function"==typeof e){var n=e;return Vt(t,Ve(n,u.ValueType)?new n:null,n)}return Vt(t,e instanceof Mt?e.default:e)}return null}var jt=[];function qt(){return jt[jt.length-1]}u._RF={push:function(e,t,n,i){void 0===n&&(n=t,t=""),jt.push({uuid:t,script:n,module:e,exports:e.exports,beh:null,importMeta:i})},pop:function(){var e=jt.pop(),t=e.module,n=t.exports;if(n===e.exports){for(var i in n)return;t.exports=n=e.cls}},peek:qt};var Xt=wt,Yt={datas:null,push:function(e){if(this.datas)this.datas.push(e);else{this.datas=[e];var t=this;setTimeout((function(){t.init()}),0)}},init:function(){var e=this.datas;if(e){for(var t=0;t<e.length;++t){var n=e[t],i=n.cls,r=n.props;"function"==typeof r&&(r=r());var o=Ie(i);r?$t(i,o,r,i.$super,n.mixins):M(3633,o)}this.datas=null}}};function Kt(e,t,n,i){!function(e,t){!function(e,t){e.indexOf(t)<0&&e.push(t)}(e.__props__,t)}(e,n),nn(e,i,t,n)}function Qt(e,t,n,i){var r=i.get;i.set,r&&(nn(e,i,t,n),Ot(e,n,"serializable",!1))}function Zt(e){return"function"==typeof e?e():e}function Jt(e,t,n){for(var i in t)e.hasOwnProperty(i)||n&&!n(i)||Object.defineProperty(e,i,Fe(t,i))}function $t(e,t,n,i,r){if(e.__props__=[],i&&i.__props__&&(e.__props__=i.__props__.slice()),r)for(var o=0;o<r.length;++o){var a=r[o];a.__props__&&(e.__props__=e.__props__.concat(a.__props__.filter((function(t){return e.__props__.indexOf(t)<0}))))}if(n)for(var s in function(e,t){for(var n in e){var i=e[n],r=Wt(i,!1);if(r&&(i=e[n]=r),i){var o=i.notify;o&&Gt(i,n,o,e),"type"in i&&Ht(i,i.type,t,n)}}}(n,t),n){var c=n[s];c.get||c.set?Qt(e,t,s,c):Kt(e,t,s,c)}var l=Dt(e);e.__values__=e.__props__.filter((function(e){return!1!==l[e+Xt+"serializable"]}))}function en(e){var t=e.name,n=e.extends,i=e.mixins,r=function(e,t,n,i){var r=u.Component,o=qt();if(o&&Ve(t,r)){if(Ve(o.cls,r))return M(3615),null;e=e||o.script}var a=function(e,t,n,i){var r=i.ctor,o=[r],a=r;Ce(a,"__ctors__",o.length>0?o:null,!0);var s=a.prototype;if(t&&(a.$super=t),n){for(var c=n.length-1;c>=0;c--){var l=n[c];Jt(s,l.prototype),en._isCCClass(l)&&Jt(Dt(a),Dt(l))}s.constructor=a}return Qe(e,a),a}(e,t,n,i);if(o)if(Ve(t,r)){var s=o.uuid;s&&Ye(s,a),o.cls=a}else Ve(o.cls,r)||(o.cls=a);return a}(t,n,i,e);t||(t=u.js.getClassName(r)),r._sealed=!0,n&&(n._sealed=!1);var o=e.properties;"function"==typeof o||n&&null===n.__props__||i&&i.some((function(e){return null===e.__props__}))?(Yt.push({cls:r,props:o,mixins:i}),r.__props__=r.__values__=null):$t(r,t,o,n,e.mixins);var a=e.editor;return a&&Ve(n,u.Component)&&u.Component._registerEditorProps(r,a),r}en._isCCClass=function(e){var t;return null==e||null===(t=e.hasOwnProperty)||void 0===t?void 0:t.call(e,"__ctors__")},en.fastDefine=function(e,t,n){Qe(e,t);for(var i=t.__props__=t.__values__=Object.keys(n),r=Dt(t),o=0;o<i.length;o++){var a=i[o];r[a+Xt+"visible"]=!1,r[a+Xt+"default"]=n[a]}},en.Attr=Ut,en.attr=It,en.getInheritanceChain=function(e){for(var t=[];e=He(e);)e!==Object&&t.push(e);return t};var tn={Integer:"Number",Float:"Number",Boolean:"Boolean",String:"String"};function nn(e,t,n,i){var r=null,o="";function a(){return o=i+Xt,r=Dt(e)}"type"in t&&void 0===t.type&&D(3660,i,n);var s=t.type;s&&(tn[s]?(r||a())[o+"type"]=s:"Object"===s||("object"==typeof s?st.isEnum(s)?((r||a())[o+"type"]="Enum",r[o+"enumList"]=st.getList(s)):ot.isBitMask(s)&&((r||a())[o+"type"]="BitMask",r[o+"bitmaskList"]=ot.getList(s)):"function"==typeof s&&((r||a())[o+"type"]="Object",r[o+"ctor"]=s))),"default"in t&&((r||a())[o+"default"]=t.default);var c,l=function(e,n){if(e in t){var i=t[e];typeof i===n&&((r||a())[o+e]=i)}};t.editorOnly&&((r||a())[o+"editorOnly"]=!0),t.__noImplicit?(r||a())[o+"serializable"]=null!==(c=t.serializable)&&void 0!==c&&c:!1===t.serializable&&((r||a())[o+"serializable"]=!1),l("formerlySerializedAs","string");var u=t.range;u&&Array.isArray(u)&&u.length>=2&&((r||a())[o+"min"]=u[0],r[o+"max"]=u[1],u.length>2&&(r[o+"step"]=u[2])),l("min","number"),l("max","number"),l("step","number")}en.isArray=function(e){return e=Zt(e),Array.isArray(e)},en.getDefault=Zt,en.escapeForJS=function(e){return JSON.stringify(e).replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029")},en.IDENTIFIER_RE=/^[A-Za-z_$][0-9A-Za-z_$]*$/,en.getNewValueTypeCode=function(e){for(var t=Ie(e),n=e.constructor,i="new "+t+"(",r=0;r<n.__props__.length;r++)i+=e[n.__props__[r]],r<n.__props__.length-1&&(i+=",");return i+")"},u.Class=en;var rn=Math.PI/180,on=180/Math.PI,an=e("EPSILON",1e-6);function sn(e,t){return Math.abs(e-t)<=an*Math.max(1,Math.abs(e),Math.abs(t))}function cn(e,t,n){return n=n||an,Math.abs(e-t)<=n}function ln(e,t,n){if(t>n){var i=t;t=n,n=i}return e<t?t:e>n?n:e}function un(e){return e<0?0:e>1?1:e}function hn(e,t,n){return e+(t-e)*n}function fn(e){return e*rn}function _n(e){return e*on}var pn=e("random",Math.random);function dn(e,t){return Math.random()*(t-e)+e}function mn(e,t){return Math.floor(dn(e,t))}function vn(e){return(e=(9301*e+49297)%233280)/233280}function gn(e,t,n){return vn(e)*(n-t)+t}function yn(e,t,n){return Math.floor(gn(e,t,n))}function xn(e){return--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Sn(e,t){return e-Math.floor(e/t)*t}function Tn(e,t){return e=Sn(e,2*t),t-Math.abs(e-t)}function bn(e,t,n){return(n-e)/(t-e)}function En(e){return Math.abs(e.x)>Math.abs(e.y)?Math.abs(e.x)>Math.abs(e.z)?e.x:e.z:Math.abs(e.y)>Math.abs(e.z)?e.y:e.z}function Cn(e,t){return Math.abs(e)>Math.abs(t)?e:t}function An(e,t){t.forEach((function(t){Object.defineProperty(e,t,{enumerable:!0})}))}var wn=1/255,Pn=e("Color",function(e){function t(t,n,i,r){var o;return(o=e.call(this)||this)._val=0,"string"==typeof t?o.fromHEX(t):void 0!==n?o.set(t,n,i,r):o.set(t),o}$(t,e),t.clone=function(e){var n=new t;return e._val?n._val=e._val:n._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,n},t.copy=function(e,t){return e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a,e},t.set=function(e,t,n,i,r){return e.r=t,e.g=n,e.b=i,e.a=r,e},t.fromHEX=function(e,t){t=0===t.indexOf("#")?t.substring(1):t,e.r=parseInt(t.substr(0,2),16)||0,e.g=parseInt(t.substr(2,2),16)||0,e.b=parseInt(t.substr(4,2),16)||0;var n=parseInt(t.substr(6,2),16);return e.a=Number.isNaN(n)?255:n,e._val=(e.a<<24>>>0)+(e.b<<16)+(e.g<<8)+e.r,e},t.add=function(e,t,n){return e.r=t.r+n.r,e.g=t.g+n.g,e.b=t.b+n.b,e.a=t.a+n.a,e},t.subtract=function(e,t,n){return e.r=t.r-n.r,e.g=t.g-n.g,e.b=t.b-n.b,e.a=t.a-n.a,e},t.multiply=function(e,t,n){return e.r=t.r*n.r,e.g=t.g*n.g,e.b=t.b*n.b,e.a=t.a*n.a,e},t.divide=function(e,t,n){return e.r=t.r/n.r,e.g=t.g/n.g,e.b=t.b/n.b,e.a=t.a/n.a,e},t.scale=function(e,t,n){return e.r=t.r*n,e.g=t.g*n,e.b=t.b*n,e.a=t.a*n,e},t.lerp=function(e,t,n,i){var r=t.r,o=t.g,a=t.b,s=t.a;return r+=(n.r-r)*i,o+=(n.g-o)*i,a+=(n.b-a)*i,s+=(n.a-s)*i,e._val=Math.floor((s<<24>>>0)+(a<<16)+(o<<8)+r),e},t.toArray=function(e,n,i){void 0===i&&(i=0);var r=n instanceof t||n.a>1?1/255:1;return e[i+0]=n.r*r,e[i+1]=n.g*r,e[i+2]=n.b*r,e[i+3]=n.a*r,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),t.r=255*e[n+0],t.g=255*e[n+1],t.b=255*e[n+2],t.a=255*e[n+3],t},t.strictEquals=function(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.r-t.r)<=n*Math.max(1,Math.abs(e.r),Math.abs(t.r))&&Math.abs(e.g-t.g)<=n*Math.max(1,Math.abs(e.g),Math.abs(t.g))&&Math.abs(e.b-t.b)<=n*Math.max(1,Math.abs(e.b),Math.abs(t.b))&&Math.abs(e.a-t.a)<=n*Math.max(1,Math.abs(e.a),Math.abs(t.a))},t.hex=function(e){return(255*e.r<<24|255*e.g<<16|255*e.b<<8|255*e.a)>>>0};var n=t.prototype;return n.clone=function(){var e=new t;return e._val=this._val,e},n.equals=function(e){return e&&this._val===e._val},n.lerp=function(e,t){var n=this.r,i=this.g,r=this.b,o=this.a;return n+=(e.r-n)*t,i+=(e.g-i)*t,r+=(e.b-r)*t,o+=(e.a-o)*t,this._val=Math.floor((o<<24>>>0)+(r<<16)+(i<<8)+n),this},n.toString=function(){return"rgba("+this.r.toFixed()+", "+this.g.toFixed()+", "+this.b.toFixed()+", "+this.a.toFixed()+")"},n.toCSS=function(e){return void 0===e&&(e="rgba"),"rgba"===e?"rgba("+this.r+","+this.g+","+this.b+","+(this.a*wn).toFixed(2)+")":"rgb"===e?"rgb("+this.r+","+this.g+","+this.b+")":"#"+this.toHEX(e)},n.fromHEX=function(e){e=0===e.indexOf("#")?e.substring(1):e;var t=parseInt(e.substr(0,2),16)||0,n=parseInt(e.substr(2,2),16)||0,i=parseInt(e.substr(4,2),16)||0,r=parseInt(e.substr(6,2),16);return r=Number.isNaN(r)?255:r,this._val=(r<<24>>>0)+(i<<16)+(n<<8)+(0|t),this},n.toHEX=function(e){void 0===e&&(e="#rrggbb");var t="0",n=[(this.r<16?t:"")+this.r.toString(16),(this.g<16?t:"")+this.g.toString(16),(this.b<16?t:"")+this.b.toString(16)];return"#rgb"===e?(n[0]=n[0][0],n[1]=n[1][0],n[2]=n[2][0]):"#rrggbbaa"===e&&n.push((this.a<16?t:"")+this.a.toString(16)),n.join("")},n.toRGBValue=function(){return 16777215&this._val},n.fromHSV=function(e,t,n){var i=0,r=0,o=0;if(0===t)i=r=o=n;else if(0===n)i=r=o=0;else{1===e&&(e=0),e*=6;var a=Math.floor(e),s=e-a,c=n*(1-t),l=n*(1-t*s),u=n*(1-t*(1-s));switch(a){case 0:i=n,r=u,o=c;break;case 1:i=l,r=n,o=c;break;case 2:i=c,r=n,o=u;break;case 3:i=c,r=l,o=n;break;case 4:i=u,r=c,o=n;break;case 5:i=n,r=c,o=l}}return i*=255,r*=255,o*=255,this._val=(this.a<<24>>>0)+(o<<16)+(r<<8)+(0|i),this},n.toHSV=function(){var e=this.r*wn,t=this.g*wn,n=this.b*wn,i={h:0,s:0,v:0},r=Math.max(e,t,n),o=Math.min(e,t,n),a=0;return i.v=r,i.s=r?(r-o)/r:0,i.s?(a=r-o,i.h=e===r?(t-n)/a:t===r?2+(n-e)/a:4+(e-t)/a,i.h/=6,i.h<0&&(i.h+=1)):i.h=0,i},n.set=function(e,t,n,i){return"object"==typeof e?null!=e._val?this._val=e._val:(t=e.g||0,n=e.b||0,i="number"==typeof e.a?e.a:255,e=e.r||0,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)):(e=e||0,t=t||0,n=n||0,i="number"==typeof i?i:255,this._val=(i<<24>>>0)+(n<<16)+(t<<8)+(0|e)),this},n.multiply=function(e){var t=(255&this._val)*e.r>>8,n=(65280&this._val)*e.g>>8,i=(16711680&this._val)*e.b>>8,r=((4278190080&this._val)>>>8)*e.a;return this._val=4278190080&r|16711680&i|65280&n|255&t,this},n._set_r_unsafe=function(e){return this._val=(4294967040&this._val|e)>>>0,this},n._set_g_unsafe=function(e){return this._val=(4294902015&this._val|e<<8)>>>0,this},n._set_b_unsafe=function(e){return this._val=(4278255615&this._val|e<<16)>>>0,this},n._set_a_unsafe=function(e){return this._val=(16777215&this._val|e<<24)>>>0,this},Z(t,[{key:"r",get:function(){return 255&this._val},set:function(e){e=~~ln(e,0,255),this._val=(4294967040&this._val|e)>>>0}},{key:"g",get:function(){return(65280&this._val)>>8},set:function(e){e=~~ln(e,0,255),this._val=(4294902015&this._val|e<<8)>>>0}},{key:"b",get:function(){return(16711680&this._val)>>16},set:function(e){e=~~ln(e,0,255),this._val=(4278255615&this._val|e<<16)>>>0}},{key:"a",get:function(){return(4278190080&this._val)>>>24},set:function(e){e=~~ln(e,0,255),this._val=(16777215&this._val|e<<24)>>>0}},{key:"x",get:function(){return this.r*wn},set:function(e){this.r=255*e}},{key:"y",get:function(){return this.g*wn},set:function(e){this.g=255*e}},{key:"z",get:function(){return this.b*wn},set:function(e){this.b=255*e}},{key:"w",get:function(){return this.a*wn},set:function(e){this.a=255*e}}]),t}(ht));function Rn(e,t,n,i){return new Pn(e,t,n,i)}Pn.WHITE=Object.freeze(new Pn(255,255,255,255)),Pn.GRAY=Object.freeze(new Pn(127,127,127,255)),Pn.BLACK=Object.freeze(new Pn(0,0,0,255)),Pn.TRANSPARENT=Object.freeze(new Pn(0,0,0,0)),Pn.RED=Object.freeze(new Pn(255,0,0,255)),Pn.GREEN=Object.freeze(new Pn(0,255,0,255)),Pn.BLUE=Object.freeze(new Pn(0,0,255,255)),Pn.CYAN=Object.freeze(new Pn(0,255,255,255)),Pn.MAGENTA=Object.freeze(new Pn(255,0,255,255)),Pn.YELLOW=Object.freeze(new Pn(255,255,0,255)),en.fastDefine("cc.Color",Pn,{r:0,g:0,b:0,a:255}),u.Color=Pn,u.color=Rn;var In=e("Vec3",function(e){function t(t,n,i){var r;return r=e.call(this)||this,t&&"object"==typeof t?(r.x=t.x,r.y=t.y,r.z=t.z):(r.x=t||0,r.y=n||0,r.z=i||0),r}$(t,e),t.zero=function(e){return e.x=0,e.y=0,e.z=0,e},t.clone=function(e){return new t(e.x,e.y,e.z)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e},t.set=function(e,t,n,i){return e.x=t,e.y=n,e.z=i,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return Math.sqrt(n*n+i*i+r*r)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z;return n*n+i*i+r*r},t.len=function(e){var t=e.x,n=e.y,i=e.z;return Math.sqrt(t*t+n*n+i*i)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z;return t*t+n*n+i*i},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e},t.invert=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e},t.invertSafe=function(e,t){var n=t.x,i=t.y,r=t.z;return Math.abs(n)<an?e.x=0:e.x=1/n,Math.abs(i)<an?e.y=0:e.y=1/i,Math.abs(r)<an?e.z=0:e.z=1/r,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o),e.x=n*o,e.y=i*o,e.z=r*o),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},t.cross=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z;return e.x=r*c-o*s,e.y=o*a-i*c,e.z=i*s-r*a,e},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e},t.random=function(e,t){t=t||1;var n=2*pn()*Math.PI,i=2*pn()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o+n.m15;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o+n.m12)*a,e.y=(n.m01*i+n.m05*r+n.m09*o+n.m13)*a,e.z=(n.m02*i+n.m06*r+n.m10*o+n.m14)*a,e},t.transformMat4Normal=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.m03*i+n.m07*r+n.m11*o;return a=a?Math.abs(1/a):1,e.x=(n.m00*i+n.m04*r+n.m08*o)*a,e.y=(n.m01*i+n.m05*r+n.m09*o)*a,e.z=(n.m02*i+n.m06*r+n.m10*o)*a,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=i*n.m00+r*n.m03+o*n.m06,e.y=i*n.m01+r*n.m04+o*n.m07,e.z=i*n.m02+r*n.m05+o*n.m08,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13,e.x=n.m02*i+n.m06*r+n.m10*o+n.m14,e},t.transformQuat=function(e,t,n){var i=n.w*t.x+n.y*t.z-n.z*t.y,r=n.w*t.y+n.z*t.x-n.x*t.z,o=n.w*t.z+n.x*t.y-n.y*t.x,a=-n.x*t.x-n.y*t.y-n.z*t.z;return e.x=i*n.w+a*-n.x+r*-n.z-o*-n.y,e.y=r*n.w+a*-n.y+o*-n.x-i*-n.z,e.z=o*n.w+a*-n.z+i*-n.y-r*-n.x,e},t.transformRTS=function(e,t,n,i,r){var o=t.x*r.x,a=t.y*r.y,s=t.z*r.z,c=n.w*o+n.y*s-n.z*a,l=n.w*a+n.z*o-n.x*s,u=n.w*s+n.x*a-n.y*o,h=-n.x*o-n.y*a-n.z*s;return e.x=c*n.w+h*-n.x+l*-n.z-u*-n.y+i.x,e.y=l*n.w+h*-n.y+u*-n.x-c*-n.z+i.y,e.z=u*n.w+h*-n.z+c*-n.y-l*-n.x+i.z,e},t.transformInverseRTS=function(e,t,n,i,r){var o=t.x-i.x,a=t.y-i.y,s=t.z-i.z,c=n.w*o-n.y*s+n.z*a,l=n.w*a-n.z*o+n.x*s,u=n.w*s-n.x*a+n.y*o,h=n.x*o+n.y*a+n.z*s;return e.x=(c*n.w+h*n.x+l*n.z-u*n.y)/r.x,e.y=(l*n.w+h*n.y+u*n.x-c*n.z)/r.y,e.z=(u*n.w+h*n.z+c*n.y-l*n.x)/r.z,e},t.rotateX=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r,u=o*s-a*c,h=o*c+a*s;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateY=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=a*c+r*s,u=o,h=a*s-r*c;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.rotateZ=function(e,t,n,i){var r=t.x-n.x,o=t.y-n.y,a=t.z-n.z,s=Math.cos(i),c=Math.sin(i),l=r*s-o*c,u=r*c+o*s,h=a;return e.x=l+n.x,e.y=u+n.y,e.z=h+n.z,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z},t.equals=function(e,t,n){void 0===n&&(n=an);var i=e.x,r=e.y,o=e.z,a=t.x,s=t.y,c=t.z;return Math.abs(i-a)<=n*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(r-s)<=n*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(o-c)<=n*Math.max(1,Math.abs(o),Math.abs(c))},t.angle=function(e,n){t.normalize(Dn,e),t.normalize(On,n);var i=t.dot(Dn,On);return i>1?0:i<-1?Math.PI:Math.acos(i)},t.projectOnPlane=function(e,n,i){return t.subtract(e,n,t.project(e,n,i))},t.project=function(e,n,i){var r=t.lengthSqr(i);return r<1e-6?t.set(e,0,0,0):t.multiplyScalar(e,i,t.dot(n,i)/r)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z)},n.set=function(e,t,n){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z):(this.x=e||0,this.y=t||0,this.z=n||0),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))},n.equals3f=function(e,t,n,i){return void 0===i&&(i=an),Math.abs(this.x-e)<=i*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=i*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=i*Math.max(1,Math.abs(this.z),Math.abs(n))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z},n.strictEquals3f=function(e,t,n){return this.x===e&&this.y===t&&this.z===n},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+")"},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},n.add3f=function(e,t,n){return this.x+=e,this.y+=t,this.z+=n,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},n.subtract3f=function(e,t,n){return this.x-=e,this.y-=t,this.z-=n,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec3.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec3.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this},n.multiply3f=function(e,t,n){return this.x*=e,this.y*=t,this.z*=n,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},n.divide3f=function(e,t,n){return this.x/=e,this.y/=t,this.z/=n,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},n.clampf=function(e,t){return this.x=ln(this.x,e.x,t.x),this.y=ln(this.y,e.y,t.y),this.z=ln(this.z,e.z,t.z),this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=e*e+t*t+n*n;return i>0&&(i=1/Math.sqrt(i),this.x=e*i,this.y=t*i,this.z=n*i),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=e.m03*t+e.m07*n+e.m11*i+e.m15;return r=r?1/r:1,this.x=(e.m00*t+e.m04*n+e.m08*i+e.m12)*r,this.y=(e.m01*t+e.m05*n+e.m09*i+e.m13)*r,this.z=(e.m02*t+e.m06*n+e.m10*i+e.m14)*r,this},t}(ht));In.UNIT_X=Object.freeze(new In(1,0,0)),In.UNIT_Y=Object.freeze(new In(0,1,0)),In.UNIT_Z=Object.freeze(new In(0,0,1)),In.RIGHT=Object.freeze(new In(1,0,0)),In.UP=Object.freeze(new In(0,1,0)),In.FORWARD=Object.freeze(new In(0,0,-1)),In.ZERO=Object.freeze(new In(0,0,0)),In.ONE=Object.freeze(new In(1,1,1)),In.NEG_ONE=Object.freeze(new In(-1,-1,-1));var Dn=new In,On=new In;function Mn(e,t,n){return new In(e,t,n)}en.fastDefine("cc.Vec3",In,{x:0,y:0,z:0}),u.Vec3=In,u.v3=Mn;var Nn=e("Mat3",function(e){function t(t,n,i,r,o,a,s,c,l){var u;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),u=e.call(this)||this,"object"==typeof t?(u.m00=t.m00,u.m01=t.m01,u.m02=t.m02,u.m03=t.m03,u.m04=t.m04,u.m05=t.m05,u.m06=t.m06,u.m07=t.m07,u.m08=t.m08):(u.m00=t,u.m01=n,u.m02=i,u.m03=r,u.m04=o,u.m05=a,u.m06=s,u.m07=c,u.m08=l),u}$(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.set=function(e,t,n,i,r,o,a,s,c,l){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m05;e.m01=t.m03,e.m02=t.m06,e.m03=n,e.m05=t.m07,e.m06=i,e.m07=r}else e.m00=t.m00,e.m01=t.m03,e.m02=t.m06,e.m03=t.m01,e.m04=t.m04,e.m05=t.m07,e.m06=t.m02,e.m07=t.m05,e.m08=t.m08;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=u*a-s*l,f=-u*o+s*c,_=l*o-a*c,p=n*h+i*f+r*_;return 0===p?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e):(p=1/p,e.m00=h*p,e.m01=(-u*i+r*l)*p,e.m02=(s*i-r*a)*p,e.m03=f*p,e.m04=(u*n-r*c)*p,e.m05=(-s*n+r*o)*p,e.m06=_*p,e.m07=(-l*n+i*c)*p,e.m08=(a*n-i*o)*p,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08;return t*(l*o-a*c)+n*(-l*r+a*s)+i*(c*r-o*s)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.m00,_=n.m01,p=n.m02,d=n.m03,m=n.m04,v=n.m05,g=n.m06,y=n.m07,x=n.m08;return e.m00=f*i+_*a+p*l,e.m01=f*r+_*s+p*u,e.m02=f*o+_*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.multiplyMat4=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.m00,_=n.m01,p=n.m02,d=n.m04,m=n.m05,v=n.m06,g=n.m08,y=n.m09,x=n.m10;return e.m00=f*i+_*a+p*l,e.m01=f*r+_*s+p*u,e.m02=f*o+_*c+p*h,e.m03=d*i+m*a+v*l,e.m04=d*r+m*s+v*u,e.m05=d*o+m*c+v*h,e.m06=g*i+y*a+x*l,e.m07=g*r+y*s+x*u,e.m08=g*o+y*c+x*h,e},t.transform=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=n.x,_=n.y;return e.m00=i,e.m01=r,e.m02=o,e.m03=a,e.m04=s,e.m05=c,e.m06=f*i+_*a+l,e.m07=f*r+_*s+u,e.m08=f*o+_*c+h,e},t.scale=function(e,t,n){var i=n.x,r=n.y;return e.m00=i*t.m00,e.m01=i*t.m01,e.m02=i*t.m02,e.m03=r*t.m03,e.m04=r*t.m04,e.m05=r*t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e},t.rotate=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=Math.sin(n),_=Math.cos(n);return e.m00=_*i+f*a,e.m01=_*r+f*s,e.m02=_*o+f*c,e.m03=_*a-f*i,e.m04=_*s-f*r,e.m05=_*c-f*o,e.m06=l,e.m07=u,e.m08=h,e},t.fromMat4=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m04,e.m04=t.m05,e.m05=t.m06,e.m06=t.m08,e.m07=t.m09,e.m08=t.m10,e},t.fromViewUp=function(e,n,i){return In.lengthSqr(n)<an*an?(t.identity(e),e):(i=i||In.UNIT_Y,In.normalize(Ln,In.cross(Ln,i,n)),In.lengthSqr(Ln)<an*an?(t.identity(e),e):(In.cross(Bn,n,Ln),t.set(e,Ln.x,Ln.y,Ln.z,Bn.x,Bn.y,Bn.z,n.x,n.y,n.z),e))},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=1,e.m05=0,e.m06=t.x,e.m07=t.y,e.m08=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=t.y,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=-n,e.m04=i,e.m05=0,e.m06=0,e.m07=0,e.m08=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,_=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m03=u-v,e.m06=f+m,e.m01=u+v,e.m04=1-l-p,e.m07=_-d,e.m02=f-m,e.m05=_+d,e.m08=1-l-h,e},t.inverseTransposeMat4=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,b=r*l-o*c,E=u*d-h*p,C=u*m-f*p,A=u*v-_*p,w=h*m-f*d,P=h*v-_*d,R=f*v-_*m,I=g*R-y*P+x*w+S*A-T*C+b*E;return I?(I=1/I,e.m00=(s*R-c*P+l*w)*I,e.m01=(c*A-a*R-l*C)*I,e.m02=(a*P-s*A+l*E)*I,e.m03=(r*P-i*R-o*w)*I,e.m04=(n*R-r*A+o*C)*I,e.m05=(i*A-n*P-o*E)*I,e.m06=(d*b-m*T+v*S)*I,e.m07=(m*x-p*b-v*y)*I,e.m08=(p*T-d*x+v*g)*I,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=n.m00*i+t.m00,e.m01=n.m01*i+t.m01,e.m02=n.m02*i+t.m02,e.m03=n.m03*i+t.m03,e.m04=n.m04*i+t.m04,e.m05=n.m05*i+t.m05,e.m06=n.m06*i+t.m06,e.m07=n.m07*i+t.m07,e.m08=n.m08*i+t.m08,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))};var n=t.prototype;return n.clone=function(){var e=this;return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08)},n.set=function(e,t,n,i,r,o,a,s,c){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=1),"object"==typeof e?(this.m00=e.m00,this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08):(this.m00=e,this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08},n.toString=function(){var e=this;return"[\n"+e.m00+", "+e.m01+", "+e.m02+",\n"+e.m03+",\n"+e.m04+", "+e.m05+",\n"+e.m06+", "+e.m07+",\n"+e.m08+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=1,this.m05=0,this.m06=0,this.m07=0,this.m08=1,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m05;return this.m01=this.m03,this.m02=this.m06,this.m03=e,this.m05=this.m07,this.m06=t,this.m07=n,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=c*r-o*s,u=-c*i+o*a,h=s*i-r*a,f=e*l+t*u+n*h;return 0===f?(this.set(0,0,0,0,0,0,0,0,0),this):(f=1/f,this.m00=l*f,this.m01=(-c*t+n*s)*f,this.m02=(o*t-n*r)*f,this.m03=u*f,this.m04=(c*e-n*a)*f,this.m05=(-o*e+n*i)*f,this.m06=h*f,this.m07=(-s*e+t*a)*f,this.m08=(r*e-t*i)*f,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08;return e*(c*r-o*s)+t*(-c*i+o*a)+n*(s*i-r*a)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=e.m00,h=e.m01,f=e.m02,_=e.m03,p=e.m04,d=e.m05,m=e.m06,v=e.m07,g=e.m08;return this.m00=u*t+h*r+f*s,this.m01=u*n+h*o+f*c,this.m02=u*i+h*a+f*l,this.m03=_*t+p*r+d*s,this.m04=_*n+p*o+d*c,this.m05=_*i+p*a+d*l,this.m06=m*t+v*r+g*s,this.m07=m*n+v*o+g*c,this.m08=m*i+v*a+g*l,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this},n.scale=function(e){var t=e.x,n=e.y;return this.m00=t*this.m00,this.m01=t*this.m01,this.m02=t*this.m02,this.m03=n*this.m03,this.m04=n*this.m04,this.m05=n*this.m05,this.m06=this.m06,this.m07=this.m07,this.m08=this.m08,this},n.rotate=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=Math.sin(e),h=Math.cos(e);return this.m00=h*t+u*r,this.m01=h*n+u*o,this.m02=h*i+u*a,this.m03=h*r-u*t,this.m04=h*o-u*n,this.m05=h*a-u*i,this.m06=s,this.m07=c,this.m08=l,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,f=i*a,_=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-_,this.m03=l-m,this.m06=h+d,this.m01=l+m,this.m04=1-c-_,this.m07=f-p,this.m02=h-d,this.m05=f+p,this.m08=1-c-u,this},t}(ht));Nn.IDENTITY=Object.freeze(new Nn);var Ln=new In,Bn=new In;en.fastDefine("cc.Mat3",Nn,{m00:1,m01:0,m02:0,m03:0,m04:1,m05:0,m06:0,m07:0,m08:1}),u.Mat3=Nn;var Fn=e("Quat",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=null!=r?r:1),o}$(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.identity=function(e){return e.x=0,e.y=0,e.z=0,e.w=1,e},t.rotationTo=function(e,n,i){var r=In.dot(n,i);return r<-.999999?(In.cross(kn,In.UNIT_X,n),kn.length()<1e-6&&In.cross(kn,In.UNIT_Y,n),In.normalize(kn,kn),t.fromAxisAngle(e,kn,Math.PI),e):r>.999999?(e.x=0,e.y=0,e.z=0,e.w=1,e):(In.cross(kn,n,i),e.x=kn.x,e.y=kn.y,e.z=kn.z,e.w=1+r,t.normalize(e,e))},t.getAxisAngle=function(e,t){var n=2*Math.acos(t.w),i=Math.sin(n/2);return 0!==i?(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i):(e.x=1,e.y=0,e.z=0),n},t.multiply=function(e,t,n){var i=t.x*n.w+t.w*n.x+t.y*n.z-t.z*n.y,r=t.y*n.w+t.w*n.y+t.z*n.x-t.x*n.z,o=t.z*n.w+t.w*n.z+t.x*n.y-t.y*n.x,a=t.w*n.w-t.x*n.x-t.y*n.y-t.z*n.z;return e.x=i,e.y=r,e.z=o,e.w=a,e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.rotateX=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+c*i,e.y=a*r+s*i,e.z=s*r-a*i,e.w=c*r-o*i,e},t.rotateY=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r-s*i,e.y=a*r+c*i,e.z=s*r+o*i,e.w=c*r-a*i,e},t.rotateZ=function(e,t,n){n*=.5;var i=Math.sin(n),r=Math.cos(n),o=t.x,a=t.y,s=t.z,c=t.w;return e.x=o*r+a*i,e.y=a*r-o*i,e.z=s*r+c*i,e.w=c*r-s*i,e},t.rotateAround=function(e,n,i,r){return t.invert(zn,n),In.transformQuat(kn,i,zn),t.fromAxisAngle(zn,kn,r),t.multiply(e,n,zn),e},t.rotateAroundLocal=function(e,n,i,r){return t.fromAxisAngle(zn,i,r),t.multiply(e,n,zn),e},t.calculateW=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=Math.sqrt(Math.abs(1-t.x*t.x-t.y*t.y-t.z*t.z)),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.slerp=function(e,t,n,i){var r=0,o=0,a=n.x,s=n.y,c=n.z,l=n.w,u=t.x*n.x+t.y*n.y+t.z*n.z+t.w*n.w;if(u<0&&(u=-u,a=-a,s=-s,c=-c,l=-l),1-u>1e-6){var h=Math.acos(u),f=Math.sin(h);r=Math.sin((1-i)*h)/f,o=Math.sin(i*h)/f}else r=1-i,o=i;return e.x=r*t.x+o*a,e.y=r*t.y+o*s,e.z=r*t.z+o*c,e.w=r*t.w+o*l,e},t.sqlerp=function(e,n,i,r,o,a){return t.slerp(zn,n,o,a),t.slerp(Un,i,r,a),t.slerp(e,zn,Un,2*a*(1-a)),e},t.invert=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w,i=n?1/n:0;return e.x=-t.x*i,e.y=-t.y*i,e.z=-t.z*i,e.w=t.w*i,e},t.conjugate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=t.w,e},t.len=function(e){return Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w)},t.lengthSqr=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.normalize=function(e,t){var n=t.x*t.x+t.y*t.y+t.z*t.z+t.w*t.w;return n>0&&(n=1/Math.sqrt(n),e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n),e},t.fromAxes=function(e,n,i,r){return Nn.set(Gn,n.x,n.y,n.z,i.x,i.y,i.z,r.x,r.y,r.z),t.normalize(e,t.fromMat3(e,Gn))},t.fromViewUp=function(e,n,i){return Nn.fromViewUp(Gn,n,i),t.normalize(e,t.fromMat3(e,Gn))},t.fromAxisAngle=function(e,t,n){n*=.5;var i=Math.sin(n);return e.x=i*t.x,e.y=i*t.y,e.z=i*t.z,e.w=Math.cos(n),e},t.fromMat3=function(e,t){var n=t.m00,i=t.m03,r=t.m06,o=t.m01,a=t.m04,s=t.m07,c=t.m02,l=t.m05,u=t.m08,h=n+a+u;if(h>0){var f=.5/Math.sqrt(h+1);e.w=.25/f,e.x=(l-s)*f,e.y=(r-c)*f,e.z=(o-i)*f}else if(n>a&&n>u){var _=2*Math.sqrt(1+n-a-u);e.w=(l-s)/_,e.x=.25*_,e.y=(i+o)/_,e.z=(r+c)/_}else if(a>u){var p=2*Math.sqrt(1+a-n-u);e.w=(r-c)/p,e.x=(i+o)/p,e.y=.25*p,e.z=(s+l)/p}else{var d=2*Math.sqrt(1+u-n-a);e.w=(o-i)/d,e.x=(r+c)/d,e.y=(s+l)/d,e.z=.25*d}return e},t.fromEuler=function(e,t,n,i){t*=Hn,n*=Hn,i*=Hn;var r=Math.sin(t),o=Math.cos(t),a=Math.sin(n),s=Math.cos(n),c=Math.sin(i),l=Math.cos(i);return e.x=r*s*l+o*a*c,e.y=o*a*l+r*s*c,e.z=o*s*c-r*a*l,e.w=o*s*l-r*a*c,e},t.fromAngleZ=function(e,t){return t*=Hn,e.x=e.y=0,e.z=Math.sin(t),e.w=Math.cos(t),e},t.toAxisX=function(e,t){var n=2*t.y,i=2*t.z;return e.x=1-n*t.y-i*t.z,e.y=n*t.x+i*t.w,e.z=i*t.x+n*t.w,e},t.toAxisY=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=i*t.x-r*t.w,e.y=1-n*t.x-r*t.z,e.z=r*t.y+n*t.w,e},t.toAxisZ=function(e,t){var n=2*t.x,i=2*t.y,r=2*t.z;return e.x=r*t.x-i*t.w,e.y=r*t.y-n*t.w,e.z=1-n*t.x-i*t.y,e},t.toEuler=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=0,c=0,l=0,u=i*r+o*a;if(u>.499999)s=0,c=_n(2*Math.atan2(i,a)),l=90;else if(u<-.499999)s=0,c=-_n(2*Math.atan2(i,a)),l=-90;else{var h=i*i,f=r*r,_=o*o;s=_n(Math.atan2(2*i*a-2*r*o,1-2*h-2*_)),c=_n(Math.atan2(2*r*a-2*i*o,1-2*f-2*_)),l=_n(Math.asin(2*u)),n&&(s=-180*Math.sign(s+1e-6)+s,c=-180*Math.sign(c+1e-6)+c,l=180*Math.sign(l+1e-6)-l)}return e.x=s,e.y=c,e.z=l,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=null!=i?i:1),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.getEulerAngles=function(e){return t.toEuler(e,this)},n.lerp=function(e,t){return this.x+=t*(e.x-this.x),this.y+=t*(e.y-this.y),this.z+=t*(e.z-this.z),this.w+=t*(e.w-this.w),this},n.slerp=function(e,n){return t.slerp(this,this,e,n)},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},t}(ht));Fn.IDENTITY=Object.freeze(new Fn);var zn=new Fn,Un=new Fn,kn=new In,Gn=new Nn,Hn=.5*Math.PI/180;function Vn(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),new Fn(e,t,n,i)}en.fastDefine("cc.Quat",Fn,{x:0,y:0,z:0,w:1}),u.Quat=Fn,u.quat=Vn;var Wn=Object.freeze([Object.freeze([1,0,0,1]),Object.freeze([0,1,-1,0]),Object.freeze([-1,0,0,-1]),Object.freeze([0,-1,1,0])]),jn=e("Mat4",function(e){function t(t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m){var v;return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=1),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=1),(v=e.call(this)||this).m00=void 0,v.m01=void 0,v.m02=void 0,v.m03=void 0,v.m04=void 0,v.m05=void 0,v.m06=void 0,v.m07=void 0,v.m08=void 0,v.m09=void 0,v.m10=void 0,v.m11=void 0,v.m12=void 0,v.m13=void 0,v.m14=void 0,v.m15=void 0,"object"==typeof t?(v.m00=t.m00,v.m01=t.m01,v.m02=t.m02,v.m03=t.m03,v.m04=t.m04,v.m05=t.m05,v.m06=t.m06,v.m07=t.m07,v.m08=t.m08,v.m09=t.m09,v.m10=t.m10,v.m11=t.m11,v.m12=t.m12,v.m13=t.m13,v.m14=t.m14,v.m15=t.m15):(v.m00=t,v.m01=n,v.m02=i,v.m03=r,v.m04=o,v.m05=a,v.m06=s,v.m07=c,v.m08=l,v.m09=u,v.m10=h,v.m11=f,v.m12=_,v.m13=p,v.m14=d,v.m15=m),v}$(t,e),t.clone=function(e){return new t(e.m00,e.m01,e.m02,e.m03,e.m04,e.m05,e.m06,e.m07,e.m08,e.m09,e.m10,e.m11,e.m12,e.m13,e.m14,e.m15)},t.copy=function(e,t){return e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.set=function(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m){return e.m00=t,e.m01=n,e.m02=i,e.m03=r,e.m04=o,e.m05=a,e.m06=s,e.m07=c,e.m08=l,e.m09=u,e.m10=h,e.m11=f,e.m12=_,e.m13=p,e.m14=d,e.m15=m,e},t.identity=function(e){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.transpose=function(e,t){if(e===t){var n=t.m01,i=t.m02,r=t.m03,o=t.m06,a=t.m07,s=t.m11;e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=n,e.m06=t.m09,e.m07=t.m13,e.m08=i,e.m09=o,e.m11=t.m14,e.m12=r,e.m13=a,e.m14=s}else e.m00=t.m00,e.m01=t.m04,e.m02=t.m08,e.m03=t.m12,e.m04=t.m01,e.m05=t.m05,e.m06=t.m09,e.m07=t.m13,e.m08=t.m02,e.m09=t.m06,e.m10=t.m10,e.m11=t.m14,e.m12=t.m03,e.m13=t.m07,e.m14=t.m11,e.m15=t.m15;return e},t.invert=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,b=r*l-o*c,E=u*d-h*p,C=u*m-f*p,A=u*v-_*p,w=h*m-f*d,P=h*v-_*d,R=f*v-_*m,I=g*R-y*P+x*w+S*A-T*C+b*E;return 0===I?(e.m00=0,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=0,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=0,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=0,e):(I=1/I,e.m00=(s*R-c*P+l*w)*I,e.m01=(r*P-i*R-o*w)*I,e.m02=(d*b-m*T+v*S)*I,e.m03=(f*T-h*b-_*S)*I,e.m04=(c*A-a*R-l*C)*I,e.m05=(n*R-r*A+o*C)*I,e.m06=(m*x-p*b-v*y)*I,e.m07=(u*b-f*x+_*y)*I,e.m08=(a*P-s*A+l*E)*I,e.m09=(i*A-n*P-o*E)*I,e.m10=(p*T-d*x+v*g)*I,e.m11=(h*x-u*T-_*g)*I,e.m12=(s*C-a*w-c*E)*I,e.m13=(n*w-i*C+r*E)*I,e.m14=(d*y-p*S-m*g)*I,e.m15=(u*S-h*y+f*g)*I,e)},t.determinant=function(e){var t=e.m00,n=e.m01,i=e.m02,r=e.m03,o=e.m04,a=e.m05,s=e.m06,c=e.m07,l=e.m08,u=e.m09,h=e.m10,f=e.m11,_=e.m12,p=e.m13,d=e.m14,m=e.m15;return(t*a-n*o)*(h*m-f*d)-(t*s-i*o)*(u*m-f*p)+(t*c-r*o)*(u*d-h*p)+(n*s-i*a)*(l*m-f*_)-(n*c-r*a)*(l*d-h*_)+(i*c-r*s)*(l*p-u*_)},t.multiply=function(e,t,n){var i=t.m00,r=t.m01,o=t.m02,a=t.m03,s=t.m04,c=t.m05,l=t.m06,u=t.m07,h=t.m08,f=t.m09,_=t.m10,p=t.m11,d=t.m12,m=t.m13,v=t.m14,g=t.m15,y=n.m00,x=n.m01,S=n.m02,T=n.m03;return e.m00=y*i+x*s+S*h+T*d,e.m01=y*r+x*c+S*f+T*m,e.m02=y*o+x*l+S*_+T*v,e.m03=y*a+x*u+S*p+T*g,y=n.m04,x=n.m05,S=n.m06,T=n.m07,e.m04=y*i+x*s+S*h+T*d,e.m05=y*r+x*c+S*f+T*m,e.m06=y*o+x*l+S*_+T*v,e.m07=y*a+x*u+S*p+T*g,y=n.m08,x=n.m09,S=n.m10,T=n.m11,e.m08=y*i+x*s+S*h+T*d,e.m09=y*r+x*c+S*f+T*m,e.m10=y*o+x*l+S*_+T*v,e.m11=y*a+x*u+S*p+T*g,y=n.m12,x=n.m13,S=n.m14,T=n.m15,e.m12=y*i+x*s+S*h+T*d,e.m13=y*r+x*c+S*f+T*m,e.m14=y*o+x*l+S*_+T*v,e.m15=y*a+x*u+S*p+T*g,e},t.transform=function(e,t,n){var i=n.x,r=n.y,o=n.z;if(t===e)e.m12=t.m00*i+t.m04*r+t.m08*o+t.m12,e.m13=t.m01*i+t.m05*r+t.m09*o+t.m13,e.m14=t.m02*i+t.m06*r+t.m10*o+t.m14,e.m15=t.m03*i+t.m07*r+t.m11*o+t.m15;else{var a=t.m00,s=t.m01,c=t.m02,l=t.m03,u=t.m04,h=t.m05,f=t.m06,_=t.m07,p=t.m08,d=t.m09,m=t.m10,v=t.m11;t.m12,t.m13,t.m14,t.m15,e.m00=a,e.m01=s,e.m02=c,e.m03=l,e.m04=u,e.m05=h,e.m06=f,e.m07=_,e.m08=p,e.m09=d,e.m10=m,e.m11=v,e.m12=a*i+u*r+p*o+t.m12,e.m13=s*i+h*r+d*o+t.m13,e.m14=c*i+f*r+m*o+t.m14,e.m15=l*i+_*r+v*o+t.m15}return e},t.translate=function(e,t,n){return console.warn("function changed"),t===e?(e.m12+=n.x,e.m13+=n.y,e.m14+=n.z):(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12+=n.x,e.m13+=n.y,e.m14+=n.z,e.m15=t.m15),e},t.scale=function(e,t,n){var i=n.x,r=n.y,o=n.z;return e.m00=t.m00*i,e.m01=t.m01*i,e.m02=t.m02*i,e.m03=t.m03*i,e.m04=t.m04*r,e.m05=t.m05*r,e.m06=t.m06*r,e.m07=t.m07*r,e.m08=t.m08*o,e.m09=t.m09*o,e.m10=t.m10*o,e.m11=t.m11*o,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15,e},t.rotate=function(e,t,n,i){var r=i.x,o=i.y,a=i.z,s=Math.sqrt(r*r+o*o+a*a);if(Math.abs(s)<an)return null;r*=s=1/s,o*=s,a*=s;var c=Math.sin(n),l=Math.cos(n),u=1-l,h=t.m00,f=t.m01,_=t.m02,p=t.m03,d=t.m04,m=t.m05,v=t.m06,g=t.m07,y=t.m08,x=t.m09,S=t.m10,T=t.m11,b=r*r*u+l,E=o*r*u+a*c,C=a*r*u-o*c,A=r*o*u-a*c,w=o*o*u+l,P=a*o*u+r*c,R=r*a*u+o*c,I=o*a*u-r*c,D=a*a*u+l;return e.m00=h*b+d*E+y*C,e.m01=f*b+m*E+x*C,e.m02=_*b+v*E+S*C,e.m03=p*b+g*E+T*C,e.m04=h*A+d*w+y*P,e.m05=f*A+m*w+x*P,e.m06=_*A+v*w+S*P,e.m07=p*A+g*w+T*P,e.m08=h*R+d*I+y*D,e.m09=f*R+m*I+x*D,e.m10=_*R+v*I+S*D,e.m11=p*R+g*I+T*D,t!==e&&(e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e},t.rotateX=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m04,a=t.m05,s=t.m06,c=t.m07,l=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m00=t.m00,e.m01=t.m01,e.m02=t.m02,e.m03=t.m03,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m04=o*r+l*i,e.m05=a*r+u*i,e.m06=s*r+h*i,e.m07=c*r+f*i,e.m08=l*r-o*i,e.m09=u*r-a*i,e.m10=h*r-s*i,e.m11=f*r-c*i,e},t.rotateY=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m08,u=t.m09,h=t.m10,f=t.m11;return t!==e&&(e.m04=t.m04,e.m05=t.m05,e.m06=t.m06,e.m07=t.m07,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r-l*i,e.m01=a*r-u*i,e.m02=s*r-h*i,e.m03=c*r-f*i,e.m08=o*i+l*r,e.m09=a*i+u*r,e.m10=s*i+h*r,e.m11=c*i+f*r,e},t.rotateZ=function(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t.m00,a=t.m01,s=t.m02,c=t.m03,l=t.m04,u=t.m05,h=t.m06,f=t.m07;return t!==e&&(e.m08=t.m08,e.m09=t.m09,e.m10=t.m10,e.m11=t.m11,e.m12=t.m12,e.m13=t.m13,e.m14=t.m14,e.m15=t.m15),e.m00=o*r+l*i,e.m01=a*r+u*i,e.m02=s*r+h*i,e.m03=c*r+f*i,e.m04=l*r-o*i,e.m05=u*r-a*i,e.m06=h*r-s*i,e.m07=f*r-c*i,e},t.fromTranslation=function(e,t){return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=t.x,e.m13=t.y,e.m14=t.z,e.m15=1,e},t.fromScaling=function(e,t){return e.m00=t.x,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=t.y,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=t.z,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRotation=function(e,t,n){var i=n.x,r=n.y,o=n.z,a=Math.sqrt(i*i+r*r+o*o);if(Math.abs(a)<an)return null;i*=a=1/a,r*=a,o*=a;var s=Math.sin(t),c=Math.cos(t),l=1-c;return e.m00=i*i*l+c,e.m01=r*i*l+o*s,e.m02=o*i*l-r*s,e.m03=0,e.m04=i*r*l-o*s,e.m05=r*r*l+c,e.m06=o*r*l+i*s,e.m07=0,e.m08=i*o*l+r*s,e.m09=r*o*l-i*s,e.m10=o*o*l+c,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromXRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=1,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=i,e.m06=n,e.m07=0,e.m08=0,e.m09=-n,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromYRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=0,e.m02=-n,e.m03=0,e.m04=0,e.m05=1,e.m06=0,e.m07=0,e.m08=n,e.m09=0,e.m10=i,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromZRotation=function(e,t){var n=Math.sin(t),i=Math.cos(t);return e.m00=i,e.m01=n,e.m02=0,e.m03=0,e.m04=-n,e.m05=i,e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=1,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.fromRT=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,_=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l;return e.m00=1-(_+d),e.m01=h+g,e.m02=f-v,e.m03=0,e.m04=h-g,e.m05=1-(u+d),e.m06=p+m,e.m07=0,e.m08=f+v,e.m09=p-m,e.m10=1-(u+_),e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.getTranslation=function(e,t){return e.x=t.m12,e.y=t.m13,e.z=t.m14,e},t.getScaling=function(e,t){var n=Xn.m00=t.m00,i=Xn.m01=t.m01,r=Xn.m02=t.m02,o=Xn.m03=t.m04,a=Xn.m04=t.m05,s=Xn.m05=t.m06,c=Xn.m06=t.m08,l=Xn.m07=t.m09,u=Xn.m08=t.m10;return e.x=Math.sqrt(n*n+i*i+r*r),e.y=Math.sqrt(o*o+a*a+s*s),e.z=Math.sqrt(c*c+l*l+u*u),Nn.determinant(Xn)<0&&(e.x*=-1),e},t.getRotation=function(e,t){var n=t.m00+t.m05+t.m10,i=0;return n>0?(i=2*Math.sqrt(n+1),e.w=.25*i,e.x=(t.m06-t.m09)/i,e.y=(t.m08-t.m02)/i,e.z=(t.m01-t.m04)/i):t.m00>t.m05&&t.m00>t.m10?(i=2*Math.sqrt(1+t.m00-t.m05-t.m10),e.w=(t.m06-t.m09)/i,e.x=.25*i,e.y=(t.m01+t.m04)/i,e.z=(t.m08+t.m02)/i):t.m05>t.m10?(i=2*Math.sqrt(1+t.m05-t.m00-t.m10),e.w=(t.m08-t.m02)/i,e.x=(t.m01+t.m04)/i,e.y=.25*i,e.z=(t.m06+t.m09)/i):(i=2*Math.sqrt(1+t.m10-t.m00-t.m05),e.w=(t.m01-t.m04)/i,e.x=(t.m08+t.m02)/i,e.y=(t.m06+t.m09)/i,e.z=.25*i),e},t.toRTS=function(e,t,n,i){i.x=In.set(qn,e.m00,e.m01,e.m02).length(),Xn.m00=e.m00/i.x,Xn.m01=e.m01/i.x,Xn.m02=e.m02/i.x,i.y=In.set(qn,e.m04,e.m05,e.m06).length(),Xn.m03=e.m04/i.y,Xn.m04=e.m05/i.y,Xn.m05=e.m06/i.y,i.z=In.set(qn,e.m08,e.m09,e.m10).length(),Xn.m06=e.m08/i.z,Xn.m07=e.m09/i.z,Xn.m08=e.m10/i.z,Nn.determinant(Xn)<0&&(i.x*=-1,Xn.m00*=-1,Xn.m01*=-1,Xn.m02*=-1),Fn.fromMat3(t,Xn),In.set(n,e.m12,e.m13,e.m14)},t.fromRTS=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=t.w,c=r+r,l=o+o,u=a+a,h=r*c,f=r*l,_=r*u,p=o*l,d=o*u,m=a*u,v=s*c,g=s*l,y=s*u,x=i.x,S=i.y,T=i.z;return e.m00=(1-(p+m))*x,e.m01=(f+y)*x,e.m02=(_-g)*x,e.m03=0,e.m04=(f-y)*S,e.m05=(1-(h+m))*S,e.m06=(d+v)*S,e.m07=0,e.m08=(_+g)*T,e.m09=(d-v)*T,e.m10=(1-(h+p))*T,e.m11=0,e.m12=n.x,e.m13=n.y,e.m14=n.z,e.m15=1,e},t.fromRTSOrigin=function(e,t,n,i,r){var o=t.x,a=t.y,s=t.z,c=t.w,l=o+o,u=a+a,h=s+s,f=o*l,_=o*u,p=o*h,d=a*u,m=a*h,v=s*h,g=c*l,y=c*u,x=c*h,S=i.x,T=i.y,b=i.z,E=r.x,C=r.y,A=r.z;return e.m00=(1-(d+v))*S,e.m01=(_+x)*S,e.m02=(p-y)*S,e.m03=0,e.m04=(_-x)*T,e.m05=(1-(f+v))*T,e.m06=(m+g)*T,e.m07=0,e.m08=(p+y)*b,e.m09=(m-g)*b,e.m10=(1-(f+d))*b,e.m11=0,e.m12=n.x+E-(e.m00*E+e.m04*C+e.m08*A),e.m13=n.y+C-(e.m01*E+e.m05*C+e.m09*A),e.m14=n.z+A-(e.m02*E+e.m06*C+e.m10*A),e.m15=1,e},t.fromQuat=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n+n,s=i+i,c=r+r,l=n*a,u=i*a,h=i*s,f=r*a,_=r*s,p=r*c,d=o*a,m=o*s,v=o*c;return e.m00=1-h-p,e.m01=u+v,e.m02=f-m,e.m03=0,e.m04=u-v,e.m05=1-l-p,e.m06=_+d,e.m07=0,e.m08=f+m,e.m09=_-d,e.m10=1-l-h,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e},t.frustum=function(e,t,n,i,r,o,a){var s=1/(n-t),c=1/(r-i),l=1/(o-a);return e.m00=2*o*s,e.m01=0,e.m02=0,e.m03=0,e.m04=0,e.m05=2*o*c,e.m06=0,e.m07=0,e.m08=(n+t)*s,e.m09=(r+i)*c,e.m10=(a+o)*l,e.m11=-1,e.m12=0,e.m13=0,e.m14=a*o*2*l,e.m15=0,e},t.perspective=function(e,t,n,i,r,o,a,s,c){void 0===o&&(o=!0),void 0===a&&(a=-1),void 0===s&&(s=1),void 0===c&&(c=0);var l=1/Math.tan(t/2),u=1/(i-r),h=o?l/n:l,f=(o?l:l*n)*s,_=Wn[c];return e.m00=h*_[0],e.m01=h*_[1],e.m02=0,e.m03=0,e.m04=f*_[2],e.m05=f*_[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=(r-a*i)*u,e.m11=-1,e.m12=0,e.m13=0,e.m14=r*i*u*(1-a),e.m15=0,e},t.ortho=function(e,t,n,i,r,o,a,s,c,l){void 0===s&&(s=-1),void 0===c&&(c=1),void 0===l&&(l=0);var u=1/(t-n),h=1/(i-r)*c,f=1/(o-a),_=-2*u,p=-2*h,d=(t+n)*u,m=(r+i)*h,v=Wn[l];return e.m00=_*v[0],e.m01=_*v[1],e.m02=0,e.m03=0,e.m04=p*v[2],e.m05=p*v[3],e.m06=0,e.m07=0,e.m08=0,e.m09=0,e.m10=f*(1-s),e.m11=0,e.m12=d*v[0]+m*v[2],e.m13=d*v[1]+m*v[3],e.m14=(o-s*a)*f,e.m15=1,e},t.lookAt=function(e,t,n,i){var r=t.x,o=t.y,a=t.z,s=i.x,c=i.y,l=i.z,u=r-n.x,h=o-n.y,f=a-n.z,_=1/Math.sqrt(u*u+h*h+f*f),p=c*(f*=_)-l*(h*=_),d=l*(u*=_)-s*f,m=s*h-c*u,v=h*(m*=_=1/Math.sqrt(p*p+d*d+m*m))-f*(d*=_),g=f*(p*=_)-u*m,y=u*d-h*p;return e.m00=p,e.m01=v,e.m02=u,e.m03=0,e.m04=d,e.m05=g,e.m06=h,e.m07=0,e.m08=m,e.m09=y,e.m10=f,e.m11=0,e.m12=-(p*r+d*o+m*a),e.m13=-(v*r+g*o+y*a),e.m14=-(u*r+h*o+f*a),e.m15=1,e},t.inverseTranspose=function(e,t){var n=t.m00,i=t.m01,r=t.m02,o=t.m03,a=t.m04,s=t.m05,c=t.m06,l=t.m07,u=t.m08,h=t.m09,f=t.m10,_=t.m11,p=t.m12,d=t.m13,m=t.m14,v=t.m15,g=n*s-i*a,y=n*c-r*a,x=n*l-o*a,S=i*c-r*s,T=i*l-o*s,b=r*l-o*c,E=u*d-h*p,C=u*m-f*p,A=u*v-_*p,w=h*m-f*d,P=h*v-_*d,R=f*v-_*m,I=g*R-y*P+x*w+S*A-T*C+b*E;return I?(I=1/I,e.m00=(s*R-c*P+l*w)*I,e.m01=(c*A-a*R-l*C)*I,e.m02=(a*P-s*A+l*E)*I,e.m03=0,e.m04=(r*P-i*R-o*w)*I,e.m05=(n*R-r*A+o*C)*I,e.m06=(i*A-n*P-o*E)*I,e.m07=0,e.m08=(d*b-m*T+v*S)*I,e.m09=(m*x-p*b-v*y)*I,e.m10=(p*T-d*x+v*g)*I,e.m11=0,e.m12=0,e.m13=0,e.m14=0,e.m15=1,e):null},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.m00,e[n+1]=t.m01,e[n+2]=t.m02,e[n+3]=t.m03,e[n+4]=t.m04,e[n+5]=t.m05,e[n+6]=t.m06,e[n+7]=t.m07,e[n+8]=t.m08,e[n+9]=t.m09,e[n+10]=t.m10,e[n+11]=t.m11,e[n+12]=t.m12,e[n+13]=t.m13,e[n+14]=t.m14,e[n+15]=t.m15,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.m00=t[n+0],e.m01=t[n+1],e.m02=t[n+2],e.m03=t[n+3],e.m04=t[n+4],e.m05=t[n+5],e.m06=t[n+6],e.m07=t[n+7],e.m08=t[n+8],e.m09=t[n+9],e.m10=t[n+10],e.m11=t[n+11],e.m12=t[n+12],e.m13=t[n+13],e.m14=t[n+14],e.m15=t[n+15],e},t.add=function(e,t,n){return e.m00=t.m00+n.m00,e.m01=t.m01+n.m01,e.m02=t.m02+n.m02,e.m03=t.m03+n.m03,e.m04=t.m04+n.m04,e.m05=t.m05+n.m05,e.m06=t.m06+n.m06,e.m07=t.m07+n.m07,e.m08=t.m08+n.m08,e.m09=t.m09+n.m09,e.m10=t.m10+n.m10,e.m11=t.m11+n.m11,e.m12=t.m12+n.m12,e.m13=t.m13+n.m13,e.m14=t.m14+n.m14,e.m15=t.m15+n.m15,e},t.subtract=function(e,t,n){return e.m00=t.m00-n.m00,e.m01=t.m01-n.m01,e.m02=t.m02-n.m02,e.m03=t.m03-n.m03,e.m04=t.m04-n.m04,e.m05=t.m05-n.m05,e.m06=t.m06-n.m06,e.m07=t.m07-n.m07,e.m08=t.m08-n.m08,e.m09=t.m09-n.m09,e.m10=t.m10-n.m10,e.m11=t.m11-n.m11,e.m12=t.m12-n.m12,e.m13=t.m13-n.m13,e.m14=t.m14-n.m14,e.m15=t.m15-n.m15,e},t.multiplyScalar=function(e,t,n){return e.m00=t.m00*n,e.m01=t.m01*n,e.m02=t.m02*n,e.m03=t.m03*n,e.m04=t.m04*n,e.m05=t.m05*n,e.m06=t.m06*n,e.m07=t.m07*n,e.m08=t.m08*n,e.m09=t.m09*n,e.m10=t.m10*n,e.m11=t.m11*n,e.m12=t.m12*n,e.m13=t.m13*n,e.m14=t.m14*n,e.m15=t.m15*n,e},t.multiplyScalarAndAdd=function(e,t,n,i){return e.m00=t.m00+n.m00*i,e.m01=t.m01+n.m01*i,e.m02=t.m02+n.m02*i,e.m03=t.m03+n.m03*i,e.m04=t.m04+n.m04*i,e.m05=t.m05+n.m05*i,e.m06=t.m06+n.m06*i,e.m07=t.m07+n.m07*i,e.m08=t.m08+n.m08*i,e.m09=t.m09+n.m09*i,e.m10=t.m10+n.m10*i,e.m11=t.m11+n.m11*i,e.m12=t.m12+n.m12*i,e.m13=t.m13+n.m13*i,e.m14=t.m14+n.m14*i,e.m15=t.m15+n.m15*i,e},t.strictEquals=function(e,t){return e.m00===t.m00&&e.m01===t.m01&&e.m02===t.m02&&e.m03===t.m03&&e.m04===t.m04&&e.m05===t.m05&&e.m06===t.m06&&e.m07===t.m07&&e.m08===t.m08&&e.m09===t.m09&&e.m10===t.m10&&e.m11===t.m11&&e.m12===t.m12&&e.m13===t.m13&&e.m14===t.m14&&e.m15===t.m15},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.m00-t.m00)<=n*Math.max(1,Math.abs(e.m00),Math.abs(t.m00))&&Math.abs(e.m01-t.m01)<=n*Math.max(1,Math.abs(e.m01),Math.abs(t.m01))&&Math.abs(e.m02-t.m02)<=n*Math.max(1,Math.abs(e.m02),Math.abs(t.m02))&&Math.abs(e.m03-t.m03)<=n*Math.max(1,Math.abs(e.m03),Math.abs(t.m03))&&Math.abs(e.m04-t.m04)<=n*Math.max(1,Math.abs(e.m04),Math.abs(t.m04))&&Math.abs(e.m05-t.m05)<=n*Math.max(1,Math.abs(e.m05),Math.abs(t.m05))&&Math.abs(e.m06-t.m06)<=n*Math.max(1,Math.abs(e.m06),Math.abs(t.m06))&&Math.abs(e.m07-t.m07)<=n*Math.max(1,Math.abs(e.m07),Math.abs(t.m07))&&Math.abs(e.m08-t.m08)<=n*Math.max(1,Math.abs(e.m08),Math.abs(t.m08))&&Math.abs(e.m09-t.m09)<=n*Math.max(1,Math.abs(e.m09),Math.abs(t.m09))&&Math.abs(e.m10-t.m10)<=n*Math.max(1,Math.abs(e.m10),Math.abs(t.m10))&&Math.abs(e.m11-t.m11)<=n*Math.max(1,Math.abs(e.m11),Math.abs(t.m11))&&Math.abs(e.m12-t.m12)<=n*Math.max(1,Math.abs(e.m12),Math.abs(t.m12))&&Math.abs(e.m13-t.m13)<=n*Math.max(1,Math.abs(e.m13),Math.abs(t.m13))&&Math.abs(e.m14-t.m14)<=n*Math.max(1,Math.abs(e.m14),Math.abs(t.m14))&&Math.abs(e.m15-t.m15)<=n*Math.max(1,Math.abs(e.m15),Math.abs(t.m15))};var n=t.prototype;return n.clone=function(){return new t(this.m00,this.m01,this.m02,this.m03,this.m04,this.m05,this.m06,this.m07,this.m08,this.m09,this.m10,this.m11,this.m12,this.m13,this.m14,this.m15)},n.set=function(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=0),void 0===d&&(d=1),"object"==typeof e?(this.m01=e.m01,this.m02=e.m02,this.m03=e.m03,this.m04=e.m04,this.m05=e.m05,this.m06=e.m06,this.m07=e.m07,this.m08=e.m08,this.m09=e.m09,this.m10=e.m10,this.m11=e.m11,this.m12=e.m12,this.m13=e.m13,this.m14=e.m14,this.m15=e.m15,this.m00=e.m00):(this.m01=t,this.m02=n,this.m03=i,this.m04=r,this.m05=o,this.m06=a,this.m07=s,this.m08=c,this.m09=l,this.m10=u,this.m11=h,this.m12=f,this.m13=_,this.m14=p,this.m15=d,this.m00=e),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.m00-e.m00)<=t*Math.max(1,Math.abs(this.m00),Math.abs(e.m00))&&Math.abs(this.m01-e.m01)<=t*Math.max(1,Math.abs(this.m01),Math.abs(e.m01))&&Math.abs(this.m02-e.m02)<=t*Math.max(1,Math.abs(this.m02),Math.abs(e.m02))&&Math.abs(this.m03-e.m03)<=t*Math.max(1,Math.abs(this.m03),Math.abs(e.m03))&&Math.abs(this.m04-e.m04)<=t*Math.max(1,Math.abs(this.m04),Math.abs(e.m04))&&Math.abs(this.m05-e.m05)<=t*Math.max(1,Math.abs(this.m05),Math.abs(e.m05))&&Math.abs(this.m06-e.m06)<=t*Math.max(1,Math.abs(this.m06),Math.abs(e.m06))&&Math.abs(this.m07-e.m07)<=t*Math.max(1,Math.abs(this.m07),Math.abs(e.m07))&&Math.abs(this.m08-e.m08)<=t*Math.max(1,Math.abs(this.m08),Math.abs(e.m08))&&Math.abs(this.m09-e.m09)<=t*Math.max(1,Math.abs(this.m09),Math.abs(e.m09))&&Math.abs(this.m10-e.m10)<=t*Math.max(1,Math.abs(this.m10),Math.abs(e.m10))&&Math.abs(this.m11-e.m11)<=t*Math.max(1,Math.abs(this.m11),Math.abs(e.m11))&&Math.abs(this.m12-e.m12)<=t*Math.max(1,Math.abs(this.m12),Math.abs(e.m12))&&Math.abs(this.m13-e.m13)<=t*Math.max(1,Math.abs(this.m13),Math.abs(e.m13))&&Math.abs(this.m14-e.m14)<=t*Math.max(1,Math.abs(this.m14),Math.abs(e.m14))&&Math.abs(this.m15-e.m15)<=t*Math.max(1,Math.abs(this.m15),Math.abs(e.m15))},n.strictEquals=function(e){return this.m00===e.m00&&this.m01===e.m01&&this.m02===e.m02&&this.m03===e.m03&&this.m04===e.m04&&this.m05===e.m05&&this.m06===e.m06&&this.m07===e.m07&&this.m08===e.m08&&this.m09===e.m09&&this.m10===e.m10&&this.m11===e.m11&&this.m12===e.m12&&this.m13===e.m13&&this.m14===e.m14&&this.m15===e.m15},n.toString=function(){return"[\n"+this.m00+", "+this.m01+", "+this.m02+", "+this.m03+",\n"+this.m04+", "+this.m05+", "+this.m06+", "+this.m07+",\n"+this.m08+", "+this.m09+", "+this.m10+", "+this.m11+",\n"+this.m12+", "+this.m13+", "+this.m14+", "+this.m15+"\n]"},n.identity=function(){return this.m00=1,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=1,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=1,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},n.zero=function(){return this.m00=0,this.m01=0,this.m02=0,this.m03=0,this.m04=0,this.m05=0,this.m06=0,this.m07=0,this.m08=0,this.m09=0,this.m10=0,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=0,this},n.transpose=function(){var e=this.m01,t=this.m02,n=this.m03,i=this.m06,r=this.m07,o=this.m11;return this.m01=this.m04,this.m02=this.m08,this.m03=this.m12,this.m04=e,this.m06=this.m09,this.m07=this.m13,this.m08=t,this.m09=i,this.m11=this.m14,this.m12=n,this.m13=r,this.m14=o,this},n.invert=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,_=this.m13,p=this.m14,d=this.m15,m=e*o-t*r,v=e*a-n*r,g=e*s-i*r,y=t*a-n*o,x=t*s-i*o,S=n*s-i*a,T=c*_-l*f,b=c*p-u*f,E=c*d-h*f,C=l*p-u*_,A=l*d-h*_,w=u*d-h*p,P=m*w-v*A+g*C+y*E-x*b+S*T;return 0===P?(this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),this):(P=1/P,this.m00=(o*w-a*A+s*C)*P,this.m01=(n*A-t*w-i*C)*P,this.m02=(_*S-p*x+d*y)*P,this.m03=(u*x-l*S-h*y)*P,this.m04=(a*E-r*w-s*b)*P,this.m05=(e*w-n*E+i*b)*P,this.m06=(p*g-f*S-d*v)*P,this.m07=(c*S-u*g+h*v)*P,this.m08=(r*A-o*E+s*T)*P,this.m09=(t*E-e*A-i*T)*P,this.m10=(f*x-_*g+d*m)*P,this.m11=(l*g-c*x-h*m)*P,this.m12=(o*b-r*C-a*T)*P,this.m13=(e*C-t*b+n*T)*P,this.m14=(_*v-f*y-p*m)*P,this.m15=(c*y-l*v+u*m)*P,this)},n.determinant=function(){var e=this.m00,t=this.m01,n=this.m02,i=this.m03,r=this.m04,o=this.m05,a=this.m06,s=this.m07,c=this.m08,l=this.m09,u=this.m10,h=this.m11,f=this.m12,_=this.m13,p=this.m14,d=this.m15;return(e*o-t*r)*(u*d-h*p)-(e*a-n*r)*(l*d-h*_)+(e*s-i*r)*(l*p-u*_)+(t*a-n*o)*(c*d-h*f)-(t*s-i*o)*(c*p-u*f)+(n*s-i*a)*(c*_-l*f)},n.add=function(e){return this.m00+=e.m00,this.m01+=e.m01,this.m02+=e.m02,this.m03+=e.m03,this.m04+=e.m04,this.m05+=e.m05,this.m06+=e.m06,this.m07+=e.m07,this.m08+=e.m08,this.m09+=e.m09,this.m10+=e.m10,this.m11+=e.m11,this.m12+=e.m12,this.m13+=e.m13,this.m14+=e.m14,this.m15+=e.m15,this},n.subtract=function(e){return this.m00-=e.m00,this.m01-=e.m01,this.m02-=e.m02,this.m03-=e.m03,this.m04-=e.m04,this.m05-=e.m05,this.m06-=e.m06,this.m07-=e.m07,this.m08-=e.m08,this.m09-=e.m09,this.m10-=e.m10,this.m11-=e.m11,this.m12-=e.m12,this.m13-=e.m13,this.m14-=e.m14,this.m15-=e.m15,this},n.multiply=function(e){var t=this.m00,n=this.m01,i=this.m02,r=this.m03,o=this.m04,a=this.m05,s=this.m06,c=this.m07,l=this.m08,u=this.m09,h=this.m10,f=this.m11,_=this.m12,p=this.m13,d=this.m14,m=this.m15,v=e.m00,g=e.m01,y=e.m02,x=e.m03;return this.m00=v*t+g*o+y*l+x*_,this.m01=v*n+g*a+y*u+x*p,this.m02=v*i+g*s+y*h+x*d,this.m03=v*r+g*c+y*f+x*m,v=e.m04,g=e.m05,y=e.m06,x=e.m07,this.m04=v*t+g*o+y*l+x*_,this.m05=v*n+g*a+y*u+x*p,this.m06=v*i+g*s+y*h+x*d,this.m07=v*r+g*c+y*f+x*m,v=e.m08,g=e.m09,y=e.m10,x=e.m11,this.m08=v*t+g*o+y*l+x*_,this.m09=v*n+g*a+y*u+x*p,this.m10=v*i+g*s+y*h+x*d,this.m11=v*r+g*c+y*f+x*m,v=e.m12,g=e.m13,y=e.m14,x=e.m15,this.m12=v*t+g*o+y*l+x*_,this.m13=v*n+g*a+y*u+x*p,this.m14=v*i+g*s+y*h+x*d,this.m15=v*r+g*c+y*f+x*m,this},n.multiplyScalar=function(e){return this.m00*=e,this.m01*=e,this.m02*=e,this.m03*=e,this.m04*=e,this.m05*=e,this.m06*=e,this.m07*=e,this.m08*=e,this.m09*=e,this.m10*=e,this.m11*=e,this.m12*=e,this.m13*=e,this.m14*=e,this.m15*=e,this},n.translate=function(e){return console.warn("function changed"),this.m12+=e.x,this.m13+=e.y,this.m14+=e.z,this},n.scale=function(e){var t=e.x,n=e.y,i=e.z;return this.m00*=t,this.m01*=t,this.m02*=t,this.m03*=t,this.m04*=n,this.m05*=n,this.m06*=n,this.m07*=n,this.m08*=i,this.m09*=i,this.m10*=i,this.m11*=i,this},n.rotate=function(e,t){var n=t.x,i=t.y,r=t.z,o=Math.sqrt(n*n+i*i+r*r);if(Math.abs(o)<an)return null;n*=o=1/o,i*=o,r*=o;var a=Math.sin(e),s=Math.cos(e),c=1-s,l=this.m00,u=this.m01,h=this.m02,f=this.m03,_=this.m04,p=this.m05,d=this.m06,m=this.m07,v=this.m08,g=this.m09,y=this.m10,x=this.m11,S=n*n*c+s,T=i*n*c+r*a,b=r*n*c-i*a,E=n*i*c-r*a,C=i*i*c+s,A=r*i*c+n*a,w=n*r*c+i*a,P=i*r*c-n*a,R=r*r*c+s;return this.m00=l*S+_*T+v*b,this.m01=u*S+p*T+g*b,this.m02=h*S+d*T+y*b,this.m03=f*S+m*T+x*b,this.m04=l*E+_*C+v*A,this.m05=u*E+p*C+g*A,this.m06=h*E+d*C+y*A,this.m07=f*E+m*C+x*A,this.m08=l*w+_*P+v*R,this.m09=u*w+p*P+g*R,this.m10=h*w+d*P+y*R,this.m11=f*w+m*P+x*R,this},n.getTranslation=function(e){return e.x=this.m12,e.y=this.m13,e.z=this.m14,e},n.getScale=function(e){var t=Xn.m00=this.m00,n=Xn.m01=this.m01,i=Xn.m02=this.m02,r=Xn.m03=this.m04,o=Xn.m04=this.m05,a=Xn.m05=this.m06,s=Xn.m06=this.m08,c=Xn.m07=this.m09,l=Xn.m08=this.m10;return e.x=Math.sqrt(t*t+n*n+i*i),e.y=Math.sqrt(r*r+o*o+a*a),e.z=Math.sqrt(s*s+c*c+l*l),Nn.determinant(Xn)<0&&(e.x*=-1),e},n.getRotation=function(e){var t=this.m00+this.m05+this.m10,n=0;return t>0?(n=2*Math.sqrt(t+1),e.w=.25*n,e.x=(this.m06-this.m09)/n,e.y=(this.m08-this.m02)/n,e.z=(this.m01-this.m04)/n):this.m00>this.m05&&this.m00>this.m10?(n=2*Math.sqrt(1+this.m00-this.m05-this.m10),e.w=(this.m06-this.m09)/n,e.x=.25*n,e.y=(this.m01+this.m04)/n,e.z=(this.m08+this.m02)/n):this.m05>this.m10?(n=2*Math.sqrt(1+this.m05-this.m00-this.m10),e.w=(this.m08-this.m02)/n,e.x=(this.m01+this.m04)/n,e.y=.25*n,e.z=(this.m06+this.m09)/n):(n=2*Math.sqrt(1+this.m10-this.m00-this.m05),e.w=(this.m01-this.m04)/n,e.x=(this.m08+this.m02)/n,e.y=(this.m06+this.m09)/n,e.z=.25*n),e},n.fromRTS=function(e,t,n){var i=e.x,r=e.y,o=e.z,a=e.w,s=i+i,c=r+r,l=o+o,u=i*s,h=i*c,f=i*l,_=r*c,p=r*l,d=o*l,m=a*s,v=a*c,g=a*l,y=n.x,x=n.y,S=n.z;return this.m00=(1-(_+d))*y,this.m01=(h+g)*y,this.m02=(f-v)*y,this.m03=0,this.m04=(h-g)*x,this.m05=(1-(u+d))*x,this.m06=(p+m)*x,this.m07=0,this.m08=(f+v)*S,this.m09=(p-m)*S,this.m10=(1-(u+_))*S,this.m11=0,this.m12=t.x,this.m13=t.y,this.m14=t.z,this.m15=1,this},n.fromQuat=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=n*o,u=n*a,h=i*o,f=i*a,_=i*s,p=r*o,d=r*a,m=r*s;return this.m00=1-u-_,this.m01=l+m,this.m02=h-d,this.m03=0,this.m04=l-m,this.m05=1-c-_,this.m06=f+p,this.m07=0,this.m08=h+d,this.m09=f-p,this.m10=1-c-u,this.m11=0,this.m12=0,this.m13=0,this.m14=0,this.m15=1,this},t}(ht));jn.IDENTITY=Object.freeze(new jn);var qn=new In,Xn=new Nn;function Yn(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return new jn(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d)}en.fastDefine("cc.Mat4",jn,{m00:1,m01:0,m02:0,m03:0,m04:0,m05:1,m06:0,m07:0,m08:0,m09:0,m10:1,m11:0,m12:0,m13:0,m14:0,m15:1}),u.Mat4=jn,u.mat4=Yn;var Kn=e("Vec2",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.x=t.x,i.y=t.y):(i.x=t||0,i.y=n||0),i}$(t,e),t.clone=function(e){return new t(e.x,e.y)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e},t.set=function(e,t,n){return e.x=t,e.y=n,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return Math.sqrt(n*n+i*i)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y;return n*n+i*i},t.len=function(e){var t=e.x,n=e.y;return Math.sqrt(t*t+n*n)},t.lengthSqr=function(e){var t=e.x,n=e.y;return t*t+n*n},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y;return Math.abs(n)<an?e.x=0:e.x=1/n,Math.abs(i)<an?e.y=0:e.y=1/i,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=n*n+i*i;return r>0&&(r=1/Math.sqrt(r),e.x=n*r,e.y=i*r),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y},t.cross=function(e,t,n){return e instanceof In?(e.x=e.y=0,e.z=t.x*n.y-t.y*n.x,e):e.x*t.y-e.y*t.x},t.lerp=function(e,t,n,i){var r=t.x,o=t.y;return e.x=r+i*(n.x-r),e.y=o+i*(n.y-o),e},t.random=function(e,t){t=t||1;var n=2*pn()*Math.PI;return e.x=Math.cos(n)*t,e.y=Math.sin(n)*t,e},t.transformMat3=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m03*r+n.m06,e.y=n.m01*i+n.m04*r+n.m07,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y;return e.x=n.m00*i+n.m04*r+n.m12,e.y=n.m01*i+n.m05*r+n.m13,e},t.str=function(e){return"Vec2("+e.x+", "+e.y+")"},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))},t.angle=function(e,n){t.normalize(Qn,e),t.normalize(Zn,n);var i=t.dot(Qn,Zn);return i>1?0:i<-1?Math.PI:Math.acos(i)};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y)},n.set=function(e,t){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y):(this.x=e||0,this.y=t||0),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))},n.equals2f=function(e,t,n){return void 0===n&&(n=an),Math.abs(this.x-e)<=n*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=n*Math.max(1,Math.abs(this.y),Math.abs(t))},n.strictEquals=function(e){return e&&this.x===e.x&&this.y===e.y},n.strictEquals2f=function(e,t){return this.x===e&&this.y===t},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+")"},n.lerp=function(e,t){var n=this.x,i=this.y;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this},n.clampf=function(e,t){return this.x=ln(this.x,e.x,t.x),this.y=ln(this.y,e.y,t.y),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this},n.add2f=function(e,t){return this.x+=e,this.y+=t,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this},n.subtract2f=function(e,t){return this.x-=e,this.y-=t,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec2.multiply for vector * vector operation"),this.x*=e,this.y*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec2.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this},n.multiply2f=function(e,t){return this.x*=e,this.y*=t,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this},n.divide2f=function(e,t){return this.x/=e,this.y/=t,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this},n.dot=function(e){return this.x*e.x+this.y*e.y},n.cross=function(e){return this.x*e.y-this.y*e.x},n.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)},n.lengthSqr=function(){return this.x*this.x+this.y*this.y},n.normalize=function(){var e=this.x,t=this.y,n=e*e+t*t;return n>0&&(n=1/Math.sqrt(n),this.x*=n,this.y*=n),this},n.angle=function(e){var t=this.lengthSqr(),n=e.lengthSqr();if(0===t||0===n)return console.warn("Can't get angle between zero vector"),0;var i=this.dot(e)/Math.sqrt(t*n);return i=ln(i,-1,1),Math.acos(i)},n.signAngle=function(e){var t=this.angle(e);return this.cross(e)<0?-t:t},n.rotate=function(e){var t=this.x,n=this.y,i=Math.sin(e),r=Math.cos(e);return this.x=r*t-i*n,this.y=i*t+r*n,this},n.project=function(e){var t=this.dot(e)/e.dot(e);return this.x=e.x*t,this.y=e.y*t,this},n.transformMat4=function(e){var t=this.x,n=this.y;return this.x=e.m00*t+e.m04*n+e.m12,this.y=e.m01*t+e.m05*n+e.m13,this},t}(ht));Kn.ZERO=Object.freeze(new Kn(0,0)),Kn.ONE=Object.freeze(new Kn(1,1)),Kn.NEG_ONE=Object.freeze(new Kn(-1,-1)),Kn.UNIT_X=Object.freeze(new Kn(1,0)),Kn.UNIT_Y=Object.freeze(new Kn(0,1));var Qn=new Kn,Zn=new Kn;function Jn(e,t){return new Kn(e,t)}en.fastDefine("cc.Vec2",Kn,{x:0,y:0}),u.Vec2=Kn,u.v2=Jn;var $n=e("Vec4",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.x=t.x,o.y=t.y,o.z=t.z,o.w=t.w):(o.x=t||0,o.y=n||0,o.z=i||0,o.w=r||0),o}$(t,e),t.clone=function(e){return new t(e.x,e.y,e.z,e.w)},t.copy=function(e,t){return e.x=t.x,e.y=t.y,e.z=t.z,e.w=t.w,e},t.set=function(e,t,n,i,r){return e.x=t,e.y=n,e.z=i,e.w=r,e},t.add=function(e,t,n){return e.x=t.x+n.x,e.y=t.y+n.y,e.z=t.z+n.z,e.w=t.w+n.w,e},t.subtract=function(e,t,n){return e.x=t.x-n.x,e.y=t.y-n.y,e.z=t.z-n.z,e.w=t.w-n.w,e},t.multiply=function(e,t,n){return e.x=t.x*n.x,e.y=t.y*n.y,e.z=t.z*n.z,e.w=t.w*n.w,e},t.divide=function(e,t,n){return e.x=t.x/n.x,e.y=t.y/n.y,e.z=t.z/n.z,e.w=t.w/n.w,e},t.ceil=function(e,t){return e.x=Math.ceil(t.x),e.y=Math.ceil(t.y),e.z=Math.ceil(t.z),e.w=Math.ceil(t.w),e},t.floor=function(e,t){return e.x=Math.floor(t.x),e.y=Math.floor(t.y),e.z=Math.floor(t.z),e.w=Math.floor(t.w),e},t.min=function(e,t,n){return e.x=Math.min(t.x,n.x),e.y=Math.min(t.y,n.y),e.z=Math.min(t.z,n.z),e.w=Math.min(t.w,n.w),e},t.max=function(e,t,n){return e.x=Math.max(t.x,n.x),e.y=Math.max(t.y,n.y),e.z=Math.max(t.z,n.z),e.w=Math.max(t.w,n.w),e},t.round=function(e,t){return e.x=Math.round(t.x),e.y=Math.round(t.y),e.z=Math.round(t.z),e.w=Math.round(t.w),e},t.multiplyScalar=function(e,t,n){return e.x=t.x*n,e.y=t.y*n,e.z=t.z*n,e.w=t.w*n,e},t.scaleAndAdd=function(e,t,n,i){return e.x=t.x+n.x*i,e.y=t.y+n.y*i,e.z=t.z+n.z*i,e.w=t.w+n.w*i,e},t.distance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return Math.sqrt(n*n+i*i+r*r+o*o)},t.squaredDistance=function(e,t){var n=t.x-e.x,i=t.y-e.y,r=t.z-e.z,o=t.w-e.w;return n*n+i*i+r*r+o*o},t.len=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return Math.sqrt(t*t+n*n+i*i+r*r)},t.lengthSqr=function(e){var t=e.x,n=e.y,i=e.z,r=e.w;return t*t+n*n+i*i+r*r},t.negate=function(e,t){return e.x=-t.x,e.y=-t.y,e.z=-t.z,e.w=-t.w,e},t.inverse=function(e,t){return e.x=1/t.x,e.y=1/t.y,e.z=1/t.z,e.w=1/t.w,e},t.inverseSafe=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w;return Math.abs(n)<an?e.x=0:e.x=1/n,Math.abs(i)<an?e.y=0:e.y=1/i,Math.abs(r)<an?e.z=0:e.z=1/r,Math.abs(o)<an?e.w=0:e.w=1/o,e},t.normalize=function(e,t){var n=t.x,i=t.y,r=t.z,o=t.w,a=n*n+i*i+r*r+o*o;return a>0&&(a=1/Math.sqrt(a),e.x=n*a,e.y=i*a,e.z=r*a,e.w=o*a),e},t.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z+e.w*t.w},t.lerp=function(e,t,n,i){return e.x=t.x+i*(n.x-t.x),e.y=t.y+i*(n.y-t.y),e.z=t.z+i*(n.z-t.z),e.w=t.w+i*(n.w-t.w),e},t.random=function(e,t){t=t||1;var n=2*pn()*Math.PI,i=2*pn()-1,r=Math.sqrt(1-i*i);return e.x=r*Math.cos(n)*t,e.y=r*Math.sin(n)*t,e.z=i*t,e.w=0,e},t.transformMat4=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m04*r+n.m08*o+n.m12*a,e.y=n.m01*i+n.m05*r+n.m09*o+n.m13*a,e.z=n.m02*i+n.m06*r+n.m10*o+n.m14*a,e.w=n.m03*i+n.m07*r+n.m11*o+n.m15*a,e},t.transformAffine=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=t.w;return e.x=n.m00*i+n.m01*r+n.m02*o+n.m03*a,e.y=n.m04*i+n.m05*r+n.m06*o+n.m07*a,e.x=n.m08*i+n.m09*r+n.m10*o+n.m11*a,e.w=t.w,e},t.transformQuat=function(e,t,n){var i=t.x,r=t.y,o=t.z,a=n.x,s=n.y,c=n.z,l=n.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,_=-a*i-s*r-c*o;return e.x=u*l+_*-a+h*-c-f*-s,e.y=h*l+_*-s+f*-a-u*-c,e.z=f*l+_*-c+u*-s-h*-a,e.w=t.w,e},t.toArray=function(e,t,n){return void 0===n&&(n=0),e[n+0]=t.x,e[n+1]=t.y,e[n+2]=t.z,e[n+3]=t.w,e},t.fromArray=function(e,t,n){return void 0===n&&(n=0),e.x=t[n+0],e.y=t[n+1],e.z=t[n+2],e.w=t[n+3],e},t.strictEquals=function(e,t){return e.x===t.x&&e.y===t.y&&e.z===t.z&&e.w===t.w},t.equals=function(e,t,n){return void 0===n&&(n=an),Math.abs(e.x-t.x)<=n*Math.max(1,Math.abs(e.x),Math.abs(t.x))&&Math.abs(e.y-t.y)<=n*Math.max(1,Math.abs(e.y),Math.abs(t.y))&&Math.abs(e.z-t.z)<=n*Math.max(1,Math.abs(e.z),Math.abs(t.z))&&Math.abs(e.w-t.w)<=n*Math.max(1,Math.abs(e.w),Math.abs(t.w))};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.z,this.w)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w):(this.x=e||0,this.y=t||0,this.z=n||0,this.w=i||0),this},n.equals=function(e,t){return void 0===t&&(t=an),Math.abs(this.x-e.x)<=t*Math.max(1,Math.abs(this.x),Math.abs(e.x))&&Math.abs(this.y-e.y)<=t*Math.max(1,Math.abs(this.y),Math.abs(e.y))&&Math.abs(this.z-e.z)<=t*Math.max(1,Math.abs(this.z),Math.abs(e.z))&&Math.abs(this.w-e.w)<=t*Math.max(1,Math.abs(this.w),Math.abs(e.w))},n.equals4f=function(e,t,n,i,r){return void 0===r&&(r=an),Math.abs(this.x-e)<=r*Math.max(1,Math.abs(this.x),Math.abs(e))&&Math.abs(this.y-t)<=r*Math.max(1,Math.abs(this.y),Math.abs(t))&&Math.abs(this.z-n)<=r*Math.max(1,Math.abs(this.z),Math.abs(n))&&Math.abs(this.w-i)<=r*Math.max(1,Math.abs(this.w),Math.abs(i))},n.strictEquals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w},n.strictEquals4f=function(e,t,n,i){return this.x===e&&this.y===t&&this.z===n&&this.w===i},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.z,o=this.w;return this.x=n+t*(e.x-n),this.y=i+t*(e.y-i),this.z=r+t*(e.z-r),this.w=o+t*(e.w-o),this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.z.toFixed(2)+", "+this.w.toFixed(2)+")"},n.clampf=function(e,t){return this.x=ln(this.x,e.x,t.x),this.y=ln(this.y,e.y,t.y),this.z=ln(this.z,e.z,t.z),this.w=ln(this.w,e.w,t.w),this},n.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this},n.add4f=function(e,t,n,i){return this.x+=e,this.y+=t,this.z+=n,this.w+=i,this},n.subtract=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this},n.subtract4f=function(e,t,n,i){return this.x-=e,this.y-=t,this.z-=n,this.w-=i,this},n.multiplyScalar=function(e){return"object"==typeof e&&console.warn("should use Vec4.multiply for vector * vector operation"),this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},n.multiply=function(e){return"object"!=typeof e&&console.warn("should use Vec4.scale for vector * scalar operation"),this.x*=e.x,this.y*=e.y,this.z*=e.z,this.w*=e.w,this},n.multiply4f=function(e,t,n,i){return this.x*=e,this.y*=t,this.z*=n,this.w*=i,this},n.divide=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this.w/=e.w,this},n.divide4f=function(e,t,n,i){return this.x/=e,this.y/=t,this.z/=n,this.w/=i,this},n.negative=function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},n.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},n.cross=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return this.x=n*a-i*o,this.y=i*r-t*a,this.z=t*o-n*r,this},n.length=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return Math.sqrt(e*e+t*t+n*n+i*i)},n.lengthSqr=function(){var e=this.x,t=this.y,n=this.z,i=this.w;return e*e+t*t+n*n+i*i},n.normalize=function(){var e=this.x,t=this.y,n=this.z,i=this.w,r=e*e+t*t+n*n+i*i;return r>0&&(r=1/Math.sqrt(r),this.x=e*r,this.y=t*r,this.z=n*r,this.w=i*r),this},n.transformMat4=function(e){var t=this.x,n=this.y,i=this.z,r=this.w;return this.x=e.m00*t+e.m04*n+e.m08*i+e.m12*r,this.y=e.m01*t+e.m05*n+e.m09*i+e.m13*r,this.z=e.m02*t+e.m06*n+e.m10*i+e.m14*r,this.w=e.m03*t+e.m07*n+e.m11*i+e.m15*r,this},t}(ht));function ei(e,t,n,i){return new $n(e,t,n,i)}$n.ZERO=Object.freeze(new $n(0,0,0,0)),$n.ONE=Object.freeze(new $n(1,1,1,1)),$n.NEG_ONE=Object.freeze(new $n(-1,-1,-1,-1)),en.fastDefine("cc.Vec4",$n,{x:0,y:0,z:0,w:0}),u.Vec4=$n,u.v4=ei,k(Kn,"Vec2",[{name:"sub",newName:"subtract",target:Kn,targetName:"Vec2"},{name:"mul",newName:"multiply",target:Kn,targetName:"Vec2"},{name:"div",newName:"divide",target:Kn,targetName:"Vec2"},{name:"dist",newName:"distance",target:Kn,targetName:"Vec2"},{name:"sqrDist",newName:"squaredDistance",target:Kn,targetName:"Vec2"},{name:"mag",newName:"len",target:Kn,targetName:"Vec2"},{name:"sqrMag",newName:"lengthSqr",target:Kn,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Kn,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Kn,targetName:"Vec2"}]),k(Kn.prototype,"Vec2",[{name:"mag",newName:"length",target:Kn.prototype,targetName:"Vec2"},{name:"magSqr",newName:"lengthSqr",target:Kn.prototype,targetName:"Vec2"},{name:"scale",newName:"multiplyScalar",target:Kn.prototype,targetName:"Vec2"},{name:"exactEquals",newName:"strictEquals",target:Kn.prototype,targetName:"Vec2"}]),k(In,"Vec3",[{name:"sub",newName:"subtract",target:In,targetName:"Vec3"},{name:"mul",newName:"multiply",target:In,targetName:"Vec3"},{name:"div",newName:"divide",target:In,targetName:"Vec3"},{name:"dist",newName:"distance",target:In,targetName:"Vec3"},{name:"sqrDist",newName:"squaredDistance",target:In,targetName:"Vec3"},{name:"mag",newName:"len",target:In,targetName:"Vec3"},{name:"sqrMag",newName:"lengthSqr",target:In,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:In,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:In,targetName:"Vec3"}]),k(In.prototype,"Vec3",[{name:"mag",newName:"length",target:In.prototype,targetName:"Vec3"},{name:"magSqr",newName:"lengthSqr",target:In.prototype,targetName:"Vec3"},{name:"scale",newName:"multiplyScalar",target:In.prototype,targetName:"Vec3"},{name:"exactEquals",newName:"strictEquals",target:In.prototype,targetName:"Vec3"}]),k($n,"Vec4",[{name:"sub",newName:"subtract",target:$n,targetName:"Vec4"},{name:"mul",newName:"multiply",target:$n,targetName:"Vec4"},{name:"div",newName:"divide",target:$n,targetName:"Vec4"},{name:"dist",newName:"distance",target:$n,targetName:"Vec4"},{name:"sqrDist",newName:"squaredDistance",target:$n,targetName:"Vec4"},{name:"mag",newName:"len",target:$n,targetName:"Vec4"},{name:"sqrMag",newName:"lengthSqr",target:$n,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:$n,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:$n,targetName:"Vec4"}]),k($n.prototype,"Vec4",[{name:"mag",newName:"length",target:$n.prototype,targetName:"Vec4"},{name:"magSqr",newName:"lengthSqr",target:$n.prototype,targetName:"Vec4"},{name:"scale",newName:"multiplyScalar",target:$n.prototype,targetName:"Vec4"},{name:"exactEquals",newName:"strictEquals",target:$n.prototype,targetName:"Vec4"}]),k(Fn,"Quat",[{name:"mag",newName:"len",target:Fn,targetName:"Quat"},{name:"mul",newName:"multiply",target:Fn,targetName:"Quat"},{name:"sqrMag",newName:"lengthSqr",target:Fn,targetName:"Quat"},{name:"scale",newName:"multiplyScalar",target:Fn,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Fn,targetName:"Quat"}]),k(Fn.prototype,"Quat",[{name:"scale",newName:"multiplyScalar",target:Fn.prototype,targetName:"Quat"},{name:"exactEquals",newName:"strictEquals",target:Fn.prototype,targetName:"Quat"}]),k(Pn,"Color",[{name:"sub",newName:"subtract",target:Pn,targetName:"Color"},{name:"mul",newName:"multiply",target:Pn,targetName:"Color"},{name:"div",newName:"divide",target:Pn,targetName:"Color"},{name:"exactEquals",newName:"strictEquals",target:Pn,targetName:"Color"},{name:"fromHex",newName:"fromHEX",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[1].toString(16);return u.Color.fromHEX(t[0],i)}}]),k(Nn,"Mat3",[{name:"sub",newName:"subtract",target:Nn,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Nn,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Nn,targetName:"Mat3"},{name:"transfrom",newName:"transform",target:Nn,targetName:"Mat3"}]),k(Nn.prototype,"Mat3",[{name:"sub",newName:"subtract",target:Nn.prototype,targetName:"Mat3"},{name:"mul",newName:"multiply",target:Nn.prototype,targetName:"Mat3"},{name:"mulScalar",newName:"multiplyScalar",target:Nn.prototype,targetName:"Mat3"},{name:"exactEquals",newName:"strictEquals",target:Nn.prototype,targetName:"Mat3"}]),k(jn,"Mat4",[{name:"sub",newName:"subtract",target:jn,targetName:"Mat4"},{name:"mul",newName:"multiply",target:jn,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:jn,targetName:"Mat4"}]),k(jn.prototype,"Mat4",[{name:"sub",newName:"subtract",target:jn.prototype,targetName:"Mat4"},{name:"mul",newName:"multiply",target:jn.prototype,targetName:"Mat4"},{name:"mulScalar",newName:"multiplyScalar",target:jn.prototype,targetName:"Mat4"},{name:"exactEquals",newName:"strictEquals",target:jn.prototype,targetName:"Mat4"}]);var ti=e("AffineTransform",function(){function e(e,t,n,i,r,o){void 0===e&&(e=1),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),this.a=e,this.b=t,this.c=n,this.d=i,this.tx=r,this.ty=o}return e.identity=function(){return new e},e.clone=function(t){return new e(t.a,t.b,t.c,t.d,t.tx,t.ty)},e.concat=function(e,t,n){var i=t.a,r=t.b,o=t.c,a=t.d,s=t.tx,c=t.ty;e.a=i*n.a+r*n.c,e.b=i*n.b+r*n.d,e.c=o*n.a+a*n.c,e.d=o*n.b+a*n.d,e.tx=s*n.a+c*n.c+n.tx,e.ty=s*n.b+c*n.d+n.ty},e.invert=function(e,t){var n=1/(t.a*t.d-t.b*t.c);e.a=n*t.d,e.b=-n*t.b,e.c=-n*t.c,e.d=n*t.a,e.tx=n*(t.c*t.ty-t.d*t.tx),e.ty=n*(t.b*t.tx-t.a*t.ty)},e.fromMat4=function(e,t){e.a=t.m00,e.b=t.m01,e.c=t.m04,e.d=t.m05,e.tx=t.m12,e.ty=t.m13},e.transformVec2=function(e,t,n,i){var r,o;void 0===i?(i=n,r=t.x,o=t.y):(r=t,o=n),e.x=i.a*r+i.c*o+i.tx,e.y=i.b*r+i.d*o+i.ty},e.transformSize=function(e,t,n){e.width=n.a*t.width+n.c*t.height,e.height=n.b*t.width+n.d*t.height},e.transformRect=function(e,t,n){var i=t.x+t.width,r=t.y+t.height,o=n.a*t.x+n.c*t.y+n.tx,a=n.b*t.x+n.d*t.y+n.ty,s=n.a*i+n.c*t.y+n.tx,c=n.b*i+n.d*t.y+n.ty,l=n.a*t.x+n.c*r+n.tx,u=n.b*t.x+n.d*r+n.ty,h=n.a*i+n.c*r+n.tx,f=n.b*i+n.d*r+n.ty,_=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,f),m=Math.max(a,c,u,f);e.x=_,e.y=d,e.width=p-_,e.height=m-d},e.transformObb=function(e,t,n,i,r,o){var a=o.a*r.x+o.c*r.y+o.tx,s=o.b*r.x+o.d*r.y+o.ty,c=o.a*r.width,l=o.b*r.width,u=o.c*r.height,h=o.d*r.height;t.x=a,t.y=s,n.x=c+a,n.y=l+s,e.x=u+a,e.y=h+s,i.x=c+u+a,i.y=l+h+s},e}());u.AffineTransform=ti;var ni=e("Size",function(e){function t(t,n){var i;return i=e.call(this)||this,t&&"object"==typeof t?(i.width=t.width,i.height=t.height):(i.width=t||0,i.height=n||0),i}$(t,e),t.lerp=function(e,t,n,i){return e.width=t.width+(n.width-t.width)*i,e.height=t.height+(n.height-t.height)*i,e};var n=t.prototype;return n.clone=function(){return new t(this.width,this.height)},n.set=function(e,t){return e&&"object"==typeof e?(this.height=e.height,this.width=e.width):(this.width=e||0,this.height=t||0),this},n.equals=function(e){return this.width===e.width&&this.height===e.height},n.lerp=function(e,t){return this.width+=(e.width-this.width)*t,this.height+=(e.height-this.height)*t,this},n.toString=function(){return"("+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},Z(t,[{key:"x",get:function(){return this.width},set:function(e){this.width=e}},{key:"y",get:function(){return this.height},set:function(e){this.height=e}}]),t}(ht));function ii(e,t){return void 0===e&&(e=0),void 0===t&&(t=0),new ni(e,t)}ni.ZERO=Object.freeze(new ni(0,0)),ni.ONE=Object.freeze(new ni(1,1)),en.fastDefine("cc.Size",ni,{width:0,height:0}),u.size=ii,u.Size=ni;var ri=e("Rect",function(e){function t(t,n,i,r){var o;return o=e.call(this)||this,t&&"object"==typeof t?(o.y=t.y,o.width=t.width,o.height=t.height,o.x=t.x):(o.x=t||0,o.y=n||0,o.width=i||0,o.height=r||0),o}$(t,e),t.fromMinMax=function(e,t,n){var i=Math.min(t.x,n.x),r=Math.min(t.y,n.y),o=Math.max(t.x,n.x),a=Math.max(t.y,n.y);return e.x=i,e.y=r,e.width=o-i,e.height=a-r,e},t.lerp=function(e,t,n,i){var r=t.x,o=t.y,a=t.width,s=t.height;return e.x=r+(n.x-r)*i,e.y=o+(n.y-o)*i,e.width=a+(n.width-a)*i,e.height=s+(n.height-s)*i,e},t.intersection=function(e,t,n){var i=t.x,r=t.y,o=t.x+t.width,a=t.y+t.height,s=n.x,c=n.y,l=n.x+n.width,u=n.y+n.height;return e.x=Math.max(i,s),e.y=Math.max(r,c),e.width=Math.min(o,l)-e.x,e.height=Math.min(a,u)-e.y,e},t.union=function(e,t,n){var i=t.x,r=t.y,o=t.width,a=t.height,s=n.x,c=n.y,l=n.width,u=n.height;return e.x=Math.min(i,s),e.y=Math.min(r,c),e.width=Math.max(i+o,s+l)-e.x,e.height=Math.max(r+a,c+u)-e.y,e};var n=t.prototype;return n.clone=function(){return new t(this.x,this.y,this.width,this.height)},n.set=function(e,t,n,i){return e&&"object"==typeof e?(this.y=e.y,this.width=e.width,this.height=e.height,this.x=e.x):(this.x=e||0,this.y=t||0,this.width=n||0,this.height=i||0),this},n.equals=function(e){return this.x===e.x&&this.y===e.y&&this.width===e.width&&this.height===e.height},n.lerp=function(e,t){var n=this.x,i=this.y,r=this.width,o=this.height;return this.x=n+(e.x-n)*t,this.y=i+(e.y-i)*t,this.width=r+(e.width-r)*t,this.height=o+(e.height-o)*t,this},n.toString=function(){return"("+this.x.toFixed(2)+", "+this.y.toFixed(2)+", "+this.width.toFixed(2)+", "+this.height.toFixed(2)+")"},n.intersects=function(e){var t=this.x+this.width,n=this.y+this.height,i=e.x+e.width,r=e.y+e.height;return!(t<e.x||i<this.x||n<e.y||r<this.y)},n.contains=function(e){return this.x<=e.x&&this.x+this.width>=e.x&&this.y<=e.y&&this.y+this.height>=e.y},n.containsRect=function(e){return this.x<=e.x&&this.x+this.width>=e.x+e.width&&this.y<=e.y&&this.y+this.height>=e.y+e.height},n.transformMat4=function(e){var t=this.x,n=this.y,i=t+this.width,r=n+this.height,o=e.m00*t+e.m04*n+e.m12,a=e.m01*t+e.m05*n+e.m13,s=e.m00*i+e.m04*n+e.m12,c=e.m01*i+e.m05*n+e.m13,l=e.m00*t+e.m04*r+e.m12,u=e.m01*t+e.m05*r+e.m13,h=e.m00*i+e.m04*r+e.m12,f=e.m01*i+e.m05*r+e.m13,_=Math.min(o,s,l,h),p=Math.max(o,s,l,h),d=Math.min(a,c,u,f),m=Math.max(a,c,u,f);return this.x=_,this.y=d,this.width=p-_,this.height=m-d,this},n.transformMat4ToPoints=function(e,t,n,i,r){var o=this.x,a=this.y,s=o+this.width,c=a+this.height;t.x=e.m00*o+e.m04*a+e.m12,t.y=e.m01*o+e.m05*a+e.m13,r.x=e.m00*s+e.m04*a+e.m12,r.y=e.m01*s+e.m05*a+e.m13,n.x=e.m00*o+e.m04*c+e.m12,n.y=e.m01*o+e.m05*c+e.m13,i.x=e.m00*s+e.m04*c+e.m12,i.y=e.m01*s+e.m05*c+e.m13},Z(t,[{key:"xMin",get:function(){return this.x},set:function(e){this.width+=this.x-e,this.x=e}},{key:"yMin",get:function(){return this.y},set:function(e){this.height+=this.y-e,this.y=e}},{key:"xMax",get:function(){return this.x+this.width},set:function(e){this.width=e-this.x}},{key:"yMax",get:function(){return this.y+this.height},set:function(e){this.height=e-this.y}},{key:"center",get:function(){return new Kn(this.x+.5*this.width,this.y+.5*this.height)},set:function(e){this.x=e.x-.5*this.width,this.y=e.y-.5*this.height}},{key:"origin",get:function(){return new Kn(this.x,this.y)},set:function(e){this.x=e.x,this.y=e.y}},{key:"size",get:function(){return new ni(this.width,this.height)},set:function(e){this.width=e.width,this.height=e.height}},{key:"z",get:function(){return this.width},set:function(e){this.width=e}},{key:"w",get:function(){return this.height},set:function(e){this.height=e}}]),t}(ht));function oi(e,t,n,i){return void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),new ri(e,t,n,i)}en.fastDefine("cc.Rect",ri,{x:0,y:0,width:0,height:0}),u.Rect=ri,u.rect=oi;var ai=e("MATH_FLOAT_ARRAY",Float64Array),si=e("MathBase",function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t.createFloatArray=function(e){return new ai(e)},Z(t,[{key:"array",get:function(){return this._array}}]),t}(ht)),ci=Object.freeze({__proto__:null,bits:c,Vec2:Kn,v2:Jn,Vec3:In,v3:Mn,Vec4:$n,v4:ei,Quat:Fn,quat:Vn,Mat3:Nn,Mat4:jn,mat4:Yn,AffineTransform:ti,Size:ni,size:ii,Rect:ri,rect:oi,Color:Pn,color:Rn,EPSILON:an,equals:sn,approx:cn,clamp:ln,clamp01:un,lerp:hn,toRadian:fn,toDegree:_n,random:pn,randomRange:dn,randomRangeInt:mn,pseudoRandom:vn,pseudoRandomRange:gn,pseudoRandomRangeInt:yn,nextPow2:xn,repeat:Sn,pingPong:Tn,inverseLerp:bn,absMaxComponent:En,absMax:Cn,enumerableProps:An,MATH_FLOAT_ARRAY:ai,MathBase:si});e("math",ci);var li,ui,hi,fi,_i,pi,di,mi,vi,gi,yi,xi,Si,Ti,bi,Ei,Ci,Ai,wi,Pi,Ri,Ii,Di,Oi,Mi,Ni,Li,Bi,Fi,zi,Ui,ki,Gi,Hi,Vi,Wi,ji,qi,Xi,Yi,Ki,Qi=function(e,t,n){for(var i=0;i<t.length;++i)e.length<=i&&e.push(new n),e[i].copy(t[i]);e.length=t.length};!function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SWAPCHAIN=1]="SWAPCHAIN",e[e.BUFFER=2]="BUFFER",e[e.TEXTURE=3]="TEXTURE",e[e.RENDER_PASS=4]="RENDER_PASS",e[e.FRAMEBUFFER=5]="FRAMEBUFFER",e[e.SAMPLER=6]="SAMPLER",e[e.SHADER=7]="SHADER",e[e.DESCRIPTOR_SET_LAYOUT=8]="DESCRIPTOR_SET_LAYOUT",e[e.PIPELINE_LAYOUT=9]="PIPELINE_LAYOUT",e[e.PIPELINE_STATE=10]="PIPELINE_STATE",e[e.DESCRIPTOR_SET=11]="DESCRIPTOR_SET",e[e.INPUT_ASSEMBLER=12]="INPUT_ASSEMBLER",e[e.COMMAND_BUFFER=13]="COMMAND_BUFFER",e[e.QUEUE=14]="QUEUE",e[e.QUERY_POOL=15]="QUERY_POOL",e[e.GLOBAL_BARRIER=16]="GLOBAL_BARRIER",e[e.TEXTURE_BARRIER=17]="TEXTURE_BARRIER",e[e.BUFFER_BARRIER=18]="BUFFER_BARRIER",e[e.COUNT=19]="COUNT"}(li||(li={})),function(e){e[e.UNREADY=0]="UNREADY",e[e.FAILED=1]="FAILED",e[e.SUCCESS=2]="SUCCESS"}(ui||(ui={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.GLES2=1]="GLES2",e[e.GLES3=2]="GLES3",e[e.METAL=3]="METAL",e[e.VULKAN=4]="VULKAN",e[e.WEBGL=5]="WEBGL",e[e.WEBGL2=6]="WEBGL2",e[e.WEBGPU=7]="WEBGPU"}(hi||(hi={})),function(e){e[e.IDENTITY=0]="IDENTITY",e[e.ROTATE_90=1]="ROTATE_90",e[e.ROTATE_180=2]="ROTATE_180",e[e.ROTATE_270=3]="ROTATE_270"}(fi||(fi={})),function(e){e[e.COLOR_FLOAT=0]="COLOR_FLOAT",e[e.COLOR_HALF_FLOAT=1]="COLOR_HALF_FLOAT",e[e.TEXTURE_FLOAT=2]="TEXTURE_FLOAT",e[e.TEXTURE_HALF_FLOAT=3]="TEXTURE_HALF_FLOAT",e[e.TEXTURE_FLOAT_LINEAR=4]="TEXTURE_FLOAT_LINEAR",e[e.TEXTURE_HALF_FLOAT_LINEAR=5]="TEXTURE_HALF_FLOAT_LINEAR",e[e.FORMAT_R11G11B10F=6]="FORMAT_R11G11B10F",e[e.FORMAT_SRGB=7]="FORMAT_SRGB",e[e.FORMAT_ETC1=8]="FORMAT_ETC1",e[e.FORMAT_ETC2=9]="FORMAT_ETC2",e[e.FORMAT_DXT=10]="FORMAT_DXT",e[e.FORMAT_PVRTC=11]="FORMAT_PVRTC",e[e.FORMAT_ASTC=12]="FORMAT_ASTC",e[e.FORMAT_RGB8=13]="FORMAT_RGB8",e[e.ELEMENT_INDEX_UINT=14]="ELEMENT_INDEX_UINT",e[e.INSTANCED_ARRAYS=15]="INSTANCED_ARRAYS",e[e.MULTIPLE_RENDER_TARGETS=16]="MULTIPLE_RENDER_TARGETS",e[e.BLEND_MINMAX=17]="BLEND_MINMAX",e[e.COMPUTE_SHADER=18]="COMPUTE_SHADER",e[e.INPUT_ATTACHMENT_BENEFIT=19]="INPUT_ATTACHMENT_BENEFIT",e[e.COUNT=20]="COUNT"}(_i||(_i={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.A8=1]="A8",e[e.L8=2]="L8",e[e.LA8=3]="LA8",e[e.R8=4]="R8",e[e.R8SN=5]="R8SN",e[e.R8UI=6]="R8UI",e[e.R8I=7]="R8I",e[e.R16F=8]="R16F",e[e.R16UI=9]="R16UI",e[e.R16I=10]="R16I",e[e.R32F=11]="R32F",e[e.R32UI=12]="R32UI",e[e.R32I=13]="R32I",e[e.RG8=14]="RG8",e[e.RG8SN=15]="RG8SN",e[e.RG8UI=16]="RG8UI",e[e.RG8I=17]="RG8I",e[e.RG16F=18]="RG16F",e[e.RG16UI=19]="RG16UI",e[e.RG16I=20]="RG16I",e[e.RG32F=21]="RG32F",e[e.RG32UI=22]="RG32UI",e[e.RG32I=23]="RG32I",e[e.RGB8=24]="RGB8",e[e.SRGB8=25]="SRGB8",e[e.RGB8SN=26]="RGB8SN",e[e.RGB8UI=27]="RGB8UI",e[e.RGB8I=28]="RGB8I",e[e.RGB16F=29]="RGB16F",e[e.RGB16UI=30]="RGB16UI",e[e.RGB16I=31]="RGB16I",e[e.RGB32F=32]="RGB32F",e[e.RGB32UI=33]="RGB32UI",e[e.RGB32I=34]="RGB32I",e[e.RGBA8=35]="RGBA8",e[e.BGRA8=36]="BGRA8",e[e.SRGB8_A8=37]="SRGB8_A8",e[e.RGBA8SN=38]="RGBA8SN",e[e.RGBA8UI=39]="RGBA8UI",e[e.RGBA8I=40]="RGBA8I",e[e.RGBA16F=41]="RGBA16F",e[e.RGBA16UI=42]="RGBA16UI",e[e.RGBA16I=43]="RGBA16I",e[e.RGBA32F=44]="RGBA32F",e[e.RGBA32UI=45]="RGBA32UI",e[e.RGBA32I=46]="RGBA32I",e[e.R5G6B5=47]="R5G6B5",e[e.R11G11B10F=48]="R11G11B10F",e[e.RGB5A1=49]="RGB5A1",e[e.RGBA4=50]="RGBA4",e[e.RGB10A2=51]="RGB10A2",e[e.RGB10A2UI=52]="RGB10A2UI",e[e.RGB9E5=53]="RGB9E5",e[e.DEPTH=54]="DEPTH",e[e.DEPTH_STENCIL=55]="DEPTH_STENCIL",e[e.BC1=56]="BC1",e[e.BC1_ALPHA=57]="BC1_ALPHA",e[e.BC1_SRGB=58]="BC1_SRGB",e[e.BC1_SRGB_ALPHA=59]="BC1_SRGB_ALPHA",e[e.BC2=60]="BC2",e[e.BC2_SRGB=61]="BC2_SRGB",e[e.BC3=62]="BC3",e[e.BC3_SRGB=63]="BC3_SRGB",e[e.BC4=64]="BC4",e[e.BC4_SNORM=65]="BC4_SNORM",e[e.BC5=66]="BC5",e[e.BC5_SNORM=67]="BC5_SNORM",e[e.BC6H_UF16=68]="BC6H_UF16",e[e.BC6H_SF16=69]="BC6H_SF16",e[e.BC7=70]="BC7",e[e.BC7_SRGB=71]="BC7_SRGB",e[e.ETC_RGB8=72]="ETC_RGB8",e[e.ETC2_RGB8=73]="ETC2_RGB8",e[e.ETC2_SRGB8=74]="ETC2_SRGB8",e[e.ETC2_RGB8_A1=75]="ETC2_RGB8_A1",e[e.ETC2_SRGB8_A1=76]="ETC2_SRGB8_A1",e[e.ETC2_RGBA8=77]="ETC2_RGBA8",e[e.ETC2_SRGB8_A8=78]="ETC2_SRGB8_A8",e[e.EAC_R11=79]="EAC_R11",e[e.EAC_R11SN=80]="EAC_R11SN",e[e.EAC_RG11=81]="EAC_RG11",e[e.EAC_RG11SN=82]="EAC_RG11SN",e[e.PVRTC_RGB2=83]="PVRTC_RGB2",e[e.PVRTC_RGBA2=84]="PVRTC_RGBA2",e[e.PVRTC_RGB4=85]="PVRTC_RGB4",e[e.PVRTC_RGBA4=86]="PVRTC_RGBA4",e[e.PVRTC2_2BPP=87]="PVRTC2_2BPP",e[e.PVRTC2_4BPP=88]="PVRTC2_4BPP",e[e.ASTC_RGBA_4X4=89]="ASTC_RGBA_4X4",e[e.ASTC_RGBA_5X4=90]="ASTC_RGBA_5X4",e[e.ASTC_RGBA_5X5=91]="ASTC_RGBA_5X5",e[e.ASTC_RGBA_6X5=92]="ASTC_RGBA_6X5",e[e.ASTC_RGBA_6X6=93]="ASTC_RGBA_6X6",e[e.ASTC_RGBA_8X5=94]="ASTC_RGBA_8X5",e[e.ASTC_RGBA_8X6=95]="ASTC_RGBA_8X6",e[e.ASTC_RGBA_8X8=96]="ASTC_RGBA_8X8",e[e.ASTC_RGBA_10X5=97]="ASTC_RGBA_10X5",e[e.ASTC_RGBA_10X6=98]="ASTC_RGBA_10X6",e[e.ASTC_RGBA_10X8=99]="ASTC_RGBA_10X8",e[e.ASTC_RGBA_10X10=100]="ASTC_RGBA_10X10",e[e.ASTC_RGBA_12X10=101]="ASTC_RGBA_12X10",e[e.ASTC_RGBA_12X12=102]="ASTC_RGBA_12X12",e[e.ASTC_SRGBA_4X4=103]="ASTC_SRGBA_4X4",e[e.ASTC_SRGBA_5X4=104]="ASTC_SRGBA_5X4",e[e.ASTC_SRGBA_5X5=105]="ASTC_SRGBA_5X5",e[e.ASTC_SRGBA_6X5=106]="ASTC_SRGBA_6X5",e[e.ASTC_SRGBA_6X6=107]="ASTC_SRGBA_6X6",e[e.ASTC_SRGBA_8X5=108]="ASTC_SRGBA_8X5",e[e.ASTC_SRGBA_8X6=109]="ASTC_SRGBA_8X6",e[e.ASTC_SRGBA_8X8=110]="ASTC_SRGBA_8X8",e[e.ASTC_SRGBA_10X5=111]="ASTC_SRGBA_10X5",e[e.ASTC_SRGBA_10X6=112]="ASTC_SRGBA_10X6",e[e.ASTC_SRGBA_10X8=113]="ASTC_SRGBA_10X8",e[e.ASTC_SRGBA_10X10=114]="ASTC_SRGBA_10X10",e[e.ASTC_SRGBA_12X10=115]="ASTC_SRGBA_12X10",e[e.ASTC_SRGBA_12X12=116]="ASTC_SRGBA_12X12",e[e.COUNT=117]="COUNT"}(pi||(pi={})),function(e){e[e.NONE=0]="NONE",e[e.UNORM=1]="UNORM",e[e.SNORM=2]="SNORM",e[e.UINT=3]="UINT",e[e.INT=4]="INT",e[e.UFLOAT=5]="UFLOAT",e[e.FLOAT=6]="FLOAT"}(di||(di={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.BOOL=1]="BOOL",e[e.BOOL2=2]="BOOL2",e[e.BOOL3=3]="BOOL3",e[e.BOOL4=4]="BOOL4",e[e.INT=5]="INT",e[e.INT2=6]="INT2",e[e.INT3=7]="INT3",e[e.INT4=8]="INT4",e[e.UINT=9]="UINT",e[e.UINT2=10]="UINT2",e[e.UINT3=11]="UINT3",e[e.UINT4=12]="UINT4",e[e.FLOAT=13]="FLOAT",e[e.FLOAT2=14]="FLOAT2",e[e.FLOAT3=15]="FLOAT3",e[e.FLOAT4=16]="FLOAT4",e[e.MAT2=17]="MAT2",e[e.MAT2X3=18]="MAT2X3",e[e.MAT2X4=19]="MAT2X4",e[e.MAT3X2=20]="MAT3X2",e[e.MAT3=21]="MAT3",e[e.MAT3X4=22]="MAT3X4",e[e.MAT4X2=23]="MAT4X2",e[e.MAT4X3=24]="MAT4X3",e[e.MAT4=25]="MAT4",e[e.SAMPLER1D=26]="SAMPLER1D",e[e.SAMPLER1D_ARRAY=27]="SAMPLER1D_ARRAY",e[e.SAMPLER2D=28]="SAMPLER2D",e[e.SAMPLER2D_ARRAY=29]="SAMPLER2D_ARRAY",e[e.SAMPLER3D=30]="SAMPLER3D",e[e.SAMPLER_CUBE=31]="SAMPLER_CUBE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE1D=33]="TEXTURE1D",e[e.TEXTURE1D_ARRAY=34]="TEXTURE1D_ARRAY",e[e.TEXTURE2D=35]="TEXTURE2D",e[e.TEXTURE2D_ARRAY=36]="TEXTURE2D_ARRAY",e[e.TEXTURE3D=37]="TEXTURE3D",e[e.TEXTURE_CUBE=38]="TEXTURE_CUBE",e[e.IMAGE1D=39]="IMAGE1D",e[e.IMAGE1D_ARRAY=40]="IMAGE1D_ARRAY",e[e.IMAGE2D=41]="IMAGE2D",e[e.IMAGE2D_ARRAY=42]="IMAGE2D_ARRAY",e[e.IMAGE3D=43]="IMAGE3D",e[e.IMAGE_CUBE=44]="IMAGE_CUBE",e[e.SUBPASS_INPUT=45]="SUBPASS_INPUT",e[e.COUNT=46]="COUNT"}(mi||(mi={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.INDEX=4]="INDEX",e[e.VERTEX=8]="VERTEX",e[e.UNIFORM=16]="UNIFORM",e[e.STORAGE=32]="STORAGE",e[e.INDIRECT=64]="INDIRECT"}(vi||(vi={})),function(e){e[e.NONE=0]="NONE"}(gi||(gi={})),function(e){e[e.NONE=0]="NONE",e[e.READ_ONLY=1]="READ_ONLY",e[e.WRITE_ONLY=2]="WRITE_ONLY",e[e.READ_WRITE=3]="READ_WRITE"}(yi||(yi={})),function(e){e[e.NONE=0]="NONE",e[e.DEVICE=1]="DEVICE",e[e.HOST=2]="HOST"}(xi||(xi={})),function(e){e[e.TEX1D=0]="TEX1D",e[e.TEX2D=1]="TEX2D",e[e.TEX3D=2]="TEX3D",e[e.CUBE=3]="CUBE",e[e.TEX1D_ARRAY=4]="TEX1D_ARRAY",e[e.TEX2D_ARRAY=5]="TEX2D_ARRAY"}(Si||(Si={})),function(e){e[e.NONE=0]="NONE",e[e.TRANSFER_SRC=1]="TRANSFER_SRC",e[e.TRANSFER_DST=2]="TRANSFER_DST",e[e.SAMPLED=4]="SAMPLED",e[e.STORAGE=8]="STORAGE",e[e.COLOR_ATTACHMENT=16]="COLOR_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=32]="DEPTH_STENCIL_ATTACHMENT",e[e.INPUT_ATTACHMENT=64]="INPUT_ATTACHMENT"}(Ti||(Ti={})),function(e){e[e.NONE=0]="NONE",e[e.GEN_MIPMAP=1]="GEN_MIPMAP",e[e.GENERAL_LAYOUT=2]="GENERAL_LAYOUT"}(bi||(bi={})),function(e){e[e.ONE=0]="ONE",e[e.MULTIPLE_PERFORMANCE=1]="MULTIPLE_PERFORMANCE",e[e.MULTIPLE_BALANCE=2]="MULTIPLE_BALANCE",e[e.MULTIPLE_QUALITY=3]="MULTIPLE_QUALITY"}(Ei||(Ei={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON",e[e.RELAXED=2]="RELAXED",e[e.MAILBOX=3]="MAILBOX",e[e.HALF=4]="HALF"}(Ci||(Ci={})),function(e){e[e.NONE=0]="NONE",e[e.POINT=1]="POINT",e[e.LINEAR=2]="LINEAR",e[e.ANISOTROPIC=3]="ANISOTROPIC"}(Ai||(Ai={})),function(e){e[e.WRAP=0]="WRAP",e[e.MIRROR=1]="MIRROR",e[e.CLAMP=2]="CLAMP",e[e.BORDER=3]="BORDER"}(wi||(wi={})),function(e){e[e.NEVER=0]="NEVER",e[e.LESS=1]="LESS",e[e.EQUAL=2]="EQUAL",e[e.LESS_EQUAL=3]="LESS_EQUAL",e[e.GREATER=4]="GREATER",e[e.NOT_EQUAL=5]="NOT_EQUAL",e[e.GREATER_EQUAL=6]="GREATER_EQUAL",e[e.ALWAYS=7]="ALWAYS"}(Pi||(Pi={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=1]="KEEP",e[e.REPLACE=2]="REPLACE",e[e.INCR=3]="INCR",e[e.DECR=4]="DECR",e[e.INVERT=5]="INVERT",e[e.INCR_WRAP=6]="INCR_WRAP",e[e.DECR_WRAP=7]="DECR_WRAP"}(Ri||(Ri={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_ALPHA=2]="SRC_ALPHA",e[e.DST_ALPHA=3]="DST_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=4]="ONE_MINUS_SRC_ALPHA",e[e.ONE_MINUS_DST_ALPHA=5]="ONE_MINUS_DST_ALPHA",e[e.SRC_COLOR=6]="SRC_COLOR",e[e.DST_COLOR=7]="DST_COLOR",e[e.ONE_MINUS_SRC_COLOR=8]="ONE_MINUS_SRC_COLOR",e[e.ONE_MINUS_DST_COLOR=9]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=10]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=11]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=12]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=13]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=14]="ONE_MINUS_CONSTANT_ALPHA"}(Ii||(Ii={})),function(e){e[e.ADD=0]="ADD",e[e.SUB=1]="SUB",e[e.REV_SUB=2]="REV_SUB",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Di||(Di={})),function(e){e[e.NONE=0]="NONE",e[e.R=1]="R",e[e.G=2]="G",e[e.B=4]="B",e[e.A=8]="A",e[e.ALL=15]="ALL"}(Oi||(Oi={})),function(e){e[e.NONE=0]="NONE",e[e.VERTEX=1]="VERTEX",e[e.CONTROL=2]="CONTROL",e[e.EVALUATION=4]="EVALUATION",e[e.GEOMETRY=8]="GEOMETRY",e[e.FRAGMENT=16]="FRAGMENT",e[e.COMPUTE=32]="COMPUTE",e[e.ALL=63]="ALL"}(Mi||(Mi={})),function(e){e[e.LOAD=0]="LOAD",e[e.CLEAR=1]="CLEAR",e[e.DISCARD=2]="DISCARD"}(Ni||(Ni={})),function(e){e[e.STORE=0]="STORE",e[e.DISCARD=1]="DISCARD"}(Li||(Li={})),function(e){e[e.NONE=0]="NONE",e[e.INDIRECT_BUFFER=1]="INDIRECT_BUFFER",e[e.INDEX_BUFFER=2]="INDEX_BUFFER",e[e.VERTEX_BUFFER=3]="VERTEX_BUFFER",e[e.VERTEX_SHADER_READ_UNIFORM_BUFFER=4]="VERTEX_SHADER_READ_UNIFORM_BUFFER",e[e.VERTEX_SHADER_READ_TEXTURE=5]="VERTEX_SHADER_READ_TEXTURE",e[e.VERTEX_SHADER_READ_OTHER=6]="VERTEX_SHADER_READ_OTHER",e[e.FRAGMENT_SHADER_READ_UNIFORM_BUFFER=7]="FRAGMENT_SHADER_READ_UNIFORM_BUFFER",e[e.FRAGMENT_SHADER_READ_TEXTURE=8]="FRAGMENT_SHADER_READ_TEXTURE",e[e.FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT=9]="FRAGMENT_SHADER_READ_COLOR_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT=10]="FRAGMENT_SHADER_READ_DEPTH_STENCIL_INPUT_ATTACHMENT",e[e.FRAGMENT_SHADER_READ_OTHER=11]="FRAGMENT_SHADER_READ_OTHER",e[e.COLOR_ATTACHMENT_READ=12]="COLOR_ATTACHMENT_READ",e[e.DEPTH_STENCIL_ATTACHMENT_READ=13]="DEPTH_STENCIL_ATTACHMENT_READ",e[e.COMPUTE_SHADER_READ_UNIFORM_BUFFER=14]="COMPUTE_SHADER_READ_UNIFORM_BUFFER",e[e.COMPUTE_SHADER_READ_TEXTURE=15]="COMPUTE_SHADER_READ_TEXTURE",e[e.COMPUTE_SHADER_READ_OTHER=16]="COMPUTE_SHADER_READ_OTHER",e[e.TRANSFER_READ=17]="TRANSFER_READ",e[e.HOST_READ=18]="HOST_READ",e[e.PRESENT=19]="PRESENT",e[e.VERTEX_SHADER_WRITE=20]="VERTEX_SHADER_WRITE",e[e.FRAGMENT_SHADER_WRITE=21]="FRAGMENT_SHADER_WRITE",e[e.COLOR_ATTACHMENT_WRITE=22]="COLOR_ATTACHMENT_WRITE",e[e.DEPTH_STENCIL_ATTACHMENT_WRITE=23]="DEPTH_STENCIL_ATTACHMENT_WRITE",e[e.COMPUTE_SHADER_WRITE=24]="COMPUTE_SHADER_WRITE",e[e.TRANSFER_WRITE=25]="TRANSFER_WRITE",e[e.HOST_PREINITIALIZED=26]="HOST_PREINITIALIZED",e[e.HOST_WRITE=27]="HOST_WRITE"}(Bi||(Bi={})),function(e){e[e.NONE=0]="NONE",e[e.SAMPLE_ZERO=1]="SAMPLE_ZERO",e[e.AVERAGE=2]="AVERAGE",e[e.MIN=3]="MIN",e[e.MAX=4]="MAX"}(Fi||(Fi={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.RAY_TRACING=2]="RAY_TRACING"}(zi||(zi={})),function(e){e[e.POINT_LIST=0]="POINT_LIST",e[e.LINE_LIST=1]="LINE_LIST",e[e.LINE_STRIP=2]="LINE_STRIP",e[e.LINE_LOOP=3]="LINE_LOOP",e[e.LINE_LIST_ADJACENCY=4]="LINE_LIST_ADJACENCY",e[e.LINE_STRIP_ADJACENCY=5]="LINE_STRIP_ADJACENCY",e[e.ISO_LINE_LIST=6]="ISO_LINE_LIST",e[e.TRIANGLE_LIST=7]="TRIANGLE_LIST",e[e.TRIANGLE_STRIP=8]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=9]="TRIANGLE_FAN",e[e.TRIANGLE_LIST_ADJACENCY=10]="TRIANGLE_LIST_ADJACENCY",e[e.TRIANGLE_STRIP_ADJACENCY=11]="TRIANGLE_STRIP_ADJACENCY",e[e.TRIANGLE_PATCH_ADJACENCY=12]="TRIANGLE_PATCH_ADJACENCY",e[e.QUAD_PATCH_LIST=13]="QUAD_PATCH_LIST"}(Ui||(Ui={})),function(e){e[e.FILL=0]="FILL",e[e.POINT=1]="POINT",e[e.LINE=2]="LINE"}(ki||(ki={})),function(e){e[e.GOURAND=0]="GOURAND",e[e.FLAT=1]="FLAT"}(Gi||(Gi={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK"}(Hi||(Hi={})),function(e){e[e.NONE=0]="NONE",e[e.LINE_WIDTH=1]="LINE_WIDTH",e[e.DEPTH_BIAS=2]="DEPTH_BIAS",e[e.BLEND_CONSTANTS=4]="BLEND_CONSTANTS",e[e.DEPTH_BOUNDS=8]="DEPTH_BOUNDS",e[e.STENCIL_WRITE_MASK=16]="STENCIL_WRITE_MASK",e[e.STENCIL_COMPARE_MASK=32]="STENCIL_COMPARE_MASK"}(Vi||(Vi={})),function(e){e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.ALL=3]="ALL"}(Wi||(Wi={})),function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.UNIFORM_BUFFER=1]="UNIFORM_BUFFER",e[e.DYNAMIC_UNIFORM_BUFFER=2]="DYNAMIC_UNIFORM_BUFFER",e[e.STORAGE_BUFFER=4]="STORAGE_BUFFER",e[e.DYNAMIC_STORAGE_BUFFER=8]="DYNAMIC_STORAGE_BUFFER",e[e.SAMPLER_TEXTURE=16]="SAMPLER_TEXTURE",e[e.SAMPLER=32]="SAMPLER",e[e.TEXTURE=64]="TEXTURE",e[e.STORAGE_IMAGE=128]="STORAGE_IMAGE",e[e.INPUT_ATTACHMENT=256]="INPUT_ATTACHMENT"}(ji||(ji={})),function(e){e[e.GRAPHICS=0]="GRAPHICS",e[e.COMPUTE=1]="COMPUTE",e[e.TRANSFER=2]="TRANSFER"}(qi||(qi={})),function(e){e[e.OCCLUSION=0]="OCCLUSION",e[e.PIPELINE_STATISTICS=1]="PIPELINE_STATISTICS",e[e.TIMESTAMP=2]="TIMESTAMP"}(Xi||(Xi={})),function(e){e[e.PRIMARY=0]="PRIMARY",e[e.SECONDARY=1]="SECONDARY"}(Yi||(Yi={})),function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.DEPTH=2]="DEPTH",e[e.STENCIL=4]="STENCIL",e[e.DEPTH_STENCIL=6]="DEPTH_STENCIL",e[e.ALL=7]="ALL"}(Ki||(Ki={}));var Zi,Ji=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),$i=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m,v,g,y,x,S){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=0),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=1),void 0===p&&(p=0),void 0===d&&(d=0),void 0===m&&(m=new Ji),void 0===v&&(v=new Ji),void 0===g&&(g=!1),void 0===y&&(y=-1),void 0===x&&(x=1),void 0===S&&(S=1),this.maxVertexAttributes=e,this.maxVertexUniformVectors=t,this.maxFragmentUniformVectors=n,this.maxTextureUnits=i,this.maxImageUnits=r,this.maxVertexTextureUnits=o,this.maxColorRenderTargets=a,this.maxShaderStorageBufferBindings=s,this.maxShaderStorageBlockSize=c,this.maxUniformBufferBindings=l,this.maxUniformBlockSize=u,this.maxTextureSize=h,this.maxCubeMapTextureSize=f,this.uboOffsetAlignment=_,this.maxComputeSharedMemorySize=p,this.maxComputeWorkGroupInvocations=d,this.maxComputeWorkGroupSize=m,this.maxComputeWorkGroupCount=v,this.supportQuery=g,this.clipSpaceMinZ=y,this.screenSpaceSignY=x,this.clipSpaceSignY=S}return e.prototype.copy=function(e){return this.maxVertexAttributes=e.maxVertexAttributes,this.maxVertexUniformVectors=e.maxVertexUniformVectors,this.maxFragmentUniformVectors=e.maxFragmentUniformVectors,this.maxTextureUnits=e.maxTextureUnits,this.maxImageUnits=e.maxImageUnits,this.maxVertexTextureUnits=e.maxVertexTextureUnits,this.maxColorRenderTargets=e.maxColorRenderTargets,this.maxShaderStorageBufferBindings=e.maxShaderStorageBufferBindings,this.maxShaderStorageBlockSize=e.maxShaderStorageBlockSize,this.maxUniformBufferBindings=e.maxUniformBufferBindings,this.maxUniformBlockSize=e.maxUniformBlockSize,this.maxTextureSize=e.maxTextureSize,this.maxCubeMapTextureSize=e.maxCubeMapTextureSize,this.uboOffsetAlignment=e.uboOffsetAlignment,this.maxComputeSharedMemorySize=e.maxComputeSharedMemorySize,this.maxComputeWorkGroupInvocations=e.maxComputeWorkGroupInvocations,this.maxComputeWorkGroupSize.copy(e.maxComputeWorkGroupSize),this.maxComputeWorkGroupCount.copy(e.maxComputeWorkGroupCount),this.supportQuery=e.supportQuery,this.clipSpaceMinZ=e.clipSpaceMinZ,this.screenSpaceSignY=e.screenSpaceSignY,this.clipSpaceSignY=e.clipSpaceSignY,this},e}(),er=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.x=e,this.y=t,this.z=n}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},e}(),tr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.width=e.width,this.height=e.height,this},e}(),nr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.width=e,this.height=t,this.depth=n}return e.prototype.copy=function(e){return this.width=e.width,this.height=e.height,this.depth=e.depth,this},e}(),ir=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=1),this.mipLevel=e,this.baseArrayLayer=t,this.layerCount=n}return e.prototype.copy=function(e){return this.mipLevel=e.mipLevel,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),rr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=1),this.baseMipLevel=e,this.levelCount=t,this.baseArrayLayer=n,this.layerCount=i}return e.prototype.copy=function(e){return this.baseMipLevel=e.baseMipLevel,this.levelCount=e.levelCount,this.baseArrayLayer=e.baseArrayLayer,this.layerCount=e.layerCount,this},e}(),or=function(){function e(e,t,n,i,r){void 0===e&&(e=new ir),void 0===t&&(t=new er),void 0===n&&(n=new ir),void 0===i&&(i=new er),void 0===r&&(r=new nr),this.srcSubres=e,this.srcOffset=t,this.dstSubres=n,this.dstOffset=i,this.extent=r}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.extent.copy(e.extent),this},e}(),ar=function(){function e(e,t,n,i,r,o){void 0===e&&(e=new ir),void 0===t&&(t=new er),void 0===n&&(n=new nr),void 0===i&&(i=new ir),void 0===r&&(r=new er),void 0===o&&(o=new nr),this.srcSubres=e,this.srcOffset=t,this.srcExtent=n,this.dstSubres=i,this.dstOffset=r,this.dstExtent=o}return e.prototype.copy=function(e){return this.srcSubres.copy(e.srcSubres),this.srcOffset.copy(e.srcOffset),this.srcExtent.copy(e.srcExtent),this.dstSubres.copy(e.dstSubres),this.dstOffset.copy(e.dstOffset),this.dstExtent.copy(e.dstExtent),this},e}(),sr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=new er),void 0===i&&(i=new nr),void 0===r&&(r=new ir),this.buffStride=e,this.buffTexHeight=t,this.texOffset=n,this.texExtent=i,this.texSubres=r}return e.prototype.copy=function(e){return this.buffStride=e.buffStride,this.buffTexHeight=e.buffTexHeight,this.texOffset.copy(e.texOffset),this.texExtent.copy(e.texExtent),this.texSubres.copy(e.texSubres),this},e}(),cr=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=1),this.left=e,this.top=t,this.width=n,this.height=i,this.minDepth=r,this.maxDepth=o}return e.prototype.copy=function(e){return this.left=e.left,this.top=e.top,this.width=e.width,this.height=e.height,this.minDepth=e.minDepth,this.maxDepth=e.maxDepth,this},e}(),lr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=e,this.y=t,this.z=n,this.w=i}return e.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},e}(),ur=function(){function e(e,t,n){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=0),this.bufferOffsets=e,this.samplerOffsets=t,this.flexibleSet=n}return e.prototype.copy=function(e){return this.bufferOffsets=e.bufferOffsets.slice(),this.samplerOffsets=e.samplerOffsets.slice(),this.flexibleSet=e.flexibleSet,this},e}(),hr=function(){function e(e,t,n,i){void 0===e&&(e=null),void 0===t&&(t=Ci.ON),void 0===n&&(n=0),void 0===i&&(i=0),this.windowHandle=e,this.vsyncMode=t,this.width=n,this.height=i}return e.prototype.copy=function(e){return this.windowHandle=e.windowHandle,this.vsyncMode=e.vsyncMode,this.width=e.width,this.height=e.height,this},e}(),fr=function(){function e(e){void 0===e&&(e=new ur),this.bindingMappingInfo=e}return e.prototype.copy=function(e){return this.bindingMappingInfo.copy(e.bindingMappingInfo),this},e}(),_r=function(){function e(e,t,n,i,r){void 0===e&&(e=vi.NONE),void 0===t&&(t=xi.NONE),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=gi.NONE),this.usage=e,this.memUsage=t,this.size=n,this.stride=i,this.flags=r}return e.prototype.copy=function(e){return this.usage=e.usage,this.memUsage=e.memUsage,this.size=e.size,this.stride=e.stride,this.flags=e.flags,this},e}(),pr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=0),void 0===n&&(n=0),this.buffer=e,this.offset=t,this.range=n}return e.prototype.copy=function(e){return this.buffer=e.buffer,this.offset=e.offset,this.range=e.range,this},e}(),dr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),this.vertexCount=e,this.firstVertex=t,this.indexCount=n,this.firstIndex=i,this.vertexOffset=r,this.instanceCount=o,this.firstInstance=a}return e.prototype.copy=function(e){return this.vertexCount=e.vertexCount,this.firstVertex=e.firstVertex,this.indexCount=e.indexCount,this.firstIndex=e.firstIndex,this.vertexOffset=e.vertexOffset,this.instanceCount=e.instanceCount,this.firstInstance=e.firstInstance,this},e}(),mr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null),void 0===r&&(r=0),this.groupCountX=e,this.groupCountY=t,this.groupCountZ=n,this.indirectBuffer=i,this.indirectOffset=r}return e.prototype.copy=function(e){return this.groupCountX=e.groupCountX,this.groupCountY=e.groupCountY,this.groupCountZ=e.groupCountZ,this.indirectBuffer=e.indirectBuffer,this.indirectOffset=e.indirectOffset,this},e}(),vr=function(){function e(e){void 0===e&&(e=[]),this.drawInfos=e}return e.prototype.copy=function(e){return Qi(this.drawInfos,e.drawInfos,dr),this},e}(),gr=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=Si.TEX2D),void 0===t&&(t=Ti.NONE),void 0===n&&(n=pi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=bi.NONE),void 0===a&&(a=1),void 0===s&&(s=1),void 0===c&&(c=Ei.ONE),void 0===l&&(l=1),void 0===u&&(u=0),this.type=e,this.usage=t,this.format=n,this.width=i,this.height=r,this.flags=o,this.layerCount=a,this.levelCount=s,this.samples=c,this.depth=l,this.externalRes=u}return e.prototype.copy=function(e){return this.type=e.type,this.usage=e.usage,this.format=e.format,this.width=e.width,this.height=e.height,this.flags=e.flags,this.layerCount=e.layerCount,this.levelCount=e.levelCount,this.samples=e.samples,this.depth=e.depth,this.externalRes=e.externalRes,this},e}(),yr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=null),void 0===t&&(t=Si.TEX2D),void 0===n&&(n=pi.UNKNOWN),void 0===i&&(i=0),void 0===r&&(r=1),void 0===o&&(o=0),void 0===a&&(a=1),this.texture=e,this.type=t,this.format=n,this.baseLevel=i,this.levelCount=r,this.baseLayer=o,this.layerCount=a}return e.prototype.copy=function(e){return this.texture=e.texture,this.type=e.type,this.format=e.format,this.baseLevel=e.baseLevel,this.levelCount=e.levelCount,this.baseLayer=e.baseLayer,this.layerCount=e.layerCount,this},e}(),xr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=Ai.LINEAR),void 0===t&&(t=Ai.LINEAR),void 0===n&&(n=Ai.NONE),void 0===i&&(i=wi.WRAP),void 0===r&&(r=wi.WRAP),void 0===o&&(o=wi.WRAP),void 0===a&&(a=0),void 0===s&&(s=Pi.ALWAYS),this.minFilter=e,this.magFilter=t,this.mipFilter=n,this.addressU=i,this.addressV=r,this.addressW=o,this.maxAnisotropy=a,this.cmpFunc=s}return e.prototype.copy=function(e){return this.minFilter=e.minFilter,this.magFilter=e.magFilter,this.mipFilter=e.mipFilter,this.addressU=e.addressU,this.addressV=e.addressV,this.addressW=e.addressW,this.maxAnisotropy=e.maxAnisotropy,this.cmpFunc=e.cmpFunc,this},e}(),Sr=function(){function e(e,t,n){void 0===e&&(e=""),void 0===t&&(t=mi.UNKNOWN),void 0===n&&(n=0),this.name=e,this.type=t,this.count=n}return e.prototype.copy=function(e){return this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Tr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=[]),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.members=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,Qi(this.members,e.members,Sr),this.count=e.count,this},e}(),br=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=mi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Er=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Cr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=mi.UNKNOWN),void 0===r&&(r=0),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this},e}(),Ar=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=mi.UNKNOWN),void 0===r&&(r=0),void 0===o&&(o=yi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.type=i,this.count=r,this.memoryAccess=o}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.type=e.type,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),wr=function(){function e(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),void 0===r&&(r=yi.READ_WRITE),this.set=e,this.binding=t,this.name=n,this.count=i,this.memoryAccess=r}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this.memoryAccess=e.memoryAccess,this},e}(),Pr=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=""),void 0===i&&(i=0),this.set=e,this.binding=t,this.name=n,this.count=i}return e.prototype.copy=function(e){return this.set=e.set,this.binding=e.binding,this.name=e.name,this.count=e.count,this},e}(),Rr=function(){function e(e,t){void 0===e&&(e=Mi.NONE),void 0===t&&(t=""),this.stage=e,this.source=t}return e.prototype.copy=function(e){return this.stage=e.stage,this.source=e.source,this},e}(),Ir=function(){function e(e,t,n,i,r,o){void 0===e&&(e=""),void 0===t&&(t=pi.UNKNOWN),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===r&&(r=!1),void 0===o&&(o=0),this.name=e,this.format=t,this.isNormalized=n,this.stream=i,this.isInstanced=r,this.location=o}return e.prototype.copy=function(e){return this.name=e.name,this.format=e.format,this.isNormalized=e.isNormalized,this.stream=e.stream,this.isInstanced=e.isInstanced,this.location=e.location,this},e}(),Dr=function(){function e(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=""),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=[]),void 0===o&&(o=[]),void 0===a&&(a=[]),void 0===s&&(s=[]),void 0===c&&(c=[]),void 0===l&&(l=[]),this.name=e,this.stages=t,this.attributes=n,this.blocks=i,this.buffers=r,this.samplerTextures=o,this.samplers=a,this.textures=s,this.images=c,this.subpassInputs=l}return e.prototype.copy=function(e){return this.name=e.name,Qi(this.stages,e.stages,Rr),Qi(this.attributes,e.attributes,Ir),Qi(this.blocks,e.blocks,Tr),Qi(this.buffers,e.buffers,wr),Qi(this.samplerTextures,e.samplerTextures,br),Qi(this.samplers,e.samplers,Er),Qi(this.textures,e.textures,Cr),Qi(this.images,e.images,Ar),Qi(this.subpassInputs,e.subpassInputs,Pr),this},e}(),Or=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=null),void 0===i&&(i=null),this.attributes=e,this.vertexBuffers=t,this.indexBuffer=n,this.indirectBuffer=i}return e.prototype.copy=function(e){return Qi(this.attributes,e.attributes,Ir),this.vertexBuffers=e.vertexBuffers.slice(),this.indexBuffer=e.indexBuffer,this.indirectBuffer=e.indirectBuffer,this},e}(),Mr=function(){function e(e,t,n,i,r,o,a){void 0===e&&(e=pi.UNKNOWN),void 0===t&&(t=Ei.ONE),void 0===n&&(n=Ni.CLEAR),void 0===i&&(i=Li.STORE),void 0===r&&(r=[]),void 0===o&&(o=[Bi.COLOR_ATTACHMENT_WRITE]),void 0===a&&(a=!1),this.format=e,this.sampleCount=t,this.loadOp=n,this.storeOp=i,this.beginAccesses=r,this.endAccesses=o,this.isGeneralLayout=a}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.loadOp=e.loadOp,this.storeOp=e.storeOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Nr=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=pi.UNKNOWN),void 0===t&&(t=Ei.ONE),void 0===n&&(n=Ni.CLEAR),void 0===i&&(i=Li.STORE),void 0===r&&(r=Ni.CLEAR),void 0===o&&(o=Li.STORE),void 0===a&&(a=[]),void 0===s&&(s=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE]),void 0===c&&(c=!1),this.format=e,this.sampleCount=t,this.depthLoadOp=n,this.depthStoreOp=i,this.stencilLoadOp=r,this.stencilStoreOp=o,this.beginAccesses=a,this.endAccesses=s,this.isGeneralLayout=c}return e.prototype.copy=function(e){return this.format=e.format,this.sampleCount=e.sampleCount,this.depthLoadOp=e.depthLoadOp,this.depthStoreOp=e.depthStoreOp,this.stencilLoadOp=e.stencilLoadOp,this.stencilStoreOp=e.stencilStoreOp,this.beginAccesses=e.beginAccesses.slice(),this.endAccesses=e.endAccesses.slice(),this.isGeneralLayout=e.isGeneralLayout,this},e}(),Lr=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=[]),void 0===i&&(i=[]),void 0===r&&(r=-1),void 0===o&&(o=-1),void 0===a&&(a=Fi.NONE),void 0===s&&(s=Fi.NONE),this.inputs=e,this.colors=t,this.resolves=n,this.preserves=i,this.depthStencil=r,this.depthStencilResolve=o,this.depthResolveMode=a,this.stencilResolveMode=s}return e.prototype.copy=function(e){return this.inputs=e.inputs.slice(),this.colors=e.colors.slice(),this.resolves=e.resolves.slice(),this.preserves=e.preserves.slice(),this.depthStencil=e.depthStencil,this.depthStencilResolve=e.depthStencilResolve,this.depthResolveMode=e.depthResolveMode,this.stencilResolveMode=e.stencilResolveMode,this},e}(),Br=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=[]),void 0===i&&(i=[]),this.srcSubpass=e,this.dstSubpass=t,this.srcAccesses=n,this.dstAccesses=i}return e.prototype.copy=function(e){return this.srcSubpass=e.srcSubpass,this.dstSubpass=e.dstSubpass,this.srcAccesses=e.srcAccesses.slice(),this.dstAccesses=e.dstAccesses.slice(),this},e}(),Fr=function(){function e(e,t,n,i){void 0===e&&(e=[]),void 0===t&&(t=new Nr),void 0===n&&(n=[]),void 0===i&&(i=[]),this.colorAttachments=e,this.depthStencilAttachment=t,this.subpasses=n,this.dependencies=i}return e.prototype.copy=function(e){return Qi(this.colorAttachments,e.colorAttachments,Mr),this.depthStencilAttachment.copy(e.depthStencilAttachment),Qi(this.subpasses,e.subpasses,Lr),Qi(this.dependencies,e.dependencies,Br),this},e}(),zr=function(){function e(e,t){void 0===e&&(e=[]),void 0===t&&(t=[]),this.prevAccesses=e,this.nextAccesses=t}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this},e}(),Ur=function(){function e(e,t,n,i,r){void 0===e&&(e=[]),void 0===t&&(t=[]),void 0===n&&(n=!1),void 0===i&&(i=null),void 0===r&&(r=null),this.prevAccesses=e,this.nextAccesses=t,this.discardContents=n,this.srcQueue=i,this.dstQueue=r}return e.prototype.copy=function(e){return this.prevAccesses=e.prevAccesses.slice(),this.nextAccesses=e.nextAccesses.slice(),this.discardContents=e.discardContents,this.srcQueue=e.srcQueue,this.dstQueue=e.dstQueue,this},e}(),kr=function(){function e(e,t,n){void 0===e&&(e=null),void 0===t&&(t=[]),void 0===n&&(n=null),this.renderPass=e,this.colorTextures=t,this.depthStencilTexture=n}return e.prototype.copy=function(e){return this.renderPass=e.renderPass,this.colorTextures=e.colorTextures.slice(),this.depthStencilTexture=e.depthStencilTexture,this},e}(),Gr=function(){function e(e,t,n,i,r){void 0===e&&(e=-1),void 0===t&&(t=ji.UNKNOWN),void 0===n&&(n=0),void 0===i&&(i=Mi.NONE),void 0===r&&(r=[]),this.binding=e,this.descriptorType=t,this.count=n,this.stageFlags=i,this.immutableSamplers=r}return e.prototype.copy=function(e){return this.binding=e.binding,this.descriptorType=e.descriptorType,this.count=e.count,this.stageFlags=e.stageFlags,this.immutableSamplers=e.immutableSamplers.slice(),this},e}(),Hr=function(){function e(e){void 0===e&&(e=[]),this.bindings=e}return e.prototype.copy=function(e){return Qi(this.bindings,e.bindings,Gr),this},e}(),Vr=function(){function e(e){void 0===e&&(e=null),this.layout=e}return e.prototype.copy=function(e){return this.layout=e.layout,this},e}(),Wr=function(){function e(e){void 0===e&&(e=[]),this.setLayouts=e}return e.prototype.copy=function(e){return this.setLayouts=e.setLayouts.slice(),this},e}(),jr=function(){function e(e){void 0===e&&(e=[]),this.attributes=e}return e.prototype.copy=function(e){return Qi(this.attributes,e.attributes,Ir),this},e}(),qr=function(){function e(e,t){void 0===e&&(e=null),void 0===t&&(t=Yi.PRIMARY),this.queue=e,this.type=t}return e.prototype.copy=function(e){return this.queue=e.queue,this.type=e.type,this},e}(),Xr=function(){function e(e){void 0===e&&(e=qi.GRAPHICS),this.type=e}return e.prototype.copy=function(e){return this.type=e.type,this},e}(),Yr=function(){function e(e,t,n){void 0===e&&(e=Xi.OCCLUSION),void 0===t&&(t=65536),void 0===n&&(n=!0),this.type=e,this.maxQueryObjects=t,this.forceWait=n}return e.prototype.copy=function(e){return this.type=e.type,this.maxQueryObjects=e.maxQueryObjects,this.forceWait=e.forceWait,this},e}(),Kr=function(e,t,n,i,r,o,a,s){void 0===e&&(e=""),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=di.NONE),void 0===r&&(r=!1),void 0===o&&(o=!1),void 0===a&&(a=!1),void 0===s&&(s=!1),this.name=e,this.size=t,this.count=n,this.type=i,this.hasAlpha=r,this.hasDepth=o,this.hasStencil=a,this.isCompressed=s},Qr=function(){function e(e,t){void 0===e&&(e=0),void 0===t&&(t=0),this.bufferSize=e,this.textureSize=t}return e.prototype.copy=function(e){return this.bufferSize=e.bufferSize,this.textureSize=e.textureSize,this},e}(),Zr=function(){function e(e,t,n){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),this.writeMask=e,this.compareMask=t,this.reference=n}return e.prototype.copy=function(e){return this.writeMask=e.writeMask,this.compareMask=e.compareMask,this.reference=e.reference,this},e}(),Jr=function(){function e(e,t,n,i,r,o,a,s,c,l,u){void 0===e&&(e=new cr),void 0===t&&(t=new tr),void 0===n&&(n=new lr),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=new Zr),void 0===u&&(u=new Zr),this.viewport=e,this.scissor=t,this.blendConstant=n,this.lineWidth=i,this.depthBiasConstant=r,this.depthBiasClamp=o,this.depthBiasSlope=a,this.depthMinBounds=s,this.depthMaxBounds=c,this.stencilStatesFront=l,this.stencilStatesBack=u}return e.prototype.copy=function(e){return this.viewport.copy(e.viewport),this.scissor.copy(e.scissor),this.blendConstant.copy(e.blendConstant),this.lineWidth=e.lineWidth,this.depthBiasConstant=e.depthBiasConstant,this.depthBiasClamp=e.depthBiasClamp,this.depthBiasSlope=e.depthBiasSlope,this.depthMinBounds=e.depthMinBounds,this.depthMaxBounds=e.depthMaxBounds,this.stencilStatesFront.copy(e.stencilStatesFront),this.stencilStatesBack.copy(e.stencilStatesBack),this},e}(),$r=function(){function e(t){this._objectType=li.UNKNOWN,this._objectID=0,this._typedID=0,this._objectType=t,this._objectID=e._idTable[li.UNKNOWN]++,this._typedID=e._idTable[t]++}return Z(e,[{key:"objectType",get:function(){return this._objectType}},{key:"objectID",get:function(){return this._objectID}},{key:"typedID",get:function(){return this._typedID}}]),e}();$r._idTable=Array(li.COUNT).fill(65536),function(e){e.ATTR_POSITION="a_position",e.ATTR_NORMAL="a_normal",e.ATTR_TANGENT="a_tangent",e.ATTR_BITANGENT="a_bitangent",e.ATTR_WEIGHTS="a_weights",e.ATTR_JOINTS="a_joints",e.ATTR_COLOR="a_color",e.ATTR_COLOR1="a_color1",e.ATTR_COLOR2="a_color2",e.ATTR_TEX_COORD="a_texCoord",e.ATTR_TEX_COORD1="a_texCoord1",e.ATTR_TEX_COORD2="a_texCoord2",e.ATTR_TEX_COORD3="a_texCoord3",e.ATTR_TEX_COORD4="a_texCoord4",e.ATTR_TEX_COORD5="a_texCoord5",e.ATTR_TEX_COORD6="a_texCoord6",e.ATTR_TEX_COORD7="a_texCoord7",e.ATTR_TEX_COORD8="a_texCoord8",e.ATTR_BATCH_ID="a_batch_id",e.ATTR_BATCH_UV="a_batch_uv"}(Zi||(Zi={}));var eo=Object.freeze([new Kr("UNKNOWN",0,0,di.NONE,!1,!1,!1,!1),new Kr("A8",1,1,di.UNORM,!0,!1,!1,!1),new Kr("L8",1,1,di.UNORM,!1,!1,!1,!1),new Kr("LA8",1,2,di.UNORM,!0,!1,!1,!1),new Kr("R8",1,1,di.UNORM,!1,!1,!1,!1),new Kr("R8SN",1,1,di.SNORM,!1,!1,!1,!1),new Kr("R8UI",1,1,di.UINT,!1,!1,!1,!1),new Kr("R8I",1,1,di.INT,!1,!1,!1,!1),new Kr("R16F",2,1,di.FLOAT,!1,!1,!1,!1),new Kr("R16UI",2,1,di.UINT,!1,!1,!1,!1),new Kr("R16I",2,1,di.INT,!1,!1,!1,!1),new Kr("R32F",4,1,di.FLOAT,!1,!1,!1,!1),new Kr("R32UI",4,1,di.UINT,!1,!1,!1,!1),new Kr("R32I",4,1,di.INT,!1,!1,!1,!1),new Kr("RG8",2,2,di.UNORM,!1,!1,!1,!1),new Kr("RG8SN",2,2,di.SNORM,!1,!1,!1,!1),new Kr("RG8UI",2,2,di.UINT,!1,!1,!1,!1),new Kr("RG8I",2,2,di.INT,!1,!1,!1,!1),new Kr("RG16F",4,2,di.FLOAT,!1,!1,!1,!1),new Kr("RG16UI",4,2,di.UINT,!1,!1,!1,!1),new Kr("RG16I",4,2,di.INT,!1,!1,!1,!1),new Kr("RG32F",8,2,di.FLOAT,!1,!1,!1,!1),new Kr("RG32UI",8,2,di.UINT,!1,!1,!1,!1),new Kr("RG32I",8,2,di.INT,!1,!1,!1,!1),new Kr("RGB8",3,3,di.UNORM,!1,!1,!1,!1),new Kr("SRGB8",3,3,di.UNORM,!1,!1,!1,!1),new Kr("RGB8SN",3,3,di.SNORM,!1,!1,!1,!1),new Kr("RGB8UI",3,3,di.UINT,!1,!1,!1,!1),new Kr("RGB8I",3,3,di.INT,!1,!1,!1,!1),new Kr("RGB16F",6,3,di.FLOAT,!1,!1,!1,!1),new Kr("RGB16UI",6,3,di.UINT,!1,!1,!1,!1),new Kr("RGB16I",6,3,di.INT,!1,!1,!1,!1),new Kr("RGB32F",12,3,di.FLOAT,!1,!1,!1,!1),new Kr("RGB32UI",12,3,di.UINT,!1,!1,!1,!1),new Kr("RGB32I",12,3,di.INT,!1,!1,!1,!1),new Kr("RGBA8",4,4,di.UNORM,!0,!1,!1,!1),new Kr("BGRA8",4,4,di.UNORM,!0,!1,!1,!1),new Kr("SRGB8_A8",4,4,di.UNORM,!0,!1,!1,!1),new Kr("RGBA8SN",4,4,di.SNORM,!0,!1,!1,!1),new Kr("RGBA8UI",4,4,di.UINT,!0,!1,!1,!1),new Kr("RGBA8I",4,4,di.INT,!0,!1,!1,!1),new Kr("RGBA16F",8,4,di.FLOAT,!0,!1,!1,!1),new Kr("RGBA16UI",8,4,di.UINT,!0,!1,!1,!1),new Kr("RGBA16I",8,4,di.INT,!0,!1,!1,!1),new Kr("RGBA32F",16,4,di.FLOAT,!0,!1,!1,!1),new Kr("RGBA32UI",16,4,di.UINT,!0,!1,!1,!1),new Kr("RGBA32I",16,4,di.INT,!0,!1,!1,!1),new Kr("R5G6B5",2,3,di.UNORM,!1,!1,!1,!1),new Kr("R11G11B10F",4,3,di.FLOAT,!1,!1,!1,!1),new Kr("RGB5A1",2,4,di.UNORM,!0,!1,!1,!1),new Kr("RGBA4",2,4,di.UNORM,!0,!1,!1,!1),new Kr("RGB10A2",2,4,di.UNORM,!0,!1,!1,!1),new Kr("RGB10A2UI",2,4,di.UINT,!0,!1,!1,!1),new Kr("RGB9E5",2,4,di.FLOAT,!0,!1,!1,!1),new Kr("DEPTH",4,1,di.FLOAT,!1,!0,!1,!1),new Kr("DEPTH_STENCIL",5,2,di.FLOAT,!1,!0,!0,!1),new Kr("BC1",1,3,di.UNORM,!1,!1,!1,!0),new Kr("BC1_ALPHA",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC1_SRGB",1,3,di.UNORM,!1,!1,!1,!0),new Kr("BC1_SRGB_ALPHA",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC2",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC2_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC3",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC3_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC4",1,1,di.UNORM,!1,!1,!1,!0),new Kr("BC4_SNORM",1,1,di.SNORM,!1,!1,!1,!0),new Kr("BC5",1,2,di.UNORM,!1,!1,!1,!0),new Kr("BC5_SNORM",1,2,di.SNORM,!1,!1,!1,!0),new Kr("BC6H_UF16",1,3,di.UFLOAT,!1,!1,!1,!0),new Kr("BC6H_SF16",1,3,di.FLOAT,!1,!1,!1,!0),new Kr("BC7",1,4,di.UNORM,!0,!1,!1,!0),new Kr("BC7_SRGB",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ETC_RGB8",1,3,di.UNORM,!1,!1,!1,!0),new Kr("ETC2_RGB8",1,3,di.UNORM,!1,!1,!1,!0),new Kr("ETC2_SRGB8",1,3,di.UNORM,!1,!1,!1,!0),new Kr("ETC2_RGB8_A1",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ETC2_SRGB8_A1",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ETC2_RGBA8",2,4,di.UNORM,!0,!1,!1,!0),new Kr("ETC2_SRGB8_A8",2,4,di.UNORM,!0,!1,!1,!0),new Kr("EAC_R11",1,1,di.UNORM,!1,!1,!1,!0),new Kr("EAC_R11SN",1,1,di.SNORM,!1,!1,!1,!0),new Kr("EAC_RG11",2,2,di.UNORM,!1,!1,!1,!0),new Kr("EAC_RG11SN",2,2,di.SNORM,!1,!1,!1,!0),new Kr("PVRTC_RGB2",2,3,di.UNORM,!1,!1,!1,!0),new Kr("PVRTC_RGBA2",2,4,di.UNORM,!0,!1,!1,!0),new Kr("PVRTC_RGB4",2,3,di.UNORM,!1,!1,!1,!0),new Kr("PVRTC_RGBA4",2,4,di.UNORM,!0,!1,!1,!0),new Kr("PVRTC2_2BPP",2,4,di.UNORM,!0,!1,!1,!0),new Kr("PVRTC2_4BPP",2,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_4x4",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_5x4",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_5x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_6x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_6x6",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_8x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_8x6",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_8x8",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_10x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_10x6",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_10x8",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_10x10",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_12x10",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_RGBA_12x12",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_4x4",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_5x4",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_5x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_6x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_6x6",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_8x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_8x6",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_8x8",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_10x5",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_10x6",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_10x8",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_10x10",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_12x10",1,4,di.UNORM,!0,!1,!1,!0),new Kr("ASTC_SRGBA_12x12",1,4,di.UNORM,!0,!1,!1,!0)]),to=ji.UNIFORM_BUFFER|ji.DYNAMIC_UNIFORM_BUFFER|ji.STORAGE_BUFFER|ji.DYNAMIC_STORAGE_BUFFER,no=ji.SAMPLER_TEXTURE|ji.SAMPLER|ji.TEXTURE|ji.STORAGE_IMAGE|ji.INPUT_ATTACHMENT,io=ji.DYNAMIC_STORAGE_BUFFER|ji.DYNAMIC_UNIFORM_BUFFER,ro=28;function oo(e){return e>0&&0==(e&e-1)}function ao(e,t,n,i){if(!eo[e].isCompressed)return t*n*i*eo[e].size;switch(e){case pi.BC1:case pi.BC1_ALPHA:case pi.BC1_SRGB:case pi.BC1_SRGB_ALPHA:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case pi.BC2:case pi.BC2_SRGB:case pi.BC3:case pi.BC3_SRGB:case pi.BC4:case pi.BC4_SNORM:case pi.BC6H_SF16:case pi.BC6H_UF16:case pi.BC7:case pi.BC7_SRGB:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case pi.BC5:case pi.BC5_SNORM:return Math.ceil(t/4)*Math.ceil(n/4)*32*i;case pi.ETC_RGB8:case pi.ETC2_RGB8:case pi.ETC2_SRGB8:case pi.ETC2_RGB8_A1:case pi.EAC_R11:case pi.EAC_R11SN:return Math.ceil(t/4)*Math.ceil(n/4)*8*i;case pi.ETC2_RGBA8:case pi.ETC2_SRGB8_A1:case pi.EAC_RG11:case pi.EAC_RG11SN:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case pi.PVRTC_RGB2:case pi.PVRTC_RGBA2:case pi.PVRTC2_2BPP:return Math.ceil(Math.max(t,16)*Math.max(n,8)/4)*i;case pi.PVRTC_RGB4:case pi.PVRTC_RGBA4:case pi.PVRTC2_4BPP:return Math.ceil(Math.max(t,8)*Math.max(n,8)/2)*i;case pi.ASTC_RGBA_4X4:case pi.ASTC_SRGBA_4X4:return Math.ceil(t/4)*Math.ceil(n/4)*16*i;case pi.ASTC_RGBA_5X4:case pi.ASTC_SRGBA_5X4:return Math.ceil(t/5)*Math.ceil(n/4)*16*i;case pi.ASTC_RGBA_5X5:case pi.ASTC_SRGBA_5X5:return Math.ceil(t/5)*Math.ceil(n/5)*16*i;case pi.ASTC_RGBA_6X5:case pi.ASTC_SRGBA_6X5:return Math.ceil(t/6)*Math.ceil(n/5)*16*i;case pi.ASTC_RGBA_6X6:case pi.ASTC_SRGBA_6X6:return Math.ceil(t/6)*Math.ceil(n/6)*16*i;case pi.ASTC_RGBA_8X5:case pi.ASTC_SRGBA_8X5:return Math.ceil(t/8)*Math.ceil(n/5)*16*i;case pi.ASTC_RGBA_8X6:case pi.ASTC_SRGBA_8X6:return Math.ceil(t/8)*Math.ceil(n/6)*16*i;case pi.ASTC_RGBA_8X8:case pi.ASTC_SRGBA_8X8:return Math.ceil(t/8)*Math.ceil(n/8)*16*i;case pi.ASTC_RGBA_10X5:case pi.ASTC_SRGBA_10X5:return Math.ceil(t/10)*Math.ceil(n/5)*16*i;case pi.ASTC_RGBA_10X6:case pi.ASTC_SRGBA_10X6:return Math.ceil(t/10)*Math.ceil(n/6)*16*i;case pi.ASTC_RGBA_10X8:case pi.ASTC_SRGBA_10X8:return Math.ceil(t/10)*Math.ceil(n/8)*16*i;case pi.ASTC_RGBA_10X10:case pi.ASTC_SRGBA_10X10:return Math.ceil(t/10)*Math.ceil(n/10)*16*i;case pi.ASTC_RGBA_12X10:case pi.ASTC_SRGBA_12X10:return Math.ceil(t/12)*Math.ceil(n/10)*16*i;case pi.ASTC_RGBA_12X12:case pi.ASTC_SRGBA_12X12:return Math.ceil(t/12)*Math.ceil(n/12)*16*i;default:return 0}}function so(e,t,n,i,r){for(var o=0,a=0;a<r;++a)o+=ao(e,t,n,i),t=Math.max(t>>1,1),n=Math.max(n>>1,1);return o}var co=[0,4,8,12,16,4,8,12,16,4,8,12,16,4,8,12,16,16,24,32,24,36,48,32,48,64,4,4,4,4,4,4];function lo(e){return co[e]||0}function uo(e){var t=e.size/e.count;switch(e.type){case di.UNORM:case di.UINT:switch(t){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array}break;case di.SNORM:case di.INT:switch(t){case 1:return Int8Array;case 2:return Int16Array;case 4:return Int32Array}break;case di.FLOAT:return Float32Array}return Float32Array}var ho=Object.freeze({__proto__:null,get ObjectType(){return li},get Status(){return ui},get API(){return hi},get SurfaceTransform(){return fi},get Feature(){return _i},get Format(){return pi},get FormatType(){return di},get Type(){return mi},get BufferUsageBit(){return vi},get BufferFlagBit(){return gi},get MemoryAccessBit(){return yi},get MemoryUsageBit(){return xi},get TextureType(){return Si},get TextureUsageBit(){return Ti},get TextureFlagBit(){return bi},get SampleCount(){return Ei},get VsyncMode(){return Ci},get Filter(){return Ai},get Address(){return wi},get ComparisonFunc(){return Pi},get StencilOp(){return Ri},get BlendFactor(){return Ii},get BlendOp(){return Di},get ColorMask(){return Oi},get ShaderStageFlagBit(){return Mi},get LoadOp(){return Ni},get StoreOp(){return Li},get AccessType(){return Bi},get ResolveMode(){return Fi},get PipelineBindPoint(){return zi},get PrimitiveMode(){return Ui},get PolygonMode(){return ki},get ShadeModel(){return Gi},get CullMode(){return Hi},get DynamicStateFlagBit(){return Vi},get StencilFace(){return Wi},get DescriptorType(){return ji},get QueueType(){return qi},get QueryType(){return Xi},get CommandBufferType(){return Yi},get ClearFlagBit(){return Ki},Size:Ji,DeviceCaps:$i,Offset:er,Rect:tr,Extent:nr,TextureSubresLayers:ir,TextureSubresRange:rr,TextureCopy:or,TextureBlit:ar,BufferTextureCopy:sr,Viewport:cr,Color:lr,BindingMappingInfo:ur,SwapchainInfo:hr,DeviceInfo:fr,BufferInfo:_r,BufferViewInfo:pr,DrawInfo:dr,DispatchInfo:mr,IndirectBuffer:vr,TextureInfo:gr,TextureViewInfo:yr,SamplerInfo:xr,Uniform:Sr,UniformBlock:Tr,UniformSamplerTexture:br,UniformSampler:Er,UniformTexture:Cr,UniformStorageImage:Ar,UniformStorageBuffer:wr,UniformInputAttachment:Pr,ShaderStage:Rr,Attribute:Ir,ShaderInfo:Dr,InputAssemblerInfo:Or,ColorAttachment:Mr,DepthStencilAttachment:Nr,SubpassInfo:Lr,SubpassDependency:Br,RenderPassInfo:Fr,GlobalBarrierInfo:zr,TextureBarrierInfo:Ur,FramebufferInfo:kr,DescriptorSetLayoutBinding:Gr,DescriptorSetLayoutInfo:Hr,DescriptorSetInfo:Vr,PipelineLayoutInfo:Wr,InputState:jr,CommandBufferInfo:qr,QueueInfo:Xr,QueryPoolInfo:Yr,FormatInfo:Kr,MemoryStatus:Qr,DynamicStencilStates:Zr,DynamicStates:Jr,GFXObject:$r,get AttributeName(){return Zi},FormatInfos:eo,DESCRIPTOR_BUFFER_TYPE:to,DESCRIPTOR_SAMPLER_TYPE:no,DESCRIPTOR_DYNAMIC_TYPE:io,DRAW_INFO_SIZE:ro,IsPowerOf2:oo,FormatSize:ao,FormatSurfaceSize:so,GetTypeSize:lo,getTypedArrayConstructor:uo}),fo=function(e){function t(){var t;return(t=e.call(this,li.BUFFER)||this)._usage=vi.NONE,t._memUsage=xi.NONE,t._size=0,t._stride=1,t._count=0,t._flags=gi.NONE,t._isBufferView=!1,t}return $(t,e),Z(t,[{key:"usage",get:function(){return this._usage}},{key:"memUsage",get:function(){return this._memUsage}},{key:"size",get:function(){return this._size}},{key:"stride",get:function(){return this._stride}},{key:"count",get:function(){return this._count}},{key:"flags",get:function(){return this._flags}}]),t}($r),_o=function(e){function t(){var t;return(t=e.call(this,li.COMMAND_BUFFER)||this)._queue=null,t._type=Yi.PRIMARY,t._numDrawCalls=0,t._numInstances=0,t._numTris=0,t}return $(t,e),Z(t,[{key:"type",get:function(){return this._type}},{key:"queue",get:function(){return this._queue}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}}]),t}($r),po=function(){function e(){this._gfxAPI=hi.UNKNOWN,this._renderer="",this._vendor="",this._features=new Array(_i.COUNT),this._queue=null,this._cmdBuff=null,this._numDrawCalls=0,this._numInstances=0,this._numTris=0,this._memoryStatus=new Qr,this._caps=new $i,this._bindingMappingInfo=new ur,this._samplers=new Map,this._globalBarriers=new Map,this._textureBarriers=new Map}return e.prototype.hasFeature=function(e){return this._features[e]},Z(e,[{key:"gfxAPI",get:function(){return this._gfxAPI}},{key:"queue",get:function(){return this._queue}},{key:"commandBuffer",get:function(){return this._cmdBuff}},{key:"renderer",get:function(){return this._renderer}},{key:"vendor",get:function(){return this._vendor}},{key:"numDrawCalls",get:function(){return this._numDrawCalls}},{key:"numInstances",get:function(){return this._numInstances}},{key:"numTris",get:function(){return this._numTris}},{key:"memoryStatus",get:function(){return this._memoryStatus}},{key:"capabilities",get:function(){return this._caps}},{key:"bindingMappingInfo",get:function(){return this._bindingMappingInfo}}]),e}();po.canvas=void 0;var mo=function(e){function t(){var t;return(t=e.call(this,li.SWAPCHAIN)||this)._transform=fi.IDENTITY,t._colorTexture=null,t._depthStencilTexture=null,t}return $(t,e),Z(t,[{key:"colorTexture",get:function(){return this._colorTexture}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}},{key:"surfaceTransform",get:function(){return this._transform}},{key:"width",get:function(){return this._colorTexture.width}},{key:"height",get:function(){return this._colorTexture.height}}]),t}($r),vo=function(e){function t(){var t;return(t=e.call(this,li.FRAMEBUFFER)||this)._renderPass=null,t._colorTextures=[],t._depthStencilTexture=null,t}return $(t,e),Z(t,[{key:"renderPass",get:function(){return this._renderPass}},{key:"colorTextures",get:function(){return this._colorTextures}},{key:"depthStencilTexture",get:function(){return this._depthStencilTexture}}]),t}($r),go=String.prototype.charCodeAt;function yo(e){return this[e]}function xo(e,t){for(var n=e.length,i=t^n,r=0,o="string"==typeof e?go:yo;n>=4;){var a=255&o.call(e,r)|(255&o.call(e,++r))<<8|(255&o.call(e,++r))<<16|(255&o.call(e,++r))<<24;a=1540483477*(65535&a)+((1540483477*(a>>>16)&65535)<<16),i=1540483477*(65535&i)+((1540483477*(i>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),n-=4,++r}switch(n){case 3:i^=(255&o.call(e,r+2))<<16;case 2:i^=(255&o.call(e,r+1))<<8;case 1:i=1540483477*(65535&(i^=255&o.call(e,r)))+((1540483477*(i>>>16)&65535)<<16)}return i=1540483477*(65535&(i^=i>>>13))+((1540483477*(i>>>16)&65535)<<16),(i^=i>>>15)>>>0}var So=function(e){function t(){var t;return(t=e.call(this,li.INPUT_ASSEMBLER)||this)._attributes=[],t._attributesHash=0,t._vertexBuffers=[],t._indexBuffer=null,t._indirectBuffer=null,t._drawInfo=new dr,t}$(t,e);var n=t.prototype;return n.getVertexBuffer=function(e){return void 0===e&&(e=0),e<this._vertexBuffers.length?this._vertexBuffers[e]:null},n.computeAttributesHash=function(){for(var e="attrs",t=0;t<this.attributes.length;++t){var n=this.attributes[t];e+=","+n.name+","+n.format+","+n.isNormalized+","+n.stream+","+n.isInstanced}return xo(e,666)},Z(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"attributesHash",get:function(){return this._attributesHash}},{key:"vertexCount",get:function(){return this._drawInfo.vertexCount},set:function(e){this._drawInfo.vertexCount=e}},{key:"firstVertex",get:function(){return this._drawInfo.firstVertex},set:function(e){this._drawInfo.firstVertex=e}},{key:"indexCount",get:function(){return this._drawInfo.indexCount},set:function(e){this._drawInfo.indexCount=e}},{key:"firstIndex",get:function(){return this._drawInfo.firstIndex},set:function(e){this._drawInfo.firstIndex=e}},{key:"vertexOffset",get:function(){return this._drawInfo.vertexOffset},set:function(e){this._drawInfo.vertexOffset=e}},{key:"instanceCount",get:function(){return this._drawInfo.instanceCount},set:function(e){this._drawInfo.instanceCount=e}},{key:"firstInstance",get:function(){return this._drawInfo.firstInstance},set:function(e){this._drawInfo.firstInstance=e}},{key:"drawInfo",get:function(){return this._drawInfo}}]),t}($r),To=function(e){function t(){var t;return(t=e.call(this,li.DESCRIPTOR_SET)||this)._layout=null,t._buffers=[],t._textures=[],t._samplers=[],t._isDirty=!1,t}$(t,e);var n=t.prototype;return n.bindBuffer=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&to){var o=this._layout.descriptorIndices[e];this._buffers[o+n]!==t&&(this._buffers[o+n]=t,this._isDirty=!0)}},n.bindSampler=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&no){var o=this._layout.descriptorIndices[e];this._samplers[o+n]!==t&&(this._samplers[o+n]=t,this._isDirty=!0)}},n.bindTexture=function(e,t,n){void 0===n&&(n=0);var i=this._layout.bindingIndices[e],r=this._layout.bindings[i];if(r&&r.descriptorType&no){var o=this._layout.descriptorIndices[e];this._textures[o+n]!==t&&(this._textures[o+n]=t,this._isDirty=!0)}},n.getBuffer=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._buffers[n+t]},n.getSampler=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._samplers[n+t]},n.getTexture=function(e,t){void 0===t&&(t=0);var n=this._layout.descriptorIndices[e];return this._textures[n+t]},Z(t,[{key:"layout",get:function(){return this._layout}}]),t}($r),bo=function(e){function t(){var t;return(t=e.call(this,li.DESCRIPTOR_SET_LAYOUT)||this)._bindings=[],t._bindingIndices=[],t._descriptorIndices=[],t}return $(t,e),Z(t,[{key:"bindings",get:function(){return this._bindings}},{key:"bindingIndices",get:function(){return this._bindingIndices}},{key:"descriptorIndices",get:function(){return this._descriptorIndices}}]),t}($r),Eo=function(e){function t(){var t;return(t=e.call(this,li.PIPELINE_LAYOUT)||this)._setLayouts=[],t}return $(t,e),Z(t,[{key:"setLayouts",get:function(){return this._setLayouts}}]),t}($r),Co=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h){void 0===e&&(e=!1),void 0===t&&(t=ki.FILL),void 0===n&&(n=Gi.GOURAND),void 0===i&&(i=Hi.BACK),void 0===r&&(r=!0),void 0===o&&(o=!1),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=!0),void 0===u&&(u=!1),void 0===h&&(h=1),this.isDiscard=e,this.polygonMode=t,this.shadeModel=n,this.cullMode=i,this.isFrontFaceCCW=r,this.depthBiasEnabled=o,this.depthBias=a,this.depthBiasClamp=s,this.depthBiasSlop=c,this.isDepthClip=l,this.isMultisample=u,this.lineWidth=h}var t=e.prototype;return t.reset=function(){this.isDiscard=!1,this.polygonMode=ki.FILL,this.shadeModel=Gi.GOURAND,this.cullMode=Hi.BACK,this.isFrontFaceCCW=!0,this.depthBiasEnabled=!1,this.depthBias=0,this.depthBiasClamp=0,this.depthBiasSlop=0,this.isDepthClip=!0,this.isMultisample=!1,this.lineWidth=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},Z(e,[{key:"native",get:function(){return this}}]),e}(),Ao=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m,v,g){void 0===e&&(e=!0),void 0===t&&(t=!0),void 0===n&&(n=Pi.LESS),void 0===i&&(i=!1),void 0===r&&(r=Pi.ALWAYS),void 0===o&&(o=65535),void 0===a&&(a=65535),void 0===s&&(s=Ri.KEEP),void 0===c&&(c=Ri.KEEP),void 0===l&&(l=Ri.KEEP),void 0===u&&(u=1),void 0===h&&(h=!1),void 0===f&&(f=Pi.ALWAYS),void 0===_&&(_=65535),void 0===p&&(p=65535),void 0===d&&(d=Ri.KEEP),void 0===m&&(m=Ri.KEEP),void 0===v&&(v=Ri.KEEP),void 0===g&&(g=1),this.depthTest=e,this.depthWrite=t,this.depthFunc=n,this.stencilTestFront=i,this.stencilFuncFront=r,this.stencilReadMaskFront=o,this.stencilWriteMaskFront=a,this.stencilFailOpFront=s,this.stencilZFailOpFront=c,this.stencilPassOpFront=l,this.stencilRefFront=u,this.stencilTestBack=h,this.stencilFuncBack=f,this.stencilReadMaskBack=_,this.stencilWriteMaskBack=p,this.stencilFailOpBack=d,this.stencilZFailOpBack=m,this.stencilPassOpBack=v,this.stencilRefBack=g}var t=e.prototype;return t.reset=function(){this.depthTest=!0,this.depthWrite=!0,this.depthFunc=Pi.LESS,this.stencilTestFront=!1,this.stencilFuncFront=Pi.ALWAYS,this.stencilReadMaskFront=65535,this.stencilWriteMaskFront=65535,this.stencilFailOpFront=Ri.KEEP,this.stencilZFailOpFront=Ri.KEEP,this.stencilPassOpFront=Ri.KEEP,this.stencilRefFront=1,this.stencilTestBack=!1,this.stencilFuncBack=Pi.ALWAYS,this.stencilReadMaskBack=65535,this.stencilWriteMaskBack=65535,this.stencilFailOpBack=Ri.KEEP,this.stencilZFailOpBack=Ri.KEEP,this.stencilPassOpBack=Ri.KEEP,this.stencilRefBack=1},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},Z(e,[{key:"native",get:function(){return this}}]),e}(),wo=function(){function e(e,t,n,i,r,o,a,s){void 0===e&&(e=!1),void 0===t&&(t=Ii.ONE),void 0===n&&(n=Ii.ZERO),void 0===i&&(i=Di.ADD),void 0===r&&(r=Ii.ONE),void 0===o&&(o=Ii.ZERO),void 0===a&&(a=Di.ADD),void 0===s&&(s=Oi.ALL),this.blend=e,this.blendSrc=t,this.blendDst=n,this.blendEq=i,this.blendSrcAlpha=r,this.blendDstAlpha=o,this.blendAlphaEq=a,this.blendColorMask=s}var t=e.prototype;return t.reset=function(){this.blend=!1,this.blendSrc=Ii.ONE,this.blendDst=Ii.ZERO,this.blendEq=Di.ADD,this.blendSrcAlpha=Ii.ONE,this.blendDstAlpha=Ii.ZERO,this.blendAlphaEq=Di.ADD,this.blendColorMask=Oi.ALL},t.assign=function(e){Object.assign(this,e)},t.destroy=function(){},e}(),Po=function(){function e(e,t,n,i){void 0===e&&(e=!1),void 0===t&&(t=!1),void 0===n&&(n=new lr),void 0===i&&(i=[new wo]),this.isA2C=e,this.isIndepend=t,this.blendColor=n,this.targets=i}var t=e.prototype;return t.setTarget=function(e,t){var n=this.targets[e];n||(n=this.targets[e]=new wo),Object.assign(n,t)},t.reset=function(){this.isA2C=!1,this.isIndepend=!1,this.blendColor.x=0,this.blendColor.y=0,this.blendColor.z=0,this.blendColor.w=0,this.targets.length=1,this.targets[0].reset()},t.destroy=function(){},Z(e,[{key:"native",get:function(){return this}}]),e}(),Ro=function(e,t,n,i,r,o,a,s,c,l){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=new jr),void 0===r&&(r=new Co),void 0===o&&(o=new Ao),void 0===a&&(a=new Po),void 0===s&&(s=Ui.TRIANGLE_LIST),void 0===c&&(c=Vi.NONE),void 0===l&&(l=zi.GRAPHICS),this.shader=e,this.pipelineLayout=t,this.renderPass=n,this.inputState=i,this.rasterizerState=r,this.depthStencilState=o,this.blendState=a,this.primitive=s,this.dynamicStates=c,this.bindPoint=l},Io=function(e){function t(){var t;return(t=e.call(this,li.PIPELINE_STATE)||this)._shader=null,t._pipelineLayout=null,t._primitive=Ui.TRIANGLE_LIST,t._is=null,t._rs=new Co,t._dss=new Ao,t._bs=new Po,t._dynamicStates=Vi.NONE,t._renderPass=null,t}return $(t,e),Z(t,[{key:"shader",get:function(){return this._shader}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}},{key:"primitive",get:function(){return this._primitive}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"inputState",get:function(){return this._is}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"renderPass",get:function(){return this._renderPass}}]),t}($r),Do=function(e){function t(){var t;return(t=e.call(this,li.QUEUE)||this)._type=qi.GRAPHICS,t}return $(t,e),Z(t,[{key:"type",get:function(){return this._type}}]),t}($r),Oo=function(e){function t(){var t;return(t=e.call(this,li.RENDER_PASS)||this)._colorInfos=[],t._depthStencilInfo=null,t._subpasses=[],t._hash=0,t}return $(t,e),t.prototype.computeHash=function(){var e="";if(this._subpasses.length)for(var t=0;t<this._subpasses.length;++t){var n=this._subpasses[t];if(n.inputs.length){e+="ia";for(var i=0;i<n.inputs.length;++i){var r=this._colorInfos[n.inputs[i]];e+=","+r.format+","+r.sampleCount}}if(n.colors.length){e+="ca";for(var o=0;o<n.inputs.length;++o){var a=this._colorInfos[n.inputs[o]];e+=","+a.format+","+a.sampleCount}}if(n.depthStencil>=0){var s=this._colorInfos[n.depthStencil];e+="ds,"+s.format+","+s.sampleCount}}else{e+="ca";for(var c=0;c<this._colorInfos.length;++c){var l=this._colorInfos[c];e+=","+l.format+","+l.sampleCount}var u=this._depthStencilInfo;u&&(e+="ds,"+u.format+","+u.sampleCount)}return xo(e,666)},Z(t,[{key:"colorAttachments",get:function(){return this._colorInfos}},{key:"depthStencilAttachment",get:function(){return this._depthStencilInfo}},{key:"subPasses",get:function(){return this._subpasses}},{key:"hash",get:function(){return this._hash}}]),t}($r),Mo=function(e){function t(t,n){var i;return(i=e.call(this,li.SAMPLER)||this)._info=new xr,i._hash=0,i._info.copy(t),i._hash=n,i}return $(t,e),t.computeHash=function(e){var t=e.minFilter;return t|=e.magFilter<<2,t|=e.mipFilter<<4,t|=e.addressU<<6,t|=e.addressV<<8,t|=e.addressW<<10,(t|=e.maxAnisotropy<<12)|e.cmpFunc<<16},t.unpackFromHash=function(e){var t=new xr;return t.minFilter=(3&e)>>0,t.magFilter=(3&e)>>2,t.mipFilter=(3&e)>>4,t.addressU=(3&e)>>6,t.addressV=(3&e)>>8,t.addressW=(3&e)>>10,t.maxAnisotropy=(15&e)>>12,t.cmpFunc=(7&e)>>16,t},Z(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}($r),No=function(e){function t(){var t;return(t=e.call(this,li.SHADER)||this)._name="",t._stages=[],t._attributes=[],t._blocks=[],t._samplers=[],t}return $(t,e),Z(t,[{key:"name",get:function(){return this._name}},{key:"attributes",get:function(){return this._attributes}},{key:"blocks",get:function(){return this._blocks}},{key:"samplers",get:function(){return this._samplers}}]),t}($r),Lo=function(e){function t(){var t;return(t=e.call(this,li.TEXTURE)||this)._type=Si.TEX2D,t._usage=Ti.NONE,t._format=pi.UNKNOWN,t._width=0,t._height=0,t._depth=1,t._layerCount=1,t._levelCount=1,t._samples=Ei.ONE,t._flags=bi.NONE,t._isPowerOf2=!1,t._size=0,t}return $(t,e),Z(t,[{key:"type",get:function(){return this._type}},{key:"usage",get:function(){return this._usage}},{key:"format",get:function(){return this._format}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"depth",get:function(){return this._depth}},{key:"layerCount",get:function(){return this._layerCount}},{key:"levelCount",get:function(){return this._levelCount}},{key:"samples",get:function(){return this._samples}},{key:"flags",get:function(){return this._flags}},{key:"size",get:function(){return this._size}}]),t}($r),Bo=function(e){function t(t,n){var i;return(i=e.call(this,li.GLOBAL_BARRIER)||this)._info=new zr,i._hash=0,i._info.copy(t),i._hash=n,i}return $(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return xo(t,666)},Z(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}($r),Fo=function(e){function t(t,n){var i;return(i=e.call(this,li.TEXTURE_BARRIER)||this)._info=new Ur,i._hash=0,i._info.copy(t),i._hash=n,i}return $(t,e),t.computeHash=function(e){for(var t="prev:",n=0;n<e.prevAccesses.length;++n)t+=" "+e.prevAccesses[n];t+="next:";for(var i=0;i<e.nextAccesses.length;++i)t+=" "+e.nextAccesses[i];return t+=e.discardContents,t+=e.srcQueue?e.srcQueue.type:0,xo(t+=e.dstQueue?e.dstQueue.type:0,666)},Z(t,[{key:"info",get:function(){return this._info}},{key:"hash",get:function(){return this._hash}}]),t}($r),zo={Device:po,Swapchain:mo,Buffer:fo,Texture:Lo,Sampler:Mo,Shader:No,InputAssembler:So,RenderPass:Oo,Framebuffer:vo,DescriptorSet:To,DescriptorSetLayout:bo,PipelineLayout:Eo,PipelineState:Io,CommandBuffer:_o,Queue:Do,GlobalBarrier:Bo,TextureBarrier:Fo,RasterizerState:Co,BlendState:Po,BlendTarget:wo,DepthStencilState:Ao,PipelineStateInfo:Ro};Object.assign(zo,ho),u.gfx=zo;var Uo={Obj:"GFXObject",DRAW_INFO_SIZE:"GFX_DRAW_INFO_SIZE",DESCRIPTOR_BUFFER_TYPE:"",DESCRIPTOR_SAMPLER_TYPE:"",DESCRIPTOR_DYNAMIC_TYPE:"",getTypedArrayConstructor:""};for(var ko in u.gfx)if("__esModule"!==ko){var Go=Uo[ko];""===Go?Go=ko:void 0===Go&&(Go="GFX"+ko),k(u,"cc",[{name:Go,newName:ko,target:u.gfx,targetName:"cc.gfx"}])}e("gfx",Object.freeze({__proto__:null,DescriptorSet:To,Buffer:fo,CommandBuffer:_o,get ObjectType(){return li},get Status(){return ui},get API(){return hi},get SurfaceTransform(){return fi},get Feature(){return _i},get Format(){return pi},get FormatType(){return di},get Type(){return mi},get BufferUsageBit(){return vi},get BufferFlagBit(){return gi},get MemoryAccessBit(){return yi},get MemoryUsageBit(){return xi},get TextureType(){return Si},get TextureUsageBit(){return Ti},get TextureFlagBit(){return bi},get SampleCount(){return Ei},get VsyncMode(){return Ci},get Filter(){return Ai},get Address(){return wi},get ComparisonFunc(){return Pi},get StencilOp(){return Ri},get BlendFactor(){return Ii},get BlendOp(){return Di},get ColorMask(){return Oi},get ShaderStageFlagBit(){return Mi},get LoadOp(){return Ni},get StoreOp(){return Li},get AccessType(){return Bi},get ResolveMode(){return Fi},get PipelineBindPoint(){return zi},get PrimitiveMode(){return Ui},get PolygonMode(){return ki},get ShadeModel(){return Gi},get CullMode(){return Hi},get DynamicStateFlagBit(){return Vi},get StencilFace(){return Wi},get DescriptorType(){return ji},get QueueType(){return qi},get QueryType(){return Xi},get CommandBufferType(){return Yi},get ClearFlagBit(){return Ki},Size:Ji,DeviceCaps:$i,Offset:er,Rect:tr,Extent:nr,TextureSubresLayers:ir,TextureSubresRange:rr,TextureCopy:or,TextureBlit:ar,BufferTextureCopy:sr,Viewport:cr,Color:lr,BindingMappingInfo:ur,SwapchainInfo:hr,DeviceInfo:fr,BufferInfo:_r,BufferViewInfo:pr,DrawInfo:dr,DispatchInfo:mr,IndirectBuffer:vr,TextureInfo:gr,TextureViewInfo:yr,SamplerInfo:xr,Uniform:Sr,UniformBlock:Tr,UniformSamplerTexture:br,UniformSampler:Er,UniformTexture:Cr,UniformStorageImage:Ar,UniformStorageBuffer:wr,UniformInputAttachment:Pr,ShaderStage:Rr,Attribute:Ir,ShaderInfo:Dr,InputAssemblerInfo:Or,ColorAttachment:Mr,DepthStencilAttachment:Nr,SubpassInfo:Lr,SubpassDependency:Br,RenderPassInfo:Fr,GlobalBarrierInfo:zr,TextureBarrierInfo:Ur,FramebufferInfo:kr,DescriptorSetLayoutBinding:Gr,DescriptorSetLayoutInfo:Hr,DescriptorSetInfo:Vr,PipelineLayoutInfo:Wr,InputState:jr,CommandBufferInfo:qr,QueueInfo:Xr,QueryPoolInfo:Yr,FormatInfo:Kr,MemoryStatus:Qr,DynamicStencilStates:Zr,DynamicStates:Jr,GFXObject:$r,get AttributeName(){return Zi},FormatInfos:eo,DESCRIPTOR_BUFFER_TYPE:to,DESCRIPTOR_SAMPLER_TYPE:no,DESCRIPTOR_DYNAMIC_TYPE:io,DRAW_INFO_SIZE:ro,IsPowerOf2:oo,FormatSize:ao,FormatSurfaceSize:so,GetTypeSize:lo,getTypedArrayConstructor:uo,Device:po,Swapchain:mo,Framebuffer:vo,InputAssembler:So,DescriptorSetLayout:bo,PipelineLayout:Eo,RasterizerState:Co,DepthStencilState:Ao,BlendTarget:wo,BlendState:Po,PipelineStateInfo:Ro,PipelineState:Io,Queue:Do,RenderPass:Oo,Sampler:Mo,Shader:No,Texture:Lo,GlobalBarrier:Bo,TextureBarrier:Fo}));var Ho=new In,Vo=new In,Wo=new In,jo=new In,qo=new In,Xo=new In,Yo=new Array(3),Ko=new Array(3);function Qo(e,t){return In.dot(t.n,e)-t.d}function Zo(e,t,n){return In.copy(e,t),In.subtract(qo,n.center,n.halfExtents),In.add(Xo,n.center,n.halfExtents),e.x=e.x<qo.x?qo.x:e.x,e.y=e.y<qo.y?qo.y:e.y,e.z=e.z<qo.z?qo.z:e.z,e.x=e.x>Xo.x?Xo.x:e.x,e.y=e.y>Xo.y?Xo.y:e.y,e.z=e.z>Xo.z?Xo.z:e.z,e}function Jo(e,t,n){In.set(Ho,n.orientation.m00,n.orientation.m01,n.orientation.m02),In.set(Vo,n.orientation.m03,n.orientation.m04,n.orientation.m05),In.set(Wo,n.orientation.m06,n.orientation.m07,n.orientation.m08),Yo[0]=Ho,Yo[1]=Vo,Yo[2]=Wo,Ko[0]=n.halfExtents.x,Ko[1]=n.halfExtents.y,Ko[2]=n.halfExtents.z,In.subtract(jo,t,n.center),In.set(e,n.center.x,n.center.y,n.center.z);for(var i=0;i<3;i++){var r=In.dot(jo,Yo[i]);r>Ko[i]&&(r=Ko[i]),r<-Ko[i]&&(r=-Ko[i]),e.x+=r*Yo[i].x,e.y+=r*Yo[i].y,e.z+=r*Yo[i].z}return e}var $o=Object.freeze({__proto__:null,point_plane:Qo,pt_point_plane:function(e,t,n){var i=Qo(t,n);return In.subtract(e,t,In.multiplyScalar(e,n.n,i))},pt_point_aabb:Zo,pt_point_obb:Jo,pt_point_line:function(e,t,n,i){In.subtract(Ho,n,i);var r=Ho,o=In.lengthSqr(r);if(0==o)In.copy(e,n);else{In.subtract(Ho,t,n);var a=In.dot(Ho,r)/o;a<0?In.copy(e,n):a>1?In.copy(e,i):In.scaleAndAdd(e,n,r,a)}}}),ea={SHAPE_RAY:1,SHAPE_LINE:2,SHAPE_SPHERE:4,SHAPE_AABB:8,SHAPE_OBB:16,SHAPE_PLANE:32,SHAPE_TRIANGLE:64,SHAPE_FRUSTUM:128,SHAPE_FRUSTUM_ACCURATE:256,SHAPE_CAPSULE:512},ta=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.s=void 0,this.e=void 0,this._type=void 0,this._type=ea.SHAPE_LINE,this.s=new In(e,t,n),this.e=new In(i,r,o)}return e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.s.x,t.s.y,t.s.z,t.e.x,t.e.y,t.e.z)},e.copy=function(e,t){return In.copy(e.s,t.s),In.copy(e.e,t.e),e},e.fromPoints=function(e,t,n){return In.copy(e.s,t),In.copy(e.e,n),e},e.set=function(e,t,n,i,r,o,a){return e.s.x=t,e.s.y=n,e.s.z=i,e.e.x=r,e.e.y=o,e.e.z=a,e},e.len=function(e){return In.distance(e.s,e.e)},e.prototype.length=function(){return In.distance(this.s,this.e)},Z(e,[{key:"type",get:function(){return this._type}}]),e}(),na=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=-1),this.o=void 0,this.d=void 0,this._type=void 0,this._type=ea.SHAPE_RAY,this.o=new In(e,t,n),this.d=new In(i,r,o)}return e.create=function(t,n,i,r,o,a){return void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=1),new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.o.x,t.o.y,t.o.z,t.d.x,t.d.y,t.d.z)},e.copy=function(e,t){return In.copy(e.o,t.o),In.copy(e.d,t.d),e},e.fromPoints=function(e,t,n){return In.copy(e.o,t),In.normalize(e.d,In.subtract(e.d,n,t)),e},e.set=function(e,t,n,i,r,o,a){return e.o.x=t,e.o.y=n,e.o.z=i,e.d.x=r,e.d.y=o,e.d.z=a,e},e.prototype.computeHit=function(e,t){In.normalize(e,this.d),In.scaleAndAdd(e,this.o,e,t)},Z(e,[{key:"type",get:function(){return this._type}}]),e}(),ia=new In,ra=new In,oa=new In,aa=new In;function sa(e){return Math.max(Math.max(e.x,e.y),e.z)}var ca,la=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),this._center=new In(0,0,0),this._radius=0,this._type=void 0,this._type=ea.SHAPE_SPHERE,this._center=new In(e,t,n),this._radius=i}e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.radius)},e.copy=function(e,t){return In.copy(e.center,t.center),e.radius=t.radius,e},e.fromPoints=function(e,t,n){return In.multiplyScalar(e.center,In.add(ia,t,n),.5),e.radius=.5*In.subtract(ia,n,t).length(),e},e.set=function(e,t,n,i,r){return e.center.x=t,e.center.y=n,e.center.z=i,e.radius=r,e};var t=e.prototype;return t.destroy=function(){},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.getBoundary=function(e,t){In.set(e,this.center.x-this.radius,this.center.y-this.radius,this.center.z-this.radius),In.set(t,this.center.x+this.radius,this.center.y+this.radius,this.center.z+this.radius)},t.transform=function(e,t,n,i,r){In.transformMat4(r.center,this.center,e),r.radius=this.radius*sa(i)},t.translateAndRotate=function(e,t,n){In.transformMat4(n.center,this.center,e)},t.setScale=function(e,t){t.radius=this.radius*sa(e)},t.mergePoint=function(e){this.radius<0&&(this.center.set(e),this.radius=0),In.subtract(ra,e,this.center);var t=ra.length();if(t>this.radius){var n=.5*(t-this.radius);this.radius+=n,In.multiplyScalar(ra,ra,n/t),In.add(this.center,this.center,ra)}},t.mergePoints=function(e){var t=e.length;if(!(t<1)){this.radius=-1;for(var n=0;n<t;n++)this.mergePoint(e[n])}},t.mergeAABB=function(e){e.getBoundary(oa,aa),this.mergePoint(oa),this.mergePoint(aa)},Z(e,[{key:"center",get:function(){return this._center},set:function(e){this._center=e}},{key:"radius",get:function(){return this._radius},set:function(e){this._radius=e}},{key:"type",get:function(){return this._type}}]),e}(),ua=function(){function e(e,t,n,i,r,o,a,s,c){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=1),void 0===c&&(c=0),this.a=void 0,this.b=void 0,this.c=void 0,this._type=void 0,this._type=ea.SHAPE_TRIANGLE,this.a=new In(e,t,n),this.b=new In(i,r,o),this.c=new In(a,s,c)}return e.create=function(t,n,i,r,o,a,s,c,l){return void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),void 0===r&&(r=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=1),new e(t,n,i,r,o,a,s,c,l)},e.clone=function(t){return new e(t.a.x,t.a.y,t.a.z,t.b.x,t.b.y,t.b.z,t.c.x,t.c.y,t.c.z)},e.copy=function(e,t){return In.copy(e.a,t.a),In.copy(e.b,t.b),In.copy(e.c,t.c),e},e.fromPoints=function(e,t,n,i){return In.copy(e.a,t),In.copy(e.b,n),In.copy(e.c,i),e},e.set=function(e,t,n,i,r,o,a,s,c,l){return e.a.x=t,e.a.y=n,e.a.z=i,e.b.x=r,e.b.y=o,e.b.z=a,e.c.x=s,e.c.y=c,e.c.z=l,e},Z(e,[{key:"type",get:function(){return this._type}}]),e}();!function(e){e[e.ALL=0]="ALL",e[e.CLOSEST=1]="CLOSEST",e[e.ANY=2]="ANY"}(ca||(ca={}));var ha,fa,_a,pa,da,ma,va,ga,ya=(ha=new In(0,0,0),function(e,t){var n=In.dot(e.d,t.n);if(Math.abs(n)<Number.EPSILON)return 0;In.multiplyScalar(ha,t.n,t.d);var i=In.dot(In.subtract(ha,ha,e.o),t.n)/n;return i<0?0:i}),xa=(fa=new In(0,0,0),_a=new In(0,0,0),pa=new In(0,0,0),da=new In(0,0,0),ma=new In(0,0,0),function(e,t,n){In.subtract(fa,t.b,t.a),In.subtract(_a,t.c,t.a),In.cross(pa,e.d,_a);var i=In.dot(fa,pa);if(i<Number.EPSILON&&(!n||i>-Number.EPSILON))return 0;var r=1/i;In.subtract(da,e.o,t.a);var o=In.dot(da,pa)*r;if(o<0||o>1)return 0;In.cross(ma,da,fa);var a=In.dot(e.d,ma)*r;if(a<0||o+a>1)return 0;var s=In.dot(_a,ma)*r;return s<0?0:s}),Sa=function(){var e=new In(0,0,0);return function(t,n){var i=n.radius,r=n.center,o=t.o,a=t.d,s=i*i;In.subtract(e,r,o);var c=e.lengthSqr(),l=In.dot(e,a),u=s-(c-l*l);if(u<0)return 0;var h=Math.sqrt(u),f=c<s?l+h:l-h;return f<0?0:f}}(),Ta=(va=new In,ga=new In,function(e,t){return In.subtract(va,t.center,t.halfExtents),In.add(ga,t.center,t.halfExtents),ba(e,va,ga)});function ba(e,t,n){var i=e.o,r=e.d,o=1/r.x,a=1/r.y,s=1/r.z,c=(t.x-i.x)*o,l=(n.x-i.x)*o,u=(t.y-i.y)*a,h=(n.y-i.y)*a,f=(t.z-i.z)*s,_=(n.z-i.z)*s,p=Math.max(Math.max(Math.min(c,l),Math.min(u,h)),Math.min(f,_)),d=Math.min(Math.min(Math.max(c,l),Math.max(u,h)),Math.max(f,_));return d<0||p>d?0:p>0?p:d}var Ea,Ca,Aa,wa,Pa=function(){var e=new In,t=new In,n=new In,i=new In,r=new In,o=new In,a=new In,s=new Array(3),c=new Array(3),l=new Array(3),u=new Array(6);return function(h,f){s[0]=f.halfExtents.x,s[1]=f.halfExtents.y,s[2]=f.halfExtents.z,e=f.center,t=h.o,n=h.d,In.set(i,f.orientation.m00,f.orientation.m01,f.orientation.m02),In.set(r,f.orientation.m03,f.orientation.m04,f.orientation.m05),In.set(o,f.orientation.m06,f.orientation.m07,f.orientation.m08),In.subtract(a,e,t),c[0]=In.dot(i,n),c[1]=In.dot(r,n),c[2]=In.dot(o,n),l[0]=In.dot(i,a),l[1]=In.dot(r,a),l[2]=In.dot(o,a);for(var _=0;_<3;++_){if(0===c[_]){if(-l[_]-s[_]>0||-l[_]+s[_]<0)return 0;c[_]=1e-7}u[2*_+0]=(l[_]+s[_])/c[_],u[2*_+1]=(l[_]-s[_])/c[_]}var p=Math.max(Math.max(Math.min(u[0],u[1]),Math.min(u[2],u[3])),Math.min(u[4],u[5])),d=Math.min(Math.min(Math.max(u[0],u[1]),Math.max(u[2],u[3])),Math.max(u[4],u[5]));return d<0||p>d?0:p>0?p:d}}(),Ra=function(){var e=new In,t=new In,n=new In,i=new In,r=new In,o=new In,a=new In,s=new la;return function(c,l){var u=l.radius*l.radius,h=In.normalize(e,c.d),f=l.ellipseCenter0,_=l.ellipseCenter1,p=In.subtract(t,_,f);if(p.equals(In.ZERO))return s.radius=l.radius,s.center.set(l.ellipseCenter0),_s.raySphere(c,s);var d=c.o,m=In.subtract(n,d,f),v=In.cross(i,h,p),g=v.lengthSqr();if(0===g){s.radius=l.radius;var y=In.subtract(r,_,d);return m.lengthSqr()<y.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),_s.raySphere(c,s)}var x=In.cross(r,m,p),S=p.lengthSqr(),T=2*In.dot(v,x),b=T*T-4*g*(x.lengthSqr()-u*S);if(b<0)return 0;var E=(-T-Math.sqrt(b))/(2*g);if(E<0){s.radius=l.radius;var C=In.subtract(o,_,d);return m.lengthSqr()<C.lengthSqr()?s.center.set(l.ellipseCenter0):s.center.set(l.ellipseCenter1),_s.raySphere(c,s)}var A=In.scaleAndAdd(o,c.o,h,E),w=In.subtract(a,A,f),P=In.dot(w,p)/S;return P>=0&&P<=1?E:P<0?(s.radius=l.radius,s.center.set(l.ellipseCenter0),_s.raySphere(c,s)):P>1?(s.radius=l.radius,s.center.set(l.ellipseCenter1),_s.raySphere(c,s)):0}}(),Ia=(Ea=ua.create(),Ca={distance:1/0,doubleSided:!1,mode:ca.ANY},Aa=0,wa=function(e,t,n,i,r,o){e===ca.CLOSEST?(Aa>t||0===Aa)&&(Aa=t,o&&(0===o.length?o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}):(o[0].distance=t,o[0].vertexIndex0=n/3,o[0].vertexIndex1=i/3,o[0].vertexIndex2=r/3))):(Aa=t,o&&o.push({distance:t,vertexIndex0:n/3,vertexIndex1:i/3,vertexIndex2:r/3}))},function(e,t,n){if(Aa=0,0===t.geometricInfo.positions.length)return Aa;var i=void 0===n?Ca:n;if(ba(e,t.geometricInfo.boundingBox.min,t.geometricInfo.boundingBox.max)){var r=t.primitiveMode,o=t.geometricInfo;!function(e,t,n,i,r){if(n===Ui.TRIANGLE_LIST)for(var o=t.length,a=0;a<o;a+=3){var s=3*t[a],c=3*t[a+1],l=3*t[a+2];In.set(Ea.a,e[s],e[s+1],e[s+2]),In.set(Ea.b,e[c],e[c+1],e[c+2]),In.set(Ea.c,e[l],e[l+1],e[l+2]);var u=_s.rayTriangle(i,Ea,r.doubleSided);if(!(0===u||u>r.distance)&&(wa(r.mode,u,s,c,l,r.result),r.mode===ca.ANY))return u}else if(n===Ui.TRIANGLE_STRIP)for(var h=t.length-2,f=0,_=0;_<h;_+=1){var p=3*t[_-f],d=3*t[_+f+1],m=3*t[_+2];In.set(Ea.a,e[p],e[p+1],e[p+2]),In.set(Ea.b,e[d],e[d+1],e[d+2]),In.set(Ea.c,e[m],e[m+1],e[m+2]),f=~f;var v=_s.rayTriangle(i,Ea,r.doubleSided);if(!(0===v||v>r.distance)&&(wa(r.mode,v,p,d,m,r.result),r.mode===ca.ANY))return v}else if(n===Ui.TRIANGLE_FAN){var g=t.length-1,y=3*t[0];In.set(Ea.a,e[y],e[y+1],e[y+2]);for(var x=1;x<g;x+=1){var S=3*t[x],T=3*t[x+1];In.set(Ea.b,e[S],e[S+1],e[S+2]),In.set(Ea.c,e[T],e[T+1],e[T+2]);var b=_s.rayTriangle(i,Ea,r.doubleSided);if(!(0===b||b>r.distance)&&(wa(r.mode,b,y,S,T,r.result),r.mode===ca.ANY))return b}}}(o.positions,o.indices,r,e,i)}return Aa}),Da=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:ca.ANY};return function(n,i,r){e=0;var o=void 0===r?t:r,a=i.renderingSubMeshes.length,s=i.struct.minPosition,c=i.struct.maxPosition;if(s&&c&&!ba(n,s,c))return e;for(var l=0;l<a;l++){var u=i.renderingSubMeshes[l],h=Ia(n,u,o);if(h)if(o.mode===ca.CLOSEST)(0===e||e>h)&&(e=h,o.subIndices&&(o.subIndices[0]=l));else if(e=h,o.subIndices&&o.subIndices.push(l),o.mode===ca.ANY)return h}return e&&o.mode===ca.CLOSEST&&(o.result&&(o.result[0].distance=e,o.result.length=1),o.subIndices&&(o.subIndices.length=1)),e}}(),Oa=function(){var e=0,t={distance:1/0,doubleSided:!1,mode:ca.ANY},n=new na,i=new jn;return function(r,o,a){e=0;var s=void 0===a?t:a,c=o.worldBounds;if(c&&!Ta(r,c))return e;na.copy(n,r),o.node&&(jn.invert(i,o.node.getWorldMatrix(i)),In.transformMat4(n.o,r.o,i),In.transformMat4Normal(n.d,r.d,i));for(var l=o.subModels,u=0;u<l.length;u++){var h=l[u].subMesh,f=Ia(n,h,s);if(f)if(s.mode===ca.CLOSEST)(0===e||e>f)&&(e=f,s.subIndices&&(s.subIndices[0]=u));else if(e=f,s.subIndices&&s.subIndices.push(u),s.mode===ca.ANY)return f}return e&&s.mode===ca.CLOSEST&&(s.result&&(s.result[0].distance=e,s.result.length=1),s.subIndices&&(s.subIndices.length=1)),e}}(),Ma=function(){var e=new In(0,0,0);return function(t,n){In.subtract(e,t.e,t.s);var i=(n.d-In.dot(t.s,n.n))/In.dot(e,n.n);return i<0||i>1?0:i}}(),Na=function(){var e=new In(0,0,0),t=new In(0,0,0),n=new In(0,0,0),i=new In(0,0,0),r=new In(0,0,0),o=new In(0,0,0);return function(a,s,c){In.subtract(e,s.b,s.a),In.subtract(t,s.c,s.a),In.subtract(n,a.s,a.e),In.cross(r,e,t);var l=In.dot(n,r);if(l<=0)return 0;In.subtract(i,a.s,s.a);var u=In.dot(i,r);if(u<0||u>l)return 0;In.cross(o,n,i);var h=In.dot(t,o);if(h<0||h>l)return 0;var f=-In.dot(e,o);if(f<0||h+f>l)return 0;if(c){var _=1/l,p=1-(h*=_)-(f*=_);In.set(c,s.a.x*p+s.b.x*h+s.c.x*f,s.a.y*p+s.b.y*h+s.c.y*f,s.a.z*p+s.b.z*h+s.c.z*f)}return 1}}(),La=new na;function Ba(e,t){La.o.set(e.s),In.subtract(La.d,e.e,e.s),La.d.normalize();var n=Ta(La,t);return n<=e.length()?n:0}function Fa(e,t){La.o.set(e.s),In.subtract(La.d,e.e,e.s),La.d.normalize();var n=Pa(La,t);return n<=e.length()?n:0}function za(e,t){La.o.set(e.s),In.subtract(La.d,e.e,e.s),La.d.normalize();var n=Sa(La,t);return n<=e.length()?n:0}var Ua,ka,Ga,Ha,Va=(Ua=new In,ka=new In,Ga=new In,Ha=new In,function(e,t){return In.subtract(Ua,e.center,e.halfExtents),In.add(ka,e.center,e.halfExtents),In.subtract(Ga,t.center,t.halfExtents),In.add(Ha,t.center,t.halfExtents),Ua.x<=Ha.x&&ka.x>=Ga.x&&Ua.y<=Ha.y&&ka.y>=Ga.y&&Ua.z<=Ha.z&&ka.z>=Ga.z});function Wa(e,t,n,i,r,o){In.set(o[0],e.x+n.x*t.x+i.x*t.y+r.x*t.z,e.y+n.y*t.x+i.y*t.y+r.y*t.z,e.z+n.z*t.x+i.z*t.y+r.z*t.z),In.set(o[1],e.x-n.x*t.x+i.x*t.y+r.x*t.z,e.y-n.y*t.x+i.y*t.y+r.y*t.z,e.z-n.z*t.x+i.z*t.y+r.z*t.z),In.set(o[2],e.x+n.x*t.x-i.x*t.y+r.x*t.z,e.y+n.y*t.x-i.y*t.y+r.y*t.z,e.z+n.z*t.x-i.z*t.y+r.z*t.z),In.set(o[3],e.x+n.x*t.x+i.x*t.y-r.x*t.z,e.y+n.y*t.x+i.y*t.y-r.y*t.z,e.z+n.z*t.x+i.z*t.y-r.z*t.z),In.set(o[4],e.x-n.x*t.x-i.x*t.y-r.x*t.z,e.y-n.y*t.x-i.y*t.y-r.y*t.z,e.z-n.z*t.x-i.z*t.y-r.z*t.z),In.set(o[5],e.x+n.x*t.x-i.x*t.y-r.x*t.z,e.y+n.y*t.x-i.y*t.y-r.y*t.z,e.z+n.z*t.x-i.z*t.y-r.z*t.z),In.set(o[6],e.x-n.x*t.x+i.x*t.y-r.x*t.z,e.y-n.y*t.x+i.y*t.y-r.y*t.z,e.z-n.z*t.x+i.z*t.y-r.z*t.z),In.set(o[7],e.x-n.x*t.x-i.x*t.y+r.x*t.z,e.y-n.y*t.x-i.y*t.y+r.y*t.z,e.z-n.z*t.x-i.z*t.y+r.z*t.z)}function ja(e,t){for(var n=In.dot(t,e[0]),i=n,r=1;r<8;++r){var o=In.dot(t,e[r]);n=o<n?o:n,i=o>i?o:i}return[n,i]}var qa,Xa,Ya,Ka=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new In(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new In(0,0,0),i[r]=new In(0,0,0);var o=new In,a=new In;return function(t,r){In.set(e[0],1,0,0),In.set(e[1],0,1,0),In.set(e[2],0,0,1),In.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),In.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),In.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var s=0;s<3;++s)In.cross(e[6+3*s],e[s],e[3]),In.cross(e[7+3*s],e[s],e[4]),In.cross(e[7+3*s],e[s],e[5]);In.subtract(o,t.center,t.halfExtents),In.add(a,t.center,t.halfExtents),function(e,t,n){In.set(n[0],e.x,t.y,t.z),In.set(n[1],e.x,t.y,e.z),In.set(n[2],e.x,e.y,t.z),In.set(n[3],e.x,e.y,e.z),In.set(n[4],t.x,t.y,t.z),In.set(n[5],t.x,t.y,e.z),In.set(n[6],t.x,e.y,t.z),In.set(n[7],t.x,e.y,e.z)}(o,a,n),Wa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var c=0;c<15;++c){var l=ja(n,e[c]),u=ja(i,e[c]);if(u[0]>l[1]||l[0]>u[1])return 0}return 1}}(),Qa=function(e,t){var n=e.halfExtents.x*Math.abs(t.n.x)+e.halfExtents.y*Math.abs(t.n.y)+e.halfExtents.z*Math.abs(t.n.z),i=In.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1},Za=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===Qa(e,t.planes[n]))return 0;return 1},Ja=function(){for(var e=new Array(8),t=0,n=0,i=0;i<e.length;i++)e[i]=new In(0,0,0);return function(i,r){for(var o=0,a=!1,s=0;s<r.planes.length;s++){if(-1===(o=Qa(i,r.planes[s])))return 0;1===o&&(a=!0)}if(!a)return 1;for(var c=0;c<r.vertices.length;c++)In.subtract(e[c],r.vertices[c],i.center);t=0,n=0;for(var l=0;l<r.vertices.length;l++)e[l].x>i.halfExtents.x?t++:e[l].x<-i.halfExtents.x&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var u=0;u<r.vertices.length;u++)e[u].y>i.halfExtents.y?t++:e[u].y<-i.halfExtents.y&&n++;if(t===r.vertices.length||n===r.vertices.length)return 0;t=0,n=0;for(var h=0;h<r.vertices.length;h++)e[h].z>i.halfExtents.z?t++:e[h].z<-i.halfExtents.z&&n++;return t===r.vertices.length||n===r.vertices.length?0:1}}(),$a=(qa=new In(0,0,0),Xa=new Nn,function(e,t){return In.subtract(qa,t,e.center),In.transformMat3(qa,qa,Nn.transpose(Xa,e.orientation)),n=qa,i=e.halfExtents,Math.abs(n.x)<i.x&&Math.abs(n.y)<i.y&&Math.abs(n.z)<i.z;var n,i}),es=(Ya=function(e,t,n,i){return Math.abs(e.x*t+e.y*n+e.z*i)},function(e,t){var n=e.halfExtents.x*Ya(t.n,e.orientation.m00,e.orientation.m01,e.orientation.m02)+e.halfExtents.y*Ya(t.n,e.orientation.m03,e.orientation.m04,e.orientation.m05)+e.halfExtents.z*Ya(t.n,e.orientation.m06,e.orientation.m07,e.orientation.m08),i=In.dot(t.n,e.center);return i+n<t.d?-1:i-n>t.d?0:1}),ts=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===es(e,t.planes[n]))return 0;return 1},ns=function(){for(var e=new Array(8),t=0,n=0,i=0,r=0;r<e.length;r++)e[r]=new In(0,0,0);var o=function(e,t,n,i){return e.x*t+e.y*n+e.z*i};return function(r,a){for(var s=0,c=!1,l=0;l<a.planes.length;l++){if(-1===(s=es(r,a.planes[l])))return 0;1===s&&(c=!0)}if(!c)return 1;for(var u=0;u<a.vertices.length;u++)In.subtract(e[u],a.vertices[u],r.center);n=0,i=0;for(var h=0;h<a.vertices.length;h++)(t=o(e[h],r.orientation.m00,r.orientation.m01,r.orientation.m02))>r.halfExtents.x?n++:t<-r.halfExtents.x&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var f=0;f<a.vertices.length;f++)(t=o(e[f],r.orientation.m03,r.orientation.m04,r.orientation.m05))>r.halfExtents.y?n++:t<-r.halfExtents.y&&i++;if(n===a.vertices.length||i===a.vertices.length)return 0;n=0,i=0;for(var _=0;_<a.vertices.length;_++)(t=o(e[_],r.orientation.m06,r.orientation.m07,r.orientation.m08))>r.halfExtents.z?n++:t<-r.halfExtents.z&&i++;return n===a.vertices.length||i===a.vertices.length?0:1}}(),is=function(){for(var e=new Array(15),t=0;t<15;t++)e[t]=new In(0,0,0);for(var n=new Array(8),i=new Array(8),r=0;r<8;r++)n[r]=new In(0,0,0),i[r]=new In(0,0,0);return function(t,r){In.set(e[0],t.orientation.m00,t.orientation.m01,t.orientation.m02),In.set(e[1],t.orientation.m03,t.orientation.m04,t.orientation.m05),In.set(e[2],t.orientation.m06,t.orientation.m07,t.orientation.m08),In.set(e[3],r.orientation.m00,r.orientation.m01,r.orientation.m02),In.set(e[4],r.orientation.m03,r.orientation.m04,r.orientation.m05),In.set(e[5],r.orientation.m06,r.orientation.m07,r.orientation.m08);for(var o=0;o<3;++o)In.cross(e[6+3*o],e[o],e[3]),In.cross(e[7+3*o],e[o],e[4]),In.cross(e[8+3*o],e[o],e[5]);Wa(t.center,t.halfExtents,e[0],e[1],e[2],n),Wa(r.center,r.halfExtents,e[3],e[4],e[5],i);for(var a=0;a<15;++a){var s=ja(n,e[a]),c=ja(i,e[a]);if(c[0]>s[1]||s[0]>c[1])return 0}return 1}}(),rs=function(){for(var e=new la,t=new In,n=new In,i=new In,r=new Array(8),o=0;o<8;o++)r[o]=new In;for(var a=new Array(8),s=0;s<8;s++)a[s]=new In;return function(o,s){if(0===In.squaredDistance(s.ellipseCenter0,s.ellipseCenter1))return e.radius=s.radius,e.center.set(s.ellipseCenter0),_s.sphereOBB(e,o);t.x=o.orientation.m00,t.y=o.orientation.m01,t.z=o.orientation.m02,n.x=o.orientation.m03,n.y=o.orientation.m04,n.z=o.orientation.m05,i.x=o.orientation.m06,i.y=o.orientation.m07,i.z=o.orientation.m08,Wa(o.center,o.halfExtents,t,n,i,r);var c=a,l=In.copy(c[0],t),u=In.copy(c[1],n),h=In.copy(c[2],i);In.subtract(c[3],s.center,o.center).normalize();var f=In.subtract(c[4],s.ellipseCenter0,s.ellipseCenter1);f.normalize(),In.cross(c[5],l,f),In.cross(c[6],u,f),In.cross(c[7],h,f);for(var _=0;_<8;++_){var p=ja(r,c[_]),d=In.dot(c[_],s.ellipseCenter0),m=In.dot(c[_],s.ellipseCenter1),v=Math.max(d,m),g=Math.min(d,m)-s.radius,y=v+s.radius;if(g>p[1]||p[0]>y)return 0}return 1}}(),os=function(e,t){var n=In.dot(t.n,e.center),i=e.radius*t.n.length();return n+i<t.d?-1:n-i>t.d?0:1},as=function(e,t){for(var n=0;n<t.planes.length;n++)if(-1===os(e,t.planes[n]))return 0;return 1},ss=function(){var e=new In(0,0,0),t=[1,-1,1,-1,1,-1];return function(n,i){for(var r=0;r<6;r++){var o=i.planes[r],a=n.radius,s=n.center,c=o.n,l=o.d,u=In.dot(c,s);if(u+a<l)return 0;if(!(u-a>l)){In.add(e,s,In.multiplyScalar(e,c,a));for(var h=0;h<6;h++)if(h!==r&&h!==r+t[r]){var f=i.planes[h];if(In.dot(f.n,e)<f.d)return 0}}}return 1}}(),cs=function(e,t){var n=e.radius+t.radius;return In.squaredDistance(e.center,t.center)<n*n},ls=function(){var e=new In;return function(t,n){return Zo(e,t.center,n),In.squaredDistance(t.center,e)<t.radius*t.radius}}(),us=function(){var e=new In;return function(t,n){return Jo(e,t.center,n),In.squaredDistance(t.center,e)<t.radius*t.radius}}(),hs=function(){var e=new In,t=new In;return function(n,i){var r=n.radius+i.radius,o=r*r,a=In.squaredDistance(i.ellipseCenter0,i.ellipseCenter1);if(0===a)return In.squaredDistance(n.center,i.center)<o;In.subtract(e,n.center,i.ellipseCenter0),In.subtract(t,i.ellipseCenter1,i.ellipseCenter0);var s=In.dot(e,t)/a;return s<0?In.squaredDistance(n.center,i.ellipseCenter0)<o:s>1?In.squaredDistance(n.center,i.ellipseCenter1)<o:(In.scaleAndAdd(e,i.ellipseCenter0,t,s),In.squaredDistance(n.center,e)<o)}}(),fs=function(){var e=new In,t=new In,n=new In,i=new In,r=new In,o=new In;return function(a,s){var c,l,u=In.subtract(e,a.ellipseCenter1,a.ellipseCenter0),h=In.subtract(t,s.ellipseCenter1,s.ellipseCenter0),f=In.subtract(n,a.ellipseCenter0,s.ellipseCenter0),_=In.dot(u,u),p=In.dot(u,h),d=In.dot(h,h),m=In.dot(u,f),v=In.dot(h,f),g=_*d-p*p,y=g,x=g;g<an?(c=0,y=1,l=v,x=d):(l=_*v-p*m,(c=p*v-d*m)<0?(c=0,l=v,x=d):c>y&&(c=y,l=v+p,x=d)),l<0?(l=0,-m<0?c=0:-m>_?c=y:(c=-m,y=_)):l>x&&(l=x,-m+p<0?c=0:-m+p>_?c=y:(c=-m+p,y=_));var S=Math.abs(c)<an?0:c/y,T=Math.abs(l)<an?0:l/x,b=i;b.set(f),b.add(In.multiplyScalar(r,u,S)),b.subtract(In.multiplyScalar(o,h,T));var E=a.radius+s.radius;return b.lengthSqr()<E*E}}(),_s={raySphere:Sa,rayAABB:Ta,rayOBB:Pa,rayPlane:ya,rayTriangle:xa,rayCapsule:Ra,raySubMesh:Ia,rayMesh:Da,rayModel:Oa,lineSphere:za,lineAABB:Ba,lineOBB:Fa,linePlane:Ma,lineTriangle:Na,sphereWithSphere:cs,sphereAABB:ls,sphereOBB:us,spherePlane:os,sphereFrustum:as,sphereFrustumAccurate:ss,sphereCapsule:hs,aabbWithAABB:Va,aabbWithOBB:Ka,aabbPlane:Qa,aabbFrustum:Za,aabbFrustumAccurate:Ja,obbWithOBB:is,obbPlane:es,obbFrustum:ts,obbFrustumAccurate:ns,obbPoint:$a,obbCapsule:rs,capsuleWithCapsule:fs,resolve:function(e,t,n){void 0===n&&(n=null);var i=e._type,r=t._type,o=this[i|r];return i<r?o(e,t,n):o(t,e,n)}};_s[ea.SHAPE_RAY|ea.SHAPE_SPHERE]=Sa,_s[ea.SHAPE_RAY|ea.SHAPE_AABB]=Ta,_s[ea.SHAPE_RAY|ea.SHAPE_OBB]=Pa,_s[ea.SHAPE_RAY|ea.SHAPE_PLANE]=ya,_s[ea.SHAPE_RAY|ea.SHAPE_TRIANGLE]=xa,_s[ea.SHAPE_RAY|ea.SHAPE_CAPSULE]=Ra,_s[ea.SHAPE_LINE|ea.SHAPE_SPHERE]=za,_s[ea.SHAPE_LINE|ea.SHAPE_AABB]=Ba,_s[ea.SHAPE_LINE|ea.SHAPE_OBB]=Fa,_s[ea.SHAPE_LINE|ea.SHAPE_PLANE]=Ma,_s[ea.SHAPE_LINE|ea.SHAPE_TRIANGLE]=Na,_s[ea.SHAPE_SPHERE]=cs,_s[ea.SHAPE_SPHERE|ea.SHAPE_AABB]=ls,_s[ea.SHAPE_SPHERE|ea.SHAPE_OBB]=us,_s[ea.SHAPE_SPHERE|ea.SHAPE_PLANE]=os,_s[ea.SHAPE_SPHERE|ea.SHAPE_FRUSTUM]=as,_s[ea.SHAPE_SPHERE|ea.SHAPE_FRUSTUM_ACCURATE]=ss,_s[ea.SHAPE_SPHERE|ea.SHAPE_CAPSULE]=hs,_s[ea.SHAPE_AABB]=Va,_s[ea.SHAPE_AABB|ea.SHAPE_OBB]=Ka,_s[ea.SHAPE_AABB|ea.SHAPE_PLANE]=Qa,_s[ea.SHAPE_AABB|ea.SHAPE_FRUSTUM]=Za,_s[ea.SHAPE_AABB|ea.SHAPE_FRUSTUM_ACCURATE]=Ja,_s[ea.SHAPE_OBB]=is,_s[ea.SHAPE_OBB|ea.SHAPE_PLANE]=es,_s[ea.SHAPE_OBB|ea.SHAPE_FRUSTUM]=ts,_s[ea.SHAPE_OBB|ea.SHAPE_FRUSTUM_ACCURATE]=ns,_s[ea.SHAPE_OBB|ea.SHAPE_CAPSULE]=rs,_s[ea.SHAPE_CAPSULE]=fs,k(ta.prototype,"line",[{name:"mag",newName:"len"},{name:"magnitude",newName:"len"}]),G(_s,"intersect",[{name:"line_quad"}]);var ps,ds,ms,vs,gs,ys,xs,Ss=new In(0,0,0),Ts=new In(0,0,0),bs=u.mat4(),Es=u.v4(),Cs=function(){function e(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=1),void 0===n&&(n=0),void 0===i&&(i=0),this.n=void 0,this.d=void 0,this._type=void 0,this._type=ea.SHAPE_PLANE,this.n=new In(e,t,n),this.d=i}return e.create=function(t,n,i,r){return new e(t,n,i,r)},e.clone=function(t){return new e(t.n.x,t.n.y,t.n.z,t.d)},e.copy=function(e,t){return In.copy(e.n,t.n),e.d=t.d,e},e.fromPoints=function(e,t,n,i){return In.subtract(Ss,n,t),In.subtract(Ts,i,t),In.normalize(e.n,In.cross(e.n,Ss,Ts)),e.d=In.dot(e.n,t),e},e.set=function(e,t,n,i,r){return e.n.x=t,e.n.y=n,e.n.z=i,e.d=r,e},e.fromNormalAndPoint=function(e,t,n){return In.copy(e.n,t),e.d=In.dot(t,n),e},e.normalize=function(e,t){var n=t.n.length();return In.normalize(e.n,t.n),n>0&&(e.d=t.d/n),e},e.prototype.transform=function(e){jn.invert(bs,e),jn.transpose(bs,bs),$n.set(Es,this.n.x,this.n.y,this.n.z,this.d),$n.transformMat4(Es,Es,bs),In.set(this.n,Es.x,Es.y,Es.z),this.d=Es.w},Z(e,[{key:"type",get:function(){return this._type}},{key:"x",get:function(){return this.n.x},set:function(e){this.n.x=e}},{key:"y",get:function(){return this.n.y},set:function(e){this.n.y=e}},{key:"z",get:function(){return this.n.z},set:function(e){this.n.z=e}},{key:"w",get:function(){return this.d},set:function(e){this.d=e}}]),e}(),As=function(){function e(e,t,n){this._arrayBuffers=[],this._chunkSize=void 0,this._chunkSize=n*(1<<t)}return e.prototype.allocateNewChunk=function(){return new ArrayBuffer(this._chunkSize)},e}();!function(e){e[e.UINT32=0]="UINT32",e[e.FLOAT32=1]="FLOAT32",e[e.NEVER=2]="NEVER"}(xs||(xs={}));var ws,Ps,Rs=function(){function e(e,t,n,i,r){void 0===r&&(r=8),this._dataType=void 0,this._dataMembers=void 0,this._elementCount=void 0,this._entryBits=void 0,this._stride=void 0,this._entriesPerChunk=void 0,this._entryMask=void 0,this._chunkMask=void 0,this._poolFlag=void 0,this._arrayBuffers=[],this._freeLists=[],this._uint32BufferViews=[],this._float32BufferViews=[],this._hasUint32=!1,this._hasFloat32=!1,this._nativePool=void 0,this._elementCount=i.COUNT,this._entryBits=r,this._dataType=t,this._dataMembers=n,this._stride=4*this._elementCount,this._entriesPerChunk=1<<r,this._entryMask=this._entriesPerChunk-1,this._poolFlag=1<<30,this._chunkMask=~(this._entryMask|this._poolFlag),this._nativePool=new As(e,r,this._stride);var o=xs.NEVER,a=!1,s=!1;for(var c in t){if(a=this._hasFloat32,(s=this._hasUint32)&&a)break;o=t[c],a||o!==xs.FLOAT32?s||o!==xs.UINT32||(this._hasUint32=!0):this._hasFloat32=!0}}var t=e.prototype;return t.alloc=function(){for(var e=0;e<this._freeLists.length;e++){var t=this._freeLists[e];if(t.length){var n=t[t.length-1];return t.length--,(e<<this._entryBits)+n+this._poolFlag}}for(var i=this._nativePool.allocateNewChunk(),r=[],o=[],a=[],s=this._hasFloat32,c=this._hasUint32,l=0;l<this._entriesPerChunk;l++)s&&r.push(new Float32Array(i,this._stride*l,this._elementCount)),c&&o.push(new Uint32Array(i,this._stride*l,this._elementCount)),l&&a.push(l);return c&&this._uint32BufferViews.push(o),s&&this._float32BufferViews.push(r),this._freeLists.push(a),this._arrayBuffers.push(i),(e<<this._entryBits)+this._poolFlag},t.getBuffer=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;return(this._hasFloat32?this._float32BufferViews:this._uint32BufferViews)[t][n]},t.getTypedArray=function(e,t){var n=(this._chunkMask&e)>>this._entryBits,i=this._entryMask&e,r=t,o=(this._dataType[t]===xs.UINT32?this._uint32BufferViews:this._float32BufferViews)[n][i],a=this._dataMembers[t];return o.subarray(r,r+a)},t.free=function(e){var t=(this._chunkMask&e)>>this._entryBits,n=this._entryMask&e;(this._hasUint32?this._uint32BufferViews:this._float32BufferViews)[t][n].fill(0),this._freeLists[t].push(n)},e}();!function(e){e[e.NODE=0]="NODE",e[e.PASS=1]="PASS",e[e.AABB=2]="AABB"}(ws||(ws={})),function(e){e[e.DIRTY_FLAG=0]="DIRTY_FLAG",e[e.LAYER=1]="LAYER",e[e.WORLD_SCALE=2]="WORLD_SCALE",e[e.WORLD_POSITION=5]="WORLD_POSITION",e[e.WORLD_ROTATION=8]="WORLD_ROTATION",e[e.WORLD_MATRIX=12]="WORLD_MATRIX",e[e.LOCAL_SCALE=28]="LOCAL_SCALE",e[e.LOCAL_POSITION=31]="LOCAL_POSITION",e[e.LOCAL_ROTATION=34]="LOCAL_ROTATION",e[e.COUNT=38]="COUNT"}(Ps||(Ps={}));var Is,Ds=((ps={})[Ps.DIRTY_FLAG]=xs.UINT32,ps[Ps.LAYER]=xs.UINT32,ps[Ps.WORLD_SCALE]=xs.FLOAT32,ps[Ps.WORLD_POSITION]=xs.FLOAT32,ps[Ps.WORLD_ROTATION]=xs.FLOAT32,ps[Ps.WORLD_MATRIX]=xs.FLOAT32,ps[Ps.LOCAL_SCALE]=xs.FLOAT32,ps[Ps.LOCAL_POSITION]=xs.FLOAT32,ps[Ps.LOCAL_ROTATION]=xs.FLOAT32,ps[Ps.COUNT]=xs.NEVER,ps),Os=((ds={})[Ps.DIRTY_FLAG]=Ps.LAYER-Ps.DIRTY_FLAG,ds[Ps.LAYER]=Ps.WORLD_SCALE-Ps.LAYER,ds[Ps.WORLD_SCALE]=Ps.WORLD_POSITION-Ps.WORLD_SCALE,ds[Ps.WORLD_POSITION]=Ps.WORLD_ROTATION-Ps.WORLD_POSITION,ds[Ps.WORLD_ROTATION]=Ps.WORLD_MATRIX-Ps.WORLD_ROTATION,ds[Ps.WORLD_MATRIX]=Ps.LOCAL_SCALE-Ps.WORLD_MATRIX,ds[Ps.LOCAL_SCALE]=Ps.LOCAL_POSITION-Ps.LOCAL_SCALE,ds[Ps.LOCAL_POSITION]=Ps.LOCAL_ROTATION-Ps.LOCAL_POSITION,ds[Ps.LOCAL_ROTATION]=Ps.COUNT-Ps.LOCAL_ROTATION,ds[Ps.COUNT]=1,ds),Ms=new Rs(ws.NODE,Ds,Os,Ps);!function(e){e[e.PRIORITY=0]="PRIORITY",e[e.STAGE=1]="STAGE",e[e.PHASE=2]="PHASE",e[e.PRIMITIVE=3]="PRIMITIVE",e[e.BATCHING_SCHEME=4]="BATCHING_SCHEME",e[e.DYNAMIC_STATE=5]="DYNAMIC_STATE",e[e.HASH=6]="HASH",e[e.COUNT=7]="COUNT"}(Is||(Is={}));var Ns,Ls=((ms={})[Is.PRIORITY]=xs.UINT32,ms[Is.STAGE]=xs.UINT32,ms[Is.PHASE]=xs.UINT32,ms[Is.PRIMITIVE]=xs.UINT32,ms[Is.BATCHING_SCHEME]=xs.UINT32,ms[Is.DYNAMIC_STATE]=xs.UINT32,ms[Is.HASH]=xs.UINT32,ms[Is.COUNT]=xs.NEVER,ms),Bs=((vs={})[Is.PRIORITY]=Is.STAGE-Is.PRIORITY,vs[Is.STAGE]=Is.PHASE-Is.STAGE,vs[Is.PHASE]=Is.PRIMITIVE-Is.PHASE,vs[Is.PRIMITIVE]=Is.BATCHING_SCHEME-Is.PRIMITIVE,vs[Is.BATCHING_SCHEME]=Is.DYNAMIC_STATE-Is.BATCHING_SCHEME,vs[Is.DYNAMIC_STATE]=Is.HASH-Is.DYNAMIC_STATE,vs[Is.HASH]=Is.COUNT-Is.HASH,vs[Is.COUNT]=1,vs),Fs=new Rs(ws.PASS,Ls,Bs,Is);!function(e){e[e.CENTER=0]="CENTER",e[e.HALFEXTENTS=3]="HALFEXTENTS",e[e.COUNT=6]="COUNT"}(Ns||(Ns={}));var zs=((gs={})[Ns.CENTER]=xs.FLOAT32,gs[Ns.HALFEXTENTS]=xs.FLOAT32,gs[Ns.COUNT]=xs.NEVER,gs),Us=((ys={})[Ns.CENTER]=Ns.HALFEXTENTS-Ns.CENTER,ys[Ns.HALFEXTENTS]=Ns.COUNT-Ns.HALFEXTENTS,ys[Ns.COUNT]=1,ys),ks=new Rs(ws.AABB,zs,Us,Ns),Gs=new In,Hs=new In,Vs=new In,Ws=new In,js=new Nn,qs=function(e,t,n){js.m00=Math.abs(n.m00),js.m01=Math.abs(n.m01),js.m02=Math.abs(n.m02),js.m03=Math.abs(n.m04),js.m04=Math.abs(n.m05),js.m05=Math.abs(n.m06),js.m06=Math.abs(n.m08),js.m07=Math.abs(n.m09),js.m08=Math.abs(n.m10),In.transformMat3(e,t,js)},Xs=function(){function e(e,t,n,i,r,o){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),this.center=void 0,this.halfExtents=void 0,this._type=void 0,this._aabbHandle=0,this._type=ea.SHAPE_AABB,this.center=new In(e,t,n),this.halfExtents=new In(i,r,o)}e.create=function(t,n,i,r,o,a){return new e(t,n,i,r,o,a)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z)},e.copy=function(e,t){return In.copy(e.center,t.center),In.copy(e.halfExtents,t.halfExtents),e},e.fromPoints=function(e,t,n){return In.add(Gs,n,t),In.subtract(Hs,n,t),In.multiplyScalar(e.center,Gs,.5),In.multiplyScalar(e.halfExtents,Hs,.5),e},e.set=function(e,t,n,i,r,o,a){return e.center.set(t,n,i),e.halfExtents.set(r,o,a),e},e.merge=function(t,n,i){return In.subtract(Gs,n.center,n.halfExtents),In.subtract(Hs,i.center,i.halfExtents),In.add(Vs,n.center,n.halfExtents),In.add(Ws,i.center,i.halfExtents),In.max(Ws,Vs,Ws),In.min(Vs,Gs,Hs),e.fromPoints(t,Vs,Ws)},e.toBoundingSphere=function(e,t){return e.center.set(t.center),e.radius=t.halfExtents.length(),e},e.transform=function(e,t,n){return In.transformMat4(e.center,t.center,n),qs(e.halfExtents,t.halfExtents,n),e};var t=e.prototype;return t.getBoundary=function(e,t){In.subtract(e,this.center,this.halfExtents),In.add(t,this.center,this.halfExtents)},t.transform=function(e,t,n,i,r){In.transformMat4(r.center,this.center,e),qs(r.halfExtents,this.halfExtents,e)},t.clone=function(){return e.clone(this)},t.copy=function(t){return e.copy(this,t)},t.mergePoint=function(e){this.getBoundary(Gs,Hs),e.x<Gs.x&&(Gs.x=e.x),e.y<Gs.y&&(Gs.y=e.y),e.z<Gs.z&&(Gs.z=e.z),e.x>Hs.x&&(Hs.x=e.x),e.y>Hs.y&&(Hs.y=e.y),e.z>Hs.z&&(Hs.z=e.z),In.add(Vs,Gs,Hs),this.center.set(In.multiplyScalar(Vs,Vs,.5)),this.halfExtents.set(Hs.x-Vs.x,Hs.y-Vs.y,Hs.z-Vs.z)},t.mergePoints=function(e){if(!(e.length<1))for(var t=0;t<e.length;t++)this.mergePoint(e[t])},t.mergeFrustum=function(e){return this.mergePoints(e.vertices)},Z(e,[{key:"type",get:function(){return this._type}},{key:"native",get:function(){return this._nativeObj}}]),e}(),Ys=new In,Ks=new In,Qs=new Nn,Zs=function(){function e(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=1),void 0===r&&(r=1),void 0===o&&(o=1),void 0===a&&(a=1),void 0===s&&(s=0),void 0===c&&(c=0),void 0===l&&(l=0),void 0===u&&(u=1),void 0===h&&(h=0),void 0===f&&(f=0),void 0===_&&(_=0),void 0===p&&(p=1),this.center=void 0,this.halfExtents=void 0,this.orientation=void 0,this._type=void 0,this._type=ea.SHAPE_OBB,this.center=new In(e,t,n),this.halfExtents=new In(i,r,o),this.orientation=new Nn(a,s,c,l,u,h,f,_,p)}e.create=function(t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return new e(t,n,i,r,o,a,s,c,l,u,h,f,_,p,d)},e.clone=function(t){return new e(t.center.x,t.center.y,t.center.z,t.halfExtents.x,t.halfExtents.y,t.halfExtents.z,t.orientation.m00,t.orientation.m01,t.orientation.m02,t.orientation.m03,t.orientation.m04,t.orientation.m05,t.orientation.m06,t.orientation.m07,t.orientation.m08)},e.copy=function(e,t){return In.copy(e.center,t.center),In.copy(e.halfExtents,t.halfExtents),Nn.copy(e.orientation,t.orientation),e},e.fromPoints=function(e,t,n){return In.multiplyScalar(e.center,In.add(Ys,t,n),.5),In.multiplyScalar(e.halfExtents,In.subtract(Ks,n,t),.5),Nn.identity(e.orientation),e},e.set=function(e,t,n,i,r,o,a,s,c,l,u,h,f,_,p,d){return In.set(e.center,t,n,i),In.set(e.halfExtents,r,o,a),Nn.set(e.orientation,s,c,l,u,h,f,_,p,d),e};var t=e.prototype;return t.getBoundary=function(e,t){!function(e,t,n){Qs.m00=Math.abs(n.m00),Qs.m01=Math.abs(n.m01),Qs.m02=Math.abs(n.m02),Qs.m03=Math.abs(n.m03),Qs.m04=Math.abs(n.m04),Qs.m05=Math.abs(n.m05),Qs.m06=Math.abs(n.m06),Qs.m07=Math.abs(n.m07),Qs.m08=Math.abs(n.m08),In.transformMat3(e,t,Qs)}(Ys,this.halfExtents,this.orientation),In.subtract(e,this.center,Ys),In.add(t,this.center,Ys)},t.transform=function(e,t,n,i,r){In.transformMat4(r.center,this.center,e),Nn.fromQuat(r.orientation,n),In.multiply(r.halfExtents,this.halfExtents,i)},t.translateAndRotate=function(e,t,n){In.transformMat4(n.center,this.center,e),Nn.fromQuat(n.orientation,t)},t.setScale=function(e,t){In.multiply(t.halfExtents,this.halfExtents,e)},Z(e,[{key:"type",get:function(){return this._type}}]),e}(),Js=function(){function e(e,t,n){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=1),this._type=void 0,this.radius=void 0,this.halfHeight=void 0,this.axis=void 0,this.center=void 0,this.rotation=void 0,this.ellipseCenter0=void 0,this.ellipseCenter1=void 0,this._type=ea.SHAPE_CAPSULE,this.radius=e,this.halfHeight=t,this.axis=n,this.center=new In,this.rotation=new Fn,this.ellipseCenter0=new In(0,t,0),this.ellipseCenter1=new In(0,-t,0),this.updateCache()}var t=e.prototype;return t.transform=function(e,t,n,i,r){var o=i,a=En(o);r.radius=this.radius*Math.abs(a);var s=(this.halfHeight+this.radius)*Math.abs(o.y)-r.radius;s<0&&(s=0),r.halfHeight=s,In.transformMat4(r.center,this.center,e),Fn.multiply(r.rotation,this.rotation,n),r.updateCache()},t.updateCache=function(){this.updateLocalCenter(),In.transformQuat(this.ellipseCenter0,this.ellipseCenter0,this.rotation),In.transformQuat(this.ellipseCenter1,this.ellipseCenter1,this.rotation),this.ellipseCenter0.add(this.center),this.ellipseCenter1.add(this.center)},t.updateLocalCenter=function(){var e=this.halfHeight;switch(this.axis){case 0:this.ellipseCenter0.set(e,0,0),this.ellipseCenter1.set(-e,0,0);break;case 1:this.ellipseCenter0.set(0,e,0),this.ellipseCenter1.set(0,-e,0);break;case 2:this.ellipseCenter0.set(0,0,e),this.ellipseCenter1.set(0,0,-e)}},Z(e,[{key:"type",get:function(){return this._type}}]),e}(),$s=new Array(8);$s[0]=new In(1,1,1),$s[1]=new In(-1,1,1),$s[2]=new In(-1,-1,1),$s[3]=new In(1,-1,1),$s[4]=new In(1,1,-1),$s[5]=new In(-1,1,-1),$s[6]=new In(-1,-1,-1),$s[7]=new In(1,-1,-1);var ec,tc,nc=new In,ic=new In,rc=new In,oc=function(){function e(){this._type=void 0,this.planes=void 0,this.vertices=void 0,this._type=ea.SHAPE_FRUSTUM,this.planes=new Array(6);for(var e=0;e<6;++e)this.planes[e]=Cs.create(0,0,0,0);this.vertices=new Array(8);for(var t=0;t<8;++t)this.vertices[t]=new In}e.createFromAABB=function(e,t){var n=new In,i=new In;return In.subtract(n,t.center,t.halfExtents),In.add(i,t.center,t.halfExtents),e.vertices[0].set(n.x,i.y,n.z),e.vertices[1].set(i.x,i.y,n.z),e.vertices[2].set(i.x,n.y,n.z),e.vertices[3].set(n.x,n.y,n.z),e.vertices[4].set(n.x,i.y,i.z),e.vertices[5].set(i.x,i.y,i.z),e.vertices[6].set(i.x,n.y,i.z),e.vertices[7].set(n.x,n.y,i.z),e._type!==ea.SHAPE_FRUSTUM_ACCURATE||e.updatePlanes(),e},e.split=function(e,t,n,i,r){var o=Math.tan(.5*t.fov),a=o*t.aspect;nc.set(i*a,i*o,i),ic.set(r*a,r*o,r);var s=e.vertices;return rc.set(nc.x,nc.y,nc.z),In.transformMat4(s[0],rc,n),rc.set(-nc.x,nc.y,nc.z),In.transformMat4(s[1],rc,n),rc.set(-nc.x,-nc.y,nc.z),In.transformMat4(s[2],rc,n),rc.set(nc.x,-nc.y,nc.z),In.transformMat4(s[3],rc,n),rc.set(ic.x,ic.y,ic.z),In.transformMat4(s[4],rc,n),rc.set(-ic.x,ic.y,ic.z),In.transformMat4(s[5],rc,n),rc.set(-ic.x,-ic.y,ic.z),In.transformMat4(s[6],rc,n),rc.set(ic.x,-ic.y,ic.z),In.transformMat4(s[7],rc,n),e.updatePlanes(),e},e.create=function(){return new e},e.clone=function(t){return e.copy(new e,t)},e.copy=function(e,t){e._type=t._type;for(var n=0;n<6;++n)Cs.copy(e.planes[n],t.planes[n]);for(var i=0;i<8;++i)In.copy(e.vertices[i],t.vertices[i]);return e};var t=e.prototype;return t.update=function(e,t){if(In.set(this.planes[0].n,e.m03+e.m00,e.m07+e.m04,e.m11+e.m08),this.planes[0].d=-(e.m15+e.m12),In.set(this.planes[1].n,e.m03-e.m00,e.m07-e.m04,e.m11-e.m08),this.planes[1].d=-(e.m15-e.m12),In.set(this.planes[2].n,e.m03+e.m01,e.m07+e.m05,e.m11+e.m09),this.planes[2].d=-(e.m15+e.m13),In.set(this.planes[3].n,e.m03-e.m01,e.m07-e.m05,e.m11-e.m09),this.planes[3].d=-(e.m15-e.m13),In.set(this.planes[4].n,e.m03+e.m02,e.m07+e.m06,e.m11+e.m10),this.planes[4].d=-(e.m15+e.m14),In.set(this.planes[5].n,e.m03-e.m02,e.m07-e.m06,e.m11-e.m10),this.planes[5].d=-(e.m15-e.m14),this._type===ea.SHAPE_FRUSTUM_ACCURATE){for(var n=0;n<6;n++){var i=this.planes[n],r=1/i.n.length();In.multiplyScalar(i.n,i.n,r),i.d*=r}for(var o=0;o<8;o++)In.transformMat4(this.vertices[o],$s[o],t)}},t.transform=function(e){if(this._type===ea.SHAPE_FRUSTUM_ACCURATE){for(var t=0;t<8;t++)In.transformMat4(this.vertices[t],this.vertices[t],e);Cs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Cs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Cs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Cs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Cs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Cs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])}},t.updatePlanes=function(){Cs.fromPoints(this.planes[0],this.vertices[1],this.vertices[6],this.vertices[5]),Cs.fromPoints(this.planes[1],this.vertices[3],this.vertices[4],this.vertices[7]),Cs.fromPoints(this.planes[2],this.vertices[6],this.vertices[3],this.vertices[7]),Cs.fromPoints(this.planes[3],this.vertices[0],this.vertices[5],this.vertices[4]),Cs.fromPoints(this.planes[4],this.vertices[2],this.vertices[0],this.vertices[3]),Cs.fromPoints(this.planes[5],this.vertices[7],this.vertices[5],this.vertices[6])},Z(e,[{key:"accurate",set:function(e){this._type=e?ea.SHAPE_FRUSTUM_ACCURATE:ea.SHAPE_FRUSTUM}},{key:"type",get:function(){return this._type}}]),e}();oc.createOrtho=function(e,t,n,i,r,o){var a=t/2,s=n/2;In.set(rc,a,s,-i),In.transformMat4(e.vertices[0],rc,o),In.set(rc,-a,s,-i),In.transformMat4(e.vertices[1],rc,o),In.set(rc,-a,-s,-i),In.transformMat4(e.vertices[2],rc,o),In.set(rc,a,-s,-i),In.transformMat4(e.vertices[3],rc,o),In.set(rc,a,s,-r),In.transformMat4(e.vertices[4],rc,o),In.set(rc,-a,s,-r),In.transformMat4(e.vertices[5],rc,o),In.set(rc,-a,-s,-r),In.transformMat4(e.vertices[6],rc,o),In.set(rc,a,-s,-r),In.transformMat4(e.vertices[7],rc,o),Cs.fromPoints(e.planes[0],e.vertices[1],e.vertices[6],e.vertices[5]),Cs.fromPoints(e.planes[1],e.vertices[3],e.vertices[4],e.vertices[7]),Cs.fromPoints(e.planes[2],e.vertices[6],e.vertices[3],e.vertices[7]),Cs.fromPoints(e.planes[3],e.vertices[0],e.vertices[5],e.vertices[4]),Cs.fromPoints(e.planes[4],e.vertices[2],e.vertices[0],e.vertices[3]),Cs.fromPoints(e.planes[5],e.vertices[7],e.vertices[5],e.vertices[6])},function(e){e[e.Default=0]="Default",e[e.Normal=1]="Normal",e[e.Loop=2]="Loop",e[e.ShouldWrap=4]="ShouldWrap",e[e.Clamp=8]="Clamp",e[e.PingPong=22]="PingPong",e[e.Reverse=36]="Reverse"}(ec||(ec={})),function(e){e[e.Default=ec.Default]="Default",e[e.Normal=ec.Normal]="Normal",e[e.Reverse=ec.Reverse]="Reverse",e[e.Loop=ec.Loop]="Loop",e[e.LoopReverse=ec.Loop|ec.Reverse]="LoopReverse",e[e.PingPong=ec.PingPong]="PingPong",e[e.PingPongReverse=ec.PingPong|ec.Reverse]="PingPongReverse"}(tc||(tc={})),ut(tc);var ac=function(){function e(e){this.ratio=0,this.time=0,this.direction=1,this.stopped=!0,this.iterations=0,this.frameIndex=void 0,e&&this.set(e)}return e.prototype.set=function(e){this.ratio=e.ratio,this.time=e.time,this.direction=e.direction,this.stopped=e.stopped,this.iterations=e.iterations,this.frameIndex=e.frameIndex},e}();function sc(e,t,n){void 0===n&&(n=1e-6);for(var i=0,r=e.length-1,o=r>>>1;i<=r;o=i+r>>>1){var a=e[o];if(a>t+n)r=o-1;else{if(!(a<t-n))return o;i=o+1}}return~i}var cc=function(){},lc=function(){return cc},uc=hc((function(){}));function hc(e){return function(t){return"function"==typeof t?e(t):function(n){return e(n,t)}}}function fc(e){return function(t){return function(n){!function(e,t,n){var i=pc(e);if(i){var r=dc(i,"proto");dc(r,"editor")[t]=n}}(n,e,t)}}}var _c="__ccclassCache__";function pc(e){return dc(e,_c)}function dc(e,t){return e[t]||(e[t]={})}var mc=hc((function(e,t){var n=rt.getSuper(e);n===Object&&(n=null);var i={name:t,extends:n,ctor:e},r=e[_c];if(r){var o=r.proto;o&&rt.mixin(i,o),e[_c]=void 0}return en(i)})),vc=fc("requireComponent"),gc=fc("executionOrder"),yc=uc;function xc(e,t,n){var i=null;function r(e,t,n){var r=pc(e.constructor);if(r){var o=dc(r,"proto"),a=dc(o,"properties");!function(e,t,n,i,r,o){var a,s=r&&(r.get||r.set);i&&(a=Wt(i,s));var c=t[n],l=rt.mixin(c||{},a||i||{});if(s)r.get&&(l.get=r.get),r.set&&(l.set=r.set);else if(r)r.initializer&&(l.default=function(e){var t;try{t=e()}catch(t){return e}return"object"!=typeof t||null===t?t:e}(r.initializer));else{var u=o.default||(o.default=function(e){var t;try{t=new e}catch(e){return{}}return t}(e));u.hasOwnProperty(n)&&(l.default=u[n])}t[n]=l}(e.constructor,a,t,i,n,r)}}return void 0===e?xc({type:void 0}):void 0===t?(i=e,r):void r(e,t,n)}var Sc=Symbol("cc:SerializationMetadata"),Tc=function(e,t,n){return xc(Cc({}))(e,t,n)};function bc(e){return xc(Cc({formerlySerializedAs:e}))}var Ec=function(e,t,n){return xc({editorOnly:!0})(e,t,n)};function Cc(e){return e.__noImplicit=!0,"serializable"in e||(e.serializable=!0),e}var Ac=cc,wc=uc,Pc=lc,Rc=uc,Ic=lc,Dc=lc,Oc=lc,Mc=cc,Nc=lc,Lc=cc,Bc=lc,Fc=lc,zc=lc,Uc=lc,kc=lc,Gc=lc,Hc=cc,Vc=lc,Wc=cc,jc=cc,qc=cc,Xc=Zc(Nt),Yc=Zc(Lt),Kc=Zc(Bt),Qc=Zc(Ft);function Zc(e){return xc({type:e})}var Jc,$c,el,tl,nl,il,rl,ol,al,sl=function(e,t,n){return xc({__noImplicit:!0,override:!0})(e,t,n)},cl=mc("cc.KeyframeCurve")((Jc=Symbol.iterator,il=function(){function e(){ce(this,"_times",tl,this),ce(this,"_values",nl,this)}var t=e.prototype;return t[Jc]=function(){var e=this,t=0;return{next:function(){if(t>=e._times.length)return{done:!0,value:void 0};var n=[e._times[t],e._values[t]];return++t,{done:!1,value:n}}}},t.keyframes=function(){return this},t.times=function(){return this._times},t.values=function(){return this._values},t.getKeyframeTime=function(e){return this._times[e]},t.getKeyframeValue=function(e){return this._values[e]},t.addKeyFrame=function(e,t){return this._insertNewKeyframe(e,t)},t.removeKeyframe=function(e){this._times.splice(e,1),this._values.splice(e,1)},t.indexOfKeyframe=function(e){return sc(this._times,e)},t.updateTime=function(e,t){var n=this._values[e];this.removeKeyframe(e),this._insertNewKeyframe(t,n)},t.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.slice());else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return e[1]})))}},t.clear=function(){this._times.length=0,this._values.length=0},t.searchKeyframe=function(e){return sc(this._times,e)},t.setKeyframes=function(e,t){e.length,t.length,function(e){e.every((function(e,t,n){return 0===t||e>n[t-1]||cn(e,n[t-1],1e-6)}))}(e),this._times=e,this._values=t},t._insertNewKeyframe=function(e,t){var n=this._times,i=this._values,r=n.length,o=sc(n,e);if(o>=0)return o;var a=~o;return 0===a?(n.unshift(e),i.unshift(t)):a===r?(n.push(e),i.push(t)):(n.splice(a-1,0,e),i.splice(a-1,0,t)),a},Z(e,[{key:"keyFramesCount",get:function(){return this._times.length}},{key:"rangeMin",get:function(){return this._times[0]}},{key:"rangeMax",get:function(){return this._times[this._values.length-1]}}]),e}(),tl=le((el=il).prototype,"_times",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nl=le(el.prototype,"_values",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$c=el))||$c;function ll(e){return e>-1e-9&&e<1e-9}!function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.CUBIC=2]="CUBIC"}(rl||(rl=e("RealInterpolationMode",{}))),function(e){e[e.LINEAR=0]="LINEAR",e[e.CLAMP=1]="CLAMP",e[e.LOOP=2]="LOOP",e[e.PING_PONG=3]="PING_PONG"}(ol||(ol=e("ExtrapolationMode",{}))),function(e){e[e.NONE=0]="NONE",e[e.LEFT=1]="LEFT",e[e.RIGHT=2]="RIGHT",e[e.BOTH=3]="BOTH"}(al||(al=e("TangentWeightMode",{})));var ul,hl=e("editorExtrasTag","__editorExtras__"),fl=function(){},_l=Object.freeze({__proto__:null,uniquelyReferenced:Ac,ccclass:mc,property:xc,requireComponent:vc,executionOrder:gc,disallowMultiple:yc,allowReplicated:function(e){en.Attr.setClassAttr(e,"replicated","visible",!0)},executeInEditMode:wc,menu:Pc,playOnFocus:Rc,inspector:Ic,icon:Dc,help:Oc,type:Zc,integer:Xc,float:Yc,boolean:Kc,string:Qc});e("_decorator",_l);var pl=1<<22,dl=[],ml=e("CCObject",function(){function e(e){void 0===e&&(e=""),this._objFlags=void 0,this._name=void 0,this._name=e,this._objFlags=0}e._deferredDestroy=function(){for(var e=dl.length,t=0;t<e;++t){var n=dl[t];1&n._objFlags||n._destroyImmediate()}e===dl.length?dl.length=0:dl.splice(0,e)};var t=e.prototype;return t.destroy=function(){return 1&this._objFlags?(D(5e3),!1):!(4&this._objFlags||(this._objFlags|=4,dl.push(this),0))},t._destruct=function(){var e=this.constructor,t=e.__destruct__;t||(t=function(e,t){var n,i=e instanceof u._BaseNode||e instanceof u.Component,r=i?"_id":null,o={};for(n in e)if(e.hasOwnProperty(n)){if(n===r)continue;switch(typeof e[n]){case"string":o[n]="";break;case"object":case"function":o[n]=null}}if(en._isCCClass(t))for(var a=u.Class.Attr.getClassAttrs(t),s=t.__props__,c=0;c<s.length;c++){var l=(n=s[c])+u.Class.Attr.DELIMETER+"default";if(l in a){if(i&&"_id"===n)continue;switch(typeof a[l]){case"string":o[n]="";break;case"object":case"function":o[n]=null;break;case"undefined":o[n]=void 0}}}var h="";for(n in o){var f;f=en.IDENTIFIER_RE.test(n)?"o."+n+"=":"o["+en.escapeForJS(n)+"]=";var _=o[n];""===_&&(_='""'),h+=f+_+";\n"}return Function("o",h)}(this,e),Ce(e,"__destruct__",t,!0)),t(this)},t._destroyImmediate=function(){1&this._objFlags?M(5e3):(this._onPreDestroy&&this._onPreDestroy(),this._destruct(),this._objFlags|=1)},Z(e,[{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"hideFlags",get:function(){return this._objFlags&e.Flags.AllHideMasks},set:function(t){var n=t&e.Flags.AllHideMasks;this._objFlags=this._objFlags&~e.Flags.AllHideMasks|n}},{key:"replicated",get:function(){return!!(this._objFlags&pl)},set:function(e){e?this._objFlags|=pl:this._objFlags&=-4194305}},{key:"isValid",get:function(){return!(1&this._objFlags)}}]),e}()),vl=ml.prototype;function gl(e,t){return"object"==typeof e?!(!e||e._objFlags&(t?5:1)):void 0!==e}vl._deserialize=null,vl._onPreDestroy=null,en.fastDefine("cc.Object",ml,((ul={_name:"",_objFlags:0})[hl]={},ul)),en.Attr.setClassAttr(ml,hl,"editorOnly",!0),en.Attr.setClassAttr(ml,"replicated","visible",!1),Ce(ml,"Flags",{Destroyed:1,DontSave:8,EditorOnly:16,Dirty:32,DontDestroy:64,PersistentMask:-4192741,Destroying:128,Deactivating:256,LockedInEditor:512,HideInHierarchy:1024,AllHideMasks:1560,IsPreloadStarted:8192,IsOnLoadStarted:32768,IsOnLoadCalled:16384,IsOnEnableCalled:2048,IsStartCalled:65536,IsEditorOnEnableCalled:4096,IsPositionLocked:1<<21,IsRotationLocked:1<<17,IsScaleLocked:1<<18,IsAnchorLocked:1<<19,IsSizeLocked:1<<20}),u.isValid=gl,u.Object=ml;var yl=function(){function e(e){this._map=null,this._count=0,e?(this._map=e,this._count=Object.keys(e).length):(this._map=rt.createMap(!0),this._count=0)}var t=e.prototype;return t.add=function(e,t){return e in this._map||this._count++,this._map[e]=t},t.get=function(e){return this._map[e]},t.has=function(e){return e in this._map},t.remove=function(e){var t=this._map[e];return e in this._map&&(delete this._map[e],this._count--),t},t.clear=function(){0!==this._count&&(this._map=rt.createMap(!0),this._count=0)},t.forEach=function(e){for(var t in this._map)e(this._map[t],t)},t.find=function(e){for(var t in this._map)if(e(this._map[t],t))return this._map[t];return null},t.destroy=function(){this._map=null},Z(e,[{key:"count",get:function(){return this._count}}]),e}(),xl=function(){function e(t,n){this.id=e._pipelineId++,this.name="",this.pipes=[],this.name=t;for(var i=0,r=n.length;i<r;i++)this.pipes.push(n[i])}var t=e.prototype;return t.insert=function(e,t){return t>this.pipes.length?(D(4921),this):(this.pipes.splice(t,0,e),this)},t.append=function(e){return this.pipes.push(e),this},t.remove=function(e){return this.pipes.splice(e,1),this},t.sync=function(e){var t=this.pipes;if(0===t.length)return null;e.isFinish=!1;for(var n=0,i=t.length;n<i;){var r=(0,t[n])(e);if(r)return e.isFinish=!0,r;++n!==i&&(e.input=e.output,e.output=null)}return e.isFinish=!0,e.output},t.async=function(e){0!==this.pipes.length&&(e.isFinish=!1,this._flow(0,e))},t._flow=function(e,t){var n=this;(0,this.pipes[e])(t,(function(i){i?(t.isFinish=!0,t.dispatch("complete",i)):++e<n.pipes.length?(t.input=t.output,t.output=null,n._flow(e,t)):(t.isFinish=!0,t.dispatch("complete",i,t.output))}))},e}();xl._pipelineId=0,function(){function e(e){if(this._weakMap={},void 0===window.WeakRef)throw new Error("this platform does not support WeakRef!");if(e)for(var t in e)this._weakMap[t]=new WeakRef(e[t])}var t=e.prototype;t.add=function(e,t){return this._weakMap[e]=new WeakRef(t),t},t.has=function(e){return e in this._weakMap&&!!this._weakMap[e].deref()},t.get=function(e){return this._weakMap[e]&&this._weakMap[e].deref()},t.remove=function(e){var t=this._weakMap[e];return delete this._weakMap[e],t&&t.deref()},t.clear=function(){this._weakMap=rt.createMap(!0)},t.forEach=function(e){for(var t in this._weakMap){var n=this.get(t);n&&e(n,t)}},t.find=function(e){for(var t in this._weakMap){var n=this.get(t);if(n&&e(n,t))return this._weakMap[t].deref()}return null},t.destroy=function(){this._weakMap={}},Z(e,[{key:"count",get:function(){return Object.values(this._weakMap).filter((function(e){return e.deref()})).length}}])}();var Sl,Tl=new yl,bl=new yl,El=new yl,Cl=new yl,Al=new xl("normal load",[]),wl=new xl("fetch",[]),Pl=new xl("transform url",[]);!function(e){e.UUID="uuid",e.PATH="path",e.DIR="dir",e.URL="url",e.SCENE="scene"}(Sl||(Sl={}));var Rl,Il={default:{priority:0},preload:{maxConcurrency:6,maxRequestsPerFrame:2,priority:-1},scene:{maxConcurrency:20,maxRequestsPerFrame:20,priority:1},bundle:{maxConcurrency:20,maxRequestsPerFrame:20,priority:2},remote:{maxRetryCount:4}};!function(e){e.RESOURCES="resources",e.MAIN="main",e.START_SCENE="start-scene"}(Rl||(Rl={}));var Dl=function(){function e(t){this.id=e._taskId++,this.onComplete=null,this.onProgress=null,this.onError=null,this.source=null,this.output=null,this.input=null,this.progress=null,this.options=null,this.isFinish=!0,this.set(t)}e.create=function(t){var n;return 0!==e._deadPool.length?(n=e._deadPool.pop()).set(t):n=new e(t),n};var t=e.prototype;return t.set=function(e){void 0===e&&(e=Object.create(null)),this.onComplete=e.onComplete||null,this.onProgress=e.onProgress||null,this.onError=e.onError||null,this.source=this.input=e.input,this.output=null,this.progress=e.progress,this.options=e.options||Object.create(null)},t.dispatch=function(e,t,n,i,r){switch(e){case"complete":this.onComplete&&this.onComplete(t,n);break;case"progress":this.onProgress&&this.onProgress(t,n,i,r);break;case"error":this.onError&&this.onError(t,n,i,r);break;default:var o="on"+e[0].toUpperCase()+e.substr(1);"function"==typeof this[o]&&this[o](t,n,i,r)}},t.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this.onComplete=null,this.onProgress=null,this.onError=null,this.source=this.output=this.input=null,this.progress=null,this.options=null,e._deadPool.push(this))},e}();Dl.MAX_DEAD_NUM=500,Dl._taskId=0,Dl._deadPool=[];var Ol="0123456789abcdef".split(""),Ml=["","","",""],Nl=Ml.concat(Ml,"-",Ml,"-",Ml,"-",Ml,"-",Ml,Ml,Ml),Ll=Nl.map((function(e,t){return"-"===e?NaN:t})).filter(isFinite);function Bl(e){var t=e.split("@")[0];if(22!==t.length)return e;Nl[0]=e[0],Nl[1]=e[1];for(var n=2,i=2;n<22;n+=2){var r=vt[e.charCodeAt(n)],o=vt[e.charCodeAt(n+1)];Nl[Ll[i++]]=Ol[r>>2],Nl[Ll[i++]]=Ol[(3&r)<<2|o>>4],Nl[Ll[i++]]=Ol[15&o]}return e.replace(t,Nl.join(""))}var Fl=/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,}).*/;function zl(e){var t=Fl.exec(e);return t?t[1]:""}function Ul(e,t){(t=t||Object.create(null)).__isNative__=t.isNative,t.ext=t.nativeExt;var n=Cl.find((function(t){return!!t.getAssetInfo(e)}));return n&&(t.bundle=n.name),Hl(e,t)}function kl(e){return!!e&&(e instanceof u.SceneAsset||e instanceof u.Scene)}function Gl(e){return e&&(46===e.charCodeAt(0)&&47===e.charCodeAt(1)?e=e.slice(2):47===e.charCodeAt(0)&&(e=e.slice(1))),e}function Hl(e,t){var n=Dl.create({input:e,options:t}),i=[];try{for(var r,o=se(Pl.sync(n));!(r=o()).done;){var a=r.value,s=a.url;a.recycle(),i.push(s)}}catch(e){for(var c,l=se(n.output);!(c=l()).done;)c.value.recycle();T(e.message,e.stack)}return n.recycle(),i.length>1?i:i[0]}var Vl=Object.freeze({__proto__:null,getUuidFromURL:zl,getUrlWithUuid:Ul,isScene:kl,normalize:Gl,transform:Hl,decodeUuid:Bl}),Wl=new(function(){function e(){this._pools=[],this._lastShrinkPassed=0,this.shrinkTimeSpan=5}var t=e.prototype;return t.addContainer=function(e){-1===e._poolHandle&&(e._poolHandle=this._pools.length,this._pools.push(e))},t.removeContainer=function(e){-1!==e._poolHandle&&(this._pools[this._pools.length-1]._poolHandle=e._poolHandle,rt.array.fastRemoveAt(this._pools,e._poolHandle),e._poolHandle=-1)},t.tryShrink=function(){for(var e=0;e<this._pools.length;e++)this._pools[e].tryShrink()},t.update=function(e){this._lastShrinkPassed+=e,this._lastShrinkPassed>this.shrinkTimeSpan&&(this.tryShrink(),this._lastShrinkPassed-=this.shrinkTimeSpan)},e}()),jl=function(){function e(){this._poolHandle=-1,Wl.addContainer(this)}return e.prototype.destroy=function(){Wl.removeContainer(this)},e}(),ql=e("Pool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._ctor=void 0,r._elementsPerBatch=void 0,r._nextAvail=void 0,r._freepool=[],r._dtor=void 0,r._ctor=t,r._dtor=i||null,r._elementsPerBatch=Math.max(n,1),r._nextAvail=r._elementsPerBatch-1;for(var o=0;o<r._elementsPerBatch;++o)r._freepool.push(t());return r}$(t,e);var n=t.prototype;return n.alloc=function(){if(this._nextAvail<0){this._freepool.length=this._elementsPerBatch;for(var e=0;e<this._elementsPerBatch;e++)this._freepool[e]=this._ctor();this._nextAvail=this._elementsPerBatch-1}return this._freepool[this._nextAvail--]},n.free=function(e){this._freepool[++this._nextAvail]=e},n.freeArray=function(e){this._freepool.length=this._nextAvail+1,Array.prototype.push.apply(this._freepool,e),this._nextAvail+=e.length},n.tryShrink=function(){if(this._nextAvail>>1>this._elementsPerBatch){if(this._dtor)for(var e=this._nextAvail>>1;e<=this._nextAvail;e++)this._dtor(this._freepool[e]);this._freepool.length=this._nextAvail>>1,this._nextAvail=this._freepool.length-1}},n.destroy=function(){var t=arguments.length>0?arguments[0]:null;t&&D(14100);var n=t||this._dtor;if(n)for(var i=0;i<=this._nextAvail;i++)n(this._freepool[i]);this._freepool.length=0,this._nextAvail=-1,e.prototype.destroy.call(this)},t}(jl)),Xl=e("RecyclePool",function(e){function t(t,n,i){var r;(r=e.call(this)||this)._fn=void 0,r._dtor=null,r._count=0,r._data=void 0,r._initSize=0,r._fn=t,r._dtor=i||null,r._data=new Array(n),r._initSize=n;for(var o=0;o<n;++o)r._data[o]=t();return r}$(t,e);var n=t.prototype;return n.reset=function(){this._count=0},n.resize=function(e){if(e>this._data.length)for(var t=this._data.length;t<e;++t)this._data[t]=this._fn()},n.add=function(){return this._count>=this._data.length&&this.resize(this._data.length<<1),this._data[this._count++]},n.destroy=function(){if(this._dtor)for(var t=0;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=0,this._count=0,e.prototype.destroy.call(this)},n.tryShrink=function(){if(this._data.length>>2>this._count){var e=Math.max(this._initSize,this._data.length>>1);if(this._dtor)for(var t=e;t<this._data.length;t++)this._dtor(this._data[t]);this._data.length=e}},n.removeAt=function(e){if(!(e>=this._count)){var t=this._count-1,n=this._data[e];this._data[e]=this._data[t],this._data[t]=n,this._count-=1}},Z(t,[{key:"length",get:function(){return this._count}},{key:"data",get:function(){return this._data}}]),t}(jl)),Yl=e("CachedArray",function(e){function t(t,n){var i;return(i=e.call(this)||this).array=void 0,i.length=0,i._compareFn=void 0,i._initSize=0,i.array=new Array(t),i._initSize=t,i.length=0,i._compareFn=void 0!==n?n:function(e,t){return e-t},i}$(t,e);var n=t.prototype;return n.push=function(e){this.array[this.length++]=e},n.pop=function(){return this.array[--this.length]},n.get=function(e){return this.array[e]},n.clear=function(){this.length=0},n.destroy=function(){this.length=0,this.array.length=0,e.prototype.destroy.call(this)},n.tryShrink=function(){this.array.length>>2>this.length&&(this.array.length=Math.max(this._initSize,this.array.length>>1))},n.sort=function(){this.array.length=this.length,this.array.sort(this._compareFn)},n.concat=function(e){for(var t=0;t<e.length;++t)this.array[this.length++]=e[t]},n.fastRemove=function(e){if(!(e>=this.length||e<0)){var t=--this.length;this.array[e]=this.array[t]}},n.indexOf=function(e){for(var t=0,n=this.length;t<n;++t)if(this.array[t]===e)return t;return-1},t}(jl));e("memop",Object.freeze({__proto__:null,Pool:ql,RecyclePool:Xl,CachedArray:Yl}));var Kl=it.fastRemoveAt;function Ql(){}var Zl=function(){function e(){this.callback=Ql,this.target=void 0,this.once=!1}var t=e.prototype;return t.set=function(e,t,n){this.callback=e||Ql,this.target=t,this.once=!!n},t.reset=function(){this.target=void 0,this.callback=Ql,this.once=!1},t.check=function(){return!(this.target instanceof ml&&!gl(this.target,!0))},e}(),Jl=new ql((function(){return new Zl}),32),$l=function(){function e(){this.callbackInfos=[],this.isInvoking=!1,this.containCanceled=!1}var t=e.prototype;return t.removeByCallback=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.callback===e&&(n.reset(),Jl.free(n),Kl(this.callbackInfos,t),--t)}},t.removeByTarget=function(e){for(var t=0;t<this.callbackInfos.length;++t){var n=this.callbackInfos[t];n&&n.target===e&&(n.reset(),Jl.free(n),Kl(this.callbackInfos,t),--t)}},t.cancel=function(e){var t=this.callbackInfos[e];t&&(t.reset(),this.isInvoking?this.callbackInfos[e]=null:Kl(this.callbackInfos,e),Jl.free(t)),this.containCanceled=!0},t.cancelAll=function(){for(var e=0;e<this.callbackInfos.length;e++){var t=this.callbackInfos[e];t&&(t.reset(),Jl.free(t),this.callbackInfos[e]=null)}this.containCanceled=!0},t.purgeCanceled=function(){for(var e=this.callbackInfos.length-1;e>=0;--e)this.callbackInfos[e]||Kl(this.callbackInfos,e);this.containCanceled=!1},t.clear=function(){this.cancelAll(),this.callbackInfos.length=0,this.isInvoking=!1,this.containCanceled=!1},e}(),eu=new ql((function(){return new $l}),16),tu=function(){function e(){this._callbackTable=Re(!0),this._offCallback=void 0}var t=e.prototype;return t.on=function(e,t,n,i){if(!this.hasEventListener(e,t,n)){var r=this._callbackTable[e];r||(r=this._callbackTable[e]=eu.alloc());var o=Jl.alloc();o.set(t,n,i),r.callbackInfos.push(o)}return t},t.hasEventListener=function(e,t,n){var i=this._callbackTable&&this._callbackTable[e];if(!i)return!1;var r=i.callbackInfos;if(!t){if(i.isInvoking){for(var o=0;o<r.length;++o)if(r[o])return!0;return!1}return r.length>0}for(var a=0;a<r.length;++a){var s=r[a];if(s&&s.check()&&s.callback===t&&s.target===n)return!0}return!1},t.removeAll=function(e){var t=typeof e;if("string"===t||"number"===t){var n=this._callbackTable&&this._callbackTable[e];n&&(n.isInvoking?n.cancelAll():(n.clear(),eu.free(n),delete this._callbackTable[e]))}else if(e)for(var i in this._callbackTable){var r=this._callbackTable[i];if(r.isInvoking)for(var o=r.callbackInfos,a=0;a<o.length;++a){var s=o[a];s&&s.target===e&&r.cancel(a)}else r.removeByTarget(e)}},t.off=function(e,t,n){var i,r=this._callbackTable&&this._callbackTable[e];if(r){var o=r.callbackInfos;if(t)for(var a=0;a<o.length;++a){var s=o[a];if(s&&s.callback===t&&s.target===n){r.cancel(a);break}}else this.removeAll(e)}null===(i=this._offCallback)||void 0===i||i.call(this)},t.emit=function(e,t,n,i,r,o){var a=this._callbackTable&&this._callbackTable[e];if(a){var s=!a.isInvoking;a.isInvoking=!0;for(var c=a.callbackInfos,l=0,u=c.length;l<u;++l){var h=c[l];if(h){var f=h.callback,_=h.target;h.once&&this.off(e,f,_),h.check()?_?f.call(_,t,n,i,r,o):f(t,n,i,r,o):this.off(e,f,_)}}s&&(a.isInvoking=!1,a.containCanceled&&a.purgeCanceled())}},t.clear=function(){for(var e in this._callbackTable){var t=this._callbackTable[e];t&&(t.clear(),eu.free(t),delete this._callbackTable[e])}},t._registerOffCallback=function(e){this._offCallback=e},e}();function nu(e){for(var t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._callbackTable=Re(!0),t}$(t,e);var n=t.prototype;return n.once=function(e,t,n){return this.on(e,t,n,!0)},n.targetOff=function(e){this.removeAll(e)},t}(e),n=tu.prototype,i=Object.getOwnPropertyNames(n).concat(Object.getOwnPropertySymbols(n)),r=0;r<i.length;++r){var o=i[r];if(!(o in t.prototype)){var a=Object.getOwnPropertyDescriptor(n,o);a&&Object.defineProperty(t.prototype,o,a)}}return t}var iu=e("EventTarget",nu((function(){})));u.EventTarget=iu;var ru,ou,au,su,cu,lu,uu,hu=new(function(){function e(){this._finalizationRegistry=null}var t=e.prototype;return t.registerGCObject=function(e){return e},t.unregisterGCObject=function(){},t.init=function(){},t.finalizationRegistryCallback=function(e){e.isValid&&e.destroy()},t.destroy=function(){},e}()),fu=mc("cc.GCObject")(ru=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return t=e.call.apply(e,[this].concat(i))||this,hu.registerGCObject(oe(t))||oe(t)}$(t,e);var n=t.prototype;return n.equals=function(e){return!!e&&e===this},n.destroy=function(){return hu.unregisterGCObject(this),e.prototype.destroy.call(this)},t}(ml))||ru;!function(e){e.UNKNOWN="unknown",e.WECHAT="wechat",e.ANDROID="androidbrowser",e.IE="ie",e.EDGE="edge",e.QQ="qqbrowser",e.MOBILE_QQ="mqqbrowser",e.UC="ucbrowser",e.UCBS="ucbs",e.BROWSER_360="360browser",e.BAIDU_APP="baiduboxapp",e.BAIDU="baidubrowser",e.MAXTHON="maxthon",e.OPERA="opera",e.OUPENG="oupeng",e.MIUI="miuibrowser",e.FIREFOX="firefox",e.SAFARI="safari",e.CHROME="chrome",e.LIEBAO="liebao",e.QZONE="qzone",e.SOUGOU="sogou",e.HUAWEI="huawei"}(ou||(ou={})),function(e){e.UNKNOWN="unknown",e.ENGLISH="en",e.CHINESE="zh",e.FRENCH="fr",e.ITALIAN="it",e.GERMAN="de",e.SPANISH="es",e.DUTCH="du",e.RUSSIAN="ru",e.KOREAN="ko",e.JAPANESE="ja",e.HUNGARIAN="hu",e.PORTUGUESE="pt",e.ARABIC="ar",e.NORWEGIAN="no",e.POLISH="pl",e.TURKISH="tr",e.UKRAINIAN="uk",e.ROMANIAN="ro",e.BULGARIAN="bg"}(au||(au={})),function(e){e[e.NONE=0]="NONE",e[e.LAN=1]="LAN",e[e.WWAN=2]="WWAN"}(su||(su={})),function(e){e.UNKNOWN="Unknown",e.IOS="iOS",e.ANDROID="Android",e.WINDOWS="Windows",e.LINUX="Linux",e.OSX="OS X",e.OHOS="OHOS"}(cu||(cu={})),function(e){e.UNKNOWN="UNKNOWN",e.EDITOR_PAGE="EDITOR_PAGE",e.EDITOR_CORE="EDITOR_CORE",e.MOBILE_BROWSER="MOBILE_BROWSER",e.DESKTOP_BROWSER="DESKTOP_BROWSER",e.WIN32="WIN32",e.ANDROID="ANDROID",e.IOS="IOS",e.MACOS="MACOS",e.OHOS="OHOS",e.WECHAT_GAME="WECHAT_GAME",e.BAIDU_MINI_GAME="BAIDU_MINI_GAME",e.XIAOMI_QUICK_GAME="XIAOMI_QUICK_GAME",e.ALIPAY_MINI_GAME="ALIPAY_MINI_GAME",e.BYTEDANCE_MINI_GAME="BYTEDANCE_MINI_GAME",e.OPPO_MINI_GAME="OPPO_MINI_GAME",e.VIVO_MINI_GAME="VIVO_MINI_GAME",e.HUAWEI_QUICK_GAME="HUAWEI_QUICK_GAME",e.COCOSPLAY="COCOSPLAY",e.LINKSURE_MINI_GAME="LINKSURE_MINI_GAME",e.QTT_MINI_GAME="QTT_MINI_GAME"}(lu||(lu={})),function(e){e.WEBP="WEBP",e.IMAGE_BITMAP="IMAGE_BITMAP",e.WEB_VIEW="WEB_VIEW",e.VIDEO_PLAYER="VIDEO_PLAYER",e.SAFE_AREA="SAFE_AREA",e.INPUT_TOUCH="INPUT_TOUCH",e.EVENT_KEYBOARD="EVENT_KEYBOARD",e.EVENT_MOUSE="EVENT_MOUSE",e.EVENT_TOUCH="EVENT_TOUCH",e.EVENT_ACCELEROMETER="EVENT_ACCELEROMETER"}(uu||(uu={}));var _u,pu,du,mu,vu=new(function(e){function t(){var t,n,i;(i=e.call(this)||this).networkType=void 0,i.isNative=void 0,i.isBrowser=void 0,i.isMobile=void 0,i.isLittleEndian=void 0,i.platform=void 0,i.language=void 0,i.nativeLanguage=void 0,i.os=void 0,i.osVersion=void 0,i.osMainVersion=void 0,i.browserType=void 0,i.browserVersion=void 0,i._battery=void 0,i._featureMap=void 0;var r,o=window.navigator,a=o.userAgent.toLowerCase();null===(t=o.getBattery)||void 0===t||t.call(o).then((function(e){i._battery=e})),i.networkType=su.LAN,i.isNative=!1,i.isBrowser=!0,i.isMobile=/mobile|android|iphone|ipad/.test(a),i.platform=i.isMobile?lu.MOBILE_BROWSER:lu.DESKTOP_BROWSER,i.isLittleEndian=(r=new ArrayBuffer(2),new DataView(r).setInt16(0,256,!0),256===new Int16Array(r)[0]);var s=o.language;i.nativeLanguage=s.toLowerCase(),s=(s=s||o.browserLanguage)?s.split("-")[0]:au.ENGLISH,i.language=s;var c=!1,l=!1,u="",h=0,f=/android\s*(\d+(?:\.\d+)*)/i.exec(a)||/android\s*(\d+(?:\.\d+)*)/i.exec(o.platform);f&&(c=!0,u=f[1]||"",h=parseInt(u)||0),(f=/(iPad|iPhone|iPod).*OS ((\d+_?){2,3})/i.exec(a))?(l=!0,u=f[2]||"",h=parseInt(u)||0):(/(iPhone|iPad|iPod)/.exec(o.platform)||"MacIntel"===o.platform&&o.maxTouchPoints&&o.maxTouchPoints>1)&&(l=!0,u="",h=0);var _=cu.UNKNOWN;-1!==o.appVersion.indexOf("Win")?_=cu.WINDOWS:l?_=cu.IOS:-1!==o.appVersion.indexOf("Mac")?_=cu.OSX:-1!==o.appVersion.indexOf("X11")&&-1===o.appVersion.indexOf("Linux")?_=cu.LINUX:c?_=cu.ANDROID:-1===o.appVersion.indexOf("Linux")&&-1===a.indexOf("ubuntu")||(_=cu.LINUX),i.os=_,i.osVersion=u,i.osMainVersion=h,i.browserType=ou.UNKNOWN;var p=/wechat|weixin|micromessenger/i.exec(a)||/mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|ucbs|360 aphone|360browser|baiduboxapp|baidubrowser|maxthon|mxbrowser|miuibrowser/i.exec(a)||/qq|qqbrowser|ucbrowser|ubrowser|edge|HuaweiBrowser/i.exec(a)||/chrome|safari|firefox|trident|opera|opr\/|oupeng/i.exec(a),d=p?p[0].toLowerCase():cu.UNKNOWN;("safari"===d&&c||"qq"===d&&/android.*applewebkit/i.test(a))&&(d=ou.ANDROID);var m={micromessenger:ou.WECHAT,wechat:ou.WECHAT,weixin:ou.WECHAT,trident:ou.IE,edge:ou.EDGE,"360 aphone":ou.BROWSER_360,mxbrowser:ou.MAXTHON,"opr/":ou.OPERA,ubrowser:ou.UC,huaweibrowser:ou.HUAWEI};i.browserType=m[d]||d,i.browserVersion="";var v=/(mqqbrowser|micromessenger|qqbrowser|sogou|qzone|liebao|maxthon|uc|ucbs|360 aphone|360|baiduboxapp|baidu|maxthon|mxbrowser|miui(?:.hybrid)?)(mobile)?(browser)?\/?([\d.]+)/i.exec(a);v||(v=/(qq|chrome|safari|firefox|trident|opera|opr\/|oupeng)(mobile)?(browser)?\/?([\d.]+)/i.exec(a)),i.browserVersion=v?v[4]:"";var g,y=document.createElement("canvas");y.getContext("2d");try{g=y.toDataURL("image/webp").startsWith("data:image/webp")}catch(e){g=!1}var x=!1;"undefined"!=typeof createImageBitmap&&"undefined"!=typeof Blob&&(y.width=y.height=2,createImageBitmap(y,{}).then((function(e){x=!0,null==e||e.close()})).catch((function(){})));var S=void 0!==document.documentElement.ontouchstart||void 0!==document.ontouchstart,T=void 0!==document.documentElement.onmouseup;return i._featureMap=((n={})[uu.WEBP]=g,n[uu.IMAGE_BITMAP]=x,n[uu.WEB_VIEW]=!0,n[uu.VIDEO_PLAYER]=!0,n[uu.SAFE_AREA]=!1,n[uu.INPUT_TOUCH]=S,n[uu.EVENT_KEYBOARD]=void 0!==document.documentElement.onkeyup,n[uu.EVENT_MOUSE]=T,n[uu.EVENT_TOUCH]=S||T,n[uu.EVENT_ACCELEROMETER]=void 0!==window.DeviceMotionEvent||void 0!==window.DeviceOrientationEvent,n),i._registerEvent(),i}$(t,e);var n=t.prototype;return n._registerEvent=function(){var e,t=this;e=void 0!==document.hidden?"hidden":void 0!==document.mozHidden?"mozHidden":void 0!==document.msHidden?"msHidden":void 0!==document.webkitHidden?"webkitHidden":"hidden";var n=!1,i=function(){n||(n=!0,t.emit("hide"))},r=function(e,i,r,o,a){n&&(n=!1,t.emit("show",e,i,r,o,a))};if(e)for(var o=["visibilitychange","mozvisibilitychange","msvisibilitychange","webkitvisibilitychange","qbrowserVisibilityChange"],a=0;a<o.length;a++)document.addEventListener(o[a],(function(t){var n=document[e];(n=n||t.hidden)?i():r()}));else window.addEventListener("blur",i),window.addEventListener("focus",r);window.navigator.userAgent.indexOf("MicroMessenger")>-1&&(window.onfocus=r),"onpageshow"in window&&"onpagehide"in window&&(window.addEventListener("pagehide",i),window.addEventListener("pageshow",r),document.addEventListener("pagehide",i),document.addEventListener("pageshow",r))},n.hasFeature=function(e){return this._featureMap[e]},n.getBatteryLevel=function(){return this._battery?this._battery.level:1},n.triggerGC=function(){},n.openURL=function(e){window.open(e)},n.now=function(){return Date.now?Date.now():+new Date},n.restartJSVM=function(){},n.close=function(){this.emit("close"),window.close()},t}(iu)),gu=/(\.[^\.\/\?\\]*)(\?.*)?$/,yu=/((.*)(\/|\\|\\\\))?(.*?\..*$)?/,xu=/[^\.\/]+\/\.\.\//;function Su(){for(var e="",t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(var r=0,o=n;r<o.length;r++){var a=o[r];e=(e+(""===e?"":"/")+a).replace(/(\/|\\\\)$/,"")}return e}function Tu(e){var t=gu.exec(e);return t?t[1]:""}function bu(e){if(e){var t=e.lastIndexOf(".");if(-1!==t)return e.substring(0,t)}return e}function Eu(e,t){var n=e.indexOf("?");n>0&&(e=e.substring(0,n));var i=/(\/|\\)([^\/\\]+)$/g.exec(e.replace(/(\/|\\)$/,""));if(!i)return e;var r=i[2];return t&&e.substring(e.length-t.length).toLowerCase()===t.toLowerCase()?r.substring(0,r.length-t.length):r}function Cu(e){var t=yu.exec(e);return t?t[2]:""}function Au(e,t){t=t||"";var n=e.indexOf("?"),i="";return n>0&&(i=e.substring(n),e=e.substring(0,n)),(n=e.lastIndexOf("."))<0?e+t+i:e.substring(0,n)+t+i}function wu(e,t,n){if(0===t.indexOf("."))return Au(e,t);var i=e.indexOf("?"),r="",o=n?Tu(e):"";return i>0&&(r=e.substring(i),e=e.substring(0,i)),i=(i=e.lastIndexOf("/"))<=0?0:i+1,e.substring(0,i)+t+o+r}function Pu(e){var t=e=String(e);do{t=e,e=e.replace(xu,"")}while(t.length!==e.length);return e}function Ru(e){return e.replace(/[\/\\]$/,"")}function Iu(){return vu.os===cu.WINDOWS?"\\":"/"}e("path",Object.freeze({__proto__:null,join:Su,extname:Tu,mainFileName:bu,basename:Eu,dirname:Cu,changeExtname:Au,changeBasename:wu,_normalize:Pu,stripSep:Ru,getSeperator:Iu}));var Du,Ou,Mu,Nu=e("Asset",mc("cc.Asset")((mu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).loaded=!0,ce(t,"_native",du,oe(t)),t._nativeUrl="",t._file=null,t._ref=0,Object.defineProperty(oe(t),"_uuid",{value:"",writable:!0}),t}$(t,e),t.deserialize=function(e){return u.deserialize(e)};var n=t.prototype;return n.toString=function(){return this.nativeUrl},n.serialize=function(){},n._setRawAsset=function(e,t){void 0===t&&(t=!0),this._native=!1!==t?e||"":"/"+e},n.addRef=function(){return this._ref++,this},n.decRef=function(e){return void 0===e&&(e=!0),this._ref>0&&this._ref--,e&&u.assetManager._releaseManager.tryRelease(this),this},n.onLoaded=function(){},n.initDefault=function(e){e&&(this._uuid=e),this.isDefault=!0},n.validate=function(){return!0},n.destroy=function(){return E(F(12101,this._uuid)),e.prototype.destroy.call(this)},Z(t,[{key:"nativeUrl",get:function(){if(!this._nativeUrl){if(!this._native)return"";var e=this._native;if(47===e.charCodeAt(0))return e.slice(1);46===e.charCodeAt(0)?this._nativeUrl=Ul(this._uuid,{nativeExt:e,isNative:!0}):this._nativeUrl=Ul(this._uuid,{__nativeName__:e,nativeExt:Tu(e),isNative:!0})}return this._nativeUrl}},{key:"_nativeAsset",get:function(){return this._file},set:function(e){this._file=e}},{key:"_nativeDep",get:function(){if(this._native)return{__isNative__:!0,uuid:this._uuid,ext:this._native}}},{key:"refCount",get:function(){return this._ref}}]),t}(nu(fu)),du=le((pu=mu).prototype,"_native",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),le(pu.prototype,"_nativeAsset",[xc],Object.getOwnPropertyDescriptor(pu.prototype,"_nativeAsset"),pu.prototype),_u=pu))||_u);Nu.prototype.createNode=null,u.Asset=Nu;var Lu=e("Script",mc("cc.Script")(Du=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(Nu))||Du);u._Script=Lu;var Bu=e("JavaScript",mc("cc.JavaScript")(Ou=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(Lu))||Ou);u._JavaScript=Bu;var Fu,zu,Uu,ku,Gu,Hu,Vu,Wu,ju,qu,Xu,Yu=e("TypeScript",mc("cc.TypeScript")(Mu=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(Lu))||Mu);u._TypeScript=Yu;var Ku,Qu,Zu,Ju,$u=new ve("Comp"),eh=ml.Flags.IsOnLoadCalled,th=e("Component",(Fu=mc("cc.Component"),zu=Bc(),Uu=Zc(Lu),ku=Fc(),Fu((Xu=qu=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"node",Vu,oe(t)),ce(t,"_enabled",Wu,oe(t)),ce(t,"__prefab",ju,oe(t)),t._sceneGetter=null,t._id=$u.getNewId(),t}$(t,e);var n=t.prototype;return n._getRenderScene=function(){return this._sceneGetter?this._sceneGetter():this.node.scene.renderScene},n.addComponent=function(e){return this.node.addComponent(e)},n.getComponent=function(e){return this.node.getComponent(e)},n.getComponents=function(e){return this.node.getComponents(e)},n.getComponentInChildren=function(e){return this.node.getComponentInChildren(e)},n.getComponentsInChildren=function(e){return this.node.getComponentsInChildren(e)},n.destroy=function(){return!!e.prototype.destroy.call(this)&&(this._enabled&&this.node.activeInHierarchy&&u.director._compScheduler.disableComp(this),!0)},n._onPreDestroy=function(){this.unscheduleAllCallbacks(),u.director._nodeActivator.destroyComp(this),this.node._removeComponent(this)},n._instantiate=function(e){return e||(e=u.instantiate._clone(this,this)),e&&(e.node=null),e},n.schedule=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=u.macro.REPEAT_FOREVER),void 0===i&&(i=0),B(e,1619),B((t=t||0)>=0,1620),n=Number.isNaN(n)?u.macro.REPEAT_FOREVER:n,i=i||0;var r=u.director.getScheduler(),o=r.isTargetPaused(this);r.schedule(e,this,t,n,i,o)},n.scheduleOnce=function(e,t){void 0===t&&(t=0),this.schedule(e,0,0,t)},n.unschedule=function(e){e&&u.director.getScheduler().unschedule(e,this)},n.unscheduleAllCallbacks=function(){u.director.getScheduler().unscheduleAllForTarget(this)},Z(t,[{key:"name",get:function(){if(this._name)return this._name;var e=Ie(this),t=e.lastIndexOf(".");return t>=0&&(e=e.slice(t+1)),this.node?this.node.name+"<"+e+">":e},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"__scriptAsset",get:function(){return null}},{key:"enabled",get:function(){return this._enabled},set:function(e){if(this._enabled!==e&&(this._enabled=e,this.node.activeInHierarchy)){var t=u.director._compScheduler;e?t.enableComp(this):t.disableComp(this)}}},{key:"enabledInHierarchy",get:function(){return this._enabled&&this.node&&this.node.activeInHierarchy}},{key:"_isOnLoadCalled",get:function(){return this._objFlags&eh}}]),t}(ml),qu.system=null,le((Hu=Xu).prototype,"__scriptAsset",[zu,Uu,ku,qc],Object.getOwnPropertyDescriptor(Hu.prototype,"__scriptAsset"),Hu.prototype),Vu=le(Hu.prototype,"node",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Wu=le(Hu.prototype,"_enabled",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),ju=le(Hu.prototype,"__prefab",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gu=Hu))||Gu)),nh=th.prototype;nh.update=null,nh.lateUpdate=null,nh.__preload=null,nh.onLoad=null,nh.start=null,nh.onEnable=null,nh.onDisable=null,nh.onDestroy=null,nh.onFocusInEditor=null,nh.onLostFocusInEditor=null,nh.resetInEditor=null,nh._getLocalBounds=null,nh.onRestore=null,th._requireComponent=null,th._executionOrder=0,Ce(th,"_registerEditorProps",(function(e,t){var n=t.requireComponent;n&&(Array.isArray(n)&&(n=n.filter(Boolean)),e._requireComponent=n);var i=t.executionOrder;i&&"number"==typeof i&&(e._executionOrder=i)})),u.Component=th;var ih,rh=e("MissingScript",mc("cc.MissingScript")(Ku=Ic()((Ju=function(e){function t(){var t;return ce(t=e.call(this)||this,"_$erialized",Zu,oe(t)),t}return $(t,e),t.safeFindClass=function(e){var t=$e(e);if(t)return t;u.deserialize.reportMissingClass(e)},t.prototype.onLoad=function(){D(4600,this.node.name)},t}(th),Zu=le((Qu=Ju).prototype,"_$erialized",[Tc,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ku=Qu))||Ku)||Ku);u._MissingScript=rh;try{var oh=rh.__values__;0!==oh.length&&"_$erialized"===oh[oh.length-1]||(T("The '_$erialized' prop in MissingScript is missing. Please contact jare."),T("    Error props: ['"+oh+"']"))}catch(Ko){T("Error when checking MissingScript 5, "+Ko)}!function(e){e[e.PORTRAIT=1]="PORTRAIT",e[e.PORTRAIT_UPSIDE_DOWN=2]="PORTRAIT_UPSIDE_DOWN",e[e.LANDSCAPE_LEFT=4]="LANDSCAPE_LEFT",e[e.LANDSCAPE_RIGHT=8]="LANDSCAPE_RIGHT",e[e.LANDSCAPE=12]="LANDSCAPE",e[e.AUTO=13]="AUTO"}(ih||(ih={}));var ah,sh={auto:ih.AUTO,landscape:ih.LANDSCAPE,portrait:ih.PORTRAIT};!function(e){e[e.Unknown=0]="Unknown",e[e.SubFrame=1]="SubFrame",e[e.BrowserWindow=2]="BrowserWindow",e[e.Fullscreen=3]="Fullscreen"}(ah||(ah={}));var ch=new(function(e){function t(){var t,n,i,r,o,a;(t=e.call(this)||this).isFrameRotated=!1,t.handleResizeEvent=!0,t._gameFrame=void 0,t._gameContainer=void 0,t._gameCanvas=void 0,t._isProportionalToFrame=!1,t._cachedFrameStyle={width:"0px",height:"0px"},t._cachedContainerStyle={width:"0px",height:"0px"},t._cbToUpdateFrameBuffer=void 0,t._supportFullScreen=!1,t._touchEventName=void 0,t._onFullscreenChange=void 0,t._onFullscreenError=void 0,t._orientationChangeTimeoutId=-1,t._cachedFrameSize=new ni(0,0),t._exactFitScreen=!1,t._fn={},t._fnGroup=[["requestFullscreen","exitFullscreen","fullscreenchange","fullscreenEnabled","fullscreenElement","fullscreenerror"],["requestFullScreen","exitFullScreen","fullScreenchange","fullScreenEnabled","fullScreenElement","fullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitfullscreenchange","webkitIsFullScreen","webkitCurrentFullScreenElement","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozfullscreenchange","mozFullScreen","mozFullScreenElement","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","MSFullscreenChange","msFullscreenEnabled","msFullscreenElement","msfullscreenerror"]],t._resolutionScale=1,t._orientation=ih.AUTO,t._gameFrame=document.getElementById("GameDiv"),t._gameContainer=document.getElementById("Cocos3dGameContainer"),t._gameCanvas=document.getElementById("GameCanvas"),t._gameFrame||(t._gameFrame=document.createElement("div"),t._gameFrame.setAttribute("id","GameDiv"),null===(n=t._gameCanvas)||void 0===n||null===(i=n.parentNode)||void 0===i||i.insertBefore(t._gameFrame,t._gameCanvas),t._gameFrame.appendChild(t._gameCanvas)),t._gameContainer||(t._gameContainer=document.createElement("div"),t._gameContainer.setAttribute("id","Cocos3dGameContainer"),null===(r=t._gameCanvas)||void 0===r||null===(o=r.parentNode)||void 0===o||o.insertBefore(t._gameContainer,t._gameCanvas),t._gameContainer.appendChild(t._gameCanvas));for(var s=t._fnGroup,c=0;c<s.length;c++)if(a=s[c],void 0!==document[a[1]]){for(var l=0;l<a.length;l++)t._fn[s[0][l]]=a[l];break}return t._supportFullScreen=void 0!==t._fn.requestFullscreen,t._touchEventName="ontouchstart"in window?"touchend":"mousedown",t._registerEvent(),t}$(t,e);var n=t.prototype;return n.init=function(e,t){this._cbToUpdateFrameBuffer=t,this.orientation=sh[e.configOrientation],this._exactFitScreen=e.exactFitScreen,this._resizeFrame()},n.requestFullScreen=function(){var e=this;return new Promise((function(t,n){e.isFullScreen?t():(e._cachedFrameSize=e.windowSize,e._doRequestFullScreen().then((function(){t()})).catch((function(){var i=e._getFullscreenTarget();i?i.addEventListener(e._touchEventName,(function(){e._doRequestFullScreen().then((function(){t()})).catch(n)}),{once:!0,capture:!0}):n(new Error("Cannot access fullscreen target"))})))}))},n.exitFullScreen=function(){var e=this;return new Promise((function(t,n){var i=document[e._fn.exitFullscreen]();window.Promise&&i instanceof Promise?i.then((function(){e.windowSize=e._cachedFrameSize,t()})).catch(n):(e.windowSize=e._cachedFrameSize,t())}))},n._registerEvent=function(){var e=this;document.addEventListener(this._fn.fullscreenerror,(function(){var t;null===(t=e._onFullscreenError)||void 0===t||t.call(e)})),window.addEventListener("resize",(function(){e.handleResizeEvent&&e._resizeFrame()})),"function"==typeof window.matchMedia&&function t(){var n,i,r=window.devicePixelRatio;null===(n=window.matchMedia("(resolution: "+r+"dppx)"))||void 0===n||null===(i=n.addEventListener)||void 0===i||i.call(n,"change",(function(){e.emit("window-resize"),t()}),{once:!0})}(),window.addEventListener("orientationchange",(function(){-1!==e._orientationChangeTimeoutId&&clearTimeout(e._orientationChangeTimeoutId),e._orientationChangeTimeoutId=setTimeout((function(){e.handleResizeEvent&&(e._updateFrameState(),e._resizeFrame(),e.emit("orientation-change"),e._orientationChangeTimeoutId=-1)}),200)})),document.addEventListener(this._fn.fullscreenchange,(function(){var t;null===(t=e._onFullscreenChange)||void 0===t||t.call(e),e.emit("fullscreen-change")}))},n._convertToSizeInCssPixels=function(e){var t=e.clone(),n=this.devicePixelRatio;return t.width/=n,t.height/=n,t},n._resizeFrame=function(e){if(this._gameFrame){if(this._gameFrame.style.display="flex",this._gameFrame.style["justify-content"]="center",this._gameFrame.style["align-items"]="center",this._windowType===ah.SubFrame){if(!e)return void this._updateContainer();this._gameFrame.style.width=e.width+"px",this._gameFrame.style.height=e.height+"px"}else{var t=window.innerWidth,n=window.innerHeight;this.isFrameRotated?(this._gameFrame.style["-webkit-transform"]="rotate(90deg)",this._gameFrame.style.transform="rotate(90deg)",this._gameFrame.style["-webkit-transform-origin"]="0px 0px 0px",this._gameFrame.style.transformOrigin="0px 0px 0px",this._gameFrame.style.margin="0 0 0 "+t+"px",this._gameFrame.style.width=n+"px",this._gameFrame.style.height=t+"px"):(this._gameFrame.style["-webkit-transform"]="rotate(0deg)",this._gameFrame.style.transform="rotate(0deg)",this._gameFrame.style.margin="0px auto",this._gameFrame.style.width=t+"px",this._gameFrame.style.height=n+"px")}this._updateContainer()}},n._getFullscreenTarget=function(){var e=this._windowType;return e===ah.Fullscreen?document[this._fn.fullscreenElement]:e===ah.SubFrame?this._gameFrame:document.body},n._doRequestFullScreen=function(){var e=this;return new Promise((function(t,n){if(e._supportFullScreen){var i=e._getFullscreenTarget();if(i){e._onFullscreenChange=void 0,e._onFullscreenError=void 0;var r=i[e._fn.requestFullscreen]();window.Promise&&r instanceof Promise?r.then(t).catch(n):(e._onFullscreenChange=t,e._onFullscreenError=n)}else n(new Error("Cannot access fullscreen target"))}else n(new Error("fullscreen is not supported"))}))},n._updateFrameState=function(){var e=this.orientation,t=window.innerWidth>window.innerHeight;this.isFrameRotated=vu.isMobile&&(t&&e===ih.PORTRAIT||!t&&e===ih.LANDSCAPE)},n._updateContainer=function(){if(this._gameContainer){if(this.isProportionalToFrame){if(!this._gameFrame)return void D(9201);var e,t,n=u.view.getDesignResolutionSize(),i=this._gameFrame,r=i.clientWidth,o=i.clientHeight,a=n.width,s=n.height,c=r/a,l=o/s,h=this._gameContainer.style;c<l?(e=r,t=s*c):(e=a*l,t=o),h.width=e+"px",h.height=t+"px"}else{var f=this._gameContainer.style;f.width="100%",f.height="100%"}!this._gameFrame||this._cachedFrameStyle.width===this._gameFrame.style.width&&this._cachedFrameStyle.height===this._gameFrame.style.height&&this._cachedContainerStyle.width===this._gameContainer.style.width&&this._cachedContainerStyle.height===this._gameContainer.style.height||(this.emit("window-resize"),this._cachedFrameStyle.width=this._gameFrame.style.width,this._cachedFrameStyle.height=this._gameFrame.style.height,this._cachedContainerStyle.width=this._gameContainer.style.width,this._cachedContainerStyle.height=this._gameContainer.style.height)}else D(9201)},Z(t,[{key:"supportFullScreen",get:function(){return this._supportFullScreen}},{key:"isFullScreen",get:function(){return!!this._supportFullScreen&&!!document[this._fn.fullscreenElement]}},{key:"devicePixelRatio",get:function(){var e;return Math.min(null!==(e=window.devicePixelRatio)&&void 0!==e?e:1,2)}},{key:"windowSize",get:function(){var e=this._windowSizeInCssPixels,t=this.devicePixelRatio;return e.width*=t,e.height*=t,e},set:function(e){this._windowType===ah.SubFrame?this._resizeFrame(this._convertToSizeInCssPixels(e)):D(9202)}},{key:"resolution",get:function(){var e=this.windowSize,t=this.resolutionScale;return new ni(e.width*t,e.height*t)}},{key:"resolutionScale",get:function(){return this._resolutionScale},set:function(e){var t;e!==this._resolutionScale&&(this._resolutionScale=e,null===(t=this._cbToUpdateFrameBuffer)||void 0===t||t.call(this))}},{key:"orientation",get:function(){return this._orientation},set:function(e){this._orientation!==e&&(this._orientation=e,this._updateFrameState())}},{key:"safeAreaEdge",get:function(){return{top:0,bottom:0,left:0,right:0}}},{key:"isProportionalToFrame",get:function(){return this._isProportionalToFrame},set:function(e){this._isProportionalToFrame!==e&&(this._isProportionalToFrame=e,this._updateContainer())}},{key:"_windowSizeInCssPixels",get:function(){if(this.isProportionalToFrame)return this._gameContainer?new ni(this._gameContainer.clientWidth,this._gameContainer.clientHeight):(D(9201),new ni(0,0));var e,t,n;switch(this._windowType){case ah.SubFrame:return this._gameFrame?new ni(this._gameFrame.clientWidth,this._gameFrame.clientHeight):(D(9201),new ni(0,0));case ah.Fullscreen:return e=this._getFullscreenTarget(),t=this.isFrameRotated?e.clientHeight:e.clientWidth,n=this.isFrameRotated?e.clientWidth:e.clientHeight,new ni(t,n);case ah.BrowserWindow:return t=this.isFrameRotated?window.innerHeight:window.innerWidth,n=this.isFrameRotated?window.innerWidth:window.innerHeight,new ni(t,n);case ah.Unknown:default:return new ni(0,0)}}},{key:"_windowType",get:function(){return this.isFullScreen?ah.Fullscreen:this._gameFrame?this._exactFitScreen?ah.BrowserWindow:ah.SubFrame:(D(9201),ah.Unknown)}}]),t}(iu)),lh=function(){function e(){}var t=e.prototype;return t._init=function(e){ch.init(e,(function(){var e,t=u.director;(null===(e=t.root)||void 0===e?void 0:e.pipeline)?t.root.pipeline.pipelineSceneData.shadingScale=ch.resolutionScale:D(1220)}))},t.fullScreen=function(){return ch.isFullScreen},t.requestFullScreen=function(e,t,n){return arguments.length>0&&D(1400,"screen.requestFullScreen(element, onFullScreenChange?, onFullScreenError?)","screen.requestFullScreen(): Promise"),ch.requestFullScreen().then((function(){null==t||t()})).catch((function(e){console.error(e),null==n||n()}))},t.exitFullScreen=function(){return ch.exitFullScreen()},t.autoFullScreen=function(e,t){var n;null===(n=this.requestFullScreen(e,t))||void 0===n||n.catch((function(){}))},t.disableAutoFullScreen=function(){},Z(e,[{key:"devicePixelRatio",get:function(){return ch.devicePixelRatio}},{key:"windowSize",get:function(){return ch.windowSize},set:function(e){ch.windowSize=e}},{key:"resolution",get:function(){return ch.resolution}},{key:"supportsFullScreen",get:function(){return ch.supportFullScreen}}]),e}(),uh=e("screen",new lh);u.screen=uh;var hh=e("sys",{Feature:uu,hasFeature:function(e){return vu.hasFeature(e)},NetworkType:su,Language:au,OS:cu,Platform:lu,BrowserType:ou,isNative:vu.isNative,isBrowser:vu.isBrowser,isMobile:vu.isMobile,isLittleEndian:vu.isLittleEndian,platform:vu.platform,language:vu.language,languageCode:vu.nativeLanguage,os:vu.os,osVersion:vu.osVersion,osMainVersion:vu.osMainVersion,browserType:vu.browserType,browserVersion:vu.browserVersion,windowPixelResolution:uh.windowSize,capabilities:{canvas:!0,opengl:!0,webp:vu.hasFeature(uu.WEBP),imageBitmap:vu.hasFeature(uu.IMAGE_BITMAP),touches:vu.hasFeature(uu.INPUT_TOUCH),mouse:vu.hasFeature(uu.EVENT_MOUSE),keyboard:vu.hasFeature(uu.EVENT_KEYBOARD),accelerometer:vu.hasFeature(uu.EVENT_ACCELEROMETER)},localStorage:{},getNetworkType:function(){return vu.networkType},getBatteryLevel:function(){return vu.getBatteryLevel()},garbageCollect:function(){vu.triggerGC()},isObjectValid:function(e){return null!=e},dump:function(){var e="";e+="isMobile : "+this.isMobile+"\r\n",e+="language : "+this.language+"\r\n",e+="browserType : "+this.browserType+"\r\n",e+="browserVersion : "+this.browserVersion+"\r\n",e+="capabilities : "+JSON.stringify(this.capabilities)+"\r\n",e+="os : "+this.os+"\r\n",e+="osVersion : "+this.osVersion+"\r\n",e+="platform : "+this.platform+"\r\n",x(e+="Using "+(u.game.renderType===u.game.RENDER_TYPE_WEBGL?"WEBGL":"CANVAS")+" renderer.\r\n")},openURL:function(e){vu.openURL(e)},now:function(){return vu.now()},restartVM:function(){vu.restartJSVM()},getSafeAreaRect:function(){var e=u.view,t=ch.safeAreaEdge,n=ch.windowSize,i=new Kn(t.left,t.bottom),r=new Kn(n.width-t.right,n.height-t.top);e._convertToUISpace(i),e._convertToUISpace(r);var o=i.x,a=i.y,s=r.x-i.x,c=r.y-i.y;return new ri(o,a,s,c)}});!function(){try{var e=hh.localStorage=window.localStorage;e.setItem("storage",""),e.removeItem("storage"),e=null}catch(e){var t=function(){D(5200)};hh.localStorage={getItem:t,setItem:t,clear:t,removeItem:t}}hh.__isWebIOS14OrIPadOS14Env=(hh.os===cu.IOS||hh.os===cu.OSX)&&vu.isBrowser&&/(OS 14)|(Version\/14)/.test(window.navigator.userAgent)}(),u.sys=hh;var fh=e("serializeTag",Symbol("[[Serialize]]")),_h=e("deserializeTag",Symbol("[[Deserialize]]")),ph=function(){function e(e,t){this._document=void 0,this._chunks=void 0,this._document=e,this._chunks=t}return Z(e,[{key:"document",get:function(){return this._document}},{key:"chunks",get:function(){return this._chunks}}]),e}();function dh(e){var t=e;return{chunks:t.chunks,document:t.document}}function mh(e){if(e.length<16)throw new vh(F(13102));var t=new DataView(e.buffer,e.byteOffset,e.byteLength);if(1313817411!==t.getUint32(0,!0))throw new vh(F(13100));var n=t.getUint32(4,!0);if(1!==n)throw new vh(F(13101,n));if(t.getUint32(8,!0)!==t.byteLength)throw new vh(F(13102));var i=12,r=t.getUint32(i,!0);i+=4;var o=new Uint8Array(t.buffer,i+t.byteOffset,r);i+=r;var a,s=function(e){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(e);if("Buffer"in globalThis)return globalThis.Buffer.from(e.buffer,e.byteOffset,e.byteLength).toString();throw new Error(F(13104))}(o);try{a=JSON.parse(s)}catch(e){throw new vh(e)}for(var c=[];i<t.byteLength;){i%8!=0&&(i+=8-i%8);var l=t.getUint32(i,!0);i+=4,c.push(new Uint8Array(t.buffer,i+t.byteOffset,l)),i+=l}if(i!==t.byteLength)throw new vh(F(13102));return new ph(a,c)}var vh=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(re(Error));function gh(e,t,n,i,r){if(t instanceof u.ValueType){r||e.push("if(prop){");var o=Ie(t);e.push("s._deserializeFastDefinedObject(o"+n+",prop,"+o+");"),r||e.push("}else o"+n+"=null;")}else e.push("\nif (prop) {\n    s._deserializeAndAssignField(o, prop, "+i+");\n} else {\n    o"+n+"=null;\n}\n")}!function(){function e(){this._viewOrPaddings=[],this._length=0}var t=e.prototype;t.alignAs=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;return this._viewOrPaddings.push(n),this._length+=n,n}}return 0},t.append=function(e){var t=this._length;return this._viewOrPaddings.push(e),this._length+=e.byteLength,t},t.get=function(){var e=new Uint8Array(this._length),t=0;return this._viewOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n.buffer,n.byteOffset,n.byteLength),t),t+=n.byteLength)})),e},Z(e,[{key:"byteLength",get:function(){return this._length}}])}(),u.internal.parseCCONJson=dh,u.internal.decodeCCONBinary=mh,u.internal.CCON=ph;var yh="$_$default",xh="$_$formerlySerializedAs",Sh=function(e){function t(){return e.call(this,(function(e){e.clear()}),1)||this}return $(t,e),t.prototype.get=function(e,t,n,i,r){var o=this._get();return o?(o.reset(e,t,n,i,r),o):new Th(e,t,n,i,r)},t}(nt),Th=function(){function e(e,t,n,i){this.deserializedList=void 0,this.deserializedData=void 0,this._ignoreEditorOnly=void 0,this.result=e,this.customEnv=i,this.deserializedList=[],this.deserializedData=null,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced}var t=e.prototype;return t.reset=function(e,t,n,i){this.result=e,this.customEnv=i,this._classFinder=t,this._reportMissingClass=n,this._onDereferenced=null==t?void 0:t.onDereferenced},t.clear=function(){this.result=null,this.customEnv=null,this.deserializedList.length=0,this.deserializedData=null,this._classFinder=null,this._reportMissingClass=null,this._onDereferenced=null},t.deserialize=function(e){var t,n=!1;e instanceof ph?(n=!0,t=e.document,e.chunks.length>0&&(e.chunks.length,this._mainBinChunk=e.chunks[0])):t=e,this._serializedData=t,this._context={fromCCON:n};var i=Array.isArray(t)?t[0]:t;return this.deserializedData=this._deserializeObject(i,0),this._serializedData=void 0,this._mainBinChunk=void 0,this._context=void 0,this.deserializedData},t._deserializeObject=function(e,t,n,i){switch(e.__type__){case"TypedArray":return this._deserializeTypedArrayView(e);case"TypedArrayRef":return this._deserializeTypedArrayViewRef(e);default:return e.__type__?this._deserializeTypeTaggedObject(e,t,n,i):Array.isArray(e)?this._deserializeArray(e):this._deserializePlainObject(e)}},t._deserializeTypedArrayView=function(e){return globalThis[e.ctor].from(e.array)},t._deserializeTypedArrayViewRef=function(e){var t=e.offset,n=e.length,i=e.ctor;return new globalThis[i](this._mainBinChunk.buffer,this._mainBinChunk.byteOffset+t,n)},t._deserializeArray=function(e){for(var t,n=new Array(e.length),i=0;i<e.length;i++)"object"==typeof(t=e[i])&&t?this._deserializeAndAssignField(n,t,""+i)&&(n[i]=null):n[i]=t;return n},t._deserializePlainObject=function(e){var t={};return this._fillPlainObject(t,e),t},t._deserializeTypeTaggedObject=function(e,t,n,i){var r=this,o=e.__type__,a=this._classFinder(o,e,n,i);if(!a)return this._classFinder===$e&&this._reportMissingClass(o),null;var s=function(e){var n=new e;return t>=0&&(r.deserializedList[t]=n),n}(a);return this._deserializeInto(e,s,a),s},t._deserializeInto=function(e,t,n,i){void 0===i&&(i=!1),i||!t[_h]?t._deserialize?t._deserialize(e.content,this):u.Class._isCCClass(n)?this._deserializeFireClass(t,e,n):this._deserializeFastDefinedObject(t,e,n):this._runCustomizedDeserialize(e,t,n)},t._runCustomizedDeserialize=function(e,t,n){var i=this,r={readProperty:function(t){var n=e[t];return"object"==typeof n&&n?i._deserializeObjectField(n):n},readThis:function(){i._deserializeInto(e,t,n,!0)},readSuper:function(){var r=He(n);r&&i._deserializeInto(e,t,r)}};t[_h](r,this._context)},t._deserializeFireClass=function(e,t,n){var i;if(n.hasOwnProperty("__deserialize__"))i=n.__deserialize__;else{i=function(e,t){for(var n=Dt(t),i=t.__values__,r=["var prop;"],o=_t.test(tt(t)),a=0;a<i.length;a++){var s=i[a],c=void 0,l=void 0;en.IDENTIFIER_RE.test(s)?(l='"'+s+'"',c="."+s):c="["+(l=en.escapeForJS(s))+"]";var h=c;if(n[s+xh]){var f=n[s+xh];h=en.IDENTIFIER_RE.test(f)?"."+f:"["+en.escapeForJS(f)+"]"}r.push("prop=d"+h+";"),r.push('if(typeof prop!=="undefined"){');var _=en.getDefault(n[s+yh]);if(o){var p=void 0,d=n[s+"$_$type"];if(void 0===_&&d)p=d instanceof Mt;else{var m=typeof _;p="string"===m||"number"===m||"boolean"===m}p?r.push("o"+c+"=prop;"):gh(r,_,c,l,!0)}else r.push('if(typeof prop!=="object"){o'+c+"=prop;}else{"),gh(r,_,c,l,!1),r.push("}");r.push("}")}return(u.js.isChildClassOf(t,u._BaseNode)||u.js.isChildClassOf(t,u.Component))&&r.push("d._id&&(o._id=d._id);"),"_$erialized"===i[i.length-1]&&(r.push("o._$erialized=JSON.parse(JSON.stringify(d));"),r.push("s._fillPlainObject(o._$erialized,d);")),Function("s","o","d","k",r.join(""))}(0,n);try{if(n===rh){var r=n.__values__;0!==r.length&&"_$erialized"===r[r.length-1]||(T("The '_$erialized' prop of MissingScript is missing. Will force the raw data to be save."),T("    Error props: ['"+r+"']. Please contact jare."));var o=i;i=function(e,t,n,i){try{JSON.parse(JSON.stringify(n._$erialized))||T("Unable to load previously serialized data. "+JSON.stringify(n))}catch(e){T("Error when checking MissingScript 7, "+e)}o(e,t,n,i)}}}catch(e){T("Error when checking MissingScript 6, "+e)}Ce(n,"__deserialize__",i,!0)}i(this,e,t,n)},t._deserializeAndAssignField=function(e,t,n){var i=t.__id__;if("number"==typeof i){var r=this.deserializedList[i];if(r)e[n]=r;else{var o,a=this._serializedData[i];e[n]=this._deserializeObject(a,i,void 0,n),null===(o=this._onDereferenced)||void 0===o||o.call(this,this.deserializedList,i,e,n)}}else{var s=t.__uuid__;if(s){var c=t.__expectedType__;this.result.push(e,n,s,c)}else e[n]=this._deserializeObject(t,-1)}return!1},t._deserializeObjectField=function(e){var t=e.__id__;if("number"==typeof t){var n=this.deserializedList[t];if(n)return n;var i=this._serializedData[t];return this._deserializeObject(i,t,void 0,void 0)}if(e.__uuid__)throw e.__expectedType__,new Error("Asset reference field serialization is currently not supported in custom serialization.");return this._deserializeObject(e,-1)},t._fillPlainObject=function(e,t){for(var n in t)if(t.hasOwnProperty(n)){var i=t[n];"object"!=typeof i?"__type__"!==n&&(e[n]=i):i?this._deserializeAndAssignField(e,i,n)&&(e[n]=null):e[n]=null}},t._deserializeFastDefinedObject=function(e,t,n){if(n===u.Vec2)return e.x=t.x||0,void(e.y=t.y||0);if(n===u.Vec3)return e.x=t.x||0,e.y=t.y||0,void(e.z=t.z||0);if(n!==u.Color){if(n===u.Size)return e.width=t.width||0,void(e.height=t.height||0);for(var i=Dt(n),r=n.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];void 0!==s||t.hasOwnProperty(a)||(s=en.getDefault(i[a+yh])),"object"!=typeof s?e[a]=s:s?this._deserializeAndAssignField(e,s,a):e[a]=null}}else{e.r=t.r||0,e.g=t.g||0,e.b=t.b||0;var c=t.a;e.a=void 0===c?255:c}},e}();Th.pool=new Sh;var bh=[Kn,In,$n,Fn,Pn,ni,ri,jn];function Eh(e,t){e.x=t[1],e.y=t[2],e.z=t[3],e.w=t[4]}var Ch=[function(e,t){e.x=t[1],e.y=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.z=t[3]},Eh,Eh,function(e,t){e._val=t[1]},function(e,t){e.width=t[1],e.height=t[2]},function(e,t){e.x=t[1],e.y=t[2],e.width=t[3],e.height=t[4]},function(e,t){jn.fromArray(e,t,1)}],Ah=e("Details",function(){function e(){this.uuidObjList=null,this.uuidPropList=null,this.uuidList=null,this.uuidTypeList=[]}var t=e.prototype;return t.init=function(e){e?(this.uuidObjList=e[8],this.uuidPropList=e[9],this.uuidList=e[10]):this.uuidList||(this.uuidList=[],this.uuidObjList=[],this.uuidPropList=[],this.uuidTypeList=[])},t.reset=function(){this.uuidList&&(this.uuidList.length=0,this.uuidObjList.length=0,this.uuidPropList.length=0,this.uuidTypeList.length=0)},t.push=function(e,t,n,i){this.uuidObjList.push(e),this.uuidPropList.push(t),this.uuidList.push(n),this.uuidTypeList.push(i||"")},e}());function wh(e,t){for(var n=e[4][t[0]],i=n[0],r=new(0,i[0]),o=i[1],a=i[2],s=n[n.length-1],c=1;c<s;++c)r[o[n[c]]]=t[c];for(;c<t.length;++c){var l=o[n[c]],u=i[n[c]+a];(0,Mh[u])(e,r,l,t[c])}return r}function Ph(e,t,n){var i=new t;return i._deserialize?i._deserialize(n,e[0]):M(5303,Ie(t)),i}function Rh(e,t,n,i){i>=0?t[n]=e[5][i]:e[7][3*~i]=t}function Ih(e){return function(t,n,i,r){n[i]=r;for(var o=0;o<r.length;++o)e(t,r,o,r[o])}}function Dh(e,t,n,i){t[n]=null,e[8][i]=t}function Oh(e,t,n,i){t[n]=wh(e,i)}Ah.pool=new nt((function(e){e.reset()}),5),Ah.pool.get=function(){return this._get()||new Ah};var Mh=new Array(13);function Nh(e,t,n){return e||n(t),Object}function Lh(e,t,n,i,r,o,a){var s=e(t);if(!s){if(r)return void(n[i]=function(t,n,i){return function(){var r=e(i)||Nh(o,i,a);return t[n]=r,new r}}(n,i,t));s=Nh(o,t,a)}n[i]=s}function Bh(e,t,n,i){for(var r=n||$e,o=e[3],a=0;a<o.length;++a){var s=o[a];"string"!=typeof s?Lh(r,s[0],s,0,t,n,i):Lh(r,s,o,a,t,n,i)}}function Fh(e){var t=e[4];if(t)for(var n=e[3],i=0;i<t.length;++i){var r=t[i];r[0]=n[r[0]]}}function zh(e,t,n){"string"==typeof e&&(e=JSON.parse(e));var i,r=!t;if(t=t||Ah.pool.get(),function(e){if(Array.isArray(e)){var t=e[0];return"number"==typeof t||t instanceof Uh}return!1}(e)){t.init(e),n=n||{};var o,a=e[0],s=!1;if("object"==typeof a&&(s=a.preprocessed,a=a.version),a<1)throw new Error(F(5304,a));n._version=a,n.result=t,e[0]=n,s||(Bh(e,!1,n.classFinder,null!==(o=n.reportMissingClass)&&void 0!==o?o:zh.reportMissingClass),Fh(e)),u.game._isCloning=!0;var c=e[5],l=function(e){var t=e[5],n=e[6],i=0===n?0:n.length,r=t[t.length-1],o=t.length-i;"number"!=typeof r?r=0:(r<0&&(r=~r),--o);for(var a=0;a<o;++a)t[a]=wh(e,t[a]);for(var s=e[3],c=0;c<i;++c,++a){var l=n[c],u=t[a];if(l>=0){var h=s[l];t[a]=Ph(e,h,u)}else(0,Mh[l=~l])(e,t,a,u)}return r}(e);u.game._isCloning=!1,e[7]&&function(e,t,n){for(var i=e.length-1,r=0,o=3*e[i];r<o;r+=3){var a=e[r],s=t[e[r+2]],c=e[r+1];c>=0?a[n[c]]=s:a[~c]=s}for(;r<i;r+=3){var l=t[e[r]],u=t[e[r+2]],h=e[r+1];h>=0?l[n[h]]=u:l[~h]=u}}(e[7],c,e[2]),function(e){for(var t=e[5],n=e[2],i=e[1],r=e[8],o=e[9],a=e[10],s=0;s<r.length;++s){var c=r[s];"number"==typeof c&&(r[s]=t[c]);var l=o[s];"number"==typeof l&&(l=l>=0?n[l]:~l,o[s]=l);var u=a[s];"number"==typeof u&&(a[s]=i[u])}}(e),i=c[l]}else i=function(e,t,n){var i,r=(n=n||{}).classFinder||$e,o=n.createAssetRefs||hh.platform===lu.EDITOR_CORE,a=n.customEnv,s=n.ignoreEditorOnly,c=null!==(i=n.reportMissingClass)&&void 0!==i?i:u.deserialize.reportMissingClass;t.init();var l=Th.pool.get(t,r,c,a,s);u.game._isCloning=!0;var h=l.deserialize(e);return u.game._isCloning=!1,Th.pool.put(l),o&&t.assignAssetsBy(EditorExtends.serialize.asAsset),h}(e,t,n);return r&&Ah.pool.put(t),i}Mh[0]=function(e,t,n,i){t[n]=i},Mh[1]=Rh,Mh[2]=Ih(Rh),Mh[3]=Ih(Dh),Mh[4]=Oh,Mh[5]=function(e,t,n,i){Ch[i[0]](t[n],i)},Mh[6]=Dh,Mh[7]=function(e,t,n,i){t[n].set(i)},Mh[8]=function(e,t,n,i){var r=new bh[i[0]];Ch[i[0]](r,i),t[n]=r},Mh[9]=Ih(Oh),Mh[10]=function(e,t,n,i){var r=e[3][i[0]];t[n]=Ph(e,r,i[1])},Mh[11]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=1;o<i.length;o+=3){var a=i[o],s=i[o+1],c=i[o+2];(0,Mh[s])(e,r,a,c)}},Mh[12]=function(e,t,n,i){var r=i[0];t[n]=r;for(var o=0;o<r.length;++o){var a=r[o],s=i[o+1];0!==s&&(0,Mh[s])(e,r,o,a)}},zh.Details=Ah,zh.reportMissingClass=function(e){M(5302,e)};var Uh=function(e){this.preprocessed=!0,this.version=e};function kh(e,t,n){return[1,0,0,[e],0,n?[t,-1]:[t],[0],0,[],[],[]]}u.deserialize=zh;var Gh,Hh,Vh,Wh,jh,qh,Xh,Yh,Kh,Qh,Zh,Jh=ml.Flags.Destroyed,$h=ml.Flags.PersistentMask,ef=[];function tf(e){var t;if(e instanceof ml){if(e._instantiate)return u.game._isCloning=!0,t=e._instantiate(null,!0),u.game._isCloning=!1,t;if(e instanceof u.Asset)throw new TypeError(F(6903))}return u.game._isCloning=!0,t=nf(e),u.game._isCloning=!1,t}function nf(e,t){var n;rf(e,n=e._iN$t?e._iN$t:e.constructor?new(0,e.constructor):Object.create(null),t);for(var i=0,r=ef.length;i<r;++i)ef[i]._iN$t=null;return ef.length=0,n}function rf(e,t,n){rt.value(e,"_iN$t",t,!0),ef.push(e);var i=e.constructor;if(u.Class._isCCClass(i))!function(e,t,n,i){for(var r=e.__values__,o=0;o<r.length;o++){var a=r[o],s=t[a];if("object"==typeof s&&s){var c=n[a];c instanceof ht&&c.constructor===s.constructor?c.set(s):n[a]=s._iN$t||of(s,i)}else n[a]=s}}(i,e,t,n);else for(var r in e)if(e.hasOwnProperty(r)&&(95!==r.charCodeAt(0)||95!==r.charCodeAt(1)||"__type__"===r||"__prefab"===r)){var o=e[r];if("object"==typeof o&&o){if(o===t)continue;t[r]=o._iN$t||of(o,n)}else t[r]=o}e instanceof ml&&(t._objFlags&=$h)}function of(e,t){if(e instanceof ht)return e.clone();if(e instanceof u.Asset)return e;var n;if(ArrayBuffer.isView(e)){var i=e.length;n=new e.constructor(i),e._iN$t=n,ef.push(e);for(var r=0;r<i;++r)n[r]=e[r];return n}if(Array.isArray(e)){var o=e.length;n=new Array(o),e._iN$t=n,ef.push(e);for(var a=0;a<o;++a){var s=e[a];n[a]="object"==typeof s&&s?s._iN$t||of(s,t):s}return n}if(e._objFlags&Jh)return null;var c=e.constructor;if(u.Class._isCCClass(c)){if(t)if(t instanceof u.Component){if(e instanceof u._BaseNode||e instanceof u.Component)return e}else if(t instanceof u._BaseNode)if(e instanceof u._BaseNode){if(!e.isChildOf(t))return e}else if(e instanceof u.Component&&e.node&&!e.node.isChildOf(t))return e;n=new c}else if(c===Object)n={};else{if(c)return e;n=Object.create(null)}return rf(e,n,t),n}function af(e,t){return(t<<3)+e}function sf(e){return lf[e]}function cf(e){switch(e){case Qh.Uint8:return Uint8Array;case Qh.Uint16:return Uint16Array;case Qh.Uint32:return Uint32Array;case Qh.Int8:return Int8Array;case Qh.Int16:return Int16Array;case Qh.Int32:return Int32Array;case Qh.Float32:return Float32Array;case Qh.Float64:return Float64Array}}tf._clone=nf,u.instantiate=tf,function(e){e[e.Uint8=0]="Uint8",e[e.Uint16=1]="Uint16",e[e.Uint32=2]="Uint32",e[e.Int8=3]="Int8",e[e.Int16=4]="Int16",e[e.Int32=5]="Int32",e[e.Float32=6]="Float32",e[e.Float64=7]="Float64"}(Qh||(Qh={})),function(e){e[e.Scalar=0]="Scalar",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Quat=4]="Quat",e[e.Mat4=5]="Mat4"}(Zh||(Zh={})),e("CompactValueTypeArray",mc("cc.CompactValueTypeArray")((Yh=Xh=function(){function e(){ce(this,"_byteOffset",Vh,this),ce(this,"_unitCount",Wh,this),ce(this,"_unitElement",jh,this),ce(this,"_length",qh,this)}return e.lengthFor=function(e,t,n){return sf(t).requiredUnits*e.length*cf(n).BYTES_PER_ELEMENT},e.compress=function(t,n,i,r,o,a){for(var s=sf(n),c=cf(i),l=s.requiredUnits*t.length,u=new c(r,o,l),h=0;h<t.length;++h)s.compress(u,h,t[h]);var f=new e;return f._unitElement=af(i,n),f._byteOffset=a,f._unitCount=l,f._length=t.length,f},e.prototype.decompress=function(e){for(var t,n={storageUnit:7&(t=this._unitElement),elementType:t>>3},i=n.storageUnit,r=sf(n.elementType),o=new(cf(i))(e,this._byteOffset,this._unitCount),a=new Array(this._length),s=0;s<this._length;++s)a[s]=r.decompress(o,s);return a},e}(),Xh.StorageUnit=Qh,Xh.ElementType=Zh,Vh=le((Hh=Yh).prototype,"_byteOffset",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wh=le(Hh.prototype,"_unitCount",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jh=le(Hh.prototype,"_unitElement",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return af(Qh.Uint8,Zh.Scalar)}}),qh=le(Hh.prototype,"_length",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Gh=Hh))||Gh);var lf=((Kh={})[Zh.Scalar]={requiredUnits:1,compress:function(e,t,n){e[t]=n},decompress:function(e,t){return e[t]}},Kh[Zh.Vec2]={requiredUnits:2,compress:function(e,t,n){e[2*t]=n.x,e[2*t+1]=n.y},decompress:function(e,t){return new In(e[2*t],e[2*t+1])}},Kh[Zh.Vec3]={requiredUnits:3,compress:function(e,t,n){e[3*t]=n.x,e[3*t+1]=n.y,e[3*t+2]=n.z},decompress:function(e,t){return new In(e[3*t],e[3*t+1],e[3*t+2])}},Kh[Zh.Vec4]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new $n(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Kh[Zh.Quat]={requiredUnits:4,compress:function(e,t,n){e[4*t]=n.x,e[4*t+1]=n.y,e[4*t+2]=n.z,e[4*t+3]=n.w},decompress:function(e,t){return new Fn(e[4*t],e[4*t+1],e[4*t+2],e[4*t+3])}},Kh[Zh.Mat4]={requiredUnits:16,compress:function(e,t,n){jn.toArray(e,n,16*t)},decompress:function(e,t){return jn.fromArray(new jn,e,16*t)}},Kh);function uf(){return 0}function hf(e){return e}function ff(e){return e*e}function _f(e){return e*(2-e)}function pf(e){return(e*=2)<1?.5*e*e:-.5*(--e*(e-2)-1)}function df(e){return e*e*e}function mf(e){return--e*e*e+1}function vf(e){return(e*=2)<1?.5*e*e*e:.5*((e-=2)*e*e+2)}function gf(e){return e*e*e*e}function yf(e){return 1- --e*e*e*e}function xf(e){return(e*=2)<1?.5*e*e*e*e:-.5*((e-=2)*e*e*e-2)}function Sf(e){return e*e*e*e*e}function Tf(e){return--e*e*e*e*e+1}function bf(e){return(e*=2)<1?.5*e*e*e*e*e:.5*((e-=2)*e*e*e*e+2)}function Ef(e){return 1===e?1:1-Math.cos(e*Math.PI/2)}function Cf(e){return Math.sin(e*Math.PI/2)}function Af(e){return.5*(1-Math.cos(Math.PI*e))}function wf(e){return 0===e?0:Math.pow(1024,e-1)}function Pf(e){return 1===e?1:1-Math.pow(2,-10*e)}function Rf(e){return 0===e?0:1===e?1:(e*=2)<1?.5*Math.pow(1024,e-1):.5*(2-Math.pow(2,-10*(e-1)))}function If(e){return 1-Math.sqrt(1-e*e)}function Df(e){return Math.sqrt(1- --e*e)}function Of(e){return(e*=2)<1?-.5*(Math.sqrt(1-e*e)-1):.5*(Math.sqrt(1-(e-=2)*e)+1)}function Mf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),-n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4))}function Nf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),n*Math.pow(2,-10*e)*Math.sin(2*(e-t)*Math.PI/.4)+1)}function Lf(e){var t,n=.1;return 0===e?0:1===e?1:(!n||n<1?(n=1,t=.1):t=.4*Math.asin(1/n)/(2*Math.PI),(e*=2)<1?n*Math.pow(2,10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*-.5:n*Math.pow(2,-10*(e-=1))*Math.sin(2*(e-t)*Math.PI/.4)*.5+1)}function Bf(e){if(1===e)return 1;var t=1.70158;return e*e*((t+1)*e-t)}function Ff(e){if(0===e)return 0;var t=1.70158;return--e*e*((t+1)*e+t)+1}function zf(e){var t=2.5949095;return(e*=2)<1?e*e*((t+1)*e-t)*.5:.5*((e-=2)*e*((t+1)*e+t)+2)}function Uf(e){return 1-kf(1-e)}function kf(e){return e<1/2.75?7.5625*e*e:e<2/2.75?7.5625*(e-=1.5/2.75)*e+.75:e<2.5/2.75?7.5625*(e-=2.25/2.75)*e+.9375:7.5625*(e-=2.625/2.75)*e+.984375}function Gf(e){return e<.5?.5*Uf(2*e):.5*kf(2*e-1)+.5}function Hf(e){return e<=0?0:e>=1?1:e*e*(3-2*e)}function Vf(e){return e<=0?0:e>=1?1:e*e*e*(e*(6*e-15)+10)}u._decorator=_l;var Wf=e_(ff,_f),jf=e_(df,mf),qf=e_(gf,yf),Xf=e_(Sf,Tf),Yf=e_(Ef,Cf),Kf=e_(wf,Pf),Qf=e_(If,Df),Zf=e_(Mf,Nf),Jf=e_(Bf,Ff),$f=e_(Uf,kf);function e_(e,t){return function(n){return n<.5?t(2*n)/2:e(2*n-1)/2+.5}}var t_,n_,i_=Object.freeze({__proto__:null,constant:uf,linear:hf,quadIn:ff,quadOut:_f,quadInOut:pf,cubicIn:df,cubicOut:mf,cubicInOut:vf,quartIn:gf,quartOut:yf,quartInOut:xf,quintIn:Sf,quintOut:Tf,quintInOut:bf,sineIn:Ef,sineOut:Cf,sineInOut:Af,expoIn:wf,expoOut:Pf,expoInOut:Rf,circIn:If,circOut:Df,circInOut:Of,elasticIn:Mf,elasticOut:Nf,elasticInOut:Lf,backIn:Bf,backOut:Ff,backInOut:zf,bounceIn:Uf,bounceOut:kf,bounceInOut:Gf,smooth:Hf,fade:Vf,quadOutIn:Wf,cubicOutIn:jf,quartOutIn:qf,quintOutIn:Xf,sineOutIn:Yf,expoOutIn:Kf,circOutIn:Qf,elasticOutIn:Zf,backOutIn:Jf,bounceOutIn:$f});e("easing",i_),function(e){e[e.LINEAR=0]="LINEAR",e[e.CONSTANT=1]="CONSTANT",e[e.QUAD_IN=2]="QUAD_IN",e[e.QUAD_OUT=3]="QUAD_OUT",e[e.QUAD_IN_OUT=4]="QUAD_IN_OUT",e[e.QUAD_OUT_IN=5]="QUAD_OUT_IN",e[e.CUBIC_IN=6]="CUBIC_IN",e[e.CUBIC_OUT=7]="CUBIC_OUT",e[e.CUBIC_IN_OUT=8]="CUBIC_IN_OUT",e[e.CUBIC_OUT_IN=9]="CUBIC_OUT_IN",e[e.QUART_IN=10]="QUART_IN",e[e.QUART_OUT=11]="QUART_OUT",e[e.QUART_IN_OUT=12]="QUART_IN_OUT",e[e.QUART_OUT_IN=13]="QUART_OUT_IN",e[e.QUINT_IN=14]="QUINT_IN",e[e.QUINT_OUT=15]="QUINT_OUT",e[e.QUINT_IN_OUT=16]="QUINT_IN_OUT",e[e.QUINT_OUT_IN=17]="QUINT_OUT_IN",e[e.SINE_IN=18]="SINE_IN",e[e.SINE_OUT=19]="SINE_OUT",e[e.SINE_IN_OUT=20]="SINE_IN_OUT",e[e.SINE_OUT_IN=21]="SINE_OUT_IN",e[e.EXPO_IN=22]="EXPO_IN",e[e.EXPO_OUT=23]="EXPO_OUT",e[e.EXPO_IN_OUT=24]="EXPO_IN_OUT",e[e.EXPO_OUT_IN=25]="EXPO_OUT_IN",e[e.CIRC_IN=26]="CIRC_IN",e[e.CIRC_OUT=27]="CIRC_OUT",e[e.CIRC_IN_OUT=28]="CIRC_IN_OUT",e[e.CIRC_OUT_IN=29]="CIRC_OUT_IN",e[e.ELASTIC_IN=30]="ELASTIC_IN",e[e.ELASTIC_OUT=31]="ELASTIC_OUT",e[e.ELASTIC_IN_OUT=32]="ELASTIC_IN_OUT",e[e.ELASTIC_OUT_IN=33]="ELASTIC_OUT_IN",e[e.BACK_IN=34]="BACK_IN",e[e.BACK_OUT=35]="BACK_OUT",e[e.BACK_IN_OUT=36]="BACK_IN_OUT",e[e.BACK_OUT_IN=37]="BACK_OUT_IN",e[e.BOUNCE_IN=38]="BOUNCE_IN",e[e.BOUNCE_OUT=39]="BOUNCE_OUT",e[e.BOUNCE_IN_OUT=40]="BOUNCE_IN_OUT",e[e.BOUNCE_OUT_IN=41]="BOUNCE_OUT_IN",e[e.SMOOTH=42]="SMOOTH",e[e.FADE=43]="FADE"}(n_||(n_={}));var r_,o_,a_,s_,c_,l_=((t_={})[n_.CONSTANT]=uf,t_[n_.LINEAR]=hf,t_[n_.QUAD_IN]=ff,t_[n_.QUAD_OUT]=_f,t_[n_.QUAD_IN_OUT]=pf,t_[n_.QUAD_OUT_IN]=Wf,t_[n_.CUBIC_IN]=df,t_[n_.CUBIC_OUT]=mf,t_[n_.CUBIC_IN_OUT]=vf,t_[n_.CUBIC_OUT_IN]=jf,t_[n_.QUART_IN]=gf,t_[n_.QUART_OUT]=yf,t_[n_.QUART_IN_OUT]=xf,t_[n_.QUART_OUT_IN]=qf,t_[n_.QUINT_IN]=Sf,t_[n_.QUINT_OUT]=Tf,t_[n_.QUINT_IN_OUT]=bf,t_[n_.QUINT_OUT_IN]=Xf,t_[n_.SINE_IN]=Ef,t_[n_.SINE_OUT]=Cf,t_[n_.SINE_IN_OUT]=Af,t_[n_.SINE_OUT_IN]=Yf,t_[n_.EXPO_IN]=wf,t_[n_.EXPO_OUT]=Pf,t_[n_.EXPO_IN_OUT]=Rf,t_[n_.EXPO_OUT_IN]=Kf,t_[n_.CIRC_IN]=If,t_[n_.CIRC_OUT]=Df,t_[n_.CIRC_IN_OUT]=Of,t_[n_.CIRC_OUT_IN]=Qf,t_[n_.ELASTIC_IN]=Mf,t_[n_.ELASTIC_OUT]=Nf,t_[n_.ELASTIC_IN_OUT]=Lf,t_[n_.ELASTIC_OUT_IN]=Zf,t_[n_.BACK_IN]=Bf,t_[n_.BACK_OUT]=Ff,t_[n_.BACK_IN_OUT]=zf,t_[n_.BACK_OUT_IN]=Jf,t_[n_.BOUNCE_IN]=Uf,t_[n_.BOUNCE_OUT]=kf,t_[n_.BOUNCE_IN_OUT]=Gf,t_[n_.BOUNCE_OUT_IN]=$f,t_[n_.SMOOTH]=Hf,t_[n_.FADE]=Vf,t_);function u_(e){return l_[e]}var h_,f_,__,p_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).interpolationMode=rl.LINEAR,t.tangentWeightMode=al.NONE,t.value=0,t.rightTangent=0,t.rightTangentWeight=0,t.leftTangent=0,t.leftTangentWeight=0,t.easingMethod=n_.LINEAR,t}return $(t,e),t}(fl);function d_(e){var t=new p_;if("number"==typeof e)t.value=e;else{var n=e.interpolationMode,i=e.tangentWeightMode,r=e.value,o=e.rightTangent,a=e.rightTangentWeight,s=e.leftTangent,c=e.leftTangentWeight,l=e.easingMethod,u=e[hl];t.value=null!=r?r:t.value,t.rightTangent=null!=o?o:t.rightTangent,t.rightTangentWeight=null!=a?a:t.rightTangentWeight,t.leftTangent=null!=s?s:t.leftTangent,t.leftTangentWeight=null!=c?c:t.leftTangentWeight,t.interpolationMode=null!=n?n:t.interpolationMode,t.tangentWeightMode=null!=i?i:t.tangentWeightMode,t.easingMethod=null!=l?l:t.easingMethod,u&&(t[hl]=u)}return t}en.fastDefine("cc.RealKeyframeValue",p_,{interpolationMode:rl.LINEAR,tangentWeightMode:al.NONE,value:0,rightTangent:0,rightTangentWeight:0,leftTangent:0,leftTangentWeight:0,easingMethod:n_.LINEAR}),en.Attr.setClassAttr(p_,hl,"editorOnly",!0),(h_=p_,null!==(__=(f_=h_)[Sc])&&void 0!==__?__:f_[Sc]={}).uniquelyReferenced=!0;var m_,v_=e("RealCurve",mc("cc.RealCurve")((c_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",a_,oe(t)),ce(t,"postExtrapolation",s_,oe(t)),t}$(t,e);var n=t.prototype;return n.evaluate=function(e){var t=this._times,n=this._values,i=t.length;if(0===i)return 0;var r=t[0],o=t[i-1];if(e<r){var a=this.preExtrapolation,s=n[0];if(a===ol.CLAMP||i<2)return s.value;switch(a){case ol.LINEAR:return M_(r,n[0].value,t[1],n[1].value,e);case ol.LOOP:e=D_(e,r,o);break;case ol.PING_PONG:e=O_(e,r,o);break;default:return s.value}}else if(e>o){var c=this.postExtrapolation,l=n[i-1];if(c===ol.CLAMP||i<2)return l.value;switch(c){case ol.LINEAR:return M_(o,l.value,t[i-2],n[i-2].value,e);case ol.LOOP:e=D_(e,r,o);break;case ol.PING_PONG:e=O_(e,r,o);break;default:return l.value}}var u=sc(t,e);if(u>=0)return n[u].value;var h=~u,f=h-1,_=t[f],p=n[f],d=t[h];return function(e,t,n,i,r){var o=n-e;switch(t.interpolationMode){default:case rl.CONSTANT:return t.value;case rl.LINEAR:var a=t.easingMethod===n_.LINEAR?r:u_(t.easingMethod)(r);return hn(t.value,i.value,a);case rl.CUBIC:var s=1/3,c=t.rightTangent,l=t.rightTangentWeight,u=0!=(t.tangentWeightMode&al.RIGHT),h=i.leftTangent,f=i.leftTangentWeight,_=0!=(i.tangentWeightMode&al.LEFT);if(u||_){var p=0;if(u)p=l;else{var d=o,m=o*c;p=Math.sqrt(d*d+m*m)*s}var v=Math.atan(c),g=Math.cos(v)*p+e,y=Math.sin(v)*p+t.value,x=0;if(_)x=f;else{var S=o,T=o*h;x=Math.sqrt(S*S+T*T)*s}var b=Math.atan(h),E=(g-e)/o,C=(-Math.cos(b)*x+n-e)/o,A=y,w=-Math.sin(b)*x+i.value,P=[0,0,0],R=function(e,t,n,i,r){var o=n/i,a=t/i,s=o*o,c=1/3*(-1/3*s+a),l=.5*(2/27*o*s-1/3*o*a+e/i),u=c*c*c,h=l*l+u,f=0;if(ll(h)){if(ll(l))return r[0]=0,1;var _=Math.cbrt(-l);return r[0]=2*_,r[1]=-_,2}if(h<0){var p=1/3*Math.acos(-l/Math.sqrt(-u)),d=2*Math.sqrt(-c);r[0]=d*Math.cos(p),r[1]=-d*Math.cos(p+Math.PI/3),r[2]=-d*Math.cos(p-Math.PI/3),f=3}else{var m=Math.sqrt(h),v=Math.cbrt(m-l),g=-Math.cbrt(m+l);r[0]=v+g,f=1}for(var y=1/3*o,x=0;x<f;++x)r[x]-=y;return f}(0-r,3*E,3*C-6*E,3*(E-C)+1,P),I=function(e,t,n){var i=n;if(1===t)i=e[0];else{i=-1/0;for(var r=0;r<t;++r){var o=e[r];o>=0&&o<=1&&o>i&&(i=o)}i===-1/0&&(i=0)}return i}(P,R,r);return N_(t.value,A,w,i.value,I)}var D=t.value+s*c*o,O=i.value-s*h*o;return N_(t.value,D,O,i.value,r)}}(_,p,d,n[h],(e-_)/(d-_))},n.addKeyFrame=function(t,n){return e.prototype.addKeyFrame.call(this,t,d_(n))},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return d_(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return d_(e[1])})))}},n.isConstant=function(e){if(this._values.length<=1)return!0;var t=this._values[0].value;return this._values.every((function(n){return cn(n.value,t,e)}))},n[fh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=n.length,o=new DataView(new ArrayBuffer(0+g_+g_+y_+x_*r+P_*r)),a=0;o.setUint8(a,this.preExtrapolation),a+=g_,o.setUint8(a,this.postExtrapolation),a+=g_,o.setUint32(a,r,!0),a+=y_,n.forEach((function(e,t){return o.setFloat32(a+x_*t,e,!0)})),a+=x_*r;for(var s,c=se(i);!(s=c()).done;){var l=s.value;a=R_(o,l,a)}var u=new Uint8Array(o.buffer,0,a);e.writeProperty("bytes",u);var h=i.map((function(e){return e[hl]}));h.some((function(e){return void 0!==e}))&&e.writeProperty("keyframeValueEditorExtras",h)}else e.writeThis()},n[_h]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0;this.preExtrapolation=i.getUint8(r),r+=g_,this.postExtrapolation=i.getUint8(r),r+=g_;var o=i.getUint32(r,!0);r+=y_;var a=Array.from({length:o},(function(e,t){return i.getFloat32(r+x_*t,!0)}));r+=x_*o;for(var s=new Array(o),c=0;c<o;++c){var l=d_({});r=I_(i,l,r),s[c]=l}n.byteLength;var u=e.readProperty("keyframeValueEditorExtras");u&&(u.length,u.forEach((function(e,t){return s[t][hl]=e}))),this._times=a,this._values=s}else e.readThis()},t}(cl),a_=le((o_=c_).prototype,"preExtrapolation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ol.CLAMP}}),s_=le(o_.prototype,"postExtrapolation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ol.CLAMP}}),r_=o_))||r_);!function(e){e[e.VALUE=1]="VALUE",e[e.INTERPOLATION_MODE=2]="INTERPOLATION_MODE",e[e.TANGENT_WEIGHT_MODE=4]="TANGENT_WEIGHT_MODE",e[e.LEFT_TANGENT=8]="LEFT_TANGENT",e[e.LEFT_TANGENT_WEIGHT=16]="LEFT_TANGENT_WEIGHT",e[e.RIGHT_TANGENT=32]="RIGHT_TANGENT",e[e.RIGHT_TANGENT_WEIGHT=64]="RIGHT_TANGENT_WEIGHT"}(m_||(m_={}));var g_=1,y_=4,x_=4,S_=d_({}),T_=S_.interpolationMode,b_=S_.tangentWeightMode,E_=S_.leftTangent,C_=S_.leftTangentWeight,A_=S_.rightTangent,w_=S_.rightTangentWeight,P_=26;function R_(e,t,n){var i=0,r=n,o=r;r+=4;var a=t.value,s=t.interpolationMode,c=t.tangentWeightMode,l=t.rightTangent,u=t.rightTangentWeight,h=t.leftTangent,f=t.leftTangentWeight,_=t.easingMethod;return e.setFloat32(r,a,!0),r+=4,s!==T_&&(i|=m_.INTERPOLATION_MODE,e.setUint8(r,s),r+=1),c!==b_&&(i|=m_.TANGENT_WEIGHT_MODE,e.setUint8(r,c),r+=1),h!==E_&&(i|=m_.LEFT_TANGENT,e.setFloat32(r,h,!0),r+=4),f!==C_&&(i|=m_.LEFT_TANGENT_WEIGHT,e.setFloat32(r,f,!0),r+=4),l!==A_&&(i|=m_.RIGHT_TANGENT,e.setFloat32(r,l,!0),r+=4),u!==w_&&(i|=m_.RIGHT_TANGENT_WEIGHT,e.setFloat32(r,u,!0),r+=4),i|=_<<8,e.setUint32(o,i,!0),r}function I_(e,t,n){var i=n,r=e.getUint32(i,!0);i+=4,t.value=e.getFloat32(i,!0),i+=4,r&m_.INTERPOLATION_MODE&&(t.interpolationMode=e.getUint8(i),i+=1),r&m_.TANGENT_WEIGHT_MODE&&(t.tangentWeightMode=e.getUint8(i),i+=1),r&m_.LEFT_TANGENT&&(t.leftTangent=e.getFloat32(i,!0),i+=4),r&m_.LEFT_TANGENT_WEIGHT&&(t.leftTangentWeight=e.getFloat32(i,!0),i+=4),r&m_.RIGHT_TANGENT&&(t.rightTangent=e.getFloat32(i,!0),i+=4),r&m_.RIGHT_TANGENT_WEIGHT&&(t.rightTangentWeight=e.getFloat32(i,!0),i+=4);var o=(65280&r)>>8;return t.easingMethod=o,i}function D_(e,t,n){return t+Sn(e-t,n-t)}function O_(e,t,n){return t+Tn(e-t,n-t)}function M_(e,t,n,i,r){return t+(i-t)/(n-e)*(r-e)}function N_(e,t,n,i,r){var o=1-r;return o*o*o*e+3*o*o*r*t+3*o*r*r*n+r*r*r*i}function L_(e,t,n,i,r){var o=1-r;return o*(o*(e+(3*t-e)*r)+3*n*r*r)+i*r*r*r}u.bezier=L_;var B_,F_,z_,U_,k_,G_,H_,V_,W_,j_,q_,X_=Math.cos,Y_=Math.acos,K_=Math.max,Q_=2*Math.PI,Z_=Math.sqrt;function J_(e){return e<0?-Math.pow(-e,1/3):Math.pow(e,1/3)}function $_(e,t){var n=function(e,t){var n,i,r,o,a=t-0,s=t-e[0],c=3*a,l=3*s,u=3*(t-e[2]),h=1/(-a+l-u+(t-1)),f=1/3,_=(c-6*s+u)*h,p=_*f,d=(-c+l)*h,m=(3*d-_*_)*f,v=m*f,g=(2*_*_*_-9*_*d+a*h*27)/27,y=g/2,x=y*y+v*v*v;if(x<0){var S=-m*f,T=Z_(S*S*S),b=-g/(2*T),E=Y_(b<-1?-1:b>1?1:b),C=2*J_(T);return i=C*X_(E*f)-p,r=C*X_((E+Q_)*f)-p,o=C*X_((E+2*Q_)*f)-p,i>=0&&i<=1?r>=0&&r<=1?o>=0&&o<=1?K_(i,r,o):K_(i,r):o>=0&&o<=1?K_(i,o):i:r>=0&&r<=1?o>=0&&o<=1?K_(r,o):r:o}if(0===x)return r=-(n=y<0?J_(-y):-J_(y))-p,(i=2*n-p)>=0&&i<=1?r>=0&&r<=1?K_(i,r):i:r;var A=Z_(x);return(n=J_(-y+A))-J_(y+A)-p}(e,t),i=e[1];return((1-n)*(i+(e[3]-i)*n)*3+n*n)*n}u.bezierByTime=$_,function(e){e[e.SLERP=0]="SLERP",e[e.CONSTANT=1]="CONSTANT"}(q_||(q_=e("QuatInterpolationMode",{})));var ep=mc("cc.QuatKeyframeValue")(B_=Ac((z_=le((F_=function(e){var t=void 0===e?{}:e,n=t.value,i=t.interpolationMode,r=t.easingMethod;ce(this,"interpolationMode",z_,this),ce(this,"value",U_,this),ce(this,"easingMethod",k_,this),this.value=n?Fn.clone(n):this.value,this.interpolationMode=null!=i?i:this.interpolationMode,this.easingMethod=null!=r?r:this.easingMethod}).prototype,"interpolationMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return q_.SLERP}}),U_=le(F_.prototype,"value",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fn.clone(Fn.IDENTITY)}}),k_=le(F_.prototype,"easingMethod",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return n_.LINEAR}}),B_=F_))||B_)||B_;function tp(e){return new ep(e)}var np,ip=e("QuatCurve",mc("cc.QuatCurve")((j_=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"preExtrapolation",V_,oe(t)),ce(t,"postExtrapolation",W_,oe(t)),t}$(t,e);var n=t.prototype;return n.evaluate=function(e,t){var n;null!==(n=t)&&void 0!==n||(t=new Fn);var i=this._times,r=this._values,o=this.postExtrapolation,a=this.preExtrapolation,s=i.length;if(0===s)return t;var c=i[0],l=i[s-1];if(e<c){var u=r[0];switch(a){case ol.LOOP:e=c+Sn(e-c,l-c);break;case ol.PING_PONG:e=c+Tn(e-c,l-c);break;case ol.CLAMP:default:return Fn.copy(t,u.value)}}else if(e>l){var h=r[s-1];switch(o){case ol.LOOP:e=c+Sn(e-c,l-c);break;case ol.PING_PONG:e=c+Tn(e-c,l-c);break;case ol.CLAMP:default:return Fn.copy(t,h.value)}}var f=sc(i,e);if(f>=0)return Fn.copy(t,r[f].value);var _=~f,p=_-1,d=i[p],m=r[p],v=i[_],g=r[_],y=(e-d)/(v-d);switch(m.interpolationMode){default:case q_.CONSTANT:return Fn.copy(t,m.value);case q_.SLERP:var x=m.easingMethod,S=x===n_.LINEAR?y:Array.isArray(x)?$_(x,y):u_(x)(y);return Fn.slerp(t,m.value,g.value,S)}},n.addKeyFrame=function(t,n){var i=new ep(n);return e.prototype.addKeyFrame.call(this,t,i)},n.assignSorted=function(e,t){if(void 0!==t)this.setKeyframes(e.slice(),t.map((function(e){return tp(e)})));else{var n=Array.from(e);this.setKeyframes(n.map((function(e){return e[0]})),n.map((function(e){return tp(e[1])})))}},n[fh]=function(e,t){if(t.toCCON){var n=this._times,i=this._values,r=!0;i.forEach((function(e,t,n){var i=n[0];r&&e.interpolationMode!==i.interpolationMode&&(r=!1)}));var o=n.length,a=pp*(r?1:o),s=i.reduce((function(e,t){var n=t.easingMethod;return e+(Array.isArray(n)?dp+4*vp:dp)}),0),c=0,l=new DataView(new ArrayBuffer(c+=up+hp+fp*o+4*_p*o+s+a+0)),u=0,h=0;r&&(h|=np.INTERPOLATION_MODE),l.setUint32(u,h,!0),u+=up,l.setUint32(u,o,!0),u+=hp,n.forEach((function(e,t){return l.setFloat32(u+fp*t,e,!0)})),u+=fp*o,i.forEach((function(e,t){var n=e.value,i=n.x,r=n.y,o=n.z,a=n.w,s=u+4*_p*t;l.setFloat32(s+0*_p,i,!0),l.setFloat32(s+1*_p,r,!0),l.setFloat32(s+2*_p,o,!0),l.setFloat32(s+3*_p,a,!0)})),u+=4*_p*o,i.forEach((function(e){var t=e.easingMethod;Array.isArray(t)?(l.setUint8(u,mp),++u,l.setFloat32(u+0*vp,t[0],!0),l.setFloat32(u+1*vp,t[1],!0),l.setFloat32(u+2*vp,t[2],!0),l.setFloat32(u+3*vp,t[3],!0),u+=4*vp):(l.setUint8(u,t),++u)}));var f=u;u+=a;var _=f;i.forEach((function(e){var t=e.interpolationMode;l.setUint8(_,t),r||(_+=pp)}));var p=new Uint8Array(l.buffer);e.writeProperty("bytes",p)}else e.writeThis()},n[_h]=function(e,t){if(t.fromCCON){var n=e.readProperty("bytes"),i=new DataView(n.buffer,n.byteOffset,n.byteLength),r=0,o=i.getUint32(r,!0);r+=up;var a=o&np.INTERPOLATION_MODE,s=i.getUint32(r,!0);r+=hp;var c=Array.from({length:s},(function(e,t){return i.getFloat32(r+fp*t,!0)})),l=r+=fp*s;r+=4*_p*s;var u=Array.from({length:s},(function(e,t){var n=l+4*_p*t,o=i.getFloat32(n+0*_p,!0),a=i.getFloat32(n+1*_p,!0),s=i.getFloat32(n+2*_p,!0),c=i.getFloat32(n+3*_p,!0),u=i.getUint8(r);++r;var h=tp({value:{x:o,y:a,z:s,w:c}});return u!==mp?h.easingMethod=u:(h.easingMethod=[i.getFloat32(r+0*vp,!0),i.getFloat32(r+1*vp,!0),i.getFloat32(r+2*vp,!0),i.getFloat32(r+3*vp,!0)],r+=4*vp),h}));if(a){var h=i.getUint8(r);++r;for(var f=0;f<s;++f)u[f].interpolationMode=h}else{for(var _=0;_<s;++_){var p=i.getUint8(r+_);u[_].interpolationMode=p}r+=s}this._times=c,this._values=u}else e.readThis()},t}(cl),V_=le((H_=j_).prototype,"preExtrapolation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ol.CLAMP}}),W_=le(H_.prototype,"postExtrapolation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ol.CLAMP}}),G_=H_))||G_);!function(e){e[e.INTERPOLATION_MODE=1]="INTERPOLATION_MODE"}(np||(np={}));var rp,op,ap,sp,cp,lp,up=1,hp=4,fp=4,_p=4,pp=1,dp=1,mp=255,vp=4,gp=e("ObjectCurve",mc("cc.ObjectCurve")(rp=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t.prototype.evaluate=function(e){var t=this.searchKeyframe(e);if(t>=0)return this._values[t];var n=ln(~t-1,0,this._values.length-1);return this._values[n]},t}(cl))||rp),yp=function(){this.time=0,this.value=0,this.inTangent=0,this.outTangent=0};en.fastDefine("cc.Keyframe",yp,{time:0,value:0,inTangent:0,outTangent:0});var xp=function(){function e(){this.index=void 0,this.time=void 0,this.endTime=void 0,this.coefficient=void 0,this.index=-1,this.time=0,this.endTime=0,this.coefficient=new Float32Array(4)}return e.prototype.evaluate=function(e){return t=e-this.time,n=this.coefficient,t*(t*(t*n[0]+n[1])+n[2])+n[3];var t,n},e}(),Sp=mc("cc.AnimationCurve")((lp=cp=function(){function e(e){if(void 0===e&&(e=null),ce(this,"_curve",sp,this),this.cachedKey=void 0,e instanceof v_)this._curve=e;else{var t=new v_;this._curve=t,t.preExtrapolation=ol.LOOP,t.postExtrapolation=ol.CLAMP,e?t.assignSorted(e.map((function(e){return[e.time,{interpolationMode:rl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]}))):t.assignSorted([[0,{interpolationMode:rl.CUBIC,value:1}],[1,{interpolationMode:rl.CUBIC,value:1}]])}this.cachedKey=new xp}var t=e.prototype;return t.addKey=function(e){e?this._curve.addKeyFrame(e.time,{interpolationMode:rl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}):this._curve.clear()},t.evaluate_slow=function(e){return this._curve.evaluate(e)},t.evaluate=function(e){var t=this.cachedKey,n=this._curve,i=n.keyFramesCount-1,r=e,o=e<0?n.preExtrapolation:n.postExtrapolation,a=n.getKeyframeTime(0),s=n.getKeyframeTime(i);switch(o){case ol.LOOP:r=Sn(e-a,s-a)+a;break;case ol.PING_PONG:r=Tn(e-a,s-a)+a;break;case ol.CLAMP:default:r=ln(e,a,s)}if(r>=t.time&&r<t.endTime)return t.evaluate(r);var c=this.findIndex(t,r),l=Math.min(c+1,i);return this.calcOptimizedKey(t,c,l),t.evaluate(r)},t.calcOptimizedKey=function(e,t,n){var i=this._curve.getKeyframeTime(t),r=this._curve.getKeyframeTime(n),o=this._curve.getKeyframeValue(t),a=o.value,s=o.leftTangent,c=this._curve.getKeyframeValue(n),l=c.value,u=c.rightTangent;e.index=t,e.time=i,e.endTime=r;var h=r-i,f=l-a,_=1/(h*h),p=s*h,d=u*h;e.coefficient[0]=(p+d-f-f)*_/h,e.coefficient[1]=(f+f+f-p-p-d)*_,e.coefficient[2]=s,e.coefficient[3]=a},t.findIndex=function(e,t){var n=this._curve,i=n.keyFramesCount,r=e.index;if(-1!==r)if(t>n.getKeyframeTime(r))for(var o=0;o<3;o++){var a=r+o;if(a+1<i&&n.getKeyframeTime(a+1)>t)return a}else for(var s=0;s<3;s++){var c=r-s;if(c>=0&&n.getKeyframeTime(c-1)<=t)return c-1}for(var l,u=0,h=i;h-u>1;)l=Math.floor((u+h)/2),n.getKeyframeTime(l)>=t?h=l:u=l;return u},Z(e,[{key:"_internalCurve",get:function(){return this._curve}},{key:"keyFrames",get:function(){return Array.from(this._curve.keyframes()).map((function(e){var t=e[0],n=e[1],i=new yp;return i.time=t,i.value=n.value,i.inTangent=n.leftTangent,i.outTangent=n.rightTangent,i}))},set:function(e){this._curve.assignSorted(e.map((function(e){return[e.time,{interpolationMode:rl.CUBIC,value:e.value,leftTangent:e.inTangent,rightTangent:e.outTangent}]})))}},{key:"preWrapMode",get:function(){return bp(this._curve.preExtrapolation)},set:function(e){this._curve.preExtrapolation=Tp(e)}},{key:"postWrapMode",get:function(){return bp(this._curve.postExtrapolation)},set:function(e){this._curve.postExtrapolation=Tp(e)}}]),e}(),cp.defaultKF=[{time:0,value:1,inTangent:0,outTangent:0},{time:1,value:1,inTangent:0,outTangent:0}],sp=le((ap=lp).prototype,"_curve",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),op=ap))||op;function Tp(e){switch(e){default:case ec.Default:case ec.Normal:case ec.Clamp:return ol.CLAMP;case ec.PingPong:return ol.PING_PONG;case ec.Loop:return ol.LOOP}}function bp(e){switch(e){default:case ol.LINEAR:case ol.CLAMP:return ec.Clamp;case ol.PING_PONG:return ec.PingPong;case ol.LOOP:return ec.Loop}}function Ep(){var e=new v_;return e.assignSorted([[0,{interpolationMode:rl.CUBIC,value:1}],[1,{interpolationMode:rl.CUBIC,value:1}]]),e}function Cp(e,t){console.warn(e+" is deprecated, please use "+t+" instead.")}k(_s,"intersect",[{name:"ray_aabb",newName:"rayAABB"},{name:"ray_plane",newName:"rayPlane"},{name:"ray_triangle",newName:"rayTriangle"},{name:"ray_sphere",newName:"raySphere"},{name:"ray_obb",newName:"rayOBB"},{name:"ray_capsule",newName:"rayCapsule"},{name:"ray_subMesh",newName:"raySubMesh"},{name:"ray_mesh",newName:"rayMesh"},{name:"ray_model",newName:"rayModel"},{name:"line_plane",newName:"linePlane"},{name:"line_triangle",newName:"lineTriangle"},{name:"line_aabb",newName:"lineAABB"},{name:"line_obb",newName:"lineOBB"},{name:"line_sphere",newName:"lineSphere"},{name:"aabb_aabb",newName:"aabbWithAABB"},{name:"aabb_obb",newName:"aabbWithOBB"},{name:"aabb_plane",newName:"aabbPlane"},{name:"aabb_frustum",newName:"aabbFrustum"},{name:"aabbFrustum_accurate",newName:"aabbFrustumAccurate"},{name:"obb_point",newName:"obbPoint"},{name:"obb_plane",newName:"obbPlane"},{name:"obb_frustum",newName:"obbFrustum"},{name:"obbFrustum_accurate",newName:"obbFrustumAccurate"},{name:"obb_obb",newName:"obbWithOBB"},{name:"obb_capsule",newName:"obbCapsule"},{name:"sphere_plane",newName:"spherePlane"},{name:"sphere_frustum",newName:"sphereFrustum"},{name:"sphereFrustum_accurate",newName:"sphereFrustumAccurate"},{name:"sphere_sphere",newName:"sphereWithSphere"},{name:"sphere_aabb",newName:"sphereAABB"},{name:"sphere_obb",newName:"sphereOBB"},{name:"sphere_capsule",newName:"sphereCapsule"},{name:"capsule_capsule",newName:"capsuleWithCapsule"}]);var Ap=function(e){function t(){var t;return t=e.call(this)||this,Cp("line","Line"),t}return $(t,e),t}(ta),wp=function(e){function t(){var t;return t=e.call(this)||this,Cp("plane","Plane"),t}return $(t,e),t}(Cs),Pp=function(e){function t(){var t;return t=e.call(this)||this,Cp("ray","Ray"),t}return $(t,e),t}(na),Rp=function(e){function t(){var t;return t=e.call(this)||this,Cp("triangle","Triangle"),t}return $(t,e),t}(ua),Ip=function(e){function t(){var t;return t=e.call(this)||this,Cp("sphere","Sphere"),t}return $(t,e),t}(la),Dp=function(e){function t(){var t;return t=e.call(this)||this,Cp("aabb","AABB"),t}return $(t,e),t}(Xs),Op=function(e){function t(){var t;return t=e.call(this)||this,Cp("obb","OBB"),t}return $(t,e),t}(Zs),Mp=function(e){function t(){var t;return t=e.call(this)||this,Cp("capsule","Capsule"),t}return $(t,e),t}(Js),Np=function(e){function t(){var t;return t=e.call(this)||this,Cp("frustum","Frustum"),t}return $(t,e),t}(oc),Lp=Object.freeze({__proto__:null,distance:$o,enums:ea,intersect:_s,Line:ta,Plane:Cs,Ray:na,Triangle:ua,Sphere:la,AABB:Xs,OBB:Zs,Capsule:Js,Frustum:oc,Keyframe:yp,AnimationCurve:Sp,get ERaycastMode(){return ca},line:Ap,plane:wp,ray:Pp,triangle:Rp,sphere:Ip,aabb:Dp,obb:Op,capsule:Mp,frustum:Np});e("geometry",Lp);var Bp={NONE:0,IGNORE_RAYCAST:1<<20,GIZMOS:1<<21,EDITOR:1<<22,UI_3D:1<<23,SCENE_GIZMO:1<<24,UI_2D:1<<25,PROFILER:1<<28,DEFAULT:1<<30,ALL:4294967295},Fp=e("Layers",function(){function e(){}return e.makeMaskInclude=function(e){for(var t,n=0,i=se(e);!(t=i()).done;)n|=t.value;return n},e.makeMaskExclude=function(t){return~e.makeMaskInclude(t)},e.addLayer=function(t,n){if(void 0!==n)if(n>19||n<0)console.warn("maximum layers reached.");else{var i=1<<n;e.Enum[t],F(2104,t),e.Enum[t]=i,rt.value(e.Enum,String(i),t),e.BitMask[t]=i,rt.value(e.BitMask,String(i),t)}else console.warn("bitNum can't be undefined")},e.deleteLayer=function(t){if(t>19||t<0)console.warn("do not change buildin layers.");else{var n=1<<t;delete e.Enum[e.Enum[n]],delete e.Enum[n],delete e.BitMask[e.BitMask[n]],delete e.BitMask[n]}},e.nameToLayer=function(t){return void 0===t?(console.warn("name can't be undefined"),-1):r(e.Enum[t])},e.layerToName=function(t){return t>31||t<0?(console.warn("Unable to access unknown layer."),""):e.Enum[1<<t]},e}());Fp.Enum=st(Bp),Fp.BitMask=ot(J({},Bp)),u.Layers=Fp;var zp,Up,kp="MainFlow",Gp="ForwardFlow",Hp="ShadowFlow";!function(e){e[e.DEFAULT=100]="DEFAULT",e[e.UI=200]="UI"}(zp||(zp={})),u.RenderPassStage=zp,function(e){e[e.MIN=0]="MIN",e[e.MAX=255]="MAX",e[e.DEFAULT=128]="DEFAULT"}(Up||(Up={}));var Vp,Wp={bindings:[],layouts:{}},jp={bindings:[],layouts:{}};!function(e){e[e.UBO_GLOBAL=0]="UBO_GLOBAL",e[e.UBO_CAMERA=1]="UBO_CAMERA",e[e.UBO_SHADOW=2]="UBO_SHADOW",e[e.SAMPLER_SHADOWMAP=3]="SAMPLER_SHADOWMAP",e[e.SAMPLER_ENVIRONMENT=4]="SAMPLER_ENVIRONMENT",e[e.SAMPLER_SPOT_LIGHTING_MAP=5]="SAMPLER_SPOT_LIGHTING_MAP",e[e.SAMPLER_DIFFUSEMAP=6]="SAMPLER_DIFFUSEMAP",e[e.COUNT=7]="COUNT"}(Vp||(Vp={}));var qp,Xp=Vp.SAMPLER_SHADOWMAP,Yp=Vp.COUNT-Xp;!function(e){e[e.UBO_LOCAL=0]="UBO_LOCAL",e[e.UBO_FORWARD_LIGHTS=1]="UBO_FORWARD_LIGHTS",e[e.UBO_SKINNING_ANIMATION=2]="UBO_SKINNING_ANIMATION",e[e.UBO_SKINNING_TEXTURE=3]="UBO_SKINNING_TEXTURE",e[e.UBO_MORPH=4]="UBO_MORPH",e[e.UBO_UI_LOCAL=5]="UBO_UI_LOCAL",e[e.SAMPLER_JOINTS=6]="SAMPLER_JOINTS",e[e.SAMPLER_MORPH_POSITION=7]="SAMPLER_MORPH_POSITION",e[e.SAMPLER_MORPH_NORMAL=8]="SAMPLER_MORPH_NORMAL",e[e.SAMPLER_MORPH_TANGENT=9]="SAMPLER_MORPH_TANGENT",e[e.SAMPLER_LIGHTMAP=10]="SAMPLER_LIGHTMAP",e[e.SAMPLER_SPRITE=11]="SAMPLER_SPRITE",e[e.SAMPLER_REFLECTION=12]="SAMPLER_REFLECTION",e[e.STORAGE_REFLECTION=13]="STORAGE_REFLECTION",e[e.COUNT=14]="COUNT"}(qp||(qp={}));var Kp,Qp=qp.SAMPLER_JOINTS,Zp=qp.COUNT-Qp;!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.MATERIAL=1]="MATERIAL",e[e.LOCAL=2]="LOCAL"}(Kp||(Kp={}));var Jp=new ur;Jp.bufferOffsets=[0,Xp+Qp,Xp],Jp.samplerOffsets=[-Xp,Yp+Zp,Yp-Qp],Jp.flexibleSet=1;var $p=function(){};$p.SIZE=4*($p.COUNT=4+($p.SCREEN_SIZE_OFFSET=4+($p.NATIVE_SIZE_OFFSET=4+($p.TIME_OFFSET=0)))),$p.NAME="CCGlobal",$p.BINDING=Vp.UBO_GLOBAL,$p.DESCRIPTOR=new Gr($p.BINDING,ji.UNIFORM_BUFFER,1,Mi.ALL),$p.LAYOUT=new Tr(Kp.GLOBAL,$p.BINDING,$p.NAME,[new Sr("cc_time",mi.FLOAT4,1),new Sr("cc_screenSize",mi.FLOAT4,1),new Sr("cc_nativeSize",mi.FLOAT4,1)],1),Wp.layouts[$p.NAME]=$p.LAYOUT,Wp.bindings[$p.BINDING]=$p.DESCRIPTOR;var ed=function(){};ed.SIZE=4*(ed.COUNT=4+(ed.VIEW_PORT_OFFSET=4+(ed.NEAR_FAR_OFFSET=4+(ed.GLOBAL_FOG_ADD_OFFSET=4+(ed.GLOBAL_FOG_BASE_OFFSET=4+(ed.GLOBAL_FOG_COLOR_OFFSET=4+(ed.AMBIENT_GROUND_OFFSET=4+(ed.AMBIENT_SKY_OFFSET=4+(ed.MAIN_LIT_COLOR_OFFSET=4+(ed.MAIN_LIT_DIR_OFFSET=4+(ed.EXPOSURE_OFFSET=4+(ed.SCREEN_SCALE_OFFSET=4+(ed.CAMERA_POS_OFFSET=16+(ed.MAT_VIEW_PROJ_INV_OFFSET=16+(ed.MAT_VIEW_PROJ_OFFSET=16+(ed.MAT_PROJ_INV_OFFSET=16+(ed.MAT_PROJ_OFFSET=16+(ed.MAT_VIEW_INV_OFFSET=16+(ed.MAT_VIEW_OFFSET=0))))))))))))))))))),ed.NAME="CCCamera",ed.BINDING=Vp.UBO_CAMERA,ed.DESCRIPTOR=new Gr(ed.BINDING,ji.UNIFORM_BUFFER,1,Mi.ALL),ed.LAYOUT=new Tr(Kp.GLOBAL,ed.BINDING,ed.NAME,[new Sr("cc_matView",mi.MAT4,1),new Sr("cc_matViewInv",mi.MAT4,1),new Sr("cc_matProj",mi.MAT4,1),new Sr("cc_matProjInv",mi.MAT4,1),new Sr("cc_matViewProj",mi.MAT4,1),new Sr("cc_matViewProjInv",mi.MAT4,1),new Sr("cc_cameraPos",mi.FLOAT4,1),new Sr("cc_screenScale",mi.FLOAT4,1),new Sr("cc_exposure",mi.FLOAT4,1),new Sr("cc_mainLitDir",mi.FLOAT4,1),new Sr("cc_mainLitColor",mi.FLOAT4,1),new Sr("cc_ambientSky",mi.FLOAT4,1),new Sr("cc_ambientGround",mi.FLOAT4,1),new Sr("cc_fogColor",mi.FLOAT4,1),new Sr("cc_fogBase",mi.FLOAT4,1),new Sr("cc_fogAdd",mi.FLOAT4,1),new Sr("cc_nearFar",mi.FLOAT4,1),new Sr("cc_viewPort",mi.FLOAT4,1)],1),Wp.layouts[ed.NAME]=ed.LAYOUT,Wp.bindings[ed.BINDING]=ed.DESCRIPTOR;var td=function(){};td.SIZE=4*(td.COUNT=4+(td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET=4+(td.SHADOW_COLOR_OFFSET=4+(td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET=4+(td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET=4+(td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET=4+(td.SHADOW_PROJ_INFO_OFFSET=4+(td.SHADOW_PROJ_DEPTH_INFO_OFFSET=4+(td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET=16+(td.MAT_LIGHT_VIEW_PROJ_OFFSET=16+(td.MAT_LIGHT_VIEW_OFFSET=16+(td.MAT_LIGHT_PLANE_PROJ_OFFSET=0)))))))))))),td.NAME="CCShadow",td.BINDING=Vp.UBO_SHADOW,td.DESCRIPTOR=new Gr(td.BINDING,ji.UNIFORM_BUFFER,1,Mi.ALL),td.LAYOUT=new Tr(Kp.GLOBAL,td.BINDING,td.NAME,[new Sr("cc_matLightPlaneProj",mi.MAT4,1),new Sr("cc_matLightView",mi.MAT4,1),new Sr("cc_matLightViewProj",mi.MAT4,1),new Sr("cc_shadowInvProjDepthInfo",mi.FLOAT4,1),new Sr("cc_shadowProjDepthInfo",mi.FLOAT4,1),new Sr("cc_shadowProjInfo",mi.FLOAT4,1),new Sr("cc_shadowNFLSInfo",mi.FLOAT4,1),new Sr("cc_shadowWHPBInfo",mi.FLOAT4,1),new Sr("cc_shadowLPNNInfo",mi.FLOAT4,1),new Sr("cc_shadowColor",mi.FLOAT4,1),new Sr("cc_planarNDInfo",mi.FLOAT4,1)],1),Wp.layouts[td.NAME]=td.LAYOUT,Wp.bindings[td.BINDING]=td.DESCRIPTOR;var nd=Vp.SAMPLER_SHADOWMAP,id=new Gr(nd,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),rd=new br(Kp.GLOBAL,nd,"cc_shadowMap",mi.SAMPLER2D,1);Wp.layouts.cc_shadowMap=rd,Wp.bindings[nd]=id;var od=Vp.SAMPLER_ENVIRONMENT,ad=new Gr(od,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),sd=new br(Kp.GLOBAL,od,"cc_environment",mi.SAMPLER_CUBE,1);Wp.layouts.cc_environment=sd,Wp.bindings[od]=ad;var cd=Vp.SAMPLER_DIFFUSEMAP,ld=new Gr(cd,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),ud=new br(Kp.GLOBAL,cd,"cc_diffuseMap",mi.SAMPLER_CUBE,1);Wp.layouts.cc_diffuseMap=ud,Wp.bindings[cd]=ld;var hd=Vp.SAMPLER_SPOT_LIGHTING_MAP,fd=new Gr(hd,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),_d=new br(Kp.GLOBAL,hd,"cc_spotLightingMap",mi.SAMPLER2D,1);Wp.layouts.cc_spotLightingMap=_d,Wp.bindings[hd]=fd;var pd=function(){};pd.SIZE=4*(pd.COUNT=4+(pd.LIGHTINGMAP_UVPARAM=16+(pd.MAT_WORLD_IT_OFFSET=16+(pd.MAT_WORLD_OFFSET=0)))),pd.NAME="CCLocal",pd.BINDING=qp.UBO_LOCAL,pd.DESCRIPTOR=new Gr(pd.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX|Mi.COMPUTE),pd.LAYOUT=new Tr(Kp.LOCAL,pd.BINDING,pd.NAME,[new Sr("cc_matWorld",mi.MAT4,1),new Sr("cc_matWorldIT",mi.MAT4,1),new Sr("cc_lightingMapUVParam",mi.FLOAT4,1)],1),jp.layouts[pd.NAME]=pd.LAYOUT,jp.bindings[pd.BINDING]=pd.DESCRIPTOR;var dd=function(){};dd.SIZE=4*(dd.COUNT=4+(dd.WORLD_BOUND_HALF_EXTENTS=4+(dd.WORLD_BOUND_CENTER=0))),dd.NAME="CCWorldBound",dd.BINDING=qp.UBO_LOCAL,dd.DESCRIPTOR=new Gr(dd.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX|Mi.COMPUTE),dd.LAYOUT=new Tr(Kp.LOCAL,dd.BINDING,dd.NAME,[new Sr("cc_worldBoundCenter",mi.FLOAT4,1),new Sr("cc_worldBoundHalfExtents",mi.FLOAT4,1)],1),jp.layouts[dd.NAME]=dd.LAYOUT,jp.bindings[dd.BINDING]=dd.DESCRIPTOR;var md="a_matWorld0",vd=function(){};vd.BATCHING_COUNT=10,vd.MAT_WORLDS_OFFSET=0,vd.SIZE=4*(vd.COUNT=16*vd.BATCHING_COUNT),vd.NAME="CCLocalBatched",vd.BINDING=qp.UBO_LOCAL,vd.DESCRIPTOR=new Gr(vd.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX|Mi.COMPUTE),vd.LAYOUT=new Tr(Kp.LOCAL,vd.BINDING,vd.NAME,[new Sr("cc_matWorlds",mi.MAT4,vd.BATCHING_COUNT)],1),jp.layouts[vd.NAME]=vd.LAYOUT,jp.bindings[vd.BINDING]=vd.DESCRIPTOR;var gd=function(){};gd.LIGHTS_PER_PASS=1,gd.SIZE=4*(gd.COUNT=(gd.LIGHT_DIR_OFFSET=(gd.LIGHT_SIZE_RANGE_ANGLE_OFFSET=(gd.LIGHT_COLOR_OFFSET=(gd.LIGHT_POS_OFFSET=0)+4*gd.LIGHTS_PER_PASS)+4*gd.LIGHTS_PER_PASS)+4*gd.LIGHTS_PER_PASS)+4*gd.LIGHTS_PER_PASS),gd.NAME="CCForwardLight",gd.BINDING=qp.UBO_FORWARD_LIGHTS,gd.DESCRIPTOR=new Gr(gd.BINDING,ji.DYNAMIC_UNIFORM_BUFFER,1,Mi.FRAGMENT),gd.LAYOUT=new Tr(Kp.LOCAL,gd.BINDING,gd.NAME,[new Sr("cc_lightPos",mi.FLOAT4,gd.LIGHTS_PER_PASS),new Sr("cc_lightColor",mi.FLOAT4,gd.LIGHTS_PER_PASS),new Sr("cc_lightSizeRangeAngle",mi.FLOAT4,gd.LIGHTS_PER_PASS),new Sr("cc_lightDir",mi.FLOAT4,gd.LIGHTS_PER_PASS)],1),jp.layouts[gd.NAME]=gd.LAYOUT,jp.bindings[gd.BINDING]=gd.DESCRIPTOR;var yd=function(){};yd.LIGHTS_PER_PASS=10;var xd=function(){};xd.SIZE=4*(xd.COUNT=4+(xd.JOINTS_TEXTURE_INFO_OFFSET=0)),xd.NAME="CCSkinningTexture",xd.BINDING=qp.UBO_SKINNING_TEXTURE,xd.DESCRIPTOR=new Gr(xd.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX),xd.LAYOUT=new Tr(Kp.LOCAL,xd.BINDING,xd.NAME,[new Sr("cc_jointTextureInfo",mi.FLOAT4,1)],1),jp.layouts[xd.NAME]=xd.LAYOUT,jp.bindings[xd.BINDING]=xd.DESCRIPTOR;var Sd=function(){};Sd.SIZE=4*(Sd.COUNT=4+(Sd.JOINTS_ANIM_INFO_OFFSET=0)),Sd.NAME="CCSkinningAnimation",Sd.BINDING=qp.UBO_SKINNING_ANIMATION,Sd.DESCRIPTOR=new Gr(Sd.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX),Sd.LAYOUT=new Tr(Kp.LOCAL,Sd.BINDING,Sd.NAME,[new Sr("cc_jointAnimInfo",mi.FLOAT4,1)],1),jp.layouts[Sd.NAME]=Sd.LAYOUT,jp.bindings[Sd.BINDING]=Sd.DESCRIPTOR;var Td="a_jointAnimInfo",bd=function(){};bd.SIZE=4*(bd.COUNT=360+(bd.JOINTS_OFFSET=0)),bd.NAME="CCSkinning",bd.BINDING=qp.UBO_SKINNING_TEXTURE,bd.DESCRIPTOR=new Gr(bd.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX),bd.LAYOUT=new Tr(Kp.LOCAL,bd.BINDING,bd.NAME,[new Sr("cc_joints",mi.FLOAT4,90)],1),jp.layouts[bd.NAME]=bd.LAYOUT,jp.bindings[bd.BINDING]=bd.DESCRIPTOR;var Ed=function(){};Ed.MAX_MORPH_TARGET_COUNT=60,Ed.OFFSET_OF_WEIGHTS=0,Ed.OFFSET_OF_VERTICES_COUNT=4+(Ed.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT=4+(Ed.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH=4*Ed.MAX_MORPH_TARGET_COUNT)),Ed.COUNT_BASE_4_BYTES=4*Math.ceil(Ed.MAX_MORPH_TARGET_COUNT/4)+4,Ed.SIZE=4*Ed.COUNT_BASE_4_BYTES,Ed.NAME="CCMorph",Ed.BINDING=qp.UBO_MORPH,Ed.DESCRIPTOR=new Gr(Ed.BINDING,ji.UNIFORM_BUFFER,1,Mi.VERTEX),Ed.LAYOUT=new Tr(Kp.LOCAL,Ed.BINDING,Ed.NAME,[new Sr("cc_displacementWeights",mi.FLOAT4,Ed.MAX_MORPH_TARGET_COUNT/4),new Sr("cc_displacementTextureInfo",mi.FLOAT4,1)],1),jp.layouts[Ed.NAME]=Ed.LAYOUT,jp.bindings[Ed.BINDING]=Ed.DESCRIPTOR;var Cd=function(){};Cd.NAME="CCUILocal",Cd.BINDING=qp.UBO_UI_LOCAL,Cd.DESCRIPTOR=new Gr(Cd.BINDING,ji.DYNAMIC_UNIFORM_BUFFER,1,Mi.VERTEX),Cd.LAYOUT=new Tr(Kp.LOCAL,Cd.BINDING,Cd.NAME,[new Sr("cc_local_data",mi.FLOAT4,1)],1),jp.layouts[Cd.NAME]=Cd.LAYOUT,jp.bindings[Cd.BINDING]=Cd.DESCRIPTOR;var Ad=qp.SAMPLER_JOINTS,wd=new Gr(Ad,ji.SAMPLER_TEXTURE,1,Mi.VERTEX),Pd=new br(Kp.LOCAL,Ad,"cc_jointTexture",mi.SAMPLER2D,1);jp.layouts.cc_jointTexture=Pd,jp.bindings[Ad]=wd;var Rd=qp.SAMPLER_MORPH_POSITION,Id=new Gr(Rd,ji.SAMPLER_TEXTURE,1,Mi.VERTEX),Dd=new br(Kp.LOCAL,Rd,"cc_PositionDisplacements",mi.SAMPLER2D,1);jp.layouts.cc_PositionDisplacements=Dd,jp.bindings[Rd]=Id;var Od=qp.SAMPLER_MORPH_NORMAL,Md=new Gr(Od,ji.SAMPLER_TEXTURE,1,Mi.VERTEX),Nd=new br(Kp.LOCAL,Od,"cc_NormalDisplacements",mi.SAMPLER2D,1);jp.layouts.cc_NormalDisplacements=Nd,jp.bindings[Od]=Md;var Ld=qp.SAMPLER_MORPH_TANGENT,Bd=new Gr(Ld,ji.SAMPLER_TEXTURE,1,Mi.VERTEX),Fd=new br(Kp.LOCAL,Ld,"cc_TangentDisplacements",mi.SAMPLER2D,1);jp.layouts.cc_TangentDisplacements=Fd,jp.bindings[Ld]=Bd;var zd=qp.SAMPLER_LIGHTMAP,Ud=new Gr(zd,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),kd=new br(Kp.LOCAL,zd,"cc_lightingMap",mi.SAMPLER2D,1);jp.layouts.cc_lightingMap=kd,jp.bindings[zd]=Ud;var Gd=qp.SAMPLER_SPRITE,Hd=new Gr(Gd,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),Vd=new br(Kp.LOCAL,Gd,"cc_spriteTexture",mi.SAMPLER2D,1);jp.layouts.cc_spriteTexture=Vd,jp.bindings[Gd]=Hd;var Wd=qp.SAMPLER_REFLECTION,jd=new Gr(Wd,ji.SAMPLER_TEXTURE,1,Mi.FRAGMENT),qd=new br(Kp.LOCAL,Wd,"cc_reflectionTexture",mi.SAMPLER2D,1);jp.layouts.cc_reflectionTexture=qd,jp.bindings[Wd]=jd;var Xd=qp.STORAGE_REFLECTION,Yd=new Gr(Xd,ji.STORAGE_IMAGE,1,Mi.COMPUTE),Kd=new Ar(Kp.LOCAL,Xd,"cc_reflectionStorage",mi.IMAGE2D,1);jp.layouts.cc_reflectionStorage=Kd,jp.bindings[Xd]=Yd;var Qd,Zd,Jd=Fp.makeMaskExclude([Fp.BitMask.UI_2D,Fp.BitMask.GIZMOS,Fp.BitMask.EDITOR,Fp.BitMask.SCENE_GIZMO,Fp.BitMask.PROFILER]),$d=Fp.makeMaskExclude([Fp.BitMask.UI_2D,Fp.BitMask.PROFILER]),em=Fp.Enum.ALL;function tm(e){return e.hasFeature(_i.COLOR_FLOAT)&&e.hasFeature(_i.TEXTURE_FLOAT)&&!(e.gfxAPI===hi.WEBGL)}e("pipeline",Object.freeze({__proto__:null,PIPELINE_FLOW_MAIN:kp,PIPELINE_FLOW_FORWARD:Gp,PIPELINE_FLOW_SHADOW:Hp,PIPELINE_FLOW_SMAA:"SMAAFlow",PIPELINE_FLOW_TONEMAP:"ToneMapFlow",get RenderPassStage(){return zp},get RenderPriority(){return Up},globalDescriptorSetLayout:Wp,localDescriptorSetLayout:jp,get PipelineGlobalBindings(){return Vp},get ModelLocalBindings(){return qp},get SetIndex(){return Kp},bindingMappingInfo:Jp,UBOGlobal:$p,UBOCamera:ed,UBOShadow:td,UNIFORM_SHADOWMAP_BINDING:nd,UNIFORM_ENVIRONMENT_BINDING:od,UNIFORM_DIFFUSEMAP_BINDING:cd,UNIFORM_SPOT_LIGHTING_MAP_TEXTURE_BINDING:hd,UBOLocal:pd,UBOWorldBound:dd,INST_MAT_WORLD:md,UBOLocalBatched:vd,UBOForwardLight:gd,UBODeferredLight:yd,JOINT_UNIFORM_CAPACITY:30,UBOSkinningTexture:xd,UBOSkinningAnimation:Sd,INST_JOINT_ANIM_INFO:Td,UBOSkinning:bd,UBOMorph:Ed,UBOUILocal:Cd,UNIFORM_JOINT_TEXTURE_BINDING:Ad,UNIFORM_POSITION_MORPH_TEXTURE_BINDING:Rd,UNIFORM_NORMAL_MORPH_TEXTURE_BINDING:Od,UNIFORM_TANGENT_MORPH_TEXTURE_BINDING:Ld,UNIFORM_LIGHTMAP_TEXTURE_BINDING:zd,UNIFORM_SPRITE_TEXTURE_BINDING:Gd,UNIFORM_REFLECTION_TEXTURE_BINDING:Wd,UNIFORM_REFLECTION_STORAGE_BINDING:Xd,CAMERA_DEFAULT_MASK:Jd,CAMERA_EDITOR_MASK:$d,MODEL_ALWAYS_MASK:em,supportsHalfFloatTexture:function(e){return e.hasFeature(_i.COLOR_HALF_FLOAT)&&e.hasFeature(_i.TEXTURE_HALF_FLOAT)&&!(e.gfxAPI===hi.WEBGL)},supportsFloatTexture:tm}));var nm=4227858432,im=66060288,rm=1044480,om=function(e,t,n,i){return void 0===i&&(i=0),t<<26&nm|e<<20&im|n<<12&rm|4095&i},am=function(e){return(e&nm)>>>26},sm=function(e){return(e&im)>>>20},cm=function(e){return(e&rm)>>>12},lm=function(e){return 4095&e},um=function(e,t){return 67108863&e|t<<26&nm},hm=((Qd={})[mi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Qd[mi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Qd[mi.INT2]=function(e,t,n){return void 0===n&&(n=0),Kn.fromArray(t,e,n)},Qd[mi.INT3]=function(e,t,n){return void 0===n&&(n=0),In.fromArray(t,e,n)},Qd[mi.INT4]=function(e,t,n){return void 0===n&&(n=0),$n.fromArray(t,e,n)},Qd[mi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]},Qd[mi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Kn.fromArray(t,e,n)},Qd[mi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),In.fromArray(t,e,n)},Qd[mi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),$n.fromArray(t,e,n)},Qd[mi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.fromArray(t,e,n)},Qd[mi.MAT4]=function(e,t,n){return void 0===n&&(n=0),jn.fromArray(t,e,n)},Qd),fm=((Zd={})[mi.UNKNOWN]=function(){return console.warn("illegal uniform handle")},Zd[mi.INT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Zd[mi.INT2]=function(e,t,n){return void 0===n&&(n=0),Kn.toArray(e,t,n)},Zd[mi.INT3]=function(e,t,n){return void 0===n&&(n=0),In.toArray(e,t,n)},Zd[mi.INT4]=function(e,t,n){return void 0===n&&(n=0),$n.toArray(e,t,n)},Zd[mi.FLOAT]=function(e,t,n){return void 0===n&&(n=0),e[n]=t},Zd[mi.FLOAT2]=function(e,t,n){return void 0===n&&(n=0),Kn.toArray(e,t,n)},Zd[mi.FLOAT3]=function(e,t,n){return void 0===n&&(n=0),In.toArray(e,t,n)},Zd[mi.FLOAT4]=function(e,t,n){return void 0===n&&(n=0),$n.toArray(e,t,n)},Zd[mi.MAT3]=function(e,t,n){return void 0===n&&(n=0),Nn.toArray(e,t,n)},Zd[mi.MAT4]=function(e,t,n){return void 0===n&&(n=0),jn.toArray(e,t,n)},Zd),_m=[Object.freeze([0]),Object.freeze([0,0]),Object.freeze([0,0,0,0]),Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])];function pm(e){switch(e){case mi.BOOL:case mi.INT:case mi.UINT:case mi.FLOAT:return _m[0];case mi.BOOL2:case mi.INT2:case mi.UINT2:case mi.FLOAT2:return _m[1];case mi.BOOL4:case mi.INT4:case mi.UINT4:case mi.FLOAT4:return _m[2];case mi.MAT4:return _m[3];case mi.SAMPLER2D:return"default-texture";case mi.SAMPLER_CUBE:return"default-cube-texture"}return _m[0]}function dm(e,t){for(var n=Object.entries(t),i=!1,r=0;r<n.length;r++)e[n[r][0]]!==n[r][1]&&(e[n[r][0]]=n[r][1],i=!0);return i}var mm=new Hr;function vm(e){return Math.ceil(Math.log2(Math.max(e,2)))}function gm(e,t){switch(e.type){case"boolean":return"number"==typeof t?t.toString():t?"1":"0";case"string":return void 0!==t?t:e.options[0];case"number":return void 0!==t?t.toString():e.range[0].toString();default:return console.warn("unknown define type '"+e.type+"'"),"-1"}}function ym(e,t,n,i,r){for(var o=e.builtins[i],a=[],s=function(e){var t=o.blocks[e],i=n.layouts[t.name],s=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&s&&s.descriptorType&to))return console.warn("builtin UBO '"+t.name+"' not available!"),"continue";a.push(i),r&&!r.includes(s)&&r.push(s)},c=0;c<o.blocks.length;c++)s(c);Array.prototype.unshift.apply(t.shaderInfo.blocks,a);for(var l=[],u=function(e){var t=o.samplerTextures[e],i=n.layouts[t.name],a=i&&n.bindings.find((function(e){return e.binding===i.binding}));if(!(i&&a&&a.descriptorType&no))return console.warn("builtin samplerTexture '"+t.name+"' not available!"),"continue";l.push(i),r&&!r.includes(a)&&r.push(a)},h=0;h<o.samplerTextures.length;h++)u(h);Array.prototype.unshift.apply(t.shaderInfo.samplerTextures,l),r&&r.sort((function(e,t){return e.binding-t.binding}))}function xm(e){return e.members.reduce((function(e,t){return e+lo(t.type)*t.count}),0)}function Sm(e,t){for(var n=0;n<e.length;n++){var i=e[n];if("!"===i[0]){if(t[i.slice(1)])return!1}else if(!t[i])return!1}return!0}function Tm(e){switch(e.gfxAPI){case hi.GLES2:case hi.WEBGL:return"glsl1";case hi.GLES3:case hi.WEBGL2:return"glsl3";default:return"glsl4"}}var bm,Em,Cm,Am,wm,Pm,Rm,Im,Dm=new(function(){function e(){this._templates={},this._cache={},this._templateInfos={}}var t=e.prototype;return t.register=function(e){for(var t=0;t<e.shaders.length;t++)this.define(e.shaders[t]).effectName=e.name;for(var n=0;n<e.techniques.length;n++)for(var i=e.techniques[n],r=0;r<i.passes.length;r++){var o=i.passes[r];void 0!==o.propertyIndex&&void 0===o.properties&&(o.properties=i.passes[o.propertyIndex].properties)}},t.define=function(e){var t=this._templates[e.name];if(t&&t.hash===e.hash)return t;for(var n=J({},e),i=0,r=function(e){var t=n.defines[e],r=1;if("number"===t.type){var o=t.range;r=vm(o[1]-o[0]+1),t._map=function(e){return e-o[0]}}else"string"===t.type?(r=vm(t.options.length),t._map=function(e){return Math.max(0,t.options.findIndex((function(t){return t===e})))}):"boolean"===t.type&&(t._map=function(e){return e?1:0});t._offset=i,i+=r},o=0;o<n.defines.length;o++)r(o);for(var a in i>31&&(n.uber=!0),n.constantMacros="",n.builtins.statistics)n.constantMacros+="#define "+a+" "+n.builtins.statistics[a]+"\n";if(this._templates[e.name]=n,!this._templateInfos[n.hash]){var s={};s.samplerStartBinding=n.blocks.length,s.shaderInfo=new Dr,s.blockSizes=[],s.bindings=[];for(var c=0;c<n.blocks.length;c++){var l=n.blocks[c];s.blockSizes.push(xm(l)),s.bindings.push(new Gr(l.binding,ji.UNIFORM_BUFFER,1,l.stageFlags)),s.shaderInfo.blocks.push(new Tr(Kp.MATERIAL,l.binding,l.name,l.members.map((function(e){return new Sr(e.name,e.type,e.count)})),1))}for(var u=0;u<n.samplerTextures.length;u++){var h=n.samplerTextures[u];s.bindings.push(new Gr(h.binding,ji.SAMPLER_TEXTURE,h.count,h.stageFlags)),s.shaderInfo.samplerTextures.push(new br(Kp.MATERIAL,h.binding,h.name,h.type,h.count))}for(var f=0;f<n.samplers.length;f++){var _=n.samplers[f];s.bindings.push(new Gr(_.binding,ji.SAMPLER,_.count,_.stageFlags)),s.shaderInfo.samplers.push(new Er(Kp.MATERIAL,_.binding,_.name,_.count))}for(var p=0;p<n.textures.length;p++){var d=n.textures[p];s.bindings.push(new Gr(d.binding,ji.TEXTURE,d.count,d.stageFlags)),s.shaderInfo.textures.push(new Cr(Kp.MATERIAL,d.binding,d.name,d.type,d.count))}for(var m=0;m<n.buffers.length;m++){var v=n.buffers[m];s.bindings.push(new Gr(v.binding,ji.STORAGE_BUFFER,1,v.stageFlags)),s.shaderInfo.buffers.push(new wr(Kp.MATERIAL,v.binding,v.name,1,v.memoryAccess))}for(var g=0;g<n.images.length;g++){var y=n.images[g];s.bindings.push(new Gr(y.binding,ji.STORAGE_IMAGE,y.count,y.stageFlags)),s.shaderInfo.images.push(new Ar(Kp.MATERIAL,y.binding,y.name,y.type,y.count,y.memoryAccess))}for(var x=0;x<n.subpassInputs.length;x++){var S=n.subpassInputs[x];s.bindings.push(new Gr(S.binding,ji.INPUT_ATTACHMENT,S.count,S.stageFlags)),s.shaderInfo.subpassInputs.push(new Pr(Kp.MATERIAL,S.binding,S.name,S.count))}s.gfxAttributes=[];for(var T=0;T<n.attributes.length;T++){var b=n.attributes[T];s.gfxAttributes.push(new Ir(b.name,b.format,b.isNormalized,0,b.isInstanced,b.location))}ym(n,s,jp,"locals"),s.shaderInfo.stages.push(new Rr(Mi.VERTEX,"")),s.shaderInfo.stages.push(new Rr(Mi.FRAGMENT,"")),s.handleMap=function(e){for(var t={},n=0;n<e.blocks.length;n++)for(var i=e.blocks[n],r=i.members,o=0,a=0;a<r.length;a++){var s=r[a];t[s.name]=om(i.binding,s.type,s.count,o),o+=(lo(s.type)>>2)*s.count}for(var c=0;c<e.samplerTextures.length;c++){var l=e.samplerTextures[c];t[l.name]=om(l.binding,l.type,l.count)}return t}(n),s.setLayouts=[],this._templateInfos[n.hash]=s}return n},t.getTemplate=function(e){return this._templates[e]},t.getTemplateInfo=function(e){var t=this._templates[e].hash;return this._templateInfos[t]},t.getDescriptorSetLayout=function(e,t,n){void 0===n&&(n=!1);var i=this._templates[t],r=this._templateInfos[i.hash];return r.setLayouts.length||(mm.bindings=r.bindings,r.setLayouts[Kp.MATERIAL]=e.createDescriptorSetLayout(mm),mm.bindings=jp.bindings,r.setLayouts[Kp.LOCAL]=e.createDescriptorSetLayout(mm)),r.setLayouts[n?Kp.LOCAL:Kp.MATERIAL]},t.hasProgram=function(e){return void 0!==this._templates[e]},t.getKey=function(e,t){var n=this._templates[e],i=n.defines;if(n.uber){for(var r="",o=0;o<i.length;o++){var a=i[o],s=t[a.name];if(s&&a._map){var c=a._map(s);r+=""+a._offset+c+"|"}}return""+r+n.hash}for(var l=0,u=0;u<i.length;u++){var h=i[u],f=t[h.name];f&&h._map&&(l|=h._map(f)<<h._offset)}return l.toString(16)+"|"+n.hash},t.destroyShaderByDefines=function(e){var t=this,n=Object.keys(e);if(n.length)for(var i=n.map((function(t){var n=e[t];return"boolean"==typeof n&&(n=n?"1":"0"),new RegExp(""+t+n)})),r=Object.keys(this._cache).filter((function(e){return i.every((function(n){return n.test(t._cache[e].name)}))})),o=0;o<r.length;o++){var a=r[o],s=this._cache[a];E("destroyed shader "+s.name),s.destroy(),delete this._cache[a]}},t.getGFXShader=function(e,t,n,i,r){Object.assign(n,i.macros),r||(r=this.getKey(t,n));var o=this._cache[r];if(o)return o;var a=this._templates[t],s=this._templateInfos[a.hash];s.pipelineLayout||(this.getDescriptorSetLayout(e,t),ym(a,s,Wp,"globals"),s.setLayouts[Kp.GLOBAL]=i.descriptorSetLayout,s.pipelineLayout=e.createPipelineLayout(new Wr(s.setLayouts)));var c=function(e,t){for(var n=[],i=0;i<t.length;i++){var r=t[i],o=r.name,a=e[o],s=gm(r,a),c=!a||"0"===a;n.push({name:o,value:s,isDefault:c})}return n}(n,a.defines),l=i.constantMacros+a.constantMacros+c.reduce((function(e,t){return e+"#define "+t.name+" "+t.value+"\n"}),""),u=a.glsl3,h=Tm(e);return h?u=a[h]:console.error("Invalid GFX API!"),s.shaderInfo.stages[0].source=l+u.vert,s.shaderInfo.stages[1].source=l+u.frag,s.shaderInfo.attributes=function(e,t,n){for(var i=[],r=e.attributes,o=t.gfxAttributes,a=0;a<r.length;a++)Sm(r[a].defines,n)&&i.push(o[a]);return i}(a,s,n),s.shaderInfo.name=function(e,t){return e+t.reduce((function(e,t){return t.isDefault?e:e+"|"+t.name+t.value}),"")}(t,c),this._cache[r]=e.createShader(s.shaderInfo)},e}());u.programLib=Dm;var Om=e("EffectAsset",mc("cc.EffectAsset")((Im=Rm=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"techniques",Cm,oe(t)),ce(t,"shaders",Am,oe(t)),ce(t,"combinations",wm,oe(t)),ce(t,"hideInEditor",Pm,oe(t)),t}$(t,e),t.register=function(e){t._effects[e.name]=e},t.remove=function(e){if("string"!=typeof e)t._effects[e.name]&&t._effects[e.name].equals(e)&&delete t._effects[e.name];else{if(t._effects[e])return void delete t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return void delete t._effects[n]}},t.get=function(e){if(t._effects[e])return t._effects[e];for(var n in t._effects)if(t._effects[n]._uuid===e)return t._effects[n];return null},t.getAll=function(){return t._effects};var n=t.prototype;return n.onLoaded=function(){Dm.register(this),t.register(this),u.game.once(u.Game.EVENT_ENGINE_INITED,this._precompile,this)},n._precompile=function(){for(var e=this,t=u.director.root,n=function(n){var i=e.shaders[n],r=e.combinations[n];if(!r)return"continue";Object.keys(r).reduce((function(e,t){return e.reduce((function(e,n){for(var i=r[t],o=0;o<i.length;++o){var a=J({},n);a[t]=i[o],e.push(a)}return e}),[])}),[{}]).forEach((function(e){return Dm.getGFXShader(t.device,i.name,e,t.pipeline)}))},i=0;i<this.shaders.length;i++)n(i)},n.destroy=function(){return t.remove(this),e.prototype.destroy.call(this)},n.initDefault=function(n){e.prototype.initDefault.call(this,n);var i=t.get("unlit");this.name="unlit",this.shaders=i.shaders,this.combinations=i.combinations,this.techniques=i.techniques},n.validate=function(){return this.techniques.length>0&&this.shaders.length>0},t}(Nu),Rm._effects={},Cm=le((Em=Im).prototype,"techniques",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Am=le(Em.prototype,"shaders",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),wm=le(Em.prototype,"combinations",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Pm=le(Em.prototype,"hideInEditor",[Tc,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),bm=Em))||bm);u.EffectAsset=Om;var Mm,Nm,Lm,Bm,Fm,zm,Um,km,Gm,Hm,Vm,Wm,jm,qm,Xm,Ym=1024;!function(e){e[e.RGB565=pi.R5G6B5]="RGB565",e[e.RGB5A1=pi.RGB5A1]="RGB5A1",e[e.RGBA4444=pi.RGBA4]="RGBA4444",e[e.RGB888=pi.RGB8]="RGB888",e[e.RGB32F=pi.RGB32F]="RGB32F",e[e.RGBA8888=pi.RGBA8]="RGBA8888",e[e.RGBA32F=pi.RGBA32F]="RGBA32F",e[e.A8=pi.A8]="A8",e[e.I8=pi.L8]="I8",e[e.AI8=pi.LA8]="AI8",e[e.RGB_PVRTC_2BPPV1=pi.PVRTC_RGB2]="RGB_PVRTC_2BPPV1",e[e.RGBA_PVRTC_2BPPV1=pi.PVRTC_RGBA2]="RGBA_PVRTC_2BPPV1",e[e.RGB_A_PVRTC_2BPPV1=Ym++]="RGB_A_PVRTC_2BPPV1",e[e.RGB_PVRTC_4BPPV1=pi.PVRTC_RGB4]="RGB_PVRTC_4BPPV1",e[e.RGBA_PVRTC_4BPPV1=pi.PVRTC_RGBA4]="RGBA_PVRTC_4BPPV1",e[e.RGB_A_PVRTC_4BPPV1=Ym++]="RGB_A_PVRTC_4BPPV1",e[e.RGB_ETC1=pi.ETC_RGB8]="RGB_ETC1",e[e.RGBA_ETC1=Ym++]="RGBA_ETC1",e[e.RGB_ETC2=pi.ETC2_RGB8]="RGB_ETC2",e[e.RGBA_ETC2=pi.ETC2_RGBA8]="RGBA_ETC2",e[e.RGBA_ASTC_4x4=pi.ASTC_RGBA_4X4]="RGBA_ASTC_4x4",e[e.RGBA_ASTC_5x4=pi.ASTC_RGBA_5X4]="RGBA_ASTC_5x4",e[e.RGBA_ASTC_5x5=pi.ASTC_RGBA_5X5]="RGBA_ASTC_5x5",e[e.RGBA_ASTC_6x5=pi.ASTC_RGBA_6X5]="RGBA_ASTC_6x5",e[e.RGBA_ASTC_6x6=pi.ASTC_RGBA_6X6]="RGBA_ASTC_6x6",e[e.RGBA_ASTC_8x5=pi.ASTC_RGBA_8X5]="RGBA_ASTC_8x5",e[e.RGBA_ASTC_8x6=pi.ASTC_RGBA_8X6]="RGBA_ASTC_8x6",e[e.RGBA_ASTC_8x8=pi.ASTC_RGBA_8X8]="RGBA_ASTC_8x8",e[e.RGBA_ASTC_10x5=pi.ASTC_RGBA_10X5]="RGBA_ASTC_10x5",e[e.RGBA_ASTC_10x6=pi.ASTC_RGBA_10X6]="RGBA_ASTC_10x6",e[e.RGBA_ASTC_10x8=pi.ASTC_RGBA_10X8]="RGBA_ASTC_10x8",e[e.RGBA_ASTC_10x10=pi.ASTC_RGBA_10X10]="RGBA_ASTC_10x10",e[e.RGBA_ASTC_12x10=pi.ASTC_RGBA_12X10]="RGBA_ASTC_12x10",e[e.RGBA_ASTC_12x12=pi.ASTC_RGBA_12X12]="RGBA_ASTC_12x12"}(Mm||(Mm={})),function(e){e[e.REPEAT=wi.WRAP]="REPEAT",e[e.CLAMP_TO_EDGE=wi.CLAMP]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=wi.MIRROR]="MIRRORED_REPEAT",e[e.CLAMP_TO_BORDER=wi.BORDER]="CLAMP_TO_BORDER"}(Nm||(Nm={})),function(e){e[e.NONE=Ai.NONE]="NONE",e[e.LINEAR=Ai.LINEAR]="LINEAR",e[e.NEAREST=Ai.POINT]="NEAREST"}(Lm||(Lm={})),ut(pi);var Km,Qm,Zm,Jm,$m=new ve("Tex"),ev=mc("cc.TextureBase")((Xm=qm=function(e){function t(){var t;return ce(t=e.call(this)||this,"_format",zm,oe(t)),ce(t,"_minFilter",Um,oe(t)),ce(t,"_magFilter",km,oe(t)),ce(t,"_mipFilter",Gm,oe(t)),ce(t,"_wrapS",Hm,oe(t)),ce(t,"_wrapT",Vm,oe(t)),ce(t,"_wrapR",Wm,oe(t)),ce(t,"_anisotropy",jm,oe(t)),t._width=1,t._height=1,t._id=void 0,t._samplerInfo=new xr,t._gfxSampler=null,t._gfxDevice=null,t._textureHash=0,t._id=$m.getNewId(),t._gfxDevice=t._getGFXDevice(),t._textureHash=xo(t._id,666),t}$(t,e);var n=t.prototype;return n.getId=function(){return this._id},n.getPixelFormat=function(){return this._format},n.getAnisotropy=function(){return this._anisotropy},n.setWrapMode=function(e,t,n){void 0===n&&(n=e),this._wrapS=e,this._samplerInfo.addressU=e,this._wrapT=t,this._samplerInfo.addressV=t,this._wrapR=n,this._samplerInfo.addressW=n,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setFilters=function(e,t){this._minFilter=e,this._samplerInfo.minFilter=e,this._magFilter=t,this._samplerInfo.magFilter=t,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setMipFilter=function(e){this._mipFilter=e,this._samplerInfo.mipFilter=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.setAnisotropy=function(e){this._anisotropy=e,this._samplerInfo.maxAnisotropy=e,this._gfxDevice&&(this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo))},n.destroy=function(){var t,n=e.prototype.destroy.call(this);return n&&(null===(t=u.director.root)||void 0===t?void 0:t.batcher2D)&&u.director.root.batcher2D._releaseDescriptorSetCache(this._textureHash),n},n.getHash=function(){return this._textureHash},n.getGFXTexture=function(){return null},n.getSamplerInfo=function(){return this._samplerInfo},n.getGFXSampler=function(){return this._gfxSampler||(this._gfxDevice?this._gfxSampler=this._gfxDevice.getSampler(this._samplerInfo):M(9302)),this._gfxSampler},n._serialize=function(){return""},n._deserialize=function(e){var t=e.split(",");t.unshift(""),t.length>=5&&(this.setFilters(parseInt(t[1]),parseInt(t[2])),this.setWrapMode(parseInt(t[3]),parseInt(t[4]))),t.length>=7&&(this.setMipFilter(parseInt(t[5])),this.setAnisotropy(parseInt(t[6])))},n._getGFXDevice=function(){return u.director.root?u.director.root.device:null},n._getGFXFormat=function(){return this._getGFXPixelFormat(this._format)},n._setGFXFormat=function(e){this._format=void 0===e?Mm.RGBA8888:e},n._getGFXPixelFormat=function(e){return e===Mm.RGBA_ETC1?e=Mm.RGB_ETC1:e===Mm.RGB_A_PVRTC_4BPPV1?e=Mm.RGB_PVRTC_4BPPV1:e===Mm.RGB_A_PVRTC_2BPPV1&&(e=Mm.RGB_PVRTC_2BPPV1),e},Z(t,[{key:"isCompressed",get:function(){return this._format>=Mm.RGB_ETC1&&this._format<=Mm.RGBA_ASTC_12x12||this._format>=Mm.RGB_A_PVRTC_2BPPV1&&this._format<=Mm.RGBA_ETC1}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),t}(Nu),qm.PixelFormat=Mm,qm.WrapMode=Nm,qm.Filter=Lm,zm=le((Fm=Xm).prototype,"_format",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Mm.RGBA8888}}),Um=le(Fm.prototype,"_minFilter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lm.LINEAR}}),km=le(Fm.prototype,"_magFilter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lm.LINEAR}}),Gm=le(Fm.prototype,"_mipFilter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lm.NONE}}),Hm=le(Fm.prototype,"_wrapS",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nm.REPEAT}}),Vm=le(Fm.prototype,"_wrapT",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nm.REPEAT}}),Wm=le(Fm.prototype,"_wrapR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nm.REPEAT}}),jm=le(Fm.prototype,"_anisotropy",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bm=Fm))||Bm;function tv(e){return!!(u.sys.hasFeature(u.sys.Feature.IMAGE_BITMAP)&&e instanceof ImageBitmap)}u.TextureBase=ev;var nv=e("ImageAsset",mc("cc.ImageAsset")((Jm=Zm=function(e){function t(t){var n;return(n=e.call(this)||this)._nativeData=void 0,n._exportedExts=void 0,n._format=Mm.RGBA8888,n._width=0,n._height=0,n._nativeData={_data:null,width:0,height:0,format:0,_compressed:!1},void 0!==t&&n.reset(t),n}$(t,e);var n=t.prototype;return n.reset=function(e){tv(e)||e instanceof HTMLElement?this._nativeData=e:(this._nativeData=e,this._format=e.format)},n.destroy=function(){return this.data&&this.data instanceof HTMLImageElement?(this.data.src="",this._setRawAsset("")):tv(this.data)&&this.data.close&&this.data.close(),e.prototype.destroy.call(this)},n._serialize=function(){},n._deserialize=function(e){var n="";"string"==typeof e?n=e:(this._width=e.w,this._height=e.h,n=e.fmt);for(var i,r=u.director.root?u.director.root.device:null,o=n.split("_"),a=Number.MAX_VALUE,s=this._format,c="",l=u.macro.SUPPORT_TEXTURE_FORMATS,h=se(o);!(i=h()).done;){var f=i.value.split("@"),_=parseInt(f[0],void 0),p=t.extnames[_]||f[0],d=l.indexOf(p);if(-1!==d&&d<a){var m=f[1]?parseInt(f[1]):this._format;if(!(".astc"!==p||r&&r.hasFeature(_i.FORMAT_ASTC)))continue;if(!(".pvr"!==p||r&&r.hasFeature(_i.FORMAT_PVRTC)))continue;if(!(m!==Mm.RGB_ETC1&&m!==Mm.RGBA_ETC1||r&&r.hasFeature(_i.FORMAT_ETC1)))continue;if(!(m!==Mm.RGB_ETC2&&m!==Mm.RGBA_ETC2||r&&r.hasFeature(_i.FORMAT_ETC2)))continue;if(".webp"===p&&!u.sys.hasFeature(u.sys.Feature.WEBP))continue;a=d,c=p,s=m}}c?(this._setRawAsset(c),this._format=s):D(3121)},n.initDefault=function(n){if(e.prototype.initDefault.call(this,n),t._sharedPlaceHolderCanvas)this.reset(t._sharedPlaceHolderCanvas);else{var i=document.createElement("canvas"),r=i.getContext("2d"),o=i.width=i.height=2;r.fillStyle="#ff00ff",r.fillRect(0,0,o,o),this.reset(i),t._sharedPlaceHolderCanvas=i}},n.validate=function(){return!!this.data},Z(t,[{key:"_nativeAsset",get:function(){return this._nativeData},set:function(e){e instanceof HTMLElement||tv(e)||(e.format=e.format||this._format),this.reset(e)}},{key:"data",get:function(){return this._nativeData&&((e=this._nativeData)instanceof HTMLImageElement||e instanceof HTMLCanvasElement||tv(e))?this._nativeData:this._nativeData&&this._nativeData._data;var e}},{key:"width",get:function(){return this._nativeData.width||this._width}},{key:"height",get:function(){return this._nativeData.height||this._height}},{key:"format",get:function(){return this._format}},{key:"isCompressed",get:function(){return this._format>=Mm.RGB_ETC1&&this._format<=Mm.RGBA_ASTC_12x12||this._format>=Mm.RGB_A_PVRTC_2BPPV1&&this._format<=Mm.RGBA_ETC1}},{key:"url",get:function(){return this.nativeUrl}}]),t}(Nu),Zm.extnames=[".png",".jpg",".jpeg",".bmp",".webp",".pvr",".pkm",".astc"],Zm._sharedPlaceHolderCanvas=null,le((Qm=Jm).prototype,"_nativeAsset",[sl],Object.getOwnPropertyDescriptor(Qm.prototype,"_nativeAsset"),Qm.prototype),Km=Qm))||Km);u.ImageAsset=nv;var iv=new WeakMap,rv=new WeakSet,ov=new WeakSet;function av(e,t){var n;n=rh.safeFindClass;var i,r=Ah.pool.get();try{i=zh(e,r,{classFinder:n,customEnv:t})}catch(e){throw T(e),Ah.pool.put(r),e}i._uuid=t.__uuid__||"";for(var o=r.uuidList,a=r.uuidObjList,s=r.uuidPropList,c=r.uuidTypeList||[],l=[],u=0;u<o.length;u++){var h=o[u];l[u]={uuid:Bl(h),owner:a[u],prop:s[u],type:rt._getClassById(c[u])}}return iv.set(i,l),i._native&&rv.add(i),Ah.pool.put(r),i}var sv,cv=new(function(){function e(){this._depends=new yl}var t=e.prototype;return t.init=function(){this._depends.clear()},t.getNativeDep=function(e){var t=this._depends.get(e);return t&&t.nativeDep?J({},t.nativeDep):null},t.getDeps=function(e){return this._depends.has(e)?this._depends.get(e).deps:[]},t.getDepsRecursively=function(e){var t=Object.create(null),n=[];return this._descend(e,t,n),n},t.remove=function(e){this._depends.remove(e)},t.parse=function(e,t){var n,i,r=null;if(Array.isArray(t)||t.__type__||t instanceof ph){if(this._depends.has(e))return this._depends.get(e);if(!Array.isArray(t)||"number"==typeof(i=(n=t[5])[n.length-1])&&i<0)try{var o=av(t,{__uuid__:e});(r=this._parseDepsFromAsset(o)).nativeDep&&(r.nativeDep.uuid=e),El.add(e+"@import",o)}catch(t){bl.remove(e+"@import"),r={deps:[]}}else r={deps:this._parseDepsFromJson(t)}}else{if(this._depends.has(e)&&(r=this._depends.get(e)).parsedFromExistAsset)return r;r=this._parseDepsFromAsset(t)}return this._depends.add(e,r),r},t._parseDepsFromAsset=function(e){for(var t={deps:[],parsedFromExistAsset:!0},n=iv.get(e),i=0,r=n.length;i<r;i++)t.deps.push(n[i].uuid);return rv.has(e)&&(t.nativeDep=e._nativeDep),t},t._parseDepsFromJson=function(e){var t=function(e){return n=(t=e)[1],t[10].map((function(e){return n[e]}));var t,n}(e);return t.forEach((function(e,n){return t[n]=Bl(e)})),t},t._descend=function(e,t,n){for(var i=this.getDeps(e),r=0;r<i.length;r++){var o=i[r];t[o]||(t[o]=!0,n.push(o),this._descend(o,t,n))}},e}()),lv=[new sr];function uv(e){return e&&0==(e&e-1)}var hv,fv,_v,pv,dv,mv,vv=mc("cc.SimpleTexture")(sv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gfxTexture=null,t._mipmapLevel=1,t._textureWidth=0,t._textureHeight=0,t}$(t,e);var n=t.prototype;return n.getGFXTexture=function(){return this._gfxTexture},n.destroy=function(){return this._tryDestroyTexture(),e.prototype.destroy.call(this)},n.updateImage=function(){this.updateMipmaps(0)},n.updateMipmaps=function(){},n.uploadData=function(e,t,n){if(void 0===t&&(t=0),void 0===n&&(n=0),this._gfxTexture&&!(this._mipmapLevel<=t)){var i=this._getGFXDevice();if(i){var r=lv[0];r.texExtent.width=this._textureWidth>>t,r.texExtent.height=this._textureHeight>>t,r.texSubres.mipLevel=t,r.texSubres.baseArrayLayer=n,ArrayBuffer.isView(e)?i.copyBuffersToTexture([e],this._gfxTexture,lv):i.copyTexImagesToTexture([e],this._gfxTexture,lv)}}},n._assignImage=function(e,t,n){var i=e.data;if(i&&(this.uploadData(i,t,n),this._checkTextureLoaded(),ft.CLEANUP_IMAGE_CACHE)){var r=cv.getDeps(this._uuid),o=r.indexOf(e._uuid);-1!==o&&(fe(r,o),e.decRef())}},n._checkTextureLoaded=function(){this._textureReady()},n._textureReady=function(){this.loaded=!0,this.emit("load")},n._setMipmapLevel=function(e){this._mipmapLevel=e<1?1:e},n._getGfxTextureCreateInfo=function(){return null},n._tryReset=function(){if(this._tryDestroyTexture(),0!==this._mipmapLevel){var e=this._getGFXDevice();e&&this._createTexture(e)}},n._createTexture=function(e){if(0!==this._width&&0!==this._height){var t=bi.NONE;this._mipFilter!==Lm.NONE&&function(e,t,n){return!(e.gfxAPI===hi.WEBGL)||uv(t)&&uv(n)}(e,this._width,this._height)&&(this._mipmapLevel=function(e,t){for(var n=Math.max(e,t),i=0;n;)n>>=1,i++;return i}(this._width,this._height),t=bi.GEN_MIPMAP);var n=this._getGfxTextureCreateInfo({usage:Ti.SAMPLED|Ti.TRANSFER_DST,format:this._getGFXFormat(),levelCount:this._mipmapLevel,flags:t});if(n){var i=e.createTexture(n);this._textureWidth=n.width,this._textureHeight=n.height,this._gfxTexture=i}}},n._tryDestroyTexture=function(){this._gfxTexture&&(this._gfxTexture.destroy(),this._gfxTexture=null)},Z(t,[{key:"mipmapLevel",get:function(){return this._mipmapLevel}}]),t}(ev))||sv;u.SimpleTexture=vv;var gv,yv,xv,Sv,Tv,bv,Ev,Cv=e("Texture2D",(hv=mc("cc.Texture2D"),fv=Zc([nv]),hv((mv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_mipmaps",dv,oe(t)),t}$(t,e);var n=t.prototype;return n.initialize=function(){this.mipmaps=this._mipmaps},n.onLoaded=function(){this.initialize()},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.create=function(e,t,n,i){void 0===n&&(n=Mm.RGBA8888),void 0===i&&(i=1),this.reset({width:e,height:t,format:n,mipmapLevel:i})},n.toString=function(){return 0!==this._mipmaps.length?this._mipmaps[0].url:""},n.updateMipmaps=function(e,t){if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var n=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),i=0;i<n;++i){var r=e+i;this._assignImage(this._mipmaps[r],r)}},n.getHtmlElementObj=function(){return this._mipmaps[0]&&this._mipmaps[0].data instanceof HTMLElement?this._mipmaps[0].data:null},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.description=function(){return"<cc.Texture2D | Name = "+(this._mipmaps[0]?this._mipmaps[0].url:"")+" | Dimension = "+this.width+" x "+this.height+">"},n.releaseTexture=function(){this.destroy()},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r)if(this._mipmaps[r]=new nv,i.mipmaps[r]){var o=i.mipmaps[r];n.result.push(this._mipmaps,""+r,o,rt._getClassId(nv))}},n._getGfxTextureCreateInfo=function(e){var t=new gr(Si.TEX2D);return t.width=this._width,t.height=this._height,Object.assign(t,e)},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new nv;n.initDefault(),this.image=n},n.validate=function(){return this.mipmaps&&0!==this.mipmaps.length},Z(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0];this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){t._assignImage(e,n)}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(vv),dv=le((pv=mv).prototype,"_mipmaps",[fv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_v=pv))||_v));u.Texture2D=Cv,function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom",e[e.front=4]="front",e[e.back=5]="back"}(Ev||(Ev={}));var Av=e("TextureCube",mc("cc.TextureCube")((bv=Tv=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"isRGBE",xv,oe(t)),ce(t,"_mipmaps",Sv,oe(t)),t}$(t,e),t.fromTexture2DArray=function(e,n){for(var i=[],r=e.length/6,o=0;o<r;o++){var a=6*o;i.push({front:e[a+Ev.front].image,back:e[a+Ev.back].image,left:e[a+Ev.left].image,right:e[a+Ev.right].image,top:e[a+Ev.top].image,bottom:e[a+Ev.bottom].image})}return(n=n||new t).mipmaps=i,n};var n=t.prototype;return n.onLoaded=function(){this.mipmaps=this._mipmaps},n.reset=function(e){this._width=e.width,this._height=e.height,this._setGFXFormat(e.format),this._setMipmapLevel(e.mipmapLevel||1),this._tryReset()},n.updateMipmaps=function(e,t){var n=this;if(void 0===e&&(e=0),!(e>=this._mipmaps.length))for(var i=Math.min(void 0===t?this._mipmaps.length:t,this._mipmaps.length-e),r=function(t){var i=e+t;wv(n._mipmaps[i],(function(e,t){n._assignImage(e,i,t)}))},o=0;o<i;++o)r(o)},n.destroy=function(){return this._mipmaps=[],e.prototype.destroy.call(this)},n.releaseTexture=function(){this.mipmaps=[]},n._serialize=function(){return null},n._deserialize=function(t,n){var i=t;e.prototype._deserialize.call(this,i.base,n),this.isRGBE=i.rgbe,this._mipmaps=new Array(i.mipmaps.length);for(var r=0;r<i.mipmaps.length;++r){this._mipmaps[r]={front:new nv,back:new nv,left:new nv,right:new nv,top:new nv,bottom:new nv};var o=i.mipmaps[r],a=rt._getClassId(nv);n.result.push(this._mipmaps[r],"front",o.front,a),n.result.push(this._mipmaps[r],"back",o.back,a),n.result.push(this._mipmaps[r],"left",o.left,a),n.result.push(this._mipmaps[r],"right",o.right,a),n.result.push(this._mipmaps[r],"top",o.top,a),n.result.push(this._mipmaps[r],"bottom",o.bottom,a)}},n._getGfxTextureCreateInfo=function(e){var t=new gr(Si.CUBE);return t.width=this._width,t.height=this._height,t.layerCount=6,Object.assign(t,e),t},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new nv;n.initDefault(),this.mipmaps=[{front:n,back:n,top:n,bottom:n,left:n,right:n}]},n.validate=function(){return 0!==this._mipmaps.length&&!this._mipmaps.find((function(e){return!(e.top&&e.bottom&&e.front&&e.back&&e.left&&e.right)}))},Z(t,[{key:"mipmaps",get:function(){return this._mipmaps},set:function(e){var t=this;if(this._mipmaps=e,this._setMipmapLevel(this._mipmaps.length),this._mipmaps.length>0){var n=this._mipmaps[0].front;this.reset({width:n.width,height:n.height,format:n.format,mipmapLevel:this._mipmaps.length}),this._mipmaps.forEach((function(e,n){wv(e,(function(e,i){t._assignImage(e,n,i)}))}))}else this.reset({width:0,height:0,mipmapLevel:this._mipmaps.length})}},{key:"image",get:function(){return 0===this._mipmaps.length?null:this._mipmaps[0]},set:function(e){this.mipmaps=e?[e]:[]}}]),t}(vv),Tv.FaceIndex=Ev,xv=le((yv=bv).prototype,"isRGBE",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Sv=le(yv.prototype,"_mipmaps",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),gv=yv))||gv);function wv(e,t){t(e.front,Ev.front),t(e.back,Ev.back),t(e.left,Ev.left),t(e.right,Ev.right),t(e.top,Ev.top),t(e.bottom,Ev.bottom)}u.TextureCube=Av;var Pv,Rv,Iv,Dv=e("effects",[{name:"billboard",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"billboard|vert:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"billboard|vert:vs_main|tinted-fs:add",hash:2909832090,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:53,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"builtin",defines:[],binding:1,stageFlags:1,members:[{name:"cc_size_rotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:2,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"clear-stencil",techniques:[{passes:[{blendState:{targets:[{blend:!0}]},rasterizerState:{cullMode:0},program:"clear-stencil|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"clear-stencil|sprite-vs:vert|sprite-fs:frag",hash:3507038093,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:0,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"graphics",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:1,blendDst:4,blendSrcAlpha:1,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"graphics|vs:vert|fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"graphics|vs:vert|fs:frag",hash:2610213142,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1},{name:"a_dist",defines:[],format:11,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"occlusion-query",techniques:[{passes:[{rasterizerState:{cullMode:2},blendState:{targets:[{blendColorMask:0}]},program:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"occlusion-query|occlusion-query-vs:vert|occlusion-query-fs:frag",hash:1571978323,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:41,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCWorldBound",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-gpu",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-gpu|particle-vs-gpu:gpvs_main|tinted-fs:add",hash:1250077034,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:63,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"USE_VK_SHADER",type:"boolean"},{name:"COLOR_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"SIZE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"FORCE_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"VELOCITY_OVER_TIME_MODULE_ENABLE",type:"boolean"},{name:"TEXTURE_ANIMATION_MODULE_ENABLE",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position_starttime",defines:[],format:44,location:0},{name:"a_size_uv",defines:[],format:44,location:1},{name:"a_rotation_uv",defines:[],format:44,location:2},{name:"a_color",defines:[],format:44,location:3},{name:"a_dir_life",defines:[],format:44,location:4},{name:"a_rndSeed",defines:[],format:11,location:5},{name:"a_texCoord",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:7},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_color1",defines:["CC_RENDER_MODE"],format:44,location:9}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"SampleConstants",defines:[],binding:1,stageFlags:1,members:[{name:"u_sampleInfo",type:16,count:1}]},{name:"TickConstants",defines:[],binding:2,stageFlags:1,members:[{name:"u_worldRot",type:16,count:1},{name:"u_timeDelta",type:16,count:1}]},{name:"ColorConstant",defines:["COLOR_OVER_TIME_MODULE_ENABLE"],binding:3,stageFlags:1,members:[{name:"u_color_mode",type:5,count:1}]},{name:"RotationConstant",defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],binding:4,stageFlags:1,members:[{name:"u_rotation_mode",type:5,count:1}]},{name:"SizeConstant",defines:["SIZE_OVER_TIME_MODULE_ENABLE"],binding:5,stageFlags:1,members:[{name:"u_size_mode",type:5,count:1}]},{name:"ForceConstant",defines:["FORCE_OVER_TIME_MODULE_ENABLE"],binding:6,stageFlags:1,members:[{name:"u_force_mode",type:5,count:1},{name:"u_force_space",type:5,count:1}]},{name:"VelocityConstant",defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],binding:7,stageFlags:1,members:[{name:"u_velocity_mode",type:5,count:1},{name:"u_velocity_space",type:5,count:1}]},{name:"AnimationConstant",defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],binding:8,stageFlags:1,members:[{name:"u_anim_info",type:16,count:1}]},{name:"FragConstants",defines:[],binding:9,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"color_over_time_tex0",type:28,count:1,defines:["COLOR_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:10},{name:"rotation_over_time_tex0",type:28,count:1,defines:["ROTATION_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:11},{name:"size_over_time_tex0",type:28,count:1,defines:["SIZE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:12},{name:"force_over_time_tex0",type:28,count:1,defines:["FORCE_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:13},{name:"velocity_over_time_tex0",type:28,count:1,defines:["VELOCITY_OVER_TIME_MODULE_ENABLE"],stageFlags:1,binding:14},{name:"texture_animation_tex0",type:28,count:1,defines:["TEXTURE_ANIMATION_MODULE_ENABLE"],stageFlags:1,binding:15},{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:16}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle-trail",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle-trail|particle-trail:vs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},frameTile_velLenScale:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle-trail|particle-trail:vs_main|tinted-fs:add",hash:1437790364,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_DRAW_WIRE_FRAME",type:"boolean"},{name:"CC_USE_WORLD_SPACE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:44,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"particle",techniques:[{name:"add",passes:[{rasterizerState:{cullMode:0},blendState:{targets:[{blend:!0,blendSrc:2,blendDst:1,blendSrcAlpha:2,blendDstAlpha:1}]},program:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",depthStencilState:{depthTest:!0,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},mainTiling_Offset:{value:[1,1,0,0],type:16},tintColor:{value:[.5,.5,.5,.5],type:16}}}]}],shaders:[{name:"particle|particle-vs-legacy:lpvs_main|tinted-fs:add",hash:2554907268,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:52,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RENDER_MODE",type:"number",range:[0,4]},{name:"CC_USE_WORLD_SPACE",type:"boolean"},{name:"ROTATION_OVER_TIME_MODULE_ENABLE",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:32,location:1},{name:"a_texCoord1",defines:[],format:32,location:2},{name:"a_texCoord2",defines:[],format:32,location:3},{name:"a_color",defines:[],format:44,location:4},{name:"a_color1",defines:["CC_RENDER_MODE"],format:32,location:8},{name:"a_texCoord3",defines:["CC_RENDER_MODE"],format:32,location:6},{name:"a_normal",defines:["CC_RENDER_MODE"],format:32,location:7}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"mainTiling_Offset",type:16,count:1},{name:"frameTile_velLenScale",type:16,count:1},{name:"scale",type:16,count:1},{name:"nodeRotation",type:16,count:1}]},{name:"FragConstants",defines:[],binding:1,stageFlags:16,members:[{name:"tintColor",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"spine",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"spine|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"spine|sprite-vs:vert|sprite-fs:frag",hash:3192452405,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:[]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"TWO_COLORED",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2},{name:"a_color2",defines:["TWO_COLORED"],format:44,location:3}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"sprite",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"sprite|sprite-vs:vert|sprite-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{alphaThreshold:{value:[.5],type:13}}}]}],shaders:[{name:"sprite|sprite-vs:vert|sprite-fs:frag",hash:1770338543,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:48,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:["USE_LOCAL"]}],samplerTextures:[{name:"cc_spriteTexture",defines:["USE_TEXTURE"]}],buffers:[],images:[]}},defines:[{name:"USE_LOCAL",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"USE_PIXEL_ALIGNMENT",type:"boolean"},{name:"CC_USE_EMBEDDED_ALPHA",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"IS_GRAY",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_texCoord",defines:[],format:21,location:1},{name:"a_color",defines:[],format:44,location:2}],blocks:[{name:"ALPHA_TEST_DATA",defines:["USE_ALPHA_TEST"],binding:0,stageFlags:16,members:[{name:"alphaThreshold",type:13,count:1}]}],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"standard",techniques:[{name:"opaque",passes:[{program:"standard|standard-vs|standard-fs",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},occlusion:{value:[1],type:13,handleInfo:["pbrParams",0,13]},roughness:{value:[.8],type:13,handleInfo:["pbrParams",1,13]},metallic:{value:[.6],type:13,handleInfo:["pbrParams",2,13]},SpecularIntensity:{value:[.5],type:13,handleInfo:["pbrParams",3,13]},emissive:{value:[0,0,0,1],linear:!0,type:16},emissiveScale:{value:[1,1,1],type:15,handleInfo:["emissiveScaleParam",0,15]},normalStrenth:{value:[1],type:13,handleInfo:["emissiveScaleParam",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},normalMap:{value:"normal",type:28},pbrMap:{value:"grey",type:28},metallicRoughnessMap:{value:"grey",type:28},occlusionMap:{value:"white",type:28},emissiveMap:{value:"grey",type:28},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},pbrParams:{type:16,value:[1,.8,.6,.5]},emissiveScaleParam:{type:16,value:[1,1,1,1]},albedoMap:{type:28,value:"grey"}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"standard|standard-vs|standard-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1}},{phase:"shadow-caster",propertyIndex:0,rasterizerState:{cullMode:1},program:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",properties:{tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],type:16,handleInfo:["albedo",0,16]},albedoScale:{value:[1,1,1],type:15,handleInfo:["albedoScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["albedoScaleAndCutoff",3,13]},mainTexture:{value:"grey",type:28,handleInfo:["albedoMap",0,28]},albedo:{type:16,value:[1,1,1,1]},albedoScaleAndCutoff:{type:16,value:[1,1,1,.5]},albedoMap:{type:28,value:"grey"}}}]}],shaders:[{name:"standard|standard-vs|standard-fs",hash:4038009253,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:222,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_NORMAL_MAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"USE_TWOSIDE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"NORMAL_UV",type:"string",options:["v_uv","v_uv1"]},{name:"PBR_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_PBR_MAP",type:"boolean"},{name:"USE_METALLIC_ROUGHNESS_MAP",type:"boolean"},{name:"USE_OCCLUSION_MAP",type:"boolean"},{name:"USE_EMISSIVE_MAP",type:"boolean"},{name:"EMISSIVE_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13},{name:"a_texCoord1",defines:[],format:21,location:14}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1},{name:"normalMap",type:28,count:1,defines:["USE_NORMAL_MAP"],stageFlags:16,binding:2},{name:"pbrMap",type:28,count:1,defines:["USE_PBR_MAP"],stageFlags:16,binding:3},{name:"metallicRoughnessMap",type:28,count:1,defines:["USE_METALLIC_ROUGHNESS_MAP"],stageFlags:16,binding:4},{name:"occlusionMap",type:28,count:1,defines:["USE_OCCLUSION_MAP"],stageFlags:16,binding:5},{name:"emissiveMap",type:28,count:1,defines:["USE_EMISSIVE_MAP"],stageFlags:16,binding:6}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:7},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:8},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:9}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"standard|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:210600745,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:183,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:65},globals:{blocks:[{name:"CCShadow",defines:[]},{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"HAS_SECOND_UV",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_ALBEDO_MAP",type:"boolean"},{name:"ALBEDO_UV",type:"string",options:["v_uv","v_uv1"]},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_texCoord1",defines:[],format:21,location:13}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:17,members:[{name:"tilingOffset",type:16,count:1},{name:"albedo",type:16,count:1},{name:"albedoScaleAndCutoff",type:16,count:1},{name:"pbrParams",type:16,count:1},{name:"emissive",type:16,count:1},{name:"emissiveScaleParam",type:16,count:1}]}],samplerTextures:[{name:"albedoMap",type:28,count:1,defines:["USE_ALBEDO_MAP"],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"terrain",techniques:[{name:"opaque",passes:[{program:"terrain|terrain-vs|terrain-fs",properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"forward-add",propertyIndex:0,embeddedMacros:{CC_FORWARD_ADD:!0},blendState:{targets:[{blend:!0,blendSrc:1,blendDst:1,blendSrcAlpha:0,blendDstAlpha:1}]},program:"terrain|terrain-vs|terrain-fs",depthStencilState:{depthFunc:2,depthTest:!0,depthWrite:!1},properties:{UVScale:{value:[1,1,1,1],type:16},lightMapUVParam:{value:[0,0,0,0],type:16},metallic:{value:[0,0,0,0],type:16},roughness:{value:[1,1,1,1],type:16},weightMap:{value:"black",type:28},detailMap0:{value:"grey",type:28},detailMap1:{value:"grey",type:28},detailMap2:{value:"grey",type:28},detailMap3:{value:"grey",type:28},normalMap0:{value:"normal",type:28},normalMap1:{value:"normal",type:28},normalMap2:{value:"normal",type:28},normalMap3:{value:"normal",type:28},lightMap:{value:"grey",type:28}}},{phase:"shadow-add",propertyIndex:0,rasterizerState:{cullMode:2},program:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag"}]}],shaders:[{name:"terrain|terrain-vs|terrain-fs",hash:3916952624,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:70,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:61},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]},{name:"CCForwardLight",defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[{name:"cc_lightingMap",defines:["USE_LIGHTMAP","!USE_BATCHING","!CC_FORWARD_ADD"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"USE_NORMALMAP",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"LAYERS",type:"number",range:[0,4]},{name:"USE_PBR",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[{name:"TexCoords",defines:[],binding:0,stageFlags:1,members:[{name:"UVScale",type:16,count:1},{name:"lightMapUVParam",type:16,count:1}]},{name:"PbrParams",defines:[],binding:1,stageFlags:16,members:[{name:"metallic",type:16,count:1},{name:"roughness",type:16,count:1}]}],samplerTextures:[{name:"weightMap",type:28,count:1,defines:[],stageFlags:16,binding:2},{name:"detailMap0",type:28,count:1,defines:[],stageFlags:16,binding:3},{name:"detailMap1",type:28,count:1,defines:[],stageFlags:16,binding:4},{name:"detailMap2",type:28,count:1,defines:[],stageFlags:16,binding:5},{name:"detailMap3",type:28,count:1,defines:[],stageFlags:16,binding:6},{name:"normalMap0",type:28,count:1,defines:[],stageFlags:16,binding:7},{name:"normalMap1",type:28,count:1,defines:[],stageFlags:16,binding:8},{name:"normalMap2",type:28,count:1,defines:[],stageFlags:16,binding:9},{name:"normalMap3",type:28,count:1,defines:[],stageFlags:16,binding:10},{name:"lightMap",type:28,count:1,defines:[],stageFlags:16,binding:11}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:12},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:13},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_FORWARD_ADD","CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:14}],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"terrain|shadow-caster-vs:vert|shadow-caster-fs:frag",hash:4270039829,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:68,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:0},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCLocal",defines:[]}],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"unlit",techniques:[{name:"opaque",passes:[{program:"unlit|unlit-vs:vert|unlit-fs:frag",properties:{mainTexture:{value:"grey",type:28},tilingOffset:{value:[1,1,0,0],type:16},mainColor:{value:[1,1,1,1],linear:!0,type:16},colorScale:{value:[1,1,1],type:15,handleInfo:["colorScaleAndCutoff",0,15]},alphaThreshold:{value:[.5],type:13,handleInfo:["colorScaleAndCutoff",3,13]},color:{linear:!0,type:16,handleInfo:["mainColor",0,16]},colorScaleAndCutoff:{type:16,value:[1,1,1,.5]}}}]}],shaders:[{name:"unlit|unlit-vs:vert|unlit-fs:frag",hash:3319190198,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:197,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:41},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]},{name:"CC_USE_ACCURATE_FOG",type:"boolean"},{name:"USE_VERTEX_COLOR",type:"boolean"},{name:"USE_TEXTURE",type:"boolean"},{name:"SAMPLE_FROM_RT",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_ALPHA_TEST",type:"boolean"},{name:"ALPHA_TEST_CHANNEL",type:"string",options:["a","r","g","b"]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12},{name:"a_color",defines:["USE_VERTEX_COLOR"],format:44,location:13}],blocks:[{name:"TexCoords",defines:["USE_TEXTURE"],binding:0,stageFlags:1,members:[{name:"tilingOffset",type:16,count:1}]},{name:"Constant",defines:[],binding:1,stageFlags:16,members:[{name:"mainColor",type:16,count:1},{name:"colorScaleAndCutoff",type:16,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:["USE_TEXTURE"],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"bloom",techniques:[{passes:[{phase:"bloom-prefilter",program:"bloom|bloom-vs|prefilter-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-downsample",program:"bloom|bloom-vs|downsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-upsample",program:"bloom|bloom-vs|upsample-fs",depthStencilState:{depthTest:!1,depthWrite:!1}},{phase:"bloom-combine",program:"bloom|bloom-vs|combine-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"bloom|bloom-vs|prefilter-fs",hash:2185821616,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|downsample-fs",hash:1780231359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|upsample-fs",hash:3580425335,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:1}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]},{name:"bloom|bloom-vs|combine-fs",hash:3457196798,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:40},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[{name:"BloomUBO",defines:[],binding:0,stageFlags:16,members:[{name:"texSize",type:16,count:1}]}],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:1},{name:"bloomTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"deferred-lighting",techniques:[{passes:[{phase:"deferred-lighting",program:"deferred-lighting|lighting-vs|lighting-fs",depthStencilState:{depthFunc:4,depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"deferred-lighting|lighting-vs|lighting-fs",hash:3788484086,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[{name:"cc_shadowMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_spotLightingMap",defines:["CC_RECEIVE_SHADOW"]},{name:"cc_environment",defines:["CC_USE_IBL"]},{name:"cc_diffuseMap",defines:["CC_USE_IBL","CC_USE_DIFFUSEMAP"]}],buffers:[],images:[]},locals:{blocks:[{name:"CCForwardLight",defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"]}],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_RECEIVE_SHADOW",type:"boolean"},{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_DIFFUSEMAP",type:"number",range:[0,2]},{name:"USE_REFLECTION_DENOISE",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"CC_FORWARD_ADD",type:"boolean"},{name:"CC_PIPELINE_TYPE",type:"number",range:[0,1]},{name:"CC_FORCE_FORWARD_SHADING",type:"boolean"},{name:"CC_USE_HDR",type:"boolean"},{name:"CC_USE_FOG",type:"number",range:[0,4]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[{name:"depth_stencil",type:28,count:1,defines:[],stageFlags:16,binding:3}],buffers:[{name:"b_ccLightsBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:4},{name:"b_clusterLightIndicesBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:5},{name:"b_clusterLightGridBuffer",memoryAccess:1,defines:["CC_ENABLE_CLUSTERED_LIGHT_CULLING"],stageFlags:16,binding:6}],images:[],textures:[],samplers:[],subpassInputs:[{name:"gbuffer_albedoMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:0},{name:"gbuffer_normalMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:1},{name:"gbuffer_emissiveMap",count:1,defines:["CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT"],stageFlags:16,binding:2}]}]},{name:"planar-shadow",techniques:[{passes:[{phase:"planarShadow",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},program:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",depthStencilState:{depthTest:!0,depthWrite:!1,stencilTestFront:!0,stencilFuncFront:5,stencilPassOpFront:2,stencilRefBack:128,stencilRefFront:128,stencilReadMaskBack:128,stencilReadMaskFront:128,stencilWriteMaskBack:128,stencilWriteMaskFront:128}}]}],shaders:[{name:"planar-shadow|planar-shadow-vs:vert|planar-shadow-fs:frag",hash:730673320,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:216,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:59},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]},{name:"CCShadow",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]},{name:"CCLocalBatched",defines:["!USE_INSTANCING","USE_BATCHING"]},{name:"CCLocal",defines:["!USE_INSTANCING","!USE_BATCHING"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"USE_BATCHING",type:"boolean"},{name:"USE_LIGHTMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7},{name:"a_matWorld0",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:8},{name:"a_matWorld1",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:9},{name:"a_matWorld2",defines:["USE_INSTANCING"],format:44,isInstanced:!0,location:10},{name:"a_lightingMapUVParam",defines:["USE_INSTANCING","USE_LIGHTMAP"],format:44,isInstanced:!0,location:11},{name:"a_dyn_batch_id",defines:["!USE_INSTANCING","USE_BATCHING"],format:11,location:12}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"post-process",techniques:[{passes:[{phase:"post-process",blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendSrcAlpha:2,blendDstAlpha:4}]},program:"post-process|post-process-vs|post-process-fs",depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"post-process|post-process-vs|post-process-fs",hash:3237848814,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:147,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[{name:"CCMorph",defines:["CC_USE_MORPH"]},{name:"CCSkinningTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinningAnimation",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]},{name:"CCSkinning",defines:["CC_USE_SKINNING","!CC_USE_BAKED_ANIMATION"]}],samplerTextures:[{name:"cc_PositionDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_POSITION"]},{name:"cc_NormalDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_NORMAL"]},{name:"cc_TangentDisplacements",defines:["CC_USE_MORPH","CC_MORPH_TARGET_HAS_TANGENT"]},{name:"cc_jointTexture",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION"]}],buffers:[],images:[]}},defines:[{name:"CC_USE_MORPH",type:"boolean"},{name:"CC_MORPH_TARGET_COUNT",type:"number",range:[2,8]},{name:"CC_MORPH_PRECOMPUTED",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_POSITION",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_NORMAL",type:"boolean"},{name:"CC_MORPH_TARGET_HAS_TANGENT",type:"boolean"},{name:"CC_USE_SKINNING",type:"boolean"},{name:"CC_USE_BAKED_ANIMATION",type:"boolean"},{name:"USE_INSTANCING",type:"boolean"},{name:"ANTIALIAS_TYPE",type:"number",range:[0,3]}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3},{name:"a_vertexId",defines:["CC_USE_MORPH"],format:11,location:6},{name:"a_joints",defines:["CC_USE_SKINNING"],location:4},{name:"a_weights",defines:["CC_USE_SKINNING"],format:44,location:5},{name:"a_jointAnimInfo",defines:["CC_USE_SKINNING","CC_USE_BAKED_ANIMATION","USE_INSTANCING"],format:44,isInstanced:!0,location:7}],blocks:[],samplerTextures:[{name:"outputResultMap",type:28,count:1,defines:[],stageFlags:16,binding:0}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"skybox",techniques:[{passes:[{rasterizerState:{cullMode:0},program:"skybox|sky-vs:vert|sky-fs:frag",priority:245,depthStencilState:{depthTest:!0,depthWrite:!1}}]}],shaders:[{name:"skybox|sky-vs:vert|sky-fs:frag",hash:4277052359,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:39,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[{name:"cc_environment",defines:[]}],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[{name:"CC_USE_IBL",type:"number",range:[0,2]},{name:"CC_USE_HDR",type:"boolean"},{name:"USE_RGBE_CUBEMAP",type:"boolean"}],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_normal",defines:[],format:32,location:1},{name:"a_texCoord",defines:[],format:21,location:2},{name:"a_tangent",defines:[],format:44,location:3}],blocks:[],samplerTextures:[],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"profiler",techniques:[{passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"profiler|profiler-vs:vert|profiler-fs:frag",priority:255,depthStencilState:{depthTest:!1,depthWrite:!1}}]}],shaders:[{name:"profiler|profiler-vs:vert|profiler-fs:frag",hash:179162168,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:60,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:39},globals:{blocks:[{name:"CCGlobal",defines:[]},{name:"CCCamera",defines:[]}],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:32,location:0},{name:"a_color",defines:[],format:44,location:1}],blocks:[{name:"Constants",defines:[],binding:0,stageFlags:1,members:[{name:"offset",type:16,count:1}]},{name:"PerFrameInfo",defines:[],binding:1,stageFlags:1,members:[{name:"digits",type:16,count:20}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]},{name:"splash-screen",techniques:[{name:"default",passes:[{blendState:{targets:[{blend:!0,blendSrc:2,blendDst:4,blendDstAlpha:4}]},rasterizerState:{cullMode:0},program:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",depthStencilState:{depthTest:!1,depthWrite:!1},properties:{mainTexture:{value:"grey",type:28},resolution:{value:[640,960],type:14,handleInfo:["u_buffer0",0,14]},percent:{value:[.5],type:13,handleInfo:["u_percent",0,13]},scale:{value:[200,500],type:14,handleInfo:["u_buffer1",0,14]},translate:{value:[320,480],type:14,handleInfo:["u_buffer1",2,14]},u_buffer0:{type:16,value:[640,960,0,0]},u_percent:{type:13,value:[.5]},u_buffer1:{type:16,value:[200,500,320,480]}}}]}],shaders:[{name:"splash-screen|splash-screen-vs:vert|splash-screen-fs:frag",hash:3189094080,builtins:{statistics:{CC_EFFECT_USED_VERTEX_UNIFORM_VECTORS:6,CC_EFFECT_USED_FRAGMENT_UNIFORM_VECTORS:1},globals:{blocks:[],samplerTextures:[],buffers:[],images:[]},locals:{blocks:[],samplerTextures:[],buffers:[],images:[]}},defines:[],attributes:[{name:"a_position",defines:[],format:21,location:0},{name:"a_texCoord",defines:[],format:21,location:1}],blocks:[{name:"Constant",defines:[],binding:0,stageFlags:1,members:[{name:"u_buffer0",type:16,count:1},{name:"u_buffer1",type:16,count:1},{name:"u_projection",type:25,count:1}]},{name:"Factor",defines:[],binding:1,stageFlags:16,members:[{name:"u_percent",type:13,count:1}]}],samplerTextures:[{name:"mainTexture",type:28,count:1,defines:[],stageFlags:16,binding:2}],buffers:[],images:[],textures:[],samplers:[],subpassInputs:[]}]}]),Ov={glsl1:[[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nuniform vec4 cc_size_rotation;\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp mat4 cc_matWorld;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec4 v_color;\nattribute float a_dist;\nvarying float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\nprecision highp float;\nvarying vec4 v_color;\nvarying float v_dist;\nvec4 frag () {\nvec4 o = v_color;\n#ifdef GL_OES_standard_derivatives\nfloat aa = fwidth(v_dist);\n#else\nfloat aa = 0.05;\n#endif\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_worldBoundCenter;\nuniform highp vec4 cc_worldBoundHalfExtents;\nattribute vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nuniform vec4 u_sampleInfo;\nuniform vec4 u_worldRot;\nuniform vec4 u_timeDelta;\nattribute vec4 a_position_starttime;\nattribute vec4 a_size_uv;\nattribute vec4 a_rotation_uv;\nattribute vec4 a_color;\nattribute vec4 a_dir_life;\nattribute float a_rndSeed;\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture2D(tex, coord);\nvec4 b = texture2D(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nuniform int u_color_mode;\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nuniform int u_rotation_mode;\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nuniform int u_size_mode;\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nuniform int u_force_mode;\nuniform int u_force_space;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nuniform int u_velocity_mode;\nuniform int u_velocity_space;\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nuniform vec4 u_anim_info;\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture2D(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture2D(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture2D(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nuniform vec4 mainTiling_Offset;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nattribute vec3 a_position;\nattribute vec4 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\n#if CC_DRAW_WIRE_FRAME\nvarying vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nuniform vec4 mainTiling_Offset;\nuniform vec4 frameTile_velLenScale;\nuniform vec4 scale;\nuniform vec4 nodeRotation;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewInv;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform highp mat4 cc_matWorld;\nvarying mediump vec2 uv;\nvarying mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nattribute vec3 a_position;\nattribute vec3 a_texCoord;\nattribute vec3 a_texCoord1;\nattribute vec3 a_texCoord2;\nattribute vec4 a_color;\n#if CC_RENDER_MODE == 1\nattribute vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nattribute vec3 a_texCoord3;\nattribute vec3 a_normal;\nattribute vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 uv;\nvarying vec4 color;\nuniform sampler2D mainTexture;\nuniform vec4 tintColor;\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture2D(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nvoid main() { gl_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matViewProj;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 v_light;\nvarying vec2 uv0;\n#if TWO_COLORED\nattribute vec4 a_color2;\nvarying vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 v_light;\n#if TWO_COLORED\nvarying vec4 v_dark;\n#endif\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture2D(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture2D(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\n#if USE_LOCAL\nuniform highp mat4 cc_matWorld;\n#endif\n#if SAMPLE_FROM_RT\n#endif\nattribute vec3 a_position;\nattribute vec2 a_texCoord;\nattribute vec4 a_color;\nvarying vec4 color;\nvarying vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture2D(tex, uv).rgb, texture2D(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture2D(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nuniform float alphaThreshold;\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nvarying vec4 color;\n#if USE_TEXTURE\nvarying vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\nuniform highp vec4 cc_lightingMapUVParam;\n#endif\nuniform vec4 tilingOffset;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nattribute vec4 a_color;\nvarying vec4 v_color;\n#endif\nvarying vec3 v_position;\nvarying vec3 v_normal;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nuniform vec4 pbrParams;\nuniform vec4 emissive;\nuniform vec4 emissiveScaleParam;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying vec3 v_position;\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec3 v_normal;\n#if USE_VERTEX_COLOR\nvarying vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nvarying vec3 v_tangent;\nvarying vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture2D(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture2D(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture2D(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture2D(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture2D(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture2D(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matWorldIT;\n#endif\nuniform vec4 tilingOffset;\nuniform highp mat4 cc_matLightViewProj;\n#if HAS_SECOND_UV || USE_LIGHTMAP\nattribute vec2 a_texCoord1;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nuniform vec4 albedo;\nuniform vec4 albedoScaleAndCutoff;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nuniform highp mat4 cc_matLightView;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nvarying vec2 v_uv;\nvarying vec2 v_uv1;\nvarying vec4 v_worldPos;\nvarying float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture2D(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matViewProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform highp mat4 cc_matWorld;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nvarying highp vec4 v_shadowPos;\nuniform highp mat4 cc_matLightViewProj;\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 luv;\nvarying mediump vec3 diffuse;\nuniform vec4 UVScale;\nuniform vec4 lightMapUVParam;\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\n#ifdef GL_EXT_draw_buffers\n#extension GL_EXT_draw_buffers: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvarying highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvarying vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nvarying highp vec3 v_position;\nvarying mediump vec3 v_normal;\n#if USE_NORMALMAP\nvarying mediump vec3 v_tangent;\nvarying mediump vec3 v_binormal;\n#endif\nvarying mediump vec2 uvw;\nvarying mediump vec2 uv0;\nvarying mediump vec2 uv1;\nvarying mediump vec2 uv2;\nvarying mediump vec2 uv3;\nvarying mediump vec3 diffuse;\nvarying mediump vec3 luv;\nuniform vec4 metallic;\nuniform vec4 roughness;\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture2D(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture2D(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture2D(detailMap0, uv0) * w.r;\nbaseColor += texture2D(detailMap1, uv1) * w.g;\nbaseColor += texture2D(detailMap2, uv2) * w.b;\nbaseColor += texture2D(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture2D(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture2D(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture2D(normalMap0, uv0) * w.r;\nbaseNormal += texture2D(normalMap1, uv1) * w.g;\nbaseNormal += texture2D(normalMap2, uv2) * w.b;\nbaseNormal += texture2D(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture2D(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture2D(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\ngl_FragData[0] = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nvoid main () {\nStandardSurface s; surf(s);\ngl_FragData[0] = s.albedo;\ngl_FragData[1] = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\ngl_FragData[2] = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nuniform highp mat4 cc_matWorld;\nuniform highp mat4 cc_matLightViewProj;\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nvarying vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nvarying vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nattribute lowp vec4 a_color;\nvarying lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform vec4 tilingOffset;\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nvarying float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nuniform vec4 mainColor;\nuniform vec4 colorScaleAndCutoff;\n#if USE_VERTEX_COLOR\nvarying lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture2D(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture2D(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\ngl_FragColor = vec4(color, 1.0);\n} else {\ngl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D bloomTexture;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture2D(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture2D(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\ngl_FragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nvarying vec2 v_uv;\nuniform mediump vec4 texSize;\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nvoid main() {\nvec4 hdrColor = texture2D(outputResultMap, v_uv);\nvec3 bloomColor = texture2D(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\ngl_FragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\n#ifdef GL_OES_standard_derivatives\n#extension GL_OES_standard_derivatives: enable\n#endif\n#ifdef GL_EXT_shader_texture_lod\n#extension GL_EXT_shader_texture_lod: enable\n#endif\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matViewProjInv;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\nuniform mediump vec4 cc_mainLitColor;\nuniform mediump vec4 cc_ambientSky;\nuniform mediump vec4 cc_ambientGround;\nuniform mediump vec4 cc_fogColor;\nuniform mediump vec4 cc_fogBase;\nuniform mediump vec4 cc_fogAdd;\nuniform mediump vec4 cc_nearFar;\nuniform mediump vec4 cc_viewPort;\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nuniform highp mat4 cc_matLightView;\nuniform highp mat4 cc_matLightViewProj;\nuniform highp vec4 cc_shadowInvProjDepthInfo;\nuniform highp vec4 cc_shadowProjDepthInfo;\nuniform highp vec4 cc_shadowProjInfo;\nuniform mediump vec4 cc_shadowNFLSInfo;\nuniform mediump vec4 cc_shadowWHPBInfo;\nuniform mediump vec4 cc_shadowLPNNInfo;\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture2D(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture2D(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture2D(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture2D(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn texture2DLodEXT(tex, coord, lod);\n#else\nreturn texture2D(tex, coord, lod);\n#endif\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\n#ifdef GL_EXT_shader_texture_lod\nreturn textureCubeLodEXT(tex, coord, lod);\n#else\nreturn textureCube(tex, coord, lod);\n#endif\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = textureCube(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = textureCube(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nuniform highp vec4 cc_lightPos[LIGHTS_PER_PASS];\nuniform vec4 cc_lightColor[LIGHTS_PER_PASS];\nuniform vec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nuniform vec4 cc_lightDir[LIGHTS_PER_PASS];\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nreadonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nreadonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nreadonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nvarying vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gl_LastFragData[0];\nvec4 normalMap = gl_LastFragData[1];\nvec4 emissiveMap = gl_LastFragDat[2];\n#else\nvec4 albedoMap = texture2D(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture2D(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture2D(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture2D(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngl_FragData[2] = color;\n#else\ngl_FragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nuniform highp vec4 cc_cameraPos;\nuniform mediump vec4 cc_mainLitDir;\n#if USE_INSTANCING\nattribute vec4 a_matWorld0;\nattribute vec4 a_matWorld1;\nattribute vec4 a_matWorld2;\n#if USE_LIGHTMAP\nattribute vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nattribute float a_dyn_batch_id;\nuniform highp mat4 cc_matWorlds[10];\n#else\nuniform highp mat4 cc_matWorld;\n#endif\nuniform mediump vec4 cc_planarNDInfo;\nvarying float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform lowp vec4 cc_shadowColor;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\n#if CC_USE_MORPH\nattribute float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nuniform vec4 cc_displacementWeights[15];\nuniform vec4 cc_displacementTextureInfo;\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 uv = getPixelCoordFromLocation(location, cc_displacementTextureInfo.xy);\nreturn texture2D(tex, uv);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture2D(tex, x)),\ndecode32(texture2D(tex, y)),\ndecode32(texture2D(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nattribute vec4 a_joints;\nattribute vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nattribute highp vec4 a_jointAnimInfo;\n#endif\nuniform highp vec4 cc_jointTextureInfo;\nuniform highp vec4 cc_jointAnimInfo;\nuniform highp sampler2D cc_jointTexture;\n#else\nuniform highp vec4 cc_joints[90];\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture2D(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture2D(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nuniform highp vec4 cc_cameraPos;\nvarying vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nuniform mediump vec4 cc_screenSize;\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture2D(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture2D(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture2D(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture2D(tex, v_rgbSE).xyz;\nvec4 texColor = texture2D(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture2D(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture2D(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture2D(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nvarying vec2 v_uv;\nuniform sampler2D outputResultMap;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\ngl_FragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\ngl_FragColor = texture2D(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nuniform highp mat4 cc_matView;\nuniform highp mat4 cc_matProj;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nattribute vec3 a_position;\nattribute vec3 a_normal;\nattribute vec2 a_texCoord;\nattribute vec4 a_tangent;\nvarying mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nuniform mediump vec4 cc_ambientSky;\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nvarying mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(textureCube(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(textureCube(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nuniform highp mat4 cc_matProj;\nattribute vec3 a_position;\nattribute vec4 a_color;\nvarying vec2 v_uv;\nuniform vec4 offset;\nuniform vec4 digits[20];\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nvarying vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture2D(mainTexture, v_uv));\n}\nvoid main() { gl_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nattribute vec2 a_position;\nattribute vec2 a_texCoord;\nvarying vec2 v_uv;\nuniform vec4 u_buffer0;\nuniform vec4 u_buffer1;\nuniform mat4 u_projection;\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvarying vec2 v_uv;\nuniform float u_percent;\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture2D(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nvoid main() { gl_FragColor = frag(); }"}]],glsl3:[[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n, mat4 viewInv\n) {\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n}\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nlayout(std140) uniform builtin {\nvec4 cc_size_rotation;\n};\nvec4 vs_main() {\nvec4 pos = vec4(a_position, 1);\npos = cc_matWorld * pos;\nvec2 vertOffset = a_texCoord.xy - 0.5;\ncomputeVertPos(pos, vertOffset, quaternionFromEuler(vec3(0., 0., cc_size_rotation.z)), vec3(cc_size_rotation.xy, 0.), cc_matViewInv);\npos = cc_matViewProj * pos;\nuv = a_texCoord.xy;\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nin vec3 a_position;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 frag () {\nvec4 o = vec4(1.0);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec4 v_color;\nin float a_dist;\nout float v_dist;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\npos = cc_matViewProj * cc_matWorld * pos;\nv_color = a_color;\nv_dist = a_dist;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nin vec4 v_color;\nin float v_dist;\nvec4 frag () {\nvec4 o = v_color;\nfloat aa = fwidth(v_dist);\nfloat alpha = 1. - smoothstep(-aa, 0., abs(v_dist) - 1.0);\no.rgb *= o.a;\no *= alpha;\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCWorldBound {\nhighp vec4 cc_worldBoundCenter;\nhighp vec4 cc_worldBoundHalfExtents;\n};\nin vec3 a_position;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition *= cc_worldBoundHalfExtents;\nposition += cc_worldBoundCenter;\nposition = cc_matViewProj * position;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nvec4 frag () {\nreturn vec4(1, 0, 0, 1);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nvec4 eulerToQuat(vec3 euler) {\nvec3 er = euler * 0.5;\nfloat x = er.x, y = er.y, z = er.z;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat;\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nlayout(std140) uniform SampleConstants {\nvec4 u_sampleInfo;\n};\nlayout(std140) uniform TickConstants {\nvec4 u_worldRot;\nvec4 u_timeDelta;\n};\nin vec4 a_position_starttime;\nin vec4 a_size_uv;\nin vec4 a_rotation_uv;\nin vec4 a_color;\nin vec4 a_dir_life;\nin float a_rndSeed;\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord;\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec3 unpackCurveData (sampler2D tex, vec2 coord) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nreturn mix(a.xyz, b.xyz, c);\n}\nvec3 unpackCurveData (sampler2D tex, vec2 coord, out float w) {\nvec4 a = texture(tex, coord);\nvec4 b = texture(tex, coord + u_sampleInfo.y);\nfloat c = fract(coord.x * u_sampleInfo.x);\nw = mix(a.w, b.w, c);\nreturn mix(a.xyz, b.xyz, c);\n}\nfloat pseudoRandom(float x) {\n#if USE_VK_SHADER\nfloat o = x;\nx = mod(x - 1.0, 2.0) - 1.0;\nfloat freqVar = 10.16640753482;\nfloat y = sin(freqVar * floor(o * 0.5 - 0.5));\nfloat v = max(0.0, 1.0-abs(x));\nv *= 0.7071067812;\nv = y < 0.0 ? -v : v;\nreturn v;\n#else\nfloat seed = mod(x, 233280.);\nfloat q = (seed * 9301. + 49297.) / 233280.;\nreturn fract(q);\n#endif\n}\n#if COLOR_OVER_TIME_MODULE_ENABLE\nuniform sampler2D color_over_time_tex0;\nlayout(std140) uniform ColorConstant {\nint u_color_mode;\n};\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nuniform sampler2D rotation_over_time_tex0;\nlayout(std140) uniform RotationConstant {\nint u_rotation_mode;\n};\n#endif\n#if SIZE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D size_over_time_tex0;\nlayout(std140) uniform SizeConstant {\nint u_size_mode;\n};\n#endif\n#if FORCE_OVER_TIME_MODULE_ENABLE\nuniform sampler2D force_over_time_tex0;\nlayout(std140) uniform ForceConstant {\nint u_force_mode;\nint u_force_space;\n};\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nuniform sampler2D velocity_over_time_tex0;\nlayout(std140) uniform VelocityConstant {\nint u_velocity_mode;\nint u_velocity_space;\n};\n#endif\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nuniform sampler2D texture_animation_tex0;\nlayout(std140) uniform AnimationConstant {\nvec4 u_anim_info;\n};\n#endif\nfloat repeat (float t, float length) {\nreturn t - floor(t / length) * length;\n}\nvec4 rotateQuat (vec4 p, vec4 q) {\nvec3 iv = cross(q.xyz, p.xyz) + q.w * p.xyz;\nvec3 res = p.xyz + 2.0 * cross(q.xyz, iv);\nreturn vec4(res.xyz, p.w);\n}\nvec4 gpvs_main () {\nfloat activeTime = u_timeDelta.x - a_position_starttime.w;\nfloat normalizedTime = clamp(activeTime / a_dir_life.w, 0.0, 1.0);\nvec2 timeCoord0 = vec2(normalizedTime, 0.);\nvec2 timeCoord1 = vec2(normalizedTime, 1.);\n#if CC_RENDER_MODE == 4\nvec2 vertIdx = vec2(a_texCoord.x, a_texCoord.y);\n#else\nvec2 vertIdx = vec2(a_size_uv.w, a_rotation_uv.w);\n#endif\nvec4 velocity = vec4(a_dir_life.xyz, 0.);\nvec4 pos = vec4(a_position_starttime.xyz, 1.);\nvec3 size = a_size_uv.xyz;\n#if SIZE_OVER_TIME_MODULE_ENABLE\nif (u_size_mode == 1) {\nsize *= unpackCurveData(size_over_time_tex0, timeCoord0);\n} else {\nvec3 size_0 = unpackCurveData(size_over_time_tex0, timeCoord0);\nvec3 size_1 = unpackCurveData(size_over_time_tex0, timeCoord1);\nfloat factor_s = pseudoRandom(a_rndSeed + 39825.);\nsize *= mix(size_0, size_1, factor_s);\n}\n#endif\nvec3 compScale = scale.xyz * size;\n#if FORCE_OVER_TIME_MODULE_ENABLE\nvec3 forceAnim = vec3(0.);\nif (u_force_mode == 1) {\nforceAnim = unpackCurveData(force_over_time_tex0, timeCoord0);\n} else {\nvec3 force_0 = unpackCurveData(force_over_time_tex0, timeCoord0);\nvec3 force_1 = unpackCurveData(force_over_time_tex0, timeCoord1);\nfloat factor_f =  pseudoRandom(a_rndSeed + 212165.);\nforceAnim = mix(force_0, force_1, factor_f);\n}\nvec4 forceTrack = vec4(forceAnim, 0.);\nif (u_force_space == 0) {\nforceTrack = rotateQuat(forceTrack, u_worldRot);\n}\nvelocity.xyz += forceTrack.xyz;\n#endif\n#if VELOCITY_OVER_TIME_MODULE_ENABLE\nfloat speedModifier0 = 1.;\nfloat speedModifier1 = 1.;\nvec3 velocityAnim = vec3(0.);\nif (u_velocity_mode == 1) {\nvelocityAnim = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\n} else {\nvec3 vectory_0 = unpackCurveData(velocity_over_time_tex0, timeCoord0, speedModifier0);\nvec3 vectory_1 = unpackCurveData(velocity_over_time_tex0, timeCoord1, speedModifier1);\nfloat factor_v = pseudoRandom(a_rndSeed + 197866.);\nvelocityAnim = mix(vectory_0, vectory_1, factor_v);\nspeedModifier0 = mix(speedModifier0, speedModifier1, factor_v);\n}\nvec4 velocityTrack = vec4(velocityAnim, 0.);\nif (u_velocity_space == 0) {\nvelocityTrack = rotateQuat(velocityTrack, u_worldRot);\n}\nvelocity.xyz += velocityTrack.xyz;\nvelocity.xyz *= speedModifier0;\n#endif\npos.xyz += velocity.xyz * normalizedTime * a_dir_life.w;\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = rotateQuat(velocity, u_worldRot);\n#endif\n#endif\nvec3 startRotation = a_rotation_uv.xyz;\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = startRotation.xyz;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., startRotation.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(startRotation);\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nif (u_rotation_mode == 1) {\nvec3 euler = unpackCurveData(rotation_over_time_tex0, timeCoord0) * normalizedTime * a_dir_life.w;\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n} else {\nvec3 rotation_0 = unpackCurveData(rotation_over_time_tex0, timeCoord0);\nvec3 rotation_1 = unpackCurveData(rotation_over_time_tex0, timeCoord1);\nfloat factor_r = pseudoRandom(a_rndSeed + 125292.);\nvec3 euler = mix(rotation_0, rotation_1, factor_r) * normalizedTime * a_dir_life.w;\n#if CC_RENDER_MODE == 3 || CC_RENDER_MODE == 2\neuler = vec3(0.0, 0.0, euler.z);\n#endif\nvec4 quat = eulerToQuat(euler);\nmat3 mLocal = quatToMat3(quat);\nmat3 mStart = quatToMat3(rot);\nrot = mat3ToQuat(mStart * mLocal);\n}\n#endif\n#if COLOR_OVER_TIME_MODULE_ENABLE\nif (u_color_mode == 1) {\ncolor = a_color * texture(color_over_time_tex0, timeCoord0);\n} else {\nvec4 color_0 = texture(color_over_time_tex0, timeCoord0);\nvec4 color_1 = texture(color_over_time_tex0, timeCoord1);\nfloat factor_c = pseudoRandom(a_rndSeed + 91041.);\ncolor = a_color * mix(color_0, color_1, factor_c);\n}\n#else\ncolor = a_color;\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((vertIdx - 0.5));\n#if CC_RENDER_MODE == 1\nrot = vec4(0.0, 0.0, 0.0, 1.0);\n#endif\ncomputeVertPos(pos, cornerOffset, rot, compScale\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, cc_matViewInv\n#endif\n#if CC_RENDER_MODE == 1\n, cc_cameraPos.xyz\n, velocity\n, frameTile_velLenScale.z\n, frameTile_velLenScale.w\n, a_size_uv.w\n#endif\n);\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor *= a_color1;\n#endif\npos = cc_matViewProj * pos;\nfloat frameIndex = 0.;\n#if TEXTURE_ANIMATION_MODULE_ENABLE\nfloat startFrame = 0.;\nvec3 frameInfo = vec3(0.);\nif (int(u_anim_info.x) == 1) {\nframeInfo = unpackCurveData(texture_animation_tex0, timeCoord0);\n} else {\nvec3 frameInfo0 = unpackCurveData(texture_animation_tex0, timeCoord0);\nvec3 frameInfo1 = unpackCurveData(texture_animation_tex0, timeCoord1);\nfloat factor_t = pseudoRandom(a_rndSeed + 90794.);\nframeInfo = mix(frameInfo0, frameInfo1, factor_t);\n}\nstartFrame = frameInfo.x / u_anim_info.y;\nframeIndex = repeat(u_anim_info.z * (frameInfo.y + startFrame), 1.);\n#endif\nuv = computeUV(frameIndex, vertIdx, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\nreturn pos;\n}\nvoid main() { gl_Position = gpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nin vec3 a_position;\nin vec4 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_DRAW_WIRE_FRAME\nout vec3 vBarycentric;\n#endif\nvec4 vs_main() {\nhighp vec4 pos = vec4(a_position, 1);\nvec4 velocity = vec4(a_texCoord1.xyz, 0);\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\nvelocity = cc_matWorld * velocity;\n#endif\nfloat vertOffset = (a_texCoord.x - 0.5) * a_texCoord.y;\nvec3 camUp = normalize(cross(pos.xyz - cc_cameraPos.xyz, velocity.xyz));\npos.xyz += camUp * vertOffset;\npos = cc_matViewProj * pos;\nuv = a_texCoord.zw * mainTiling_Offset.xy + mainTiling_Offset.zw;;\ncolor = a_color;\n#if CC_DRAW_WIRE_FRAME\nvBarycentric = a_texCoord2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\n#if CC_DRAW_WIRE_FRAME\nin vec3 vBarycentric;\n#endif\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\n#if CC_DRAW_WIRE_FRAME\nif (any(lessThan(vBarycentric, vec3(0.02)))) {\ncol = vec4(0., 1., 1., 1.);\n}\n#endif\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nvec4 quaternionFromAxis (vec3 xAxis,vec3 yAxis,vec3 zAxis){\nmat3 m = mat3(xAxis,yAxis,zAxis);\nfloat trace = m[0][0] + m[1][1] + m[2][2];\nvec4 quat;\nif (trace > 0.) {\nfloat s = 0.5 / sqrt(trace + 1.0);\nquat.w = 0.25 / s;\nquat.x = (m[2][1] - m[1][2]) * s;\nquat.y = (m[0][2] - m[2][0]) * s;\nquat.z = (m[1][0] - m[0][1]) * s;\n} else if ((m[0][0] > m[1][1]) && (m[0][0] > m[2][2])) {\nfloat s = 2.0 * sqrt(1.0 + m[0][0] - m[1][1] - m[2][2]);\nquat.w = (m[2][1] - m[1][2]) / s;\nquat.x = 0.25 * s;\nquat.y = (m[0][1] + m[1][0]) / s;\nquat.z = (m[0][2] + m[2][0]) / s;\n} else if (m[1][1] > m[2][2]) {\nfloat s = 2.0 * sqrt(1.0 + m[1][1] - m[0][0] - m[2][2]);\nquat.w = (m[0][2] - m[2][0]) / s;\nquat.x = (m[0][1] + m[1][0]) / s;\nquat.y = 0.25 * s;\nquat.z = (m[1][2] + m[2][1]) / s;\n} else {\nfloat s = 2.0 * sqrt(1.0 + m[2][2] - m[0][0] - m[1][1]);\nquat.w = (m[1][0] - m[0][1]) / s;\nquat.x = (m[0][2] + m[2][0]) / s;\nquat.y = (m[1][2] + m[2][1]) / s;\nquat.z = 0.25 * s;\n}\nfloat len = quat.x * quat.x + quat.y * quat.y + quat.z * quat.z + quat.w * quat.w;\nif (len > 0.) {\nlen = 1. / sqrt(len);\nquat.x = quat.x * len;\nquat.y = quat.y * len;\nquat.z = quat.z * len;\nquat.w = quat.w * len;\n}\nreturn quat;\n}\nvec4 quaternionFromEuler (vec3 angle){\nfloat x = angle.x / 2.;\nfloat y = angle.y / 2.;\nfloat z = angle.z / 2.;\nfloat sx = sin(x);\nfloat cx = cos(x);\nfloat sy = sin(y);\nfloat cy = cos(y);\nfloat sz = sin(z);\nfloat cz = cos(z);\nvec4 quat = vec4(0);\nquat.x = sx * cy * cz + cx * sy * sz;\nquat.y = cx * sy * cz + sx * cy * sz;\nquat.z = cx * cy * sz - sx * sy * cz;\nquat.w = cx * cy * cz - sx * sy * sz;\nreturn quat;\n}\nmat4 matrixFromRT (vec4 q, vec3 p){\nfloat x2 = q.x + q.x;\nfloat y2 = q.y + q.y;\nfloat z2 = q.z + q.z;\nfloat xx = q.x * x2;\nfloat xy = q.x * y2;\nfloat xz = q.x * z2;\nfloat yy = q.y * y2;\nfloat yz = q.y * z2;\nfloat zz = q.z * z2;\nfloat wx = q.w * x2;\nfloat wy = q.w * y2;\nfloat wz = q.w * z2;\nreturn mat4(\n1. - (yy + zz), xy + wz, xz - wy, 0,\nxy - wz, 1. - (xx + zz), yz + wx, 0,\nxz + wy, yz - wx, 1. - (xx + yy), 0,\np.x, p.y, p.z, 1\n);\n}\nmat4 matFromRTS (vec4 q, vec3 t, vec3 s){\nfloat x = q.x, y = q.y, z = q.z, w = q.w;\nfloat x2 = x + x;\nfloat y2 = y + y;\nfloat z2 = z + z;\nfloat xx = x * x2;\nfloat xy = x * y2;\nfloat xz = x * z2;\nfloat yy = y * y2;\nfloat yz = y * z2;\nfloat zz = z * z2;\nfloat wx = w * x2;\nfloat wy = w * y2;\nfloat wz = w * z2;\nfloat sx = s.x;\nfloat sy = s.y;\nfloat sz = s.z;\nreturn mat4((1. - (yy + zz)) * sx, (xy + wz) * sx, (xz - wy) * sx, 0,\n(xy - wz) * sy, (1. - (xx + zz)) * sy, (yz + wx) * sy, 0,\n(xz + wy) * sz, (yz - wx) * sz, (1. - (xx + yy)) * sz, 0,\nt.x, t.y, t.z, 1);\n}\nvec4 quatMultiply (vec4 a, vec4 b){\nvec4 quat;\nquat.x = a.x * b.w + a.w * b.x + a.y * b.z - a.z * b.y;\nquat.y = a.y * b.w + a.w * b.y + a.z * b.x - a.x * b.z;\nquat.z = a.z * b.w + a.w * b.z + a.x * b.y - a.y * b.x;\nquat.w = a.w * b.w - a.x * b.x - a.y * b.y - a.z * b.z;\nreturn quat;\n}\nvoid rotateVecFromQuat (inout vec3 v, vec4 q){\nfloat ix = q.w * v.x + q.y * v.z - q.z * v.y;\nfloat iy = q.w * v.y + q.z * v.x - q.x * v.z;\nfloat iz = q.w * v.z + q.x * v.y - q.y * v.x;\nfloat iw = -q.x * v.x - q.y * v.y - q.z * v.z;\nv.x = ix * q.w + iw * -q.x + iy * -q.z - iz * -q.y;\nv.y = iy * q.w + iw * -q.y + iz * -q.x - ix * -q.z;\nv.z = iz * q.w + iw * -q.z + ix * -q.y - iy * -q.x;\n}\nvec3 rotateInLocalSpace (vec3 pos, vec3 xAxis, vec3 yAxis, vec3 zAxis, vec4 q){\nvec4 viewQuat = quaternionFromAxis(xAxis, yAxis, zAxis);\nvec4 rotQuat = quatMultiply(viewQuat, q);\nrotateVecFromQuat(pos, rotQuat);\nreturn pos;\n}\nmat3 quatToMat3(vec4 q) {\nvec3 m0 = vec3(\n1.0 - 2.0 * q.y * q.y - 2.0 * q.z * q.z,\n2.0 * q.x * q.y + 2.0 * q.w * q.z,\n2.0 * q.x * q.z - 2.0 * q.w * q.y);\nvec3 m1 = vec3(\n2.0 * q.x * q.y - 2.0 * q.w * q.z,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.z * q.z,\n2.0 * q.y * q.z + 2.0 * q.w * q.x);\nvec3 m2 = vec3(\n2.0 * q.x * q.z + 2.0 * q.w * q.y,\n2.0 * q.y * q.z - 2.0 * q.w * q.x,\n1.0 - 2.0 * q.x * q.x - 2.0 * q.y * q.y);\nreturn mat3(m0, m1, m2);\n}\nvec4 mat3ToQuat(mat3 mat) {\nfloat tr = mat[0][0] + mat[1][1] + mat[2][2];\nfloat qw, qx, qy, qz;\nif (tr > 0.0) {\nfloat S = sqrt(tr + 1.0) * 2.0;\nfloat invS = 1.0 / S;\nqw = 0.25 * S;\nqx = (mat[1][2] - mat[2][1]) * invS;\nqy = (mat[2][0] - mat[0][2]) * invS;\nqz = (mat[0][1] - mat[1][0]) * invS;\n} else if ((mat[0][0] > mat[1][1])&&(mat[0][0] > mat[2][2])) {\nfloat S = sqrt(1.0 + mat[0][0] - mat[1][1] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[1][2] - mat[2][1]) * invS;\nqx = 0.25 * S;\nqy = (mat[1][0] + mat[0][1]) * invS;\nqz = (mat[2][0] + mat[0][2]) * invS;\n} else if (mat[1][1] > mat[2][2]) {\nfloat S = sqrt(1.0 + mat[1][1] - mat[0][0] - mat[2][2]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[2][0] - mat[0][2]) * invS;\nqx = (mat[1][0] + mat[0][1]) * invS;\nqy = 0.25 * S;\nqz = (mat[2][1] + mat[1][2]) * invS;\n} else {\nfloat S = sqrt(1.0 + mat[2][2] - mat[0][0] - mat[1][1]) * 2.0;\nfloat invS = 1.0 / S;\nqw = (mat[0][1] - mat[1][0]) * invS;\nqx = (mat[2][0] + mat[0][2]) * invS;\nqy = (mat[2][1] + mat[1][2]) * invS;\nqz = 0.25 * S;\n}\nreturn vec4(qx, qy, qz, qw);\n}\nlayout(std140) uniform Constants {\nvec4 mainTiling_Offset;\nvec4 frameTile_velLenScale;\nvec4 scale;\nvec4 nodeRotation;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nout mediump vec2 uv;\nout mediump vec4 color;\nvoid computeVertPos (inout vec4 pos, vec2 vertOffset, vec4 q, vec3 s\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\n, mat4 viewInv\n#endif\n#if CC_RENDER_MODE == 1\n, vec3 eye\n, vec4 velocity\n, float velocityScale\n, float lengthScale\n, float xIndex\n#endif\n) {\n#if CC_RENDER_MODE == 0\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = normalize(vec3(viewInv[0][0], viewInv[1][0], viewInv[2][0]));\nvec3 camY = normalize(vec3(viewInv[0][1], viewInv[1][1], viewInv[2][1]));\nvec3 camZ = normalize(vec3(viewInv[0][2], viewInv[1][2], viewInv[2][2]));\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, camZ, q);\n#elif CC_RENDER_MODE == 1\nvec3 camRight = normalize(cross(pos.xyz - eye, velocity.xyz)) * s.x;\nvec3 camUp = velocity.xyz * velocityScale + normalize(velocity.xyz) * lengthScale * s.y;\npos.xyz += (camRight * abs(vertOffset.x) * sign(vertOffset.y)) - camUp * xIndex;\n#elif CC_RENDER_MODE == 2\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nvec3 camX = vec3(1, 0, 0);\nvec3 camY = vec3(0, 0, -1);\npos.xyz += rotateInLocalSpace(viewSpaceVert, camX, camY, cross(camX, camY), q);\n#elif CC_RENDER_MODE == 3\nvec3 viewSpaceVert = vec3(vertOffset.x * s.x, vertOffset.y * s.y, 0.);\nrotateVecFromQuat(viewSpaceVert, q);\nvec3 camX = normalize(vec3(cc_matView[0][0], cc_matView[1][0], cc_matView[2][0]));\nvec3 camY = vec3(0, 1, 0);\nvec3 offset = camX * viewSpaceVert.x + camY * viewSpaceVert.y;\npos.xyz += offset;\n#else\npos.x += vertOffset.x;\npos.y += vertOffset.y;\n#endif\n}\nvec2 computeUV (float frameIndex, vec2 vertIndex, vec2 frameTile){\nvec2 aniUV = vec2(0, floor(frameIndex * frameTile.y));\naniUV.x = floor(frameIndex * frameTile.x * frameTile.y - aniUV.y * frameTile.x);\n#if CC_RENDER_MODE != 4\nvertIndex.y = 1. - vertIndex.y;\n#endif\nreturn (aniUV.xy + vertIndex) / vec2(frameTile.x, frameTile.y);\n}\nin vec3 a_position;\nin vec3 a_texCoord;\nin vec3 a_texCoord1;\nin vec3 a_texCoord2;\nin vec4 a_color;\n#if CC_RENDER_MODE == 1\nin vec3 a_color1;\n#endif\n#if CC_RENDER_MODE == 4\nin vec3 a_texCoord3;\nin vec3 a_normal;\nin vec4 a_color1;\n#endif\nvec4 lpvs_main () {\nvec3 compScale = scale.xyz * a_texCoord1;\nvec4 pos = vec4(a_position, 1);\n#if CC_RENDER_MODE == 1\nvec4 velocity = vec4(a_color1.xyz, 0);\n#endif\n#if !CC_USE_WORLD_SPACE\npos = cc_matWorld * pos;\n#if CC_RENDER_MODE == 1\nvelocity = cc_matWorld * velocity;\n#endif\n#endif\n#if ROTATION_OVER_TIME_MODULE_ENABLE\nvec3 rotTmp = a_texCoord2;\nfloat mulFactor = 1.0;\nif (rotTmp.x > 10.0 * 0.5) {\nrotTmp.x -= 10.0;\nmulFactor = -1.0;\n}\nvec4 rot = vec4(rotTmp, 0.0);\nrot.w = mulFactor * sqrt(abs(1.0 - rot.x * rot.x - rot.y * rot.y - rot.z * rot.z));\n#else\n#if CC_RENDER_MODE != 4\n#if CC_RENDER_MODE == 0\nvec3 rotEuler = a_texCoord2;\n#elif CC_RENDER_MODE == 1\nvec3 rotEuler = vec3(0.);\n#else\nvec3 rotEuler = vec3(0., 0., a_texCoord2.z);\n#endif\nvec4 rot = quaternionFromEuler(rotEuler);\n#else\nvec4 rot = quaternionFromEuler(a_texCoord2);\n#endif\n#endif\n#if CC_RENDER_MODE != 4\nvec2 cornerOffset = vec2((a_texCoord.xy - 0.5));\n#if CC_RENDER_MODE == 0 || CC_RENDER_MODE == 3\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_matViewInv);\n#elif CC_RENDER_MODE == 1\ncomputeVertPos(pos, cornerOffset, rot, compScale, cc_cameraPos.xyz, velocity, frameTile_velLenScale.z, frameTile_velLenScale.w, a_texCoord.x);\n#elif 2\ncomputeVertPos(pos, cornerOffset, rot, compScale);\n#endif\ncolor = a_color;\n#else\nmat3 rotMat = quatToMat3(rot);\nmat3 nodeMat = quatToMat3(nodeRotation);\nrotMat = nodeMat * rotMat;\nrot = mat3ToQuat(rotMat);\nmat4 xformNoScale = matrixFromRT(rot, pos.xyz);\nmat4 xform = matFromRTS(rot, pos.xyz, compScale);\npos = xform * vec4(a_texCoord3, 1);\nvec4 normal = xformNoScale * vec4(a_normal, 0);\ncolor = a_color * a_color1;\n#endif\nuv = computeUV(a_texCoord.z, a_texCoord.xy, frameTile_velLenScale.xy) * mainTiling_Offset.xy + mainTiling_Offset.zw;\npos = cc_matViewProj * pos;\nreturn pos;\n}\nvoid main() { gl_Position = lpvs_main(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 uv;\nin vec4 color;\nuniform sampler2D mainTexture;\nlayout(std140) uniform FragConstants {\nvec4 tintColor;\n};\nvec4 add () {\nvec4 col = 2.0 * color * tintColor * texture(mainTexture, uv);\nreturn CCFragOutput(col);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = add(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 v_light;\nout vec2 uv0;\n#if TWO_COLORED\nin vec4 a_color2;\nout vec4 v_dark;\n#endif\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\npos = cc_matViewProj * pos;\nuv0 = a_texCoord;\nv_light = a_color;\n#if TWO_COLORED\nv_dark = a_color2;\n#endif\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 v_light;\n#if TWO_COLORED\nin vec4 v_dark;\n#endif\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if TWO_COLORED\nvec4 texColor = vec4(1, 1, 1, 1);\ntexColor *= texture(cc_spriteTexture, uv0);\no.a = texColor.a * v_light.a;\no.rgb = ((texColor.a - 1.0) * v_dark.a + 1.0 - texColor.rgb) * v_dark.rgb + texColor.rgb * v_light.rgb;\n#else\no *= texture(cc_spriteTexture, uv0);\no *= v_light;\n#endif\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_LOCAL\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\n#if SAMPLE_FROM_RT\n#endif\nin vec3 a_position;\nin vec2 a_texCoord;\nin vec4 a_color;\nout vec4 color;\nout vec2 uv0;\nvec4 vert () {\nvec4 pos = vec4(a_position, 1);\n#if USE_LOCAL\npos = cc_matWorld * pos;\n#endif\n#if USE_PIXEL_ALIGNMENT\npos = cc_matView * pos;\npos.xyz = floor(pos.xyz);\npos = cc_matProj * pos;\n#else\npos = cc_matViewProj * pos;\n#endif\nuv0 = a_texCoord;\n#if SAMPLE_FROM_RT\nuv0 = cc_cameraPos.w > 1.0 ? vec2(uv0.x, 1.0 - uv0.y) : uv0;\n#endif\ncolor = a_color;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 CCSampleWithAlphaSeparated(sampler2D tex, vec2 uv) {\n#if CC_USE_EMBEDDED_ALPHA\nreturn vec4(texture(tex, uv).rgb, texture(tex, uv + vec2(0.0, 0.5)).r);\n#else\nreturn texture(tex, uv);\n#endif\n}\n#if USE_ALPHA_TEST\nlayout(std140) uniform ALPHA_TEST_DATA {\nfloat alphaThreshold;\n};\n#endif\nvoid ALPHA_TEST (in vec4 color) {\n#if USE_ALPHA_TEST\nif (color.a < alphaThreshold) discard;\n#endif\n}\nvoid ALPHA_TEST (in float alpha) {\n#if USE_ALPHA_TEST\nif (alpha < alphaThreshold) discard;\n#endif\n}\nin vec4 color;\n#if USE_TEXTURE\nin vec2 uv0;\nuniform sampler2D cc_spriteTexture;\n#endif\nvec4 frag () {\nvec4 o = vec4(1, 1, 1, 1);\n#if USE_TEXTURE\no *= CCSampleWithAlphaSeparated(cc_spriteTexture, uv0);\n#if IS_GRAY\nfloat gray  = 0.2126 * o.r + 0.7152 * o.g + 0.0722 * o.b;\no.r = o.g = o.b = gray;\n#endif\n#endif\no *= color;\nALPHA_TEST(o);\nreturn o;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\n#if USE_VERTEX_COLOR\nin vec4 a_color;\nout vec4 v_color;\n#endif\nout vec3 v_position;\nout vec3 v_normal;\nout vec2 v_uv;\nout vec2 v_uv1;\n#if USE_NORMAL_MAP\nout vec3 v_tangent;\nout vec3 v_bitangent;\n#endif\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nout vec3 v_luv;\nvoid CCLightingMapCaclUV()\n{\n#if !USE_INSTANCING\nv_luv.xy = cc_lightingMapUVParam.xy + a_texCoord1 * cc_lightingMapUVParam.zw;\nv_luv.z = cc_lightingMapUVParam.z;\n#else\nv_luv.xy = a_lightingMapUVParam.xy + a_texCoord1 * a_lightingMapUVParam.zw;\nv_luv.z = a_lightingMapUVParam.z;\n#endif\n}\n#endif\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nvec4 pos = matWorld * In.position;\nv_position = pos.xyz;\nv_normal = normalize((matWorldIT * vec4(In.normal, 0.0)).xyz);\n#if USE_TWOSIDE\nvec3 viewDirect = normalize(cc_cameraPos.xyz - v_position);\nv_normal *= dot(v_normal, viewDirect) < 0.0 ? -1.0 : 1.0;\n#endif\n#if USE_NORMAL_MAP\nv_tangent = normalize((matWorld * vec4(In.tangent.xyz, 0.0)).xyz);\nv_bitangent = cross(v_normal, v_tangent) * In.tangent.w;\n#endif\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv1 = cc_cameraPos.w > 1.0 ? vec2(v_uv1.x, 1.0 - v_uv1.y) : v_uv1;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(pos);\nv_shadowPos = cc_matLightViewProj * pos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nCCLightingMapCaclUV();\n#endif\ngl_Position = cc_matProj * (cc_matView * matWorld) * In.position;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin vec3 v_position;\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec3 v_normal;\n#if USE_VERTEX_COLOR\nin vec4 v_color;\n#endif\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_NORMAL_MAP\nin vec3 v_tangent;\nin vec3 v_bitangent;\nuniform sampler2D normalMap;\n#endif\n#if USE_PBR_MAP\nuniform sampler2D pbrMap;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nuniform sampler2D metallicRoughnessMap;\n#endif\n#if USE_OCCLUSION_MAP\nuniform sampler2D occlusionMap;\n#endif\n#if USE_EMISSIVE_MAP\nuniform sampler2D emissiveMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvoid surf (out StandardSurface s) {\nvec4 baseColor = albedo;\n#if USE_VERTEX_COLOR\nbaseColor.rgb *= SRGBToLinear(v_color.rgb);\nbaseColor.a *= v_color.a;\n#endif\n#if USE_ALBEDO_MAP\nvec4 texColor = texture(albedoMap, ALBEDO_UV);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\nbaseColor *= texColor;\n#endif\ns.albedo = baseColor;\ns.albedo.rgb *= albedoScaleAndCutoff.xyz;\n#if USE_ALPHA_TEST\nif (s.albedo.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(cc_lightingMap, v_luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = v_luv.z;\n#endif\ns.normal = v_normal;\n#if USE_NORMAL_MAP\nvec3 nmmp = texture(normalMap, NORMAL_UV).xyz - vec3(0.5);\ns.normal =\n(nmmp.x * emissiveScaleParam.w) * normalize(v_tangent) +\n(nmmp.y * emissiveScaleParam.w) * normalize(v_bitangent) +\nnmmp.z * normalize(s.normal);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\nvec4 pbr = pbrParams;\n#if USE_PBR_MAP\nvec4 res = texture(pbrMap, PBR_UV);\npbr.x *= res.r;\npbr.y *= res.g;\npbr.z *= res.b;\npbr.w *= res.a;\n#endif\n#if USE_METALLIC_ROUGHNESS_MAP\nvec4 metallicRoughness = texture(metallicRoughnessMap, PBR_UV);\npbr.z *= metallicRoughness.b;\npbr.y *= metallicRoughness.g;\n#endif\n#if USE_OCCLUSION_MAP\npbr.x *= texture(occlusionMap, PBR_UV).r;\n#endif\ns.occlusion = pbr.x;\ns.roughness = pbr.y;\ns.metallic = pbr.z;\ns.emissive = emissive.rgb * emissiveScaleParam.xyz;\n#if USE_EMISSIVE_MAP\ns.emissive *= SRGBToLinear(texture(emissiveMap, EMISSIVE_UV).rgb);\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if HAS_SECOND_UV || USE_LIGHTMAP\nin vec2 a_texCoord1;\n#endif\nout vec2 v_uv;\nout vec2 v_uv1;\nout vec4 v_worldPos;\nout float v_clip_depth;\nvec4 vert () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nmat4 matWorld, matWorldIT;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\nmatWorldIT = matWorld;\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\nmatWorldIT = matWorld;\n#else\nmatWorld = cc_matWorld;\nmatWorldIT = cc_matWorldIT;\n#endif\nv_worldPos = matWorld * In.position;\nvec4 clipPos = cc_matLightViewProj * v_worldPos;\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if HAS_SECOND_UV\nv_uv1 = a_texCoord1 * tilingOffset.xy + tilingOffset.zw;\n#endif\nv_clip_depth = clipPos.z / clipPos.w * 0.5 + 0.5;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nlayout(std140) uniform Constants {\nvec4 tilingOffset;\nvec4 albedo;\nvec4 albedoScaleAndCutoff;\nvec4 pbrParams;\nvec4 emissive;\nvec4 emissiveScaleParam;\n};\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec2 v_uv;\nin vec2 v_uv1;\nin vec4 v_worldPos;\nin float v_clip_depth;\n#if USE_ALBEDO_MAP\nuniform sampler2D albedoMap;\n#endif\n#if USE_ALPHA_TEST\n#endif\nvec4 frag () {\nvec4 baseColor = albedo;\n#if USE_ALBEDO_MAP\nbaseColor *= texture(albedoMap, ALBEDO_UV);\n#endif\n#if USE_ALPHA_TEST\nif (baseColor.ALPHA_TEST_CHANNEL < albedoScaleAndCutoff.w) discard;\n#endif\nif(cc_shadowLPNNInfo.x > 0.000001 && cc_shadowLPNNInfo.x < 1.999999) {\nif (cc_shadowNFLSInfo.z > 0.000001) {\nreturn vec4(CCGetLinearDepth(v_worldPos.xyz), 1.0, 1.0, 1.0);\n}\n}\nif (cc_shadowLPNNInfo.y > 0.000001) {\nreturn packDepthToRGBA(v_clip_depth);\n}\nreturn vec4(v_clip_depth, 1.0, 1.0, 1.0);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\nout highp vec4 v_shadowPos;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\n#endif\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout highp vec3 v_position;\nout mediump vec3 v_normal;\n#if USE_NORMALMAP\nout mediump vec3 v_tangent;\nout mediump vec3 v_binormal;\n#endif\nout mediump vec2 uvw;\nout mediump vec2 uv0;\nout mediump vec2 uv1;\nout mediump vec2 uv2;\nout mediump vec2 uv3;\nout mediump vec3 luv;\nout mediump vec3 diffuse;\nlayout(std140) uniform TexCoords {\nvec4 UVScale;\nvec4 lightMapUVParam;\n};\nvoid main () {\nvec3 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nvec4 pos = vec4(worldPos, 1.0);\npos = cc_matViewProj * pos;\nuvw = a_texCoord;\nuv0 = a_position.xz * UVScale.x;\nuv1 = a_position.xz * UVScale.y;\nuv2 = a_position.xz * UVScale.z;\nuv3 = a_position.xz * UVScale.w;\n#if USE_LIGHTMAP\nluv.xy = lightMapUVParam.xy + a_texCoord * lightMapUVParam.zw;\nluv.z = lightMapUVParam.z;\n#endif\nv_position = worldPos;\nv_normal = a_normal;\nCC_TRANSFER_FOG(vec4(worldPos, 1.0));\n#if USE_NORMALMAP\nv_tangent = vec3(1.0, 0.0, 0.0);\nv_binormal = vec3(0.0, 0.0, 1.0);\nv_binormal = cross(v_tangent, a_normal);\nv_tangent = cross(a_normal, v_binormal);\n#endif\nv_shadowPos = cc_matLightViewProj * vec4(worldPos, 1.0);\ngl_Position = pos;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out float mainPart, out float modPart, highp float data, const float modValue) {\nhighp float divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec2 mainPart, out vec2 modPart, highp vec2 data, const float modValue) {\nhighp vec2 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec3 mainPart, out vec3 modPart, highp vec3 data, const float modValue) {\nhighp vec3 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data) {\nmainPart = fract(data);\nmodPart = data - mainPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nvoid packHighpData (out vec4 mainPart, out vec4 modPart, highp vec4 data, const float modValue) {\nhighp vec4 divide = data / modValue;\nmainPart = floor(divide);\nmodPart = (data - mainPart * modValue) / modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\nin highp vec4 v_shadowPos;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nin vec3 v_luv;\nuniform sampler2D cc_lightingMap;\nvec3 UnpackLightingmap(vec4 color) {\nvec3 c;\nfloat e = 1.0 + color.a * (8.0 - 1.0);\nc.r = color.r * e;\nc.g = color.g * e;\nc.b = color.b * e;\nreturn c;\n}\n#endif\nin highp vec3 v_position;\nin mediump vec3 v_normal;\n#if USE_NORMALMAP\nin mediump vec3 v_tangent;\nin mediump vec3 v_binormal;\n#endif\nin mediump vec2 uvw;\nin mediump vec2 uv0;\nin mediump vec2 uv1;\nin mediump vec2 uv2;\nin mediump vec2 uv3;\nin mediump vec3 diffuse;\nin mediump vec3 luv;\nlayout(std140) uniform PbrParams {\nvec4 metallic;\nvec4 roughness;\n};\nuniform sampler2D weightMap;\nuniform sampler2D detailMap0;\nuniform sampler2D detailMap1;\nuniform sampler2D detailMap2;\nuniform sampler2D detailMap3;\nuniform sampler2D normalMap0;\nuniform sampler2D normalMap1;\nuniform sampler2D normalMap2;\nuniform sampler2D normalMap3;\nuniform sampler2D lightMap;\nvoid surf (out StandardSurface s) {\n#if LAYERS > 1\nvec4 w = texture(weightMap, uvw);\n#endif\nvec4 baseColor = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseColor = texture(detailMap0, uv0);\n#elif LAYERS == 2\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseColor += texture(detailMap0, uv0) * w.r;\nbaseColor += texture(detailMap1, uv1) * w.g;\nbaseColor += texture(detailMap2, uv2) * w.b;\nbaseColor += texture(detailMap3, uv3) * w.a;\n#else\nbaseColor = texture(detailMap0, uv0);\n#endif\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\npackHighpData(s.position, s.position_fract_part, v_position);\n#else\ns.position = v_position;\n#endif\n#if USE_NORMALMAP\nvec4 baseNormal = vec4(0, 0, 0, 0);\n#if LAYERS == 1\nbaseNormal = texture(normalMap0, uv0);\n#elif LAYERS == 2\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\n#elif LAYERS == 3\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\n#elif LAYERS == 4\nbaseNormal += texture(normalMap0, uv0) * w.r;\nbaseNormal += texture(normalMap1, uv1) * w.g;\nbaseNormal += texture(normalMap2, uv2) * w.b;\nbaseNormal += texture(normalMap3, uv3) * w.a;\n#else\nbaseNormal = texture(normalMap0, uv0);\n#endif\nvec3 nmmp = baseNormal.xyz - vec3(0.5);\ns.normal =\nnmmp.x * normalize(v_tangent) +\nnmmp.y * normalize(v_binormal) +\nnmmp.z * normalize(v_normal);\n#else\ns.normal = v_normal;\n#endif\ns.albedo = vec4(SRGBToLinear(baseColor.rgb), 1.0);\ns.occlusion = 1.0;\n#if USE_PBR\ns.roughness = 0.0;\n#if LAYERS == 1\ns.roughness = roughness.x;\n#elif LAYERS == 2\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\n#elif LAYERS == 3\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\n#elif LAYERS == 4\ns.roughness += roughness.x * w.r;\ns.roughness += roughness.y * w.g;\ns.roughness += roughness.z * w.b;\ns.roughness += roughness.w * w.a;\n#else\ns.roughness = 1.0;\n#endif\ns.metallic = 0.0;\n#if LAYERS == 1\ns.metallic = metallic.x;\n#elif LAYERS == 2\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\n#elif LAYERS == 3\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\n#elif LAYERS == 4\ns.metallic += metallic.x * w.r;\ns.metallic += metallic.y * w.g;\ns.metallic += metallic.z * w.b;\ns.metallic += metallic.w * w.a;\n#else\ns.metallic = 0.0;\n#endif\n#else\ns.roughness = 1.0;\ns.metallic = 0.0;\n#endif\ns.emissive = vec3(0.0, 0.0, 0.0);\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nvec4 lightColor = texture(lightMap, luv.xy);\ns.lightmap = UnpackLightingmap(lightColor);\ns.lightmap_test = luv.z;\n#endif\n}\n#if CC_FORWARD_ADD\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nvec4 color = CCClusterShadingAdditive(s, v_shadowPos);\n#else\nvec4 color = CCStandardShadingAdditive(s, v_shadowPos);\n#endif\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif (CC_PIPELINE_TYPE == 0 || CC_FORCE_FORWARD_SHADING)\nlayout(location = 0) out vec4 fragColorX;\nvoid main () {\nStandardSurface s; surf(s);\nvec4 color = CCStandardShadingBase(s, v_shadowPos);\nCC_APPLY_FOG(color, s.position.xyz);\nfragColorX = CCFragOutput(color);\n}\n#elif CC_PIPELINE_TYPE == 1\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec2 float32x3_to_oct(in vec3 v) {\nvec2 p = v.xy * (1.0 / (abs(v.x) + abs(v.y) + abs(v.z)));\nreturn (v.z <= 0.0) ? ((1.0 - abs(p.yx)) * signNotZero(p)) : p;\n}\nlayout(location = 0) out vec4 fragColor0;\nlayout(location = 1) out vec4 fragColor1;\nlayout(location = 2) out vec4 fragColor2;\nvoid main () {\nStandardSurface s; surf(s);\nfragColor0 = s.albedo;\nfragColor1 = vec4(float32x3_to_oct(s.normal), s.roughness, s.metallic);\nfragColor2 = vec4(s.emissive, s.occlusion);\n}\n#endif"},{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nout vec2 v_clip_depth;\nvec4 vert () {\nvec4 worldPos;\nworldPos.x = cc_matWorld[3][0] + a_position.x;\nworldPos.y = cc_matWorld[3][1] + a_position.y;\nworldPos.z = cc_matWorld[3][2] + a_position.z;\nworldPos.w = 1.0;\nvec4 clipPos = cc_matLightViewProj * worldPos;\nv_clip_depth = clipPos.zw;\nreturn clipPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec4 packDepthToRGBA (float depth) {\nvec4 ret = vec4(1.0, 255.0, 65025.0, 16581375.0) * depth;\nret = fract(ret);\nret -= vec4(ret.yzw, 0.0) / 255.0;\nreturn ret;\n}\nin vec2 v_clip_depth;\nvec4 frag () {\nreturn packDepthToRGBA(v_clip_depth.x / v_clip_depth.y * 0.5 + 0.5);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\n#if !CC_USE_ACCURATE_FOG\nout float v_fog_factor;\n#endif\nvoid CC_TRANSFER_FOG(vec4 pos) {\n#if !CC_USE_ACCURATE_FOG\nCC_TRANSFER_FOG_BASE(pos, v_fog_factor);\n#endif\n}\n#if USE_VERTEX_COLOR\nin lowp vec4 a_color;\nout lowp vec4 v_color;\n#endif\n#if USE_TEXTURE\nout vec2 v_uv;\nlayout(std140) uniform TexCoords {\nvec4 tilingOffset;\n};\n#endif\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\n#if USE_TEXTURE\nv_uv = a_texCoord * tilingOffset.xy + tilingOffset.zw;\n#if SAMPLE_FROM_RT\nv_uv = cc_cameraPos.w > 1.0 ? vec2(v_uv.x, 1.0 - v_uv.y) : v_uv;\n#endif\n#endif\n#if USE_VERTEX_COLOR\nv_color = a_color;\n#endif\nCC_TRANSFER_FOG(matWorld * position);\nreturn cc_matProj * (cc_matView * matWorld) * position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision highp float;\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\n#if !CC_USE_ACCURATE_FOG\nin float v_fog_factor;\n#endif\nvoid CC_APPLY_FOG(inout vec4 color) {\n#if !CC_USE_ACCURATE_FOG\nCC_APPLY_FOG_BASE(color, v_fog_factor);\n#endif\n}\nvoid CC_APPLY_FOG(inout vec4 color, vec3 worldPos) {\n#if CC_USE_ACCURATE_FOG\nfloat factor;\nCC_TRANSFER_FOG_BASE(vec4(worldPos, 1.0), factor);\n#else\nfloat factor = v_fog_factor;\n#endif\nCC_APPLY_FOG_BASE(color, factor);\n}\n#if USE_ALPHA_TEST\n#endif\n#if USE_TEXTURE\nin vec2 v_uv;\nuniform sampler2D mainTexture;\n#endif\nlayout(std140) uniform Constant {\nvec4 mainColor;\nvec4 colorScaleAndCutoff;\n};\n#if USE_VERTEX_COLOR\nin lowp vec4 v_color;\n#endif\nvec4 frag () {\nvec4 o = mainColor;\no.rgb *= colorScaleAndCutoff.xyz;\n#if USE_VERTEX_COLOR\no.rgb *= SRGBToLinear(v_color.rgb);\no.a *= v_color.a;\n#endif\n#if USE_TEXTURE\nvec4 texColor = texture(mainTexture, v_uv);\ntexColor.rgb = SRGBToLinear(texColor.rgb);\no *= texColor;\n#endif\n#if USE_ALPHA_TEST\nif (o.ALPHA_TEST_CHANNEL < colorScaleAndCutoff.w) discard;\n#endif\nCC_APPLY_FOG(o);\nreturn CCFragOutput(o);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nfloat luminance(vec3 color) {\nreturn dot(color, vec3(0.2126, 0.7152, 0.0722));\n}\nvoid main() {\nvec3 color = texture(outputResultMap, v_uv).xyz;\nif (luminance(SRGBToLinear(color)) > texSize.z) {\nfragColor = vec4(color, 1.0);\n} else {\nfragColor = vec4(0.0, 0.0, 0.0, 1.0);\n}\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 downsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main()\n{\nvec3 result = downsample4taps(v_uv, 1.0 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvec3 upsample4taps(vec2 uv, vec2 halfpixel) {\nvec3 sum = texture(bloomTexture, uv + vec2(-halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(halfpixel.x, -halfpixel.y)).xyz;\nsum += texture(bloomTexture, uv + vec2(-halfpixel.x, -halfpixel.y)).xyz;\nreturn sum / 4.0;\n}\nvoid main() {\nvec3 result = upsample4taps(v_uv, 0.5 / texSize.xy).rgb;\nfragColor = vec4(result, 1.0);\n}"},{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec2 v_uv;\nlayout(std140) uniform BloomUBO {\nmediump vec4 texSize;\n};\nuniform sampler2D outputResultMap;\nuniform sampler2D bloomTexture;\nlayout(location = 0) out vec4 fragColor;\nvoid main() {\nvec4 hdrColor = texture(outputResultMap, v_uv);\nvec3 bloomColor = texture(bloomTexture, v_uv).rgb;\nvec3 result = hdrColor.rgb + bloomColor * texSize.w * hdrColor.a;\nfragColor = vec4(result, hdrColor.a);\n}"}],[{vert:"\nprecision highp float;\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nvec4 position;\nposition = vec4(a_position, 1.0);\nposition.xy = cc_cameraPos.w == 0.0 ? vec2(position.xy.x, -position.xy.y) : position.xy;\ngl_Position = vec4(position.x, position.y, 1.0, 1.0);\nv_uv = a_texCoord;\n}",frag:"\n#ifdef GL_EXT_shader_framebuffer_fetch\n#extension GL_EXT_shader_framebuffer_fetch: enable\n#endif\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nhighp float unpackHighpData (float mainPart, float modPart) {\nhighp float data = mainPart;\nreturn data + modPart;\n}\nhighp float unpackHighpData (float mainPart, float modPart, const float modValue) {\nhighp float data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart) {\nhighp vec2 data = mainPart;\nreturn data + modPart;\n}\nhighp vec2 unpackHighpData (vec2 mainPart, vec2 modPart, const float modValue) {\nhighp vec2 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart) {\nhighp vec3 data = mainPart;\nreturn data + modPart;\n}\nhighp vec3 unpackHighpData (vec3 mainPart, vec3 modPart, const float modValue) {\nhighp vec3 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart) {\nhighp vec4 data = mainPart;\nreturn data + modPart;\n}\nhighp vec4 unpackHighpData (vec4 mainPart, vec4 modPart, const float modValue) {\nhighp vec4 data = mainPart * modValue;\nreturn data + modPart * modValue;\n}\nfloat CCGetLinearDepthFromViewSpace(vec3 viewPos) {\nfloat dist = length(viewPos);\nreturn (dist - cc_shadowNFLSInfo.x) / (cc_shadowNFLSInfo.y - cc_shadowNFLSInfo.x);\n}\nfloat CCGetLinearDepth(vec3 worldPos) {\nvec4 viewStartPos = cc_matLightView * vec4(worldPos.xyz, 1.0);\nreturn CCGetLinearDepthFromViewSpace(viewStartPos.xyz);\n}\n#if CC_RECEIVE_SHADOW\nuniform highp sampler2D cc_shadowMap;\nuniform highp sampler2D cc_spotLightingMap;\nvec4 ApplyShadowDepthBias_FaceNormal(vec4 shadowPos, vec3 worldNormal)\n{\nvec4 newShadowPos = shadowPos;\nif(cc_shadowLPNNInfo.z > 0.0001)\n{\nvec4 viewNormal = cc_matLightView * vec4(worldNormal, 0.0);\nif(viewNormal.z < 0.1)\nnewShadowPos.xy += viewNormal.xy * cc_shadowProjInfo.xy * cc_shadowLPNNInfo.z * clamp(viewNormal.z, 0.001, 0.1);\n}\nreturn newShadowPos;\n}\nvec4 ApplyShadowDepthBias_Perspective(vec4 shadowPos, float viewspaceDepthBias)\n{\nvec3 viewSpacePos;\nviewSpacePos.xy = shadowPos.xy * cc_shadowProjInfo.zw;\nviewSpacePos.z = shadowPos.z * cc_shadowInvProjDepthInfo.x + shadowPos.w * cc_shadowInvProjDepthInfo.y;\nviewSpacePos.xyz += cc_shadowProjDepthInfo.z * normalize(viewSpacePos.xyz) * viewspaceDepthBias;\nvec4 clipSpacePos;\nclipSpacePos.xy = viewSpacePos.xy * cc_shadowProjInfo.xy;\nclipSpacePos.zw = viewSpacePos.z * cc_shadowProjDepthInfo.xz + vec2(cc_shadowProjDepthInfo.y, 0.0);\nif (cc_shadowNFLSInfo.z > 0.000001) {\nclipSpacePos.z = CCGetLinearDepthFromViewSpace(viewSpacePos.xyz);\nclipSpacePos.z = (clipSpacePos.z * 2.0 - 1.0) * clipSpacePos.w;\n}\nreturn clipSpacePos;\n}\nvec4 ApplyShadowDepthBias_Orthographic(vec4 shadowPos, float viewspaceDepthBias)\n{\nfloat coeffA = cc_shadowProjDepthInfo.x;\nfloat coeffB = cc_shadowProjDepthInfo.y;\nfloat viewSpacePos_z = (shadowPos.z - coeffB) / coeffA;\nviewSpacePos_z += viewspaceDepthBias;\nvec4 result = shadowPos;\nresult.z = viewSpacePos_z * coeffA + coeffB;\nreturn result;\n}\nfloat CCGetShadowFactorHard (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_shadowMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_shadowMap, clipPos.xy).x;\n}\nshadow = step(clipPos.z, closestDepth);\nreturn shadow;\n}\nfloat CCGetShadowFactorSoft (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * mapSize.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetShadowFactorSoft2X (vec4 shadowPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Orthographic(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat offsetDepth = clipPos.z;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(offsetDepth, dot(texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(offsetDepth, texture(cc_shadowMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\nfloat CCGetSpotLightShadowFactorHard (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat shadow = 0.0;\nfloat closestDepth = 0.0;\nfloat depth = clipPos.z;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nclosestDepth = dot(texture(cc_spotLightingMap, clipPos.xy), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0));\n} else {\nclosestDepth = texture(cc_spotLightingMap, clipPos.xy).x;\n}\nshadow = step(depth, closestDepth);\nreturn shadow;\n}\nfloat CCGetSpotLightShadowFactorSoft (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 oneTap = 1.0 / cc_shadowWHPBInfo.xy;\nvec2 clipPos_offset = clipPos.xy + oneTap;\nfloat block0, block1, block2, block3;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos.y)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset.y)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset.x, clipPos_offset.y)).x);\n}\nfloat coefX   = mod(clipPos.x, oneTap.x) * cc_shadowWHPBInfo.x;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block2, block3, coefX);\nfloat coefY   = mod(clipPos.y, oneTap.y) * cc_shadowWHPBInfo.y;\nreturn mix(resultX, resultY, coefY);\n}\nfloat CCGetSpotLightShadowFactorSoft2X (vec4 shadowPos, vec3 worldPos) {\nvec4 clipPosNew = ApplyShadowDepthBias_Perspective(shadowPos, cc_shadowWHPBInfo.w);\nvec3 clipPos = clipPosNew.xyz / clipPosNew.w * 0.5 + 0.5;\nif (clipPos.x < 0.0 || clipPos.x > 1.0 ||\nclipPos.y < 0.0 || clipPos.y > 1.0 ||\nclipPos.z < 0.0 || clipPos.z > 1.0) { return 1.0; }\nclipPos.xy = cc_cameraPos.w == 1.0 ? vec2(clipPos.xy.x, 1.0 - clipPos.xy.y) : clipPos.xy;\nfloat depth = 0.0;\nif (cc_shadowNFLSInfo.z > 0.000001) {\ndepth = CCGetLinearDepth(worldPos);\n} else {\ndepth = clipPos.z;\n}\nfloat bias = cc_shadowWHPBInfo.w;\nvec2 mapSize = cc_shadowWHPBInfo.xy;\nvec2 oneTap = 1.0 / mapSize;\nfloat clipPos_offset_L = clipPos.x - oneTap.x;\nfloat clipPos_offset_R = clipPos.x + oneTap.x;\nfloat clipPos_offset_U = clipPos.y - oneTap.y;\nfloat clipPos_offset_D = clipPos.y + oneTap.y;\nfloat block0, block1, block2, block3, block4, block5, block6, block7, block8;\nif (cc_shadowLPNNInfo.y > 0.000001) {\nblock0 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock1 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock2 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock3 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock4 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock5 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock6 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock7 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\nblock8 = step(depth, dot(texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)), vec4(1.0, 1.0 / 255.0, 1.0 / 65025.0, 1.0 / 16581375.0)));\n} else {\nblock0 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_U)).x);\nblock1 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_U)).x);\nblock2 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_U)).x);\nblock3 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos.y)).x);\nblock4 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos.y)).x);\nblock5 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos.y)).x);\nblock6 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_L, clipPos_offset_D)).x);\nblock7 = step(depth, texture(cc_spotLightingMap, vec2(clipPos.x, clipPos_offset_D)).x);\nblock8 = step(depth, texture(cc_spotLightingMap, vec2(clipPos_offset_R, clipPos_offset_D)).x);\n}\nfloat coefX = mod(clipPos.x, oneTap.x) * mapSize.x;\nfloat coefY = mod(clipPos.y, oneTap.y) * mapSize.y;\nfloat shadow = 0.0;\nfloat resultX = mix(block0, block1, coefX);\nfloat resultY = mix(block3, block4, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block1, block2, coefX);\nresultY = mix(block4, block5, coefX);\nshadow += mix(resultX , resultY, coefY);\nresultX = mix(block3, block4, coefX);\nresultY = mix(block6, block7, coefX);\nshadow += mix(resultX, resultY, coefY);\nresultX = mix(block4, block5, coefX);\nresultY = mix(block7, block8, coefX);\nshadow += mix(resultX, resultY, coefY);\nreturn shadow * 0.25;\n}\n#endif\n#if CC_USE_IBL\nuniform samplerCube cc_environment;\nvec4 fragTextureLod (sampler2D tex, vec2 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec4 fragTextureLod (samplerCube tex, vec3 coord, float lod) {\nreturn textureLod(tex, coord, lod);\n}\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\n#if CC_USE_DIFFUSEMAP\nuniform samplerCube cc_diffuseMap;\n#endif\n#endif\nfloat GGXMobile (float roughness, float NoH, vec3 H, vec3 N) {\nvec3 NxH = cross(N, H);\nfloat OneMinusNoHSqr = dot(NxH, NxH);\nfloat a = roughness * roughness;\nfloat n = NoH * a;\nfloat p = a / (OneMinusNoHSqr + n * n);\nreturn p * p;\n}\nfloat CalcSpecular (float roughness, float NoH, vec3 H, vec3 N) {\nreturn (roughness * 0.25 + 0.25) * GGXMobile(roughness, NoH, H, N);\n}\nvec3 BRDFApprox (vec3 specular, float roughness, float NoV) {\nconst vec4 c0 = vec4(-1.0, -0.0275, -0.572, 0.022);\nconst vec4 c1 = vec4(1.0, 0.0425, 1.04, -0.04);\nvec4 r = roughness * c0 + c1;\nfloat a004 = min(r.x * r.x, exp2(-9.28 * NoV)) * r.x + r.y;\nvec2 AB = vec2(-1.04, 1.04) * a004 + r.zw;\nAB.y *= clamp(50.0 * specular.g, 0.0, 1.0);\nreturn specular * AB.x + AB.y;\n}\n#if USE_REFLECTION_DENOISE\nvec3 GetEnvReflectionWithMipFiltering(vec3 R, float roughness, float mipCount, float denoiseIntensity) {\n#if CC_USE_IBL\nfloat mip = roughness * mipCount;\nfloat delta = (dot(dFdx(R), dFdy(R))) * 1000.0;\nfloat mipBias = mix(0.0, 5.0, clamp(delta, 0.0, 1.0));\nvec4 biased = fragTextureLod(cc_environment, R, mip + mipBias);\nvec4 filtered = texture(cc_environment, R);\n#if CC_USE_IBL == 2\nbiased.rgb = unpackRGBE(biased);\nfiltered.rgb = unpackRGBE(filtered);\n#else\nbiased.rgb = SRGBToLinear(biased.rgb);\nfiltered.rgb = SRGBToLinear(filtered.rgb);\n#endif\nreturn mix(biased.rgb, filtered.rgb, denoiseIntensity);\n#else\nreturn vec3(0.0, 0.0, 0.0);\n#endif\n}\n#endif\nstruct StandardSurface {\nvec4 albedo;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nvec3 position, position_fract_part;\n#else\nvec3 position;\n#endif\nvec3 normal;\nvec3 emissive;\nvec3 lightmap;\nfloat lightmap_test;\nfloat roughness;\nfloat metallic;\nfloat occlusion;\n};\nvec4 CCStandardShadingBase (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 L = normalize(-cc_mainLitDir.xyz);\nvec3 H = normalize(L + V);\nfloat NH = max(dot(N, H), 0.0);\nfloat NL = max(dot(N, L), 0.0);\nvec3 finalColor = NL * cc_mainLitColor.rgb * cc_mainLitColor.w;\nvec3 diffuseContrib = diffuse;\n#if USE_LIGHTMAP && !USE_BATCHING && !CC_FORWARD_ADD\nif (s.lightmap_test > 0.0001) {\nfinalColor = s.lightmap.rgb;\n}\n#else\ndiffuseContrib /= 3.14159265359;\n#endif\nvec3 specularContrib = specular * CalcSpecular(s.roughness, NH, H, N);\nvec3 dirlightContrib = (diffuseContrib + specularContrib);\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (NL > 0.0 && cc_mainLitDir.w > 0.0) {\n{\nvec4 pos = ApplyShadowDepthBias_FaceNormal(shadowPos, N);\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetShadowFactorSoft2X(pos);\nelse if (pcf > 0.9) shadow = CCGetShadowFactorSoft(pos);\nelse shadow = CCGetShadowFactorHard(pos);\nshadow = mix(shadow, 1.0, cc_shadowNFLSInfo.w);\n}\n}\n#endif\ndirlightContrib *= shadow;\nfinalColor *= dirlightContrib;\nfloat fAmb = 0.5 - N.y * 0.5;\nvec3 ambDiff = mix(cc_ambientSky.rgb, cc_ambientGround.rgb, fAmb);\n#if CC_USE_IBL\n#if CC_USE_DIFFUSEMAP\nvec4 diffuseMap = texture(cc_diffuseMap, N);\n#if CC_USE_DIFFUSEMAP == 2\nambDiff = unpackRGBE(diffuseMap);\n#else\nambDiff = SRGBToLinear(diffuseMap.rgb);\n#endif\n#endif\nvec3 R = normalize(reflect(-V, N));\n#if USE_REFLECTION_DENOISE\nvec3 env = GetEnvReflectionWithMipFiltering(R, s.roughness, cc_ambientGround.w, 0.6);\n#else\nvec4 envmap = fragTextureLod(cc_environment, R, s.roughness * cc_ambientGround.w);\n#if CC_USE_IBL == 2\nvec3 env = unpackRGBE(envmap);\n#else\nvec3 env = SRGBToLinear(envmap.rgb);\n#endif\n#endif\nfinalColor += env * cc_ambientSky.w * specular * s.occlusion;\n#endif\nfinalColor += ambDiff.rgb * cc_ambientSky.w * diffuse * s.occlusion;\nfinalColor += s.emissive;\nreturn vec4(finalColor, s.albedo.a);\n}\n#if CC_PIPELINE_TYPE == 0\n# define LIGHTS_PER_PASS 1\n#else\n# define LIGHTS_PER_PASS 10\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nlayout(std140) uniform CCForwardLight {\nhighp vec4 cc_lightPos[LIGHTS_PER_PASS];\nvec4 cc_lightColor[LIGHTS_PER_PASS];\nvec4 cc_lightSizeRangeAngle[LIGHTS_PER_PASS];\nvec4 cc_lightDir[LIGHTS_PER_PASS];\n};\n#endif\nfloat SmoothDistAtt (float distSqr, float invSqrAttRadius) {\nfloat factor = distSqr * invSqrAttRadius;\nfloat smoothFactor = clamp(1.0 - factor * factor, 0.0, 1.0);\nreturn smoothFactor * smoothFactor;\n}\nfloat GetDistAtt (float distSqr, float invSqrAttRadius) {\nfloat attenuation = 1.0 / max(distSqr, 0.01*0.01);\nattenuation *= SmoothDistAtt(distSqr , invSqrAttRadius);\nreturn attenuation;\n}\nfloat GetAngleAtt (vec3 L, vec3 litDir, float litAngleScale, float litAngleOffset) {\nfloat cd = dot(litDir, L);\nfloat attenuation = clamp(cd * litAngleScale + litAngleOffset, 0.0, 1.0);\nreturn (attenuation * attenuation);\n}\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 0\nvec4 CCStandardShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.0);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nint numLights = CC_PIPELINE_TYPE == 0 ? LIGHTS_PER_PASS : int(cc_lightDir[0].w);\nfor (int i = 0; i < LIGHTS_PER_PASS; i++) {\nif (i >= numLights) break;\nvec3 SLU = cc_lightPos[i].xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.0);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = cc_lightSizeRangeAngle[i].x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(cc_lightSizeRangeAngle[i].y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (cc_lightPos[i].w > 0.0) {\nfloat cosInner = max(dot(-cc_lightDir[i].xyz, SL), 0.01);\nfloat cosOuter = cc_lightSizeRangeAngle[i].z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -cc_lightDir[i].xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = cc_lightColor[i].rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (cc_lightPos[i].w > 0.0 && cc_lightSizeRangeAngle[i].w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * cc_lightColor[i].w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nlayout(std430, binding = 4) readonly buffer b_ccLightsBuffer { vec4 b_ccLights[]; };\nlayout(std430, binding = 5) readonly buffer b_clusterLightIndicesBuffer { uint b_clusterLightIndices[]; };\nlayout(std430, binding = 6) readonly buffer b_clusterLightGridBuffer { uvec4 b_clusterLightGrid[]; };\nstruct CCLight\n{\nvec4 cc_lightPos;\nvec4 cc_lightColor;\nvec4 cc_lightSizeRangeAngle;\nvec4 cc_lightDir;\n};\nstruct Cluster\n{\nvec3 minBounds;\nvec3 maxBounds;\n};\nstruct LightGrid\n{\nuint offset;\nuint ccLights;\n};\nCCLight getCCLight(uint i)\n{\nCCLight light;\nlight.cc_lightPos = b_ccLights[4u * i + 0u];\nlight.cc_lightColor = b_ccLights[4u * i + 1u];\nlight.cc_lightSizeRangeAngle = b_ccLights[4u * i + 2u];\nlight.cc_lightDir = b_ccLights[4u * i + 3u];\nreturn light;\n}\nLightGrid getLightGrid(uint cluster)\n{\nuvec4 gridvec = b_clusterLightGrid[cluster];\nLightGrid grid;\ngrid.offset = gridvec.x;\ngrid.ccLights = gridvec.y;\nreturn grid;\n}\nuint getGridLightIndex(uint start, uint offset)\n{\nreturn b_clusterLightIndices[start + offset];\n}\nuint getClusterZIndex(vec4 worldPos)\n{\nfloat scale = float(24) / log(cc_nearFar.y / cc_nearFar.x);\nfloat bias = -(float(24) * log(cc_nearFar.x) / log(cc_nearFar.y / cc_nearFar.x));\nfloat eyeDepth = -(cc_matView * worldPos).z;\nuint zIndex = uint(max(log(eyeDepth) * scale + bias, 0.0));\nreturn zIndex;\n}\nuint getClusterIndex(vec4 fragCoord, vec4 worldPos)\n{\nuint zIndex = getClusterZIndex(worldPos);\nfloat clusterSizeX = ceil(cc_viewPort.z / float(16));\nfloat clusterSizeY = ceil(cc_viewPort.w / float(8));\nuvec3 indices = uvec3(uvec2(fragCoord.xy / vec2(clusterSizeX, clusterSizeY)), zIndex);\nuint cluster = (16u * 8u) * indices.z + 16u * indices.y + indices.x;\nreturn cluster;\n}\nvec4 CCClusterShadingAdditive (StandardSurface s, vec4 shadowPos) {\nvec3 diffuse = s.albedo.rgb * (1.0 - s.metallic);\nvec3 specular = mix(vec3(0.04), s.albedo.rgb, s.metallic);\nvec3 diffuseContrib = diffuse / 3.14159265359;\nvec3 position;\n#if CC_PLATFORM_ANDROID_AND_WEBGL && CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES\nposition = unpackHighpData(s.position, s.position_fract_part);\n#else\nposition = s.position;\n#endif\nvec3 N = normalize(s.normal);\nvec3 V = normalize(cc_cameraPos.xyz - position);\nfloat NV = max(abs(dot(N, V)), 0.001);\nspecular = BRDFApprox(specular, s.roughness, NV);\nvec3 finalColor = vec3(0.0);\nuint cluster = getClusterIndex(gl_FragCoord, vec4(position, 1.0));\nLightGrid grid = getLightGrid(cluster);\nuint numLights = grid.ccLights;\nfor (uint i = 0u; i < 100u; i++) {\nif (i >= numLights) break;\nuint lightIndex = getGridLightIndex(grid.offset, i);\nCCLight light = getCCLight(lightIndex);\nvec3 SLU = light.cc_lightPos.xyz - position;\nvec3 SL = normalize(SLU);\nvec3 SH = normalize(SL + V);\nfloat SNL = max(dot(N, SL), 0.001);\nfloat SNH = max(dot(N, SH), 0.0);\nfloat distSqr = dot(SLU, SLU);\nfloat litRadius = light.cc_lightSizeRangeAngle.x;\nfloat litRadiusSqr = litRadius * litRadius;\nfloat illum = 3.14159265359 * (litRadiusSqr / max(litRadiusSqr , distSqr));\nfloat attRadiusSqrInv = 1.0 / max(light.cc_lightSizeRangeAngle.y, 0.01);\nattRadiusSqrInv *= attRadiusSqrInv;\nfloat att = GetDistAtt(distSqr, attRadiusSqrInv);\nvec3 lspec = specular * CalcSpecular(s.roughness, SNH, SH, N);\nif (light.cc_lightPos.w > 0.0) {\nfloat cosInner = max(dot(-light.cc_lightDir.xyz, SL), 0.01);\nfloat cosOuter = light.cc_lightSizeRangeAngle.z;\nfloat litAngleScale = 1.0 / max(0.001, cosInner - cosOuter);\nfloat litAngleOffset = -cosOuter * litAngleScale;\natt *= GetAngleAtt(SL, -light.cc_lightDir.xyz, litAngleScale, litAngleOffset);\n}\nvec3 lightColor = light.cc_lightColor.rgb;\nfloat shadow = 1.0;\n#if CC_RECEIVE_SHADOW\nif (light.cc_lightPos.w > 0.0) {\n{\nfloat pcf = cc_shadowWHPBInfo.z;\nif (pcf > 1.9) shadow = CCGetSpotLightShadowFactorSoft2X(shadowPos, position);\nelse if (pcf > 0.9) shadow = CCGetSpotLightShadowFactorSoft(shadowPos, position);\nelse shadow = CCGetSpotLightShadowFactorHard(shadowPos, position);\n}\n}\n#endif\nlightColor *= shadow;\nfinalColor += SNL * lightColor * light.cc_lightColor.w * illum * att * (diffuseContrib + lspec);\n}\nreturn vec4(finalColor, 0.0);\n}\n#endif\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nfloat LinearFog(vec4 pos) {\nvec4 wPos = pos;\nfloat cam_dis = distance(cc_cameraPos, wPos);\nfloat fogStart = cc_fogBase.x;\nfloat fogEnd = cc_fogBase.y;\nreturn clamp((fogEnd - cam_dis) / (fogEnd - fogStart), 0., 1.);\n}\nfloat ExpFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * fogDensity);\nreturn f;\n}\nfloat ExpSquaredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat fogStart = cc_fogBase.x;\nfloat fogDensity = cc_fogBase.z;\nfloat cam_dis = max(distance(cc_cameraPos, wPos) - fogStart, 0.0) / fogAtten * 4.;\nfloat f = exp(-cam_dis * cam_dis * fogDensity * fogDensity);\nreturn f;\n}\nfloat LayeredFog(vec4 pos) {\nvec4 wPos = pos;\nfloat fogAtten = cc_fogAdd.z;\nfloat _FogTop = cc_fogAdd.x;\nfloat _FogRange = cc_fogAdd.y;\nvec3 camWorldProj = cc_cameraPos.xyz;\ncamWorldProj.y = 0.;\nvec3 worldPosProj = wPos.xyz;\nworldPosProj.y = 0.;\nfloat fDeltaD = distance(worldPosProj, camWorldProj) / fogAtten * 2.0;\nfloat fDeltaY, fDensityIntegral;\nif (cc_cameraPos.y > _FogTop) {\nif (wPos.y < _FogTop) {\nfDeltaY = (_FogTop - wPos.y) / _FogRange * 2.0;\nfDensityIntegral = fDeltaY * fDeltaY * 0.5;\n} else {\nfDeltaY = 0.;\nfDensityIntegral = 0.;\n}\n} else {\nif (wPos.y < _FogTop) {\nfloat fDeltaA = (_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfloat fDeltaB = (_FogTop - wPos.y) / _FogRange * 2.;\nfDeltaY = abs(fDeltaA - fDeltaB);\nfDensityIntegral = abs((fDeltaA * fDeltaA * 0.5) - (fDeltaB * fDeltaB * 0.5));\n} else {\nfDeltaY = abs(_FogTop - cc_cameraPos.y) / _FogRange * 2.;\nfDensityIntegral = abs(fDeltaY * fDeltaY * 0.5);\n}\n}\nfloat fDensity;\nif (fDeltaY != 0.) {\nfDensity = (sqrt(1.0 + ((fDeltaD / fDeltaY) * (fDeltaD / fDeltaY)))) * fDensityIntegral;\n} else {\nfDensity = 0.;\n}\nfloat f = exp(-fDensity);\nreturn f;\n}\nvoid CC_TRANSFER_FOG_BASE(vec4 pos, out float factor)\n{\n#if CC_USE_FOG == 0\nfactor = LinearFog(pos);\n#elif CC_USE_FOG == 1\nfactor = ExpFog(pos);\n#elif CC_USE_FOG == 2\nfactor = ExpSquaredFog(pos);\n#elif CC_USE_FOG == 3\nfactor = LayeredFog(pos);\n#else\nfactor = 1.0;\n#endif\n}\nvoid CC_APPLY_FOG_BASE(inout vec4 color, float factor) {\ncolor = vec4(mix(cc_fogColor.rgb, color.rgb, factor), color.a);\n}\nvec2 signNotZero(vec2 v) {\nreturn vec2((v.x >= 0.0) ? +1.0 : -1.0, (v.y >= 0.0) ? +1.0 : -1.0);\n}\nvec3 oct_to_float32x3(vec2 e) {\nvec3 v = vec3(e.xy, 1.0 - abs(e.x) - abs(e.y));\nif (v.z < 0.0) v.xy = (1.0 - abs(v.yx)) * signNotZero(v.xy);\nreturn normalize(v);\n}\nvec4 screen2WS(vec3 coord) {\nvec3 ndc = vec3(\n2.0 * (coord.x - cc_viewPort.x) / cc_viewPort.z - 1.0,\n2.0 * (coord.y - cc_viewPort.y) / cc_viewPort.w - 1.0,\n2.0 * coord.z - 1.0);\nvec4 world = ((cc_matViewProjInv) * (vec4(ndc, 1.0)));\nworld      = world / world.w;\nreturn world;\n}\nin vec2 v_uv;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nlayout(location = 0) inout vec4 gbuffer_albedoMap;\nlayout(location = 1) inout vec4 gbuffer_normalMap;\nlayout(location = 2) inout vec4 gbuffer_emissiveMap;\n#else\nuniform sampler2D gbuffer_albedoMap;\nuniform sampler2D gbuffer_normalMap;\nuniform sampler2D gbuffer_emissiveMap;\n#endif\nuniform sampler2D depth_stencil;\n#if !CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT || __VERSION__ >= 450\nlayout(location = 0) out vec4 fragColor;\n#endif\nvoid main () {\nStandardSurface s;\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\nvec4 albedoMap = gbuffer_albedoMap;\nvec4 normalMap = gbuffer_normalMap;\nvec4 emissiveMap = gbuffer_emissiveMap;\n#else\nvec4 albedoMap = texture(gbuffer_albedoMap,v_uv);\nvec4 normalMap = texture(gbuffer_normalMap,v_uv);\nvec4 emissiveMap = texture(gbuffer_emissiveMap,v_uv);\n#endif\nfloat depth = texture(depth_stencil, v_uv).x;\ns.albedo = albedoMap;\nvec3 position = screen2WS(vec3(gl_FragCoord.xy, depth)).xyz;\ns.position = position;\ns.roughness = normalMap.z;\ns.normal = oct_to_float32x3(normalMap.xy);\ns.metallic = normalMap.w;\ns.emissive = emissiveMap.xyz;\ns.occlusion = emissiveMap.w;\nfloat fogFactor;\nCC_TRANSFER_FOG_BASE(vec4(position, 1), fogFactor);\nvec4 shadowPos;\nshadowPos = cc_matLightViewProj * vec4(position, 1);\nvec4 color = CCStandardShadingBase(s, shadowPos) +\n#if CC_ENABLE_CLUSTERED_LIGHT_CULLING == 1\nCCClusterShadingAdditive(s, shadowPos);\n#else\nCCStandardShadingAdditive(s, shadowPos);\n#endif\nCC_APPLY_FOG_BASE(color, fogFactor);\ncolor = CCFragOutput(color);\n#if CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT\ngbuffer_emissiveMap = color;\n#else\nfragColor = color;\n#endif\n}"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if USE_INSTANCING\nin vec4 a_matWorld0;\nin vec4 a_matWorld1;\nin vec4 a_matWorld2;\n#if USE_LIGHTMAP\nin vec4 a_lightingMapUVParam;\n#endif\n#elif USE_BATCHING\nin float a_dyn_batch_id;\nlayout(std140) uniform CCLocalBatched {\nhighp mat4 cc_matWorlds[10];\n};\n#else\nlayout(std140) uniform CCLocal {\nhighp mat4 cc_matWorld;\nhighp mat4 cc_matWorldIT;\nhighp vec4 cc_lightingMapUVParam;\n};\n#endif\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nout float v_dist;\nvec4 vert () {\nvec4 position;\nposition = vec4(a_position, 1.0);\n#if CC_USE_MORPH\napplyMorph(position);\n#endif\n#if CC_USE_SKINNING\nCCSkin(position);\n#endif\nmat4 matWorld;\n#if USE_INSTANCING\nmatWorld = mat4(\nvec4(a_matWorld0.xyz, 0.0),\nvec4(a_matWorld1.xyz, 0.0),\nvec4(a_matWorld2.xyz, 0.0),\nvec4(a_matWorld0.w, a_matWorld1.w, a_matWorld2.w, 1.0)\n);\n#elif USE_BATCHING\nmatWorld = cc_matWorlds[int(a_dyn_batch_id)];\n#else\nmatWorld = cc_matWorld;\n#endif\nvec3 P = (matWorld * position).xyz;\nvec3 L = cc_mainLitDir.xyz;\nvec3 N = cc_planarNDInfo.xyz;\nfloat d = cc_planarNDInfo.w + 0.001;\nfloat dist = (-d - dot(P, N)) / (dot(L, N) + 0.0001);\nvec3 shadowPos = P + L * dist;\nvec3 view = normalize(cc_cameraPos.xyz - shadowPos);\nfloat viewLength = length(cc_cameraPos.xyz - shadowPos);\nshadowPos += view * min(1.0, 0.005 * viewLength);\nposition = cc_matProj * cc_matView * vec4(shadowPos, 1.0);\nv_dist = dist;\nreturn position;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCShadow {\nhighp mat4 cc_matLightPlaneProj;\nhighp mat4 cc_matLightView;\nhighp mat4 cc_matLightViewProj;\nhighp vec4 cc_shadowInvProjDepthInfo;\nhighp vec4 cc_shadowProjDepthInfo;\nhighp vec4 cc_shadowProjInfo;\nmediump vec4 cc_shadowNFLSInfo;\nmediump vec4 cc_shadowWHPBInfo;\nmediump vec4 cc_shadowLPNNInfo;\nlowp vec4 cc_shadowColor;\nmediump vec4 cc_planarNDInfo;\n};\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin float v_dist;\nvec4 frag () {\nif(v_dist < 0.0)\ndiscard;\nreturn CCFragOutput(cc_shadowColor);\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision highp float;\nhighp float decode32 (highp vec4 rgba) {\nrgba = rgba * 255.0;\nhighp float Sign = 1.0 - (step(128.0, (rgba[3]) + 0.5)) * 2.0;\nhighp float Exponent = 2.0 * (mod(float(int((rgba[3]) + 0.5)), 128.0)) + (step(128.0, (rgba[2]) + 0.5)) - 127.0;\nhighp float Mantissa = (mod(float(int((rgba[2]) + 0.5)), 128.0)) * 65536.0 + rgba[1] * 256.0 + rgba[0] + 8388608.0;\nreturn Sign * exp2(Exponent - 23.0) * Mantissa;\n}\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\n#if CC_USE_MORPH\nin float a_vertexId;\nint getVertexId() {\nreturn int(a_vertexId);\n}\nlayout(std140) uniform CCMorph {\nvec4 cc_displacementWeights[15];\nvec4 cc_displacementTextureInfo;\n};\nvec2 getPixelLocation(vec2 textureResolution, int pixelIndex) {\nfloat pixelIndexF = float(pixelIndex);\nfloat x = mod(pixelIndexF, textureResolution.x);\nfloat y = floor(pixelIndexF / textureResolution.x);\nreturn vec2(x, y);\n}\nvec2 getPixelCoordFromLocation(vec2 location, vec2 textureResolution) {\nreturn (vec2(location.x, location.y) + .5) / textureResolution;\n}\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int pixelIndex) {\nivec2 texSize = textureSize(tex, 0);\nreturn texelFetch(tex, ivec2(pixelIndex % texSize.x, pixelIndex / texSize.x), 0);\n}\n#else\nvec4 fetchVec3ArrayFromTexture(sampler2D tex, int elementIndex) {\nint pixelIndex = elementIndex * 4;\nvec2 location = getPixelLocation(cc_displacementTextureInfo.xy, pixelIndex);\nvec2 x = getPixelCoordFromLocation(location + vec2(0.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 y = getPixelCoordFromLocation(location + vec2(1.0, 0.0), cc_displacementTextureInfo.xy);\nvec2 z = getPixelCoordFromLocation(location + vec2(2.0, 0.0), cc_displacementTextureInfo.xy);\nreturn vec4(\ndecode32(texture(tex, x)),\ndecode32(texture(tex, y)),\ndecode32(texture(tex, z)),\n1.0\n);\n}\n#endif\nfloat getDisplacementWeight(int index) {\nint quot = index / 4;\nint remainder = index - quot * 4;\nif (remainder == 0) {\nreturn cc_displacementWeights[quot].x;\n} else if (remainder == 1) {\nreturn cc_displacementWeights[quot].y;\n} else if (remainder == 2) {\nreturn cc_displacementWeights[quot].z;\n} else {\nreturn cc_displacementWeights[quot].w;\n}\n}\nvec3 getVec3DisplacementFromTexture(sampler2D tex, int vertexIndex) {\n#if CC_MORPH_PRECOMPUTED\nreturn fetchVec3ArrayFromTexture(tex, vertexIndex).rgb;\n#else\nvec3 result = vec3(0, 0, 0);\nint nVertices = int(cc_displacementTextureInfo.z);\nfor (int iTarget = 0; iTarget < CC_MORPH_TARGET_COUNT; ++iTarget) {\nresult += (fetchVec3ArrayFromTexture(tex, nVertices * iTarget + vertexIndex).rgb * getDisplacementWeight(iTarget));\n}\nreturn result;\n#endif\n}\n#if CC_MORPH_TARGET_HAS_POSITION\nuniform sampler2D cc_PositionDisplacements;\nvec3 getPositionDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_PositionDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nuniform sampler2D cc_NormalDisplacements;\nvec3 getNormalDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_NormalDisplacements, vertexId);\n}\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nuniform sampler2D cc_TangentDisplacements;\nvec3 getTangentDisplacement(int vertexId) {\nreturn getVec3DisplacementFromTexture(cc_TangentDisplacements, vertexId);\n}\n#endif\nvoid applyMorph (inout StandardVertInput attr) {\nint vertexId = getVertexId();\n#if CC_MORPH_TARGET_HAS_POSITION\nattr.position.xyz = attr.position.xyz + getPositionDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_NORMAL\nattr.normal.xyz = attr.normal.xyz + getNormalDisplacement(vertexId);\n#endif\n#if CC_MORPH_TARGET_HAS_TANGENT\nattr.tangent.xyz = attr.tangent.xyz + getTangentDisplacement(vertexId);\n#endif\n}\nvoid applyMorph (inout vec4 position) {\n#if CC_MORPH_TARGET_HAS_POSITION\nposition.xyz = position.xyz + getPositionDisplacement(getVertexId());\n#endif\n}\n#endif\n#if CC_USE_SKINNING\nin vec4 a_joints;\nin vec4 a_weights;\n#if CC_USE_BAKED_ANIMATION\n#if USE_INSTANCING\nin highp vec4 a_jointAnimInfo;\n#endif\nlayout(std140) uniform CCSkinningTexture {\nhighp vec4 cc_jointTextureInfo;\n};\nlayout(std140) uniform CCSkinningAnimation {\nhighp vec4 cc_jointAnimInfo;\n};\nuniform highp sampler2D cc_jointTexture;\n#else\nlayout(std140) uniform CCSkinning {\nhighp vec4 cc_joints[30 * 3];\n};\n#endif\n#if CC_USE_BAKED_ANIMATION\n#if CC_DEVICE_SUPPORT_FLOAT_TEXTURE\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 3.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 3.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = texture(cc_jointTexture, vec2((x + 0.5) * invSize, y));\nvec4 v2 = texture(cc_jointTexture, vec2((x + 1.5) * invSize, y));\nvec4 v3 = texture(cc_jointTexture, vec2((x + 2.5) * invSize, y));\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#else\nmat4 getJointMatrix (float i) {\n#if USE_INSTANCING\nhighp float j = 12.0 * (a_jointAnimInfo.x * a_jointAnimInfo.y + i) + a_jointAnimInfo.z;\n#else\nhighp float j = 12.0 * (cc_jointAnimInfo.x * cc_jointTextureInfo.y + i) + cc_jointTextureInfo.z;\n#endif\nhighp float invSize = cc_jointTextureInfo.w;\nhighp float y = floor(j * invSize);\nhighp float x = floor(j - y * cc_jointTextureInfo.x);\ny = (y + 0.5) * invSize;\nvec4 v1 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 0.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 1.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 2.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 3.5) * invSize, y)))\n);\nvec4 v2 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 4.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 5.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 6.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 7.5) * invSize, y)))\n);\nvec4 v3 = vec4(\ndecode32(texture(cc_jointTexture, vec2((x + 8.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 9.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 10.5) * invSize, y))),\ndecode32(texture(cc_jointTexture, vec2((x + 11.5) * invSize, y)))\n);\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\n#else\nmat4 getJointMatrix (float i) {\nint idx = int(i);\nvec4 v1 = cc_joints[idx * 3];\nvec4 v2 = cc_joints[idx * 3 + 1];\nvec4 v3 = cc_joints[idx * 3 + 2];\nreturn mat4(vec4(v1.xyz, 0.0), vec4(v2.xyz, 0.0), vec4(v3.xyz, 0.0), vec4(v1.w, v2.w, v3.w, 1.0));\n}\n#endif\nmat4 skinMatrix () {\nvec4 joints = vec4(a_joints);\nreturn getJointMatrix(joints.x) * a_weights.x\n+ getJointMatrix(joints.y) * a_weights.y\n+ getJointMatrix(joints.z) * a_weights.z\n+ getJointMatrix(joints.w) * a_weights.w;\n}\nvoid CCSkin (inout vec4 position) {\nmat4 m = skinMatrix();\nposition = m * position;\n}\nvoid CCSkin (inout StandardVertInput attr) {\nmat4 m = skinMatrix();\nattr.position = m * attr.position;\nattr.normal = (m * vec4(attr.normal, 0.0)).xyz;\nattr.tangent.xyz = (m * vec4(attr.tangent.xyz, 0.0)).xyz;\n}\n#endif\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nout vec2 v_uv;\nvoid main () {\nStandardVertInput In;\nIn.position = vec4(a_position, 1.0);\nIn.normal = a_normal;\nIn.tangent = a_tangent;\n#if CC_USE_MORPH\napplyMorph(In);\n#endif\n#if CC_USE_SKINNING\nCCSkin(In);\n#endif\nIn.position.xy = cc_cameraPos.w == 0.0 ? vec2(In.position.xy.x, -In.position.xy.y) : In.position.xy;\ngl_Position = In.position;\ngl_Position.y = gl_Position.y;\nv_uv = a_texCoord;\n}",frag:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\n#if ANTIALIAS_TYPE == 1\nvec4 fxaa(sampler2D tex, vec2 fragCoord, vec2 resolution,\nvec2 v_rgbNW, vec2 v_rgbNE,\nvec2 v_rgbSW, vec2 v_rgbSE,\nvec2 v_rgbM) {\nvec4 color;\nmediump vec2 inverseVP = vec2(1.0 / resolution.x, 1.0 / resolution.y);\nvec3 rgbNW = texture(tex, v_rgbNW).xyz;\nvec3 rgbNE = texture(tex, v_rgbNE).xyz;\nvec3 rgbSW = texture(tex, v_rgbSW).xyz;\nvec3 rgbSE = texture(tex, v_rgbSE).xyz;\nvec4 texColor = texture(tex, v_rgbM);\nvec3 rgbM  = texColor.xyz;\nvec3 luma = vec3(0.299, 0.587, 0.114);\nfloat lumaNW = dot(rgbNW, luma);\nfloat lumaNE = dot(rgbNE, luma);\nfloat lumaSW = dot(rgbSW, luma);\nfloat lumaSE = dot(rgbSE, luma);\nfloat lumaM  = dot(rgbM,  luma);\nfloat lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\nfloat lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\nmediump vec2 dir;\ndir.x = -((lumaNW + lumaNE) - (lumaSW + lumaSE));\ndir.y =  ((lumaNW + lumaSW) - (lumaNE + lumaSE));\nfloat dirReduce = max((lumaNW + lumaNE + lumaSW + lumaSE) *\n(0.25 * (1.0 / 8.0)), (1.0/ 128.0));\nfloat rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\ndir = min(vec2(8.0, 8.0),\nmax(vec2(-8.0, -8.0),\ndir * rcpDirMin)) * inverseVP;\nvec3 rgbA = 0.5 * (\ntexture(tex, fragCoord * inverseVP + dir * (1.0 / 3.0 - 0.5)).xyz +\ntexture(tex, fragCoord * inverseVP + dir * (2.0 / 3.0 - 0.5)).xyz);\nvec3 rgbB = rgbA * 0.5 + 0.25 * (\ntexture(tex, fragCoord * inverseVP + dir * -0.5).xyz +\ntexture(tex, fragCoord * inverseVP + dir * 0.5).xyz);\nfloat lumaB = dot(rgbB, luma);\nif ((lumaB < lumaMin) || (lumaB > lumaMax))\ncolor = vec4(rgbA, texColor.a);\nelse\ncolor = vec4(rgbB, texColor.a);\nreturn color;\n}\n#endif\nin vec2 v_uv;\nuniform sampler2D outputResultMap;\nlayout(location = 0) out vec4 fragColor;\nvoid texcoords(vec2 fragCoord, vec2 resolution,\nout vec2 v_rgbNW, out vec2 v_rgbNE,\nout vec2 v_rgbSW, out vec2 v_rgbSE,\nout vec2 v_rgbM) {\nvec2 inverseVP = 1.0 / resolution.xy;\nv_rgbNW = (fragCoord + vec2(-1.0, -1.0)) * inverseVP;\nv_rgbNE = (fragCoord + vec2(1.0, -1.0)) * inverseVP;\nv_rgbSW = (fragCoord + vec2(-1.0, 1.0)) * inverseVP;\nv_rgbSE = (fragCoord + vec2(1.0, 1.0)) * inverseVP;\nv_rgbM = vec2(fragCoord * inverseVP);\n}\nvoid main () {\nmediump vec2 v_rgbNW;\nmediump vec2 v_rgbNE;\nmediump vec2 v_rgbSW;\nmediump vec2 v_rgbSE;\nmediump vec2 v_rgbM;\n#if ANTIALIAS_TYPE == 1\nvec2 resolution = cc_screenSize.xy;\nvec2 fragCoord = v_uv * resolution;\ntexcoords(fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\nfragColor = fxaa(outputResultMap, fragCoord, resolution, v_rgbNW, v_rgbNE, v_rgbSW, v_rgbSE, v_rgbM);\n#else\nfragColor = texture(outputResultMap, v_uv);\n#endif\n}"}],[{vert:"\nprecision highp float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nstruct StandardVertInput {\nhighp vec4 position;\nvec3 normal;\nvec4 tangent;\n};\nin vec3 a_position;\nin vec3 a_normal;\nin vec2 a_texCoord;\nin vec4 a_tangent;\nout mediump vec4 viewDir;\nvec4 vert () {\nviewDir = vec4(a_position, 1.0);\nmat4 matViewRotOnly = mat4(mat3(cc_matView));\nvec4 pos = matViewRotOnly * viewDir;\nif (cc_matProj[3].w > 0.0) {\nmat4 matProj = cc_matProj;\nmatProj[0].x = 5.2;\nmatProj[1].y = 2.6;\nmatProj[2].zw = vec2(-1.0);\nmatProj[3].zw = vec2(0.0);\npos = matProj * pos;\n} else {\npos = cc_matProj * pos;\n}\npos.z = 0.99999 * pos.w;\nreturn pos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nuniform samplerCube cc_environment;\nvec3 unpackRGBE (vec4 rgbe) {\nreturn rgbe.rgb * pow(1.1, rgbe.a * 255.0 - 128.0);\n}\nvec3 SRGBToLinear (vec3 gamma) {\nreturn gamma * gamma;\n}\nvec3 ACESToneMap (vec3 color) {\ncolor = min(color, vec3(8.0));\nconst float A = 2.51;\nconst float B = 0.03;\nconst float C = 2.43;\nconst float D = 0.59;\nconst float E = 0.14;\nreturn (color * (A * color + B)) / (color * (C * color + D) + E);\n}\nvec4 CCFragOutput (vec4 color) {\n#if CC_USE_HDR\ncolor.rgb = ACESToneMap(color.rgb);\n#endif\ncolor.rgb = sqrt(color.rgb);\nreturn color;\n}\nin mediump vec4 viewDir;\nvec4 frag () {\n#if USE_RGBE_CUBEMAP\nvec3 c = unpackRGBE(texture(cc_environment, viewDir.xyz));\n#else\nvec3 c = SRGBToLinear(texture(cc_environment, viewDir.xyz).rgb);\n#endif\nreturn CCFragOutput(vec4(c * cc_ambientSky.w, 1.0));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nin vec3 a_position;\nin vec4 a_color;\nout vec2 v_uv;\nlayout(std140) uniform Constants {\nvec4 offset;\n};\nlayout(std140) uniform PerFrameInfo {\nvec4 digits[8 * 10 / 4];\n};\nfloat getComponent(vec4 v, float i) {\nif (i < 1.0) { return v.x; }\nelse if (i < 2.0) { return v.y; }\nelse if (i < 3.0) { return v.z; }\nelse { return v.w; }\n}\nvec4 vert () {\nmat2 proj = mat2(cc_matProj[0].xy, cc_matProj[1].xy);\nproj /= abs(proj[1].x + proj[1].y);\nvec2 position = proj * a_position.xy + offset.xy;\nv_uv = a_color.xy;\nif (a_color.z >= 0.0) {\nfloat n = getComponent(digits[int(a_color.z)], a_color.w);\nv_uv += vec2(offset.z * n, 0.0);\n}\nreturn vec4(position, 0.0, 1.0);\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nlayout(std140) uniform CCGlobal {\nhighp   vec4 cc_time;\nmediump vec4 cc_screenSize;\nmediump vec4 cc_nativeSize;\n};\nlayout(std140) uniform CCCamera {\nhighp   mat4 cc_matView;\nhighp   mat4 cc_matViewInv;\nhighp   mat4 cc_matProj;\nhighp   mat4 cc_matProjInv;\nhighp   mat4 cc_matViewProj;\nhighp   mat4 cc_matViewProjInv;\nhighp   vec4 cc_cameraPos;\nmediump vec4 cc_screenScale;\nmediump vec4 cc_exposure;\nmediump vec4 cc_mainLitDir;\nmediump vec4 cc_mainLitColor;\nmediump vec4 cc_ambientSky;\nmediump vec4 cc_ambientGround;\nmediump vec4 cc_fogColor;\nmediump vec4 cc_fogBase;\nmediump vec4 cc_fogAdd;\nmediump vec4 cc_nearFar;\nmediump vec4 cc_viewPort;\n};\nvec4 CCFragOutput (vec4 color) {\nreturn color;\n}\nin vec2 v_uv;\nuniform sampler2D mainTexture;\nvec4 frag () {\nreturn CCFragOutput(texture(mainTexture, v_uv));\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}],[{vert:"\nprecision mediump float;\nin vec2 a_position;\nin vec2 a_texCoord;\nout vec2 v_uv;\nlayout(std140) uniform Constant {\nvec4 u_buffer0;\nvec4 u_buffer1;\nmat4 u_projection;\n};\nvec4 vert () {\nvec2 worldPos = a_position * u_buffer1.xy + u_buffer1.zw;\nvec2 clipSpace = worldPos / u_buffer0.xy * 2.0 - 1.0;\nvec4 screenPos = u_projection * vec4(clipSpace, 0.0, 1.0);\nv_uv = a_texCoord;\nreturn screenPos;\n}\nvoid main() { gl_Position = vert(); }",frag:"\nprecision mediump float;\nin vec2 v_uv;\nlayout(std140) uniform Factor {\nfloat u_percent;\n};\nuniform sampler2D mainTexture;\nvec4 frag () {\nvec4 color = texture(mainTexture, v_uv);\nfloat percent = clamp(u_percent, 0.0, 1.0);\ncolor.xyz *= percent;\nreturn color;\n}\nlayout(location = 0) out vec4 cc_FragColor;\nvoid main() { cc_FragColor = frag(); }"}]]},Mv=function(){function e(){this._device=null,this._resources={}}var t=e.prototype;return t.initBuiltinRes=function(e){var t=this;this._device=e;for(var n=this._resources,i=new Uint8Array(16),r=new Uint8Array(16),o=new Uint8Array(16),a=new Uint8Array(16),s=new Uint8Array(16),c=0,l=0;l<4;l++)i[c]=0,i[c+1]=0,i[c+2]=0,i[c+3]=255,r[c]=0,r[c+1]=0,r[c+2]=0,r[c+3]=0,o[c]=119,o[c+1]=119,o[c+2]=119,o[c+3]=255,a[c]=255,a[c+1]=255,a[c+2]=255,a[c+3]=255,s[c]=127,s[c+1]=127,s[c+2]=255,s[c+3]=255,c+=4;var h=new Uint8Array(1024);c=0;for(var f=0;f<256;f++)h[c]=221,h[c+1]=221,h[c+2]=221,h[c+3]=255,c+=4;c=0;for(var _=0;_<8;_++){for(var p=0;p<8;p++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}c+=32;for(var d=0;d<8;d++){for(var m=0;m<8;m++)h[c]=85,h[c+1]=85,h[c+2]=85,h[c+3]=255,c+=4;c+=32}var v={width:2,height:2,_data:i,_compressed:!1,format:Cv.PixelFormat.RGBA8888},g={width:2,height:2,_data:r,_compressed:!1,format:Cv.PixelFormat.RGBA8888},y={width:2,height:2,_data:o,_compressed:!1,format:Cv.PixelFormat.RGBA8888},x={width:2,height:2,_data:a,_compressed:!1,format:Cv.PixelFormat.RGBA8888},S={width:2,height:2,_data:s,_compressed:!1,format:Cv.PixelFormat.RGBA8888},T={width:16,height:16,_data:h,_compressed:!1,format:Cv.PixelFormat.RGBA8888},b=new nv(v),E=new Cv;E._uuid="black-texture",E.image=b,n[E._uuid]=E;var C=new nv(g),A=new Cv;A._uuid="empty-texture",A.image=C,n[A._uuid]=A;var w=new Av;w._uuid="black-cube-texture",w.setMipFilter(Av.Filter.NEAREST),w.image={front:new nv(v),back:new nv(v),left:new nv(v),right:new nv(v),top:new nv(v),bottom:new nv(v)},n[w._uuid]=w;var P=new nv(y),R=new Cv;R._uuid="grey-texture",R.image=P,n[R._uuid]=R;var I=new nv(x),D=new Cv;D._uuid="white-texture",D.image=I,n[D._uuid]=D;var O=new Av;O._uuid="white-cube-texture",O.setMipFilter(Av.Filter.NEAREST),O.image={front:new nv(x),back:new nv(x),left:new nv(x),right:new nv(x),top:new nv(x),bottom:new nv(x)},n[O._uuid]=O;var M=new nv(S),N=new Cv;N._uuid="normal-texture",N.image=M,n[N._uuid]=N;var L=new nv(T),B=new Cv;B._uuid="default-texture",B.image=L,n[B._uuid]=B;var F=new Av;if(F.setMipFilter(Av.Filter.NEAREST),F._uuid="default-cube-texture",F.image={front:new nv(T),back:new nv(T),left:new nv(T),right:new nv(T),top:new nv(T),bottom:new nv(T)},n[F._uuid]=F,u.SpriteFrame){var z=new u.SpriteFrame,U=b,k=new Cv;k.image=U,z.texture=k,z._uuid="default-spriteframe",n[z._uuid]=z}var G=Tm(e);if(!G)return Promise.reject(Error("Failed to initialize builtin shaders: unknown device."));var H=Ov[G];return H?Promise.resolve().then((function(){Dv.forEach((function(e,t){var n=Object.assign(new u.EffectAsset,e);n.shaders.forEach((function(e,n){var i=H[t][n];i&&(e[G]=i)})),n.hideInEditor=!0,n.onLoaded()})),t._initMaterials()})):Promise.reject(Error("Current device is requiring builtin shaders of version "+G+" but shaders of that version are not assembled in this build."))},t.get=function(e){return this._resources[e]},t._initMaterials=function(){var e=this._resources,t=[],n=new u.Material;n._uuid="standard-material",n.initialize({effectName:"standard"}),e[n._uuid]=n,t.push(n);var i=new u.Material;i._uuid="missing-effect-material",i.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),i.setProperty("mainColor",u.color("#ffff00")),e[i._uuid]=i,t.push(i);var r=new u.Material;r._uuid="missing-material",r.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),r.setProperty("mainColor",u.color("#ff00ff")),e[r._uuid]=r,t.push(r);var o=new u.Material;o._uuid="default-clear-stencil",o.initialize({defines:{USE_TEXTURE:!1},effectName:"clear-stencil"}),e[o._uuid]=o,t.push(o);var a=new u.Material;a._uuid="ui-base-material",a.initialize({defines:{USE_TEXTURE:!1},effectName:"sprite"}),e[a._uuid]=a,t.push(a);var s=new u.Material;s._uuid="ui-sprite-material",s.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[s._uuid]=s,t.push(s);var c=new u.Material;c._uuid="ui-alpha-test-material",c.initialize({defines:{USE_TEXTURE:!0,USE_ALPHA_TEST:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"sprite"}),e[c._uuid]=c,t.push(c);var l=new u.Material;l._uuid="ui-sprite-gray-material",l.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!0},effectName:"sprite"}),e[l._uuid]=l,t.push(l);var h=new u.Material;h._uuid="ui-sprite-alpha-sep-material",h.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!1},effectName:"sprite"}),e[h._uuid]=h,t.push(h);var f=new u.Material;f._uuid="ui-sprite-gray-alpha-sep-material",f.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!0,IS_GRAY:!0},effectName:"sprite"}),e[f._uuid]=f,t.push(f);var _=new u.Material;_._uuid="ui-graphics-material",_.initialize({effectName:"graphics"}),e[_._uuid]=_,t.push(_);var p=new u.Material;p._uuid="default-particle-material",p.initialize({effectName:"particle"}),e[p._uuid]=p,t.push(p);var d=new u.Material;d._uuid="default-particle-gpu-material",d.initialize({effectName:"particle-gpu"}),e[d._uuid]=d,t.push(d);var m=new u.Material;m._uuid="default-trail-material",m.initialize({effectName:"particle-trail"}),e[m._uuid]=m,t.push(m);var v=new u.Material;v._uuid="default-billboard-material",v.initialize({effectName:"billboard"}),e[v._uuid]=v,t.push(v);var g=new u.Material;g._uuid="default-spine-material",g.initialize({defines:{USE_TEXTURE:!0,CC_USE_EMBEDDED_ALPHA:!1,IS_GRAY:!1},effectName:"spine"}),e[g._uuid]=g,t.push(g),u.game.on(u.Game.EVENT_GAME_INITED,(function(){for(var e=0;e<t.length;++e)for(var n=t[e],i=0;i<n.passes.length;++i)n.passes[i].tryCompile()}))},e}(),Nv=e("builtinResMgr",u.builtinResMgr=new Mv),Lv=e("getPhaseID",(Pv=new Map,Rv=0,function(e){return"number"==typeof e?e:(Pv.has(e)||(Pv.set(e,1<<Rv),Rv++),Pv.get(e))})),Bv=e("InstancedBuffer",function(){function e(e){this.instances=[],this.pass=void 0,this.hasPendingModels=!1,this.dynamicOffsets=[],this._device=void 0,this._device=e.device,this.pass=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.instances.length;++e){var t=this.instances[e];t.vb.destroy(),t.ia.destroy()}this.instances.length=0},t.merge=function(e,t,n,i){void 0===i&&(i=null);var r=t.buffer.length;if(r){var o=e.inputAssembler,a=e.descriptorSet.getTexture(zd),s=i;s||(s=e.shaders[n]);for(var c=e.descriptorSet,l=0;l<this.instances.length;++l){var u=this.instances[l];if(!(u.ia.indexBuffer!==o.indexBuffer||u.count>=1024)&&u.lightingMap===a&&u.stride===r){if(u.count>=u.capacity){u.capacity<<=1;var h=u.stride*u.capacity,f=u.data;u.data=new Uint8Array(h),u.data.set(f),u.vb.resize(h)}return u.shader!==s&&(u.shader=s),u.descriptorSet!==c&&(u.descriptorSet=c),u.data.set(t.buffer,u.stride*u.count++),void(this.hasPendingModels=!0)}}for(var _=this._device.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,32*r,r)),p=new Uint8Array(32*r),d=o.vertexBuffers.slice(),m=o.attributes.slice(),v=o.indexBuffer,g=0;g<t.attributes.length;g++){var y=t.attributes[g],x=new Ir(y.name,y.format,y.isNormalized,d.length,!0);m.push(x)}p.set(t.buffer),d.push(_);var S=new Or(m,d,v),T=this._device.createInputAssembler(S);this.instances.push({count:1,capacity:32,vb:_,data:p,ia:T,stride:r,shader:s,descriptorSet:c,lightingMap:a}),this.hasPendingModels=!0}},t.uploadBuffers=function(e){for(var t=0;t<this.instances.length;++t){var n=this.instances[t];n.count&&(n.ia.instanceCount=n.count,e.updateBuffer(n.vb,n.data))}},t.clear=function(){for(var e=0;e<this.instances.length;++e)this.instances[e].count=0;this.hasPendingModels=!1},e}()),Fv=function(){function e(e){this.batches=[],this.dynamicOffsets=[],this._device=void 0,this._device=e.device}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this.batches.length;++e){for(var t=this.batches[e],n=0;n<t.vbs.length;++n)t.vbs[n].destroy();t.vbIdx.destroy(),t.ia.destroy(),t.ubo.destroy()}this.batches.length=0},t.merge=function(e,t,n){var i=e.subMesh.flatBuffers;if(0!==i.length){for(var r=0,o=0,a=i[0].count,s=e.passes[t],c=e.shaders[t],l=e.descriptorSet,u=!1,h=0;h<this.batches.length;++h){var f=this.batches[h];if(f.vbs.length===i.length&&f.mergeCount<vd.BATCHING_COUNT){u=!0;for(var _=0;_<f.vbs.length;++_)if(f.vbs[_].stride!==i[_].stride){u=!1;break}if(u){for(var p=0;p<f.vbs.length;++p){var d=i[p],m=f.vbs[p],v=f.vbDatas[p];(r=(a+f.vbCount)*d.stride)>m.size&&(m.resize(r),f.vbDatas[p]=new Uint8Array(r),f.vbDatas[p].set(v)),f.vbDatas[p].set(d.buffer,f.vbCount*d.stride)}var g=f.vbIdxData;(o=4*(a+f.vbCount))>f.vbIdx.size&&(f.vbIdx.resize(o),f.vbIdxData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT),f.vbIdxData.set(g),g=f.vbIdxData);var y=f.vbCount,x=y+a,S=f.mergeCount;if(g[y]!==S||g[x-1]!==S)for(var T=y;T<x;T++)g[T]=S+.1;return jn.toArray(f.uboData,n.transform.worldMatrix,vd.MAT_WORLDS_OFFSET+16*f.mergeCount),f.mergeCount||(l.bindBuffer(vd.BINDING,f.ubo),l.update(),f.pass=s,f.shader=c,f.descriptorSet=l),++f.mergeCount,f.vbCount+=a,void(f.ia.vertexCount+=a)}}}for(var b=[],E=[],C=[],A=0;A<i.length;++A){var w=i[A],P=this._device.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,w.count*w.stride,w.stride));P.update(w.buffer.buffer),b.push(P),E.push(new Uint8Array(P.size)),C.push(P)}var R=this._device.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,4*a,4)),I=new Float32Array(a);I.fill(0),R.update(I),C.push(R);for(var D=e.inputAssembler.attributes,O=new Array(D.length+1),M=0;M<D.length;++M)O[M]=D[M];O[D.length]=new Ir("a_dyn_batch_id",pi.R32F,!1,i.length);var N=new Or(O,C),L=this._device.createInputAssembler(N),B=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,vd.SIZE,vd.SIZE));l.bindBuffer(vd.BINDING,B),l.update();var F=new Float32Array(vd.COUNT);jn.toArray(F,n.transform.worldMatrix,vd.MAT_WORLDS_OFFSET),this.batches.push({mergeCount:1,vbs:b,vbDatas:E,vbIdx:R,vbIdxData:I,vbCount:a,ia:L,ubo:B,uboData:F,pass:s,shader:c,descriptorSet:l})}},t.clear=function(){for(var e=0;e<this.batches.length;++e){var t=this.batches[e];t.vbCount=0,t.mergeCount=0,t.ia.vertexCount=0}},e}(),zv=new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.DEVICE),Uv=new pr(null),kv=new Vr(null);!function(e){e[e.NONE=0]="NONE",e[e.INSTANCING=1]="INSTANCING",e[e.VB_MERGING=2]="VB_MERGING"}(Iv||(Iv={}));var Gv=function(){function e(e){this._rootBuffer=null,this._buffers=[],this._descriptorSet=null,this._pipelineLayout=null,this._passIndex=0,this._propertyIndex=0,this._programName="",this._dynamics={},this._propertyHandleMap={},this._rootBlock=null,this._blocksInt=[],this._blocks=[],this._shaderInfo=null,this._defines={},this._properties={},this._shader=null,this._bs=new Po,this._dss=new Ao,this._rs=new Co,this._priority=Up.DEFAULT,this._stage=zp.DEFAULT,this._phase=Lv("default"),this._primitive=Ui.TRIANGLE_LIST,this._batchingScheme=Iv.NONE,this._dynamicStates=Vi.NONE,this._instancedBuffers={},this._batchedBuffers={},this._hash=0,this._root=void 0,this._device=void 0,this._passHandle=0,this._rootBufferDirty=!1,this._root=e,this._device=e.device}e.fillPipelineInfo=function(e,t){void 0!==t.priority&&e._setPriority(t.priority),void 0!==t.primitive&&e._setPrimitive(t.primitive),void 0!==t.stage&&e._setStage(t.stage),void 0!==t.dynamicStates&&e._setDynamicState(t.dynamicStates),void 0!==t.phase&&e._setPhase(Lv(t.phase));var n=e._bs;if(t.blendState){var i=t.blendState,r=i.targets;r&&r.forEach((function(e,t){n.setTarget(t,e)})),void 0!==i.isA2C&&(n.isA2C=i.isA2C),void 0!==i.isIndepend&&(n.isIndepend=i.isIndepend),void 0!==i.blendColor&&(n.blendColor=i.blendColor)}e._rs.assign(t.rasterizerState),e._dss.assign(t.depthStencilState)},e.getPassHash=function(e){var t,n=Dm.getKey(e.program,e.defines)+","+e._primitive+","+e._dynamicStates;return n+=function(e){for(var t,n=",bs,"+e.isA2C,i=se(e.targets);!(t=i()).done;){var r=t.value;n+=",bt,"+r.blend+","+r.blendEq+","+r.blendAlphaEq+","+r.blendColorMask,n+=","+r.blendSrc+","+r.blendDst+","+r.blendSrcAlpha+","+r.blendDstAlpha}return n}(e._bs),n+=function(e){var t=",dss,"+e.depthTest+","+e.depthWrite+","+e.depthFunc;return t+=","+e.stencilTestFront+","+e.stencilFuncFront+","+e.stencilRefFront+","+e.stencilReadMaskFront,t+=","+e.stencilFailOpFront+","+e.stencilZFailOpFront+","+e.stencilPassOpFront+","+e.stencilWriteMaskFront,(t+=","+e.stencilTestBack+","+e.stencilFuncBack+","+e.stencilRefBack+","+e.stencilReadMaskBack)+","+e.stencilFailOpBack+","+e.stencilZFailOpBack+","+e.stencilPassOpBack+","+e.stencilWriteMaskBack}(e._dss),xo(n+=",rs,"+(t=e._rs).cullMode+","+t.depthBias+","+t.isFrontFaceCCW,666)};var t=e.prototype;return t.initialize=function(e){this._doInit(e),this.resetUBOs(),this.resetTextures(),this.tryCompile()},t.getHandle=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=mi.UNKNOWN);var i=this._propertyHandleMap[e];return i?(n?i=um(i,n):t&&(i=um(i,am(i)-t)),i+t):0},t.getBinding=function(t){var n=this.getHandle(t);return n?e.getBindingFromHandle(n):-1},t.setUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);fm[r](a,n,o),this._setRootBufferDirty(!0)},t.getUniform=function(t,n){var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=e.getOffsetFromHandle(t),a=this._getBlockView(r,i);return hm[r](a,n,o)},t.setUniformArray=function(t,n){for(var i=e.getBindingFromHandle(t),r=e.getTypeFromHandle(t),o=lo(r)>>2,a=this._getBlockView(r,i),s=e.getOffsetFromHandle(t),c=0;c<n.length;c++,s+=o)null!==n[c]&&fm[r](a,n[c],s);this._setRootBufferDirty(!0)},t.bindTexture=function(e,t,n){this._descriptorSet.bindTexture(e,t,n||0)},t.bindSampler=function(e,t,n){this._descriptorSet.bindSampler(e,t,n||0)},t.setDynamicState=function(e,t){var n=this._dynamics[e];n&&n.value===t||(n.value=t,n.dirty=!0)},t.overridePipelineStates=function(){console.warn("base pass cannot override states, please use pass instance instead.")},t._setRootBufferDirty=function(e){this._rootBufferDirty=e},t.update=function(){this._descriptorSet?(this._rootBuffer&&this._rootBufferDirty&&(this._rootBuffer.update(this._rootBlock),this._setRootBufferDirty(!1)),this._descriptorSet.update()):M(12006)},t.getInstancedBuffer=function(e){return void 0===e&&(e=0),this._instancedBuffers[e]||(this._instancedBuffers[e]=new Bv(this))},t.getBatchedBuffer=function(e){return void 0===e&&(e=0),this._batchedBuffers[e]||(this._batchedBuffers[e]=new Fv(this))},t._initNative=function(){},t._destroy=function(){},t.destroy=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++){var t=this._shaderInfo.blocks[e];this._buffers[t.binding].destroy()}for(var n in this._buffers=[],this._rootBuffer&&(this._rootBuffer.destroy(),this._rootBuffer=null),this._instancedBuffers)this._instancedBuffers[n].destroy();for(var i in this._batchedBuffers)this._batchedBuffers[i].destroy();this._descriptorSet.destroy(),this._rs.destroy(),this._dss.destroy(),this._bs.destroy(),this._destroy()},t.resetUniform=function(t){var n=this.getHandle(t);if(n){for(var i=e.getTypeFromHandle(n),r=e.getBindingFromHandle(n),o=e.getOffsetFromHandle(n),a=e.getCountFromHandle(n),s=this._getBlockView(i,r),c=this._properties[t],l=c&&c.value||pm(i),u=(lo(i)>>2)*a,h=0;h+l.length<=u;h+=l.length)s.set(l,o+h);this._setRootBufferDirty(!0)}},t.resetTexture=function(t,n){var i=this.getHandle(t);if(i){var r=e.getTypeFromHandle(i),o=e.getBindingFromHandle(i),a=this._properties[t],s=a&&a.value,c=s?s+"-texture":pm(r),l=Nv.get(c),u=l&&l.getGFXTexture(),h=a&&void 0!==a.samplerHash?Mo.unpackFromHash(a.samplerHash):l&&l.getSamplerInfo(),f=this._device.getSampler(h);this._descriptorSet.bindSampler(o,f,n),this._descriptorSet.bindTexture(o,u,n)}},t.resetUBOs=function(){for(var e=0;e<this._shaderInfo.blocks.length;e++)for(var t=this._shaderInfo.blocks[e],n=0,i=0;i<t.members.length;i++){for(var r=t.members[i],o=this._getBlockView(r.type,t.binding),a=this._properties[r.name],s=a&&a.value||pm(r.type),c=(lo(r.type)>>2)*r.count,l=0;l+s.length<=c;l+=s.length)o.set(s,n+l);n+=c}this._setRootBufferDirty(!0)},t.resetTextures=function(){for(var e=0;e<this._shaderInfo.samplerTextures.length;e++)for(var t=this._shaderInfo.samplerTextures[e],n=0;n<t.count;n++)this.resetTexture(t.name,n)},t.tryCompile=function(){var t=this._root.pipeline;if(!t)return!1;this._syncBatchingScheme();var n=Dm.getGFXShader(this._device,this._programName,this._defines,t);return n?(this._shader=n,this._setPipelineLayout(Dm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e.getPassHash(this)),!0):(console.warn("create shader "+this._programName+" failed"),!1)},t.getShaderVariant=function(e){if(void 0===e&&(e=null),!this._shader&&!this.tryCompile())return console.warn("pass resources incomplete"),null;if(!e)return this._shader;for(var t=this._root.pipeline,n=0;n<e.length;n++){var i=e[n];this._defines[i.name]=i.value}for(var r=Dm.getGFXShader(this._device,this._programName,this._defines,t),o=0;o<e.length;o++){var a=e[o];delete this._defines[a.name]}return r},t.beginChangeStatesSilently=function(){},t.endChangeStatesSilently=function(){},t._setPriority=function(e){this._priority=e},t._setStage=function(e){this._stage=e},t._setPhase=function(e){this._phase=e},t._setPrimitive=function(e){this._primitive=e},t._setState=function(e,t,n,i){this._bs=e,this._dss=t,this._rs=n,this._descriptorSet=i},t._doInit=function(t,n){void 0===n&&(n=!1),this._initNative(),this._setPriority(Up.DEFAULT),this._setStage(zp.DEFAULT),this._setPhase(Lv("default")),this._setPrimitive(Ui.TRIANGLE_LIST),this._passIndex=t.passIndex,this._propertyIndex=void 0!==t.propertyIndex?t.propertyIndex:t.passIndex,this._programName=t.program,this._defines=n?J({},t.defines):t.defines,this._shaderInfo=Dm.getTemplate(t.program),this._properties=t.properties||this._properties;var i=this._device;e.fillPipelineInfo(this,t),t.stateOverrides&&e.fillPipelineInfo(this,t.stateOverrides),kv.layout=Dm.getDescriptorSetLayout(this._device,t.program),this._descriptorSet=this._device.createDescriptorSet(kv),this._setState(this._bs,this._dss,this._rs,this._descriptorSet);for(var r=this._shaderInfo.blocks,o=Dm.getTemplateInfo(t.program),a=o.blockSizes,s=o.handleMap,c=i.capabilities.uboOffsetAlignment,l=[],u=0,h=0,f=0;f<r.length;f++){var _=a[f];l.push(h),h+=Math.ceil(_/c)*c,u=_}var p=l[l.length-1]+u;p&&(zv.size=16*Math.ceil(p/16),this._rootBuffer=i.createBuffer(zv),this._rootBlock=new ArrayBuffer(p));for(var d=0,m=0;d<r.length;d++){var v=r[d].binding,g=a[d];Uv.buffer=this._rootBuffer,Uv.offset=l[m++],Uv.range=16*Math.ceil(g/16);var y=this._buffers[v]=i.createBuffer(Uv);this._blocks[v]=new Float32Array(this._rootBlock,Uv.offset,g/Float32Array.BYTES_PER_ELEMENT),this._blocksInt[v]=new Int32Array(this._blocks[v].buffer,this._blocks[v].byteOffset,this._blocks[v].length),this._descriptorSet.bindBuffer(v,y)}var x=this._propertyHandleMap=s,S={};for(var T in this._properties){var b=this._properties[T];b.handleInfo&&(S[T]=this.getHandle.apply(this,b.handleInfo))}Object.assign(x,S)},t._syncBatchingScheme=function(){this._defines.USE_INSTANCING?this._device.hasFeature(_i.INSTANCED_ARRAYS)?this._setBatchingScheme(Iv.INSTANCING):(this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Iv.NONE)):this._defines.USE_BATCHING?this._setBatchingScheme(Iv.VB_MERGING):this._setBatchingScheme(Iv.NONE)},t._setBatchingScheme=function(e){this._batchingScheme=e},t._setDynamicState=function(e){this._dynamicStates=e},t._setHash=function(e){this._hash=e},t._getBlockView=function(e,t){return e<mi.FLOAT?this._blocksInt[t]:this._blocks[t]},t._setPipelineLayout=function(e){this._pipelineLayout=e},t._initPassFromTarget=function(e,t,n,i){this._initNative(),this._setPriority(e.priority),this._setStage(e.stage),this._setPhase(e.phase),this._setBatchingScheme(e.batchingScheme),this._setPrimitive(e.primitive),this._setDynamicState(e.dynamicStates),this._setState(n,t,e.rasterizerState,e.descriptorSet),this._passIndex=e.passIndex,this._propertyIndex=e.propertyIndex,this._programName=e.program,this._defines=e.defines,this._shaderInfo=e._shaderInfo,this._properties=e._properties,this._blocks=e._blocks,this._blocksInt=e._blocksInt,this._dynamics=e._dynamics,this._shader=e._shader,this._setPipelineLayout(Dm.getTemplateInfo(this._programName).pipelineLayout),this._setHash(e._hash^i)},Z(e,[{key:"native",get:function(){return this._nativeObj}},{key:"root",get:function(){return this._root}},{key:"device",get:function(){return this._device}},{key:"shaderInfo",get:function(){return this._shaderInfo}},{key:"localSetLayout",get:function(){return Dm.getDescriptorSetLayout(this._device,this._programName,!0)}},{key:"program",get:function(){return this._programName}},{key:"properties",get:function(){return this._properties}},{key:"defines",get:function(){return this._defines}},{key:"passIndex",get:function(){return this._passIndex}},{key:"propertyIndex",get:function(){return this._propertyIndex}},{key:"dynamics",get:function(){return this._dynamics}},{key:"blocks",get:function(){return this._blocks}},{key:"blocksInt",get:function(){return this._blocksInt}},{key:"rootBufferDirty",get:function(){return this._rootBufferDirty}},{key:"priority",get:function(){return this._priority}},{key:"primitive",get:function(){return this._primitive}},{key:"stage",get:function(){return this._stage}},{key:"phase",get:function(){return this._phase}},{key:"rasterizerState",get:function(){return this._rs}},{key:"depthStencilState",get:function(){return this._dss}},{key:"blendState",get:function(){return this._bs}},{key:"dynamicStates",get:function(){return this._dynamicStates}},{key:"batchingScheme",get:function(){return this._batchingScheme}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"hash",get:function(){return this._hash}},{key:"pipelineLayout",get:function(){return this._pipelineLayout}}]),e}();Gv.getTypeFromHandle=am,Gv.getBindingFromHandle=sm,Gv.getCountFromHandle=cm,Gv.getOffsetFromHandle=lm;var Hv=e("PipelineStateManager",function(){function e(){}return e.getOrCreatePipelineState=function(e,t,n,i,r){var o=t.hash^i.hash^r.attributesHash^n.typedID,a=this._PSOHashMap.get(o);if(!a){var s=t.pipelineLayout,c=new jr(r.attributes),l=new Ro(n,s,i,c,t.rasterizerState,t.depthStencilState,t.blendState,t.primitive,t.dynamicStates);a=e.createPipelineState(l),this._PSOHashMap.set(o,a)}return a},e}());Hv._PSOHashMap=new Map;var Vv=new cr,Wv=new tr;function jv(e,t){e.x=t.x*t.x,e.y=t.y*t.y,e.z=t.z*t.z}var qv,Xv,Yv,Kv,Qv,Zv,Jv,$v,eg,tg,ng=null;function ig(e,t,n,i,r){if(i&&i.enabled&&r===ng){var o=i.subModels[0],a=o.inputAssembler,s=o.passes,c=o.shaders,l=o.descriptorSet;Vv.width=Wv.width=r.window.width,Vv.height=Wv.height=r.window.height;var u=Hv.getOrCreatePipelineState(e,s[0],c[0],t,a);n.setViewport(Vv),n.setScissor(Wv),n.bindPipelineState(u),n.bindDescriptorSet(Kp.MATERIAL,s[0].descriptorSet),n.bindDescriptorSet(Kp.LOCAL,l),n.bindInputAssembler(a),n.draw(a)}}var rg,og,ag,sg,cg,lg=new $n,ug=e("Material",(qv=mc("cc.Material"),Xv=Zc(Om),qv((tg=function(e){function t(){var t;return ce(t=e.call(this)||this,"_effectAsset",Qv,oe(t)),ce(t,"_techIdx",Zv,oe(t)),ce(t,"_defines",Jv,oe(t)),ce(t,"_states",$v,oe(t)),ce(t,"_props",eg,oe(t)),t._passes=[],t._hash=0,t}$(t,e),t.getHash=function(e){for(var t,n=0,i=se(e.passes);!(t=i()).done;)n^=t.value.hash;return n};var n=t.prototype;return n.initialize=function(e){this._passes.length?D(12005):(this._defines||(this._defines=[]),this._states||(this._states=[]),this._props||(this._props=[]),this._fillInfo(e),this._update())},n.reset=function(e){this.initialize(e)},n.destroy=function(){return this._doDestroy(),e.prototype.destroy.call(this)},n.recompileShaders=function(){console.warn("Shaders in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.overridePipelineStates=function(){console.warn("Pipeline states in material asset '"+this.name+"' cannot be modified at runtime, please instantiate the material first.")},n.onLoaded=function(){this._update()},n.resetUniforms=function(e){void 0===e&&(e=!0),this._props.length=this._passes.length;for(var t=0;t<this._props.length;t++)this._props[t]={};if(e)for(var n,i=se(this._passes);!(n=i()).done;){var r=n.value;r.resetUBOs(),r.resetTextures()}},n.setProperty=function(e,t,n){var i=!1;if(void 0===n)for(var r=this._passes,o=r.length,a=0;a<o;a++){var s=r[a];this._uploadProperty(s,e,t)&&(this._props[s.propertyIndex][e]=t,i=!0)}else{if(n>=this._passes.length)return void console.warn("illegal pass index: "+n+".");var c=this._passes[n];this._uploadProperty(c,e,t)&&(this._props[c.propertyIndex][e]=t,i=!0)}i||console.warn("illegal property name: "+e+".")},n.getProperty=function(e,t){if(void 0===t)for(var n=this._props,i=n.length,r=0;r<i;r++){var o=n[r];if(e in o)return o[e]}else{if(t>=this._props.length)return console.warn("illegal pass index: "+t+"."),null;var a=this._props[this._passes[t].propertyIndex];if(e in a)return a[e]}return null},n.copy=function(e,t){this._techIdx=e._techIdx,this._props.length=e._props.length;for(var n=0;n<e._props.length;n++)this._props[n]=J({},e._props[n]);this._defines.length=e._defines.length;for(var i=0;i<e._defines.length;i++)this._defines[i]=J({},e._defines[i]);this._states.length=e._states.length;for(var r=0;r<e._states.length;r++)this._states[r]=J({},e._states[r]);this._effectAsset=e._effectAsset,t&&this._fillInfo(t),this._update()},n._fillInfo=function(e){void 0!==e.technique&&(this._techIdx=e.technique),e.effectAsset?this._effectAsset=e.effectAsset:e.effectName&&(this._effectAsset=Om.get(e.effectName)),e.defines&&this._prepareInfo(e.defines,this._defines),e.states&&this._prepareInfo(e.states,this._states)},n._prepareInfo=function(e,t){var n=e;if(!Array.isArray(n)){var i=this._effectAsset?this._effectAsset.techniques[this._techIdx].passes.length:1;n=Array(i).fill(n)}for(var r=0;r<n.length;++r)Object.assign(t[r]||(t[r]={}),n[r])},n._createPasses=function(){var e=this._effectAsset.techniques[this._techIdx||0];if(!e)return[];for(var t=e.passes.length,n=[],i=0;i<t;++i){var r=e.passes[i],o=r.passIndex=i,a=r.defines=this._defines[o]||(this._defines[o]={});if(r.stateOverrides=this._states[o]||(this._states[o]={}),void 0!==r.propertyIndex&&Object.assign(a,this._defines[r.propertyIndex]),void 0!==r.embeddedMacros&&Object.assign(a,r.embeddedMacros),!r.switch||a[r.switch]){var s=new Gv(u.director.root);s.initialize(r),n.push(s)}}return n},n._update=function(e){var n=this;if(void 0===e&&(e=!0),this._effectAsset){this._passes=this._createPasses();var i=this._effectAsset.techniques[this._techIdx].passes.length;if(this._props.length=i,e)this._passes.forEach((function(e,t){var i=n._props[t];for(var r in i||(i=n._props[t]={}),void 0!==e.propertyIndex&&Object.assign(i,n._props[e.propertyIndex]),i)n._uploadProperty(e,r,i[r])}));else for(var r=0;r<this._props.length;r++)this._props[r]={}}this._hash=t.getHash(this)},n._uploadProperty=function(e,t,n){var i=e.getHandle(t);if(!i)return!1;if(Gv.getTypeFromHandle(i)<mi.SAMPLER1D)if(Array.isArray(n))e.setUniformArray(i,n);else if(null!==n){var r;if(null===(r=e.properties[t])||void 0===r?void 0:r.linear){var o=n;jv(lg,o),lg.w=o.w,n=lg}e.setUniform(i,n)}else e.resetUniform(t);else if(Array.isArray(n))for(var a=0;a<n.length;a++)this._bindTexture(e,i,n[a],a);else n?this._bindTexture(e,i,n):e.resetTexture(t);return!0},n._bindTexture=function(e,t,n,i){var r=Gv.getBindingFromHandle(t);if(n instanceof Lo)e.bindTexture(r,n,i);else if(n instanceof ev){var o=n.getGFXTexture();if(!o||!o.width||!o.height)return;e.bindTexture(r,o,i),e.bindSampler(r,n.getGFXSampler(),i)}},n._doDestroy=function(){if(this._passes&&this._passes.length)for(var e,t=se(this._passes);!(e=t()).done;)e.value.destroy();this._passes.length=0},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.initialize({effectName:"unlit",defines:{USE_COLOR:!0}}),this.setProperty("mainColor",new Pn("#ff00ff"))},n.validate=function(){return!!this._effectAsset&&!this._effectAsset.isDefault&&this.passes.length>0},Z(t,[{key:"effectAsset",get:function(){return this._effectAsset}},{key:"effectName",get:function(){return this._effectAsset?this._effectAsset.name:""}},{key:"technique",get:function(){return this._techIdx}},{key:"passes",get:function(){return this._passes}},{key:"hash",get:function(){return this._hash}},{key:"parent",get:function(){return null}},{key:"owner",get:function(){return null}}]),t}(Nu),Qv=le((Kv=tg).prototype,"_effectAsset",[Xv],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Zv=le(Kv.prototype,"_techIdx",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jv=le(Kv.prototype,"_defines",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$v=le(Kv.prototype,"_states",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),eg=le(Kv.prototype,"_props",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Yv=Kv))||Yv));u.Material=ug,function(e){e[e.VERTICAL=0]="VERTICAL",e[e.HORIZONTAL=1]="HORIZONTAL"}(rg||(rg={})),function(e){e[e.ORTHO=0]="ORTHO",e[e.PERSPECTIVE=1]="PERSPECTIVE"}(og||(og={})),function(e){e[e.F1_8=0]="F1_8",e[e.F2_0=1]="F2_0",e[e.F2_2=2]="F2_2",e[e.F2_5=3]="F2_5",e[e.F2_8=4]="F2_8",e[e.F3_2=5]="F3_2",e[e.F3_5=6]="F3_5",e[e.F4_0=7]="F4_0",e[e.F4_5=8]="F4_5",e[e.F5_0=9]="F5_0",e[e.F5_6=10]="F5_6",e[e.F6_3=11]="F6_3",e[e.F7_1=12]="F7_1",e[e.F8_0=13]="F8_0",e[e.F9_0=14]="F9_0",e[e.F10_0=15]="F10_0",e[e.F11_0=16]="F11_0",e[e.F13_0=17]="F13_0",e[e.F14_0=18]="F14_0",e[e.F16_0=19]="F16_0",e[e.F18_0=20]="F18_0",e[e.F20_0=21]="F20_0",e[e.F22_0=22]="F22_0"}(ag||(ag={})),function(e){e[e.ISO100=0]="ISO100",e[e.ISO200=1]="ISO200",e[e.ISO400=2]="ISO400",e[e.ISO800=3]="ISO800"}(sg||(sg={})),function(e){e[e.D1=0]="D1",e[e.D2=1]="D2",e[e.D4=2]="D4",e[e.D8=3]="D8",e[e.D15=4]="D15",e[e.D30=5]="D30",e[e.D60=6]="D60",e[e.D125=7]="D125",e[e.D250=8]="D250",e[e.D500=9]="D500",e[e.D1000=10]="D1000",e[e.D2000=11]="D2000",e[e.D4000=12]="D4000"}(cg||(cg={}));var hg=[1.8,2,2.2,2.5,2.8,3.2,3.5,4,4.5,5,5.6,6.3,7.1,8,9,10,11,13,14,16,18,20,22],fg=[1,.5,1/4,1/8,1/15,1/30,1/60,.008,.004,.002,.001,5e-4,1/4e3],_g=[100,200,400,800],pg=new In,dg=new In,mg=new jn,vg=Ki.STENCIL<<1,gg=[],yg=function(){function e(e){if(this.isWindowSize=!0,this.screenScale=void 0,this._device=void 0,this._scene=null,this._node=null,this._name=null,this._enabled=!1,this._proj=-1,this._aspect=void 0,this._orthoHeight=10,this._fovAxis=rg.VERTICAL,this._fov=fn(45),this._nearClip=1,this._farClip=1e3,this._clearColor=new lr(.2,.2,.2,1),this._viewport=new ri(0,0,1,1),this._orientedViewport=new ri(0,0,1,1),this._curTransform=fi.IDENTITY,this._isProjDirty=!0,this._matView=new jn,this._matProj=new jn,this._matProjInv=new jn,this._matViewProj=new jn,this._matViewProjInv=new jn,this._frustum=new oc,this._forward=new In,this._position=new In,this._priority=0,this._aperture=ag.F16_0,this._apertureValue=void 0,this._shutter=cg.D125,this._shutterValue=0,this._iso=sg.ISO100,this._isoValue=0,this._ec=0,this._window=null,this._width=1,this._height=1,this._clearFlag=Ki.NONE,this._clearDepth=1,this._visibility=Jd,this._exposure=0,this._clearStencil=0,this._device=e,this._apertureValue=hg[this._aperture],this._shutterValue=fg[this._shutter],this._isoValue=_g[this._iso],this._aspect=this.screenScale=1,this._frustum.accurate=!0,!gg.length){var t=e.capabilities.clipSpaceSignY;gg[fi.IDENTITY]=new jn(1,0,0,0,0,t),gg[fi.ROTATE_90]=new jn(0,1,0,0,-t,0),gg[fi.ROTATE_180]=new jn(-1,0,0,0,0,-t),gg[fi.ROTATE_270]=new jn(0,-1,0,0,t,0)}}var t=e.prototype;return t._setWidth=function(e){this._width=e},t._setHeight=function(e){this._height=e},t._setScene=function(e){this._scene=e},t._updateAspect=function(e){if(void 0===e&&(e=!0),this._aspect=this.window.width*this._viewport.width/(this.window.height*this._viewport.height),e){var t=this.window.swapchain;(t&&t.surfaceTransform||fi.IDENTITY)%2&&(this._aspect=1/this._aspect)}this._isProjDirty=!0},t._init=function(){},t.initialize=function(e){this._init(e),this.node=e.node,this._setWidth(1),this._setHeight(1),this.clearFlag=Ki.NONE,this.clearDepth=1,this.visibility=Jd,this._name=e.name,this._proj=e.projection,this._priority=e.priority||0,this._aspect=this.screenScale=1,this.updateExposure(),this.changeTargetWindow(e.window)},t._destroy=function(){},t.destroy=function(){this._window&&(this._window.detachCamera(this),this.window=null),this._name=null,this._destroy()},t.attachToScene=function(e){this._enabled=!0,this._setScene(e)},t.detachFromScene=function(){this._enabled=!1,this._setScene(null)},t.resize=function(e,t){this._window&&(this._setWidth(e),this._setHeight(t),this._updateAspect())},t.setFixedSize=function(e,t){this._setWidth(e),this._setHeight(t),this._updateAspect(!1),this.isWindowSize=!1},t.syncCameraEditor=function(){},t.update=function(e){var t;if(void 0===e&&(e=!1),this._node){var n=!1;(this._node.hasChangedFlags||e)&&(jn.invert(this._matView,this._node.worldMatrix),this._forward.x=-this._matView.m02,this._forward.y=-this._matView.m06,this._forward.z=-this._matView.m10,this._node.getWorldPosition(this._position),n=!0);var i=null===(t=this.window)||void 0===t?void 0:t.swapchain,r=i&&i.surfaceTransform||fi.IDENTITY;if(this._isProjDirty||this._curTransform!==r){this._curTransform=r;var o=this._device.capabilities.clipSpaceSignY;if(this._proj===og.PERSPECTIVE)jn.perspective(this._matProj,this._fov,this._aspect,this._nearClip,this._farClip,this._fovAxis===rg.VERTICAL,this._device.capabilities.clipSpaceMinZ,o,r);else{var a=this._orthoHeight*this._aspect,s=this._orthoHeight;jn.ortho(this._matProj,-a,a,-s,s,this._nearClip,this._farClip,this._device.capabilities.clipSpaceMinZ,o,r)}jn.invert(this._matProjInv,this._matProj),n=!0,this._isProjDirty=!1}n&&(jn.multiply(this._matViewProj,this._matProj,this._matView),jn.invert(this._matViewProjInv,this._matViewProj),this._frustum.update(this._matViewProj,this._matViewProjInv))}},t.setViewportInOrientedSpace=function(e){var t,n=e.x,i=e.width,r=e.height,o=this._device.capabilities.screenSpaceSignY<0?1-e.y-r:e.y,a=null===(t=this.window)||void 0===t?void 0:t.swapchain;switch(a&&a.surfaceTransform||fi.IDENTITY){case fi.ROTATE_90:this._viewport.x=1-o-r,this._viewport.y=n,this._viewport.width=r,this._viewport.height=i;break;case fi.ROTATE_180:this._viewport.x=1-n-i,this._viewport.y=1-o-r,this._viewport.width=i,this._viewport.height=r;break;case fi.ROTATE_270:this._viewport.x=o,this._viewport.y=1-n-i,this._viewport.width=r,this._viewport.height=i;break;case fi.IDENTITY:this._viewport.x=n,this._viewport.y=o,this._viewport.width=i,this._viewport.height=r}this._orientedViewport.x=n,this._orientedViewport.y=o,this._orientedViewport.width=i,this._orientedViewport.height=r,this.resize(this.width,this.height)},t.changeTargetWindow=function(e){void 0===e&&(e=null),this._window&&this._window.detachCamera(this);var t=e||u.director.root.mainWindow;if(t){t.attachCamera(this),this.window=t;var n=t.swapchain;(n&&n.surfaceTransform||fi.IDENTITY)%2?this.resize(t.height,t.width):this.resize(t.width,t.height)}},t.detachCamera=function(){this._window&&this._window.detachCamera(this)},t.screenPointToRay=function(e,t,n){if(!this._node)return null;var i=this.width,r=this.height,o=this._orientedViewport.x*i,a=this._orientedViewport.y*r,s=this._orientedViewport.width*i,c=this._orientedViewport.height*r,l=this._proj===og.PERSPECTIVE,u=this._device.capabilities.clipSpaceSignY,h=Wn[this._curTransform];In.set(pg,(t-o)/s*2-1,(n-a)/c*2-1,l?1:-1);var f=pg.x,_=pg.y;return pg.x=f*h[0]+_*h[2]*u,pg.y=f*h[1]+_*h[3]*u,In.transformMat4(l?pg:e.o,pg,this._matViewProjInv),l?(this._node.getWorldPosition(dg),na.fromPoints(e,dg,pg)):In.transformQuat(e.d,In.FORWARD,this._node.worldRotation),e},t.screenToWorld=function(e,t){var n=this.width,i=this.height,r=this._orientedViewport.x*n,o=this._orientedViewport.y*i,a=this._orientedViewport.width*n,s=this._orientedViewport.height*i,c=this._device.capabilities.clipSpaceSignY,l=Wn[this._curTransform];if(this._proj===og.PERSPECTIVE){In.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,1);var u=e.x,h=e.y;e.x=u*l[0]+h*l[2]*c,e.y=u*l[1]+h*l[3]*c,In.transformMat4(e,e,this._matViewProjInv),this._node&&this._node.getWorldPosition(pg),In.lerp(e,pg,e,hn(this._nearClip/this._farClip,1,t.z))}else{In.set(e,(t.x-r)/a*2-1,(t.y-o)/s*2-1,2*t.z-1);var f=e.x,_=e.y;e.x=f*l[0]+_*l[2]*c,e.y=f*l[1]+_*l[3]*c,In.transformMat4(e,e,this._matViewProjInv)}return e},t.worldToScreen=function(e,t){var n=this._device.capabilities.clipSpaceSignY,i=Wn[this._curTransform];In.transformMat4(e,t,this._matViewProj);var r=e.x,o=e.y;e.x=r*i[0]+o*i[2]*n,e.y=r*i[1]+o*i[3]*n;var a=this.width,s=this.height,c=this._orientedViewport.x*a,l=this._orientedViewport.y*s,u=this._orientedViewport.width*a,h=this._orientedViewport.height*s;return e.x=c+.5*(e.x+1)*u,e.y=l+.5*(e.y+1)*h,e.z=.5*e.z+.5,e},t.worldMatrixToScreen=function(e,t,n,i){jn.multiply(e,this._matViewProj,t),jn.multiply(e,gg[this._curTransform],e);var r=n/2,o=i/2;return jn.identity(mg),jn.transform(mg,mg,In.set(pg,r,o,0)),jn.scale(mg,mg,In.set(pg,r,o,1)),jn.multiply(e,mg,e),e},t.setExposure=function(e){this._exposure=.833333/Math.pow(2,e)},t.updateExposure=function(){var e=Math.log2(this._apertureValue*this._apertureValue/this._shutterValue*100/this._isoValue);this.setExposure(e)},Z(e,[{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._isProjDirty=!0}},{key:"projectionType",get:function(){return this._proj},set:function(e){this._proj=e,this._isProjDirty=!0}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){this._fovAxis=e,this._isProjDirty=!0}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._isProjDirty=!0}},{key:"nearClip",get:function(){return this._nearClip},set:function(e){this._nearClip=e,this._isProjDirty=!0}},{key:"farClip",get:function(){return this._farClip},set:function(e){this._farClip=e,this._isProjDirty=!0}},{key:"clearColor",get:function(){return this._clearColor},set:function(e){this._clearColor.x=e.x,this._clearColor.y=e.y,this._clearColor.z=e.z,this._clearColor.w=e.w}},{key:"viewport",get:function(){return this._viewport},set:function(e){D(8302),this.setViewportInOrientedSpace(e)}},{key:"scene",get:function(){return this._scene}},{key:"name",get:function(){return this._name}},{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"aspect",get:function(){return this._aspect}},{key:"matView",get:function(){return this._matView}},{key:"matProj",get:function(){return this._matProj}},{key:"matProjInv",get:function(){return this._matProjInv}},{key:"matViewProj",get:function(){return this._matViewProj}},{key:"matViewProjInv",get:function(){return this._matViewProjInv}},{key:"frustum",get:function(){return this._frustum},set:function(e){this._frustum=e}},{key:"window",get:function(){return this._window},set:function(e){this._window=e}},{key:"forward",get:function(){return this._forward},set:function(e){this._forward=e}},{key:"position",get:function(){return this._position},set:function(e){this._position=e}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._apertureValue=hg[this._aperture],this.updateExposure()}},{key:"apertureValue",get:function(){return this._apertureValue}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._shutterValue=fg[this._shutter],this.updateExposure()}},{key:"shutterValue",get:function(){return this._shutterValue}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._isoValue=_g[this._iso],this.updateExposure()}},{key:"isoValue",get:function(){return this._isoValue}},{key:"ec",get:function(){return this._ec},set:function(e){this._ec=e}},{key:"exposure",get:function(){return this._exposure}},{key:"clearFlag",get:function(){return this._clearFlag},set:function(e){this._clearFlag=e}},{key:"clearDepth",get:function(){return this._clearDepth},set:function(e){this._clearDepth=e}},{key:"clearStencil",get:function(){return this._clearStencil},set:function(e){this._clearStencil=e}},{key:"native",get:function(){return this._nativeObj}}],[{key:"standardExposureValue",get:function(){return 1/38400}},{key:"standardLightMeterScale",get:function(){return 1e4}}]),e}(),xg=st({Low_256x256:256,Medium_512x512:512,High_1024x1024:1024,Ultra_2048x2048:2048}),Sg=st({Planar:0,ShadowMap:1}),Tg=st({HARD:0,SOFT:1,SOFT_2X:2}),bg=Sg.ShadowMap+1,Eg=function(){function e(){this.fixedSphere=new la(0,0,0,.01),this.maxReceived=4,this.firstSetCSM=!1,this.shadowCameraFar=0,this.matShadowView=new jn,this.matShadowProj=new jn,this.matShadowViewProj=new jn,this._normal=new In(0,1,0),this._shadowColor=new Pn(0,0,0,76),this._matLight=new jn,this._material=null,this._instancingMaterial=null,this._size=new Kn(512,512),this._enabled=!1,this._distance=0,this._type=bg,this._near=.1,this._far=10,this._invisibleOcclusionRange=200,this._shadowDistance=100,this._orthoSize=1,this._pcf=0,this._shadowMapDirty=!1,this._bias=0,this._normalBias=0,this._fixedArea=!1,this._saturation=.75}var t=e.prototype;return t.getPlanarShader=function(e){return this._material||(this._material=new ug,this._material.initialize({effectName:"planar-shadow"})),this._material.passes[0].getShaderVariant(e)},t.getPlanarInstanceShader=function(e){return this._instancingMaterial||(this._instancingMaterial=new ug,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}})),this._instancingMaterial.passes[0].getShaderVariant(e)},t._setEnable=function(e){this._enabled=e},t._setType=function(e){this._type=this.enabled?e:bg},t.initialize=function(e){this.near=e.near,this.far=e.far,this.invisibleOcclusionRange=e.invisibleOcclusionRange,this.shadowDistance=e.shadowDistance,this.orthoSize=e.orthoSize,this.size=e.size,this.pcf=e.pcf,this.normal=e.normal,this.distance=e.distance,this.shadowColor=e.shadowColor,this.bias=e.bias,this.normalBias=e.normalBias,this.maxReceived=e.maxReceived,this.fixedArea=e.fixedArea,this._setEnable(e.enabled),this._setType(e.type),this.saturation=e.saturation},t.activate=function(){this.enabled&&this.type===Sg.Planar&&this._updatePlanarInfo()},t._updatePlanarInfo=function(){this._material||(this._material=new ug,this._material.initialize({effectName:"planar-shadow"})),this._instancingMaterial||(this._instancingMaterial=new ug,this._instancingMaterial.initialize({effectName:"planar-shadow",defines:{USE_INSTANCING:!0}}))},t._destroy=function(){},t.destroy=function(){this._destroy(),this._material&&this._material.destroy(),this._instancingMaterial&&this._instancingMaterial.destroy(),this.fixedSphere.destroy()},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),this.activate()}},{key:"normal",get:function(){return this._normal},set:function(e){In.copy(this._normal,e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor=e}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=e}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=e}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.activate()}},{key:"near",get:function(){return this._near},set:function(e){this._near=e}},{key:"far",get:function(){return this._far},set:function(e){this._far=e}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e}},{key:"size",get:function(){return this._size},set:function(e){this._size.set(e)}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e}},{key:"shadowMapDirty",get:function(){return this._shadowMapDirty},set:function(e){this._shadowMapDirty=e}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e}},{key:"saturation",get:function(){return this._saturation},set:function(e){this._saturation=e}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e}},{key:"matLight",get:function(){return this._matLight}},{key:"material",get:function(){return this._material}},{key:"instancingMaterial",get:function(){return this._instancingMaterial}},{key:"native",get:function(){return this._nativeObj}}]),e}();Eg.MAX_FAR=2e3,Eg.COEFFICIENT_OF_EXPANSION=2*Math.sqrt(3),u.Shadows=Eg;var Cg=new In,Ag=(new In,new In,new In),wg=new jn,Pg=new Xs,Rg=new Xs,Ig=!1,Dg=la.create(0,0,0,1),Og=new la,Mg=new oc;Mg.accurate=!0;var Ng=new oc;Ng.accurate=!0;var Lg=new oc,Bg=new jn,Fg=new jn,zg=new jn,Ug=new jn,kg=new jn,Gg=new jn,Hg=new jn,Vg=new In,Wg=new Kn,jg=new In,qg=new In,Xg=new In(0,0,0),Yg=(new Xs,new ql((function(){return{model:null,depth:0}}),128)),Kg=new ql((function(){return{model:null,depth:0}}),128),Qg=new ql((function(){return{model:null,depth:0}}),128);function Zg(e,t){var n=0;e.node&&(In.subtract(Cg,e.node.worldPosition,t.position),n=In.dot(Cg,t.forward));var i=Yg.alloc();return i.model=e,i.depth=n,i}function Jg(e,t){var n=0;e.node&&(In.subtract(Cg,e.node.worldPosition,t.position),n=In.dot(Cg,t.forward));var i=Kg.alloc();return i.model=e,i.depth=n,i}function $g(e,t){var n=0;e.node&&(In.subtract(Cg,e.node.worldPosition,t.position),n=In.dot(Cg,t.forward));var i=Qg.alloc();return i.model=e,i.depth=n,i}function ey(e,t,n){var i=t.direction,r=e.normal,o=e.distance+.001,a=1/In.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,_=e.matLight;_.m00=1-u*s,_.m01=-u*c,_.m02=-u*l,_.m03=0,_.m04=-h*s,_.m05=1-h*c,_.m06=-h*l,_.m07=0,_.m08=-f*s,_.m09=-f*c,_.m10=1-f*l,_.m11=0,_.m12=s*o,_.m13=c*o,_.m14=l*o,_.m15=1,jn.toArray(n,_,td.MAT_LIGHT_PLANE_PROJ_OFFSET)}function ty(e,t){In.normalize(Cg,e.normal),t[td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+0]=Cg.x,t[td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+1]=Cg.y,t[td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+2]=Cg.z,t[td.PLANAR_NORMAL_DISTANCE_INFO_OFFSET+3]=e.distance}function ny(e,t){var n=e.pipelineSceneData.validPunctualLights;n.length=0;for(var i=t.scene.spotLights,r=0;r<i.length;r++){var o=i[r];o.baked||(la.set(Dg,o.position.x,o.position.y,o.position.z,o.range),_s.sphereFrustum(Dg,t.frustum)&&n.push(o))}for(var a=t.scene.sphereLights,s=0;s<a.length;s++){var c=a[s];c.baked||(la.set(Dg,c.position.x,c.position.y,c.position.z,c.range),_s.sphereFrustum(Dg,t.frustum)&&n.push(c))}}function iy(e,t){var n=t.scene,i=n.mainLight,r=e.pipelineSceneData,o=r.shadows,a=r.skybox,s=r.renderObjects;Yg.freeArray(s),s.length=0;var c=r.castShadowObjects;Qg.freeArray(c),c.length=0,Ig=!1;var l=null;if(o.enabled&&(e.pipelineUBO.updateShadowUBORange(td.SHADOW_COLOR_OFFSET,o.shadowColor),o.type===Sg.ShadowMap))if(l=e.pipelineSceneData.dirShadowObjects,Kg.freeArray(l),l.length=0,i&&i.node)!function(e,t,n,i,r){var o=t.device;if(r.fixedArea){var a=r.orthoSize,s=r.orthoSize,c=r.near,l=r.far;jn.fromRT(Bg,n.node.getWorldRotation(),n.node.getWorldPosition()),jn.invert(Fg,Bg),jn.ortho(Ug,-a,a,-s,s,c,l,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),jn.multiply(kg,Ug,Fg),jn.invert(zg,Fg),r.matShadowView=Fg,r.matShadowProj=Ug,r.matShadowViewProj=kg,oc.createOrtho(e,2*a,2*s,c,l,zg)}else{var u=r.invisibleOcclusionRange,h=r.size.x;!function(e,t){if(t.node){var n=t.node,i=n.getWorldPosition(),r=n.getWorldRotation();jn.fromRT(e,r,i),e.m08*=-1,e.m09*=-1,e.m10*=-1}}(wg,i),oc.split(Mg,i,wg,.1,r.shadowDistance),Ng=oc.clone(Mg),jn.fromRT(Bg,n.node.rotation,Xg),jn.invert(Fg,Bg),jn.invert(zg,Fg);var f=Fg.clone();Ng.transform(Fg),Xs.fromPoints(Pg,new In(1e7,1e7,1e7),new In(-1e7,-1e7,-1e7)),Pg.mergeFrustum(Ng);var _=2*Pg.halfExtents.z;Ag.set(Pg.center.x,Pg.center.y,Pg.center.z+Pg.halfExtents.z+u),In.transformMat4(Ag,Ag,zg),jn.fromRT(Bg,n.node.rotation,Ag),jn.invert(Fg,Bg),jn.invert(zg,Fg);var p=In.distance(Mg.vertices[0],Mg.vertices[6]);Og.center.set(0,0,0),Og.radius=-1,Og.mergePoints(Mg.vertices);var d=.8*p+.4*Og.radius;r.shadowCameraFar=_+u;var m=.5*d;if(jn.ortho(Ug,-m,m,-m,m,.1,r.shadowCameraFar,o.capabilities.clipSpaceMinZ,o.capabilities.clipSpaceSignY),h>0){jn.multiply(Gg,Ug,f),In.transformMat4(Vg,Ag,Gg);var v=2/h;Wg.set(v,v);var g=Vg.x%Wg.x,y=Vg.y%Wg.y;jg.set(Vg.x-g,Vg.y-y,Vg.z),jn.invert(Hg,Gg),In.transformMat4(qg,jg,Hg),jn.fromRT(Bg,n.node.rotation,qg),jn.invert(Fg,Bg),jn.invert(zg,Fg),oc.createOrtho(e,d,d,.1,r.shadowCameraFar,zg)}else{for(var x=0;x<8;x++)e.vertices[x].set(0,0,0);e.updatePlanes()}jn.multiply(kg,Ug,Fg),r.matShadowView=Fg,r.matShadowProj=Ug,r.matShadowViewProj=kg}}(Lg,e,i,t,o);else{for(var u=0;u<8;u++)Lg.vertices[u].set(0,0,0);Lg.updatePlanes()}i&&o.type===Sg.Planar&&function(e,t){var n=e.pipelineSceneData.shadows,i=t.direction,r=n.normal,o=n.distance+.001,a=1/In.dot(r,i),s=i.x*a,c=i.y*a,l=i.z*a,u=r.x,h=r.y,f=r.z,_=n.matLight;_.m00=1-u*s,_.m01=-u*c,_.m02=-u*l,_.m03=0,_.m04=-h*s,_.m05=1-h*c,_.m06=-h*l,_.m07=0,_.m08=-f*s,_.m09=-f*c,_.m10=1-f*l,_.m11=0,_.m12=s*o,_.m13=c*o,_.m14=l*o,_.m15=1,e.pipelineUBO.updateShadowUBORange(td.MAT_LIGHT_PLANE_PROJ_OFFSET,n.matLight)}(e,i),a.enabled&&a.model&&t.clearFlag&vg&&s.push(Zg(a.model,t));for(var h=n.models,f=t.visibility,_=0;_<h.length;_++){var p=h[_];if(p.enabled&&(p.castShadow&&c.push($g(p,t)),o.firstSetCSM&&p.worldBounds&&(Ig||(Rg.copy(p.worldBounds),Ig=!0),Xs.merge(Rg,Rg,p.worldBounds)),p.node&&(f&p.node.layer)===p.node.layer||f&p.visFlags)){if(null!=l&&p.castShadow&&p.worldBounds&&_s.aabbFrustum(p.worldBounds,Lg)&&l.push(Jg(p,t)),p.worldBounds&&!_s.aabbFrustum(p.worldBounds,t.frustum))continue;s.push(Zg(p,t))}}o.firstSetCSM&&(o.shadowDistance=2*Rg.halfExtents.length(),o.firstSetCSM=!1)}var ry,oy,ay,sy=new xr(Ai.LINEAR,Ai.LINEAR,Ai.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),cy=new xr(Ai.POINT,Ai.POINT,Ai.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),ly=function(){function e(e){this._device=void 0,this._descriptorSetMap=new Map,this._globalDescriptorSet=void 0,this._descriptorSetLayout=void 0,this._linearSampler=void 0,this._pointSampler=void 0,this._device=e.device,this._linearSampler=this._device.getSampler(sy),this._pointSampler=this._device.getSampler(cy);var t=new Hr(Wp.bindings);this._descriptorSetLayout=this._device.createDescriptorSetLayout(t),this._globalDescriptorSet=this._device.createDescriptorSet(new Vr(this._descriptorSetLayout))}var t=e.prototype;return t.bindBuffer=function(e,t){this._globalDescriptorSet.bindBuffer(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindBuffer(e,t),i=n.next()},t.bindSampler=function(e,t){this._globalDescriptorSet.bindSampler(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindSampler(e,t),i=n.next()},t.bindTexture=function(e,t){this._globalDescriptorSet.bindTexture(e,t);for(var n=this._descriptorSetMap.values(),i=n.next();!i.done;)i.value.bindTexture(e,t),i=n.next()},t.update=function(){this._globalDescriptorSet.update();for(var e=this._descriptorSetMap.values(),t=e.next();!t.done;)t.value.update(),t=e.next()},t.getOrCreateDescriptorSet=function(e){var t=this._device;if(!this._descriptorSetMap.has(e)){var n=this._globalDescriptorSet,i=t.createDescriptorSet(new Vr(this._descriptorSetLayout));this._descriptorSetMap.set(e,i);for(var r=Vp.UBO_GLOBAL;r<Vp.COUNT;r++)i.bindBuffer(r,n.getBuffer(r)),i.bindSampler(r,n.getSampler(r)),i.bindTexture(r,n.getTexture(r));var o=t.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,td.SIZE,td.SIZE));i.bindBuffer(td.BINDING,o),i.update()}return this._descriptorSetMap.get(e)},t.destroy=function(){this._descriptorSetLayout.destroy()},Z(e,[{key:"descriptorSetMap",get:function(){return this._descriptorSetMap}},{key:"linearSampler",get:function(){return this._linearSampler}},{key:"pointSampler",get:function(){return this._pointSampler}},{key:"descriptorSetLayout",get:function(){return this._descriptorSetLayout}},{key:"globalDescriptorSet",get:function(){return this._globalDescriptorSet}}]),e}();function uy(e,t){t<1e3?t=1e3:t>15e3&&(t=15e3);var n=t*t,i=(.860117757+.000154118254*t+1.28641212e-7*n)/(1+.000842420235*t+7.08145163e-7*n),r=(.317398726+422806245e-13*t+4.20481691e-8*n)/(1-289741816e-13*t+1.61456053e-7*n),o=2*i-8*r+4,a=3*i/o,s=2*r/o,c=1/s*a,l=1/s*(1-a-s);e.x=3.2404542*c-1.5371385+-.4985314*l,e.y=-.969266*c+1.8760108+.041556*l,e.z=.0556434*c-.2040259+1.0572252*l}!function(e){e[e.LOCAL=0]="LOCAL",e[e.WORLD=1]="WORLD"}(ry||(ry={})),function(e){e[e.NONE=0]="NONE",e[e.POSITION=1]="POSITION",e[e.ROTATION=2]="ROTATION",e[e.SCALE=4]="SCALE",e[e.RS=e.ROTATION|e.SCALE]="RS",e[e.TRS=e.POSITION|e.ROTATION|e.SCALE]="TRS",e[e.TRS_MASK=~e.TRS]="TRS_MASK"}(oy||(oy={})),u.internal.TransformBit=oy,function(e){e[e.DIRECTIONAL=0]="DIRECTIONAL",e[e.SPHERE=1]="SPHERE",e[e.SPOT=2]="SPOT",e[e.UNKNOWN=3]="UNKNOWN"}(ay||(ay={}));var hy,fy,_y,py,dy,my,vy,gy,yy,xy,Sy=function(e){return 4*Math.PI*Math.PI*e*e},Ty=function(){function e(){this._baked=!1,this._color=new In(1,1,1),this._colorTemp=6550,this._colorTempRGB=new In(1,1,1),this._scene=null,this._node=null,this._name=null,this._useColorTemperature=!1,this._type=ay.UNKNOWN}var t=e.prototype;return t._init=function(){},t._destroy=function(){},t.initialize=function(){this._init(),this.color=new In(1,1,1),this.colorTemperature=6550},t.attachToScene=function(e){this._scene=e},t.detachFromScene=function(){this._scene=null},t.destroy=function(){this._name=null,this._node=null,this._destroy()},t.update=function(){},Z(e,[{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"color",get:function(){return this._color},set:function(e){this._color.set(e)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e}},{key:"colorTemperature",get:function(){return this._colorTemp},set:function(e){this._colorTemp=e,uy(this._colorTempRGB,this._colorTemp)}},{key:"colorTemperatureRGB",get:function(){return this._colorTempRGB}},{key:"node",get:function(){return this._node},set:function(e){this._node=e,this._node&&(this._node.hasChangedFlags|=oy.ROTATION)}},{key:"type",get:function(){return this._type}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"scene",get:function(){return this._scene}},{key:"native",get:function(){return this._nativeObj}}]),e}(),by=new jn,Ey=new jn,Cy=new jn,Ay=new $n,wy=new $n(0,0,1,0),Py=function(){function e(){this._globalUBO=new Float32Array($p.COUNT),this._cameraUBO=new Float32Array(ed.COUNT),this._shadowUBO=new Float32Array(td.COUNT)}e.updateGlobalUBOView=function(e,t){var n=u.director.root,i=t,r=Math.floor(e.width),o=Math.floor(e.height);i[$p.TIME_OFFSET]=n.cumulativeTime,i[$p.TIME_OFFSET+1]=n.frameTime,i[$p.TIME_OFFSET+2]=u.director.getTotalFrames(),i[$p.SCREEN_SIZE_OFFSET]=r,i[$p.SCREEN_SIZE_OFFSET+1]=o,i[$p.SCREEN_SIZE_OFFSET+2]=1/r,i[$p.SCREEN_SIZE_OFFSET+3]=1/o,i[$p.NATIVE_SIZE_OFFSET]=r,i[$p.NATIVE_SIZE_OFFSET+1]=o,i[$p.NATIVE_SIZE_OFFSET+2]=1/i[$p.NATIVE_SIZE_OFFSET],i[$p.NATIVE_SIZE_OFFSET+3]=1/i[$p.NATIVE_SIZE_OFFSET+1]},e.updateCameraUBOView=function(e,t,n){var i=(n.scene?n.scene:u.director.getScene().renderScene).mainLight,r=e.pipelineSceneData,o=r.ambient,a=r.fog,s=r.shadows,c=t,l=n.exposure,h=r.isHDR;if(c[ed.SCREEN_SCALE_OFFSET]=r.shadingScale,c[ed.SCREEN_SCALE_OFFSET+1]=r.shadingScale,c[ed.SCREEN_SCALE_OFFSET+2]=1/c[ed.SCREEN_SCALE_OFFSET],c[ed.SCREEN_SCALE_OFFSET+3]=1/c[ed.SCREEN_SCALE_OFFSET+1],c[ed.EXPOSURE_OFFSET]=l,c[ed.EXPOSURE_OFFSET+1]=1/l,c[ed.EXPOSURE_OFFSET+2]=h?1:0,c[ed.EXPOSURE_OFFSET+3]=0,i){var f=s.enabled&&s.type===Sg.ShadowMap?1:0,_=i.direction;if(wy.set(_.x,_.y,_.z,f),$n.toArray(c,wy,ed.MAIN_LIT_DIR_OFFSET),In.toArray(c,i.color,ed.MAIN_LIT_COLOR_OFFSET),i.useColorTemperature){var p=i.colorTemperatureRGB;c[ed.MAIN_LIT_COLOR_OFFSET]*=p.x,c[ed.MAIN_LIT_COLOR_OFFSET+1]*=p.y,c[ed.MAIN_LIT_COLOR_OFFSET+2]*=p.z}c[ed.MAIN_LIT_COLOR_OFFSET+3]=h?i.illuminance*l:i.illuminance}else wy.set(0,0,1,0),$n.toArray(c,wy,ed.MAIN_LIT_DIR_OFFSET),$n.toArray(c,$n.ZERO,ed.MAIN_LIT_COLOR_OFFSET);var d=o.skyColor;d.w=h?o.skyIllum*l:o.skyIllum,c[ed.AMBIENT_SKY_OFFSET+0]=d.x,c[ed.AMBIENT_SKY_OFFSET+1]=d.y,c[ed.AMBIENT_SKY_OFFSET+2]=d.z,c[ed.AMBIENT_SKY_OFFSET+3]=d.w,c[ed.AMBIENT_GROUND_OFFSET+0]=o.groundAlbedo.x,c[ed.AMBIENT_GROUND_OFFSET+1]=o.groundAlbedo.y,c[ed.AMBIENT_GROUND_OFFSET+2]=o.groundAlbedo.z,c[ed.AMBIENT_GROUND_OFFSET+3]=o.mipmapCount,jn.toArray(c,n.matView,ed.MAT_VIEW_OFFSET),jn.toArray(c,n.node.worldMatrix,ed.MAT_VIEW_INV_OFFSET),In.toArray(c,n.position,ed.CAMERA_POS_OFFSET),jn.toArray(c,n.matProj,ed.MAT_PROJ_OFFSET),jn.toArray(c,n.matProjInv,ed.MAT_PROJ_INV_OFFSET),jn.toArray(c,n.matViewProj,ed.MAT_VIEW_PROJ_OFFSET),jn.toArray(c,n.matViewProjInv,ed.MAT_VIEW_PROJ_INV_OFFSET),c[ed.CAMERA_POS_OFFSET+3]=this.getCombineSignY();var m=a.colorArray;c[ed.GLOBAL_FOG_COLOR_OFFSET]=m.x,c[ed.GLOBAL_FOG_COLOR_OFFSET+1]=m.y,c[ed.GLOBAL_FOG_COLOR_OFFSET+2]=m.z,c[ed.GLOBAL_FOG_COLOR_OFFSET+3]=m.z,c[ed.GLOBAL_FOG_BASE_OFFSET]=a.fogStart,c[ed.GLOBAL_FOG_BASE_OFFSET+1]=a.fogEnd,c[ed.GLOBAL_FOG_BASE_OFFSET+2]=a.fogDensity,c[ed.GLOBAL_FOG_ADD_OFFSET]=a.fogTop,c[ed.GLOBAL_FOG_ADD_OFFSET+1]=a.fogRange,c[ed.GLOBAL_FOG_ADD_OFFSET+2]=a.fogAtten,c[ed.NEAR_FAR_OFFSET]=n.nearClip,c[ed.NEAR_FAR_OFFSET+1]=n.farClip,c[ed.VIEW_PORT_OFFSET]=r.shadingScale*n.window.width*n.viewport.x,c[ed.VIEW_PORT_OFFSET+1]=r.shadingScale*n.window.height*n.viewport.y,c[ed.VIEW_PORT_OFFSET+2]=r.shadingScale*n.window.width*n.viewport.z,c[ed.VIEW_PORT_OFFSET+3]=r.shadingScale*n.window.height*n.viewport.w},e.updateShadowUBOView=function(e,t,n){var i=e.device,r=n.scene.mainLight,o=e.pipelineSceneData.shadows,a=t;if(o.enabled){if(r&&o.type===Sg.ShadowMap){var s=.1,c=0,l=o.matShadowView,u=o.matShadowProj,h=o.matShadowViewProj;o.fixedArea?(s=o.near,c=o.far):(s=.1,c=o.shadowCameraFar),jn.toArray(t,l,td.MAT_LIGHT_VIEW_OFFSET),a[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,a[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,a[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,a[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,a[td.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,a[td.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,a[td.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,a[td.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,jn.toArray(t,h,td.MAT_LIGHT_VIEW_PROJ_OFFSET);var f=tm(i)?0:1;a[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=s,a[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=c,a[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,a[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-o.saturation,a[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=o.size.x,a[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=o.size.y,a[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=o.pcf,a[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=o.bias,a[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=0,a[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=f,a[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=o.normalBias,a[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0}else r&&o.type===Sg.Planar&&(ey(o,r,a),ty(o,a));Pn.toArray(a,o.shadowColor,td.SHADOW_COLOR_OFFSET)}},e.updateShadowUBOLightView=function(e,t,n){var i=e.device,r=e.pipelineSceneData.shadows,o=t,a=tm(i)?0:1,s=.1,c=0,l=r.matShadowView,u=r.matShadowProj,h=r.matShadowViewProj;switch(n.type){case ay.DIRECTIONAL:r.fixedArea?(s=r.near,c=r.far):(s=.1,c=r.shadowCameraFar),jn.toArray(t,l,td.MAT_LIGHT_VIEW_OFFSET),o[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=u.m10,o[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=u.m14,o[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=u.m11,o[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=u.m15,o[td.SHADOW_PROJ_INFO_OFFSET+0]=u.m00,o[td.SHADOW_PROJ_INFO_OFFSET+1]=u.m05,o[td.SHADOW_PROJ_INFO_OFFSET+2]=1/u.m00,o[td.SHADOW_PROJ_INFO_OFFSET+3]=1/u.m05,jn.toArray(t,h,td.MAT_LIGHT_VIEW_PROJ_OFFSET),Ay.set(s,c,0,1-r.saturation),$n.toArray(o,Ay,td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ay.set(0,a,r.normalBias,0),$n.toArray(o,Ay,td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET);break;case ay.SPOT:jn.invert(by,n.node.getWorldMatrix()),jn.toArray(o,by,td.MAT_LIGHT_VIEW_OFFSET),jn.perspective(Ey,n.angle,n.aspect,.001,n.range),jn.multiply(Cy,Ey,by),jn.toArray(o,Cy,td.MAT_LIGHT_VIEW_PROJ_OFFSET),Ay.set(.01,n.range,0,1-r.saturation),$n.toArray(o,Ay,td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET),Ay.set(1,a,r.normalBias,0),$n.toArray(o,Ay,td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET)}Ay.set(r.size.x,r.size.y,r.pcf,r.bias),$n.toArray(o,Ay,td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET),Pn.toArray(o,r.shadowColor,td.SHADOW_COLOR_OFFSET)},e.getCombineSignY=function(){return e._combineSignY};var t=e.prototype;return t._initCombineSignY=function(){var t=this._device;e._combineSignY=.5*t.capabilities.screenSpaceSignY+.5<<1|.5*t.capabilities.clipSpaceSignY+.5},t.activate=function(e,t){this._device=e,this._pipeline=t;var n=this._pipeline.descriptorSet;this._initCombineSignY();var i=e.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,$p.SIZE,$p.SIZE));n.bindBuffer($p.BINDING,i);var r=e.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,ed.SIZE,ed.SIZE));n.bindBuffer(ed.BINDING,r);var o=e.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,td.SIZE,td.SIZE));n.bindBuffer(td.BINDING,o)},t.updateGlobalUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;i.update(),e.updateGlobalUBOView(t,this._globalUBO),r[0].updateBuffer(i.getBuffer($p.BINDING),this._globalUBO),n.bindBuffer($p.BINDING,i.getBuffer($p.BINDING)),n.update()},t.updateCameraUBO=function(t){var n=this._pipeline.globalDSManager,i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers;e.updateCameraUBOView(this._pipeline,this._cameraUBO,t),r[0].updateBuffer(i.getBuffer(ed.BINDING),this._cameraUBO),n.bindBuffer(ed.BINDING,i.getBuffer(ed.BINDING)),n.update()},t.updateShadowUBO=function(t){var n=this._pipeline.pipelineSceneData;if(n.shadows.enabled){var i=this._pipeline.descriptorSet,r=this._pipeline.commandBuffers,o=n.shadowFrameBufferMap,a=t.scene.mainLight;a&&o.has(a)&&i.bindTexture(nd,o.get(a).colorTextures[0]),e.updateShadowUBOView(this._pipeline,this._shadowUBO,t),i.update(),r[0].updateBuffer(i.getBuffer(td.BINDING),this._shadowUBO)}},t.updateShadowUBOLight=function(t,n){e.updateShadowUBOLightView(this._pipeline,this._shadowUBO,n),t.bindTexture(nd,Nv.get("default-texture").getGFXTexture()),t.bindTexture(hd,Nv.get("default-texture").getGFXTexture()),t.update(),t.getBuffer(td.BINDING).update(this._shadowUBO)},t.updateShadowUBORange=function(e,t){t instanceof jn?jn.toArray(this._shadowUBO,t,e):t instanceof Pn&&Pn.toArray(this._shadowUBO,t,e)},t.destroy=function(){},e}();Py._combineSignY=0;var Ry,Iy,Dy,Oy,My,Ny,Ly,By,Fy,zy,Uy,ky,Gy,Hy=e("RenderStage",(hy=mc("RenderStage"),fy=Vc(),_y=Vc(),py=Vc(),hy((xy=function(){function e(){ce(this,"_name",vy,this),ce(this,"_priority",gy,this),this._enabled=!0,ce(this,"_tag",yy,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,e.tag&&(this._tag=e.tag),!0},t.activate=function(e,t){this._pipeline=e,this._flow=t},Z(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}}]),e}(),vy=le((my=xy).prototype,"_name",[fy,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gy=le(my.prototype,"_priority",[_y,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),yy=le(my.prototype,"_tag",[py,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),dy=my))||dy));u.RenderStage=Hy;var Vy,Wy=e("RenderFlow",(Ry=mc("RenderFlow"),Iy=Vc(),Dy=Vc(),Oy=Vc(),My=Vc(),Ny=Zc([Hy]),Ry((Gy=function(){function e(){ce(this,"_name",Fy,this),ce(this,"_priority",zy,this),ce(this,"_tag",Uy,this),ce(this,"_stages",ky,this)}var t=e.prototype;return t.initialize=function(e){return this._name=e.name,this._priority=e.priority,this._stages=e.stages,e.tag&&(this._tag=e.tag),!0},t.activate=function(e){this._pipeline=e,this._stages.sort((function(e,t){return e.priority-t.priority}));for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].activate(e,this)},t.render=function(e){for(var t=0,n=this._stages.length;t<n;t++)this._stages[t].enabled&&this._stages[t].render(e)},t.destroy=function(){for(var e=0,t=this._stages.length;e<t;e++)this._stages[e].destroy();this._stages.length=0},Z(e,[{key:"name",get:function(){return this._name}},{key:"priority",get:function(){return this._priority}},{key:"tag",get:function(){return this._tag}},{key:"stages",get:function(){return this._stages}},{key:"pipeline",get:function(){return this._pipeline}}]),e}(),Fy=le((By=Gy).prototype,"_name",[Iy,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),zy=le(By.prototype,"_priority",[Dy,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Uy=le(By.prototype,"_tag",[Oy,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ky=le(By.prototype,"_stages",[My,Ny,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ly=By))||Ly));u.RenderFlow=Wy,function(e){e.RENDER_FRAME_BEGIN="render-frame-begin",e.RENDER_FRAME_END="render-frame-end",e.RENDER_CAMERA_BEGIN="render-camera-begin",e.RENDER_CAMERA_END="render-camera-end",e.ATTACHMENT_SCALE_CAHNGED="attachment-scale-changed"}(Vy||(Vy=e("PipelineEventType",{})));var jy,qy,Xy,Yy,Ky,Qy,Zy,Jy,$y,ex,tx,nx,ix,rx,ox,ax=e("PipelineEventProcessor",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t}$(t,e);var n=t.prototype;return n.on=function(e,t,n,i){return this.eventTargetOn(e,t,n,i)},n.once=function(e,t,n){return this.eventTargetOnce(e,t,n)},t}(iu)),sx=new tr,cx=new cr,lx=function(){this.renderPass=null,this.sampler=null,this.prefiterTex=null,this.downsampleTexs=[],this.upsampleTexs=[],this.combineTex=null,this.prefilterFramebuffer=null,this.downsampleFramebuffers=[],this.upsampleFramebuffers=[],this.combineFramebuffer=null},ux=function(){this.quadIB=null,this.quadVB=null,this.quadIA=null},hx=e("RenderPipeline",(jy=mc("cc.RenderPipeline"),qy=Vc(),Xy=Vc(),Yy=Zc([Wy]),jy(($y=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_tag",Zy,oe(t)),ce(t,"_flows",Jy,oe(t)),t._quadIB=null,t._quadVBOnscreen=null,t._quadVBOffscreen=null,t._quadIAOnscreen=null,t._quadIAOffscreen=null,t._eventProcessor=new ax,t._commandBuffers=[],t._pipelineUBO=new Py,t._macros={},t._constantMacros="",t._profiler=null,t._pipelineRenderData=null,t._renderPasses=new Map,t._width=0,t._height=0,t._lastUsedRenderArea=new tr,t._clusterEnabled=!1,t._bloomEnabled=!1,t}$(t,e);var n=t.prototype;return n.getPipelineRenderData=function(){return this._pipelineRenderData},n.initialize=function(e){return this._flows=e.flows,e.tag&&(this._tag=e.tag),!0},n.createRenderPass=function(e,t,n){var i=this._device,r=new Mr,o=new Nr;r.format=t,o.format=n,o.stencilStoreOp=Li.DISCARD,o.depthStoreOp=Li.DISCARD,e&Ki.COLOR||(e&vg?r.loadOp=Ni.DISCARD:(r.loadOp=Ni.LOAD,r.beginAccesses=[Bi.COLOR_ATTACHMENT_WRITE])),(e&Ki.DEPTH_STENCIL)!==Ki.DEPTH_STENCIL&&(e&Ki.DEPTH||(o.depthLoadOp=Ni.LOAD),e&Ki.STENCIL||(o.stencilLoadOp=Ni.LOAD)),o.beginAccesses=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE];var a=new Fr([r],o);return i.createRenderPass(a)},n.getRenderPass=function(e,t){var n=this._renderPasses.get(e);return n||(n=this.createRenderPass(e,t.colorTextures[0].format,t.depthStencilTexture.format),this._renderPasses.set(e,n),n)},n.applyFramebufferRatio=function(e){for(var t=this.pipelineSceneData,n=this._width*t.shadingScale,i=this._height*t.shadingScale,r=e.colorTextures,o=0;o<r.length;o++)r[o].resize(n,i);e.depthStencilTexture&&e.depthStencilTexture.resize(n,i),e.destroy(),e.initialize(new kr(e.renderPass,r,e.depthStencilTexture))},n.generateRenderArea=function(e,t){var n=e.viewport,i=e.window.width,r=e.window.height;t.x=n.x*i,t.y=n.y*r,t.width=n.width*i,t.height=n.height*r},n.generateViewport=function(e,t){this.generateRenderArea(e,sx),t||(t=cx);var n=this.pipelineSceneData.shadingScale;return t.left=sx.x*n,t.top=sx.y*n,t.width=sx.width*n,t.height=sx.height*n,t},n.generateScissor=function(e,t){t||(t=sx),this.generateRenderArea(e,t);var n=this.pipelineSceneData.shadingScale;return t.x*=n,t.y*=n,t.width*=n,t.height*=n,t},n.activate=function(){var e=u.director.root;this._device=e.device,this._generateConstantMacros(),this._globalDSManager=new ly(this),this._descriptorSet=this._globalDSManager.globalDescriptorSet,this._pipelineUBO.activate(this._device,this),this._macros.CC_USE_HDR=this._pipelineSceneData.isHDR,this._generateConstantMacros(),this._pipelineSceneData.activate(this._device,this);for(var t=0;t<this._flows.length;t++)this._flows[t].activate(this);return!0},n._ensureEnoughSize=function(){},n.render=function(e){if(0!==e.length){this._commandBuffers[0].begin(),this.emit(Vy.RENDER_FRAME_BEGIN,e),this._ensureEnoughSize(e),function(e){for(var t=e.length-1;t>=0;--t){var n=e[t];if(n.window.swapchain)return void(ng=n)}ng=null}(e);for(var t=0;t<e.length;t++){var n=e[t];if(n.scene){this.emit(Vy.RENDER_CAMERA_BEGIN,n),ny(this,n),iy(this,n),this._pipelineUBO.updateGlobalUBO(n.window),this._pipelineUBO.updateCameraUBO(n);for(var i=0;i<this._flows.length;i++)this._flows[i].render(n);this.emit(Vy.RENDER_CAMERA_END,n)}}this.emit(Vy.RENDER_FRAME_END,e),this._commandBuffers[0].end(),this._device.queue.submit(this._commandBuffers)}},n._destroyQuadInputAssembler=function(){this._quadIB&&(this._quadIB.destroy(),this._quadIB=null),this._quadVBOnscreen&&(this._quadVBOnscreen.destroy(),this._quadVBOnscreen=null),this._quadVBOffscreen&&(this._quadVBOffscreen.destroy(),this._quadVBOffscreen=null),this._quadIAOnscreen&&(this._quadIAOnscreen.destroy(),this._quadIAOnscreen=null),this._quadIAOffscreen&&(this._quadIAOffscreen.destroy(),this._quadIAOffscreen=null)},n._destroyBloomData=function(){var e,t=this._pipelineRenderData.bloom;if(null!==t){t.prefiterTex&&t.prefiterTex.destroy(),t.prefilterFramebuffer&&t.prefilterFramebuffer.destroy();for(var n=0;n<t.downsampleTexs.length;++n)t.downsampleTexs[n].destroy(),t.downsampleFramebuffers[n].destroy();t.downsampleTexs.length=0,t.downsampleFramebuffers.length=0;for(var i=0;i<t.upsampleTexs.length;++i)t.upsampleTexs[i].destroy(),t.upsampleFramebuffers[i].destroy();t.upsampleTexs.length=0,t.upsampleFramebuffers.length=0,t.combineTex&&t.combineTex.destroy(),t.combineFramebuffer&&t.combineFramebuffer.destroy(),null===(e=t.renderPass)||void 0===e||e.destroy(),this._pipelineRenderData.bloom=null}},n._genQuadVertexData=function(e,t){var n=new Float32Array(16),i=t.x/this._width,r=(t.x+t.width)/this._width,o=t.y/this._height,a=(t.y+t.height)/this._height;if(this.device.capabilities.screenSpaceSignY>0){var s=a;a=o,o=s}var c=0;switch(e){case fi.IDENTITY:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=o;break;case fi.ROTATE_90:c=0,n[c++]=-1,n[c++]=-1,n[c++]=r,n[c++]=a,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=i,n[c++]=o;break;case fi.ROTATE_180:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=r,n[c++]=o,n[c++]=-1,n[c++]=1,n[c++]=i,n[c++]=a,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a;break;case fi.ROTATE_270:c=0,n[c++]=-1,n[c++]=-1,n[c++]=i,n[c++]=o,n[c++]=1,n[c++]=-1,n[c++]=i,n[c++]=a,n[c++]=-1,n[c++]=1,n[c++]=r,n[c++]=o,n[c++]=1,n[c++]=1,n[c++]=r,n[c++]=a}return n},n._createQuadInputAssembler=function(){var e=new ux,t=4*Float32Array.BYTES_PER_ELEMENT,n=4*t,i=this._device.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE|xi.HOST,n,t));if(!i)return e;var r=Uint8Array.BYTES_PER_ELEMENT,o=6*r,a=this._device.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,o,r));if(!a)return e;var s=new Uint8Array(6);s[0]=0,s[1]=1,s[2]=2,s[3]=1,s[4]=3,s[5]=2,a.update(s);var c=new Array(2);c[0]=new Ir("a_position",pi.RG32F),c[1]=new Ir("a_texCoord",pi.RG32F);var l=this._device.createInputAssembler(new Or(c,[i],a));return e.quadIB=a,e.quadVB=i,e.quadIA=l,e},n.updateQuadVertexData=function(e,t){var n=this._lastUsedRenderArea;if(n.x!==e.x||n.y!==e.y||n.width!==e.width||n.height!==e.height){var i=this._genQuadVertexData(fi.IDENTITY,e);this._quadVBOffscreen.update(i);var r=this._genQuadVertexData(t.swapchain&&t.swapchain.surfaceTransform||fi.IDENTITY,e);this._quadVBOnscreen.update(r),n.copy(e)}},n.destroy=function(){for(var t,n,i=0;i<this._flows.length;i++)this._flows[i].destroy();this._flows.length=0,this._descriptorSet&&this._descriptorSet.destroy(),null===(t=this._globalDSManager)||void 0===t||t.destroy();for(var r=0;r<this._commandBuffers.length;r++)this._commandBuffers[r].destroy();return this._commandBuffers.length=0,this._pipelineUBO.destroy(),null===(n=this._pipelineSceneData)||void 0===n||n.destroy(),e.prototype.destroy.call(this)},n._generateConstantMacros=function(){var e="";e+="#define CC_DEVICE_SUPPORT_FLOAT_TEXTURE "+(this.device.hasFeature(_i.TEXTURE_FLOAT)?1:0)+"\n",e+="#define CC_ENABLE_CLUSTERED_LIGHT_CULLING "+(this._clusterEnabled?1:0)+"\n",e+="#define CC_DEVICE_MAX_VERTEX_UNIFORM_VECTORS "+this.device.capabilities.maxVertexUniformVectors+"\n",e+="#define CC_DEVICE_MAX_FRAGMENT_UNIFORM_VECTORS "+this.device.capabilities.maxFragmentUniformVectors+"\n",e+="#define CC_DEVICE_CAN_BENEFIT_FROM_INPUT_ATTACHMENT "+(this.device.hasFeature(_i.INPUT_ATTACHMENT_BENEFIT)?1:0)+"\n",e+="#define CC_PLATFORM_ANDROID_AND_WEBGL "+(vu.os===cu.ANDROID&&vu.isBrowser?1:0)+"\n",e+="#define CC_ENABLE_WEBGL_HIGHP_STRUCT_VALUES "+(ft.ENABLE_WEBGL_HIGHP_STRUCT_VALUES?1:0)+"\n",this._constantMacros=e},n.generateBloomRenderData=function(){if(null==this._pipelineRenderData.bloom){var e=this._pipelineRenderData.bloom=new lx,t=this.device,n=new Mr;n.format=pi.RGBA8,n.loadOp=Ni.CLEAR,n.storeOp=Li.STORE,n.endAccesses=[Bi.COLOR_ATTACHMENT_WRITE],e.renderPass=t.createRenderPass(new Fr([n]));var i=this._width,r=this._height;e.prefiterTex=t.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,pi.RGBA8,i>>1,r>>1)),e.prefilterFramebuffer=t.createFramebuffer(new kr(e.renderPass,[e.prefiterTex])),i>>=1,r>>=1;for(var o=0;o<6;++o)e.downsampleTexs.push(t.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,pi.RGBA8,i>>1,r>>1))),e.downsampleFramebuffers[o]=t.createFramebuffer(new kr(e.renderPass,[e.downsampleTexs[o]])),e.upsampleTexs.push(t.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,pi.RGBA8,i,r))),e.upsampleFramebuffers[o]=t.createFramebuffer(new kr(e.renderPass,[e.upsampleTexs[o]])),i>>=1,r>>=1;e.combineTex=t.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,pi.RGBA8,this._width,this._height)),e.combineFramebuffer=t.createFramebuffer(new kr(e.renderPass,[e.combineTex])),e.sampler=this.globalDSManager.linearSampler}},n.on=function(e,t,n,i){return this._eventProcessor.on(e,t,n,i)},n.once=function(e,t,n){return this._eventProcessor.once(e,t,n)},n.off=function(e,t,n){this._eventProcessor.off(e,t,n)},n.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},n.targetOff=function(e){this._eventProcessor.targetOff(e)},n.removeAll=function(e){this._eventProcessor.removeAll(e)},n.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},Z(t,[{key:"tag",get:function(){return this._tag}},{key:"flows",get:function(){return this._flows}},{key:"quadIAOnscreen",get:function(){return this._quadIAOnscreen}},{key:"quadIAOffscreen",get:function(){return this._quadIAOffscreen}},{key:"constantMacros",get:function(){return this._constantMacros}},{key:"macros",get:function(){return this._macros}},{key:"device",get:function(){return this._device}},{key:"globalDSManager",get:function(){return this._globalDSManager}},{key:"descriptorSetLayout",get:function(){return this._globalDSManager.descriptorSetLayout}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"commandBuffers",get:function(){return this._commandBuffers}},{key:"pipelineUBO",get:function(){return this._pipelineUBO}},{key:"pipelineSceneData",get:function(){return this._pipelineSceneData}},{key:"profiler",get:function(){return this._profiler},set:function(e){this._profiler=e}},{key:"clusterEnabled",get:function(){return this._clusterEnabled},set:function(e){this._clusterEnabled=e}},{key:"bloomEnabled",get:function(){return this._bloomEnabled},set:function(e){this._bloomEnabled=e}}]),t}(Nu),Zy=le((Qy=$y).prototype,"_tag",[qy,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jy=le(Qy.prototype,"_flows",[Xy,Yy,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ky=Qy))||Ky));u.RenderPipeline=hx,function(e){e[e.BLOOM=18]="BLOOM",e[e.POST_PROCESS=19]="POST_PROCESS",e[e.UI=20]="UI"}(ex||(ex={})),function(e){e[e.FORWARD=10]="FORWARD"}(tx||(tx={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.FORWARD=1]="FORWARD",e[e.UI=10]="UI"}(nx||(nx={})),function(e){e[e.GBUFFER=10]="GBUFFER",e[e.LIGHTING=15]="LIGHTING",e[e.TRANSPARENT=18]="TRANSPARENT"}(ix||(ix={})),function(e){e[e.SHADOW=0]="SHADOW",e[e.MAIN=1]="MAIN",e[e.UI=10]="UI"}(rx||(rx={}));var fx=new Mr;fx.format=pi.RGBA8,fx.beginAccesses=[Bi.FRAGMENT_SHADER_READ_TEXTURE],fx.endAccesses=[Bi.FRAGMENT_SHADER_READ_TEXTURE];var _x=new Nr;_x.format=pi.DEPTH_STENCIL;var px,dx,mx,vx,gx,yx,xx,Sx,Tx,bx,Ex,Cx,Ax,wx,Px,Rx,Ix,Dx,Ox,Mx,Nx,Lx,Bx,Fx,zx,Ux,kx,Gx,Hx,Vx,Wx,jx,qx,Xx,Yx,Kx,Qx,Zx,Jx,$x,eS,tS,nS,iS,rS,oS,aS,sS,cS,lS,uS,hS,fS,_S,pS,dS,mS,vS,gS,yS,xS,SS,TS,bS,ES,CS,AS,wS,PS,RS,IS,DS,OS,MS,NS,LS,BS,FS,zS,US=new Fr([fx],_x),kS={width:1,height:1,renderPassInfo:US},GS=e("RenderTexture",mc("cc.RenderTexture")(ox=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._window=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name||"",this._width=e.width,this._height=e.height,this._initWindow(e)},n.reset=function(e){this.initialize(e)},n.destroy=function(){if(this._window){var t=u.director.root;null==t||t.destroyWindow(this._window),this._window=null}return e.prototype.destroy.call(this)},n.resize=function(e,t){this._width=Math.floor(ln(e,1,2048)),this._height=Math.floor(ln(t,1,2048)),this._window&&this._window.resize(this._width,this._height),this.emit("resize",this._window)},n._serialize=function(){return{}},n._deserialize=function(t,n){var i=t;this._width=i.w,this._height=i.h,this._name=i.n,e.prototype._deserialize.call(this,i.base,n)},n.getGFXTexture=function(){return this._window&&this._window.framebuffer.colorTextures[0]},n.onLoaded=function(){this._initWindow()},n._initWindow=function(e){var t=u.director.root;kS.title=this._name,kS.width=this._width,kS.height=this._height,kS.renderPassInfo=e&&e.passInfo?e.passInfo:US,this._window?(this._window.destroy(),this._window.initialize(t.device,kS)):this._window=t.createWindow(kS)},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this._width=this._height=1,this._initWindow()},n.validate=function(){return this.width>=1&&this.width<=2048&&this.height>=1&&this.height<=2048},n.readPixels=function(e,t,n,i,r){void 0===e&&(e=0),void 0===t&&(t=0),n=n||this.width,i=i||this.height;var o=this.getGFXTexture();if(!o)return M(7606),null;var a=4*n*i;if(void 0===r)r=new Uint8Array(a);else if(r.length<a)return M(7607,a),null;var s=this._getGFXDevice(),c=[],l=[],u=new sr;return u.texOffset.x=e,u.texOffset.y=t,u.texExtent.width=n,u.texExtent.height=i,l.push(u),c.push(r),null==s||s.copyTextureToBuffers(o,c,l),r},Z(t,[{key:"window",get:function(){return this._window}}]),t}(ev))||ox);u.RenderTexture=GS,ut(Si),ut(Ti),ut(Li),ut(Ni),ut(Bi),function(e){e[e.SCENE=0]="SCENE",e[e.POSTPROCESS=1]="POSTPROCESS",e[e.UI=2]="UI"}(zS||(zS={})),ut(zS),px=mc("RenderTextureDesc"),dx=Zc(Si),mx=Zc(Ti),vx=Zc(pi),px((yx=le((gx=function(){ce(this,"name",yx,this),ce(this,"type",xx,this),ce(this,"usage",Sx,this),ce(this,"format",Tx,this),ce(this,"width",bx,this),ce(this,"height",Ex,this)}).prototype,"name",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xx=le(gx.prototype,"type",[dx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Si.TEX2D}}),Sx=le(gx.prototype,"usage",[mx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ti.COLOR_ATTACHMENT}}),Tx=le(gx.prototype,"format",[vx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pi.UNKNOWN}}),bx=le(gx.prototype,"width",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),Ex=le(gx.prototype,"height",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),gx));var HS,VS=(Cx=mc("RenderTextureConfig"),Ax=Zc(GS),Cx((Rx=le((Px=function(){ce(this,"name",Rx,this),ce(this,"texture",Ix,this)}).prototype,"name",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Ix=le(Px.prototype,"texture",[Ax],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wx=Px))||wx),WS=(Dx=mc("MaterialConfig"),Ox=Zc(ug),Dx((Nx=le((Mx=function(){ce(this,"name",Nx,this),ce(this,"material",Lx,this)}).prototype,"name",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Lx=le(Mx.prototype,"material",[Ox],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Mx)),Bx=mc("FrameBufferDesc"),Fx=Zc([Ft]),zx=Zc(GS),Bx((kx=le((Ux=function(){ce(this,"name",kx,this),ce(this,"renderPass",Gx,this),ce(this,"colorTextures",Hx,this),ce(this,"depthStencilTexture",Vx,this),ce(this,"texture",Wx,this)}).prototype,"name",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Gx=le(Ux.prototype,"renderPass",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hx=le(Ux.prototype,"colorTextures",[Fx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Vx=le(Ux.prototype,"depthStencilTexture",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Wx=le(Ux.prototype,"texture",[zx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Ux)),jx=mc("ColorDesc"),qx=Zc(pi),Xx=Zc(Ni),Yx=Zc(Li),Kx=Zc([Bi]),Qx=Zc([Bi]),jx(($x=le((Jx=function(){ce(this,"format",$x,this),ce(this,"loadOp",eS,this),ce(this,"storeOp",tS,this),ce(this,"sampleCount",nS,this),ce(this,"beginAccesses",iS,this),ce(this,"endAccesses",rS,this)}).prototype,"format",[qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pi.UNKNOWN}}),eS=le(Jx.prototype,"loadOp",[Xx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ni.CLEAR}}),tS=le(Jx.prototype,"storeOp",[Yx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.STORE}}),nS=le(Jx.prototype,"sampleCount",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),iS=le(Jx.prototype,"beginAccesses",[Kx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rS=le(Jx.prototype,"endAccesses",[Qx],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Bi.COLOR_ATTACHMENT_WRITE]}}),Zx=Jx))||Zx),jS=(oS=mc("DepthStencilDesc"),aS=Zc(pi),sS=Zc(Ni),cS=Zc(Li),lS=Zc(Ni),uS=Zc(Li),hS=Zc([Bi]),fS=Zc([Bi]),oS((dS=le((pS=function(){ce(this,"format",dS,this),ce(this,"depthLoadOp",mS,this),ce(this,"depthStoreOp",vS,this),ce(this,"stencilLoadOp",gS,this),ce(this,"stencilStoreOp",yS,this),ce(this,"sampleCount",xS,this),ce(this,"beginAccesses",SS,this),ce(this,"endAccesses",TS,this)}).prototype,"format",[aS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pi.UNKNOWN}}),mS=le(pS.prototype,"depthLoadOp",[sS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ni.CLEAR}}),vS=le(pS.prototype,"depthStoreOp",[cS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.STORE}}),gS=le(pS.prototype,"stencilLoadOp",[lS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ni.CLEAR}}),yS=le(pS.prototype,"stencilStoreOp",[uS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Li.STORE}}),xS=le(pS.prototype,"sampleCount",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),SS=le(pS.prototype,"beginAccesses",[hS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),TS=le(pS.prototype,"endAccesses",[fS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE]}}),_S=pS))||_S);bS=mc("RenderPassDesc"),ES=Zc([WS]),CS=Zc(jS),bS((wS=le((AS=function(){ce(this,"index",wS,this),ce(this,"colorAttachments",PS,this),ce(this,"depthStencilAttachment",RS,this)}).prototype,"index",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),PS=le(AS.prototype,"colorAttachments",[ES],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RS=le(AS.prototype,"depthStencilAttachment",[CS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jS}}),AS)),function(e){e[e.FRONT_TO_BACK=0]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=1]="BACK_TO_FRONT"}(HS||(HS={})),ut(HS);var qS=(IS=mc("RenderQueueDesc"),DS=Zc(HS),OS=Zc([Ft]),IS((LS=le((NS=function(){ce(this,"isTransparent",LS,this),ce(this,"sortMode",BS,this),ce(this,"stages",FS,this)}).prototype,"isTransparent",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),BS=le(NS.prototype,"sortMode",[DS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return HS.FRONT_TO_BACK}}),FS=le(NS.prototype,"stages",[OS],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),MS=NS))||MS);function XS(e,t){return e.hash-t.hash||e.depth-t.depth||e.shaderId-t.shaderId}function YS(e,t){return e.hash-t.hash||t.depth-e.depth||e.shaderId-t.shaderId}var KS=function(){function e(e){this.queue=void 0,this._passDesc=void 0,this._passPool=void 0,this._passDesc=e,this._passPool=new Xl((function(){return{hash:0,depth:0,shaderId:0,subModel:null,passIdx:0}}),64),this.queue=new Yl(64,this._passDesc.sortFunc)}var t=e.prototype;return t.clear=function(){this.queue.clear(),this._passPool.reset()},t.insertRenderPass=function(e,t,n){var i=e.model.subModels[t],r=i.passes[n],o=i.shaders[n];if(r.blendState.targets[0].blend!==this._passDesc.isTransparent||!(r.phase&this._passDesc.phases))return!1;var a=0|r.priority<<16|i.priority<<8|n,s=this._passPool.add();return s.hash=a,s.depth=e.depth||0,s.shaderId=o.typedID,s.subModel=i,s.passIdx=n,this.queue.push(s),!0},t.sort=function(){this.queue.sort()},t.recordCommandBuffer=function(e,t,n){for(var i=0;i<this.queue.length;++i){var r=this.queue.array[i],o=r.subModel,a=r.passIdx,s=o.inputAssembler,c=o.passes[a],l=o.shaders[a],u=Hv.getOrCreatePipelineState(e,c,l,t,s);n.bindPipelineState(u),n.bindDescriptorSet(Kp.MATERIAL,c.descriptorSet),n.bindDescriptorSet(Kp.LOCAL,o.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}();function QS(e){for(var t=0,n=0;n<e.stages.length;n++)t|=Lv(e.stages[n]);var i=XS;switch(e.sortMode){case HS.BACK_TO_FRONT:i=YS;break;case HS.FRONT_TO_BACK:i=XS}return new KS({isTransparent:e.isTransparent,phases:t,sortFunc:i})}function ZS(e){e.clear()}function JS(e){e.sort()}var $S=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;){for(var i=0;i<n.value.batches.length;++i){var r=n.value.batches[i];if(r.mergeCount){for(var o=0;o<r.vbs.length;++o)r.vbs[o].update(r.vbDatas[o]);e.updateBuffer(r.vbIdx,r.vbIdxData.buffer),e.updateBuffer(r.ubo,r.uboData)}}n=t.next()}},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){for(var o=!1,a=0;a<r.value.batches.length;++a){var s=r.value.batches[a];if(s.mergeCount){if(!o){var c=s.shader,l=Hv.getOrCreatePipelineState(e,s.pass,c,t,s.ia);n.bindPipelineState(l),n.bindDescriptorSet(Kp.MATERIAL,s.pass.descriptorSet),o=!0}n.bindDescriptorSet(Kp.LOCAL,s.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(s.ia),n.draw(s.ia)}}r=i.next()}},e}(),eT=function(){function e(){this.queue=new Set}var t=e.prototype;return t.clear=function(){for(var e=this.queue.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this.queue.clear()},t.uploadBuffers=function(e){for(var t=this.queue.values(),n=t.next();!n.done;)n.value.hasPendingModels&&n.value.uploadBuffers(e),n=t.next()},t.recordCommandBuffer=function(e,t,n){for(var i=this.queue.values(),r=i.next();!r.done;){var o=r.value,a=o.instances,s=o.pass;if(o.hasPendingModels){n.bindDescriptorSet(Kp.MATERIAL,s.descriptorSet);for(var c=null,l=0;l<a.length;++l){var u=a[l];if(u.count){var h=u.shader,f=Hv.getOrCreatePipelineState(e,s,h,t,u.ia);c!==f&&(n.bindPipelineState(f),c=f),n.bindDescriptorSet(Kp.LOCAL,u.descriptorSet,r.value.dynamicOffsets),n.bindInputAssembler(u.ia),n.draw(u.ia)}}}r=i.next()}},e}(),tT=function(){function e(){this._groundAlbedoHDR=new $n(.2,.2,.2,1),this._skyColorHDR=new $n(.2,.5,.8,1),this._skyIllumHDR=0,this._groundAlbedoLDR=new $n(.2,.2,.2,1),this._skyColorLDR=new $n(.2,.5,.8,1),this._skyIllumLDR=0,this._mipmapCount=1,this._enabled=!1}var t=e.prototype;return t.initialize=function(e){this._skyColorHDR=e.skyColorHDR,this._groundAlbedoHDR.set(e.groundAlbedoHDR),this._skyIllumHDR=e.skyIllumHDR,this._skyColorLDR=e.skyColorLDR,this._groundAlbedoLDR.set(e.groundAlbedoLDR),this._skyIllumLDR=e.skyIllumLDR},t._destroy=function(){},t.destroy=function(){this._destroy()},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"skyColor",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR:this._skyColorLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e)}},{key:"skyIllum",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e}},{key:"groundAlbedo",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR:this._groundAlbedoLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e)}},{key:"mipmapCount",get:function(){return this._mipmapCount},set:function(e){this._mipmapCount=e}},{key:"native",get:function(){return this._nativeObj}}]),e}();tT.SUN_ILLUM=65e3,tT.SKY_ILLUM=2e4,u.Ambient=tT;var nT,iT=function(){function e(){this._enabled=!1,this._minPos=new In(0,0,0),this._maxPos=new In(0,0,0),this._depth=0}var t=e.prototype;return t.initialize=function(e){this._enabled=e.enabled,this._minPos=e.minPos,this._maxPos=e.maxPos,this._depth=e.depth},t._destroy=function(){},t.destroy=function(){this._destroy()},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),rT=new Vr(null),oT=function(){function e(){this._device=null,this._passes=null,this._shaders=null,this._subMesh=null,this._patches=null,this._priority=Up.DEFAULT,this._inputAssembler=null,this._descriptorSet=null,this._worldBoundDescriptorSet=null,this._planarInstanceShader=null,this._planarShader=null,this._reflectionTex=null,this._reflectionSampler=null}var t=e.prototype;return t._destroyDescriptorSet=function(){this._descriptorSet.destroy(),this._descriptorSet=null},t._destroyWorldBoundDescriptorSet=function(){this._worldBoundDescriptorSet.destroy(),this._worldBoundDescriptorSet=null},t._destroyInputAssembler=function(){this._inputAssembler.destroy(),this._inputAssembler=null},t._createDescriptorSet=function(e){this._descriptorSet=this._device.createDescriptorSet(e)},t._createWorldBoundDescriptorSet=function(e){this._worldBoundDescriptorSet=this._device.createDescriptorSet(e)},t._setInputAssembler=function(e){this._inputAssembler=this._device.createInputAssembler(e)},t._setSubMesh=function(e){this._subMesh=e},t._init=function(){},t.initialize=function(e,t,n){void 0===n&&(n=null);var i=u.director.root;this._device=i.device,rT.layout=t[0].localSetLayout,this._init(),this._setInputAssembler(e.iaInfo),this._createDescriptorSet(rT);var r=u.director.root.pipeline.pipelineSceneData.getOcclusionQueryPass(),o=new Vr(null);if(o.layout=r.localSetLayout,this._createWorldBoundDescriptorSet(o),this._setSubMesh(e),this._patches=n,this._passes=t,this._flushPassInfo(),t[0].batchingScheme===Iv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this.priority=Up.DEFAULT,t[0].phase===Lv("reflection")){var a=i.mainWindow.width,s=i.mainWindow.height,c=512;s<a?(a=c*a/s,s=c):s=c*s/(a=c),this._reflectionTex=this._device.createTexture(new gr(Si.TEX2D,Ti.STORAGE|Ti.TRANSFER_SRC|Ti.SAMPLED,pi.RGBA8,a,s)),this.descriptorSet.bindTexture(Wd,this._reflectionTex),this._reflectionSampler=this._device.getSampler(new xr(Ai.LINEAR,Ai.LINEAR,Ai.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP)),this.descriptorSet.bindSampler(Wd,this._reflectionSampler),this.descriptorSet.bindTexture(Xd,this._reflectionTex)}},t._initNativePlanarShadowShader=function(e){this._planarShader=e.getPlanarShader(this._patches)},t.initPlanarShadowShader=function(){var e=u.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowShader(e)},t._initNativePlanarShadowInstanceShader=function(e){this._planarInstanceShader=e.getPlanarInstanceShader(this._patches)},t.initPlanarShadowInstanceShader=function(){var e=u.director.root.pipeline.pipelineSceneData.shadows;this._initNativePlanarShadowInstanceShader(e)},t._destroy=function(){},t.destroy=function(){this._destroyDescriptorSet(),this._destroyWorldBoundDescriptorSet(),this._destroyInputAssembler(),this.priority=Up.DEFAULT,this._patches=null,this._subMesh=null,this._passes=null,this._shaders=null,this._reflectionTex&&this._reflectionTex.destroy(),this._reflectionTex=null,this._reflectionSampler=null,this._destroy()},t.update=function(){for(var e=0;e<this._passes.length;++e)this._passes[e].update();this._descriptorSet.update(),this._worldBoundDescriptorSet.update()},t.onPipelineStateChanged=function(){var e=this._passes;if(e){for(var t=0;t<e.length;t++){var n=e[t];n.beginChangeStatesSilently(),n.tryCompile(),n.endChangeStatesSilently()}this._flushPassInfo()}},t.onMacroPatchesStateChanged=function(e){this._patches=e;var t=this._passes;if(t){for(var n=0;n<t.length;n++){var i=t[n];i.beginChangeStatesSilently(),i.tryCompile(),i.endChangeStatesSilently()}this._flushPassInfo()}},t._flushPassInfo=function(){var e=this._passes;if(e){this._shaders||(this._shaders=[]),this._shaders.length=e.length;for(var t=0,n=e.length;t<n;t++)this._shaders[t]=e[t].getShaderVariant(this.patches)}},Z(e,[{key:"passes",get:function(){return this._passes},set:function(e){e.length>8?M(12004,8):(this._passes=e,this._flushPassInfo(),this._passes[0].batchingScheme===Iv.VB_MERGING&&(this.subMesh.genFlatBuffers(),this._setSubMesh(this.subMesh)),this._descriptorSet&&(this._destroyDescriptorSet(),rT.layout=e[0].localSetLayout,this._createDescriptorSet(rT)))}},{key:"shaders",get:function(){return this._shaders}},{key:"subMesh",get:function(){return this._subMesh},set:function(e){this._inputAssembler.destroy(),this._inputAssembler.initialize(e.iaInfo),this._passes[0].batchingScheme===Iv.VB_MERGING&&this.subMesh.genFlatBuffers(),this._setSubMesh(e)}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"inputAssembler",get:function(){return this._inputAssembler}},{key:"descriptorSet",get:function(){return this._descriptorSet}},{key:"worldBoundDescriptorSet",get:function(){return this._worldBoundDescriptorSet}},{key:"patches",get:function(){return this._patches}},{key:"planarInstanceShader",get:function(){return this._planarInstanceShader}},{key:"planarShader",get:function(){return this._planarShader}},{key:"native",get:function(){return this._nativeObj}}]),e}(),aT=new jn,sT=[{name:"CC_RECEIVE_SHADOW",value:!0}];!function(e){e[e.DEFAULT=0]="DEFAULT",e[e.SKINNING=1]="SKINNING",e[e.BAKED_SKINNING=2]="BAKED_SKINNING",e[e.BATCH_2D=3]="BATCH_2D",e[e.PARTICLE_BATCH=4]="PARTICLE_BATCH",e[e.LINE=5]="LINE"}(nT||(nT={}));var cT=new xr(Ai.LINEAR,Ai.LINEAR,Ai.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),lT=new xr(Ai.LINEAR,Ai.LINEAR,Ai.LINEAR,wi.CLAMP,wi.CLAMP,wi.CLAMP),uT=function(){function e(){this.type=nT.DEFAULT,this.scene=null,this.isDynamicBatching=!1,this.instancedAttributes={buffer:null,views:[],attributes:[]},this._worldBounds=null,this._modelBounds=null,this._subModels=[],this._node=null,this._transform=null,this._device=void 0,this._inited=!1,this._descriptorSetCount=1,this._updateStamp=-1,this._localDataUpdated=!0,this._localData=new Float32Array(pd.COUNT),this._localBuffer=null,this._instMatWorldIdx=-1,this._lightmap=null,this._lightmapUVParam=new $n,this._worldBoundBuffer=null,this._receiveShadow=!1,this._castShadow=!1,this._enabled=!0,this._visFlags=Fp.Enum.NONE,this._device=u.director.root.device}var t=e.prototype;return t._setReceiveShadow=function(e){this._receiveShadow=e},t._init=function(){},t.initialize=function(){this._inited||(this._init(),this._setReceiveShadow(!0),this.castShadow=!1,this.enabled=!0,this.visFlags=Fp.Enum.NONE,this._inited=!0)},t._destroySubmodel=function(e){e.destroy()},t._destroy=function(){},t.destroy=function(){for(var e=this._subModels,t=0;t<e.length;t++){var n=this._subModels[t];this._destroySubmodel(n)}this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._worldBoundBuffer&&(this._worldBoundBuffer.destroy(),this._worldBoundBuffer=null),this._worldBounds=null,this._modelBounds=null,this._subModels.length=0,this._inited=!1,this._localDataUpdated=!0,this._transform=null,this._node=null,this.isDynamicBatching=!1,this._destroy()},t.attachToScene=function(e){this.scene=e,this._localDataUpdated=!0},t.detachFromScene=function(){this.scene=null},t.updateTransform=function(){var e=this.transform;if(e.hasChangedFlags||e._dirtyFlags){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t.updateWorldBound=function(){var e=this.transform;if(null!==e){e.updateWorldTransform(),this._localDataUpdated=!0;var t=this._worldBounds;this._modelBounds&&t&&this._modelBounds.transform(e._mat,e._pos,e._rot,e._scale,t)}},t._applyLocalData=function(){},t._applyLocalBuffer=function(){},t._applyWorldBoundBuffer=function(){},t.updateUBOs=function(e){for(var t=this._subModels,n=0;n<t.length;n++)t[n].update();if(this._updateStamp=e,this._localDataUpdated){this._localDataUpdated=!1;var i=this.transform._mat,r=this._instMatWorldIdx;if(r>=0){var o=this.instancedAttributes.views;!function(e,t,n,i){t[0]=e.m00,t[1]=e.m01,t[2]=e.m02,t[3]=e.m12,n[0]=e.m04,n[1]=e.m05,n[2]=e.m06,n[3]=e.m13,i[0]=e.m08,i[1]=e.m09,i[2]=e.m10,i[3]=e.m14}(i,o[r],o[r+1],o[r+2])}else if(this._localBuffer){jn.toArray(this._localData,i,pd.MAT_WORLD_OFFSET),jn.inverseTranspose(aT,i);var a=Math.abs(jn.determinant(aT)),s=1/Math.sqrt(a);jn.multiplyScalar(aT,aT,s),jn.toArray(this._localData,aT,pd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._applyLocalData(),this._applyLocalBuffer()}}},t._updateNativeBounds=function(){},t.createBoundingShape=function(e,t){e&&t&&(this._modelBounds=Xs.fromPoints(Xs.create(),e,t),this._worldBounds=Xs.clone(this._modelBounds),this._updateNativeBounds())},t._createSubModel=function(){return new oT},t.initSubModel=function(e,t,n){this.initialize(),null==this._subModels[e]?this._subModels[e]=this._createSubModel():this._subModels[e].destroy(),this._subModels[e].initialize(t,n.passes,this.getMacroPatches(e)),this._subModels[e].initPlanarShadowShader(),this._subModels[e].initPlanarShadowInstanceShader(),this._updateAttributesAndBinding(e)},t.setSubModelMesh=function(e,t){this._subModels[e]&&(this._subModels[e].subMesh=t)},t.setSubModelMaterial=function(e,t){this._subModels[e]&&(this._subModels[e].passes=t.passes,this._updateAttributesAndBinding(e))},t.onGlobalPipelineStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onPipelineStateChanged()},t.onMacroPatchesStateChanged=function(){for(var e=this._subModels,t=0;t<e.length;t++)e[t].onMacroPatchesStateChanged(this.getMacroPatches(t))},t.updateLightingmap=function(e,t){$n.toArray(this._localData,t,pd.LIGHTINGMAP_UVPARAM),this._localDataUpdated=!0,this._lightmap=e,this._lightmapUVParam=t,null===e&&(e=Nv.get("empty-texture"));var n=e.getGFXTexture();if(n)for(var i=this._device.getSampler(e.mipmaps.length>1?lT:cT),r=this._subModels,o=0;o<r.length;o++){var a=r[o].descriptorSet;a.bindTexture(zd,n),a.bindSampler(zd,i),a.update()}},t.getMacroPatches=function(){return this.receiveShadow?sT:null},t._updateAttributesAndBinding=function(e){var t=this._subModels[e];if(t){this._initLocalDescriptors(e),this._updateLocalDescriptors(e,t.descriptorSet),this._initWorldBoundDescriptors(e),this._updateWorldBoundDescriptors(e,t.worldBoundDescriptorSet);var n=t.passes[0].getShaderVariant(t.patches);this._updateInstancedAttributes(n.attributes,t.passes[0])}},t._getInstancedAttributeIndex=function(e){for(var t=this.instancedAttributes.attributes,n=0;n<t.length;n++)if(t[n].name===e)return n;return-1},t._setInstMatWorldIdx=function(e){this._instMatWorldIdx=e},t._updateInstancedAttributes=function(e,t){if(t.device.hasFeature(_i.INSTANCED_ARRAYS)){for(var n=0,i=0;i<e.length;i++){var r=e[i];r.isInstanced&&(n+=eo[r.format].size)}var o=this.instancedAttributes;o.buffer=new Uint8Array(n),o.views.length=o.attributes.length=0;for(var a=0,s=0;s<e.length;s++){var c=e[s];if(c.isInstanced){var l=new Ir;l.format=c.format,l.name=c.name,l.isNormalized=c.isNormalized,l.location=c.location,o.attributes.push(l);var u=eo[c.format],h=new(uo(u))(o.buffer.buffer,a,u.count);o.views.push(h),a+=u.size}}t.batchingScheme===Iv.INSTANCING&&t.getInstancedBuffer().destroy(),this._setInstMatWorldIdx(this._getInstancedAttributeIndex(md)),this._localDataUpdated=!0}},t._initLocalDescriptors=function(){this._localBuffer||(this._localBuffer=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.DEVICE,pd.SIZE,pd.SIZE)),this._applyLocalBuffer())},t._initWorldBoundDescriptors=function(){this._worldBoundBuffer||(this._worldBoundBuffer=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.DEVICE,dd.SIZE,dd.SIZE)),this._applyWorldBoundBuffer())},t._updateLocalDescriptors=function(e,t){this._localBuffer&&t.bindBuffer(pd.BINDING,this._localBuffer)},t._updateWorldBoundDescriptors=function(e,t){this._worldBoundBuffer&&t.bindBuffer(dd.BINDING,this._worldBoundBuffer)},Z(e,[{key:"subModels",get:function(){return this._subModels}},{key:"inited",get:function(){return this._inited}},{key:"worldBounds",get:function(){return this._worldBounds}},{key:"modelBounds",get:function(){return this._modelBounds}},{key:"localBuffer",get:function(){return this._localBuffer}},{key:"worldBoundBuffer",get:function(){return this._worldBoundBuffer}},{key:"updateStamp",get:function(){return this._updateStamp}},{key:"isInstancingEnabled",get:function(){return this._instMatWorldIdx>=0}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._setReceiveShadow(e),this.onMacroPatchesStateChanged()}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"node",get:function(){return this._node},set:function(e){this._node=e}},{key:"transform",get:function(){return this._transform},set:function(e){this._transform=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled=e}},{key:"native",get:function(){return this._nativeObj}}]),e}(),hT=function(){function e(e){this._root=void 0,this._name="",this._cameras=[],this._models=[],this._batches=[],this._directionalLights=[],this._sphereLights=[],this._spotLights=[],this._mainLight=null,this._modelId=0,this._root=e,this._createNativeObject()}e.registerCreateFunc=function(t){t._createSceneFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e){return this._name=e.name,!0},t.activate=function(){},t.update=function(e){var t=this._mainLight;t&&t.update();for(var n=this._sphereLights,i=0;i<n.length;i++)n[i].update();for(var r=this._spotLights,o=0;o<r.length;o++)r[o].update();for(var a=this._models,s=0;s<a.length;s++){var c=a[s];c.enabled&&(c.updateTransform(e),c.updateUBOs(e))}},t._destroy=function(){},t.destroy=function(){this.removeCameras(),this.removeSphereLights(),this.removeSpotLights(),this.removeModels(),this._destroy()},t.addCamera=function(e){e.attachToScene(this),this._cameras.push(e)},t.removeCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return this._cameras.splice(t,1),void e.detachFromScene()},t.removeCameras=function(){for(var e,t=se(this._cameras);!(e=t()).done;)e.value.detachFromScene();this._cameras.splice(0)},t.setMainLight=function(e){this._mainLight=e},t.unsetMainLight=function(e){if(this._mainLight===e){var t=this._directionalLights;if(t.length)return this.setMainLight(t[t.length-1]),void(this._mainLight.node&&(this._mainLight.node.hasChangedFlags|=oy.ROTATION));this.setMainLight(null)}},t.addDirectionalLight=function(e){e.attachToScene(this),this._directionalLights.push(e)},t.removeDirectionalLight=function(e){for(var t=0;t<this._directionalLights.length;++t)if(this._directionalLights[t]===e)return e.detachFromScene(),void this._directionalLights.splice(t,1)},t.addSphereLight=function(e){e.attachToScene(this),this._sphereLights.push(e)},t.removeSphereLight=function(e){for(var t=0;t<this._sphereLights.length;++t)if(this._sphereLights[t]===e)return e.detachFromScene(),void this._sphereLights.splice(t,1)},t.addSpotLight=function(e){e.attachToScene(this),this._spotLights.push(e)},t.removeSpotLight=function(e){for(var t=0;t<this._spotLights.length;++t)if(this._spotLights[t]===e)return e.detachFromScene(),void this._spotLights.splice(t,1)},t.removeSphereLights=function(){for(var e=0;e<this._sphereLights.length;++e)this._sphereLights[e].detachFromScene();this._sphereLights.length=0},t.removeSpotLights=function(){for(var e=0;e<this._spotLights.length;++e)this._spotLights[e].detachFromScene();this._spotLights=[]},t.addModel=function(e){e.attachToScene(this),this._models.push(e)},t.removeModel=function(e){for(var t=0;t<this._models.length;++t)if(this._models[t]===e)return e.detachFromScene(),void this._models.splice(t,1)},t.removeModels=function(){for(var e,t=se(this._models);!(e=t()).done;){var n=e.value;n.detachFromScene(),n.destroy()}this._models.length=0},t.addBatch=function(e){this._batches.push(e)},t.removeBatch=function(e){for(var t=0;t<this._batches.length;++t)if(this._batches[t]===e)return void this._batches.splice(t,1)},t.removeBatches=function(){this._batches.length=0},t.onGlobalPipelineStateChanged=function(){for(var e,t=se(this._models);!(e=t()).done;)e.value.onGlobalPipelineStateChanged()},t.generateModelId=function(){return this._modelId++},t._createNativeObject=function(){},Z(e,[{key:"root",get:function(){return this._root}},{key:"name",get:function(){return this._name}},{key:"cameras",get:function(){return this._cameras}},{key:"mainLight",get:function(){return this._mainLight}},{key:"sphereLights",get:function(){return this._sphereLights}},{key:"spotLights",get:function(){return this._spotLights}},{key:"models",get:function(){return this._models}},{key:"native",get:function(){return this._nativeObj}},{key:"batches",get:function(){return this._batches}}]),e}();G(hT.prototype,"RenderScene.prototype",[{name:"raycastUI2DNode"},{name:"raycastUINode"}]),G(hT.prototype,"RenderScene.prototype",[{name:"raycastAll",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllModels",suggest:"using intersect.rayModel in geometry"},{name:"raycastSingleModel",suggest:"using intersect.rayModel in geometry"},{name:"raycastAllCanvas",suggest:"using intersect.rayAABB in geometry"},{name:"rayResultCanvas"},{name:"rayResultModels"},{name:"rayResultAll"},{name:"rayResultSingleModel"}]);var fT={};G(fT,"CameraVisFlags",[{name:"GENERAL"}]),k(fT,"CameraVisFlags",[{name:"PROFILER",newName:"PROFILER",target:Fp.BitMask,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Fp.BitMask,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Fp.BitMask,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Fp.BitMask,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Fp.BitMask,targetName:"UI_2D"}]),u.CameraVisFlags=fT;var _T={};G(_T,"VisibilityFlags",[{name:"GENERAL"}]),k(_T,"VisibilityFlags",[{name:"ALWALS",newName:"ALWALS",target:Fp.Enum,targetName:"ALWALS"},{name:"PROFILER",newName:"PROFILER",target:Fp.Enum,targetName:"PROFILER"},{name:"GIZMOS",newName:"GIZMOS",target:Fp.Enum,targetName:"GIZMOS"},{name:"EDITOR",newName:"EDITOR",target:Fp.Enum,targetName:"EDITOR"},{name:"UI",newName:"UI",target:Fp.Enum,targetName:"UI_3D"},{name:"UI2D",newName:"UI2D",target:Fp.Enum,targetName:"UI_2D"}]),u.VisibilityFlags=_T,k(Gv.prototype,"Pass.prototype",[{name:"getBindingTypeFromHandle",newName:"getDescriptorTypeFromHandle"}]),G(yg.prototype,"Camera.prototype",[{name:"getSplitFrustum"},{name:"setMatView"},{name:"setMatViewInv"},{name:"setMatProjInv"},{name:"setMatViewProjInv"},{name:"setMatProj"},{name:"setMatViewProj"},{name:"getMatViewInv"}]),G(Eg.prototype,"Shadows.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]);var pT=new In(0,0,-1),dT=new In,mT=function(e){function t(){var t;return(t=e.call(this)||this)._dir=new In(1,-1,-1),t._illuminanceHDR=tT.SUN_ILLUM,t._illuminanceLDR=1,t._type=ay.DIRECTIONAL,t}$(t,e);var n=t.prototype;return n.initialize=function(){e.prototype.initialize.call(this),this.illuminance=tT.SUN_ILLUM,this.direction=new In(1,-1,-1)},n.update=function(){this._node&&this._node.hasChangedFlags&&(this.direction=In.transformQuat(dT,pT,this._node.worldRotation))},Z(t,[{key:"direction",get:function(){return this._dir},set:function(e){In.normalize(this._dir,e)}},{key:"illuminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this.illuminanceHDR=e:this.illuminanceLDR=e}},{key:"illuminanceHDR",get:function(){return this._illuminanceHDR},set:function(e){this._illuminanceHDR=e}},{key:"illuminanceLDR",get:function(){return this._illuminanceLDR},set:function(e){this._illuminanceLDR=e}}]),t}(Ty),vT=function(e){function t(t,n){var i;(i=e.call(this,t.root)||this)._parent=void 0,i._owner=void 0,i._dontNotify=!1,i._parent=t,i._owner=n,i._doInit(i._parent,!0);for(var r=0;r<i._shaderInfo.blocks.length;r++){var o=i._shaderInfo.blocks[r],a=i._blocks[o.binding],s=i._parent.blocks[o.binding];a.set(s)}i._setRootBufferDirty(!0);for(var c=i._parent,l=0;l<i._shaderInfo.samplerTextures.length;l++)for(var u=i._shaderInfo.samplerTextures[l],h=0;h<u.count;h++){var f=c._descriptorSet.getSampler(u.binding,h),_=c._descriptorSet.getTexture(u.binding,h);i._descriptorSet.bindSampler(u.binding,f,h),i._descriptorSet.bindTexture(u.binding,_,h)}return e.prototype.tryCompile.call(oe(i)),i}$(t,e);var n=t.prototype;return n.overridePipelineStates=function(e,t){this._bs.reset(),this._rs.reset(),this._dss.reset(),Gv.fillPipelineInfo(this,e),Gv.fillPipelineInfo(this,t),this._onStateChange()},n.tryCompile=function(t){if(t&&!dm(this._defines,t))return!1;var n=e.prototype.tryCompile.call(this);return this._onStateChange(),n},n.beginChangeStatesSilently=function(){this._dontNotify=!0},n.endChangeStatesSilently=function(){this._dontNotify=!1},n._syncBatchingScheme=function(){this._defines.USE_BATCHING=this._defines.USE_INSTANCING=!1,this._setBatchingScheme(Iv.NONE)},n._onStateChange=function(){this._setHash(Gv.getPassHash(this)),this._owner.onPassStateChange(this._dontNotify)},Z(t,[{key:"parent",get:function(){return this._parent}}]),t}(Gv),gT=function(e){function t(t){var n;return(n=e.call(this)||this)._passes=[],n._parent=void 0,n._owner=void 0,n._subModelIdx=0,n._parent=t.parent,n._owner=t.owner||null,n._subModelIdx=t.subModelIdx||0,n.copy(n._parent),n}$(t,e);var n=t.prototype;return n.recompileShaders=function(e,t){if(this._passes&&this.effectAsset)if(void 0===t)for(var n,i=se(this._passes);!(n=i()).done;)n.value.tryCompile(e);else this._passes[t].tryCompile(e)},n.overridePipelineStates=function(e,t){if(this._passes&&this.effectAsset){var n=this.effectAsset.techniques[this.technique].passes;if(void 0===t)for(var i=0;i<this._passes.length;i++){var r=this._passes[i],o=this._states[i]||(this._states[i]={});for(var a in e)o[a]=e[a];r.overridePipelineStates(n[r.passIndex],o)}else{var s=this._states[t]||(this._states[t]={});for(var c in e)s[c]=e[c];this._passes[t].overridePipelineStates(n[t],s)}}},n.destroy=function(){return this._doDestroy(),!0},n.onPassStateChange=function(e){this._hash=ug.getHash(this),!e&&this._owner&&this._owner._onRebuildPSO(this._subModelIdx,this)},n._createPasses=function(){var e=[],t=this._parent.passes;if(!t)return e;for(var n=0;n<t.length;++n)e.push(new vT(t[n],this));return e},Z(t,[{key:"parent",get:function(){return this._parent}},{key:"owner",get:function(){return this._owner}}]),t}(ug),yT=null,xT=null,ST=function(){function e(){this._envmapLDR=null,this._envmapHDR=null,this._diffuseMapLDR=null,this._diffuseMapHDR=null,this._globalDSManager=null,this._model=null,this._default=null,this._enabled=!1,this._useIBL=!1,this._useHDR=!0,this._useDiffuseMap=!1}var t=e.prototype;return t._setEnabled=function(e){this._enabled=e},t._setUseIBL=function(e){this._useIBL=e},t._setUseHDR=function(e){this._useHDR=e},t._setUseDiffuseMap=function(e){this._useDiffuseMap=e},t.initialize=function(e){this._setEnabled(e.enabled),this._setUseIBL(e.useIBL),this._setUseDiffuseMap(e.applyDiffuseMap),this._setUseHDR(e.useHDR)},t.setEnvMaps=function(e,t){this._envmapHDR=e,this._envmapLDR=t;var n=u.director.root;n.pipeline.pipelineSceneData.isHDR?e&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=e.mipmapLevel):t&&(n.pipeline.pipelineSceneData.ambient.mipmapCount=t.mipmapLevel),this._updateGlobalBinding(),this._updatePipeline()},t.setDiffuseMaps=function(e,t){this._diffuseMapHDR=e,this._diffuseMapLDR=t,this._updateGlobalBinding(),this._updatePipeline()},t.activate=function(){var e=u.director.root.pipeline;this._globalDSManager=e.globalDSManager,this._default=Nv.get("default-cube-texture"),this._model||(this._model=u.director.root.createModel(u.renderer.scene.Model),this._model._initLocalDescriptors=function(){},this._model._initWorldBoundDescriptors=function(){});var t=this._default.isRGBE;if(this.envmap&&(t=this.envmap.isRGBE),!xT){var n=new ug;n.initialize({effectName:"skybox",defines:{USE_RGBE_CUBEMAP:t}}),xT=new gT({parent:n})}this.enabled&&(yT||(yT=u.utils.createMesh(u.primitives.box({width:2,height:2,length:2}))),this._model.initSubModel(0,yT.renderingSubMeshes[0],xT)),this.envmap||(this.envmap=this._default),this.diffuseMap||(this.diffuseMap=this._default),this._updateGlobalBinding(),this._updatePipeline()},t._updatePipeline=function(){var e=u.director.root,t=e.pipeline,n=this.useIBL?this.isRGBE?2:1:0,i=this.useIBL&&this.useDiffuseMap&&this.diffuseMap?this.isRGBE?2:1:0,r=this.useHDR;t.macros.CC_USE_IBL===n&&t.macros.CC_USE_DIFFUSEMAP===i&&t.macros.CC_USE_HDR===r||(t.macros.CC_USE_IBL=n,t.macros.CC_USE_DIFFUSEMAP=i,t.macros.CC_USE_HDR=r,e.onGlobalPipelineStateChanged()),this.enabled&&xT&&xT.recompileShaders({USE_RGBE_CUBEMAP:this.isRGBE}),this._model&&this._model.setSubModelMaterial(0,xT)},t._updateGlobalBinding=function(){if(this._globalDSManager){var e=u.director.root.device,t=this.envmap?this.envmap:this._default;if(t){var n=t.getGFXTexture(),i=e.getSampler(t.getSamplerInfo());this._globalDSManager.bindSampler(od,i),this._globalDSManager.bindTexture(od,n)}var r=this.diffuseMap?this.diffuseMap:this._default;if(r){var o=r.getGFXTexture(),a=e.getSampler(r.getSamplerInfo());this._globalDSManager.bindSampler(cd,a),this._globalDSManager.bindTexture(cd,o)}this._globalDSManager.update()}},t._destroy=function(){},t.destroy=function(){this._destroy()},Z(e,[{key:"model",get:function(){return this._model}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnabled(e),e?this.activate():this._updatePipeline()}},{key:"useHDR",get:function(){return this._useHDR},set:function(e){this._setUseHDR(e),this.setEnvMaps(this._envmapHDR,this._envmapLDR)}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._setUseIBL(e),this._updatePipeline()}},{key:"useDiffuseMap",get:function(){return this._useDiffuseMap},set:function(e){this._useDiffuseMap=e,this.setDiffuseMaps(null,null)}},{key:"isRGBE",get:function(){return!!this.envmap&&this.envmap.isRGBE}},{key:"envmap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this.setEnvMaps(e,this._envmapLDR):this.setEnvMaps(this._envmapHDR,e)}},{key:"diffuseMap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this.setDiffuseMaps(e,this._diffuseMapLDR):this.setDiffuseMaps(this._diffuseMapHDR,e)}},{key:"native",get:function(){return this._nativeObj}}]),e}();u.Skybox=ST;var TT=function(e){$(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._needUpdate=!1,t._size=.15,t._range=1,t._luminanceHDR=0,t._luminanceLDR=0,t._pos=void 0,t._aabb=void 0,t._aabb=Xs.create(),t._pos=new In,t._type=ay.SPHERE,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.range=1,this.luminance=1700/Sy(.15),this.luminanceLDR=1},t.update=function(){if(this._node&&(this._node.hasChangedFlags||this._needUpdate)){this._node.getWorldPosition(this._pos);var e=this._range;Xs.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,e,e,e),this._needUpdate=!1}},Z(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",set:function(e){this._luminanceLDR=e}},{key:"aabb",get:function(){return this._aabb}}]),n}(Ty),bT=new In(0,0,-1),ET=new Fn,CT=new jn,AT=new jn,wT=new jn,PT=new jn,RT=function(e){$(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this)._dir=new In(1,-1,-1),t._range=5,t._spotAngle=Math.cos(Math.PI/6),t._pos=void 0,t._aabb=void 0,t._frustum=void 0,t._angle=0,t._needUpdate=!1,t._size=.15,t._luminanceHDR=0,t._luminanceLDR=0,t._aspect=0,t._aabb=Xs.create(),t._frustum=oc.create(),t._pos=new In,t._type=ay.SPOT,t}return t._init=function(){e.prototype._init.call(this)},t._destroy=function(){e.prototype._destroy.call(this)},t._setDirection=function(e){this._dir.set(e)},t.initialize=function(){e.prototype.initialize.call(this),this.size=.15,this.aspect=1,this.luminance=1700/Sy(.15),this.luminanceLDR=1,this.range=Math.cos(Math.PI/6),this._setDirection(new In(1,-1,-1))},t.update=function(){this._node&&(this._node.hasChangedFlags||this._needUpdate)&&(this._node.getWorldPosition(this._pos),In.transformQuat(this._dir,bT,this._node.getWorldRotation(ET)),In.normalize(this._dir,this._dir),Xs.set(this._aabb,this._pos.x,this._pos.y,this._pos.z,this._range,this._range,this._range),this._node.getWorldRT(CT),jn.invert(CT,CT),jn.perspective(AT,this._angle,1,.001,this._range),jn.multiply(wT,AT,CT),this._frustum.update(wT,PT),this._needUpdate=!1)},Z(n,[{key:"position",get:function(){return this._pos}},{key:"size",get:function(){return this._size},set:function(e){this._size=e}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._needUpdate=!0}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this.luminanceHDR=e:this.luminanceLDR=e}},{key:"luminanceHDR",get:function(){return this._luminanceHDR},set:function(e){this._luminanceHDR=e}},{key:"luminanceLDR",get:function(){return this._luminanceLDR},set:function(e){this._luminanceLDR=e}},{key:"direction",get:function(){return this._dir}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._angle=e,this._spotAngle=Math.cos(.5*e),this._needUpdate=!0}},{key:"angle",get:function(){return this._angle}},{key:"aspect",get:function(){return this._aspect},set:function(e){this._aspect=e,this._needUpdate=!0}},{key:"aabb",get:function(){return this._aabb}},{key:"frustum",get:function(){return this._frustum}}]),n}(Ty),IT=Object.freeze({__proto__:null,Ambient:tT,Octree:iT,get CameraFOVAxis(){return rg},get CameraProjection(){return og},get CameraAperture(){return ag},get CameraISO(){return sg},get CameraShutter(){return cg},SKYBOX_FLAG:vg,Camera:yg,CameraVisFlags:fT,VisibilityFlags:_T,DirectionalLight:mT,ColorTemperatureToRGB:uy,get LightType(){return ay},nt2lm:Sy,Light:Ty,get ModelType(){return nT},Model:uT,ShadowSize:xg,ShadowType:Sg,PCFType:Tg,Shadows:Eg,RenderScene:hT,Skybox:ST,SphereLight:TT,SpotLight:RT,SubModel:oT,NativeNode:null,NativeScene:null,NativeAABB:null,NativeModel:null,NativeSkinningModel:null,NativeBakedAnimInfo:null,NativeBakedJointInfo:null,NativeBakedSkinningModel:null,NativeLight:null,NativeDirectionalLight:null,NativeSphereLight:null,NativeSpotLight:null,NaitveSkybox:null,NativeFog:null,NativeRenderWindow:null,NativeCamera:null,NativePass:null,NativeSubModel:null,NativeDrawBatch2D:null,NativeRenderScene:null,NativeOctree:null,NativeAmbient:null,NativeShadow:null,NativeRoot:null,NativeJointTransform:null,NativeJointInfo:null,NativePipelineSharedSceneData:null}),DT=new ql((function(){return{subModel:null,passIdx:-1,dynamicOffsets:[],lights:[]}}),16),OT=new Float32Array(4),MT=[],NT=[],LT=new jn,BT=new jn;function FT(e,t){return!(!t.worldBounds||_s.aabbWithAABB(t.worldBounds,e.aabb))}function zT(e,t){return!(!t.worldBounds||_s.aabbWithAABB(t.worldBounds,e.aabb)&&_s.aabbFrustum(t.worldBounds,e.frustum))}var UT=Lv("forward-add"),kT=[];function GT(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===UT){o=a,n=!0;break}t.push(o)}return n}var HT,VT,WT,jT,qT,XT,YT,KT,QT,ZT,JT,$T=function(){function e(e){this._pipeline=void 0,this._device=void 0,this._lightPasses=[],this._shadowUBO=new Float32Array(td.COUNT),this._lightBufferCount=16,this._lightBufferStride=void 0,this._lightBufferElementCount=void 0,this._lightBuffer=void 0,this._firstLightBufferView=void 0,this._lightBufferData=void 0,this._instancedQueue=void 0,this._batchedQueue=void 0,this._lightMeterScale=1e4,this._pipeline=e,this._device=e.device,this._instancedQueue=new eT,this._batchedQueue=new $S;var t=this._device.capabilities.uboOffsetAlignment;this._lightBufferStride=Math.ceil(gd.SIZE/t)*t,this._lightBufferElementCount=this._lightBufferStride/Float32Array.BYTES_PER_ELEMENT,this._lightBuffer=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,this._lightBufferStride*this._lightBufferCount,this._lightBufferStride)),this._firstLightBufferView=this._device.createBuffer(new pr(this._lightBuffer,0,gd.SIZE)),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount)}var t=e.prototype;return t.clear=function(){this._instancedQueue.clear(),this._batchedQueue.clear();for(var e=0;e<this._lightPasses.length;e++){var t=this._lightPasses[e];t.dynamicOffsets.length=0,t.lights.length=0}DT.freeArray(this._lightPasses),this._lightPasses.length=0},t.destroy=function(){for(var e=this._pipeline.globalDSManager.descriptorSetMap,t=e.keys,n=0;n<t.length;n++){var i=t[n],r=e.get(i);r&&(r.getBuffer(td.BINDING).destroy(),r.getTexture(nd).destroy(),r.getTexture(hd).destroy(),r.destroy()),e.delete(i)}},t.gatherLightPasses=function(e,t){this.clear();var n=this._pipeline.pipelineSceneData.validPunctualLights;if(n.length){this._updateUBOs(e,t),this._updateLightDescriptorSet(e,t);for(var i=this._pipeline.pipelineSceneData.renderObjects,r=0;r<i.length;r++){var o=i[r].model,a=o.subModels;if(GT(a,kT)&&(NT.length=0,this._lightCulling(o,n),NT.length))for(var s=0;s<a.length;s++){var c=kT[s];if(!(c<0)){var l=a[s],u=l.passes[c];l.passes[0].blendState.targets[0].blend||(l.descriptorSet.bindBuffer(gd.BINDING,this._firstLightBufferView),l.descriptorSet.update(),this._addRenderQueue(u,l,o,c))}}}this._instancedQueue.uploadBuffers(t),this._batchedQueue.uploadBuffers(t)}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=this._pipeline.globalDSManager,r=0;r<this._lightPasses.length;r++){var o=this._lightPasses[r],a=o.subModel,s=o.passIdx,c=o.dynamicOffsets,l=o.lights,u=a.passes[s],h=a.shaders[s],f=a.inputAssembler,_=Hv.getOrCreatePipelineState(e,u,h,t,f),p=u.descriptorSet,d=a.descriptorSet;n.bindPipelineState(_),n.bindDescriptorSet(Kp.MATERIAL,p),n.bindInputAssembler(f);for(var m=0;m<c.length;++m){var v=l[m],g=i.getOrCreateDescriptorSet(v);MT[0]=c[m],n.bindDescriptorSet(Kp.GLOBAL,g),n.bindDescriptorSet(Kp.LOCAL,d,MT),n.draw(f)}}},t._lightCulling=function(e,t){for(var n=0;n<t.length;n++){var i=t[n],r=!1;switch(i.type){case ay.SPHERE:r=FT(i,e);break;case ay.SPOT:r=zT(i,e)}r||NT.push(n)}},t._addRenderQueue=function(e,t,n,i){var r=e.batchingScheme;if(r===Iv.INSTANCING)for(var o=0;o<NT.length;o++){var a=NT[o],s=e.getInstancedBuffer(a);s.merge(t,n.instancedAttributes,i),s.dynamicOffsets[0]=this._lightBufferStride*a,this._instancedQueue.queue.add(s)}else if(r===Iv.VB_MERGING)for(var c=0;c<NT.length;c++){var l=NT[c],u=e.getBatchedBuffer(l);u.merge(t,i,n),u.dynamicOffsets[0]=this._lightBufferStride*l,this._batchedQueue.queue.add(u)}else{var h=DT.alloc();h.subModel=t,h.passIdx=i;for(var f=0;f<NT.length;f++){var _=NT[f];h.lights.push(_),h.dynamicOffsets.push(this._lightBufferStride*_)}this._lightPasses.push(h)}},t._updateLightDescriptorSet=function(e,t){for(var n=this._pipeline.device,i=this._pipeline.pipelineSceneData,r=i.shadows,o=i.shadowFrameBufferMap,a=e.scene.mainLight,s=tm(n)?0:1,c=this._pipeline.globalDSManager,l=i.validPunctualLights,u=0;u<l.length;u++){var h=l[u],f=c.getOrCreateDescriptorSet(u);if(f){var _=void 0,p=void 0;switch(h.type){case ay.SPHERE:a&&(ey(r,a,this._shadowUBO),ty(r,this._shadowUBO)),this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=2,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,Pn.toArray(this._shadowUBO,r.shadowColor,td.SHADOW_COLOR_OFFSET);break;case ay.SPOT:if(a&&(ey(r,a,this._shadowUBO),ty(r,this._shadowUBO)),jn.invert(LT,h.node.getWorldMatrix()),jn.perspective(BT,h.angle,h.aspect,.001,h.range),_=BT.clone(),p=BT.clone().invert(),jn.multiply(BT,BT,LT),jn.toArray(this._shadowUBO,LT,td.MAT_LIGHT_VIEW_OFFSET),jn.toArray(this._shadowUBO,BT,td.MAT_LIGHT_VIEW_PROJ_OFFSET),this._shadowUBO[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+0]=.01,this._shadowUBO[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+1]=h.range,this._shadowUBO[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+2]=0,this._shadowUBO[td.SHADOW_NEAR_FAR_LINEAR_SATURATION_INFO_OFFSET+3]=1-r.saturation,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+0]=r.size.x,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+1]=r.size.y,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+2]=r.pcf,this._shadowUBO[td.SHADOW_WIDTH_HEIGHT_PCF_BIAS_INFO_OFFSET+3]=r.bias,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+0]=1,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+1]=s,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+2]=r.normalBias,this._shadowUBO[td.SHADOW_LIGHT_PACKING_NBIAS_NULL_INFO_OFFSET+3]=0,this._shadowUBO[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+0]=_.m10,this._shadowUBO[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+1]=_.m14,this._shadowUBO[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+2]=_.m11,this._shadowUBO[td.SHADOW_PROJ_DEPTH_INFO_OFFSET+3]=_.m15,this._shadowUBO[td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+0]=p.m10,this._shadowUBO[td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+1]=p.m14,this._shadowUBO[td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+2]=p.m11,this._shadowUBO[td.SHADOW_INV_PROJ_DEPTH_INFO_OFFSET+3]=p.m15,this._shadowUBO[td.SHADOW_PROJ_INFO_OFFSET+0]=_.m00,this._shadowUBO[td.SHADOW_PROJ_INFO_OFFSET+1]=_.m05,this._shadowUBO[td.SHADOW_PROJ_INFO_OFFSET+2]=1/_.m00,this._shadowUBO[td.SHADOW_PROJ_INFO_OFFSET+3]=1/_.m05,Pn.toArray(this._shadowUBO,r.shadowColor,td.SHADOW_COLOR_OFFSET),o.has(h)){var d,m=null===(d=o.get(h))||void 0===d?void 0:d.colorTextures[0];m&&f.bindTexture(hd,m)}}f.update(),t.updateBuffer(f.getBuffer(td.BINDING),this._shadowUBO)}}},t._updateUBOs=function(e,t){var n=e.exposure,i=this._pipeline.pipelineSceneData,r=i.isHDR,o=i.shadows,a=i.validPunctualLights;a.length>this._lightBufferCount&&(this._firstLightBufferView.destroy(),this._lightBufferCount=xn(a.length),this._lightBuffer.resize(this._lightBufferStride*this._lightBufferCount),this._lightBufferData=new Float32Array(this._lightBufferElementCount*this._lightBufferCount),this._firstLightBufferView.initialize(new pr(this._lightBuffer,0,gd.SIZE)));for(var s=0,c=0;s<a.length;s++,c+=this._lightBufferElementCount){var l=a[s];switch(l.type){case ay.SPHERE:if(In.toArray(OT,l.position),OT[3]=0,this._lightBufferData.set(OT,c+gd.LIGHT_POS_OFFSET),OT[0]=l.size,OT[1]=l.range,OT[2]=0,OT[3]=o.enabled&&o.type===Sg.ShadowMap?1:0,this._lightBufferData.set(OT,c+gd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),In.toArray(OT,l.color),l.useColorTemperature){var u=l.colorTemperatureRGB;OT[0]*=u.x,OT[1]*=u.y,OT[2]*=u.z}OT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(OT,c+gd.LIGHT_COLOR_OFFSET);break;case ay.SPOT:if(In.toArray(OT,l.position),OT[3]=1,this._lightBufferData.set(OT,c+gd.LIGHT_POS_OFFSET),OT[0]=l.size,OT[1]=l.range,OT[2]=l.spotAngle,OT[3]=o.enabled&&o.type===Sg.ShadowMap?1:0,this._lightBufferData.set(OT,c+gd.LIGHT_SIZE_RANGE_ANGLE_OFFSET),In.toArray(OT,l.direction),this._lightBufferData.set(OT,c+gd.LIGHT_DIR_OFFSET),In.toArray(OT,l.color),l.useColorTemperature){var h=l.colorTemperatureRGB;OT[0]*=h.x,OT[1]*=h.y,OT[2]*=h.z}OT[3]=r?l.luminance*n*this._lightMeterScale:l.luminance,this._lightBufferData.set(OT,c+gd.LIGHT_COLOR_OFFSET)}}t.updateBuffer(this._lightBuffer,this._lightBufferData)},e}(),eb=new Xs,tb=function(){function e(e){this._pendingModels=[],this._castModels=[],this._instancedQueue=new eT,this._pipeline=void 0,this._pipeline=e}var t=e.prototype;return t.gatherShadowPasses=function(e,t){var n=this._pipeline.pipelineSceneData,i=(this._pipeline.pipelineUBO,n.shadows);if(this._instancedQueue.clear(),this._pendingModels.length=0,this._castModels.length=0,i.enabled&&i.type===Sg.Planar&&!(i.normal.length()<1e-6)){var r=e.scene,o=e.frustum,a=0!=(e.visibility&Fp.BitMask.DEFAULT);if(r.mainLight&&a){for(var s=r.models,c=0;c<s.length;c++){var l=s[c];l.enabled&&l.node&&l.castShadow&&this._castModels.push(l)}var u=i.instancingMaterial.passes[0].getInstancedBuffer();this._instancedQueue.queue.add(u);for(var h=0;h<this._castModels.length;h++){var f=this._castModels[h];if(!f.worldBounds||(Xs.transform(eb,f.worldBounds,i.matLight),_s.aabbFrustum(eb,o)))if(f.isInstancingEnabled)for(var _=f.subModels,p=0;p<_.length;p++){var d=_[p];u.merge(d,f.instancedAttributes,0,d.planarInstanceShader)}else this._pendingModels.push(f)}this._instancedQueue.uploadBuffers(t)}}},t.recordCommandBuffer=function(e,t,n){var i=this._pipeline.pipelineSceneData.shadows;if(i.enabled&&i.type===Sg.Planar&&(this._instancedQueue.recordCommandBuffer(e,t,n),this._pendingModels.length)){var r=i.material.passes[0],o=r.descriptorSet;n.bindDescriptorSet(Kp.MATERIAL,o);for(var a=this._pendingModels.length,s=0;s<a;s++)for(var c=this._pendingModels[s],l=0;l<c.subModels.length;l++){var u=c.subModels[l],h=u.planarShader,f=u.inputAssembler,_=Hv.getOrCreatePipelineState(e,r,h,t,f);n.bindPipelineState(_),n.bindDescriptorSet(Kp.LOCAL,u.descriptorSet),n.bindInputAssembler(f),n.draw(f)}}},e}(),nb=function(){function e(){this._phaseID=Lv("default")}var t=e.prototype;return t.activate=function(e){this._pipeline=e},t.render=function(e,t){for(var n=this._pipeline,i=n.device,r=n.commandBuffers[0],o=e.scene.batches,a=0;a<o.length;a++){var s=o[a],c=!1;if(e.visibility&s.visFlags&&(c=!0),c)for(var l=s.shaders.length,u=0;u<l;u++){var h=s.passes[u];if(h.phase===this._phaseID){var f=s.shaders[u],_=s.inputAssembler,p=Hv.getOrCreatePipelineState(i,h,f,t,_);r.bindPipelineState(p),r.bindDescriptorSet(Kp.MATERIAL,h.descriptorSet);var d=s.descriptorSet;r.bindDescriptorSet(Kp.LOCAL,d),r.bindInputAssembler(_),r.draw(_)}}}},e}(),ib=[new lr(0,0,0,1)],rb=e("ForwardStage",(HT=mc("ForwardStage"),VT=Zc([qS]),WT=Vc(),HT((KT=YT=function(e){function t(){var t;return ce(t=e.call(this)||this,"renderQueues",XT,oe(t)),t._renderQueues=[],t._renderArea=new tr,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Lv("default"),t._clearFlag=4294967295,t._batchedQueue=new $S,t._instancedQueue=new eT,t._uiPhase=new nb,t}$(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=QS(this.renderQueues[i]);this._additiveLightQueue=new $T(this._pipeline),this._planarQueue=new tb(this._pipeline),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(ZS);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var _=f.batchingScheme;if(_===Iv.INSTANCING){var p=f.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(_===Iv.VB_MERGING){var d=f.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(JS);var m=t.commandBuffers[0];t.pipelineUBO.updateShadowUBO(e),this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),this._additiveLightQueue.gatherLightPasses(e,m),this._planarQueue.gatherShadowPasses(e,m),e.clearFlag&Ki.COLOR&&(ib[0].x=e.clearColor.x,ib[0].y=e.clearColor.y,ib[0].z=e.clearColor.z,ib[0].w=e.clearColor.w),t.generateRenderArea(e,this._renderArea);var v=e.window.framebuffer,g=t.getRenderPass(e.clearFlag&this._clearFlag,v);m.beginRenderPass(g,v,this._renderArea,ib,e.clearDepth,e.clearStencil),m.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet),this._renderQueues[0].recordCommandBuffer(n,g,m),this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),this._additiveLightQueue.recordCommandBuffer(n,g,m),m.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet),this._planarQueue.recordCommandBuffer(n,g,m),this._renderQueues[1].recordCommandBuffer(n,g,m),this._uiPhase.render(e,g),ig(n,g,m,t.profiler,e),m.endRenderPass()},t}(Hy),YT.initInfo={name:"ForwardStage",priority:tx.FORWARD,tag:0,renderQueues:[{isTransparent:!1,sortMode:HS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:HS.BACK_TO_FRONT,stages:["default","planarShadow"]}]},XT=le((qT=KT).prototype,"renderQueues",[VT,Tc,WT],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jT=qT))||jT)),ob=e("ForwardFlow",mc("ForwardFlow")((JT=ZT=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new rb;n.initialize(rb.initInfo),this._stages.push(n)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Wy),ZT.initInfo={name:Gp,priority:nx.FORWARD,stages:[]},QT=JT))||QT),ab=new jn,sb=new jn,cb=new jn,lb=new Xs,ub=Lv("shadow-caster"),hb=[];function fb(e,t){t.length=0;for(var n=!1,i=0;i<e.length;i++){for(var r=e[i].passes,o=-1,a=0;a<r.length;a++)if(r[a].phase===ub){o=a,n=!0;break}t.push(o)}return n}var _b,pb,db,mb,vb,gb,yb=function(){function e(e){this._pipeline=void 0,this._subModelsArray=[],this._passArray=[],this._shaderArray=[],this._instancedQueue=void 0,this._batchedQueue=void 0,this._pipeline=e,this._instancedQueue=new eT,this._batchedQueue=new $S}var t=e.prototype;return t.gatherLightPasses=function(e,t,n,i){this.clear();var r=this._pipeline.pipelineSceneData,o=r.shadows;if(n&&o.enabled&&o.type===Sg.ShadowMap){var a=r.dirShadowObjects,s=r.castShadowObjects;switch(n.type){case ay.DIRECTIONAL:for(var c=0;c<a.length;c++){var l=a[c].model;fb(l.subModels,hb)&&this.add(l,hb)}break;case ay.SPOT:jn.invert(ab,n.node.getWorldMatrix()),jn.perspective(sb,n.angle,n.aspect,.001,n.range),jn.multiply(cb,sb,ab);for(var u=0;u<s.length;u++){var h=s[u].model;fb(h.subModels,hb)&&(h.worldBounds&&(Xs.transform(lb,h.worldBounds,cb),!_s.aabbFrustum(lb,t.frustum))||this.add(h,hb))}}this._instancedQueue.uploadBuffers(i),this._batchedQueue.uploadBuffers(i)}},t.clear=function(){this._subModelsArray.length=0,this._shaderArray.length=0,this._passArray.length=0,this._instancedQueue.clear(),this._batchedQueue.clear()},t.add=function(e,t){for(var n=e.subModels,i=0;i<n.length;i++){var r=n[i],o=t[i],a=r.passes[o];if(a.batchingScheme===Iv.INSTANCING){var s=a.getInstancedBuffer();s.merge(r,e.instancedAttributes,o),this._instancedQueue.queue.add(s)}else if(a.batchingScheme===Iv.VB_MERGING){var c=a.getBatchedBuffer();c.merge(r,o,e),this._batchedQueue.queue.add(c)}else{var l=r.shaders[o];this._subModelsArray.push(r),l&&this._shaderArray.push(l),this._passArray.push(a)}}},t.recordCommandBuffer=function(e,t,n){this._instancedQueue.recordCommandBuffer(e,t,n),this._batchedQueue.recordCommandBuffer(e,t,n);for(var i=0;i<this._subModelsArray.length;++i){var r=this._subModelsArray[i],o=this._shaderArray[i],a=this._passArray[i],s=r.inputAssembler,c=Hv.getOrCreatePipelineState(e,a,o,t,s),l=a.descriptorSet;n.bindPipelineState(c),n.bindDescriptorSet(Kp.MATERIAL,l),n.bindDescriptorSet(Kp.LOCAL,r.descriptorSet),n.bindInputAssembler(s),n.draw(s)}},e}(),xb=[new lr(1,1,1,1)],Sb=e("ShadowStage",mc("ShadowStage")((db=pb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowFrameBuffer=null,t._renderArea=new tr,t._light=null,t._globalDS=null,t}$(t,e);var n=t.prototype;return n.setUsage=function(e,t,n){this._globalDS=e,this._light=t,this._shadowFrameBuffer=n},n.destroy=function(){var e;this._shadowFrameBuffer=null,this._globalDS=null,this._light=null,null===(e=this._additiveShadowQueue)||void 0===e||e.clear()},n.clearFramebuffer=function(e){if(this._light&&this._shadowFrameBuffer){xb[0].w=e.clearColor.w;var t=this._pipeline.commandBuffers[0],n=this._shadowFrameBuffer.renderPass;t.beginRenderPass(n,this._shadowFrameBuffer,this._renderArea,xb,e.clearDepth,e.clearStencil),t.endRenderPass()}},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData,i=n.shadows,r=n.shadingScale,o=this._globalDS,a=t.commandBuffers[0];if(this._light&&this._shadowFrameBuffer){this._pipeline.pipelineUBO.updateShadowUBOLight(o,this._light),this._additiveShadowQueue.gatherLightPasses(o,e,this._light,a);var s=e.viewport,c=i.size;this._renderArea.x=s.x*c.x,this._renderArea.y=s.y*c.y,this._renderArea.width=s.width*c.x*r,this._renderArea.height=s.height*c.y*r;var l=t.device,u=this._shadowFrameBuffer.renderPass;a.beginRenderPass(u,this._shadowFrameBuffer,this._renderArea,xb,e.clearDepth,e.clearStencil),a.bindDescriptorSet(Kp.GLOBAL,o),this._additiveShadowQueue.recordCommandBuffer(l,u,a),a.endRenderPass()}},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._additiveShadowQueue=new yb(t)},t}(Hy),pb.initInfo={name:"ShadowStage",priority:tx.FORWARD,tag:0},_b=db))||_b),Tb=[],bb=e("ShadowFlow",mc("ShadowFlow")((gb=vb=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._shadowRenderPass=null,t}$(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new Sb;n.initialize(Sb.initInfo),this._stages.push(n)}return!0},n.render=function(e){var t=this._pipeline,n=t.pipelineSceneData.shadows,i=t.pipelineSceneData.shadowFrameBufferMap,r=t.pipelineSceneData.castShadowObjects,o=this._pipeline.pipelineSceneData.validPunctualLights;if(n.enabled&&n.type===Sg.ShadowMap){for(var a=0,s=0;a<n.maxReceived&&s<o.length;){var c=o[s];c.type===ay.SPOT&&(Tb.push(c),a++),s++}if(0!==r.length){n.shadowMapDirty&&this.resizeShadowMap();var l=e.scene.mainLight;if(l){var u=t.descriptorSet;i.has(l)||this._initShadowFrameBuffer(t,l,e.window.swapchain);for(var h=i.get(l),f=0;f<this._stages.length;f++){var _=this._stages[f];_.setUsage(u,l,h),_.render(e)}}for(var p=0;p<Tb.length;p++){var d=Tb[p],m=t.globalDSManager.getOrCreateDescriptorSet(p);i.has(d)||this._initShadowFrameBuffer(t,d,e.window.swapchain);for(var v=i.get(d),g=0;g<this._stages.length;g++){var y=this._stages[g];y.setUsage(m,d,v),y.render(e)}}Tb.length=0}else this.clearShadowMap(Tb,e)}},n.destroy=function(){if(e.prototype.destroy.call(this),this._pipeline){for(var t=this._pipeline.pipelineSceneData.shadowFrameBufferMap,n=Array.from(t.values()),i=0;i<n.length;i++){var r=n[i];if(r){for(var o=r.colorTextures,a=0;a<o.length;a++){var s=o[i];s&&s.destroy()}o.length=0;var c=r.depthStencilTexture;c&&c.destroy(),r.destroy()}}t.clear()}this._shadowRenderPass&&this._shadowRenderPass.destroy()},n._initShadowFrameBuffer=function(e,t){var n=e.device,i=e.pipelineSceneData.shadows.size,r=e.pipelineSceneData.shadowFrameBufferMap,o=tm(n)?pi.R32F:pi.RGBA8;if(!this._shadowRenderPass){var a=new Mr;a.format=o,a.loadOp=Ni.CLEAR,a.storeOp=Li.STORE,a.sampleCount=1;var s=new Nr;s.format=pi.DEPTH_STENCIL,s.depthLoadOp=Ni.CLEAR,s.depthStoreOp=Li.DISCARD,s.stencilLoadOp=Ni.CLEAR,s.stencilStoreOp=Li.DISCARD,s.sampleCount=1;var c=new Fr([a],s);this._shadowRenderPass=n.createRenderPass(c)}var l=[];l.push(n.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,o,i.x,i.y)));var u=n.createTexture(new gr(Si.TEX2D,Ti.DEPTH_STENCIL_ATTACHMENT,pi.DEPTH_STENCIL,i.x,i.y)),h=n.createFramebuffer(new kr(this._shadowRenderPass,l,u));r.set(t,h)},n.clearShadowMap=function(e,t){var n=this._pipeline,i=n.pipelineSceneData,r=t.scene.mainLight;if(r){var o=this._pipeline.descriptorSet;i.shadowFrameBufferMap.has(r)||this._initShadowFrameBuffer(this._pipeline,r,t.window.swapchain);for(var a=i.shadowFrameBufferMap.get(r),s=0;s<this._stages.length;s++){var c=this._stages[s];c.setUsage(o,r,a),c.render(t)}}for(var l=0;l<e.length;l++){var u=e[l],h=i.shadowFrameBufferMap.get(u),f=n.globalDSManager.getOrCreateDescriptorSet(l);if(i.shadowFrameBufferMap.has(u))for(var _=0;_<this._stages.length;_++){var p=this._stages[_];p.setUsage(f,u,h),p.clearFramebuffer(t)}}},n.resizeShadowMap=function(){for(var e=this._pipeline.pipelineSceneData.shadows,t=e.size,n=this._pipeline,i=n.device,r=n.pipelineSceneData.shadowFrameBufferMap,o=tm(i)?pi.R32F:pi.RGBA8,a=r.values(),s=a.next();!s.done;){var c=s.value;if(c){var l=[];l.push(n.device.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,o,t.x,t.y)));var u=c.depthStencilTexture;u&&u.resize(t.x,t.y);var h=c.renderPass;c.destroy(),c.initialize(new kr(h,l,u)),s=a.next()}else s=a.next()}e.shadowMapDirty=!1},t}(Wy),vb.initInfo={name:Hp,priority:nx.SHADOW,tag:zS.SCENE,stages:[]},mb=gb))||mb),Eb=new $n,Cb=st({LINEAR:0,EXP:1,EXP_SQUARED:2,LAYERED:3}),Ab=Cb.LAYERED+1,wb=function(){function e(){this._fogColor=new Pn("#C8C8C8"),this._colorArray=new $n(.2,.2,.2,1),this._enabled=!1,this._accurate=!1,this._type=0,this._fogDensity=.3,this._fogStart=.5,this._fogEnd=300,this._fogAtten=5,this._fogTop=1.5,this._fogRange=1.2}var t=e.prototype;return t._setType=function(e){this._type=this.enabled?e:Ab},t._setEnable=function(e){this._enabled=e},t._setAccurate=function(e){this._accurate=e},t.initialize=function(e){this.fogColor=e.fogColor,this._setEnable(e.enabled),this._setAccurate(e.accurate),this._setType(e.type),this.fogDensity=e.fogDensity,this.fogStart=e.fogStart,this.fogEnd=e.fogEnd,this.fogAtten=e.fogAtten,this.fogTop=e.fogTop,this.fogRange=e.fogRange},t.activate=function(){this._updatePipeline()},t._updatePipeline=function(){var e=u.director.root,t=this.enabled?this.type:Ab,n=this.accurate?1:0,i=e.pipeline;i.macros.CC_USE_FOG===t&&i.macros.CC_USE_ACCURATE_FOG===n||(i.macros.CC_USE_FOG=t,i.macros.CC_USE_ACCURATE_FOG=n,e.onGlobalPipelineStateChanged())},t._destroy=function(){},t.destroy=function(){this._destroy()},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._setEnable(e),e?this.activate():(this._type=Ab,this._updatePipeline())}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._setAccurate(e),this._updatePipeline()}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),Eb.set(e.x,e.y,e.z,e.w),jv(this._colorArray,Eb)}},{key:"type",get:function(){return this._type},set:function(e){this._setType(e),this.enabled&&this._updatePipeline()}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e}},{key:"colorArray",get:function(){return this._colorArray}},{key:"native",get:function(){return this._nativeObj}}]),e}();function Pb(e,t){for(var n,i=se(t);!(n=i()).done;){var r=n.value;Array.isArray(r)?Pb(e,r):e.push(r)}}function Rb(e){var t=[];return Pb(t,e),t.join("")}u.Fog=wb;var Ib=ml.Flags.Destroyed,Db=ml.Flags.PersistentMask,Ob=en.IDENTIFIER_RE,Mb="var ",Nb="o",Lb={"cc.ClickEvent":!1,"cc.PrefabInfo":!1},Bb=en.escapeForJS,Fb=function(){function e(e,t){this.varName=void 0,this.expression=void 0,this.varName=e,this.expression=t}return e.prototype.toString=function(){return Mb+this.varName+"="+this.expression+";"},e}();function zb(e,t){return t instanceof Fb?new Fb(t.varName,e+t.expression):e+t}function Ub(e,t,n){Array.isArray(n)?(n[0]=zb(t,n[0]),e.push(n)):e.push(zb(t,n)+";")}var kb=function(){function e(e){this._exps=void 0,this._targetExp=void 0,this._exps=[],this._targetExp=e}var t=e.prototype;return t.append=function(e,t){this._exps.push([e,t])},t.writeCode=function(e){var t;if(this._exps.length>1)e.push("t="+this._targetExp+";"),t="t";else{if(1!==this._exps.length)return;t=this._targetExp}for(var n=0;n<this._exps.length;n++){var i=this._exps[n];Ub(e,t+Gb(i[0])+"=",i[1])}},e}();function Gb(e){return Ob.test(e)?"."+e:"["+Bb(e)+"]"}kb.pool=void 0,kb.pool=new nt((function(e){e._exps.length=0,e._targetExp=null}),1),kb.pool.get=function(e){var t=this._get()||new kb;return t._targetExp=e,t};var Hb=function(){function e(e,t){var n;this.parent=void 0,this.objsToClear_iN$t=void 0,this.codeArray=void 0,this.objs=void 0,this.funcs=void 0,this.funcModuleCache=void 0,this.globalVariables=void 0,this.globalVariableId=void 0,this.localVariableId=void 0,this.result=void 0,this.parent=t,this.objsToClear_iN$t=[],this.codeArray=[],this.objs=[],this.funcs=[],this.funcModuleCache=Re(),ke(this.funcModuleCache,Lb),this.globalVariables=[],this.globalVariableId=0,this.localVariableId=0,this.codeArray.push("var o,t;","if(R){","o=R;","}else{","o=R=new "+this.getFuncModule(e.constructor,!0)+"();","}"),e._iN$t={globalVar:"R"},this.objsToClear_iN$t.push(e),this.enumerateObject(this.codeArray,e),this.globalVariables.length>0&&(n=Mb+this.globalVariables.join(",")+";");var i=Rb(["return (function(R){",n||[],this.codeArray,"return o;","})"]);this.result=Function("O","F",i)(this.objs,this.funcs);for(var r=0,o=this.objsToClear_iN$t.length;r<o;++r)this.objsToClear_iN$t[r]._iN$t=null;this.objsToClear_iN$t.length=0}var t=e.prototype;return t.getFuncModule=function(e,t){var n=Ie(e);if(n){var i=this.funcModuleCache[n];if(i)return i;if(void 0===i){var r=-1!==n.indexOf(".");if(r)try{if(r=e===Function("return "+n)())return this.funcModuleCache[n]=n,n}catch(e){}}}var o=this.funcs.indexOf(e);o<0&&(o=this.funcs.length,this.funcs.push(e));var a="F["+o+"]";return t&&(a="("+a+")"),this.funcModuleCache[n]=a,a},t.getObjRef=function(e){var t=this.objs.indexOf(e);return t<0&&(t=this.objs.length,this.objs.push(e)),"O["+t+"]"},t.setValueType=function(e,t,n,i){var r=kb.pool.get(i),o=t.constructor.__props__;o||(o=Object.keys(t));for(var a=0;a<o.length;a++){var s=o[a],c=n[s];if(t[s]!==c){var l=this.enumerateField(n,s,c);r.append(s,l)}}r.writeCode(e),kb.pool.put(r)},t.enumerateCCClass=function(e,t,n){for(var i=n.__values__,r=Dt(n),o=0;o<i.length;o++){var a=i[o],s=t[a],c=r[a+"$_$default"];if(!Vb(c,s))if("object"==typeof s&&s instanceof u.ValueType&&(c=en.getDefault(c))&&c.constructor===s.constructor){var l=Nb+Gb(a);this.setValueType(e,c,s,l)}else this.setObjProp(e,t,a,s)}},t.instantiateArray=function(e){if(0===e.length)return"[]";var t="a"+ ++this.localVariableId,n=[new Fb(t,"new Array("+e.length+")")];e._iN$t={globalVar:"",source:n},this.objsToClear_iN$t.push(e);for(var i=0;i<e.length;++i)Ub(n,t+"["+i+"]=",this.enumerateField(e,i,e[i]));return n},t.instantiateTypedArray=function(e){var t=e.constructor.name;if(0===e.length)return"new "+t;var n="a"+ ++this.localVariableId,i=[new Fb(n,"new "+t+"("+e.length+")")];e._iN$t={globalVar:"",source:i},this.objsToClear_iN$t.push(e);for(var r=0;r<e.length;++r)0!==e[r]&&Ub(i,n+"["+r+"]=",e[r]);return i},t.enumerateField=function(e,t,n){if("object"==typeof n&&n){var i=n._iN$t;if(i){var r=i.globalVar;if(!r){r=i.globalVar="v"+ ++this.globalVariableId,this.globalVariables.push(r);var o=i.source[0];i.source[0]=zb(r+"=",o)}return r}return ArrayBuffer.isView(n)?this.instantiateTypedArray(n):Array.isArray(n)?this.instantiateArray(n):this.instantiateObj(n)}return"function"==typeof n?this.getFuncModule(n):"string"==typeof n?Bb(n):("_objFlags"===t&&e instanceof ml&&(n&=Db),n)},t.setObjProp=function(e,t,n,i){Ub(e,Nb+Gb(n)+"=",this.enumerateField(t,n,i))},t.enumerateObject=function(e,t){var n=t.constructor;if(u.Class._isCCClass(n))this.enumerateCCClass(e,t,n);else for(var i in t)if(t.hasOwnProperty(i)&&(95!==i.charCodeAt(0)||95!==i.charCodeAt(1)||"__type__"===i)){var r=t[i];"object"==typeof r&&r&&r===t._iN$t||this.setObjProp(e,t,i,r)}},t.instantiateObj=function(e){if(e instanceof u.ValueType)return en.getNewValueTypeCode(e);if(e instanceof u.Asset)return this.getObjRef(e);if(e._objFlags&Ib)return null;var t,n=e.constructor;if(u.Class._isCCClass(n)){if(this.parent)if(this.parent instanceof u.Component){if(e instanceof u._BaseNode||e instanceof u.Component)return this.getObjRef(e)}else if(this.parent instanceof u._BaseNode)if(e instanceof u._BaseNode){if(!e.isChildOf(this.parent))return this.getObjRef(e)}else if(e instanceof u.Component){var i;if(!(null===(i=e.node)||void 0===i?void 0:i.isChildOf(this.parent)))return this.getObjRef(e)}t=new Fb(Nb,"new "+this.getFuncModule(n,!0)+"()")}else if(n===Object)t=new Fb(Nb,"{}");else{if(n)return this.getObjRef(e);t=new Fb(Nb,"Object.create(null)")}var r=[t];return e._iN$t={globalVar:"",source:r},this.objsToClear_iN$t.push(e),this.enumerateObject(r,e),["(function(){",r,"return o;})();"]},e}();function Vb(e,t){if("function"==typeof e)try{e=e()}catch(e){return!1}if(e===t)return!0;if(e&&t&&"object"==typeof e&&"object"==typeof t&&e.constructor===t.constructor)if(e instanceof u.ValueType){if(e.equals(t))return!0}else{if(Array.isArray(e))return 0===e.length&&0===t.length;if(e.constructor===Object)return be(e)&&be(t)}return!1}var Wb,jb,qb,Xb,Yb,Kb,Qb,Zb,Jb,$b,eE=function(){function e(e){this._uiComp=null,this._opacity=1,this._localOpacity=1,this.colorDirty=!0,this._uiTransformComp=null,this._node=void 0,this._node=e}return e.prototype.applyOpacity=function(e){this._opacity=this._localOpacity*e},e.markOpacityTree=function(){},Z(e,[{key:"uiTransformComp",get:function(){return this._uiTransformComp||(this._uiTransformComp=this._node.getComponent("cc.UITransform")),this._uiTransformComp},set:function(e){this._uiTransformComp=e}},{key:"uiComp",get:function(){return this._uiComp},set:function(e){this._uiComp&&e?D(12002):this._uiComp=e}},{key:"opacity",get:function(){return this._opacity}},{key:"localOpacity",get:function(){return this._localOpacity},set:function(e){this._localOpacity=e,this.colorDirty=!0}}]),e}();ml.Flags.Destroying,function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed",e.ACTIVE_IN_HIERARCHY_CHANGED="active-in-hierarchy-changed"}(Wb||(Wb={}));var tE=ml.Flags.Destroying,nE=ml.Flags.DontDestroy,iE=ml.Flags.Deactivating,rE=new ve("Node");function oE(e){return e?"string"==typeof e?et(e):e:(M(3804),null)}var aE,sE,cE,lE,uE,hE,fE,_E,pE,dE,mE,vE=e("BaseNode",mc("cc.BaseNode")(($b=Jb=function(e){$(n,e),n._setScene=function(e){e._updateScene()},n._findComponent=function(e,t){var n=t,i=e._components;if(n._sealed)for(var r=0;r<i.length;++r){var o=i[r];if(o.constructor===t)return o}else for(var a=0;a<i.length;++a){var s=i[a];if(s instanceof t)return s}return null},n._findComponents=function(e,t,n){var i=t,r=e._components;if(i._sealed)for(var o=0;o<r.length;++o){var a=r[o];a.constructor===t&&n.push(a)}else for(var s=0;s<r.length;++s){var c=r[s];c instanceof t&&n.push(c)}},n._findChildComponent=function(e,t){for(var i=0;i<e.length;++i){var r=e[i],o=n._findComponent(r,t);if(o)return o;if(r._children.length>0&&(o=n._findChildComponent(r._children,t)))return o}return null},n._findChildComponents=function(e,t,i){for(var r=0;r<e.length;++r){var o=e[r];n._findComponents(o,t,i),o._children.length>0&&n._findChildComponents(o._children,t,i)}};var t=n.prototype;function n(t){var n;return ce(n=e.call(this,t)||this,"_parent",Xb,oe(n)),ce(n,"_children",Yb,oe(n)),ce(n,"_active",Kb,oe(n)),ce(n,"_components",Qb,oe(n)),ce(n,"_prefab",Zb,oe(n)),n._scene=null,n._activeInHierarchy=!1,n._id=rE.getNewId(),n._name=void 0,n._eventProcessor=new u.NodeEventProcessor(oe(n)),n._eventMask=0,n._siblingIndex=0,n._originalSceneId="",n._registerIfAttached=void 0,n._name=void 0!==t?t:"New Node",n}return t._updateScene=function(){null==this._parent?T("Node %s(%s) has not attached to a scene.",this.name,this.uuid):this._scene=this._parent._scene},t.attr=function(e){ke(this,e)},t.getParent=function(){return this._parent},t.setParent=function(e,t){if(void 0===t&&(t=!1),this._parent!==e){var n=this._parent,i=e;if(this._parent=i,this._siblingIndex=0,this._onSetParent(n,t),this.emit&&this.emit(Wb.PARENT_CHANGED,n),n&&!(n._objFlags&tE)){var r=n._children.indexOf(this);n._children.splice(r,1),n._updateSiblingIndex(),n.emit&&n.emit(Wb.CHILD_REMOVED,this)}i&&(i._children.push(this),this._siblingIndex=i._children.length-1,i.emit&&i.emit(Wb.CHILD_ADDED,this)),this._onHierarchyChanged(n)}},t.getChildByUuid=function(e){if(!e)return x("Invalid uuid"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._id===e)return t[n];return null},t.getChildByName=function(e){if(!e)return x("Invalid name"),null;for(var t=this._children,n=0,i=t.length;n<i;n++)if(t[n]._name===e)return t[n];return null},t.getChildByPath=function(e){for(var t=e.split("/"),n=this,i=function(e){var i=t[e];if(0===i.length)return"continue";var r=n.children.find((function(e){return e.name===i}));if(!r)return{v:null};n=r},r=0;r<t.length;++r){var o=i(r);if("continue"!==o&&"object"==typeof o)return o.v}return n},t.addChild=function(e){e.setParent(this)},t.insertChild=function(e,t){e.parent=this,e.setSiblingIndex(t)},t.getSiblingIndex=function(){return this._siblingIndex},t.setSiblingIndex=function(e){if(this._parent)if(this._parent._objFlags&iE)M(3821);else{var t=this._parent._children;e=-1!==e?e:t.length-1;var n=t.indexOf(this);e!==n&&(t.splice(n,1),e<t.length?t.splice(e,0,this):t.push(this),this._parent._updateSiblingIndex(),this._onSiblingIndexChanged&&this._onSiblingIndexChanged(e))}},t.walk=function(e,t){var i=1,r=null,o=null,a=0,s=n._stacks[n._stackId];s||(s=[],n._stacks.push(s)),n._stackId++,s.length=0,s[0]=this;for(var c=null,l=!1;i;)if(o=s[--i])if(!l&&e?e(o):l&&t&&t(o),s[i]=null,l){if(c===this._parent)break;if(l=!1,r)if(r[++a])s[i]=r[a],i++;else if(c&&(s[i]=c,i++,l=!0,c._parent?(a=(r=c._parent._children).indexOf(c),c=c._parent):(c=null,r=null),a<0))break}else o._children.length>0?(c=o,r=o._children,a=0,s[i]=r[a],i++):(s[i]=o,i++,l=!0);s.length=0,n._stackId--},t.removeFromParent=function(){this._parent&&this._parent.removeChild(this)},t.removeChild=function(e){this._children.indexOf(e)>-1&&(e.parent=null)},t.removeAllChildren=function(){for(var e=this._children,t=e.length-1;t>=0;t--){var n=e[t];n&&(n.parent=null)}this._children.length=0},t.isChildOf=function(e){var t=this;do{if(t===e)return!0;t=t._parent}while(t);return!1},t.getComponent=function(e){var t=oE(e);return t?n._findComponent(this,t):null},t.getComponents=function(e){var t=oE(e),i=[];return t&&n._findComponents(this,t,i),i},t.getComponentInChildren=function(e){var t=oE(e);return t?n._findChildComponent(this._children,t):null},t.getComponentsInChildren=function(e){var t=oE(e),i=[];return t&&(n._findComponents(this,t,i),n._findChildComponents(this._children,t,i)),i},t.addComponent=function(e){var t;if("string"==typeof e){if(!(t=et(e)))throw u._RF.peek()&&M(3808,e),TypeError(F(3807,e))}else{if(!e)throw TypeError(F(3804));t=e}if("function"!=typeof t)throw TypeError(F(3809));if(!Ve(t,u.Component))throw TypeError(F(3810));var n=t._requireComponent;if(n)if(Array.isArray(n))for(var i=0;i<n.length;i++){var r=n[i];this.getComponent(r)||this.addComponent(r)}else{var o=n;this.getComponent(o)||this.addComponent(o)}var a=new t;return a.node=this,this._components.push(a),this._activeInHierarchy&&u.director._nodeActivator.activateComp(a),a},t.removeComponent=function(e){if(e){var t=null;(t=e instanceof th?e:this.getComponent(e))&&t.destroy()}else M(3813)},t.on=function(e,t,n,i){switch(void 0===i&&(i=!1),e){case Wb.TRANSFORM_CHANGED:this._eventMask|=1}this._eventProcessor.on(e,t,n,i)},t.off=function(e,t,n,i){if(void 0===i&&(i=!1),this._eventProcessor.off(e,t,n,i),!this._eventProcessor.hasEventListener(e))switch(e){case Wb.TRANSFORM_CHANGED:this._eventMask&=-2}},t.once=function(e,t,n,i){this._eventProcessor.once(e,t,n,i)},t.emit=function(e,t,n,i,r,o){this._eventProcessor.emit(e,t,n,i,r,o)},t.dispatchEvent=function(e){this._eventProcessor.dispatchEvent(e)},t.hasEventListener=function(e,t,n){return this._eventProcessor.hasEventListener(e,t,n)},t.targetOff=function(e){this._eventProcessor.targetOff(e),1&this._eventMask&&!this._eventProcessor.hasEventListener(Wb.TRANSFORM_CHANGED)&&(this._eventMask&=-2)},t.destroy=function(){return!!e.prototype.destroy.call(this)&&(this.active=!1,!0)},t.destroyAllChildren=function(){for(var e=this._children,t=0;t<e.length;++t)e[t].destroy()},t._removeComponent=function(e){if(e){if(!(this._objFlags&tE)){var t=this._components.indexOf(e);-1!==t?this._components.splice(t,1):e.node!==this&&M(3815)}}else M(3814)},t._updateSiblingIndex=function(){for(var e=0;e<this._children.length;++e)this._children[e]._siblingIndex=e;this.emit(Wb.SIBLING_ORDER_CHANGED)},t._onSetParent=function(e){this._parent&&(null!=e&&e._scene===this._parent._scene||null==this._parent._scene||this.walk(n._setScene))},t._onPostActivated=function(){},t._onBatchCreated=function(){this._parent&&(this._siblingIndex=this._parent.children.indexOf(this))},t._onPreDestroy=function(){this._onPreDestroyBase()},t._onHierarchyChanged=function(e){return this._onHierarchyChangedBase(e)},t._instantiate=function(e,t){return e||(e=u.instantiate._clone(this,this)),e._prefab,e._parent=null,e._onBatchCreated(t),e},t._onHierarchyChangedBase=function(){var e=this._parent;!this._persistNode||e instanceof u.Scene||u.game.removePersistRootNode(this);var t=this._active&&!(!e||!e._activeInHierarchy);this._activeInHierarchy!==t&&u.director._nodeActivator.activateNode(this,t)},t._onPreDestroyBase=function(){this._objFlags|=tE;var e=this._parent,t=!!e&&0!=(e._objFlags&tE);if(this._persistNode&&u.game.removePersistRootNode(this),!t&&e){this.emit(Wb.PARENT_CHANGED,this);var n=e._children.indexOf(this);e._children.splice(n,1),this._siblingIndex=0,e._updateSiblingIndex(),e.emit&&e.emit(Wb.CHILD_REMOVED,this)}this.emit(Wb.NODE_DESTROYED,this),this._eventProcessor.destroy();for(var i=this._children,r=0;r<i.length;++r)i[r]._destroyImmediate();for(var o=this._components,a=0;a<o.length;++a)o[a]._destroyImmediate();return t},Z(n,[{key:"components",get:function(){return this._components}},{key:"_persistNode",get:function(){return(this._objFlags&nE)>0},set:function(e){e?this._objFlags|=nE:this._objFlags&=~nE}},{key:"name",get:function(){return this._name},set:function(e){this._name=e}},{key:"uuid",get:function(){return this._id}},{key:"children",get:function(){return this._children}},{key:"active",get:function(){return this._active},set:function(e){if(this._active!==e){this._active=e;var t=this._parent;t&&t._activeInHierarchy&&u.director._nodeActivator.activateNode(this,e)}}},{key:"activeInHierarchy",get:function(){return this._activeInHierarchy}},{key:"parent",get:function(){return this._parent},set:function(e){this.setParent(e)}},{key:"scene",get:function(){return this._scene}},{key:"eventProcessor",get:function(){return this._eventProcessor}}]),n}(ml),Jb.idGenerator=rE,Jb._stacks=[[]],Jb._stackId=0,le((qb=$b).prototype,"_persistNode",[xc],Object.getOwnPropertyDescriptor(qb.prototype,"_persistNode"),qb.prototype),le(qb.prototype,"name",[Mc],Object.getOwnPropertyDescriptor(qb.prototype,"name"),qb.prototype),le(qb.prototype,"children",[Mc],Object.getOwnPropertyDescriptor(qb.prototype,"children"),qb.prototype),le(qb.prototype,"active",[Mc],Object.getOwnPropertyDescriptor(qb.prototype,"active"),qb.prototype),le(qb.prototype,"activeInHierarchy",[Mc],Object.getOwnPropertyDescriptor(qb.prototype,"activeInHierarchy"),qb.prototype),le(qb.prototype,"parent",[Mc],Object.getOwnPropertyDescriptor(qb.prototype,"parent"),qb.prototype),Xb=le(qb.prototype,"_parent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Yb=le(qb.prototype,"_children",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Kb=le(qb.prototype,"_active",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Qb=le(qb.prototype,"_components",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Zb=le(qb.prototype,"_prefab",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jb=qb))||jb);u._BaseNode=vE;var gE=new In,yE=new Fn,xE=new Fn,SE=new Fn,TE=new Nn,bE=new Nn,EE=new jn,CE=[],AE=[],wE=[],PE=function(){function e(){this._chunks=[],this._freelists=[],this._createChunk()}var t=e.prototype;return t.alloc=function(){for(var e=this._freelists.length,t=0;t<e;++t)if(this._freelists[t].length)return this._createView(t);return this._createChunk(),this._createView(e)},t.free=function(e,t){for(var n=this._freelists.length,i=0;i<n;++i)if(this._chunks[i]===e)return void this._freelists[i].push(t)},t.clear=function(){for(var e=this._chunks.length,t=0;t<e;++t)this._chunks[t].fill(0)},t._createChunk=function(){this._chunks.push(new Uint32Array(e.CAPACITY_PER_CHUNK));for(var t=[],n=e.CAPACITY_PER_CHUNK-1;n>=0;n--)t.push(n);this._freelists.push(t)},t._createView=function(e){return wE[0]=this._chunks[e],wE[1]=this._freelists[e].pop(),wE},e}();PE.CAPACITY_PER_CHUNK=256;var RE,IE,DE,OE,ME,NE,LE,BE,FE,zE,UE,kE,GE,HE,VE,WE,jE,qE,XE,YE,KE,QE,ZE,JE,$E,eC,tC,nC,iC,rC,oC,aC,sC,cC,lC,uC,hC,fC,_C,pC,dC,mC,vC,gC,yC,xC,SC,TC,bC,EC,CC,AC,wC,PC,RC,IC,DC,OC,MC,NC,LC,BC,FC,zC,UC,kC,GC,HC,VC,WC=new PE,jC=Symbol("ReserveContentsForAllSyncablePrefab"),qC=e("Node",(aE=mc("cc.Node"),sE=Zc(In),aE((mE=dE=function(e){$(n,e);var t=n.prototype;function n(t){var n;return(n=e.call(this,t)||this)._uiProps=new eE(oe(n)),n._static=!1,ce(n,"_lpos",uE,oe(n)),ce(n,"_lrot",hE,oe(n)),ce(n,"_lscale",fE,oe(n)),ce(n,"_layer",_E,oe(n)),ce(n,"_euler",pE,oe(n)),n._dirtyFlagsPri=oy.NONE,n._eulerDirty=!1,n._nodeHandle=0,n._init(),n}return t._init=function(){var e=WC.alloc(),t=e[0],n=e[1];this._hasChangedFlagsChunk=t,this._hasChangedFlagsOffset=n;var i=new Uint32Array(t.buffer,t.byteOffset+4*n,1);this._hasChangedFlags=i,this._pos=new In,this._rot=new Fn,this._scale=new In(1,1,1),this._mat=new jn},n.isNode=function(e){return e instanceof n&&(e.constructor===n||!(e instanceof u.Scene))},t._onPreDestroy=function(){var e=this._onPreDestroyBase();return WC.free(this._hasChangedFlagsChunk,this._hasChangedFlagsOffset),e},t[fh]=function(e){e.writeThis()},t.setParent=function(t,n){void 0===n&&(n=!1),n&&this.updateWorldTransform(),e.prototype.setParent.call(this,t,n)},t._onSetParent=function(t,n){if(e.prototype._onSetParent.call(this,t,n),n){var i=this._parent;i?(i.updateWorldTransform(),jn.multiply(EE,jn.invert(EE,i._mat),this._mat),jn.toRTS(EE,this._lrot,this._lpos,this._lscale)):(In.copy(this._lpos,this._pos),Fn.copy(this._lrot,this._rot),In.copy(this._lscale,this._scale)),this._eulerDirty=!0}this.invalidateChildren(oy.TRS)},t._onHierarchyChanged=function(t){this.eventProcessor.reattach(),e.prototype._onHierarchyChangedBase.call(this,t)},t._onBatchCreated=function(e){this.hasChangedFlags=oy.TRS,this._dirtyFlags|=oy.TRS;for(var t=this._children.length,n=0;n<t;++n)this._children[n]._siblingIndex=n,this._children[n]._onBatchCreated(e)},t._onBeforeSerialize=function(){this.eulerAngles},t._onPostActivated=function(e){e?(this._eventProcessor.setEnabled(!0),this.invalidateChildren(oy.TRS),this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.setTextureDirty(),this._uiProps.uiComp.markForUpdateRenderData())):this._eventProcessor.setEnabled(!1)},t.translate=function(e,t){var n=t||ry.LOCAL;if(n===ry.LOCAL)In.transformQuat(gE,e,this._lrot),this._lpos.x+=gE.x,this._lpos.y+=gE.y,this._lpos.z+=gE.z;else if(n===ry.WORLD)if(this._parent){Fn.invert(yE,this._parent.worldRotation),In.transformQuat(gE,e,yE);var i=this.worldScale;this._lpos.x+=gE.x/i.x,this._lpos.y+=gE.y/i.y,this._lpos.z+=gE.z/i.z}else this._lpos.x+=e.x,this._lpos.y+=e.y,this._lpos.z+=e.z;this.invalidateChildren(oy.POSITION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.POSITION)},t.rotate=function(e,t){var n=t||ry.LOCAL;if(Fn.normalize(yE,e),n===ry.LOCAL)Fn.multiply(this._lrot,this._lrot,yE);else if(n===ry.WORLD){var i=this.worldRotation;Fn.multiply(xE,yE,i),Fn.invert(yE,i),Fn.multiply(xE,yE,xE),Fn.multiply(this._lrot,this._lrot,xE)}this._eulerDirty=!0,this.invalidateChildren(oy.ROTATION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.ROTATION)},t.lookAt=function(e,t){this.getWorldPosition(gE),In.subtract(gE,gE,e),In.normalize(gE,gE),Fn.fromViewUp(yE,gE,t),this.setWorldRotation(yE)},t._setDirtyNode=function(e,t){CE[e]=t},t.invalidateChildren=function(e){var t,n,i,r=0,o=0,a=0,s=0,c=0,l=e|oy.POSITION;for(CE[0]=this;r>=0;){if(c=(t=CE[r--])._hasChangedFlags[0],s=t._dirtyFlagsPri,t.isValid&&(s&c&e)!==e)for(s|=e,t._dirtyFlagsPri=s,t._hasChangedFlags[0]=c|e,a=(i=t._children).length,o=0;o<a;o++)n=i[o],CE[++r]=n;e=l}},t.updateWorldTransform=function(){if(this._dirtyFlags){for(var e,t=this,n=0;t&&t._dirtyFlags;)this._setDirtyNode(n++,t),t=t._parent;for(var i=0;n;)i|=(e=CE[--n])._dirtyFlags,t?(i&oy.POSITION&&(In.transformMat4(e._pos,e._lpos,t._mat),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&oy.RS&&(jn.fromRTS(e._mat,e._lrot,e._lpos,e._lscale),jn.multiply(e._mat,t._mat,e._mat),i&oy.ROTATION&&Fn.multiply(e._rot,t._rot,e._lrot),Nn.fromQuat(TE,Fn.conjugate(SE,e._rot)),Nn.multiplyMat4(TE,TE,e._mat),e._scale.x=TE.m00,e._scale.y=TE.m04,e._scale.z=TE.m08)):(i&oy.POSITION&&(In.copy(e._pos,e._lpos),e._mat.m12=e._pos.x,e._mat.m13=e._pos.y,e._mat.m14=e._pos.z),i&oy.RS&&(i&oy.ROTATION&&Fn.copy(e._rot,e._lrot),i&oy.SCALE&&(In.copy(e._scale,e._lscale),jn.fromRTS(e._mat,e._rot,e._pos,e._scale)))),e._dirtyFlags=oy.NONE,t=e}},t.setPosition=function(e,t,n){void 0===t&&void 0===n?In.copy(this._lpos,e):void 0===n?In.set(this._lpos,e,t,this._lpos.z):In.set(this._lpos,e,t,n),this.invalidateChildren(oy.POSITION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.POSITION)},t.getPosition=function(e){return e?In.set(e,this._lpos.x,this._lpos.y,this._lpos.z):In.copy(new In,this._lpos)},t.setRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Fn.copy(this._lrot,e):Fn.set(this._lrot,e,t,n,i),this._eulerDirty=!0,this.invalidateChildren(oy.ROTATION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.ROTATION)},t.setRotationFromEuler=function(e,t,n){var i=void 0===n?this._euler.z:n;void 0===t?(In.copy(this._euler,e),Fn.fromEuler(this._lrot,e.x,e.y,e.z)):(In.set(this._euler,e,t,i),Fn.fromEuler(this._lrot,e,t,i)),this._eulerDirty=!1,this.invalidateChildren(oy.ROTATION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.ROTATION)},t.getRotation=function(e){return e?Fn.set(e,this._lrot.x,this._lrot.y,this._lrot.z,this._lrot.w):Fn.copy(new Fn,this._lrot)},t.setScale=function(e,t,n){void 0===t&&void 0===n?In.copy(this._lscale,e):void 0===n?In.set(this._lscale,e,t,this._lscale.z):In.set(this._lscale,e,t,n),this.invalidateChildren(oy.SCALE),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.SCALE)},t.getScale=function(e){return e?In.set(e,this._lscale.x,this._lscale.y,this._lscale.z):In.copy(new In,this._lscale)},t.inverseTransformPoint=function(e,t){In.copy(e,t);for(var n=this,i=0;n._parent;)this._setDirtyNode(i++,n),n=n._parent;for(;i>=0;)In.transformInverseRTS(e,e,n._lrot,n._lpos,n._lscale),n=CE[--i];return e},t.setWorldPosition=function(e,t,n){void 0===t||void 0===n?In.copy(this._pos,e):In.set(this._pos,e,t,n);var i=this._parent,r=this._lpos;i?(i.updateWorldTransform(),In.transformMat4(r,this._pos,jn.invert(EE,i._mat))):In.copy(r,this._pos),this.invalidateChildren(oy.POSITION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.POSITION)},t.getWorldPosition=function(e){return this.updateWorldTransform(),e?In.copy(e,this._pos):In.copy(new In,this._pos)},t.setWorldRotation=function(e,t,n,i){void 0===t||void 0===n||void 0===i?Fn.copy(this._rot,e):Fn.set(this._rot,e,t,n,i),this._parent?(this._parent.updateWorldTransform(),Fn.multiply(this._lrot,Fn.conjugate(this._lrot,this._parent._rot),this._rot)):Fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(oy.ROTATION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.ROTATION)},t.setWorldRotationFromEuler=function(e,t,n){Fn.fromEuler(this._rot,e,t,n),this._parent?(this._parent.updateWorldTransform(),Fn.multiply(this._lrot,Fn.conjugate(this._lrot,this._parent._rot),this._rot)):Fn.copy(this._lrot,this._rot),this._eulerDirty=!0,this.invalidateChildren(oy.ROTATION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.ROTATION)},t.getWorldRotation=function(e){return this.updateWorldTransform(),e?Fn.copy(e,this._rot):Fn.copy(new Fn,this._rot)},t.setWorldScale=function(e,t,n){void 0===t||void 0===n?In.copy(this._scale,e):In.set(this._scale,e,t,n);var i=this._parent;i?(i.updateWorldTransform(),Nn.fromQuat(TE,Fn.conjugate(SE,i._rot)),Nn.multiplyMat4(TE,TE,i._mat),bE.m00=this._scale.x,bE.m04=this._scale.y,bE.m08=this._scale.z,Nn.multiply(TE,bE,Nn.invert(TE,TE)),this._lscale.x=In.set(gE,TE.m00,TE.m01,TE.m02).length(),this._lscale.y=In.set(gE,TE.m03,TE.m04,TE.m05).length(),this._lscale.z=In.set(gE,TE.m06,TE.m07,TE.m08).length()):In.copy(this._lscale,this._scale),this.invalidateChildren(oy.SCALE),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.SCALE)},t.getWorldScale=function(e){return this.updateWorldTransform(),e?In.copy(e,this._scale):In.copy(new In,this._scale)},t.getWorldMatrix=function(e){this.updateWorldTransform();var t=e||new jn;return jn.copy(t,this._mat)},t.getWorldRS=function(e){this.updateWorldTransform();var t=e||new jn;return jn.copy(t,this._mat),t.m12=0,t.m13=0,t.m14=0,t},t.getWorldRT=function(e){this.updateWorldTransform();var t=e||new jn;return jn.fromRT(t,this._rot,this._pos)},t.setRTS=function(e,t,n){var i=0;e&&(i|=oy.ROTATION,void 0!==e.w?(Fn.copy(this._lrot,e),this._eulerDirty=!0):(In.copy(this._euler,e),Fn.fromEuler(this._lrot,e.x,e.y,e.z),this._eulerDirty=!1)),t&&(In.copy(this._lpos,t),i|=oy.POSITION),n&&(In.copy(this._lscale,n),i|=oy.SCALE),i&&(this.invalidateChildren(i),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,i))},t.pauseSystemEvents=function(e){this._eventProcessor.setEnabled(!1,e)},t.resumeSystemEvents=function(e){this._eventProcessor.setEnabled(!0,e)},n.resetHasChangedFlags=function(){WC.clear()},n.clearNodeArray=function(){n.ClearFrame<n.ClearRound?n.ClearFrame++:(n.ClearFrame=0,CE.length=0,AE.length=0)},Z(n,[{key:"_dirtyFlags",get:function(){return this._dirtyFlagsPri},set:function(e){this._dirtyFlagsPri=e}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return this._lpos},set:function(e){this.setPosition(e)}},{key:"worldPosition",get:function(){return this.updateWorldTransform(),this._pos},set:function(e){this.setWorldPosition(e)}},{key:"rotation",get:function(){return this._lrot},set:function(e){this.setRotation(e)}},{key:"eulerAngles",get:function(){return this._eulerDirty&&(Fn.toEuler(this._euler,this._lrot),this._eulerDirty=!1),this._euler},set:function(e){this.setRotationFromEuler(e.x,e.y,e.z)}},{key:"angle",get:function(){return this._euler.z},set:function(e){In.set(this._euler,0,0,e),Fn.fromAngleZ(this._lrot,e),this._eulerDirty=!1,this.invalidateChildren(oy.ROTATION),1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.ROTATION)}},{key:"worldRotation",get:function(){return this.updateWorldTransform(),this._rot},set:function(e){this.setWorldRotation(e)}},{key:"scale",get:function(){return this._lscale},set:function(e){this.setScale(e)}},{key:"worldScale",get:function(){return this.updateWorldTransform(),this._scale},set:function(e){this.setWorldScale(e)}},{key:"matrix",set:function(e){jn.toRTS(e,this._lrot,this._lpos,this._lscale),this.invalidateChildren(oy.TRS),this._eulerDirty=!0,1&this._eventMask&&this.emit(Wb.TRANSFORM_CHANGED,oy.TRS)}},{key:"worldMatrix",get:function(){return this.updateWorldTransform(),this._mat}},{key:"forward",get:function(){return In.transformQuat(new In,In.FORWARD,this.worldRotation)},set:function(e){var t=e.length();In.multiplyScalar(gE,e,-1/t),Fn.fromViewUp(yE,gE),this.setWorldRotation(yE)}},{key:"up",get:function(){return In.transformQuat(new In,In.UP,this.worldRotation)}},{key:"right",get:function(){return In.transformQuat(new In,In.RIGHT,this.worldRotation)}},{key:"layer",get:function(){return this._layer},set:function(e){this._layer=e,this._uiProps&&this._uiProps.uiComp&&(this._uiProps.uiComp.setNodeDirty(),this._uiProps.uiComp.markForUpdateRenderData()),this.emit(Wb.LAYER_CHANGED,this._layer)}},{key:"hasChangedFlags",get:function(){return this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]},set:function(e){this._hasChangedFlagsChunk[this._hasChangedFlagsOffset]=e}}]),n}(vE),dE.EventType=Wb,dE.NodeSpace=ry,dE.TransformDirtyBit=oy,dE.TransformBit=oy,dE.reserveContentsForAllSyncablePrefabTag=jC,dE.ClearFrame=0,dE.ClearRound=1e3,uE=le((lE=mE).prototype,"_lpos",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),hE=le(lE.prototype,"_lrot",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Fn}}),fE=le(lE.prototype,"_lscale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(1,1,1)}}),_E=le(lE.prototype,"_layer",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp.Enum.DEFAULT}}),pE=le(lE.prototype,"_euler",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),le(lE.prototype,"eulerAngles",[sE],Object.getOwnPropertyDescriptor(lE.prototype,"eulerAngles"),lE.prototype),le(lE.prototype,"angle",[Mc],Object.getOwnPropertyDescriptor(lE.prototype,"angle"),lE.prototype),le(lE.prototype,"layer",[Mc],Object.getOwnPropertyDescriptor(lE.prototype,"layer"),lE.prototype),cE=lE))||cE));u.Node=qC;var XC=mc("cc.TargetInfo")((DE=le((IE=function(){ce(this,"localID",DE,this)}).prototype,"localID",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RE=IE))||RE,YC=(OE=mc("cc.TargetOverrideInfo"),ME=Zc(ml),NE=Zc(XC),LE=Zc(qC),BE=Zc(XC),OE((UE=le((zE=function(){ce(this,"source",UE,this),ce(this,"sourceInfo",kE,this),ce(this,"propertyPath",GE,this),ce(this,"target",HE,this),ce(this,"targetInfo",VE,this)}).prototype,"source",[Tc,ME],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kE=le(zE.prototype,"sourceInfo",[Tc,NE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GE=le(zE.prototype,"propertyPath",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HE=le(zE.prototype,"target",[Tc,LE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),VE=le(zE.prototype,"targetInfo",[Tc,BE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FE=zE))||FE),KC=mc("cc.CompPrefabInfo")((qE=le((jE=function(){ce(this,"fileId",qE,this)}).prototype,"fileId",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),WE=jE))||WE,QC=(XE=mc("CCPropertyOverrideInfo"),YE=Zc(XC),XE((eC=function(){function e(){ce(this,"targetInfo",ZE,this),ce(this,"propertyPath",JE,this),ce(this,"value",$E,this)}return e.prototype.isTarget=function(){},e}(),ZE=le((QE=eC).prototype,"targetInfo",[Tc,YE],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JE=le(QE.prototype,"propertyPath",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),$E=le(QE.prototype,"value",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KE=QE))||KE),ZC=(tC=mc("cc.MountedChildrenInfo"),nC=Zc(XC),iC=Zc([qC]),tC((cC=function(){function e(){ce(this,"targetInfo",aC,this),ce(this,"nodes",sC,this)}return e.prototype.isTarget=function(){},e}(),aC=le((oC=cC).prototype,"targetInfo",[Tc,nC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),sC=le(oC.prototype,"nodes",[Tc,iC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rC=oC))||rC),JC=(lC=mc("cc.MountedComponentsInfo"),uC=Zc(XC),hC=Zc([th]),lC((mC=function(){function e(){ce(this,"targetInfo",pC,this),ce(this,"components",dC,this)}return e.prototype.isTarget=function(){},e}(),pC=le((_C=mC).prototype,"targetInfo",[Tc,uC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dC=le(_C.prototype,"components",[Tc,hC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fC=_C))||fC),$C=(vC=mc("cc.PrefabInstance"),gC=Zc(qC),yC=Zc([ZC]),xC=Zc([JC]),SC=Zc([QC]),TC=Zc([XC]),vC((DC=function(){function e(){ce(this,"fileId",CC,this),ce(this,"prefabRootNode",AC,this),ce(this,"mountedChildren",wC,this),ce(this,"mountedComponents",PC,this),ce(this,"propertyOverrides",RC,this),ce(this,"removedComponents",IC,this),this.targetMap={}}var t=e.prototype;return t.findPropertyOverride=function(){},t.removePropertyOverride=function(){},e}(),CC=le((EC=DC).prototype,"fileId",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),AC=le(EC.prototype,"prefabRootNode",[Tc,gC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wC=le(EC.prototype,"mountedChildren",[Tc,yC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),PC=le(EC.prototype,"mountedComponents",[Tc,xC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),RC=le(EC.prototype,"propertyOverrides",[Tc,SC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),IC=le(EC.prototype,"removedComponents",[Tc,TC],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),bC=EC))||bC),eA=(OC=mc("cc.PrefabInfo"),MC=Zc(qC),NC=Zc($C),LC=Zc([YC]),OC((zC=le((FC=function(){ce(this,"root",zC,this),ce(this,"asset",UC,this),ce(this,"fileId",kC,this),ce(this,"instance",GC,this),ce(this,"targetOverrides",HC,this),ce(this,"nestedPrefabInstanceRoots",VC,this)}).prototype,"root",[Tc,MC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UC=le(FC.prototype,"asset",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kC=le(FC.prototype,"fileId",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),GC=le(FC.prototype,"instance",[Tc,NC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),HC=le(FC.prototype,"targetOverrides",[Tc,LC],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),VC=le(FC.prototype,"nestedPrefabInstanceRoots",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BC=FC))||BC);function tA(e){var t=e._prefab;if(t&&t.instance){if(!t.asset)return M(3701,e.name),void(t.instance=void 0);var n=e._objFlags,i=e._parent,r=e._id,o=e._prefab;e[hl],u.game._isCloning=!0,t.asset._doInstantiate(e),u.game._isCloning=!1,e._objFlags=n,e._parent=i,e._id=r,e._prefab&&(e._prefab.instance=null==o?void 0:o.instance)}}function nA(e,t,n){var i;if(t&&e){var r=t,o=null===(i=e._prefab)||void 0===i?void 0:i.instance;!n&&o&&(t[o.fileId]={},r=t[o.fileId]);var a=e._prefab;a&&(r[a.fileId]=e);for(var s=e.components,c=0;c<s.length;c++){var l=s[c];l.__prefab&&(r[l.__prefab.fileId]=l)}for(var u=0;u<e.children.length;u++)nA(e.children[u],r,!1)}}function iA(e,t){if(!e)return null;for(var n=t,i=0;i<e.length;i++){if(!n)return null;n=n[e[i]]}return n}function rA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=iA(r.targetInfo.localID,n);if(!o)continue;var a=n,s=r.targetInfo.localID;if(s.length>0)for(var c=0;c<s.length-1;c++)a=a[s[c]];if(r.nodes)for(var l=0;l<r.nodes.length;l++){var u=r.nodes[l];u&&(o._children.push(u),u._parent=o,nA(u,a,!1),u._siblingIndex=o._children.length-1,lA(u,!0))}}}}function oA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r&&r.targetInfo){var o=iA(r.targetInfo.localID,n);if(!o)continue;if(r.components)for(var a=0;a<r.components.length;a++){var s=r.components[a];s&&(s.node=o,o._components.push(s))}}}}function aA(e,t,n){if(t)for(var i=0;i<t.length;i++){var r=t[i];if(r){var o=iA(r.localID,n);if(!o||!o.node)continue;var a=o.node.components.indexOf(o);a>=0&&o.node._components.splice(a,1)}}}function sA(e,t,n){if(!(t.length<=0))for(var i=null,r=0;r<t.length;r++){var o=t[r];if(o&&o.targetInfo){if(!(i=iA(o.targetInfo.localID,n)))continue;var a=i,s=o.propertyPath.slice();if(s.length>0){var c=s.pop();if(!c)continue;for(var l=0;l<s.length&&(a=a[s[l]]);l++);if(!a)continue;if(Array.isArray(a))if("length"===c)a[c]=o.value;else{var u=Number.parseInt(c);Number.isInteger(u)&&u<a.length&&(a[c]=o.value)}else a[c]instanceof ht?a[c].set(o.value):a[c]=o.value}}}}function cA(e){var t,n=null===(t=e._prefab)||void 0===t?void 0:t.targetOverrides;if(n)for(var i=0;i<n.length;i++){var r,o,a=n[i],s=a.source,c=a.sourceInfo;if(c){var l,u,h=null===(l=a.source)||void 0===l||null===(u=l._prefab)||void 0===u?void 0:u.instance;h&&h.targetMap&&(s=iA(c.localID,h.targetMap))}if(s){var f,_=a.targetInfo;if(_){var p=null===(r=a.target)||void 0===r||null===(o=r._prefab)||void 0===o?void 0:o.instance;if(p&&p.targetMap&&(f=iA(_.localID,p.targetMap))){var d=a.propertyPath.slice(),m=s;if(d.length>0){var v=d.pop();if(!v)return;for(var g=0;g<d.length&&(m=m[d[g]]);g++);if(!m)continue;m[v]=f}}}}}}function lA(e,t){void 0===t&&(t=!1);var n=e._prefab,i=null==n?void 0:n.instance;if(i){tA(e);var r={};i.targetMap=r,nA(e,r,!0),rA(0,i.mountedChildren,r),aA(0,i.removedComponents,r),oA(0,i.mountedComponents,r),sA(0,i.propertyOverrides,r)}t&&e&&e.children&&e.children.forEach((function(e){lA(e,!0)}))}function uA(e){var t=e._prefab;t&&t.nestedPrefabInstanceRoots&&t.nestedPrefabInstanceRoots.forEach((function(e){lA(e)}))}u._PrefabInfo=eA;var hA,fA,_A,pA,dA,mA,vA,gA,yA,xA,SA,TA,bA,EA,CA=Object.freeze({__proto__:null,TargetInfo:XC,TargetOverrideInfo:YC,CompPrefabInfo:KC,PropertyOverrideInfo:QC,MountedChildrenInfo:ZC,MountedComponentsInfo:JC,PrefabInstance:$C,PrefabInfo:eA,createNodeWithPrefab:tA,generateTargetMap:nA,getTarget:iA,applyMountedChildren:rA,applyMountedComponents:oA,applyRemovedComponents:aA,applyPropertyOverrides:sA,applyTargetOverrides:cA,expandPrefabInstanceNode:lA,expandNestedPrefabInstanceNode:uA}),AA=st({AUTO:0,SINGLE_INSTANCE:1,MULTI_INSTANCE:2}),wA=e("Prefab",mc("cc.Prefab")((vA=mA=function(e){function t(){var t;return ce(t=e.call(this)||this,"data",_A,oe(t)),ce(t,"optimizationPolicy",pA,oe(t)),ce(t,"persistent",dA,oe(t)),t._createFunction=void 0,t._instantiatedTimes=void 0,t._createFunction=null,t._instantiatedTimes=0,t}$(t,e);var n=t.prototype;return n.createNode=function(e){var t=u.instantiate(this);t.name=this.name,e(null,t)},n.compileCreateFunction=function(){var e,t;this._createFunction=(t=(e=this.data)instanceof u._BaseNode&&e,new Hb(e,t).result)},n._doInstantiate=function(e){return this.data._prefab||D(3700),this._createFunction||this.compileCreateFunction(),this._createFunction(e)},n._instantiate=function(){var e;return this.optimizationPolicy!==AA.SINGLE_INSTANCE&&(this.optimizationPolicy===AA.MULTI_INSTANCE||this._instantiatedTimes+1>=t.OptimizationPolicyThreshold)?(e=this._doInstantiate(),this.data._instantiate(e)):e=this.data._instantiate(),++this._instantiatedTimes,e},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.data=new qC,this.data.name="(Missing Node)";var n=new u._PrefabInfo;n.asset=this,n.root=this.data,this.data._prefab=n},n.validate=function(){return!!this.data},n.onLoaded=function(){var e=this.data;uA(e),cA(e)},t}(Nu),mA.OptimizationPolicy=AA,mA.OptimizationPolicyThreshold=3,_A=le((fA=vA).prototype,"data",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pA=le(fA.prototype,"optimizationPolicy",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AA.AUTO}}),dA=le(fA.prototype,"persistent",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hA=fA))||hA);rt.value(wA,"_utils",CA),u.Prefab=wA,De(u,"cc._Prefab","Prefab"),e("PrefabLink",(gA=mc("cc.PrefabLink"),yA=Zc(wA),xA=Nc(),gA((EA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"prefab",bA,oe(t)),t}return $(t,e),t}(th),bA=le((TA=EA).prototype,"prefab",[yA,Tc,xA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SA=TA))||SA));var PA=new In;function RA(e,t,n,i){i||(i=new In),e.convertToUINode(t,n,i);var r=n.position;return i.add(r),i}function IA(e,t,n){return n||(n=new In),e.worldToScreen(t,n),n.x/=u.view.getScaleX(),n.y/=u.view.getScaleY(),n}var DA,OA,MA=e("convertUtils",{WorldNode3DToLocalNodeUI:RA,WorldNode3DToWorldNodeUI:IA});u.pipelineUtils=MA,k(u.pipelineUtils,"cc.pipelineUtils",[{name:"WorldNode3DToLocalNodeUI",newName:"convertToUINode",targetName:"cc.Camera.prototype",customFunction:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=t[0],r=t[3]||PA;return i.convertToUINode(t[1],t[2],r),r.add(t[2].position),t[3]||r.clone()}}]),G(ev.prototype,"TextureBase.prototype",[{name:"hasPremultipliedAlpha"},{name:"setPremultiplyAlpha"},{name:"setFlipY"}]),k(GS.prototype,"RenderTexture.prototype",[{name:"getGFXWindow",customFunction:function(){return this._window}}]);var NA,LA=e("BufferAsset",mc("cc.BufferAsset")((le((OA=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._buffer=null,t}$(t,e);var n=t.prototype;return n.buffer=function(){return this._buffer},n.validate=function(){return!!this.buffer},Z(t,[{key:"_nativeAsset",get:function(){return this._buffer},set:function(e){e instanceof ArrayBuffer?this._buffer=e:this._buffer=e.buffer}}]),t}(Nu)).prototype,"_nativeAsset",[sl],Object.getOwnPropertyDescriptor(OA.prototype,"_nativeAsset"),OA.prototype),DA=OA))||DA);u.BufferAsset=LA;var BA=((NA={})[di.UNORM]="Uint",NA[di.SNORM]="Int",NA[di.UINT]="Uint",NA[di.INT]="Int",NA[di.UFLOAT]="Float",NA[di.FLOAT]="Float",NA.default="Uint",NA);function FA(e){return""+(BA[e.type]||BA.default)+e.size/e.count*8}function zA(e,t,n,i,r){void 0===n&&(n=pi.R32F),void 0===i&&(i=0),void 0===r&&(r=0);var o=eo[n];r||(r=o.size);for(var a="set"+FA(o),s=o.size/o.count,c=Math.floor(t.length/o.count),l=hh.isLittleEndian,u=0;u<c;++u)for(var h=i+r*u,f=0;f<o.count;++f){var _=h+s*f;e[a](_,t[o.count*u+f],l)}}function UA(e,t,n,i,r,o){void 0===t&&(t=pi.R32F),void 0===n&&(n=0),void 0===i&&(i=e.byteLength-n),void 0===r&&(r=0),void 0===o&&(o=[]);var a=eo[t];r||(r=a.size);for(var s="get"+FA(a),c=a.size/a.count,l=Math.floor(i/r),u=hh.isLittleEndian,h=0;h<l;++h)for(var f=n+r*h,_=0;_<a.count;++_){var p=f+c*_;o[a.count*h+_]=e[s](p,u)}return o}function kA(e,t,n,i,r,o,a){void 0===n&&(n=pi.R32F),void 0===i&&(i=0),void 0===r&&(r=e.byteLength-i),void 0===o&&(o=0),a||(a=new DataView(e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)));var s=eo[n];o||(o=s.size);for(var c="set"+FA(s),l="get"+FA(s),u=s.size/s.count,h=Math.floor(r/o),f=hh.isLittleEndian,_=0;_<h;++_)for(var p=i+o*_,d=0;d<s.count;++d){var m=p+u*d,v=e[l](m,f);a[c](m,t(v,d,e),f)}return a}var GA,HA,VA=e("RenderingSubMesh",function(){var e=t.prototype;function t(e,t,n,i,r){void 0===i&&(i=null),void 0===r&&(r=null),this.mesh=void 0,this.subMeshIdx=void 0,this._flatBuffers=[],this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0,this._vertexIdChannel=void 0,this._geometricInfo=void 0,this._vertexBuffers=void 0,this._attributes=void 0,this._indexBuffer=null,this._indirectBuffer=null,this._primitiveMode=void 0,this._iaInfo=void 0,this._attributes=t,this._vertexBuffers=e,this._indexBuffer=i,this._indirectBuffer=r,this._primitiveMode=n,this._iaInfo=new Or(t,e,i,r),this._init()}return e._init=function(){},e.genFlatBuffers=function(){if(!this._flatBuffers.length&&this.mesh&&void 0!==this.subMeshIdx){var e=this.mesh,t=0,n=e.struct.primitives[this.subMeshIdx];n.indexView&&(t=n.indexView.count);for(var i=0;i<n.vertexBundelIndices.length;i++){var r=n.vertexBundelIndices[i],o=e.struct.vertexBundles[r],a=n.indexView?n.indexView.count:o.view.count,s=o.view.stride,c=s*a,l=new Uint8Array(e.data.buffer,o.view.offset,o.view.length),u=new Uint8Array(n.indexView?c:o.view.length);if(n.indexView){for(var h=e.readIndices(this.subMeshIdx),f=0;f<t;++f)for(var _=f*s,p=h[f]*s,d=0;d<s;++d)u[_+d]=l[p+d];this._flatBuffers.push({stride:s,count:a,buffer:u})}else u.set(e.data.subarray(o.view.offset,o.view.offset+o.view.length)),this._flatBuffers.push({stride:s,count:a,buffer:u})}}},e.destroy=function(){for(var e=0;e<this.vertexBuffers.length;e++)this.vertexBuffers[e].destroy();if(this.vertexBuffers.length=0,this._indexBuffer&&(this._indexBuffer.destroy(),this._indexBuffer=null),this._jointMappedBuffers&&this._jointMappedBufferIndices){for(var t=0;t<this._jointMappedBufferIndices.length;t++)this._jointMappedBuffers[this._jointMappedBufferIndices[t]].destroy();this._jointMappedBuffers=void 0,this._jointMappedBufferIndices=void 0}this._indirectBuffer&&(this._indirectBuffer.destroy(),this._indirectBuffer=null)},e.enableVertexIdChannel=function(e){if(!this._vertexIdChannel){var t=this.vertexBuffers.length,n=this.attributes.length,i=this._allocVertexIdBuffer(e);this._vertexBuffers.push(i),this._attributes.push(new Ir("a_vertexId",pi.R32F,!1,t)),this._iaInfo.attributes=this._attributes,this._iaInfo.vertexBuffers=this._vertexBuffers,this._vertexIdChannel={stream:t,index:n}}},e._allocVertexIdBuffer=function(e){for(var t=0===this.vertexBuffers.length||0===this.vertexBuffers[0].stride?0:this.vertexBuffers[0].size/this.vertexBuffers[0].stride,n=new Float32Array(t),i=0;i<t;++i)n[i]=i+.5;var r=e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,n.byteLength,n.BYTES_PER_ELEMENT));return r.update(n),r},Z(t,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexBuffers",get:function(){return this._vertexBuffers}},{key:"indexBuffer",get:function(){return this._indexBuffer}},{key:"indirectBuffer",get:function(){return this._indirectBuffer}},{key:"primitiveMode",get:function(){return this._primitiveMode}},{key:"geometricInfo",get:function(){if(this._geometricInfo)return this._geometricInfo;if(void 0===this.mesh)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:In.ZERO,max:In.ZERO}};if(void 0===this.subMeshIdx)return{positions:new Float32Array,indices:new Uint8Array,boundingBox:{min:In.ZERO,max:In.ZERO}};var e=this.mesh,t=this.subMeshIdx,n=e.readAttribute(t,Zi.ATTR_POSITION),i=e.readIndices(t),r=new In,o=new In,a=this.attributes.find((function(e){return e.name===Zi.ATTR_POSITION}));if(a){var s=eo[a.format].count;2===s?(r.set(n[0],n[1],0),o.set(n[0],n[1],0)):(r.set(n[0],n[1],n[2]),o.set(n[0],n[1],n[2]));for(var c=0;c<n.length;c+=s)2===s?(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y):(r.x=n[c]>r.x?n[c]:r.x,r.y=n[c+1]>r.y?n[c+1]:r.y,r.z=n[c+2]>r.z?n[c+2]:r.z,o.x=n[c]<o.x?n[c]:o.x,o.y=n[c+1]<o.y?n[c+1]:o.y,o.z=n[c+2]<o.z?n[c+2]:o.z)}return this._geometricInfo={positions:n,indices:i,boundingBox:{max:r,min:o}},this._geometricInfo}},{key:"flatBuffers",get:function(){return this._flatBuffers}},{key:"jointMappedBuffers",get:function(){var e=this;if(this._jointMappedBuffers)return this._jointMappedBuffers;var t=this._jointMappedBuffers=[],n=this._jointMappedBufferIndices=[];if(!this.mesh||void 0===this.subMeshIdx)return this._jointMappedBuffers=this.vertexBuffers;var i,r,o=this.mesh.struct,a=o.primitives[this.subMeshIdx];if(!o.jointMaps||void 0===a.jointMapIndex||!o.jointMaps[a.jointMapIndex])return this._jointMappedBuffers=this.vertexBuffers;for(var s=u.director.root.device,c=0;c<a.vertexBundelIndices.length;c++){var l=o.vertexBundles[a.vertexBundelIndices[c]];r=0,i=pi.UNKNOWN;for(var h=0;h<l.attributes.length;h++){var f=l.attributes[h];if(f.name===Zi.ATTR_JOINTS){i=f.format;break}r+=eo[f.format].size}i?function(){var u=new Uint8Array(e.mesh.data.buffer,l.view.offset,l.view.length),h=new DataView(u.slice().buffer),f=o.jointMaps[a.jointMapIndex];kA(h,(function(e){return f.indexOf(e)}),i,r,l.view.length,l.view.stride,h);var _=s.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,l.view.length,l.view.stride));_.update(h.buffer),t.push(_),n.push(c)}():t.push(this.vertexBuffers[a.vertexBundelIndices[c]])}return this._vertexIdChannel&&t.push(this._allocVertexIdBuffer(s)),t}},{key:"iaInfo",get:function(){return this._iaInfo}}]),t}());!function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.MOUSE_ENTER="mouse-enter",e.MOUSE_LEAVE="mouse-leave",e.KEY_DOWN="keydown",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion",e.TRANSFORM_CHANGED="transform-changed",e.SCENE_CHANGED_FOR_PERSISTS="scene-changed-for-persists",e.SIZE_CHANGED="size-changed",e.ANCHOR_CHANGED="anchor-changed",e.COLOR_CHANGED="color-changed",e.CHILD_ADDED="child-added",e.CHILD_REMOVED="child-removed",e.PARENT_CHANGED="parent-changed",e.NODE_DESTROYED="node-destroyed",e.LAYER_CHANGED="layer-changed",e.SIBLING_ORDER_CHANGED="sibling-order-changed"}(GA||(GA=e("SystemEventType",{}))),function(e){e.TOUCH_START="touch-start",e.TOUCH_MOVE="touch-move",e.TOUCH_END="touch-end",e.TOUCH_CANCEL="touch-cancel",e.MOUSE_DOWN="mouse-down",e.MOUSE_MOVE="mouse-move",e.MOUSE_UP="mouse-up",e.MOUSE_WHEEL="mouse-wheel",e.KEY_DOWN="keydown",e.KEY_PRESSING="key-pressing",e.KEY_UP="keyup",e.DEVICEMOTION="devicemotion"}(HA||(HA={})),u.SystemEventType=GA;var WA,jA=new Array(16),qA=null,XA=new Kn,YA=[Wb.TOUCH_START,Wb.TOUCH_MOVE,Wb.TOUCH_END,Wb.TOUCH_CANCEL],KA=[Wb.MOUSE_DOWN,Wb.MOUSE_ENTER,Wb.MOUSE_MOVE,Wb.MOUSE_LEAVE,Wb.MOUSE_UP,Wb.MOUSE_WHEEL];!function(e){e[e.ADD_POINTER_EVENT_PROCESSOR=0]="ADD_POINTER_EVENT_PROCESSOR",e[e.REMOVE_POINTER_EVENT_PROCESSOR=1]="REMOVE_POINTER_EVENT_PROCESSOR",e[e.MARK_LIST_DIRTY=2]="MARK_LIST_DIRTY"}(WA||(WA={}));var QA,ZA,JA,$A,ew,tw,nw,iw,rw,ow,aw,sw,cw,lw,uw,hw,fw,_w,pw,dw,mw,vw,gw,yw,xw,Sw,Tw,bw,Ew,Cw,Aw,ww,Pw,Rw,Iw,Dw,Ow,Mw,Nw,Lw,Bw,Fw,zw,Uw,kw,Gw,Hw,Vw,Ww,jw,qw,Xw,Yw,Kw,Qw,Zw,Jw,$w,eP,tP,nP,iP,rP,oP,aP,sP,cP,lP,uP,hP,fP,_P,pP,dP,mP,vP,gP,yP,xP,SP,TP,bP,EP,CP,AP,wP,PP,RP,IP,DP,OP,MP,NP,LP,BP,FP,zP,UP,kP,GP,HP,VP,WP,jP,qP,XP,YP,KP,QP,ZP,JP,$P,eR,tR,nR,iR,rR,oR,aR,sR,cR,lR,uR,hR,fR,_R,pR,dR,mR,vR,gR,yR,xR,SR,TR,bR,ER,CR,AR,wR,PR,RR,IR,DR,OR,MR,NR,LR,BR,FR,zR,UR,kR,GR,HR,VR,WR,jR,qR,XR,YR,KR,QR,ZR,JR,$R,eI,tI,nI,iI,rI,oI,aI,sI,cI,lI,uI,hI,fI,_I,pI,dI,mI,vI,gI,yI,xI,SI,TI,bI,EI,CI,AI,wI,PI,RI=function(){var e=t.prototype;function t(e){this._isEnabled=!1,this.claimedTouchIdList=[],this.maskList=null,this.cachedCameraPriority=0,this.previousMouseIn=!1,this.bubblingTarget=null,this.capturingTarget=null,this.shouldHandleEventMouse=!1,this.shouldHandleEventTouch=!1,this._node=void 0,this._node=e}return e.setEnabled=function(e,n){if(void 0===n&&(n=!1),this._isEnabled!==e){this._isEnabled=e;var i=this.node.children;if(e&&this._attachMask(),t.callbacksInvoker.emit(WA.MARK_LIST_DIRTY),n&&i.length>0)for(var r=0;r<i.length;++r)i[r]._eventProcessor.setEnabled(e,!0)}},e._searchComponentsInParent=function(e){var t=this.node;if(e){for(var n=0,i=[],r=t;r&&qC.isNode(r);r=r.parent,++n){var o=r.getComponent(e);if(o){var a={index:n,comp:o};i?i.push(a):i=[a]}}return i.length>0?i:null}return null},e._attachMask=function(){this.maskList=this._searchComponentsInParent(t._maskComp)},e.reattach=function(){var e,n=this;this.node.walk((function(i){e||(e=n._searchComponentsInParent(t._maskComp)),i.eventProcessor.maskList=e}))},e.destroy=function(){qA===this._node&&(qA=null),this.capturingTarget&&this.capturingTarget.clear(),this.bubblingTarget&&this.bubblingTarget.clear(),t.callbacksInvoker.emit(WA.REMOVE_POINTER_EVENT_PROCESSOR,this)},e._isTouchEvent=function(e){return-1!==YA.indexOf(e)},e._isMouseEvent=function(e){return-1!==KA.indexOf(e)},e._hasTouchListeners=function(){for(var e=0;e<YA.length;++e){var t=YA[e];if(this.hasEventListener(t))return!0}return!1},e._hasMouseListeners=function(){for(var e=0;e<KA.length;++e){var t=KA[e];if(this.hasEventListener(t))return!0}return!1},e._hasPointerListeners=function(){return!!this._hasTouchListeners()||this._hasMouseListeners()},e._tryEmittingAddEvent=function(e){var n=this._isTouchEvent(e),i=this._isMouseEvent(e);n?this.shouldHandleEventTouch=!0:i&&(this.shouldHandleEventMouse=!0),!n&&!i||this._hasPointerListeners()||t.callbacksInvoker.emit(WA.ADD_POINTER_EVENT_PROCESSOR,this)},e._newCallbacksInvoker=function(){var e=this,n=new tu;return n._registerOffCallback((function(){e.shouldHandleEventTouch&&!e._hasTouchListeners()&&(e.shouldHandleEventTouch=!1),e.shouldHandleEventMouse&&!e._hasMouseListeners()&&(e.shouldHandleEventMouse=!1),e._hasPointerListeners()||t.callbacksInvoker.emit(WA.REMOVE_POINTER_EVENT_PROCESSOR,e)})),n},e.on=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n),t},e.once=function(e,t,n,i){var r,o;return this._tryEmittingAddEvent(e),((i=!!i)?null!==(r=this.capturingTarget)&&void 0!==r?r:this.capturingTarget=this._newCallbacksInvoker():null!==(o=this.bubblingTarget)&&void 0!==o?o:this.bubblingTarget=this._newCallbacksInvoker()).on(e,t,n,!0),t},e.off=function(e,t,n,i){var r;null===(r=(i=!!i)?this.capturingTarget:this.bubblingTarget)||void 0===r||r.off(e,t,n)},e.targetOff=function(e){var n,i;null===(n=this.capturingTarget)||void 0===n||n.removeAll(e),null===(i=this.bubblingTarget)||void 0===i||i.removeAll(e),this.shouldHandleEventTouch&&!this._hasTouchListeners()&&(this.shouldHandleEventTouch=!1),this.shouldHandleEventMouse&&!this._hasMouseListeners()&&(this.shouldHandleEventMouse=!1),this._hasPointerListeners()||t.callbacksInvoker.emit(WA.REMOVE_POINTER_EVENT_PROCESSOR,this)},e.emit=function(e,t,n,i,r,o){var a;null===(a=this.bubblingTarget)||void 0===a||a.emit(e,t,n,i,r,o)},e.dispatchEvent=function(e){var t,n=this.node,i=0;for(e.target=n,jA.length=0,this.getCapturingTargets(e.type,jA),e.eventPhase=1,i=jA.length-1;i>=0;--i)if((t=jA[i]).eventProcessor.capturingTarget&&(e.currentTarget=t,t.eventProcessor.capturingTarget.emit(e.type,e,jA),e.propagationStopped))return void(jA.length=0);if(jA.length=0,e.eventPhase=2,e.currentTarget=n,this.capturingTarget&&this.capturingTarget.emit(e.type,e),!e.propagationImmediateStopped&&this.bubblingTarget&&this.bubblingTarget.emit(e.type,e),!e.propagationStopped&&e.bubbles)for(this.getBubblingTargets(e.type,jA),e.eventPhase=3,i=0;i<jA.length;++i)if((t=jA[i]).eventProcessor.bubblingTarget&&(e.currentTarget=t,t.eventProcessor.bubblingTarget.emit(e.type,e),e.propagationStopped))return void(jA.length=0);jA.length=0},e.hasEventListener=function(e,t,n){var i=!1;return this.bubblingTarget&&(i=this.bubblingTarget.hasEventListener(e,t,n)),!i&&this.capturingTarget&&(i=this.capturingTarget.hasEventListener(e,t,n)),i},e.getCapturingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.capturingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e.getBubblingTargets=function(e,t){for(var n=this._node.parent;n;){var i;(null===(i=n.eventProcessor.bubblingTarget)||void 0===i?void 0:i.hasEventListener(e))&&t.push(n),n=n.parent}},e._handleEventMouse=function(e){switch(e.type){case HA.MOUSE_DOWN:return this._handleMouseDown(e);case HA.MOUSE_MOVE:return this._handleMouseMove(e);case HA.MOUSE_UP:return this._handleMouseUp(e);case HA.MOUSE_WHEEL:return this._handleMouseWheel(e);default:return!1}},e._handleMouseDown=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(XA=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(XA)||(e.type=Wb.MOUSE_DOWN,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseMove=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(XA=e.getUILocation(),t._uiProps.uiTransformComp.isHit(XA)?(this.previousMouseIn||(qA&&qA!==t&&(e.type=Wb.MOUSE_LEAVE,qA.dispatchEvent(e),qA.eventProcessor.previousMouseIn=!1),qA=t,e.type=Wb.MOUSE_ENTER,t.dispatchEvent(e),this.previousMouseIn=!0),e.type=Wb.MOUSE_MOVE,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0):(this.previousMouseIn&&(e.type=Wb.MOUSE_LEAVE,t.dispatchEvent(e),this.previousMouseIn=!1,qA=null),1)))},e._handleMouseUp=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(XA=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(XA)||(e.type=Wb.MOUSE_UP,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleMouseWheel=function(e){var t=this._node;return!(!t||!t._uiProps.uiTransformComp||(XA=e.getUILocation(),!t._uiProps.uiTransformComp.isHit(XA)||(e.type=Wb.MOUSE_WHEEL,e.bubbles=!0,t.dispatchEvent(e),e.propagationStopped=!0,0)))},e._handleEventTouch=function(e){switch(e.type){case HA.TOUCH_START:return this._handleTouchStart(e);case HA.TOUCH_MOVE:return this._handleTouchMove(e);case HA.TOUCH_END:return this._handleTouchEnd(e);case HA.TOUCH_CANCEL:return this._handleTouchCancel(e);default:return!1}},e._handleTouchStart=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.getUILocation(XA),!t._uiProps.uiTransformComp.isHit(XA)||(e.type=Wb.TOUCH_START,e.bubbles=!0,t.dispatchEvent(e),0)))},e._handleTouchMove=function(e){var t=this.node;return!(!t||!t._uiProps.uiTransformComp||(e.type=Wb.TOUCH_MOVE,e.bubbles=!0,t.dispatchEvent(e),0))},e._handleTouchEnd=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.getUILocation(XA),t._uiProps.uiTransformComp.isHit(XA)?e.type=Wb.TOUCH_END:e.type=Wb.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},e._handleTouchCancel=function(e){var t=this.node;t&&t._uiProps.uiTransformComp&&(e.type=Wb.TOUCH_CANCEL,e.bubbles=!0,t.dispatchEvent(e))},Z(t,[{key:"isEnabled",get:function(){return this._isEnabled}},{key:"node",get:function(){return this._node}}]),t}();RI._maskComp=null,RI.callbacksInvoker=new tu,u.NodeEventProcessor=RI;var II=new In(0,1,0),DI=new In,OI=new $n,MI=new Pn,NI=new Fn,LI=function(e){var t=1/Math.max(Math.max(Math.max(e.x,e.y),e.z),1e-4);t<1&&(e.x*=t,e.y*=t,e.z*=t)},BI=(QA=mc("cc.AmbientInfo"),ZA=Oc(),JA=bc("_skyColor"),$A=bc("_skyIllum"),ew=bc("_groundAlbedo"),tw=Nc(),nw=Fc(),iw=Zc(Lt),rw=Fc(),ow=Nc(),aw=Fc(),QA(sw=ZA((dw=function(){function e(){ce(this,"_skyColorHDR",lw,this),ce(this,"_skyIllumHDR",uw,this),ce(this,"_groundAlbedoHDR",hw,this),ce(this,"_skyColorLDR",fw,this),ce(this,"_skyIllumLDR",_w,this),ce(this,"_groundAlbedoLDR",pw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},Z(e,[{key:"skyColorHDR",get:function(){return this._skyColorHDR}},{key:"groundAlbedoHDR",get:function(){return this._groundAlbedoHDR}},{key:"skyIllumHDR",get:function(){return this._skyIllumHDR}},{key:"skyColorLDR",get:function(){return this._skyColorLDR}},{key:"groundAlbedoLDR",get:function(){return this._groundAlbedoLDR}},{key:"skyIllumLDR",get:function(){return this._skyIllumLDR}},{key:"skyLightingColor",get:function(){var e=u.director.root.pipeline.pipelineSceneData.isHDR;return OI.set(e?this._skyColorHDR:this._skyColorLDR),LI(OI),MI.set(255*OI.x,255*OI.y,255*OI.z,255)},set:function(e){OI.set(e.x,e.y,e.z,e.w),u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(OI):this._skyColorLDR.set(OI),this._resource&&this._resource.skyColor.set(OI)}},{key:"skyColor",set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyColorHDR.set(e):this._skyColorLDR.set(e),this._resource&&this._resource.skyColor.set(e)}},{key:"skyIllum",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR:this._skyIllumLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._skyIllumHDR=e:this._skyIllumLDR=e,this._resource&&(this._resource.skyIllum=e)}},{key:"groundLightingColor",get:function(){var e=u.director.root.pipeline.pipelineSceneData.isHDR;return OI.set(e?this._groundAlbedoHDR:this._groundAlbedoLDR),LI(OI),MI.set(255*OI.x,255*OI.y,255*OI.z,255)},set:function(e){OI.set(e.x,e.y,e.z,e.w),u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(OI):this._groundAlbedoLDR.set(OI),this._resource&&this._resource.groundAlbedo.set(OI)}},{key:"groundAlbedo",set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._groundAlbedoHDR.set(e):this._groundAlbedoLDR.set(e),this._resource&&this._resource.groundAlbedo.set(e)}}]),e}(),lw=le((cw=dw).prototype,"_skyColorHDR",[Tc,JA],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $n(.2,.5,.8,1)}}),uw=le(cw.prototype,"_skyIllumHDR",[Tc,$A],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tT.SKY_ILLUM}}),hw=le(cw.prototype,"_groundAlbedoHDR",[Tc,ew],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $n(.2,.2,.2,1)}}),fw=le(cw.prototype,"_skyColorLDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $n(.2,.5,.8,1)}}),_w=le(cw.prototype,"_skyIllumLDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tT.SKY_ILLUM}}),pw=le(cw.prototype,"_groundAlbedoLDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $n(.2,.2,.2,1)}}),le(cw.prototype,"skyLightingColor",[tw,Mc,nw],Object.getOwnPropertyDescriptor(cw.prototype,"skyLightingColor"),cw.prototype),le(cw.prototype,"skyIllum",[Mc,iw,rw],Object.getOwnPropertyDescriptor(cw.prototype,"skyIllum"),cw.prototype),le(cw.prototype,"groundLightingColor",[ow,Mc,aw],Object.getOwnPropertyDescriptor(cw.prototype,"groundLightingColor"),cw.prototype),sw=cw))||sw)||sw);u.AmbientInfo=BI;var FI=(mw=mc("cc.SkyboxInfo"),vw=Oc(),gw=Zc(Av),yw=bc("_envmap"),xw=Zc(Av),Sw=Zc(Av),Tw=Zc(Av),bw=Nc(),Ew=Fc(),Cw=Vc(),Aw=Fc(),ww=Fc(),Pw=Fc(),Rw=Zc(Av),Iw=Fc(),Dw=Nc(),Ow=Zc(Av),Mw=Vc(),mw(Nw=vw((Ww=function(){function e(){ce(this,"_applyDiffuseMap",Bw,this),ce(this,"_envmapHDR",Fw,this),ce(this,"_envmapLDR",zw,this),ce(this,"_diffuseMapHDR",Uw,this),ce(this,"_diffuseMapLDR",kw,this),ce(this,"_enabled",Gw,this),ce(this,"_useIBL",Hw,this),ce(this,"_useHDR",Vw,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.activate()},Z(e,[{key:"applyDiffuseMap",get:function(){return this._applyDiffuseMap},set:function(e){this._applyDiffuseMap=e,this._resource&&(this._resource.useDiffuseMap=e)}},{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=this._enabled))}},{key:"useIBL",get:function(){return this._useIBL},set:function(e){this._useIBL=e,this._resource&&(this._resource.useIBL=this._useIBL)}},{key:"useHDR",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR=this._useHDR,this._useHDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR=e,this._useHDR=e,this._resource&&(this.envmap=this._resource.envmap,this.diffuseMap=this._resource.diffuseMap,null==this.diffuseMap&&(this.applyDiffuseMap=!1)),this._resource&&(this._resource.useHDR=this._useHDR)}},{key:"envmap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR:this._envmapLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._envmapHDR=e:this._envmapLDR=e,this._envmapHDR||(this._diffuseMapHDR=null,this._applyDiffuseMap=!1,this.useIBL=!1),this._resource&&(this._resource.setEnvMaps(this._envmapHDR,this._envmapLDR),this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR),this._resource.useDiffuseMap=this._applyDiffuseMap,this._resource.envmap=e)}},{key:"diffuseMap",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR:this._diffuseMapLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?this._diffuseMapHDR=e:this._diffuseMapLDR=e,this._resource&&this._resource.setDiffuseMaps(this._diffuseMapHDR,this._diffuseMapLDR)}}]),e}(),Bw=le((Lw=Ww).prototype,"_applyDiffuseMap",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Fw=le(Lw.prototype,"_envmapHDR",[Tc,gw,yw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zw=le(Lw.prototype,"_envmapLDR",[Tc,xw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uw=le(Lw.prototype,"_diffuseMapHDR",[Tc,Sw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),kw=le(Lw.prototype,"_diffuseMapLDR",[Tc,Tw],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gw=le(Lw.prototype,"_enabled",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hw=le(Lw.prototype,"_useIBL",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vw=le(Lw.prototype,"_useHDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le(Lw.prototype,"applyDiffuseMap",[bw,Mc,Ew,Cw],Object.getOwnPropertyDescriptor(Lw.prototype,"applyDiffuseMap"),Lw.prototype),le(Lw.prototype,"enabled",[Mc,Aw],Object.getOwnPropertyDescriptor(Lw.prototype,"enabled"),Lw.prototype),le(Lw.prototype,"useIBL",[Mc,ww],Object.getOwnPropertyDescriptor(Lw.prototype,"useIBL"),Lw.prototype),le(Lw.prototype,"useHDR",[Mc,Pw],Object.getOwnPropertyDescriptor(Lw.prototype,"useHDR"),Lw.prototype),le(Lw.prototype,"envmap",[Mc,Rw,Iw],Object.getOwnPropertyDescriptor(Lw.prototype,"envmap"),Lw.prototype),le(Lw.prototype,"diffuseMap",[Dw,Mc,Lc,Ow,Mw],Object.getOwnPropertyDescriptor(Lw.prototype,"diffuseMap"),Lw.prototype),Nw=Lw))||Nw)||Nw);u.SkyboxInfo=FI;var zI=(jw=mc("cc.FogInfo"),qw=Oc(),Xw=Fc(),Yw=Vc(),Kw=Fc(),Qw=Vc(),Zw=Fc(),Jw=Zc(Cb),$w=Vc(),eP=Fc(),tP=Nc(),nP=Zc(Lt),iP=zc(),rP=Gc(),oP=Fc(),aP=Nc(),sP=Zc(Lt),cP=Gc(),lP=Fc(),uP=Nc(),hP=Zc(Lt),fP=Gc(),_P=Fc(),pP=Nc(),dP=Zc(Lt),mP=Uc(),vP=Gc(),gP=Fc(),yP=Nc(),xP=Zc(Lt),SP=Gc(),TP=Fc(),bP=Nc(),EP=Zc(Lt),CP=Gc(),AP=Fc(),jw(wP=qw((kP=UP=function(){function e(){ce(this,"_type",RP,this),ce(this,"_fogColor",IP,this),ce(this,"_enabled",DP,this),ce(this,"_fogDensity",OP,this),ce(this,"_fogStart",MP,this),ce(this,"_fogEnd",NP,this),ce(this,"_fogAtten",LP,this),ce(this,"_fogTop",BP,this),ce(this,"_fogRange",FP,this),ce(this,"_accurate",zP,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this),this._resource.activate()},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"accurate",get:function(){return this._accurate},set:function(e){this._accurate!==e&&(this._accurate=e,this._resource&&(this._resource.accurate=e,e&&(this._resource.type=this._type)))}},{key:"fogColor",get:function(){return this._fogColor},set:function(e){this._fogColor.set(e),this._resource&&(this._resource.fogColor=this._fogColor)}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"fogDensity",get:function(){return this._fogDensity},set:function(e){this._fogDensity=e,this._resource&&(this._resource.fogDensity=e)}},{key:"fogStart",get:function(){return this._fogStart},set:function(e){this._fogStart=e,this._resource&&(this._resource.fogStart=e)}},{key:"fogEnd",get:function(){return this._fogEnd},set:function(e){this._fogEnd=e,this._resource&&(this._resource.fogEnd=e)}},{key:"fogAtten",get:function(){return this._fogAtten},set:function(e){this._fogAtten=e,this._resource&&(this._resource.fogAtten=e)}},{key:"fogTop",get:function(){return this._fogTop},set:function(e){this._fogTop=e,this._resource&&(this._resource.fogTop=e)}},{key:"fogRange",get:function(){return this._fogRange},set:function(e){this._fogRange=e,this._resource&&(this._resource.fogRange=e)}}]),e}(),UP.FogType=Cb,RP=le((PP=kP).prototype,"_type",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Cb.LINEAR}}),IP=le(PP.prototype,"_fogColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn("#C8C8C8")}}),DP=le(PP.prototype,"_enabled",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),OP=le(PP.prototype,"_fogDensity",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),MP=le(PP.prototype,"_fogStart",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),NP=le(PP.prototype,"_fogEnd",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 300}}),LP=le(PP.prototype,"_fogAtten",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),BP=le(PP.prototype,"_fogTop",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.5}}),FP=le(PP.prototype,"_fogRange",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),zP=le(PP.prototype,"_accurate",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(PP.prototype,"enabled",[Mc,Xw,Yw],Object.getOwnPropertyDescriptor(PP.prototype,"enabled"),PP.prototype),le(PP.prototype,"accurate",[Mc,Kw,Qw],Object.getOwnPropertyDescriptor(PP.prototype,"accurate"),PP.prototype),le(PP.prototype,"fogColor",[Mc,Zw],Object.getOwnPropertyDescriptor(PP.prototype,"fogColor"),PP.prototype),le(PP.prototype,"type",[Mc,Jw,$w,eP],Object.getOwnPropertyDescriptor(PP.prototype,"type"),PP.prototype),le(PP.prototype,"fogDensity",[tP,nP,iP,rP,Hc,oP],Object.getOwnPropertyDescriptor(PP.prototype,"fogDensity"),PP.prototype),le(PP.prototype,"fogStart",[aP,sP,cP,lP],Object.getOwnPropertyDescriptor(PP.prototype,"fogStart"),PP.prototype),le(PP.prototype,"fogEnd",[uP,hP,fP,_P],Object.getOwnPropertyDescriptor(PP.prototype,"fogEnd"),PP.prototype),le(PP.prototype,"fogAtten",[pP,dP,mP,vP,gP],Object.getOwnPropertyDescriptor(PP.prototype,"fogAtten"),PP.prototype),le(PP.prototype,"fogTop",[yP,xP,SP,TP],Object.getOwnPropertyDescriptor(PP.prototype,"fogTop"),PP.prototype),le(PP.prototype,"fogRange",[bP,EP,CP,AP],Object.getOwnPropertyDescriptor(PP.prototype,"fogRange"),PP.prototype),wP=PP))||wP)||wP),UI=(GP=mc("cc.ShadowsInfo"),HP=Oc(),VP=Fc(),WP=Zc(Sg),jP=Nc(),qP=Nc(),XP=Fc(),YP=Zc(Lt),KP=Fc(),QP=Nc(),ZP=zc(),JP=Zc(Lt),$P=Fc(),eR=Nc(),tR=Zc(Tg),nR=Fc(),iR=Nc(),rR=Zc(Nt),oR=Nc(),aR=Zc(Lt),sR=Fc(),cR=Nc(),lR=Zc(Lt),uR=Fc(),hR=Nc(),fR=Zc(xg),_R=Fc(),pR=Nc(),dR=Zc(Bt),mR=Fc(),vR=Nc(),gR=Zc(Lt),yR=Fc(),xR=Nc(),SR=Zc(Lt),TR=Fc(),bR=Nc(),ER=zc(),CR=Zc(Lt),AR=Fc(),wR=Nc(),PR=zc(),RR=Zc(Lt),IR=Fc(),DR=Nc(),OR=Zc(Lt),MR=Fc(),NR=Nc(),GP(LR=HP((tI=function(){function e(){ce(this,"_type",FR,this),ce(this,"_enabled",zR,this),ce(this,"_normal",UR,this),ce(this,"_distance",kR,this),ce(this,"_shadowColor",GR,this),ce(this,"_firstSetCSM",HR,this),ce(this,"_fixedArea",VR,this),ce(this,"_pcf",WR,this),ce(this,"_bias",jR,this),ce(this,"_normalBias",qR,this),ce(this,"_near",XR,this),ce(this,"_far",YR,this),ce(this,"_shadowDistance",KR,this),ce(this,"_invisibleOcclusionRange",QR,this),ce(this,"_orthoSize",ZR,this),ce(this,"_maxReceived",JR,this),ce(this,"_size",$R,this),ce(this,"_saturation",eI,this),this._resource=null}var t=e.prototype;return t.setPlaneFromNode=function(e){e.getWorldRotation(NI),this.normal=In.transformQuat(DI,II,NI),e.getWorldPosition(DI),this.distance=In.dot(this._normal,DI)},t.activate=function(e){this.pcf=Math.min(this._pcf,Tg.SOFT_2X),this._resource=e,this._resource.initialize(this),this._resource.activate()},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e,e&&(this._resource.type=this._type)))}},{key:"type",get:function(){return this._type},set:function(e){this._type=e,this._resource&&(this._resource.type=e)}},{key:"shadowColor",get:function(){return this._shadowColor},set:function(e){this._shadowColor.set(e),this._resource&&(this._resource.shadowColor=e)}},{key:"normal",get:function(){return this._normal},set:function(e){In.copy(this._normal,e),this._resource&&(this._resource.normal=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance=e,this._resource&&(this._resource.distance=e)}},{key:"saturation",get:function(){return this._saturation},set:function(e){e>1?(this._saturation=e/e,this._resource&&(this._resource.saturation=e/e)):(this._saturation=e,this._resource&&(this._resource.saturation=e))}},{key:"pcf",get:function(){return this._pcf},set:function(e){this._pcf=e,this._resource&&(this._resource.pcf=e)}},{key:"maxReceived",get:function(){return this._maxReceived},set:function(e){this._maxReceived=e,this._resource&&(this._resource.maxReceived=e)}},{key:"bias",get:function(){return this._bias},set:function(e){this._bias=e,this._resource&&(this._resource.bias=e)}},{key:"normalBias",get:function(){return this._normalBias},set:function(e){this._normalBias=e,this._resource&&(this._resource.normalBias=e)}},{key:"shadowMapSize",get:function(){return this._size.x},set:function(e){this._size.set(e,e),this._resource&&(this._resource.size.set(e,e),this._resource.shadowMapDirty=!0)}},{key:"size",get:function(){return this._size}},{key:"fixedArea",get:function(){return this._fixedArea},set:function(e){this._fixedArea=e,this._resource&&(this._resource.fixedArea=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._resource&&(this._resource.near=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=Math.min(e,Eg.MAX_FAR),this._resource&&(this._resource.far=this._far)}},{key:"invisibleOcclusionRange",get:function(){return this._invisibleOcclusionRange},set:function(e){this._invisibleOcclusionRange=Math.min(e,Eg.MAX_FAR),this._resource&&(this._resource.invisibleOcclusionRange=this._invisibleOcclusionRange)}},{key:"shadowDistance",get:function(){return this._shadowDistance},set:function(e){this._shadowDistance=Math.min(e,Eg.MAX_FAR),this._resource&&(this._resource.shadowDistance=this._shadowDistance)}},{key:"orthoSize",get:function(){return this._orthoSize},set:function(e){this._orthoSize=e,this._resource&&(this._resource.orthoSize=e)}}]),e}(),FR=le((BR=tI).prototype,"_type",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Sg.Planar}}),zR=le(BR.prototype,"_enabled",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),UR=le(BR.prototype,"_normal",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,1,0)}}),kR=le(BR.prototype,"_distance",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GR=le(BR.prototype,"_shadowColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(0,0,0,76)}}),HR=le(BR.prototype,"_firstSetCSM",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),VR=le(BR.prototype,"_fixedArea",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WR=le(BR.prototype,"_pcf",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Tg.HARD}}),jR=le(BR.prototype,"_bias",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e-5}}),qR=le(BR.prototype,"_normalBias",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XR=le(BR.prototype,"_near",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),YR=le(BR.prototype,"_far",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),KR=le(BR.prototype,"_shadowDistance",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),QR=le(BR.prototype,"_invisibleOcclusionRange",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 200}}),ZR=le(BR.prototype,"_orthoSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),JR=le(BR.prototype,"_maxReceived",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),$R=le(BR.prototype,"_size",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(512,512)}}),eI=le(BR.prototype,"_saturation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.75}}),le(BR.prototype,"enabled",[Mc,VP],Object.getOwnPropertyDescriptor(BR.prototype,"enabled"),BR.prototype),le(BR.prototype,"type",[Mc,WP],Object.getOwnPropertyDescriptor(BR.prototype,"type"),BR.prototype),le(BR.prototype,"shadowColor",[jP],Object.getOwnPropertyDescriptor(BR.prototype,"shadowColor"),BR.prototype),le(BR.prototype,"normal",[qP,XP],Object.getOwnPropertyDescriptor(BR.prototype,"normal"),BR.prototype),le(BR.prototype,"distance",[YP,KP,QP],Object.getOwnPropertyDescriptor(BR.prototype,"distance"),BR.prototype),le(BR.prototype,"saturation",[Mc,ZP,Hc,JP,$P,eR],Object.getOwnPropertyDescriptor(BR.prototype,"saturation"),BR.prototype),le(BR.prototype,"pcf",[tR,nR,iR],Object.getOwnPropertyDescriptor(BR.prototype,"pcf"),BR.prototype),le(BR.prototype,"maxReceived",[rR,oR],Object.getOwnPropertyDescriptor(BR.prototype,"maxReceived"),BR.prototype),le(BR.prototype,"bias",[aR,sR,cR],Object.getOwnPropertyDescriptor(BR.prototype,"bias"),BR.prototype),le(BR.prototype,"normalBias",[lR,uR,hR],Object.getOwnPropertyDescriptor(BR.prototype,"normalBias"),BR.prototype),le(BR.prototype,"shadowMapSize",[fR,_R,pR],Object.getOwnPropertyDescriptor(BR.prototype,"shadowMapSize"),BR.prototype),le(BR.prototype,"fixedArea",[dR,mR,vR],Object.getOwnPropertyDescriptor(BR.prototype,"fixedArea"),BR.prototype),le(BR.prototype,"near",[gR,yR,xR],Object.getOwnPropertyDescriptor(BR.prototype,"near"),BR.prototype),le(BR.prototype,"far",[SR,TR,bR],Object.getOwnPropertyDescriptor(BR.prototype,"far"),BR.prototype),le(BR.prototype,"invisibleOcclusionRange",[Mc,ER,Hc,CR,AR,wR],Object.getOwnPropertyDescriptor(BR.prototype,"invisibleOcclusionRange"),BR.prototype),le(BR.prototype,"shadowDistance",[Mc,PR,Hc,RR,IR,DR],Object.getOwnPropertyDescriptor(BR.prototype,"shadowDistance"),BR.prototype),le(BR.prototype,"orthoSize",[OR,MR,NR],Object.getOwnPropertyDescriptor(BR.prototype,"orthoSize"),BR.prototype),LR=BR))||LR)||LR);u.ShadowsInfo=UI;var kI=new In(-1024,-1024,-1024),GI=new In(1024,1024,1024),HI=(nI=mc("cc.OctreeInfo"),iI=Oc(),rI=Fc(),oI=Fc(),aI=Bc(),sI=Fc(),cI=Bc(),lI=zc(),uI=Zc(Nt),hI=Fc(),nI(fI=iI((gI=function(){function e(){ce(this,"_enabled",pI,this),ce(this,"_minPos",dI,this),ce(this,"_maxPos",mI,this),ce(this,"_depth",vI,this),this._resource=null}return e.prototype.activate=function(e){this._resource=e,this._resource.initialize(this)},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(this._enabled=e,this._resource&&(this._resource.enabled=e))}},{key:"minPos",get:function(){return this._minPos},set:function(e){this._minPos=e,this._resource&&(this._resource.minPos=e)}},{key:"maxPos",get:function(){return this._maxPos},set:function(e){this._maxPos=e,this._resource&&(this._resource.maxPos=e)}},{key:"depth",get:function(){return this._depth},set:function(e){this._depth=e,this._resource&&(this._resource.depth=e)}}]),e}(),pI=le((_I=gI).prototype,"_enabled",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dI=le(_I.prototype,"_minPos",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(kI)}}),mI=le(_I.prototype,"_maxPos",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(GI)}}),vI=le(_I.prototype,"_depth",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 8}}),le(_I.prototype,"enabled",[Mc,rI],Object.getOwnPropertyDescriptor(_I.prototype,"enabled"),_I.prototype),le(_I.prototype,"minPos",[Mc,oI,aI],Object.getOwnPropertyDescriptor(_I.prototype,"minPos"),_I.prototype),le(_I.prototype,"maxPos",[Mc,sI,cI],Object.getOwnPropertyDescriptor(_I.prototype,"maxPos"),_I.prototype),le(_I.prototype,"depth",[Mc,lI,uI,hI],Object.getOwnPropertyDescriptor(_I.prototype,"depth"),_I.prototype),fI=_I))||fI)||fI),VI=(yI=mc("cc.SceneGlobals"),xI=Zc(FI),yI((PI=function(){function e(){ce(this,"ambient",bI,this),ce(this,"shadows",EI,this),ce(this,"_skybox",CI,this),ce(this,"fog",AI,this),ce(this,"octree",wI,this)}return e.prototype.activate=function(){var e=u.director.root.pipeline.pipelineSceneData;this.skybox.activate(e.skybox),this.ambient.activate(e.ambient),this.shadows.activate(e.shadows),this.fog.activate(e.fog),this.octree.activate(e.octree)},Z(e,[{key:"skybox",get:function(){return this._skybox},set:function(e){this._skybox=e}}]),e}(),bI=le((TI=PI).prototype,"ambient",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new BI}}),EI=le(TI.prototype,"shadows",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new UI}}),CI=le(TI.prototype,"_skybox",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new FI}}),AI=le(TI.prototype,"fog",[Mc,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new zI}}),le(TI.prototype,"skybox",[Mc,xI],Object.getOwnPropertyDescriptor(TI.prototype,"skybox"),TI.prototype),wI=le(TI.prototype,"octree",[Mc,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new HI}}),SI=TI))||SI);u.SceneGlobals=VI;var WI=e("Event",function(){function e(e,t){this.type=void 0,this.bubbles=void 0,this.target=null,this.currentTarget=null,this.eventPhase=0,this.propagationStopped=!1,this.propagationImmediateStopped=!1,this.type=e,this.bubbles=!!t}var t=e.prototype;return t.unuse=function(){this.type=e.NO_TYPE,this.target=null,this.currentTarget=null,this.eventPhase=e.NONE,this.propagationStopped=!1,this.propagationImmediateStopped=!1},t.reuse=function(e,t){this.type=e,this.bubbles=t||!1},t.isStopped=function(){return this.propagationStopped||this.propagationImmediateStopped},t.getCurrentTarget=function(){return this.currentTarget},t.getType=function(){return this.type},e}());WI.NO_TYPE="no_type",WI.TOUCH="touch",WI.MOUSE="mouse",WI.KEYBOARD="keyboard",WI.ACCELERATION="acceleration",WI.NONE=0,WI.CAPTURING_PHASE=1,WI.AT_TARGET=2,WI.BUBBLING_PHASE=3,u.Event=WI;var jI=e("EventAcceleration",function(e){function t(t,n){var i;return(i=e.call(this,GA.DEVICEMOTION,n)||this).acc=void 0,i.acc=t,i}return $(t,e),t}(WI));WI.EventAcceleration=jI;var qI=e("EventKeyboard",function(e){function t(t,n,i){var r;return"boolean"==typeof n&&(n=n?GA.KEY_DOWN:GA.KEY_UP),(r=e.call(this,n,i)||this).keyCode=void 0,r.rawEvent=void 0,r._isPressed=void 0,r._isPressed=n!==GA.KEY_UP,"number"==typeof t?r.keyCode=t:(r.keyCode=t.keyCode,r.rawEvent=t),r}return $(t,e),Z(t,[{key:"isPressed",get:function(){return this._isPressed}}]),t}(WI));WI.EventKeyboard=qI;var XI=e("EventMouse",function(e){function t(n,i,r){var o;return(o=e.call(this,n,i)||this).movementX=0,o.movementY=0,o.preventSwallow=!1,o._eventType=void 0,o._button=t.BUTTON_MISSING,o._x=0,o._y=0,o._prevX=0,o._prevY=0,o._scrollX=0,o._scrollY=0,o._eventType=n,r&&(o._prevX=r.x,o._prevY=r.y),o}$(t,e);var n=t.prototype;return n.setScrollData=function(e,t){this._scrollX=e,this._scrollY=t},n.getScrollX=function(){return this._scrollX},n.getScrollY=function(){return this._scrollY},n.setLocation=function(e,t){this._x=e,this._y=t},n.getLocation=function(e){return e||(e=new Kn),Kn.set(e,this._x,this._y),e},n.getLocationInView=function(e){return e||(e=new Kn),Kn.set(e,this._x,u.view._designResolutionSize.height-this._y),e},n.getUILocation=function(e){return e||(e=new Kn),Kn.set(e,this._x,this._y),u.view._convertToUISpace(e),e},n.getPreviousLocation=function(e){return e||(e=new Kn),Kn.set(e,this._prevX,this._prevY),e},n.getUIPreviousLocation=function(e){return e||(e=new Kn),Kn.set(e,this._prevX,this._prevY),u.view._convertToUISpace(e),e},n.getDelta=function(e){return e||(e=new Kn),Kn.set(e,this._x-this._prevX,this._y-this._prevY),e},n.getDeltaX=function(){return this._x-this._prevX},n.getDeltaY=function(){return this._y-this._prevY},n.getUIDelta=function(e){return e||(e=new Kn),Kn.set(e,(this._x-this._prevX)/u.view.getScaleX(),(this._y-this._prevY)/u.view.getScaleY()),e},n.getUIDeltaX=function(){return(this._x-this._prevX)/u.view.getScaleX()},n.getUIDeltaY=function(){return(this._y-this._prevY)/u.view.getScaleY()},n.setButton=function(e){this._button=e},n.getButton=function(){return this._button},n.getLocationX=function(){return this._x},n.getLocationY=function(){return this._y},n.getUILocationX=function(){var e=u.view.getViewportRect();return(this._x-e.x)/u.view.getScaleX()},n.getUILocationY=function(){var e=u.view.getViewportRect();return(this._y-e.y)/u.view.getScaleY()},Z(t,[{key:"eventType",get:function(){return this._eventType}}]),t}(WI));XI.BUTTON_MISSING=-1,XI.BUTTON_LEFT=0,XI.BUTTON_RIGHT=2,XI.BUTTON_MIDDLE=1,XI.BUTTON_4=3,XI.BUTTON_5=4,XI.BUTTON_6=5,XI.BUTTON_7=6,XI.BUTTON_8=7,WI.EventMouse=XI;var YI=new Kn,KI=e("EventTouch",function(e){function t(t,n,i,r){var o;return void 0===r&&(r=[]),(o=e.call(this,i,n)||this).touch=null,o.simulate=!1,o.preventSwallow=!1,o._eventCode=void 0,o._touches=void 0,o._allTouches=void 0,o._eventCode=i,o._touches=t||[],o._allTouches=r,o}$(t,e);var n=t.prototype;return n.getEventCode=function(){return this._eventCode},n.getTouches=function(){return this._touches},n.getAllTouches=function(){return this._allTouches},n.setLocation=function(e,t){this.touch&&this.touch.setTouchInfo(this.touch.getID(),e,t)},n.getLocation=function(e){return this.touch?this.touch.getLocation(e):new Kn},n.getUILocation=function(e){return this.touch?this.touch.getUILocation(e):new Kn},n.getLocationInView=function(e){return this.touch?this.touch.getLocationInView(e):new Kn},n.getPreviousLocation=function(e){return this.touch?this.touch.getPreviousLocation(e):new Kn},n.getStartLocation=function(e){return this.touch?this.touch.getStartLocation(e):new Kn},n.getUIStartLocation=function(e){return this.touch?this.touch.getUIStartLocation(e):new Kn},n.getID=function(){return this.touch?this.touch.getID():null},n.getDelta=function(e){return this.touch?this.touch.getDelta(e):new Kn},n.getUIDelta=function(e){return this.touch?this.touch.getUIDelta(e):new Kn},n.getDeltaX=function(){return this.touch?this.touch.getDelta(YI).x:0},n.getDeltaY=function(){return this.touch?this.touch.getDelta(YI).y:0},n.getLocationX=function(){return this.touch?this.touch.getLocationX():0},n.getLocationY=function(){return this.touch?this.touch.getLocationY():0},t}(WI));KI.MAX_TOUCHES=5,WI.EventTouch=KI;var QI,ZI=e("Acceleration",(function(e,t,n,i){void 0===e&&(e=0),void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=0),this.x=void 0,this.y=void 0,this.z=void 0,this.timestamp=void 0,this.x=e,this.y=t,this.z=n,this.timestamp=i}));!function(e){e[e.NONE=0]="NONE",e[e.MOBILE_BACK=6]="MOBILE_BACK",e[e.BACKSPACE=8]="BACKSPACE",e[e.TAB=9]="TAB",e[e.ENTER=13]="ENTER",e[e.SHIFT_LEFT=16]="SHIFT_LEFT",e[e.CTRL_LEFT=17]="CTRL_LEFT",e[e.ALT_LEFT=18]="ALT_LEFT",e[e.PAUSE=19]="PAUSE",e[e.CAPS_LOCK=20]="CAPS_LOCK",e[e.ESCAPE=27]="ESCAPE",e[e.SPACE=32]="SPACE",e[e.PAGE_UP=33]="PAGE_UP",e[e.PAGE_DOWN=34]="PAGE_DOWN",e[e.END=35]="END",e[e.HOME=36]="HOME",e[e.ARROW_LEFT=37]="ARROW_LEFT",e[e.ARROW_UP=38]="ARROW_UP",e[e.ARROW_RIGHT=39]="ARROW_RIGHT",e[e.ARROW_DOWN=40]="ARROW_DOWN",e[e.INSERT=45]="INSERT",e[e.DELETE=46]="DELETE",e[e.DIGIT_0=48]="DIGIT_0",e[e.DIGIT_1=49]="DIGIT_1",e[e.DIGIT_2=50]="DIGIT_2",e[e.DIGIT_3=51]="DIGIT_3",e[e.DIGIT_4=52]="DIGIT_4",e[e.DIGIT_5=53]="DIGIT_5",e[e.DIGIT_6=54]="DIGIT_6",e[e.DIGIT_7=55]="DIGIT_7",e[e.DIGIT_8=56]="DIGIT_8",e[e.DIGIT_9=57]="DIGIT_9",e[e.KEY_A=65]="KEY_A",e[e.KEY_B=66]="KEY_B",e[e.KEY_C=67]="KEY_C",e[e.KEY_D=68]="KEY_D",e[e.KEY_E=69]="KEY_E",e[e.KEY_F=70]="KEY_F",e[e.KEY_G=71]="KEY_G",e[e.KEY_H=72]="KEY_H",e[e.KEY_I=73]="KEY_I",e[e.KEY_J=74]="KEY_J",e[e.KEY_K=75]="KEY_K",e[e.KEY_L=76]="KEY_L",e[e.KEY_M=77]="KEY_M",e[e.KEY_N=78]="KEY_N",e[e.KEY_O=79]="KEY_O",e[e.KEY_P=80]="KEY_P",e[e.KEY_Q=81]="KEY_Q",e[e.KEY_R=82]="KEY_R",e[e.KEY_S=83]="KEY_S",e[e.KEY_T=84]="KEY_T",e[e.KEY_U=85]="KEY_U",e[e.KEY_V=86]="KEY_V",e[e.KEY_W=87]="KEY_W",e[e.KEY_X=88]="KEY_X",e[e.KEY_Y=89]="KEY_Y",e[e.KEY_Z=90]="KEY_Z",e[e.NUM_0=96]="NUM_0",e[e.NUM_1=97]="NUM_1",e[e.NUM_2=98]="NUM_2",e[e.NUM_3=99]="NUM_3",e[e.NUM_4=100]="NUM_4",e[e.NUM_5=101]="NUM_5",e[e.NUM_6=102]="NUM_6",e[e.NUM_7=103]="NUM_7",e[e.NUM_8=104]="NUM_8",e[e.NUM_9=105]="NUM_9",e[e.NUM_MULTIPLY=106]="NUM_MULTIPLY",e[e.NUM_PLUS=107]="NUM_PLUS",e[e.NUM_SUBTRACT=109]="NUM_SUBTRACT",e[e.NUM_DECIMAL=110]="NUM_DECIMAL",e[e.NUM_DIVIDE=111]="NUM_DIVIDE",e[e.F1=112]="F1",e[e.F2=113]="F2",e[e.F3=114]="F3",e[e.F4=115]="F4",e[e.F5=116]="F5",e[e.F6=117]="F6",e[e.F7=118]="F7",e[e.F8=119]="F8",e[e.F9=120]="F9",e[e.F10=121]="F10",e[e.F11=122]="F11",e[e.F12=123]="F12",e[e.NUM_LOCK=144]="NUM_LOCK",e[e.SCROLL_LOCK=145]="SCROLL_LOCK",e[e.SEMICOLON=186]="SEMICOLON",e[e.EQUAL=187]="EQUAL",e[e.COMMA=188]="COMMA",e[e.DASH=189]="DASH",e[e.PERIOD=190]="PERIOD",e[e.SLASH=191]="SLASH",e[e.BACK_QUOTE=192]="BACK_QUOTE",e[e.BRACKET_LEFT=219]="BRACKET_LEFT",e[e.BACKSLASH=220]="BACKSLASH",e[e.BRACKET_RIGHT=221]="BRACKET_RIGHT",e[e.QUOTE=222]="QUOTE",e[e.SHIFT_RIGHT=2e3]="SHIFT_RIGHT",e[e.CTRL_RIGHT=2001]="CTRL_RIGHT",e[e.ALT_RIGHT=2002]="ALT_RIGHT",e[e.NUM_ENTER=2003]="NUM_ENTER"}(QI||(QI=e("KeyCode",{})));var JI=new Kn,$I=e("Touch",function(){function e(e,t,n){void 0===n&&(n=0),this._point=new Kn,this._prevPoint=new Kn,this._lastModified=0,this._id=0,this._startPoint=new Kn,this._startPointCaptured=!1,this.setTouchInfo(n,e,t)}var t=e.prototype;return t.getLocation=function(e){return e||(e=new Kn),e.set(this._point.x,this._point.y),e},t.getLocationX=function(){return this._point.x},t.getLocationY=function(){return this._point.y},t.getUILocation=function(e){return e||(e=new Kn),e.set(this._point.x,this._point.y),u.view._convertToUISpace(e),e},t.getUILocationX=function(){var e=u.view.getViewportRect();return(this._point.x-e.x)/u.view.getScaleX()},t.getUILocationY=function(){var e=u.view.getViewportRect();return(this._point.y-e.y)/u.view.getScaleY()},t.getPreviousLocation=function(e){return e||(e=new Kn),e.set(this._prevPoint.x,this._prevPoint.y),e},t.getUIPreviousLocation=function(e){return e||(e=new Kn),e.set(this._prevPoint.x,this._prevPoint.y),u.view._convertToUISpace(e),e},t.getStartLocation=function(e){return e||(e=new Kn),e.set(this._startPoint.x,this._startPoint.y),e},t.getUIStartLocation=function(e){return e||(e=new Kn),e.set(this._startPoint.x,this._startPoint.y),u.view._convertToUISpace(e),e},t.getDelta=function(e){return e||(e=new Kn),e.set(this._point),e.subtract(this._prevPoint),e},t.getUIDelta=function(e){return e||(e=new Kn),JI.set(this._point),JI.subtract(this._prevPoint),e.set(u.view.getScaleX(),u.view.getScaleY()),Kn.divide(e,JI,e),e},t.getLocationInView=function(e){return e||(e=new Kn),e.set(this._point.x,u.view._designResolutionSize.height-this._point.y),e},t.getPreviousLocationInView=function(e){return e||(e=new Kn),e.set(this._prevPoint.x,u.view._designResolutionSize.height-this._prevPoint.y),e},t.getStartLocationInView=function(e){return e||(e=new Kn),e.set(this._startPoint.x,u.view._designResolutionSize.height-this._startPoint.y),e},t.getID=function(){return this._id},t.setTouchInfo=function(e,t,n){void 0===e&&(e=0),this._prevPoint=this._point,this._point=new Kn(t||0,n||0),this._id=e,this._startPointCaptured||(this._startPoint=new Kn(this._point),this._startPointCaptured=!0)},t.setPoint=function(e,t){"object"==typeof e?(this._point.x=e.x,this._point.y=e.y):(this._point.x=e||0,this._point.y=t||0),this._lastModified=u.game.frameStartTime},t.setPrevPoint=function(e,t){this._prevPoint="object"==typeof e?new Kn(e.x,e.y):new Kn(e||0,t||0),this._lastModified=u.game.frameStartTime},Z(e,[{key:"lastModified",get:function(){return this._lastModified}}]),e}());u.Touch=$I;var eD,tD,nD=function(){function e(){this._intervalInMileSeconds=200,this._accelTimer=0,this._eventTarget=new iu,this._deviceEventName=void 0,this._globalEventClass=void 0,this._didAccelerateFunc=void 0,this._globalEventClass=window.DeviceMotionEvent||window.DeviceOrientationEvent,vu.browserType===ou.MOBILE_QQ&&(this._globalEventClass=window.DeviceOrientationEvent),this._deviceEventName=this._globalEventClass===window.DeviceMotionEvent?"devicemotion":"deviceorientation",this._didAccelerateFunc=this._didAccelerate.bind(this)}var t=e.prototype;return t._registerEvent=function(){this._accelTimer=performance.now(),window.addEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._unregisterEvent=function(){this._accelTimer=0,window.removeEventListener(this._deviceEventName,this._didAccelerateFunc,!1)},t._didAccelerate=function(e){var t=performance.now();if(!(t-this._accelTimer<this._intervalInMileSeconds)){this._accelTimer=t;var n=0,i=0,r=0;if(this._globalEventClass===window.DeviceMotionEvent){var o=e.accelerationIncludingGravity;n=.1*((null==o?void 0:o.x)||0),i=.1*((null==o?void 0:o.y)||0),r=.1*((null==o?void 0:o.z)||0)}else{var a=e;n=(a.gamma||0)/90*.981,i=-(a.beta||0)/90*.981,r=(a.alpha||0)/90*.981}if(ch.isFrameRotated){var s=n;n=-i,i=s}var c=n;90===window.orientation?(n=-i,i=c):-90===window.orientation?(n=i,i=-c):180===window.orientation&&(n=-n,i=-i),vu.os===cu.ANDROID&&vu.browserType!==ou.MOBILE_QQ&&(n=-n,i=-i);var l=performance.now(),u=new ZI(n,i,r,l),h=new jI(u);this._eventTarget.emit(HA.DEVICEMOTION,h)}},t.start=function(){var e=this;window.DeviceMotionEvent&&"function"==typeof DeviceMotionEvent.requestPermission?DeviceMotionEvent.requestPermission().then((function(t){"granted"===t&&e._registerEvent()})).catch((function(){})):this._registerEvent()},t.stop=function(){this._unregisterEvent()},t.setInterval=function(e){this._intervalInMileSeconds=e},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),iD={Backspace:QI.BACKSPACE,Tab:QI.TAB,Enter:QI.ENTER,ShiftLeft:QI.SHIFT_LEFT,ControlLeft:QI.CTRL_LEFT,AltLeft:QI.ALT_LEFT,ShiftRight:QI.SHIFT_RIGHT,ControlRight:QI.CTRL_RIGHT,AltRight:QI.ALT_RIGHT,Pause:QI.PAUSE,CapsLock:QI.CAPS_LOCK,Escape:QI.ESCAPE,Space:QI.SPACE,PageUp:QI.PAGE_UP,PageDown:QI.PAGE_DOWN,End:QI.END,Home:QI.HOME,ArrowLeft:QI.ARROW_LEFT,ArrowUp:QI.ARROW_UP,ArrowRight:QI.ARROW_RIGHT,ArrowDown:QI.ARROW_DOWN,Insert:QI.INSERT,Delete:QI.DELETE,Digit0:QI.DIGIT_0,Digit1:QI.DIGIT_1,Digit2:QI.DIGIT_2,Digit3:QI.DIGIT_3,Digit4:QI.DIGIT_4,Digit5:QI.DIGIT_5,Digit6:QI.DIGIT_6,Digit7:QI.DIGIT_7,Digit8:QI.DIGIT_8,Digit9:QI.DIGIT_9,KeyA:QI.KEY_A,KeyB:QI.KEY_B,KeyC:QI.KEY_C,KeyD:QI.KEY_D,KeyE:QI.KEY_E,KeyF:QI.KEY_F,KeyG:QI.KEY_G,KeyH:QI.KEY_H,KeyI:QI.KEY_I,KeyJ:QI.KEY_J,KeyK:QI.KEY_K,KeyL:QI.KEY_L,KeyM:QI.KEY_M,KeyN:QI.KEY_N,KeyO:QI.KEY_O,KeyP:QI.KEY_P,KeyQ:QI.KEY_Q,KeyR:QI.KEY_R,KeyS:QI.KEY_S,KeyT:QI.KEY_T,KeyU:QI.KEY_U,KeyV:QI.KEY_V,KeyW:QI.KEY_W,KeyX:QI.KEY_X,KeyY:QI.KEY_Y,KeyZ:QI.KEY_Z,Numpad0:QI.NUM_0,Numpad1:QI.NUM_1,Numpad2:QI.NUM_2,Numpad3:QI.NUM_3,Numpad4:QI.NUM_4,Numpad5:QI.NUM_5,Numpad6:QI.NUM_6,Numpad7:QI.NUM_7,Numpad8:QI.NUM_8,Numpad9:QI.NUM_9,NumpadMultiply:QI.NUM_MULTIPLY,NumpadAdd:QI.NUM_PLUS,NumpadSubtract:QI.NUM_SUBTRACT,NumpadDecimal:QI.NUM_DECIMAL,NumpadDivide:QI.NUM_DIVIDE,NumpadEnter:QI.NUM_ENTER,F1:QI.F1,F2:QI.F2,F3:QI.F3,F4:QI.F4,F5:QI.F5,F6:QI.F6,F7:QI.F7,F8:QI.F8,F9:QI.F9,F10:QI.F10,F11:QI.F11,F12:QI.F12,NumLock:QI.NUM_LOCK,ScrollLock:QI.SCROLL_LOCK,Semicolon:QI.SEMICOLON,Equal:QI.EQUAL,Comma:QI.COMMA,Minus:QI.DASH,Period:QI.PERIOD,Slash:QI.SLASH,Backquote:QI.BACK_QUOTE,BracketLeft:QI.BRACKET_LEFT,Backslash:QI.BACKSLASH,BracketRight:QI.BRACKET_RIGHT,Quote:QI.QUOTE},rD=function(){function e(){this._eventTarget=new iu,this._registerEvent()}var t=e.prototype;return t._registerEvent=function(){var e=this,t=document.getElementById("GameCanvas");null==t||t.addEventListener("keydown",(function(t){if(t.stopPropagation(),t.preventDefault(),t.repeat){var n=e._getInputEvent(t,HA.KEY_PRESSING);e._eventTarget.emit(HA.KEY_PRESSING,n)}else{var i=e._getInputEvent(t,HA.KEY_DOWN);e._eventTarget.emit(HA.KEY_DOWN,i)}})),null==t||t.addEventListener("keyup",(function(t){var n=e._getInputEvent(t,HA.KEY_UP);t.stopPropagation(),t.preventDefault(),e._eventTarget.emit(HA.KEY_UP,n)}))},t._getInputEvent=function(e,t){var n,i=(n=e.code,iD[n]||QI.NONE);return new qI(i,t)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),oD=function(){function e(){this._canvas=void 0,this._eventTarget=new iu,this._pointLocked=!1,this._isPressed=!1,this._preMousePos=new Kn,vu.hasFeature(uu.EVENT_MOUSE)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new ri(t.x,t.y,t.width,t.height):new ri(0,0,0,0)},t._getLocation=function(e){var t=this._getCanvasRect(),n=ch.devicePixelRatio,i=this._pointLocked?this._preMousePos.x/n+e.movementX:e.clientX-t.x,r=this._pointLocked?this._preMousePos.y/n-e.movementY:t.y+t.height-e.clientY;return new Kn(i*=n,r*=n)},t._registerEvent=function(){var e,t,n,i,r=this;window.addEventListener("mousedown",(function(){r._isPressed=!0})),null===(e=this._canvas)||void 0===e||e.addEventListener("mousedown",this._createCallback(HA.MOUSE_DOWN)),null===(t=this._canvas)||void 0===t||t.addEventListener("mousemove",this._createCallback(HA.MOUSE_MOVE));var o=this._createCallback(HA.MOUSE_UP);window.addEventListener("mouseup",o),null===(n=this._canvas)||void 0===n||n.addEventListener("mouseup",o),null===(i=this._canvas)||void 0===i||i.addEventListener("wheel",this._handleMouseWheel.bind(this)),this._registerPointerLockEvent()},t._registerPointerLockEvent=function(){var e=this,t=function(){var t=e._canvas;document.pointerLockElement===t||document.mozPointerLockElement===t?e._pointLocked=!0:e._pointLocked=!1};"onpointerlockchange"in document?document.addEventListener("pointerlockchange",t,!1):"onmozpointerlockchange"in document&&document.addEventListener("mozpointerlockchange",t,!1)},t._createCallback=function(e){var t=this;return function(n){var i,r=t._getLocation(n),o=n.button;switch(e){case HA.MOUSE_DOWN:null===(i=t._canvas)||void 0===i||i.focus(),t._isPressed=!0;break;case HA.MOUSE_UP:t._isPressed=!1;break;case HA.MOUSE_MOVE:t._isPressed||(o=XI.BUTTON_MISSING)}var a=new XI(e,!1,t._preMousePos);a.setLocation(r.x,r.y),a.setButton(o),a.movementX=n.movementX,a.movementY=n.movementY,t._preMousePos.set(r.x,r.y),n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),t._eventTarget.emit(e,a)}},t._handleMouseWheel=function(e){var t=HA.MOUSE_WHEEL,n=this._getLocation(e),i=e.button,r=new XI(t,!1,this._preMousePos);r.setLocation(n.x,n.y),r.setButton(i),r.movementX=e.movementX,r.movementY=e.movementY,r.setScrollData(5*e.deltaX,5*-e.deltaY),this._preMousePos.set(n.x,n.y),e.stopPropagation(),e.target===this._canvas&&e.preventDefault(),this._eventTarget.emit(t,r)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}(),aD=new Kn,sD=new(function(){function e(){this._touchMap=void 0,this._maxTouches=8,this._touchMap=new Map}var t=e.prototype;return t._cloneTouch=function(e){var t=e.getID();e.getStartLocation(aD);var n=new $I(aD.x,aD.y,t);return e.getLocation(aD),n.setPoint(aD.x,aD.y),e.getPreviousLocation(aD),n.setPrevPoint(aD),n},t._createTouch=function(e,t,n){if(this._touchMap.has(e))console.log("Cannot create the same touch object.");else{if(!this._checkTouchMapSizeMoreThanMax(e)){var i=new $I(t,n,e);return this._touchMap.set(e,i),this._updateTouch(i,t,n),this._cloneTouch(i)}console.log("The touches is more than MAX_TOUCHES.")}},t.releaseTouch=function(e){this._touchMap.has(e)&&this._touchMap.delete(e)},t.getTouch=function(e,t,n){var i=this._touchMap.get(e);return i?this._updateTouch(i,t,n):i=this._createTouch(e,t,n),i?this._cloneTouch(i):void 0},t.getAllTouches=function(){var e=this,t=[];return this._touchMap.forEach((function(n){if(n){var i=e._cloneTouch(n);t.push(i)}})),t},t._updateTouch=function(e,t,n){e.getLocation(aD),e.setPrevPoint(aD),e.setPoint(t,n)},t._checkTouchMapSizeMoreThanMax=function(e){var t=this;if(this._touchMap.has(e))return!1;var n=ft.ENABLE_MULTI_TOUCH?this._maxTouches:1;if(this._touchMap.size<n)return!1;var i=performance.now();return this._touchMap.forEach((function(e){i-e.lastModified>ft.TOUCH_TIMEOUT&&(console.log("The touches is more than MAX_TOUCHES, release touch id "+e.getID()+"."),t.releaseTouch(e.getID()))})),n>=this._touchMap.size},e}()),cD=function(){function e(){this._canvas=void 0,this._eventTarget=new iu,vu.hasFeature(uu.INPUT_TOUCH)&&(this._canvas=document.getElementById("GameCanvas"),this._canvas||console.warn("failed to access canvas"),this._registerEvent())}var t=e.prototype;return t._registerEvent=function(){var e,t,n,i;null===(e=this._canvas)||void 0===e||e.addEventListener("touchstart",this._createCallback(HA.TOUCH_START)),null===(t=this._canvas)||void 0===t||t.addEventListener("touchmove",this._createCallback(HA.TOUCH_MOVE)),null===(n=this._canvas)||void 0===n||n.addEventListener("touchend",this._createCallback(HA.TOUCH_END)),null===(i=this._canvas)||void 0===i||i.addEventListener("touchcancel",this._createCallback(HA.TOUCH_CANCEL))},t._createCallback=function(e){var t=this;return function(n){for(var i,r=t._getCanvasRect(),o=[],a=n.changedTouches.length,s=0;s<a;++s){var c=n.changedTouches[s],l=c.identifier;if(null!==l){var u=t._getLocation(c,r),h=sD.getTouch(l,u.x,u.y);h&&(e!==HA.TOUCH_END&&e!==HA.TOUCH_CANCEL||sD.releaseTouch(l),o.push(h))}}if(n.stopPropagation(),n.target===t._canvas&&n.preventDefault(),e===HA.TOUCH_START&&(null===(i=t._canvas)||void 0===i||i.focus()),o.length>0){var f=new KI(o,!1,e,ft.ENABLE_MULTI_TOUCH?sD.getAllTouches():o);t._eventTarget.emit(e,f)}}},t._getCanvasRect=function(){var e=this._canvas,t=null==e?void 0:e.getBoundingClientRect();return t?new ri(t.x,t.y,t.width,t.height):new ri(0,0,0,0)},t._getLocation=function(e,t){var n=e.clientX-t.x,i=t.y+t.height-e.clientY;if(ch.isFrameRotated){var r=n;n=t.height-i,i=r}var o=ch.devicePixelRatio;return new Kn(n*=o,i*=o)},t.on=function(e,t,n){this._eventTarget.on(e,t,n)},e}();!function(e){e[e.GLOBAL=0]="GLOBAL",e[e.UI=1]="UI"}(tD||(tD={}));var lD=function(){function e(e){this.priority=tD.GLOBAL,this._inputEventTarget=void 0,this._inputEventTarget=e}return e.prototype.dispatchEvent=function(e){return this._inputEventTarget.emit(e.type,e),!0},e}(),uD=((eD={})[HA.MOUSE_DOWN]=HA.TOUCH_START,eD[HA.MOUSE_MOVE]=HA.TOUCH_MOVE,eD[HA.MOUSE_UP]=HA.TOUCH_END,eD),hD=e("Input",function(){function e(){this._dispatchImmediately=!0,this._eventTarget=new iu,this._touchInput=new cD,this._mouseInput=new oD,this._keyboardInput=new rD,this._accelerometerInput=new nD,this._eventTouchList=[],this._eventMouseList=[],this._eventKeyboardList=[],this._eventAccelerationList=[],this._needSimulateTouchMoveEvent=!1,this._inputEventDispatcher=void 0,this._eventDispatcherList=[],this._registerEvent(),this._inputEventDispatcher=new lD(this._eventTarget),this._registerEventDispatcher(this._inputEventDispatcher)}var t=e.prototype;return t.on=function(e,t,n){return this._eventTarget.on(e,t,n),t},t.once=function(e,t,n){return this._eventTarget.once(e,t,n),t},t.off=function(e,t,n){this._eventTarget.off(e,t,n)},t.setAccelerometerEnabled=function(e){e?this._accelerometerInput.start():this._accelerometerInput.stop()},t.setAccelerometerInterval=function(e){this._accelerometerInput.setInterval(e)},t._simulateEventTouch=function(e){var t=uD[e.type],n=sD.getTouch(0,e.getLocationX(),e.getLocationY());if(n){var i=[n],r=new KI(i,!1,t,i);t===HA.TOUCH_END&&sD.releaseTouch(0),this._dispatchOrPushEventTouch(r,this._eventTouchList)}},t._registerEventDispatcher=function(e){this._eventDispatcherList.push(e),this._eventDispatcherList.sort((function(e,t){return t.priority-e.priority}))},t._emitEvent=function(e){for(var t=this._eventDispatcherList.length,n=0;n<t&&this._eventDispatcherList[n].dispatchEvent(e);++n);},t._registerEvent=function(){var e=this;if(hh.hasFeature(hh.Feature.INPUT_TOUCH)){var t=this._eventTouchList;this._touchInput.on(HA.TOUCH_START,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(HA.TOUCH_MOVE,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(HA.TOUCH_END,(function(n){e._dispatchOrPushEventTouch(n,t)})),this._touchInput.on(HA.TOUCH_CANCEL,(function(n){e._dispatchOrPushEventTouch(n,t)}))}if(hh.hasFeature(hh.Feature.EVENT_MOUSE)){var n=this._eventMouseList;this._mouseInput.on(HA.MOUSE_DOWN,(function(t){e._needSimulateTouchMoveEvent=!0,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(HA.MOUSE_MOVE,(function(t){e._needSimulateTouchMoveEvent&&e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(HA.MOUSE_UP,(function(t){e._needSimulateTouchMoveEvent=!1,e._simulateEventTouch(t),e._dispatchOrPushEvent(t,n)})),this._mouseInput.on(HA.MOUSE_WHEEL,(function(t){e._dispatchOrPushEvent(t,n)}))}if(hh.hasFeature(hh.Feature.EVENT_KEYBOARD)){var i=this._eventKeyboardList;this._keyboardInput.on(HA.KEY_DOWN,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(HA.KEY_PRESSING,(function(t){e._dispatchOrPushEvent(t,i)})),this._keyboardInput.on(HA.KEY_UP,(function(t){e._dispatchOrPushEvent(t,i)}))}if(hh.hasFeature(hh.Feature.EVENT_ACCELEROMETER)){var r=this._eventAccelerationList;this._accelerometerInput.on(HA.DEVICEMOTION,(function(t){e._dispatchOrPushEvent(t,r)}))}},t._clearEvents=function(){this._eventMouseList.length=0,this._eventTouchList.length=0,this._eventKeyboardList.length=0,this._eventAccelerationList.length=0},t._dispatchOrPushEvent=function(e,t){this._dispatchImmediately?this._emitEvent(e):t.push(e)},t._dispatchOrPushEventTouch=function(e,t){if(this._dispatchImmediately)for(var n=e.getTouches(),i=n.length,r=0;r<i;++r)e.touch=n[r],e.propagationStopped=e.propagationImmediateStopped=!1,this._emitEvent(e);else t.push(e)},t._frameDispatchEvents=function(){for(var e=this._eventMouseList,t=0,n=e.length;t<n;++t){var i=e[t];this._emitEvent(i)}for(var r=this._eventTouchList,o=0,a=r.length;o<a;++o)for(var s=r[o],c=s.getTouches(),l=c.length,u=0;u<l;++u)s.touch=c[u],s.propagationStopped=s.propagationImmediateStopped=!1,this._emitEvent(s);for(var h=this._eventKeyboardList,f=0,_=h.length;f<_;++f){var p=h[f];this._emitEvent(p)}for(var d=this._eventAccelerationList,m=0,v=d.length;m<v;++m){var g=d[m];this._emitEvent(g)}this._clearEvents()},e}());hD.EventType=HA;var fD=e("input",new hD),_D=e("SystemEvent",function(e){function t(){var t;return t=e.call(this)||this,fD.on(HA.MOUSE_DOWN,(function(e){t.emit(GA.MOUSE_DOWN,e)})),fD.on(HA.MOUSE_MOVE,(function(e){t.emit(GA.MOUSE_MOVE,e)})),fD.on(HA.MOUSE_UP,(function(e){t.emit(GA.MOUSE_UP,e)})),fD.on(HA.MOUSE_WHEEL,(function(e){t.emit(GA.MOUSE_WHEEL,e)})),fD.on(HA.TOUCH_START,(function(e){t.emit(GA.TOUCH_START,e.touch,e)})),fD.on(HA.TOUCH_MOVE,(function(e){t.emit(GA.TOUCH_MOVE,e.touch,e)})),fD.on(HA.TOUCH_END,(function(e){t.emit(GA.TOUCH_END,e.touch,e)})),fD.on(HA.TOUCH_CANCEL,(function(e){t.emit(GA.TOUCH_CANCEL,e.touch,e)})),fD.on(HA.KEY_DOWN,(function(e){t.emit(GA.KEY_DOWN,e)})),fD.on(HA.KEY_PRESSING,(function(e){t.emit(GA.KEY_DOWN,e)})),fD.on(HA.KEY_UP,(function(e){t.emit(GA.KEY_UP,e)})),fD.on(HA.DEVICEMOTION,(function(e){t.emit(GA.DEVICEMOTION,e)})),t}$(t,e);var n=t.prototype;return n.setAccelerometerEnabled=function(e){fD.setAccelerometerEnabled(e)},n.setAccelerometerInterval=function(e){fD.setAccelerometerInterval(e)},n.on=function(t,n,i,r){return e.prototype.on.call(this,t,n,i,r),n},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i)},t}(iu));_D.EventType=GA,u.SystemEvent=_D;var pD,dD=e("systemEvent",new _D);u.systemEvent=dD,k(GA,"Node.EventType",[{name:"POSITION_PART",newName:"TRANSFORM_CHANGED"},{name:"ROTATION_PART",newName:"TRANSFORM_CHANGED"},{name:"SCALE_PART",newName:"TRANSFORM_CHANGED"}]),k(WI,"Event",[{name:"ACCELERATION",newName:"DEVICEMOTION",target:_D.EventType,targetName:"SystemEvent.EventType"}]),H(WI,"Event",[{name:"TOUCH",suggest:"please use SystemEvent.EventType.TOUCH_START, SystemEvent.EventType.TOUCH_MOVE, SystemEvent.EventType.TOUCH_END and SystemEvent.EventType.TOUCH_CANCEL instead"},{name:"MOUSE",suggest:"please use SystemEvent.EventType.MOUSE_DOWN, SystemEvent.EventType.MOUSE_MOVE, SystemEvent.EventType.MOUSE_UP, SystemEvent.EventType.MOUSE_WHEEL, Node.EventType.MOUSE_ENTER and Node.EventType.MOUSE_LEAVE instead"},{name:"KEYBOARD",suggest:"please use SystemEvent.EventType.KEY_DOWN and SystemEvent.EventType.KEY_UP instead"}]),k(XI,"EventMouse",["DOWN","UP","MOVE"].map((function(e){return{name:e,newName:"MOUSE_"+e,target:_D.EventType,targetName:"SystemEvent.EventType"}}))),k(XI,"EventMouse",[{name:"SCROLL",newName:"MOUSE_WHEEL",target:_D.EventType,targetName:"SystemEvent.EventType"}]),H(XI.prototype,"EventMouse.prototype",[{name:"eventType",suggest:"please use EventMouse.prototype.type instead"}]),k(KI,"EventTouch",[{name:"BEGAN",newName:"TOUCH_START",target:_D.EventType,targetName:"SystemEvent.EventType"}]),k(KI,"EventTouch",[{name:"MOVED",newName:"TOUCH_MOVE",target:_D.EventType,targetName:"SystemEvent.EventType"}]),k(KI,"EventTouch",[{name:"ENDED",newName:"TOUCH_END",target:_D.EventType,targetName:"SystemEvent.EventType"}]),k(KI,"EventTouch",[{name:"CANCELLED",newName:"TOUCH_CANCEL",target:_D.EventType,targetName:"SystemEvent.EventType"}]),H(KI.prototype,"EventTouch.prototype",[{name:"getEventCode",suggest:"please use EventTouch.prototype.type instead"}]),k(KI.prototype,"EventTouch.prototype",[{name:"getUILocationInView",newName:"getLocationInView",target:KI,targetName:"EventTouch"}]),H(ft.KEY,"macro.KEY",["back","menu","0","1","2","3","4","5","6","7","8","9","0","*","+","-","/",";","=",",",".","[","]","dpadLeft","dpadRight","dpadUp","dpadDown","dpadCenter"].map((function(e){return{name:e}}))),H(ft.KEY,"macro.KEY",[{name:"shift",suggest:"please use KeyCode.SHIFT_LEFT instead"}]),H(ft.KEY,"macro.KEY",[{name:"ctrl",suggest:"please use KeyCode.CTRL_LEFT instead"}]),H(ft.KEY,"macro.KEY",[{name:"alt",suggest:"please use KeyCode.ALT_LEFT instead"}]),H(ft,"macro",[{name:"KEY",suggest:"please use KeyCode instead"}]),k(vE.prototype,"BaseNode",[{name:"childrenCount",newName:"children.length",customGetter:function(){return this.children.length}}]),k(qC.prototype,"Node",[{name:"width",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.width},customSetter:function(e){this._uiProps.uiTransformComp.width=e}},{name:"height",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.height},customSetter:function(e){this._uiProps.uiTransformComp.height=e}},{name:"anchorX",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorX},customSetter:function(e){this._uiProps.uiTransformComp.anchorX=e}},{name:"anchorY",targetName:"node.getComponent(UITransform)",customGetter:function(){return this._uiProps.uiTransformComp.anchorY},customSetter:function(e){this._uiProps.uiTransformComp.anchorY=e}},{name:"getAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new Kn),e.set(this._uiProps.uiTransformComp.anchorPoint),e}},{name:"setAnchorPoint",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){this._uiProps.uiTransformComp.setAnchorPoint(e,t)}},{name:"getContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e){return e||(e=new ni),e.set(this._uiProps.uiTransformComp.contentSize),e}},{name:"setContentSize",targetName:"node.getComponent(UITransform)",customFunction:function(e,t){"number"==typeof e?this._uiProps.uiTransformComp.setContentSize(e,t):this._uiProps.uiTransformComp.setContentSize(e)}}]),G(VI.prototype,"SceneGlobals.prototype",[{name:"aspect"},{name:"selfShadow"},{name:"linear"},{name:"packing"},{name:"autoAdapt"}]),G(qC.prototype,"Node.prototype",[{name:"addLayer"},{name:"removeLayer"}]),k(eE.prototype,"NodeUIProperties",[{name:"opacityDirty",newName:"colorDirty"}]),G(Fp,"Layers",[{name:"All"},{name:"RaycastMask"},{name:"check"}]),k(Fp,"Layers",[{name:"Default",newName:"DEFAULT",target:Fp.Enum,targetName:"Layers.Enum"},{name:"Always",newName:"ALWAYS",target:Fp.Enum,targetName:"Layers.Enum"},{name:"IgnoreRaycast",newName:"IGNORE_RAYCAST",target:Fp.Enum,targetName:"Layers.Enum"},{name:"Gizmos",newName:"GIZMOS",target:Fp.Enum,targetName:"Layers.Enum"},{name:"Editor",newName:"EDITOR",target:Fp.Enum,targetName:"Layers.Enum"},{name:"UI",newName:"UI_3D",target:Fp.Enum,targetName:"Layers.Enum"},{name:"UI2D",newName:"UI_2D",target:Fp.Enum,targetName:"Layers.Enum"},{name:"SceneGizmo",newName:"SCENE_GIZMO",target:Fp.Enum,targetName:"Layers.Enum"},{name:"makeInclusiveMask",newName:"makeMaskInclude",target:Fp,targetName:"Layers"},{name:"makeExclusiveMask",newName:"makeMaskExclude",target:Fp,targetName:"Layers"}]),G(Fp.Enum,"Layers.Enum",[{name:"ALWAYS"}]),G(Fp.BitMask,"Layers.BitMask",[{name:"ALWAYS"}]);var mD,vD,gD,yD,xD=ml.Flags.HideInHierarchy,SD=ml.Flags.DontSave,TD=e("PrivateNode",mc("cc.PrivateNode")(pD=function(e){function t(t){var n;return D(12003,(n=e.call(this,t)||this).name),n.hideFlags|=SD|xD,n}return $(t,e),t}(qC))||pD);k(GA,"SystemEventType",["MOUSE_ENTER","MOUSE_LEAVE","TRANSFORM_CHANGED","SCENE_CHANGED_FOR_PERSISTS","SIZE_CHANGED","ANCHOR_CHANGED","COLOR_CHANGED","CHILD_ADDED","CHILD_REMOVED","PARENT_CHANGED","NODE_DESTROYED","LAYER_CHANGED","SIBLING_ORDER_CHANGED"].map((function(e){return{name:e,target:qC.EventType,targetName:"Node.EventType"}}))),k(qC.EventType,"Node.EventType",[{name:"DEVICEMOTION",target:_D.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_DOWN",target:_D.EventType,targetName:"SystemEvent.EventType"},{name:"KEY_UP",target:_D.EventType,targetName:"SystemEvent.EventType"}]),u.PrivateNode=TD;var bD=e("Scene",mc("cc.Scene")((le((vD=function(e){$(n,e);var t=n.prototype;function n(t){var n;return ce(n=e.call(this,t)||this,"autoReleaseAssets",gD,oe(n)),ce(n,"_globals",yD,oe(n)),n.dependAssets=null,n._renderScene=null,n._inited=void 0,n._prefabSyncedInLiveReload=!1,n._pos=In.ZERO,n._rot=Fn.IDENTITY,n._scale=In.ONE,n._mat=jn.IDENTITY,n._dirtyFlags=0,n._lpos=In.ZERO,n._lrot=Fn.IDENTITY,n._lscale=In.ONE,n._activeInHierarchy=!1,u.director&&u.director.root&&(n._renderScene=u.director.root.createScene({})),n._inited=!u.game||!u.game._isCloning,n._init(),n}return t._updateScene=function(){this._scene=this},t._init=function(){},t.destroy=function(){var e=ml.prototype.destroy.call(this);if(e)for(var t=this._children,n=0;n<t.length;++n)t[n].active=!1;return this._renderScene&&u.director.root.destroyScene(this._renderScene),this._active=!1,this._activeInHierarchy=!1,e},t.addComponent=function(){throw new Error(F(3822))},t._onHierarchyChanged=function(){},t._onBatchCreated=function(t){e.prototype._onBatchCreated.call(this,t);for(var n=this._children.length,i=0;i<n;++i)this.children[i]._siblingIndex=i,this._children[i]._onBatchCreated(t)},t.getPosition=function(e){return In.copy(e||new In,In.ZERO)},t.getRotation=function(e){return Fn.copy(e||new Fn,Fn.IDENTITY)},t.getScale=function(e){return In.copy(e||new In,In.ONE)},t.getWorldPosition=function(e){return In.copy(e||new In,In.ZERO)},t.getWorldRotation=function(e){return Fn.copy(e||new Fn,Fn.IDENTITY)},t.getWorldScale=function(e){return In.copy(e||new In,In.ONE)},t.getWorldMatrix=function(e){return jn.copy(e||new jn,jn.IDENTITY)},t.getWorldRS=function(e){return jn.copy(e||new jn,jn.IDENTITY)},t.getWorldRT=function(e){return jn.copy(e||new jn,jn.IDENTITY)},t.updateWorldTransform=function(){},t._instantiate=function(){},t._load=function(){this._inited||(uA(this),cA(this),this._onBatchCreated(false),this._inited=!0),this.walk(vE._setScene)},t._activate=function(e){e=!1!==e,u.director._nodeActivator.activateNode(this,e),this._globals.activate(),this._renderScene&&this._renderScene.activate()},Z(n,[{key:"renderScene",get:function(){return this._renderScene}},{key:"globals",get:function(){return this._globals}},{key:"native",get:function(){return this._nativeObj}},{key:"position",get:function(){return In.ZERO}},{key:"worldPosition",get:function(){return In.ZERO}},{key:"rotation",get:function(){return Fn.IDENTITY}},{key:"worldRotation",get:function(){return Fn.IDENTITY}},{key:"scale",get:function(){return In.ONE}},{key:"worldScale",get:function(){return In.ONE}},{key:"eulerAngles",get:function(){return In.ZERO}},{key:"worldMatrix",get:function(){return jn.IDENTITY}}]),n}(vE)).prototype,"globals",[Mc],Object.getOwnPropertyDescriptor(vD.prototype,"globals"),vD.prototype),gD=le(vD.prototype,"autoReleaseAssets",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),yD=le(vD.prototype,"_globals",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new VI}}),mD=vD))||mD);function ED(e,t){if(!t){var n=u.director.getScene();if(!n)return null;t=n}return t.getChildByPath(e)}u.Scene=bD,u.find=ED;var CD=it.fastRemoveAt,AD=ml.Flags.IsStartCalled,wD=ml.Flags.IsOnEnableCalled;function PD(e,t){for(var n=t.constructor._executionOrder,i=t._id,r=0,o=e.length-1,a=o>>>1;r<=o;a=r+o>>>1){var s=e[a],c=s.constructor._executionOrder;if(c>n)o=a-1;else if(c<n)r=a+1;else{var l=s._id;if(l>i)o=a-1;else{if(!(l<i))return a;r=a+1}}}return~r}function RD(e,t){for(var n=e.array,i=e.i+1;i<n.length;){var r=n[i];r.node._activeInHierarchy?++i:(e.removeAt(i),t&&(r._objFlags&=~t))}}ml.Flags.IsEditorOnEnableCalled;var ID=function(e){this._zero=void 0,this._neg=void 0,this._pos=void 0,this._invoke=void 0;var t=ue;this._zero=new t([]),this._neg=new t([]),this._pos=new t([]),this._invoke=e};function DD(e,t){return e.constructor._executionOrder-t.constructor._executionOrder}ID.stableRemoveInactive=RD;var OD=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).array.push(e)},n.remove=function(e){var t=e.constructor._executionOrder;(0===t?this._zero:t<0?this._neg:this._pos).fastRemove(e)},n.cancelInactive=function(e){RD(this._zero,e),RD(this._neg,e),RD(this._pos,e)},n.invoke=function(){var e=this._neg;e.array.length>0&&(e.array.sort(DD),this._invoke(e),e.array.length=0),this._invoke(this._zero),this._zero.array.length=0;var t=this._pos;t.array.length>0&&(t.array.sort(DD),this._invoke(t),t.array.length=0)},t}(ID),MD=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.add=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.array.push(e);else{var n=t<0?this._neg.array:this._pos.array,i=PD(n,e);i<0&&n.splice(~i,0,e)}},n.remove=function(e){var t=e.constructor._executionOrder;if(0===t)this._zero.fastRemove(e);else{var n=t<0?this._neg:this._pos,i=PD(n.array,e);i>=0&&n.removeAt(i)}},n.invoke=function(e){this._neg.array.length>0&&this._invoke(this._neg,e),this._invoke(this._zero,e),this._pos.array.length>0&&this._invoke(this._pos,e)},t}(ID);function ND(e,t,n){var i="var a=it.array;for(it.i=0;it.i<a.length;++it.i){var c=a[it.i];"+e+"}",r=t?Function("it","dt",i):Function("it",i);return function(e,t,n){return function(i,r){try{t(i,r)}catch(t){u._throw(t);var o=i.array;for(n&&(o[i.i]._objFlags|=n),++i.i;i.i<o.length;++i.i)try{e(o[i.i],r)}catch(e){u._throw(e),n&&(o[i.i]._objFlags|=n)}}}}(Function("c","dt",e),r,n)}var LD=ND("c.start();c._objFlags|="+AD,!1,AD),BD=ND("c.update(dt)",!0),FD=ND("c.lateUpdate(dt)",!0),zD=function(e){var t=u.director._compScheduler,n=e.array;for(e.i=0;e.i<n.length;++e.i){var i=n[e.i];i._enabled&&(i.onEnable(),!i.node._activeInHierarchy||t._onEnabled(i))}},UD=function(){function e(){this._deferredComps=[],this.unscheduleAll()}var t=e.prototype;return t.unscheduleAll=function(){this.startInvoker=new OD(LD),this.updateInvoker=new MD(BD),this.lateUpdateInvoker=new MD(FD),this._updating=!1},t._onEnabled=function(e){u.director.getScheduler().resumeTarget(e),e._objFlags|=wD,this._updating?this._deferredComps.push(e):this._scheduleImmediate(e)},t._onDisabled=function(e){u.director.getScheduler().pauseTarget(e),e._objFlags&=~wD;var t=this._deferredComps.indexOf(e);t>=0?CD(this._deferredComps,t):(!e.start||e._objFlags&AD||this.startInvoker.remove(e),e.update&&this.updateInvoker.remove(e),e.lateUpdate&&this.lateUpdateInvoker.remove(e))},t.enableComp=function(e,t){if(!(e._objFlags&wD)){if(e.onEnable){if(t)return void t.add(e);if(e.onEnable(),!e.node._activeInHierarchy)return}this._onEnabled(e)}},t.disableComp=function(e){e._objFlags&wD&&(e.onDisable&&e.onDisable(),this._onDisabled(e))},t.startPhase=function(){this._updating=!0,this.startInvoker.invoke(),this._startForNewComps()},t.updatePhase=function(e){this.updateInvoker.invoke(e)},t.lateUpdatePhase=function(e){this.lateUpdateInvoker.invoke(e),this._updating=!1,this._startForNewComps()},t._startForNewComps=function(){this._deferredComps.length>0&&(this._deferredSchedule(),this.startInvoker.invoke())},t._scheduleImmediate=function(e){"function"!=typeof e.start||e._objFlags&AD||this.startInvoker.add(e),"function"==typeof e.update&&this.updateInvoker.add(e),"function"==typeof e.lateUpdate&&this.lateUpdateInvoker.add(e)},t._deferredSchedule=function(){for(var e=this._deferredComps,t=0,n=e.length;t<n;t++)this._scheduleImmediate(e[t]);e.length=0},e}(),kD=ml.Flags.IsPreloadStarted,GD=ml.Flags.IsOnLoadStarted,HD=ml.Flags.IsOnLoadCalled,VD=ml.Flags.Deactivating,WD=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.add=function(e){this._zero.array.push(e)},n.remove=function(e){this._zero.fastRemove(e)},n.cancelInactive=function(e){ID.stableRemoveInactive(this._zero,e)},n.invoke=function(){this._invoke(this._zero),this._zero.array.length=0},t}(ID),jD=ND("c.__preload();"),qD=ND("c.onLoad();c._objFlags|="+HD,!1,HD),XD=new nt(4);function YD(e,t,n){M(3817,e.name,n),console.log("Corrupted component value:",t),t?e._removeComponent(t):it.removeAt(e._components,n)}XD.get=function(){var e=this._get()||{preload:new WD(jD),onLoad:new OD(qD),onEnable:new OD(zD)};e.preload._zero.i=-1;var t=e.onLoad;return t._zero.i=-1,t._neg.i=-1,t._pos.i=-1,(t=e.onEnable)._zero.i=-1,t._neg.i=-1,t._pos.i=-1,e};var KD,QD,ZD,JD,$D,eO,tO,nO,iO=e("NodeActivator",function(){function e(){this.resetComp=void 0,this.reset()}var t=e.prototype;return t.reset=function(){this._activatingStack=[]},t.activateNode=function(e,t){if(t){var n=XD.get();this._activatingStack.push(n),this._activateNodeRecursively(e,n.preload,n.onLoad,n.onEnable),n.preload.invoke(),n.onLoad.invoke(),n.onEnable.invoke(),this._activatingStack.pop(),XD.put(n)}else{this._deactivateNodeRecursively(e);for(var i,r=se(this._activatingStack);!(i=r()).done;){var o=i.value;o.preload.cancelInactive(kD),o.onLoad.cancelInactive(GD),o.onEnable.cancelInactive()}}e.emit(Wb.ACTIVE_IN_HIERARCHY_CHANGED,e)},t.activateComp=function(e,t,n,i){if(gl(e,!0)&&(e._objFlags&kD||(e._objFlags|=kD,e.__preload&&(t?t.add(e):e.__preload())),e._objFlags&GD||(e._objFlags|=GD,e.onLoad?n?n.add(e):(e.onLoad(),e._objFlags|=HD):e._objFlags|=HD),e._enabled)){if(!e.node._activeInHierarchy)return;u.director._compScheduler.enableComp(e,i)}},t.destroyComp=function(e){u.director._compScheduler.disableComp(e),e.onDestroy&&e._objFlags&HD&&e.onDestroy()},t._activateNodeRecursively=function(e,t,n,i){if(e._objFlags&VD)M(3816,e.name);else{e._activeInHierarchy=!0;for(var r=e._components.length,o=0;o<r;++o){var a=e._components[o];a instanceof u.Component?this.activateComp(a,t,n,i):(YD(e,a,o),--o,--r)}for(var s=0,c=e._children.length;s<c;++s){var l=e._children[s];l._active&&this._activateNodeRecursively(l,t,n,i)}e._onPostActivated(!0)}},t._deactivateNodeRecursively=function(e){e._objFlags|=VD,e._activeInHierarchy=!1;for(var t=e._components.length,n=0;n<t;++n){var i=e._components[n];if(i._enabled&&(u.director._compScheduler.disableComp(i),e._activeInHierarchy))return void(e._objFlags&=~VD)}for(var r=0,o=e._children.length;r<o;++r){var a=e._children[r];if(a._activeInHierarchy&&(this._deactivateNodeRecursively(a),e._activeInHierarchy))return void(e._objFlags&=~VD)}e._onPostActivated(!1),e._objFlags&=~VD},e}()),rO=e("SceneAsset",mc("cc.SceneAsset")((JD=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"scene",ZD,oe(t)),t}$(t,e);var n=t.prototype;return n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.scene=new bD("New Scene")},n.validate=function(){return!!this.scene},t}(Nu),ZD=le((QD=JD).prototype,"scene",[Mc,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KD=QD))||KD);u.SceneAsset=rO;var oO,aO,sO,cO,lO=e("TextAsset",mc("cc.TextAsset")((nO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"text",tO,oe(t)),t}return $(t,e),t.prototype.toString=function(){return this.text},t}(Nu),tO=le((eO=nO).prototype,"text",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$D=eO))||$D);u.TextAsset=lO;var uO=e("JsonAsset",mc("cc.JsonAsset")((cO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"json",sO,oe(t)),t}return $(t,e),t}(Nu),sO=le((aO=cO).prototype,"json",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),oO=aO))||oO);u.JsonAsset=uO;var hO,fO,_O,pO,dO,mO,vO,gO,yO,xO,SO,TO,bO,EO,CO,AO,wO,PO,RO,IO,DO,OO,MO,NO,LO,BO,FO,zO,UO,kO,GO,HO,VO,WO,jO,qO,XO,YO,KO=function(){var e=t.prototype;function t(){this.fog=new wb,this.ambient=new tT,this.skybox=new ST,this.shadows=new Eg,this.octree=new iT,this.validPunctualLights=[],this.renderObjects=[],this.castShadowObjects=[],this.dirShadowObjects=[],this.shadowFrameBufferMap=new Map,this._occlusionQueryVertexBuffer=null,this._occlusionQueryIndicesBuffer=null,this._occlusionQueryInputAssembler=null,this._occlusionQueryMaterial=null,this._occlusionQueryShader=null,this._isHDR=!0,this._shadingScale=1,this._init(),this.shadingScale=1}return e._init=function(){},e.activate=function(e,t){return this._device=e,this._pipeline=t,this.initOcclusionQuery(),!0},e.initOcclusionQuery=function(){if(this._occlusionQueryInputAssembler||(this._occlusionQueryInputAssembler=this._createOcclusionQueryIA()),!this._occlusionQueryMaterial){var e=new ug;e._uuid="default-occlusion-query-material",e.initialize({effectName:"occlusion-query"}),this._occlusionQueryMaterial=e,this._occlusionQueryShader=e.passes[0].getShaderVariant()}},e.getOcclusionQueryPass=function(){return this._occlusionQueryMaterial.passes[0]},e.onGlobalPipelineStateChanged=function(){},e.destroy=function(){var e,t,n;this.ambient.destroy(),this.skybox.destroy(),this.fog.destroy(),this.shadows.destroy(),this.octree.destroy(),this.validPunctualLights.length=0,null===(e=this._occlusionQueryInputAssembler)||void 0===e||e.destroy(),this._occlusionQueryInputAssembler=null,null===(t=this._occlusionQueryVertexBuffer)||void 0===t||t.destroy(),this._occlusionQueryVertexBuffer=null,null===(n=this._occlusionQueryIndicesBuffer)||void 0===n||n.destroy(),this._occlusionQueryIndicesBuffer=null},e._createOcclusionQueryIA=function(){var e=this._device,t=new Float32Array([-1,-1,-1,1,-1,-1,-1,1,-1,1,1,-1,-1,-1,1,1,-1,1,-1,1,1,1,1,1]),n=3*Float32Array.BYTES_PER_ELEMENT,i=8*n;this._occlusionQueryVertexBuffer=e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,i,n)),this._occlusionQueryVertexBuffer.update(t);var r=new Uint16Array([0,2,1,1,2,3,4,5,6,5,7,6,1,3,7,1,7,5,0,4,6,0,6,2,0,1,5,0,5,4,2,6,7,2,7,3]),o=Uint16Array.BYTES_PER_ELEMENT,a=36*o;this._occlusionQueryIndicesBuffer=e.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,a,o)),this._occlusionQueryIndicesBuffer.update(r);var s=[new Ir("a_position",pi.RGB32F)],c=new Or(s,[this._occlusionQueryVertexBuffer],this._occlusionQueryIndicesBuffer);return e.createInputAssembler(c)},Z(t,[{key:"native",get:function(){return this._nativeObj}},{key:"isHDR",get:function(){return this._isHDR},set:function(e){this._isHDR=e}},{key:"shadingScale",get:function(){return this._shadingScale},set:function(e){this._shadingScale!==e&&(this._shadingScale=e,this._pipeline.emit(Vy.ATTACHMENT_SCALE_CAHNGED,e))}}]),t}(),QO=e("ForwardPipeline",(hO=mc("ForwardPipeline"),fO=Zc([VS]),_O=Vc(),hO((vO=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"renderTextures",mO,oe(t)),t._postRenderPass=null,t}$(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new bb;n.initialize(bb.initInfo),this._flows.push(n);var i=new ob;i.initialize(ob.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:0},this._pipelineSceneData=new KO,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(M(2402),1))},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n)},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n._activeRenderer=function(){var e=this.device;this._commandBuffers.push(e.commandBuffer);var t=this.globalDSManager.pointSampler;return this._descriptorSet.bindSampler(nd,t),this._descriptorSet.bindTexture(nd,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(hd,t),this._descriptorSet.bindTexture(hd,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.update(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer($p.BINDING).destroy(),this._descriptorSet.getBuffer(td.BINDING).destroy(),this._descriptorSet.getBuffer(ed.BINDING).destroy(),this._descriptorSet.getTexture(nd).destroy(),this._descriptorSet.getTexture(hd).destroy())},Z(t,[{key:"postRenderPass",get:function(){return this._postRenderPass}}]),t}(hx),mO=le((dO=vO).prototype,"renderTextures",[fO,Tc,_O],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pO=dO))||pO)),ZO=[new lr(0,0,0,0),new lr(0,0,0,0),new lr(0,0,0,0)],JO=e("GbufferStage",(gO=mc("GbufferStage"),yO=Zc([qS]),xO=Vc(),gO((CO=EO=function(e){function t(){var t;return ce(t=e.call(this)||this,"renderQueues",bO,oe(t)),t._renderQueues=[],t._renderArea=new tr,t._batchedQueue=void 0,t._instancedQueue=void 0,t._phaseID=Lv("default"),t._batchedQueue=new $S,t._instancedQueue=new eT,t}$(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),t.renderQueues&&(this.renderQueues=t.renderQueues),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n);for(var i=0;i<this.renderQueues.length;i++)this._renderQueues[i]=QS(this.renderQueues[i])},n.destroy=function(){},n.render=function(e){this._instancedQueue.clear(),this._batchedQueue.clear();var t=this._pipeline,n=t.device;this._renderQueues.forEach(ZS),t.generateRenderArea(e,this._renderArea),t.updateQuadVertexData(this._renderArea,e.window);for(var i=t.pipelineSceneData.renderObjects,r=0,o=0,a=0,s=0;s<i.length;++s){var c=i[s],l=c.model.subModels;for(r=0;r<l.length;++r){var u=l[r],h=u.passes;for(o=0;o<h.length;++o){var f=h[o];if(f.phase===this._phaseID){var _=f.batchingScheme;if(_===Iv.INSTANCING){var p=f.getInstancedBuffer();p.merge(u,c.model.instancedAttributes,o),this._instancedQueue.queue.add(p)}else if(_===Iv.VB_MERGING){var d=f.getBatchedBuffer();d.merge(u,o,c.model),this._batchedQueue.queue.add(d)}else for(a=0;a<this._renderQueues.length;a++)this._renderQueues[a].insertRenderPass(c,r,o)}}}}this._renderQueues.forEach(JS);var m=t.commandBuffers[0];this._instancedQueue.uploadBuffers(m),this._batchedQueue.uploadBuffers(m),e.clearFlag&Ki.COLOR&&(t.pipelineSceneData.isHDR?jv(ZO[0],e.clearColor):(ZO[0].x=e.clearColor.x,ZO[0].y=e.clearColor.y,ZO[0].z=e.clearColor.z)),ZO[0].w=e.clearColor.w;var v=t.getPipelineRenderData().gbufferFrameBuffer,g=v.renderPass;m.beginRenderPass(g,v,this._renderArea,ZO,e.clearDepth,e.clearStencil),m.setScissor(t.generateScissor(e)),m.setViewport(t.generateViewport(e)),m.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet);for(var y=0;y<this.renderQueues.length;y++)this._renderQueues[y].recordCommandBuffer(n,g,m);this._instancedQueue.recordCommandBuffer(n,g,m),this._batchedQueue.recordCommandBuffer(n,g,m),m.endRenderPass()},t}(Hy),EO.initInfo={name:"GbufferStage",priority:ix.GBUFFER,tag:0,renderQueues:[{isTransparent:!1,sortMode:HS.FRONT_TO_BACK,stages:["default"]},{isTransparent:!0,sortMode:HS.BACK_TO_FRONT,stages:["default"]}]},bO=le((TO=CO).prototype,"renderQueues",[yO,Tc,xO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),SO=TO))||SO)),$O=[new lr(0,0,0,1)],eM=e("LightingStage",(AO=mc("LightingStage"),wO=Zc(ug),PO=Vc(),RO=Zc([qS]),IO=Vc(),AO((BO=LO=function(e){function t(){var t;return(t=e.call(this)||this)._deferredLitsBufs=null,t._maxDeferredLights=yd.LIGHTS_PER_PASS,t._lightMeterScale=1e4,t._descriptorSet=null,t._renderArea=new tr,t._uiPhase=void 0,ce(t,"_deferredMaterial",MO,oe(t)),ce(t,"renderQueues",NO,oe(t)),t._phaseID=Lv("default"),t._renderQueues=[],t._uiPhase=new nb,t}$(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.gatherLights=function(e){for(var t=this._pipeline,n=t.commandBuffers[0],i=e.scene.sphereLights,r=e.scene.spotLights,o=la.create(0,0,0,1),a=new Float32Array(4),s=e.exposure,c=0,l=$n.length,u=l*this._maxDeferredLights,h=0;h<i.length&&c<this._maxDeferredLights;h++,++c){var f=i[h];if(la.set(o,f.position.x,f.position.y,f.position.z,f.range),_s.sphereFrustum(o,e.frustum)){if(In.toArray(a,f.position),a[3]=0,this._lightBufferData.set(a,c*l),In.toArray(a,f.color),f.useColorTemperature){var _=f.colorTemperatureRGB;a[0]*=_.x,a[1]*=_.y,a[2]*=_.z}t.pipelineSceneData.isHDR?a[3]=f.luminance*s*this._lightMeterScale:a[3]=f.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=f.size,a[1]=f.range,a[2]=0,this._lightBufferData.set(a,c*l+2*u)}}for(var p=0;p<r.length&&c<this._maxDeferredLights;p++,++c){var d=r[p];if(la.set(o,d.position.x,d.position.y,d.position.z,d.range),_s.sphereFrustum(o,e.frustum)){if(In.toArray(a,d.position),a[3]=1,this._lightBufferData.set(a,c*l+0*u),In.toArray(a,d.color),d.useColorTemperature){var m=d.colorTemperatureRGB;a[0]*=m.x,a[1]*=m.y,a[2]*=m.z}t.pipelineSceneData.isHDR?a[3]=d.luminance*s*this._lightMeterScale:a[3]=d.luminance,this._lightBufferData.set(a,c*l+1*u),a[0]=d.size,a[1]=d.range,a[2]=d.spotAngle,this._lightBufferData.set(a,c*l+2*u),In.toArray(a,d.direction),this._lightBufferData.set(a,c*l+3*u)}}var v=3*u+3;this._lightBufferData.set([c],v),n.updateBuffer(this._deferredLitsBufs,this._lightBufferData)},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._uiPhase.activate(t);for(var i=t.device,r=0;r<this.renderQueues.length;r++)this._renderQueues[r]=QS(this.renderQueues[r]);var o=16*Float32Array.BYTES_PER_ELEMENT*this._maxDeferredLights;o=Math.ceil(o/i.capabilities.uboOffsetAlignment)*i.capabilities.uboOffsetAlignment,this._deferredLitsBufs=i.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,o,i.capabilities.uboOffsetAlignment));var a=i.createBuffer(new pr(this._deferredLitsBufs,0,o));this._lightBufferData=new Float32Array(o/Float32Array.BYTES_PER_ELEMENT);var s=new Hr(jp.bindings);this._descriptorSetLayout=i.createDescriptorSetLayout(s),this._descriptorSet=i.createDescriptorSet(new Vr(this._descriptorSetLayout)),this._descriptorSet.bindBuffer(gd.BINDING,a),this._planarQueue=new tb(this._pipeline),this._deferredMaterial&&(t.pipelineSceneData.deferredLightingMaterial=this._deferredMaterial)},n.destroy=function(){var e;null===(e=this._deferredLitsBufs)||void 0===e||e.destroy(),this._deferredLitsBufs=null,this._descriptorSet=null},n.render=function(e){var t=this._pipeline,n=t.device,i=t.commandBuffers[0],r=t.pipelineSceneData,o=r.renderObjects;this.gatherLights(e),this._descriptorSet.update(),this._planarQueue.gatherShadowPasses(e,i),i.bindDescriptorSet(Kp.LOCAL,this._descriptorSet,[0]),t.generateRenderArea(e,this._renderArea),e.clearFlag&Ki.COLOR&&($O[0].x=e.clearColor.x,$O[0].y=e.clearColor.y,$O[0].z=e.clearColor.z),$O[0].w=0;var a=t.getPipelineRenderData(),s=a.outputFrameBuffer,c=s.renderPass;t.pipelineUBO.updateShadowUBO(e),i.beginRenderPass(c,s,this._renderArea,$O,e.clearDepth,e.clearStencil),i.setScissor(t.generateScissor(e)),i.setViewport(t.generateViewport(e)),i.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet);for(var l=r.deferredLightingMaterial.passes[0],u=l.getShaderVariant(),h=0;h<3;++h)l.descriptorSet.bindTexture(h,a.gbufferRenderTargets[h]),l.descriptorSet.bindSampler(h,a.sampler);l.descriptorSet.bindTexture(3,a.outputDepth),l.descriptorSet.bindSampler(3,a.sampler),l.descriptorSet.update(),i.bindDescriptorSet(Kp.MATERIAL,l.descriptorSet);var f=t.quadIAOffscreen,_=null;null!=l&&null!=u&&null!=f&&(_=Hv.getOrCreatePipelineState(n,l,u,c,f)),null!=_&&(i.bindPipelineState(_),i.bindInputAssembler(f),i.draw(f)),this._renderQueues.forEach(ZS);for(var p=0,d=0,m=0,v=0;v<o.length;++v){var g=o[v],y=g.model.subModels;for(p=0;p<y.length;++p){var x=y[p].passes;for(d=0;d<x.length;++d)if(x[d].phase===this._phaseID)for(m=0;m<this._renderQueues.length;m++)this._renderQueues[m].insertRenderPass(g,p,d)}}if(o.length>0){this._renderQueues.forEach(JS);for(var S=0;S<this._renderQueues.length;S++)this._renderQueues[S].recordCommandBuffer(n,c,i);this._planarQueue.recordCommandBuffer(n,c,i)}this._uiPhase.render(e,c),i.endRenderPass()},t}(Hy),LO.initInfo={name:"LightingStage",priority:ix.LIGHTING,tag:0},MO=le((OO=BO).prototype,"_deferredMaterial",[wO,Tc,PO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),NO=le(OO.prototype,"renderQueues",[RO,Tc,IO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),DO=OO))||DO)),tM=[new lr(0,0,0,1)],nM=e("PostProcessStage",(FO=mc("PostProcessStage"),zO=Zc(ug),UO=Vc(),kO=Zc([qS]),GO=Vc(),FO((XO=qO=function(e){function t(){var t;return ce(t=e.call(this)||this,"_postProcessMaterial",WO,oe(t)),ce(t,"renderQueues",jO,oe(t)),t._renderArea=new tr,t._uiPhase=new nb,t}$(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._postProcessMaterial&&(t.pipelineSceneData.postprocessMaterial=this._postProcessMaterial),this._uiPhase.activate(t)},n.destroy=function(){},n.render=function(e){var t=this._pipeline,n=t.device,i=t.pipelineSceneData,r=t.commandBuffers[0];t.pipelineUBO.updateCameraUBO(e);var o=e.viewport;this._renderArea.x=o.x*e.window.width,this._renderArea.y=o.y*e.window.height,this._renderArea.width=o.width*e.window.width,this._renderArea.height=o.height*e.window.height;var a=t.getPipelineRenderData(),s=e.window.framebuffer,c=t.getRenderPass(e.clearFlag,s);e.clearFlag&Ki.COLOR&&(tM[0].x=e.clearColor.x,tM[0].y=e.clearColor.y,tM[0].z=e.clearColor.z),tM[0].w=e.clearColor.w,r.beginRenderPass(c,s,this._renderArea,tM,e.clearDepth,e.clearStencil),r.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet);var l=i.postprocessMaterial.passes[0],u=l.getShaderVariant();t.bloomEnabled?l.descriptorSet.bindTexture(0,a.bloom.combineTex):l.descriptorSet.bindTexture(0,a.outputRenderTargets[0]),l.descriptorSet.bindSampler(0,a.sampler),l.descriptorSet.update(),r.bindDescriptorSet(Kp.MATERIAL,l.descriptorSet);var h=e.window.swapchain?t.quadIAOnscreen:t.quadIAOffscreen,f=null;null!=l&&null!=u&&null!=h&&(f=Hv.getOrCreatePipelineState(n,l,u,c,h));var _=t.pipelineSceneData.renderObjects;null!=f&&_.length>0&&(r.bindPipelineState(f),r.bindInputAssembler(h),r.draw(h)),this._uiPhase.render(e,c),ig(n,c,r,t.profiler,e),r.endRenderPass()},t}(Hy),qO.initInfo={name:"PostProcessStage",priority:ex.POST_PROCESS,tag:0},WO=le((VO=XO).prototype,"_postProcessMaterial",[zO,Tc,UO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jO=le(VO.prototype,"renderQueues",[kO,Tc,GO],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),HO=VO))||HO));!function(e){e[e.NONE=0]="NONE",e[e.FXAA=1]="FXAA"}(YO||(YO={}));var iM,rM,oM,aM,sM,cM,lM,uM,hM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._antiAliasing=YO.NONE,t}$(t,e);var n=t.prototype;return n.onGlobalPipelineStateChanged=function(){this.updatePipelinePassInfo()},n.updateBloomPass=function(){if(this._bloomMaterial){var e=this._bloomMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently();for(var t=[],n=[],i=0;i<6;++i){var r=this._bloomMaterial.passes[1+i];r.beginChangeStatesSilently(),r.tryCompile(),r.endChangeStatesSilently();var o=this._bloomMaterial.passes[7+i];o.beginChangeStatesSilently(),o.tryCompile(),o.endChangeStatesSilently(),t.push(r.native),n.push(o.native)}var a=this._bloomMaterial.passes[13];a.beginChangeStatesSilently(),a.tryCompile(),a.endChangeStatesSilently()}},n.updatePostProcessPass=function(){if(this.postprocessMaterial){var e=this.postprocessMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},n.initPipelinePassInfo=function(){var e=new ug;e._uuid="builtin-deferred-material",e.initialize({effectName:"deferred-lighting"});for(var t=0;t<e.passes.length;++t)e.passes[t].tryCompile();this._deferredLightingMaterial=e;var n=new ug;n._uuid="builtin-bloom-material",n.initialize({effectName:"bloom"});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._bloomMaterial=n;var r=new ug;r._uuid="builtin-post-process-material",ft.ENABLE_ANTIALIAS_FXAA&&(this._antiAliasing=YO.FXAA),r.initialize({effectName:"post-process",defines:{ANTIALIAS_TYPE:this._antiAliasing}});for(var o=0;o<r.passes.length;++o)r.passes[o].tryCompile();this._postprocessMaterial=r,this.updatePipelinePassInfo()},n.updatePipelinePassInfo=function(){this.updateBloomPass(),this.updatePostProcessPass(),this.updateDeferredPassInfo()},n.activate=function(t,n){return e.prototype.activate.call(this,t,n),this.initPipelinePassInfo(),!0},n.updateDeferredPassInfo=function(){this.updateDeferredLightPass()},n.updateDeferredLightPass=function(){if(this._deferredLightingMaterial){this.shadows.enabled&&(this._pipeline.macros.CC_RECEIVE_SHADOW=1);var e=this._deferredLightingMaterial.passes[0];e.beginChangeStatesSilently(),e.tryCompile(),e.endChangeStatesSilently()}},Z(t,[{key:"antiAliasing",get:function(){return this._antiAliasing},set:function(e){if(this._antiAliasing=e,this._postprocessMaterial){var t=this._postprocessMaterial.passes[0].defines;Object.assign(t,{ANTIALIAS_TYPE:e});var n=new ug;n.initialize({effectAsset:this._postprocessMaterial.effectAsset,defines:t});for(var i=0;i<n.passes.length;++i)n.passes[i].tryCompile();this._postprocessMaterial=n}}},{key:"bloomMaterial",get:function(){return this._bloomMaterial},set:function(e){this._bloomMaterial!==e&&e&&(this._bloomMaterial=e,this.updatePipelinePassInfo())}},{key:"postprocessMaterial",get:function(){return this._postprocessMaterial},set:function(e){this._postprocessMaterial!==e&&e&&(this._postprocessMaterial=e,this.updatePipelinePassInfo())}},{key:"deferredLightingMaterial",get:function(){return this._deferredLightingMaterial},set:function(e){this._deferredLightingMaterial!==e&&e&&(this._deferredLightingMaterial=e,this.updatePipelinePassInfo())}}]),t}(KO),fM=[new lr(0,0,0,1)],_M=function(){};_M.SIZE=4*(_M.COUNT=4+(_M.TEXTURE_SIZE_OFFSET=0));var pM,dM,mM,vM,gM,yM,xM,SM,TM,bM,EM=e("BloomStage",(iM=mc("BloomStage"),rM=Zc(ug),oM=Vc(),iM((uM=lM=function(e){function t(){var t;return(t=e.call(this)||this).threshold=1,t.intensity=.8,t.iterations=2,ce(t,"_bloomMaterial",cM,oe(t)),t._renderArea=new tr,t._bloomUBO=[],t}$(t,e);var n=t.prototype;return n.initialize=function(t){return e.prototype.initialize.call(this,t),!0},n.activate=function(t,n){e.prototype.activate.call(this,t,n),this._bloomMaterial&&(t.pipelineSceneData.bloomMaterial=this._bloomMaterial)},n.destroy=function(){},n.render=function(e){var t,n=this._pipeline;if(n.generateBloomRenderData(),((null===(t=e.window)||void 0===t?void 0:t.swapchain)||n.macros.CC_PIPELINE_TYPE)&&n.bloomEnabled&&0!==n.pipelineSceneData.renderObjects.length){if(0===this._bloomUBO.length)for(var i=0;i<14;++i)this._bloomUBO[i]=n.device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,_M.SIZE,_M.SIZE));e.clearFlag&Ki.COLOR&&(fM[0].x=e.clearColor.x,fM[0].y=e.clearColor.y,fM[0].z=e.clearColor.z),fM[0].w=e.clearColor.w,this._prefilterPass(e,n),this._downsamplePass(e,n),this._upsamplePass(e,n),this._combinePass(e,n)}},n._prefilterPass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial.passes[0],r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(_M.COUNT);a[_M.TEXTURE_SIZE_OFFSET+2]=this.threshold,n.updateBuffer(this._bloomUBO[0],a),n.beginRenderPass(o.renderPass,o.prefilterFramebuffer,this._renderArea,fM,0,0),n.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet),i.descriptorSet.bindBuffer(0,this._bloomUBO[0]),i.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),i.descriptorSet.bindSampler(1,o.sampler),i.descriptorSet.update(),n.bindDescriptorSet(Kp.MATERIAL,i.descriptorSet);var s=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,c=null,l=i.getShaderVariant();null!=i&&null!=l&&null!=s&&(c=Hv.getOrCreatePipelineState(t.device,i,l,o.renderPass,s)),null!=c&&(n.bindPipelineState(c),n.bindInputAssembler(s),n.draw(s)),n.endRenderPass()},n._downsamplePass=function(e,t){t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=1,this._renderArea.height>>=1;for(var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData().bloom,o=new Float32Array(_M.COUNT),a=0;a<this.iterations;++a){o[_M.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[_M.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,n.updateBuffer(this._bloomUBO[a+1],o),this._renderArea.width>>=1,this._renderArea.height>>=1,n.beginRenderPass(r.renderPass,r.downsampleFramebuffers[a],this._renderArea,fM,0,0);var s=i.passes[1+a],c=s.getShaderVariant();s.descriptorSet.bindBuffer(0,this._bloomUBO[a+1]),0===a?s.descriptorSet.bindTexture(1,r.prefiterTex):s.descriptorSet.bindTexture(1,r.downsampleTexs[a-1]),s.descriptorSet.bindSampler(1,r.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Kp.MATERIAL,s.descriptorSet);var l=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,u=null;null!=s&&null!=c&&null!=l&&(u=Hv.getOrCreatePipelineState(t.device,s,c,r.renderPass,l)),null!=u&&(n.bindPipelineState(u),n.bindInputAssembler(l),n.draw(l)),n.endRenderPass()}},n._upsamplePass=function(e,t){var n=t.getPipelineRenderData().bloom;t.generateRenderArea(e,this._renderArea),this._renderArea.width>>=this.iterations+1,this._renderArea.height>>=this.iterations+1;for(var i=t.commandBuffers[0],r=t.pipelineSceneData.bloomMaterial,o=new Float32Array(_M.COUNT),a=0;a<this.iterations;++a){var s=a+6+1;o[_M.TEXTURE_SIZE_OFFSET+0]=this._renderArea.width,o[_M.TEXTURE_SIZE_OFFSET+1]=this._renderArea.height,i.updateBuffer(this._bloomUBO[s],o),this._renderArea.width<<=1,this._renderArea.height<<=1,i.beginRenderPass(n.renderPass,n.upsampleFramebuffers[this.iterations-1-a],this._renderArea,fM,0,0);var c=r.passes[7+a],l=c.getShaderVariant();c.descriptorSet.bindBuffer(0,this._bloomUBO[s]),0===a?c.descriptorSet.bindTexture(1,n.downsampleTexs[this.iterations-1]):c.descriptorSet.bindTexture(1,n.upsampleTexs[this.iterations-a]),c.descriptorSet.bindSampler(1,n.sampler),c.descriptorSet.update(),i.bindDescriptorSet(Kp.MATERIAL,c.descriptorSet);var u=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,h=null;null!=c&&null!=l&&null!=u&&(h=Hv.getOrCreatePipelineState(t.device,c,l,n.renderPass,u)),null!=h&&(i.bindPipelineState(h),i.bindInputAssembler(u),i.draw(u)),i.endRenderPass()}},n._combinePass=function(e,t){t.generateRenderArea(e,this._renderArea);var n=t.commandBuffers[0],i=t.pipelineSceneData.bloomMaterial,r=t.getPipelineRenderData(),o=r.bloom,a=new Float32Array(_M.COUNT);a[_M.TEXTURE_SIZE_OFFSET+3]=this.intensity,n.updateBuffer(this._bloomUBO[13],a),n.beginRenderPass(o.renderPass,o.combineFramebuffer,this._renderArea,fM,0,0),n.bindDescriptorSet(Kp.GLOBAL,t.descriptorSet);var s=i.passes[13];s.descriptorSet.bindBuffer(0,this._bloomUBO[13]),s.descriptorSet.bindTexture(1,r.outputRenderTargets[0]),s.descriptorSet.bindTexture(2,o.upsampleTexs[0]),s.descriptorSet.bindSampler(1,o.sampler),s.descriptorSet.bindSampler(2,o.sampler),s.descriptorSet.update(),n.bindDescriptorSet(Kp.MATERIAL,s.descriptorSet);var c=e.window.swapchain?t.quadIAOffscreen:t.quadIAOnscreen,l=null,u=s.getShaderVariant();null!=s&&null!=u&&null!=c&&(l=Hv.getOrCreatePipelineState(t.device,s,u,o.renderPass,c)),null!=l&&(n.bindPipelineState(l),n.bindInputAssembler(c),n.draw(c)),n.endRenderPass()},t}(Hy),lM.initInfo={name:"BloomStage",priority:ex.BLOOM,tag:0},cM=le((sM=uM).prototype,"_bloomMaterial",[rM,Tc,oM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),aM=sM))||aM)),CM=e("MainFlow",mc("MainFlow")((mM=dM=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._stages.length){var n=new JO;n.initialize(JO.initInfo),this._stages.push(n);var i=new eM;i.initialize(eM.initInfo),this._stages.push(i);var r=new EM;r.initialize(EM.initInfo),this._stages.push(r);var o=new nM;o.initialize(nM.initInfo),this._stages.push(o)}return!0},n.activate=function(t){e.prototype.activate.call(this,t)},n.render=function(t){e.prototype.render.call(this,t)},n.destroy=function(){e.prototype.destroy.call(this)},t}(Wy),dM.initInfo={name:kp,priority:rx.MAIN,stages:[]},pM=mM))||pM),AM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).gbufferFrameBuffer=null,t.gbufferRenderTargets=[],t}return $(t,e),t}((function(){this.outputFrameBuffer=null,this.outputRenderTargets=[],this.outputDepth=null,this.sampler=null,this.bloom=null})),wM=e("DeferredPipeline",(vM=mc("DeferredPipeline"),gM=Zc([VS]),yM=Vc(),vM((bM=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gbufferRenderPass=null,t._lightingRenderPass=null,ce(t,"renderTextures",TM,oe(t)),t}$(t,e);var n=t.prototype;return n.initialize=function(t){if(e.prototype.initialize.call(this,t),0===this._flows.length){var n=new bb;n.initialize(bb.initInfo),this._flows.push(n);var i=new CM;i.initialize(CM.initInfo),this._flows.push(i)}return!0},n.activate=function(t){return this._macros={CC_PIPELINE_TYPE:1},this._pipelineSceneData=new hM,!(!e.prototype.activate.call(this,t)||!this._activeRenderer(t)&&(M(2402),1))},n.destroy=function(){this._destroyUBOs(),this._destroyQuadInputAssembler(),this._destroyDeferredData();for(var t=this._renderPasses.values(),n=t.next();!n.done;)n.value.destroy(),n=t.next();return this._commandBuffers.length=0,e.prototype.destroy.call(this)},n.getPipelineRenderData=function(){return this._pipelineRenderData||this._generateDeferredRenderData(),this._pipelineRenderData},n._activeRenderer=function(e){var t=this.device;this._commandBuffers.push(t.commandBuffer);var n=this.globalDSManager.pointSampler;this._descriptorSet.bindSampler(nd,n),this._descriptorSet.bindTexture(nd,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.bindSampler(hd,n),this._descriptorSet.bindTexture(hd,Nv.get("default-texture").getGFXTexture()),this._descriptorSet.update();var i=new ux;if(!(i=this._createQuadInputAssembler()).quadIB||!i.quadVB||!i.quadIA)return!1;this._quadIB=i.quadIB,this._quadVBOffscreen=i.quadVB,this._quadIAOffscreen=i.quadIA;var r=this._createQuadInputAssembler();if(!r.quadIB||!r.quadVB||!r.quadIA)return!1;if(this._quadVBOnscreen=r.quadVB,this._quadIAOnscreen=r.quadIA,!this._gbufferRenderPass){var o=new Mr;o.format=pi.RGBA16F,o.loadOp=Ni.CLEAR,o.storeOp=Li.STORE;var a=new Mr;a.format=pi.RGBA16F,a.loadOp=Ni.CLEAR,a.storeOp=Li.STORE;var s=new Mr;s.format=pi.RGBA16F,s.loadOp=Ni.CLEAR,s.storeOp=Li.STORE;var c=new Nr;c.format=pi.DEPTH_STENCIL,c.depthLoadOp=Ni.CLEAR,c.depthStoreOp=Li.STORE,c.stencilLoadOp=Ni.CLEAR,c.stencilStoreOp=Li.STORE;var l=new Fr([o,a,s],c);this._gbufferRenderPass=t.createRenderPass(l)}if(!this._lightingRenderPass){var u=new Mr;u.format=pi.RGBA8,u.loadOp=Ni.CLEAR,u.storeOp=Li.STORE,u.endAccesses=[Bi.COLOR_ATTACHMENT_WRITE];var h=new Nr;h.format=pi.DEPTH_STENCIL,h.depthLoadOp=Ni.LOAD,h.depthStoreOp=Li.DISCARD,h.stencilLoadOp=Ni.LOAD,h.stencilStoreOp=Li.DISCARD,h.beginAccesses=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE],h.endAccesses=[Bi.DEPTH_STENCIL_ATTACHMENT_WRITE];var f=new Fr([u],h);this._lightingRenderPass=t.createRenderPass(f)}return this._width=e.width,this._height=e.height,this._generateDeferredRenderData(),!0},n._destroyUBOs=function(){this._descriptorSet&&(this._descriptorSet.getBuffer($p.BINDING).destroy(),this._descriptorSet.getBuffer(td.BINDING).destroy(),this._descriptorSet.getBuffer(ed.BINDING).destroy(),this._descriptorSet.getTexture(nd).destroy(),this._descriptorSet.getTexture(hd).destroy())},n._destroyDeferredData=function(){var e=this._pipelineRenderData;if(e){e.gbufferFrameBuffer&&e.gbufferFrameBuffer.destroy(),e.outputFrameBuffer&&e.outputFrameBuffer.destroy(),e.outputDepth&&e.outputDepth.destroy();for(var t=0;t<e.gbufferRenderTargets.length;t++)e.gbufferRenderTargets[t].destroy();e.gbufferRenderTargets.length=0;for(var n=0;n<e.outputRenderTargets.length;n++)e.outputRenderTargets[n].destroy();e.outputRenderTargets.length=0,this._destroyBloomData()}this._pipelineRenderData=null},n._ensureEnoughSize=function(e){for(var t=this._width,n=this._height,i=0;i<e.length;++i){var r=e[i].window;t=Math.max(r.width,t),n=Math.max(r.height,n)}t===this._width&&n===this._height||(this._width=t,this._height=n,this._destroyDeferredData(),this._generateDeferredRenderData())},n._generateDeferredRenderData=function(){for(var e=this,t=this.device,n=this._pipelineRenderData=new AM,i=this.pipelineSceneData,r=0;r<3;++r)n.gbufferRenderTargets.push(t.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,pi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale)));n.outputDepth=t.createTexture(new gr(Si.TEX2D,Ti.DEPTH_STENCIL_ATTACHMENT|Ti.SAMPLED,pi.DEPTH_STENCIL,this._width*i.shadingScale,this._height*i.shadingScale)),n.gbufferFrameBuffer=t.createFramebuffer(new kr(this._gbufferRenderPass,n.gbufferRenderTargets,n.outputDepth)),n.outputRenderTargets.push(t.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED,pi.RGBA16F,this._width*i.shadingScale,this._height*i.shadingScale))),n.outputFrameBuffer=t.createFramebuffer(new kr(this._lightingRenderPass,n.outputRenderTargets,null)),this.on(Vy.ATTACHMENT_SCALE_CAHNGED,(function(t){n.sampler=t<1?e.globalDSManager.pointSampler:e.globalDSManager.linearSampler,e.applyFramebufferRatio(n.gbufferFrameBuffer),e.applyFramebufferRatio(n.outputFrameBuffer)})),n.sampler=this.globalDSManager.linearSampler},t}(hx),TM=le((SM=bM).prototype,"renderTextures",[gM,Tc,yM],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),xM=SM))||xM));function PM(){var e=new QO;return e.initialize({flows:[]}),e}var RM=new Kn,IM=function(){var e=t.prototype;function t(){this.handle=0,this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.isPause=!1,this._splashFinish=!1,this._loadFinish=!1,this._directCall=!1}return e.pauseRendering=function(){this.isPause=!0},e.resumeRendering=function(){this.isPause=!1},e.main=function(e){if(null!=e){if(window._CCSettings&&window._CCSettings.splashScreen){var t=this.settings=window._CCSettings.splashScreen;t.totalTime=null!=this.settings.totalTime?this.settings.totalTime:3e3,t.base64src=this.settings.base64src||"",t.effect=this.settings.effect||"FADE-INOUT",t.clearColor=this.settings.clearColor||new lr(.88,.88,.88,1),t.displayRatio=null!=this.settings.displayRatio?this.settings.displayRatio:.4,t.displayWatermark=null==this.settings.displayWatermark||this.settings.displayWatermark}else this.settings={totalTime:3e3,base64src:"",effect:"FADE-INOUT",clearColor:new lr(.88,.88,.88,1),displayRatio:.4,displayWatermark:!0};if(""===this.settings.base64src||this.settings.totalTime<=0)this.callBack&&this.callBack(),this.callBack=null,this.settings=null,this._directCall=!0;else{u.view.resizeWithBrowserSize(!0);var n=window._CCSettings.designResolution;n?u.view.setDesignResolutionSize(n.width,n.height,n.policy):u.view.setDesignResolutionSize(960,640,4),this.device=e.device,this.swapchain=e.mainWindow.swapchain,this.framebuffer=e.mainWindow.framebuffer,u.game.once(u.Game.EVENT_GAME_INITED,(function(){u.director._lateUpdate=performance.now()}),u.director),this.callBack=null,this.cancelAnimate=!1,this.startTime=-1,this.preInit(),this.logoImage=new Image,this.logoImage.onload=this.init.bind(this),this.logoImage.src=this.settings.base64src}}else T("RENDER ROOT IS NULL.")},e.setOnFinish=function(e){if(this._directCall&&e)return t._ins=void 0,void e();this.callBack=e},e._tryToStart=function(){this._splashFinish&&this._loadFinish&&this.callBack&&(this.callBack(),this.hide(),u.game.resume())},e.preInit=function(){var e=this.settings.clearColor;this.clearColors=[new lr(e.x,e.y,e.z,e.w)];var t=this.device,n=this.swapchain;this.renderArea=new tr(0,0,n.width,n.height),this.cmdBuff=t.commandBuffer;var i=new Float32Array([.5,.5,1,0,-.5,.5,0,0,.5,-.5,1,1,-.5,-.5,0,1]),r=4*Float32Array.BYTES_PER_ELEMENT,o=4*r;this.vertexBuffers=t.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,o,r)),this.vertexBuffers.update(i);var a=new Uint16Array([0,1,2,1,3,2]),s=Uint16Array.BYTES_PER_ELEMENT,c=6*s;this.indicesBuffers=t.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,c,s)),this.indicesBuffers.update(a);var l=[new Ir("a_position",pi.RG32F),new Ir("a_texCoord",pi.RG32F)],u=new Or(l,[this.vertexBuffers],this.indicesBuffers);this.quadAssmebler=t.createInputAssembler(u),this.projection=new jn,jn.ortho(this.projection,-1,1,-1,1,-1,1,t.capabilities.clipSpaceMinZ,t.capabilities.clipSpaceSignY,n.surfaceTransform)},e.init=function(){var e=this;this.initLogo(),this.settings.displayWatermark&&this.initWarterMark(),u.game.pause(),this.handle=requestAnimationFrame((function t(n){if(!e.cancelAnimate){var i=e.settings,r=e.device,o=e.swapchain;jn.ortho(e.projection,-1,1,-1,1,-1,1,r.capabilities.clipSpaceMinZ,r.capabilities.clipSpaceSignY,o.surfaceTransform);var a=o.width,s=o.height,c=a<s?a:s;e.startTime<0&&(e.startTime=n);var l=n-e.startTime,u=mf(un(l/i.totalTime));"NONE"===i.effect&&(u=1);var h=e.logoTexture.width,f=e.logoTexture.height,_=c*i.displayRatio,p=_*h/f,d=_;if(o.surfaceTransform!==fi.ROTATE_90&&o.surfaceTransform!==fi.ROTATE_270||(p=_*a/s,d=_*f/h*s/a),e.logoMat.setProperty("resolution",RM.set(a,s),0),e.logoMat.setProperty("scale",RM.set(p,d),0),e.logoMat.setProperty("translate",RM.set(.5*a,.5*s),0),e.logoMat.setProperty("percent",u),e.logoMat.setProperty("u_projection",e.projection),e.logoMat.passes[0].update(),i.displayWatermark&&e.watermarkMat){var m=.5*c,v=e.watermarkTexture.width,g=m,y=m*e.watermarkTexture.height/v;o.surfaceTransform!==fi.ROTATE_90&&o.surfaceTransform!==fi.ROTATE_270||(g=.5*m,y=m*a/s*.5),e.watermarkMat.setProperty("resolution",RM.set(a,s),0),e.watermarkMat.setProperty("scale",RM.set(g,y),0),e.watermarkMat.setProperty("translate",RM.set(.5*a,.1*s),0),e.watermarkMat.setProperty("percent",u),e.watermarkMat.setProperty("u_projection",e.projection),e.watermarkMat.passes[0].update()}e.isPause||(e.frame(),l>i.totalTime&&(e.splashFinish=!0)),requestAnimationFrame(t)}}))},e.hide=function(){cancelAnimationFrame(this.handle),this.cancelAnimate=!0,setTimeout(this.destroy.bind(this))},e.initLogo=function(){var e=this.device;this.logoMat=new ug,this.logoMat.initialize({effectName:"splash-screen"});var t=new xr;t.addressU=wi.CLAMP,t.addressV=wi.CLAMP,t.addressW=wi.CLAMP,this.sampler=e.getSampler(t),this.logoTexture=e.createTexture(new gr(Si.TEX2D,Ti.SAMPLED|Ti.TRANSFER_DST,pi.RGBA8,this.logoImage.width,this.logoImage.height));var n=this.logoMat.passes[0],i=n.getBinding("mainTexture");n.bindTexture(i,this.logoTexture),this.shader=n.getShaderVariant();var r=n.descriptorSet;r.bindSampler(i,this.sampler),r.update();var o=new sr;o.texExtent.width=this.logoImage.width,o.texExtent.height=this.logoImage.height,o.texExtent.depth=1,e.copyTexImagesToTexture([this.logoImage],this.logoTexture,[o])},e.initWarterMark=function(){var e=document.createElement("canvas");e.width=330,e.height=30,e.style.width=""+e.width,e.style.height=""+e.height;var t=e.getContext("2d");t.font="18px Arial",t.textBaseline="top",t.textAlign="left",t.fillStyle="`#424242`";var n="Powered by Cocos Creator",i=t.measureText(n);t.fillText(n,(330-i.width)/2,6);var r=new sr;r.texExtent.width=e.width,r.texExtent.height=e.height,r.texExtent.depth=1,this.watermarkTexture=this.device.createTexture(new gr(Si.TEX2D,Ti.SAMPLED|Ti.TRANSFER_DST,pi.RGBA8,e.width,e.height)),this.device.copyTexImagesToTexture([e],this.watermarkTexture,[r]),this.watermarkMat=new ug,this.watermarkMat.initialize({effectName:"splash-screen"});var o=this.watermarkMat.passes[0],a=o.getBinding("mainTexture");o.bindTexture(a,this.watermarkTexture),o.descriptorSet.update()},e.frame=function(){var e=this.device,t=this.swapchain;e.acquire([t]);var n=this.cmdBuff,i=this.framebuffer,r=this.renderArea;r.width=t.width,r.height=t.height,n.begin(),n.beginRenderPass(i.renderPass,i,r,this.clearColors,1,0);var o=this.logoMat.passes[0],a=Hv.getOrCreatePipelineState(e,o,this.shader,i.renderPass,this.quadAssmebler);if(n.bindPipelineState(a),n.bindDescriptorSet(Kp.MATERIAL,o.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler),this.settings.displayWatermark&&this.watermarkMat){var s=this.watermarkMat.passes[0],c=Hv.getOrCreatePipelineState(e,s,this.shader,i.renderPass,this.quadAssmebler);n.bindPipelineState(c),n.bindDescriptorSet(Kp.MATERIAL,s.descriptorSet),n.bindInputAssembler(this.quadAssmebler),n.draw(this.quadAssmebler)}n.endRenderPass(),n.end(),e.flushCommands([n]),e.queue.submit([n]),e.present()},e.destroy=function(){this.callBack=null,this.device=null,this.swapchain=null,this.clearColors=null,this.logoImage.destroy&&this.logoImage.destroy(),this.logoImage=null,this.framebuffer=null,this.renderArea=null,this.cmdBuff=null,this.shader=null,this.logoMat.destroy(),this.logoMat=null,this.logoTexture.destroy(),this.logoTexture=null,this.quadAssmebler.destroy(),this.quadAssmebler=null,this.vertexBuffers.destroy(),this.vertexBuffers=null,this.indicesBuffers.destroy(),this.indicesBuffers=null,this.sampler=null,this.watermarkTexture&&(this.watermarkMat.destroy(),this.watermarkMat=null,this.watermarkTexture.destroy(),this.watermarkTexture=null),this.settings=null,t._ins=void 0},Z(t,[{key:"splashFinish",set:function(e){this._splashFinish=e,this._tryToStart()}},{key:"loadFinish",set:function(e){this._loadFinish=e,this._tryToStart()}}],[{key:"instance",get:function(){return t._ins||(t._ins=new t),t._ins}}]),t}();IM._ins=void 0,u.internal.SplashScreen=IM;var DM=e("System",function(){function e(){this._id="",this._priority=0,this._executeInEditMode=!1}e.sortByPriority=function(e,t){return e._priority<t._priority?1:e._priority>t.priority?-1:0};var t=e.prototype;return t.init=function(){},t.update=function(){},t.postUpdate=function(){},Z(e,[{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e}},{key:"id",get:function(){return this._id},set:function(e){this._id=e}}]),e}());DM.Priority=st({LOW:0,MEDIUM:100,HIGH:200,SCHEDULER:1<<31>>>0});var OM=new ve("Scheduler"),MM=function(e,t,n,i){this.target=void 0,this.priority=void 0,this.paused=void 0,this.markedForDeletion=void 0,this.target=e,this.priority=t,this.paused=n,this.markedForDeletion=i};MM.get=function(e,t,n,i){var r=MM._listEntries.pop();return r?(r.target=e,r.priority=t,r.paused=n,r.markedForDeletion=i):r=new MM(e,t,n,i),r},MM.put=function(e){MM._listEntries.length<20&&(e.target=null,MM._listEntries.push(e))},MM._listEntries=[];var NM=function(e,t,n,i){this.list=void 0,this.entry=void 0,this.target=void 0,this.callback=void 0,this.list=e,this.entry=t,this.target=n,this.callback=i};NM.get=function(e,t,n,i){var r=NM._hashUpdateEntries.pop();return r?(r.list=e,r.entry=t,r.target=n,r.callback=i):r=new NM(e,t,n,i),r},NM.put=function(e){NM._hashUpdateEntries.length<20&&(e.list=e.entry=e.target=e.callback=null,NM._hashUpdateEntries.push(e))},NM._hashUpdateEntries=[];var LM=function(e,t,n,i,r,o){this.timers=void 0,this.target=void 0,this.timerIndex=void 0,this.currentTimer=void 0,this.currentTimerSalvaged=void 0,this.paused=void 0,this.timers=e,this.target=t,this.timerIndex=n,this.currentTimer=i,this.currentTimerSalvaged=r,this.paused=o};LM.get=function(e,t,n,i,r,o){var a=LM._hashTimerEntries.pop();return a?(a.timers=e,a.target=t,a.timerIndex=n,a.currentTimer=i,a.currentTimerSalvaged=r,a.paused=o):a=new LM(e,t,n,i,r,o),a},LM.put=function(e){LM._hashTimerEntries.length<20&&(e.timers=e.target=e.currentTimer=null,LM._hashTimerEntries.push(e))},LM._hashTimerEntries=[];var BM=function(){function e(){this._lock=void 0,this._scheduler=void 0,this._elapsed=void 0,this._runForever=void 0,this._useDelay=void 0,this._timesExecuted=void 0,this._repeat=void 0,this._delay=void 0,this._interval=void 0,this._target=void 0,this._callback=void 0,this._lock=!1,this._scheduler=null,this._elapsed=-1,this._runForever=!1,this._useDelay=!1,this._timesExecuted=0,this._repeat=0,this._delay=0,this._interval=0,this._target=null,this._callback=null}var t=e.prototype;return t.initWithCallback=function(e,t,n,i,r,o){return this._lock=!1,this._scheduler=e,this._target=n,this._callback=t,this._elapsed=-1,this._interval=i,this._delay=o,this._useDelay=this._delay>0,this._repeat=r,this._runForever=this._repeat===u.macro.REPEAT_FOREVER,!0},t.getInterval=function(){return this._interval},t.setInterval=function(e){this._interval=e},t.update=function(e){-1===this._elapsed?(this._elapsed=0,this._timesExecuted=0):(this._elapsed+=e,this._runForever&&!this._useDelay?this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0):(this._useDelay?this._elapsed>=this._delay&&(this.trigger(),this._elapsed-=this._delay,this._timesExecuted+=1,this._useDelay=!1):this._elapsed>=this._interval&&(this.trigger(),this._elapsed=0,this._timesExecuted+=1),this._callback&&!this._runForever&&this._timesExecuted>this._repeat&&this.cancel()))},t.getCallback=function(){return this._callback},t.trigger=function(){this._target&&this._callback&&(this._lock=!0,this._callback.call(this._target,this._elapsed),this._lock=!1)},t.cancel=function(){this._scheduler.unschedule(this._callback,this._target)},e}();BM._timers=[],BM.get=function(){return BM._timers.pop()||new BM},BM.put=function(e){BM._timers.length<20&&!e._lock&&(e._scheduler=e._target=e._callback=null,BM._timers.push(e))};var FM,zM=e("Scheduler",function(e){function t(){var t;return(t=e.call(this)||this)._timeScale=void 0,t._updatesNegList=void 0,t._updates0List=void 0,t._updatesPosList=void 0,t._hashForUpdates=void 0,t._hashForTimers=void 0,t._currentTarget=void 0,t._currentTargetSalvaged=void 0,t._updateHashLocked=void 0,t._arrayForTimers=void 0,t._timeScale=1,t._updatesNegList=[],t._updates0List=[],t._updatesPosList=[],t._hashForUpdates=Re(!0),t._hashForTimers=Re(!0),t._currentTarget=null,t._currentTargetSalvaged=!1,t._updateHashLocked=!1,t._arrayForTimers=[],t}$(t,e),t.enableForTarget=function(e){var t=!1;(e.uuid||e.id)&&(t=!0),t||(e.__instanceId?D(1513):e.id=OM.getNewId())};var n=t.prototype;return n.setTimeScale=function(e){this._timeScale=e},n.getTimeScale=function(){return this._timeScale},n.update=function(e){var t,n,i,r,o;for(this._updateHashLocked=!0,1!==this._timeScale&&(e*=this._timeScale),t=0,i=(n=this._updatesNegList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updates0List).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);for(t=0,i=(n=this._updatesPosList).length;t<i;t++)(r=n[t]).paused||r.markedForDeletion||r.target.update(e);var a=this._arrayForTimers;for(t=0;t<a.length;t++){if(o=a[t],this._currentTarget=o,this._currentTargetSalvaged=!1,!o.paused)for(o.timerIndex=0;o.timerIndex<o.timers.length;++o.timerIndex)o.currentTimer=o.timers[o.timerIndex],o.currentTimerSalvaged=!1,o.currentTimer.update(e),o.currentTimer=null;this._currentTargetSalvaged&&0===this._currentTarget.timers.length&&(this._removeHashElement(this._currentTarget),--t)}for(t=0,n=this._updatesNegList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updates0List;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;for(t=0,n=this._updatesPosList;t<n.length;)(r=n[t]).markedForDeletion?this._removeUpdateFromHash(r):t++;this._updateHashLocked=!1,this._currentTarget=null},n.schedule=function(e,t,n,i,r,o){if("function"!=typeof e){var a=e;e=t,t=a}3!==arguments.length&&4!==arguments.length&&5!==arguments.length||(o=!!i,i=u.macro.REPEAT_FOREVER,r=0),B(t,1502);var s=t.uuid||t.id;if(s){var c,l,h=this._hashForTimers[s];if(h?h.paused!==o&&D(1511):(h=LM.get(null,t,0,null,null,o),this._arrayForTimers.push(h),this._hashForTimers[s]=h),null==h.timers)h.timers=[];else for(l=0;l<h.timers.length;++l)if((c=h.timers[l])&&e===c._callback)return R(1507,c.getInterval(),n),void(c._interval=n);(c=BM.get()).initWithCallback(this,e,t,n,i,r),h.timers.push(c),this._currentTarget===h&&this._currentTargetSalvaged&&(this._currentTargetSalvaged=!1)}else M(1510)},n.scheduleUpdate=function(e,t,n){var i=e.uuid||e.id;if(i){var r=this._hashForUpdates[i];if(r&&r.entry){if(r.entry.priority===t)return r.entry.markedForDeletion=!1,void(r.entry.paused=n);if(this._updateHashLocked)return R(1506),r.entry.markedForDeletion=!1,void(r.entry.paused=n);this.unscheduleUpdate(e)}var o,a=MM.get(e,t,n,!1);0===t?(o=this._updates0List,this._appendIn(o,a)):(o=t<0?this._updatesNegList:this._updatesPosList,this._priorityIn(o,a,t)),this._hashForUpdates[i]=NM.get(o,a,e,null)}else M(1510)},n.unschedule=function(e,t){if(t&&e){var n=t.uuid||t.id;if(n){var i=this._hashForTimers[n];if(i)for(var r=i.timers,o=0,a=r.length;o<a;o++){var s=r[o];if(e===s._callback)return s!==i.currentTimer||i.currentTimerSalvaged||(i.currentTimerSalvaged=!0),r.splice(o,1),BM.put(s),i.timerIndex>=o&&i.timerIndex--,void(0===r.length&&(this._currentTarget===i?this._currentTargetSalvaged=!0:this._removeHashElement(i)))}}else M(1510)}},n.unscheduleUpdate=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForUpdates[t];n&&(this._updateHashLocked?n.entry.markedForDeletion=!0:this._removeUpdateFromHash(n.entry))}else M(1510)}},n.unscheduleAllForTarget=function(e){if(e){var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];if(n){var i=n.timers;i.indexOf(n.currentTimer)>-1&&!n.currentTimerSalvaged&&(n.currentTimerSalvaged=!0);for(var r=0,o=i.length;r<o;r++)BM.put(i[r]);i.length=0,this._currentTarget===n?this._currentTargetSalvaged=!0:this._removeHashElement(n)}this.unscheduleUpdate(e)}else M(1510)}},n.unscheduleAll=function(){this.unscheduleAllWithMinPriority(DM.Priority.SCHEDULER)},n.unscheduleAllWithMinPriority=function(e){var t,n,i,r=this._arrayForTimers;for(t=r.length-1;t>=0;t--)n=r[t],this.unscheduleAllForTarget(n.target);var o=0;if(e<0)for(t=0;t<this._updatesNegList.length;)o=this._updatesNegList.length,(i=this._updatesNegList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesNegList.length&&t++;if(e<=0)for(t=0;t<this._updates0List.length;)o=this._updates0List.length,(i=this._updates0List[t])&&this.unscheduleUpdate(i.target),o===this._updates0List.length&&t++;for(t=0;t<this._updatesPosList.length;)o=this._updatesPosList.length,(i=this._updatesPosList[t])&&i.priority>=e&&this.unscheduleUpdate(i.target),o===this._updatesPosList.length&&t++},n.isScheduled=function(e,t){B(e,1508),B(t,1509);var n=t.uuid||t.id;if(!n)return M(1510),!1;var i=this._hashForTimers[n];if(!i)return!1;if(null==i.timers)return!1;for(var r=i.timers,o=0;o<r.length;++o)if(e===r[o]._callback)return!0;return!1},n.pauseAllTargets=function(){return this.pauseAllTargetsWithMinPriority(DM.Priority.SCHEDULER)},n.pauseAllTargetsWithMinPriority=function(e){var t,n,i,r,o=[],a=this._arrayForTimers;for(n=0,i=a.length;n<i;n++)(t=a[n])&&(t.paused=!0,o.push(t.target));if(e<0)for(n=0;n<this._updatesNegList.length;n++)(r=this._updatesNegList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));if(e<=0)for(n=0;n<this._updates0List.length;n++)(r=this._updates0List[n])&&(r.paused=!0,o.push(r.target));for(n=0;n<this._updatesPosList.length;n++)(r=this._updatesPosList[n])&&r.priority>=e&&(r.paused=!0,o.push(r.target));return o},n.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)this.resumeTarget(e[t])},n.pauseTarget=function(e){B(e,1503);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!0);var i=this._hashForUpdates[t];i&&(i.entry.paused=!0)}else M(1510)},n.resumeTarget=function(e){B(e,1504);var t=e.uuid||e.id;if(t){var n=this._hashForTimers[t];n&&(n.paused=!1);var i=this._hashForUpdates[t];i&&(i.entry.paused=!1)}else M(1510)},n.isTargetPaused=function(e){B(e,1505);var t=e.uuid||e.id;if(!t)return M(1510),!1;var n=this._hashForTimers[t];if(n)return n.paused;var i=this._hashForUpdates[t];return!!i&&i.entry.paused},n._removeHashElement=function(e){var t=e.target.uuid||e.target.id;delete this._hashForTimers[t];for(var n=this._arrayForTimers,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}LM.put(e)},n._removeUpdateFromHash=function(e){var t=e.target.uuid||e.target.id,n=this._hashForUpdates[t];if(n){for(var i=n.list,r=n.entry,o=0,a=i.length;o<a;o++)if(i[o]===r){i.splice(o,1);break}delete this._hashForUpdates[t],MM.put(r),NM.put(n)}},n._priorityIn=function(e,t,n){for(var i=0;i<e.length;i++)if(n<e[i].priority)return void e.splice(i,0,t);e.push(t)},n._appendIn=function(e,t){e.push(t)},t}(DM));zM.ID="scheduler",u.Scheduler=zM;var UM=((FM={})[ih.PORTRAIT]=fi.IDENTITY,FM[ih.LANDSCAPE_RIGHT]=fi.ROTATE_90,FM[ih.PORTRAIT_UPSIDE_DOWN]=fi.ROTATE_180,FM[ih.LANDSCAPE_LEFT]=fi.ROTATE_270,FM),kM=function(){function e(){this._title="",this._width=1,this._height=1,this._swapchain=null,this._renderPass=null,this._colorTextures=[],this._depthStencilTexture=null,this._cameras=[],this._hasOnScreenAttachments=!1,this._hasOffScreenAttachments=!1,this._framebuffer=null}e.registerCreateFunc=function(t){t._createWindowFun=function(t){return new e(t)}};var t=e.prototype;return t.initialize=function(e,t){if(this._init(),void 0!==t.title&&(this._title=t.title),void 0!==t.swapchain&&(this._swapchain=t.swapchain),this._width=t.width,this._height=t.height,this._renderPass=e.createRenderPass(t.renderPassInfo),t.swapchain)this._setSwapchain(t.swapchain),this._colorTextures.push(t.swapchain.colorTexture),this._depthStencilTexture=t.swapchain.depthStencilTexture;else{for(var n=0;n<t.renderPassInfo.colorAttachments.length;n++)this._colorTextures.push(e.createTexture(new gr(Si.TEX2D,Ti.COLOR_ATTACHMENT|Ti.SAMPLED|Ti.TRANSFER_SRC,t.renderPassInfo.colorAttachments[n].format,this._width,this._height)));t.renderPassInfo.depthStencilAttachment.format!==pi.UNKNOWN&&(this._depthStencilTexture=e.createTexture(new gr(Si.TEX2D,Ti.DEPTH_STENCIL_ATTACHMENT|Ti.SAMPLED,t.renderPassInfo.depthStencilAttachment.format,this._width,this._height)))}return this._setFrameBuffer(e.createFramebuffer(new kr(this._renderPass,this._colorTextures,this._depthStencilTexture))),!0},t.destroy=function(){this.clearCameras(),this._framebuffer&&(this._framebuffer.destroy(),this._framebuffer=null),this._depthStencilTexture&&(this._depthStencilTexture.destroy(),this._depthStencilTexture=null);for(var e=0;e<this._colorTextures.length;e++){var t=this._colorTextures[e];t&&t.destroy()}this._colorTextures.length=0,this._destroy()},t.resize=function(e,t){if(this._swapchain)this._swapchain.resize(e,t,UM[ch.orientation]),this._width=this._swapchain.width,this._height=this._swapchain.height;else{for(var n=0;n<this._colorTextures.length;n++)this._colorTextures[n].resize(e,t);this._depthStencilTexture&&this._depthStencilTexture.resize(e,t),this._width=e,this._height=t}this.framebuffer&&(this.framebuffer.destroy(),this.framebuffer.initialize(new kr(this._renderPass,this._colorTextures,this._depthStencilTexture)));for(var i,r=se(this._cameras);!(i=r()).done;)i.value.resize(e,t)},t.extractRenderCameras=function(e){for(var t=0;t<this._cameras.length;t++){var n=this._cameras[t];n.enabled&&(n.update(),e.push(n))}},t.attachCamera=function(e){for(var t=0;t<this._cameras.length;t++)if(this._cameras[t]===e)return;this._cameras.push(e),this.sortCameras()},t.detachCamera=function(e){for(var t=0;t<this._cameras.length;++t)if(this._cameras[t]===e)return void this._cameras.splice(t,1)},t.clearCameras=function(){this._cameras.length=0},t.sortCameras=function(){this._cameras.sort((function(e,t){return e.priority-t.priority}))},t._init=function(){},t._destroy=function(){},t._setSwapchain=function(e){this._swapchain=e},t._setFrameBuffer=function(e){this._framebuffer=e},Z(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}},{key:"swapchain",get:function(){return this._swapchain}},{key:"framebuffer",get:function(){return this._framebuffer}},{key:"cameras",get:function(){return this._cameras}},{key:"native",get:function(){return this._nativeObj}}]),e}(),GM=function(){var e=t.prototype;function t(e){var t=this;this._createSceneFun=null,this._createWindowFun=null,this._device=void 0,this._windows=[],this._mainWindow=null,this._curWindow=null,this._tempWindow=null,this._pipeline=null,this._batcher=null,this._dataPoolMgr=void 0,this._scenes=[],this._modelPools=new Map,this._cameraPool=null,this._lightPools=new Map,this._fpsTime=0,this._frameCount=0,this._fps=0,this._fixedFPS=0,this._useDeferredPipeline=!1,this._fixedFPSFrameTime=0,this._cumulativeTime=0,this._frameTime=0,this._device=e,this._dataPoolMgr=u.internal.DataPoolManager&&new u.internal.DataPoolManager(e),hT.registerCreateFunc(this),kM.registerCreateFunc(this),this._cameraPool=new ql((function(){return new yg(t._device)}),4,(function(e){return e.destroy()}))}return e._init=function(){},e._destroy=function(){},e._setCumulativeTime=function(e){this._cumulativeTime+=e},e._setFrameTime=function(e){this._frameTime=e},e.initialize=function(){this._init();var e=u.game._swapchain,t=new Mr;t.format=e.colorTexture.format;var n=new Nr;n.format=e.depthStencilTexture.format,n.depthStoreOp=Li.DISCARD,n.stencilStoreOp=Li.DISCARD;var i=new Fr([t],n);return this._mainWindow=this.createWindow({title:"rootMainWindow",width:e.width,height:e.height,renderPassInfo:i,swapchain:e}),this._curWindow=this._mainWindow,Promise.resolve(Nv.initBuiltinRes(this._device))},e.destroy=function(){this.destroyScenes(),this._pipeline&&(this._pipeline.destroy(),this._pipeline=null),this._batcher&&(this._batcher.destroy(),this._batcher=null),this._curWindow=null,this._mainWindow=null,this.dataPoolManager.clear(),this._destroy()},e.resize=function(e,t){for(var n,i=se(this._windows);!(n=i()).done;){var r=n.value;r.swapchain&&r.resize(e,t)}},e.setRenderPipeline=function(e){e instanceof wM&&(this._useDeferredPipeline=!0);var t=!1;if(e||(e=PM(),t=!0),this._pipeline=e,this._useDeferredPipeline&&this.device.hasFeature(_i.COMPUTE_SHADER)||(this._pipeline.clusterEnabled=!1),this._pipeline.bloomEnabled=!1,!this._pipeline.activate(this._mainWindow.swapchain))return t&&this._pipeline.destroy(),this._pipeline=null,!1;var n=u.director.getScene();return n&&n.globals.activate(),this.onGlobalPipelineStateChanged(),!(!this._batcher&&u.internal.Batcher2D&&(this._batcher=new u.internal.Batcher2D(this),!this._batcher.initialize())&&(this.destroy(),1))},e.onGlobalPipelineStateChanged=function(){for(var e=0;e<this._scenes.length;e++)this._scenes[e].onGlobalPipelineStateChanged();this._pipeline.pipelineSceneData.onGlobalPipelineStateChanged()},e.activeWindow=function(e){this._curWindow=e},e.resetCumulativeTime=function(){this._setCumulativeTime(0)},e.frameMove=function(e){this._setFrameTime(e),++this._frameCount,this._setCumulativeTime(e),this._fpsTime+=e,this._fpsTime>1&&(this._fps=this._frameCount,this._frameCount=0,this._fpsTime=0);for(var t=0;t<this._scenes.length;++t)this._scenes[t].removeBatches();for(var n=this._windows,i=[],r=0;r<n.length;r++)n[r].extractRenderCameras(i);if(this._pipeline&&i.length>0){this._device.acquire([u.game._swapchain]);var o=this._scenes,a=u.director.getTotalFrames();this._batcher&&(this._batcher.update(),this._batcher.uploadBuffers());for(var s=0;s<o.length;s++)o[s].update(a);u.director.emit(u.Director.EVENT_BEFORE_COMMIT),i.sort((function(e,t){return e.priority-t.priority})),this._pipeline.render(i),this._device.present()}this._batcher&&this._batcher.reset()},e.createWindow=function(e){var t=this._createWindowFun(this);return t.initialize(this.device,e),this._windows.push(t),t},e.destroyWindow=function(e){for(var t=0;t<this._windows.length;++t)if(this._windows[t]===e)return e.destroy(),void this._windows.splice(t,1)},e.destroyWindows=function(){for(var e,t=se(this._windows);!(e=t()).done;)e.value.destroy();this._windows.length=0},e.createScene=function(e){var t=this._createSceneFun(this);return t.initialize(e),this._scenes.push(t),t},e.destroyScene=function(e){for(var t=0;t<this._scenes.length;++t)if(this._scenes[t]===e)return e.destroy(),void this._scenes.splice(t,1)},e.destroyScenes=function(){for(var e,t=se(this._scenes);!(e=t()).done;)e.value.destroy();this._scenes.length=0},e.createModel=function(e){var t=this._modelPools.get(e);t||(this._modelPools.set(e,new ql((function(){return new e}),10,(function(e){return e.destroy()}))),t=this._modelPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyModel=function(e){var t=this._modelPools.get(e.constructor);t?(t.free(e),e.scene&&e.scene.removeModel(e)):D(1300,e.constructor.name),e.destroy()},e.createCamera=function(){return this._cameraPool.alloc()},e.createLight=function(e){var t=this._lightPools.get(e);t||(this._lightPools.set(e,new ql((function(){return new e}),4,(function(e){return e.destroy()}))),t=this._lightPools.get(e));var n=t.alloc();return n.initialize(),n},e.destroyLight=function(e){var t=this._lightPools.get(e.constructor);if(t&&(t.free(e),e.scene))switch(e.type){case ay.SPHERE:e.scene.removeSphereLight(e);break;case ay.SPOT:e.scene.removeSpotLight(e)}e.destroy()},Z(t,[{key:"device",get:function(){return this._device}},{key:"mainWindow",get:function(){return this._mainWindow}},{key:"curWindow",get:function(){return this._curWindow},set:function(e){this._curWindow=e}},{key:"tempWindow",get:function(){return this._tempWindow},set:function(e){this._tempWindow=e}},{key:"windows",get:function(){return this._windows}},{key:"pipeline",get:function(){return this._pipeline}},{key:"batcher2D",get:function(){return this._batcher}},{key:"scenes",get:function(){return this._scenes}},{key:"cumulativeTime",get:function(){return this._cumulativeTime}},{key:"frameTime",get:function(){return this._frameTime}},{key:"frameCount",get:function(){return this._frameCount}},{key:"fps",get:function(){return this._fps}},{key:"fixedFPS",get:function(){return this._fixedFPS},set:function(e){e>0?(this._fixedFPS=e,this._fixedFPSFrameTime=1e3/e):this._fixedFPSFrameTime=0}},{key:"dataPoolManager",get:function(){return this._dataPoolMgr}},{key:"useDeferredPipeline",get:function(){return this._useDeferredPipeline}}]),t}();u.Root=GM;var HM=e("Game",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).frame=null,t.container=null,t.canvas=null,t.renderType=-1,t.eventTargetOn=e.prototype.on,t.eventTargetOnce=e.prototype.once,t.config={},t.onStart=null,t.frameTime=1e3/60,t.collisionMatrix=[],t.groupList=[],t._persistRootNodes={},t._gfxDevice=null,t._swapchain=null,t._configLoaded=!1,t._isCloning=!1,t._inited=!1,t._engineInited=!1,t._rendererInitialized=!1,t._paused=!0,t._frameRate=60,t._intervalId=0,t._initTime=0,t._startTime=0,t._deltaTime=0,t._onEngineInitedCallback=[],t}$(t,e);var n=t.prototype;return n.setFrameRate=function(e){this.frameRate=e},n.getFrameRate=function(){return this.frameRate},n.step=function(){u.director.tick(this.frameTime/1e3)},n.pause=function(){this._paused||(this._paused=!0,this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0))},n.resume=function(){this._paused&&(fD._clearEvents(),this._intervalId&&(window.cAF(this._intervalId),this._intervalId=0),this._paused=!1,this._updateCallback(),this._intervalId=window.rAF(this._frameCB))},n.isPaused=function(){return this._paused},n.restart=function(){var e=this;return new Promise((function(e){return u.director.once(u.Director.EVENT_END_FRAME,(function(){return e()}))})).then((function(){for(var n in e._persistRootNodes)e.removePersistRootNode(e._persistRootNodes[n]);return u.director.getScene().destroy(),u.Object._deferredDestroy(),u.director.reset(),u.profiler.reset(),e.pause(),e._setRenderPipelineNShowSplash().then((function(){e.resume(),e._safeEmit(t.EVENT_RESTART)}))}))},n.end=function(){vu.close()},n.on=function(e,n,i,r){return(this._engineInited&&e===t.EVENT_ENGINE_INITED||this._inited&&e===t.EVENT_GAME_INITED||this._rendererInitialized&&e===t.EVENT_RENDERER_INITED)&&n.call(i),this.eventTargetOn(e,n,i,r)},n.once=function(e,n,i){return this._engineInited&&e===t.EVENT_ENGINE_INITED?n.call(i):this.eventTargetOnce(e,n,i)},n.init=function(e){var t=this;if(this._initConfig(e),uh._init({configOrientation:e.orientation||"auto",exactFitScreen:e.exactFitScreen}),this.config.assetOptions&&u.assetManager.init(this.config.assetOptions),this.config.layers)for(var n=this.config.layers,i=0;i<n.length;i++){var o=n[i],a=r(o.value);Fp.addLayer(o.name,a)}return this._initEngine().then((function(){return t._initEvents(),u.director.root&&u.director.root.dataPoolManager&&u.director.root.dataPoolManager.jointTexturePool.registerCustomTextureLayouts(e.customJointTextureLayouts),t._engineInited}))},n.run=function(e,t){var n,i=this;return"function"!=typeof e&&e?(n=this.init(e),this.onStart=null!=t?t:null):this.onStart=null!=e?e:null,hu.init(),Promise.resolve(n).then((function(){return i._setRenderPipelineNShowSplash()})).then((function(){}))},n.addPersistRootNode=function(e){if(u.Node.isNode(e)&&e.uuid){var t=e.uuid;if(!this._persistRootNodes[t]){var n=u.director._scene;if(u.isValid(n))if(e.parent){if(!(e.parent instanceof u.Scene))return void D(3801);if(e.parent!==n)return void D(3802);e._originalSceneId=n.uuid}else e.parent=n;this._persistRootNodes[t]=e,e._persistNode=!0,u.assetManager._releaseManager._addPersistNodeRef(e)}}else D(3800)},n.removePersistRootNode=function(e){var t=e.uuid||"";e===this._persistRootNodes[t]&&(delete this._persistRootNodes[t],e._persistNode=!1,e._originalSceneId="",u.assetManager._releaseManager._removePersistNodeRef(e))},n.isPersistRootNode=function(e){return!!e._persistNode},n.onEngineInitedAsync=function(e){this._onEngineInitedCallback.push(e)},n._initEngine=function(){var e=this;this._initDevice();var n=u.director;return Promise.resolve(n._init()).then((function(){u.view.init(),x("Cocos Creator v"+h),e.emit(t.EVENT_ENGINE_INITED),e._engineInited=!0,u.internal.dynamicAtlasManager&&(u.internal.dynamicAtlasManager.enabled=!ft.CLEANUP_IMAGE_CACHE)})).then((function(){var t=e._onEngineInitedCallback.map((function(e){return e()})).filter(Boolean);return e._onEngineInitedCallback.length=0,Promise.all(t)}))},n._setAnimFrame=function(){var e=this._frameRate,t=window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame;60!==e&&30!==e?(window.rAF=this._stTime.bind(this),window.cAF=this._ctTime):(window.rAF=t||this._stTime.bind(this),window.cAF=window.cancelAnimationFrame||window.cancelRequestAnimationFrame||window.msCancelRequestAnimationFrame||window.mozCancelRequestAnimationFrame||window.oCancelRequestAnimationFrame||window.webkitCancelRequestAnimationFrame||window.msCancelAnimationFrame||window.mozCancelAnimationFrame||window.webkitCancelAnimationFrame||window.ocancelAnimationFrame||this._ctTime,this._updateCallback())},n._stTime=function(e){var t=performance.now(),n=Math.max(0,t-this._startTime),i=Math.max(0,this.frameTime-n);return window.setTimeout(e,i)},n._ctTime=function(e){window.clearTimeout(e)},n._calculateDT=function(e){return e||(e=performance.now()),this._deltaTime=e>this._startTime?(e-this._startTime)/1e3:0,this._deltaTime>t.DEBUG_DT_THRESHOLD&&(this._deltaTime=this.frameTime/1e3),this._startTime=e,this._deltaTime},n._updateCallback=function(){var e,t=this,n=u.director;if(30===this._frameRate){var i=!0;e=function(e){t._intervalId=window.rAF(t._frameCB),(i=!i)||n.tick(t._calculateDT(e))}}else e=function(e){n.tick(t._calculateDT(e)),t._intervalId=window.rAF(t._frameCB)};this._frameCB=e},n._runMainLoop=function(){if(this._inited){var e=this.config,t=u.director;U(!!e.showFPS),t.startAnimation(),this.resume()}},n._initConfig=function(e){"number"!=typeof e.debugMode&&(e.debugMode=N.NONE),e.exposeClassName=!!e.exposeClassName,"number"!=typeof e.frameRate&&(e.frameRate=60);var t=e.renderMode;("number"!=typeof t||t>3||t<0)&&(e.renderMode=0),e.showFPS=!!e.showFPS,C(e.debugMode),this.config=e,this._configLoaded=!0,this.frameRate=e.frameRate},n._determineRenderType=function(){var e=this.config,n=parseInt(e.renderMode,10);this.renderType=t.RENDER_TYPE_CANVAS;var i=!1;if(1===n?(this.renderType=t.RENDER_TYPE_CANVAS,i=!0):0===n||2===n?(this.renderType=t.RENDER_TYPE_WEBGL,i=!0):3===n&&(this.renderType=t.RENDER_TYPE_HEADLESS,i=!0),!i)throw new Error(F(3820,n))},n._initDevice=function(){if(!this._rendererInitialized){var e=this.config.adapter;if(e&&(this.canvas=e.canvas,this.frame=e.frame,this.container=e.container),this._determineRenderType(),this.renderType===t.RENDER_TYPE_WEBGL){var n=new fr(Jp),i=!!window.WebGL2RenderingContext,r=window.navigator.userAgent.toLowerCase();(-1!==r.indexOf("safari")&&-1===r.indexOf("chrome")||hh.browserType===ou.UC)&&(i=!1);var o=[];i&&u.WebGL2Device&&o.push(u.WebGL2Device),u.WebGLDevice&&o.push(u.WebGLDevice),u.EmptyDevice&&o.push(u.EmptyDevice),po.canvas=this.canvas;for(var a=0;a<o.length&&(this._gfxDevice=new o[a],!this._gfxDevice.initialize(n));a++);}else this.renderType===t.RENDER_TYPE_HEADLESS&&u.EmptyDevice&&(this._gfxDevice=new u.EmptyDevice,this._gfxDevice.initialize(new fr(Jp)));if(!this._gfxDevice)return T("can not support canvas rendering in 3D"),void(this.renderType=t.RENDER_TYPE_CANVAS);var s=new hr(this.canvas),c=uh.windowSize;s.width=c.width,s.height=c.height,this._swapchain=this._gfxDevice.createSwapchain(s),this.canvas.oncontextmenu=function(){return!1}}},n._initEvents=function(){vu.on("show",this._onShow,this),vu.on("hide",this._onHide,this)},n._onHide=function(){this.emit(t.EVENT_HIDE),this.pause()},n._onShow=function(){this.emit(t.EVENT_SHOW),this.resume()},n._setRenderPipelineNShowSplash=function(){var e=this;return Promise.resolve(this._setupRenderPipeline()).then((function(){return Promise.resolve(e._showSplashScreen()).then((function(){e._inited=!0,e._initTime=performance.now(),e._runMainLoop(),e._safeEmit(t.EVENT_GAME_INITED),e.onStart&&e.onStart()}))}))},n._setupRenderPipeline=function(){var e=this,t=this.config.renderPipeline;return t?new Promise((function(e,n){u.assetManager.loadAny(t,(function(t,i){return!t&&i instanceof hx?e(i):n(t)}))})).then((function(t){e._setRenderPipeline(t)})).catch((function(n){S(n),S("Failed load render pipeline: "+t+", engine failed to initialize, will fallback to default pipeline"),e._setRenderPipeline()})):this._setRenderPipeline()},n._showSplashScreen=function(){if(u.internal.SplashScreen){var e=u.internal.SplashScreen.instance;return e.main(u.director.root),new Promise((function(t){e.setOnFinish((function(){return t()})),e.loadFinish=!0}))}return null},n._setRenderPipeline=function(e){u.director.root.setRenderPipeline(e)||this._setRenderPipeline(),this._rendererInitialized=!0,this._safeEmit(t.EVENT_RENDERER_INITED)},n._safeEmit=function(e){this.emit(e)},Z(t,[{key:"inited",get:function(){return this._inited}},{key:"frameRate",get:function(){return this._frameRate},set:function(e){"number"!=typeof e&&(e=parseInt(e,10),Number.isNaN(e)&&(e=60)),this._frameRate=e,this.frameTime=1e3/e,this._setAnimFrame()}},{key:"deltaTime",get:function(){return this._deltaTime}},{key:"totalTime",get:function(){return performance.now()-this._initTime}},{key:"frameStartTime",get:function(){return this._startTime}}]),t}(iu));HM.EVENT_HIDE="game_on_hide",HM.EVENT_SHOW="game_on_show",HM.EVENT_LOW_MEMORY="game_on_low_memory",HM.EVENT_GAME_INITED="game_inited",HM.EVENT_ENGINE_INITED="engine_inited",HM.EVENT_RENDERER_INITED="renderer_inited",HM.EVENT_RESTART="game_on_restart",HM.RENDER_TYPE_CANVAS=0,HM.RENDER_TYPE_WEBGL=1,HM.RENDER_TYPE_OPENGL=2,HM.RENDER_TYPE_HEADLESS=3,HM.DEBUG_DT_THRESHOLD=1,u.Game=HM;var VM=e("game",u.game=new HM),WM=e("Director",function(e){function t(){var t;return(t=e.call(this)||this)._compScheduler=void 0,t._nodeActivator=void 0,t._invalid=void 0,t._paused=void 0,t._root=void 0,t._loadingScene=void 0,t._scene=void 0,t._totalFrames=void 0,t._scheduler=void 0,t._systems=void 0,t._invalid=!1,t._paused=!1,t._root=null,t._loadingScene="",t._scene=null,t._totalFrames=0,t._scheduler=new zM,t._compScheduler=new UD,t._nodeActivator=new iO,t._systems=[],VM.once(HM.EVENT_RENDERER_INITED,t._initOnRendererInitialized,oe(t)),t}$(t,e);var n=t.prototype;return n.calculateDeltaTime=function(){},n.end=function(){var e=this;this.once(t.EVENT_END_FRAME,(function(){e.purgeDirector()}))},n.pause=function(){this._paused||(this._paused=!0)},n.purgeDirector=function(){this._scheduler.unscheduleAll(),this._compScheduler.unscheduleAll(),this._nodeActivator.reset(),u.isValid(this._scene)&&this._scene.destroy(),this._scene=null,this.stopAnimation(),u.assetManager.releaseAll()},n.reset=function(){this.purgeDirector(),this.emit(t.EVENT_RESET),this.startAnimation()},n.runSceneImmediate=function(e,t,n){e instanceof rO&&(e=e.scene),B(e instanceof bD,1216),e._load();for(var i=Object.keys(VM._persistRootNodes).map((function(e){return VM._persistRootNodes[e]})),r=0;r<i.length;r++){var o=i[r];o.emit(u.Node.SCENE_CHANGED_FOR_PERSISTS,e.renderScene);var a=e.uuid===o._originalSceneId&&e.getChildByUuid(o.uuid);if(a){var s=a.getSiblingIndex();a._destroyImmediate(),e.insertChild(o,s)}else o.parent=e}var c=this._scene;u.isValid(c)&&c.destroy(),u.assetManager._releaseManager._autoRelease(c,e,VM._persistRootNodes),this._scene=null,ml._deferredDestroy(),t&&t(),this.emit(u.Director.EVENT_BEFORE_SCENE_LAUNCH,e),this._scene=e,e._activate(),this._root&&this._root.resetCumulativeTime(),this.startAnimation(),n&&n(null,e),this.emit(u.Director.EVENT_AFTER_SCENE_LAUNCH,e)},n.runScene=function(e,t,n){var i=this;e instanceof rO&&(e=e.scene),B(e,1205),B(e instanceof bD,1216),e._load(),this.once(u.Director.EVENT_END_FRAME,(function(){i.runSceneImmediate(e,t,n)}))},n.loadScene=function(e,t,n){var i=this;if(this._loadingScene)return D(1208,e,this._loadingScene),!1;var r=u.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));return r?(this.emit(u.Director.EVENT_BEFORE_SCENE_LOADING,e),this._loadingScene=e,console.time("LoadScene "+e),r.loadScene(e,(function(r,o){console.timeEnd("LoadScene "+e),i._loadingScene="",r?(T(r),t&&t(r)):i.runSceneImmediate(o,n,t)})),!0):(M(1209,e),!1)},n.preloadScene=function(e,t,n){var i=u.assetManager.bundles.find((function(t){return!!t.getSceneInfo(e)}));if(i)i.preloadScene(e,null,t,n);else{var r='Can not preload the scene "'+e+'" because it is not in the build settings.';n&&n(new Error(r)),T("preloadScene: "+r)}},n.resume=function(){this._paused&&(this._paused=!1)},n.getScene=function(){return this._scene},n.getDeltaTime=function(){return VM.deltaTime},n.getTotalTime=function(){return VM.totalTime},n.getCurrentTime=function(){return VM.frameStartTime},n.getTotalFrames=function(){return this._totalFrames},n.isPaused=function(){return this._paused},n.getScheduler=function(){return this._scheduler},n.setScheduler=function(e){this._scheduler!==e&&(this.unregisterSystem(this._scheduler),this._scheduler=e,this.registerSystem(zM.ID,e,200))},n.registerSystem=function(e,t,n){t.id=e,t.priority=n,t.init(),this._systems.push(t),this._systems.sort(DM.sortByPriority)},n.unregisterSystem=function(e){it.fastRemove(this._systems,e),this._systems.sort(DM.sortByPriority)},n.getSystem=function(e){return this._systems.find((function(t){return t.id===e}))},n.getAnimationManager=function(){return this.getSystem(u.AnimationManager.ID)},n.startAnimation=function(){this._invalid=!1},n.stopAnimation=function(){this._invalid=!0},n.mainLoop=function(e){var t;t=VM._calculateDT(e),this.tick(t)},n.tick=function(e){if(!this._invalid){if(this.emit(t.EVENT_BEGIN_FRAME),fD._frameDispatchEvents(),!this._paused){this.emit(t.EVENT_BEFORE_UPDATE),this._compScheduler.startPhase(),this._compScheduler.updatePhase(e);for(var n=0;n<this._systems.length;++n)this._systems[n].update(e);this._compScheduler.lateUpdatePhase(e),this.emit(t.EVENT_AFTER_UPDATE),ml._deferredDestroy();for(var i=0;i<this._systems.length;++i)this._systems[i].postUpdate(e)}this.emit(t.EVENT_BEFORE_DRAW),this._root.frameMove(e),this.emit(t.EVENT_AFTER_DRAW),qC.resetHasChangedFlags(),qC.clearNodeArray(),Wl.update(e),this.emit(t.EVENT_END_FRAME),this._totalFrames++}},n._initOnRendererInitialized=function(){this._totalFrames=0,this._paused=!1,this.registerSystem(zM.ID,this._scheduler,200),this.emit(t.EVENT_INIT)},n._init=function(){return this._root=new GM(VM._gfxDevice),this._root.initialize({}).catch((function(e){return M(1217),Promise.reject(e)}))},Z(t,[{key:"root",get:function(){return this._root}}]),t}(iu));WM.EVENT_INIT="director_init",WM.EVENT_RESET="director_reset",WM.EVENT_BEFORE_SCENE_LOADING="director_before_scene_loading",WM.EVENT_BEFORE_SCENE_LAUNCH="director_before_scene_launch",WM.EVENT_AFTER_SCENE_LAUNCH="director_after_scene_launch",WM.EVENT_BEFORE_UPDATE="director_before_update",WM.EVENT_AFTER_UPDATE="director_after_update",WM.EVENT_BEFORE_DRAW="director_before_draw",WM.EVENT_AFTER_DRAW="director_after_draw",WM.EVENT_BEFORE_COMMIT="director_before_commit",WM.EVENT_BEFORE_PHYSICS="director_before_physics",WM.EVENT_AFTER_PHYSICS="director_after_physics",WM.EVENT_BEGIN_FRAME="director_begin_frame",WM.EVENT_END_FRAME="director_end_frame",WM.instance=void 0,u.Director=WM;var jM=e("director",WM.instance=u.director=new WM),qM={};k(qM,"vmath",[{name:"vec2",newName:"Vec2",target:ci,targetName:"math"},{name:"vec3",newName:"Vec3",target:ci,targetName:"math"},{name:"vec4",newName:"Vec4",target:ci,targetName:"math"},{name:"quat",newName:"Quat",target:ci,targetName:"math"},{name:"mat3",newName:"Mat3",target:ci,targetName:"math"},{name:"mat4",newName:"Mat4",target:ci,targetName:"math"},{name:"color4",newName:"Color",target:ci,targetName:"math"},{name:"rect",newName:"Rect",target:ci,targetName:"math"},{name:"approx",newName:"approx",target:ci,targetName:"math"},{name:"EPSILON",newName:"EPSILON",target:ci,targetName:"math"},{name:"equals",newName:"equals",target:ci,targetName:"math"},{name:"clamp",newName:"clamp",target:ci,targetName:"math"},{name:"clamp01",newName:"clamp01",target:ci,targetName:"math"},{name:"lerp",newName:"lerp",target:ci,targetName:"math"},{name:"toRadian",newName:"toRadian",target:ci,targetName:"math"},{name:"toDegree",newName:"toDegree",target:ci,targetName:"math"},{name:"random",newName:"random",target:ci,targetName:"math"},{name:"randomRange",newName:"randomRange",target:ci,targetName:"math"},{name:"randomRangeInt",newName:"randomRangeInt",target:ci,targetName:"math"},{name:"pseudoRandom",newName:"pseudoRandom",target:ci,targetName:"math"},{name:"pseudoRandomRangeInt",newName:"pseudoRandomRangeInt",target:ci,targetName:"math"},{name:"nextPow2",newName:"nextPow2",target:ci,targetName:"math"},{name:"repeat",newName:"repeat",target:ci,targetName:"math"},{name:"pingPong",newName:"pingPong",target:ci,targetName:"math"},{name:"inverseLerp",newName:"inverseLerp",target:ci,targetName:"math"}]),u.vmath=qM,k(zM.prototype,"Scheduler.prototype",[{name:"enableForTarget",newName:"enableForTarget",target:zM,targetName:"Scheduler"}]),k(zM,"Scheduler",[{name:"PRIORITY_SYSTEM",newName:"System.Priority.SCHEDULER",customGetter:function(){return DM.Priority.SCHEDULER}}]),G(zM,"Scheduler",[{name:"PRIORITY_NON_SYSTEM",suggest:"Use enum` System.Priority` instead"}]),k(oT.prototype,"SubModel.prototype",[{name:"subMeshData",newName:"subMesh"}]),G(oT.prototype,"SubModel.prototype",[{name:"getSubModel",suggest:"Use `subModels[i]` instead"},{name:"subModelNum",suggest:"Use `subModels.length` instead"}]),k(GM.prototype,"Root.prototype",[{name:"ui",newName:"batcher2D"}]),H(VM,"game",[{name:"collisionMatrix"},{name:"groupList"}]),H(WM.prototype,"director",[{name:"calculateDeltaTime"},{name:"getDeltaTime",suggest:"Use game.deltaTime instead"},{name:"getTotalTime",suggest:"Use game.totalTime instead"},{name:"getCurrentTime",suggest:"Use game.frameStartTime instead"}]),G(WM.prototype,"director",[{name:"setAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getAnimationInterval",suggest:"please use game.frameRate instead"},{name:"getRunningScene",suggest:"please use getScene instead"},{name:"setDepthTest",suggest:"please use camera API instead"},{name:"setClearColor",suggest:"please use camera API instead"},{name:"getWinSize",suggest:"please use view.getVisibleSize instead"},{name:"getWinSizeInPixels"},{name:"purgeCachedData",suggest:"please use assetManager.releaseAll instead"},{name:"convertToGL"},{name:"convertToUI"}]);var XM,YM={topLeft:u.v2(0,0),topRight:u.v2(0,0),top:u.v2(0,0),bottomLeft:u.v2(0,0),bottomRight:u.v2(0,0),bottom:u.v2(0,0),center:u.v2(0,0),left:u.v2(0,0),right:u.v2(0,0),width:0,height:0,init:function(e){var t=this.width=e.width,n=this.height=e.height,i=e.x,r=e.y,o=r+n,a=i+t;this.topLeft.x=i,this.topLeft.y=o,this.topRight.x=a,this.topRight.y=o,this.top.x=i+t/2,this.top.y=o,this.bottomLeft.x=i,this.bottomLeft.y=r,this.bottomRight.x=a,this.bottomRight.y=r,this.bottom.x=i+t/2,this.bottom.y=r,this.center.x=i+t/2,this.center.y=r+n/2,this.left.x=i,this.left.y=r+n/2,this.right.x=a,this.right.y=r+n/2}};u.visibleRect=YM;var KM=new ni,QM=((XM={})[ft.ORIENTATION_AUTO]=ih.AUTO,XM[ft.ORIENTATION_LANDSCAPE]=ih.LANDSCAPE,XM[ft.ORIENTATION_PORTRAIT]=ih.PORTRAIT,XM),ZM=e("View",function(e){function t(){var t;(t=e.call(this)||this)._designResolutionSize=void 0,t._scaleX=void 0,t._scaleY=void 0,t._viewportRect=void 0,t._visibleRect=void 0,t._autoFullScreen=void 0,t._retinaEnabled=void 0,t._resizeCallback=void 0,t._resolutionPolicy=void 0,t._rpExactFit=void 0,t._rpShowAll=void 0,t._rpNoBorder=void 0,t._rpFixedHeight=void 0,t._rpFixedWidth=void 0;var n=JM,i=$M;return t._designResolutionSize=new ni(0,0),t._scaleX=1,t._scaleY=1,t._viewportRect=new ri(0,0,0,0),t._visibleRect=new ri(0,0,0,0),t._autoFullScreen=!1,t._retinaEnabled=!1,t._resizeCallback=null,t._rpExactFit=new eN(n.EQUAL_TO_FRAME,i.EXACT_FIT),t._rpShowAll=new eN(n.EQUAL_TO_FRAME,i.SHOW_ALL),t._rpNoBorder=new eN(n.EQUAL_TO_FRAME,i.NO_BORDER),t._rpFixedHeight=new eN(n.EQUAL_TO_FRAME,i.FIXED_HEIGHT),t._rpFixedWidth=new eN(n.EQUAL_TO_FRAME,i.FIXED_WIDTH),t._resolutionPolicy=t._rpShowAll,t}$(t,e);var n=t.prototype;return n.init=function(){var e=uh.windowSize,t=e.width,n=e.height;this._designResolutionSize.width=t,this._designResolutionSize.height=n,this._viewportRect.width=t,this._viewportRect.height=n,this._visibleRect.width=t,this._visibleRect.height=n,KM.width=this._visibleRect.width,KM.height=this._visibleRect.height,YM&&YM.init(this._visibleRect),ch.on("window-resize",this._updateAdaptResult,this),ch.on("orientation-change",this._updateAdaptResult,this),ch.on("fullscreen-change",this._updateAdaptResult,this)},n.resizeWithBrowserSize=function(e){ch.handleResizeEvent=e},n.setResizeCallback=function(e){"function"!=typeof e&&null!=e||(this._resizeCallback=e)},n.setOrientation=function(e){ch.orientation=QM[e]},n.adjustViewportMeta=function(){},n.enableRetina=function(e){this._retinaEnabled=!!e},n.isRetinaEnabled=function(){return this._retinaEnabled},n.enableAutoFullScreen=function(e){e!==this._autoFullScreen&&(this._autoFullScreen=e,e&&uh.requestFullScreen().catch((function(){})))},n.isAutoFullScreenEnabled=function(){return this._autoFullScreen},n.setCanvasSize=function(e,t){ch.resolutionScale=1;var n=ch.devicePixelRatio,i=new ni(e*n,t*n);uh.windowSize=i},n.getCanvasSize=function(){return uh.windowSize},n.getFrameSize=function(){var e=ch.devicePixelRatio,t=uh.windowSize;return t.width/=e,t.height/=e,t},n.setFrameSize=function(e,t){var n=ch.devicePixelRatio;uh.windowSize=new ni(e*n,t*n)},n.getVisibleSize=function(){return new ni(this._visibleRect.width,this._visibleRect.height)},n.getVisibleSizeInPixel=function(){return new ni(this._visibleRect.width*this._scaleX,this._visibleRect.height*this._scaleY)},n.getVisibleOrigin=function(){return new Kn(this._visibleRect.x,this._visibleRect.y)},n.getVisibleOriginInPixel=function(){return new Kn(this._visibleRect.x*this._scaleX,this._visibleRect.y*this._scaleY)},n.getResolutionPolicy=function(){return this._resolutionPolicy},n._updateResolutionPolicy=function(e){if(e instanceof eN)this._resolutionPolicy=e;else{var t=eN;e===t.EXACT_FIT&&(this._resolutionPolicy=this._rpExactFit),e===t.SHOW_ALL&&(this._resolutionPolicy=this._rpShowAll),e===t.NO_BORDER&&(this._resolutionPolicy=this._rpNoBorder),e===t.FIXED_HEIGHT&&(this._resolutionPolicy=this._rpFixedHeight),e===t.FIXED_WIDTH&&(this._resolutionPolicy=this._rpFixedWidth)}},n.setResolutionPolicy=function(e){this._updateResolutionPolicy(e);var t=tN.getDesignResolutionSize();tN.setDesignResolutionSize(t.width,t.height,e)},n.setDesignResolutionSize=function(e,t,n){if(e>0&&t>0){this._updateResolutionPolicy(n);var i=this._resolutionPolicy;i&&i.preApply(this),this._designResolutionSize.width=e,this._designResolutionSize.height=t;var r=i.apply(this,this._designResolutionSize);if(r.scale&&2===r.scale.length&&(this._scaleX=r.scale[0],this._scaleY=r.scale[1]),r.viewport){var o=this._viewportRect,a=this._visibleRect,s=r.viewport;o.x=s.x,o.y=s.y,o.width=s.width,o.height=s.height,a.x=0,a.y=0,a.width=s.width/this._scaleX,a.height=s.height/this._scaleY}i.postApply(this),KM.width=this._visibleRect.width,KM.height=this._visibleRect.height,YM&&YM.init(this._visibleRect),this.emit("design-resolution-changed")}else M(2200)},n.getDesignResolutionSize=function(){return new ni(this._designResolutionSize.width,this._designResolutionSize.height)},n.setRealPixelResolution=function(e,t,n){document.documentElement.style.width=e+"px",document.body.style.width=e+"px",document.body.style.left="0px",document.body.style.top="0px",this.setDesignResolutionSize(e,t,n)},n.getViewportRect=function(){return this._viewportRect},n.getScaleX=function(){return this._scaleX},n.getScaleY=function(){return this._scaleY},n.getDevicePixelRatio=function(){return ch.devicePixelRatio},n.convertToLocationInView=function(e,t,n,i){void 0===i&&(i=new Kn);var r=ch.devicePixelRatio*(e-n.left),o=ch.devicePixelRatio*(n.top+n.height-t);return ch.isFrameRotated?(i.x=uh.windowSize.width-o,i.y=r):(i.x=r,i.y=o),i},n._convertToUISpace=function(e){var t=this._viewportRect;e.x=(e.x-t.x)/this._scaleX,e.y=(e.y-t.y)/this._scaleY},n._updateAdaptResult=function(){var e;u.director.root.resize(uh.windowSize.width,uh.windowSize.height);var t=this._designResolutionSize.width,n=this._designResolutionSize.height;t>0&&this.setDesignResolutionSize(t,n,this._resolutionPolicy),this.emit("canvas-resize"),null===(e=this._resizeCallback)||void 0===e||e.call(this)},t}(iu));ZM.instance=void 0;var JM=function(){function e(){this.name="ContainerStrategy"}var t=e.prototype;return t.preApply=function(){},t.apply=function(){},t.postApply=function(){},t._setupCanvas=function(){var e=VM.canvas;if(e){var t=uh.windowSize;e.width=t.width,e.height=t.height}},e}();JM.EQUAL_TO_FRAME=void 0,JM.PROPORTION_TO_FRAME=void 0;var $M=function(){function e(){this.name="ContentStrategy",this._result=void 0,this._result={scale:[1,1],viewport:null}}var t=e.prototype;return t.preApply=function(){},t.apply=function(){return{scale:[1,1]}},t.postApply=function(){},t._buildResult=function(e,t,n,i,r,o){Math.abs(e-n)<2&&(n=e),Math.abs(t-i)<2&&(i=t);var a=new ri(Math.round((e-n)/2),Math.round((t-i)/2),n,i);return this._result.scale=[r,o],this._result.viewport=a,this._result},e}();$M.EXACT_FIT=void 0,$M.SHOW_ALL=void 0,$M.NO_BORDER=void 0,$M.FIXED_HEIGHT=void 0,$M.FIXED_WIDTH=void 0,function(){var e=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="EqualToFrame",t}return $(t,e),t.prototype.apply=function(){ch.isProportionalToFrame=!1,this._setupCanvas()},t}(JM),t=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ProportionalToFrame",t}return $(t,e),t.prototype.apply=function(){ch.isProportionalToFrame=!0,this._setupCanvas()},t}(JM);JM.EQUAL_TO_FRAME=new e,JM.PROPORTION_TO_FRAME=new t;var n=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ExactFit",t}return $(t,e),t.prototype.apply=function(e,t){var n=uh.windowSize,i=n.width,r=n.height,o=i/t.width,a=r/t.height;return this._buildResult(i,r,i,r,o,a)},t}($M),i=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="ShowAll",t}return $(t,e),t.prototype.apply=function(e,t){var n,i,r=uh.windowSize,o=r.width,a=r.height,s=t.width,c=t.height,l=o/s,u=a/c,h=0;return l<u?(n=o,i=c*(h=l)):(n=s*(h=u),i=a),this._buildResult(o,a,n,i,h,h)},t}($M),r=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="NoBorder",t}return $(t,e),t.prototype.apply=function(e,t){var n,i,r,o=uh.windowSize,a=o.width,s=o.height,c=t.width,l=t.height,u=a/c,h=s/l;return u<h?(i=c*(n=h),r=s):(i=a,r=l*(n=u)),this._buildResult(a,s,i,r,n,n)},t}($M),o=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedHeight",t}return $(t,e),t.prototype.apply=function(e,t){var n=uh.windowSize,i=n.width,r=n.height,o=r/t.height,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}($M),a=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).name="FixedWidth",t}return $(t,e),t.prototype.apply=function(e,t){var n=uh.windowSize,i=n.width,r=n.height,o=i/t.width,a=i,s=r;return this._buildResult(i,r,a,s,o,o)},t}($M);$M.EXACT_FIT=new n,$M.SHOW_ALL=new i,$M.NO_BORDER=new r,$M.FIXED_HEIGHT=new o,$M.FIXED_WIDTH=new a}();var eN=e("ResolutionPolicy",function(){function e(e,t){this.name="ResolutionPolicy",this._containerStrategy=void 0,this._contentStrategy=void 0,this._containerStrategy=null,this._contentStrategy=null,this.setContainerStrategy(e),this.setContentStrategy(t)}var t=e.prototype;return t.preApply=function(e){this._contentStrategy.preApply(e)},t.apply=function(e,t){return this._containerStrategy.apply(e,t),this._contentStrategy.apply(e,t)},t.postApply=function(e){this._contentStrategy.postApply(e)},t.setContainerStrategy=function(e){e instanceof JM&&(this._containerStrategy=e)},t.setContentStrategy=function(e){e instanceof $M&&(this._contentStrategy=e)},Z(e,[{key:"canvasSize",get:function(){return uh.windowSize}}]),e}());eN.EXACT_FIT=0,eN.NO_BORDER=1,eN.SHOW_ALL=2,eN.FIXED_HEIGHT=3,eN.FIXED_WIDTH=4,eN.UNKNOWN=5,eN.ContainerStrategy=JM,eN.ContentStrategy=$M,u.ResolutionPolicy=eN;var tN=e("view",ZM.instance=u.view=new ZM);u.winSize=KM,G(ZM.prototype,"View.prototype",[{name:"isAntiAliasEnabled",suggest:"The API of Texture2d have been largely modified, no alternative"},{name:"enableAntiAlias",suggest:"The API of Texture2d have been largely modified, no alternative"}]),H(ZM.prototype,"View.prototype",[{name:"adjustViewportMeta"},{name:"enableAutoFullScreen",suggest:"use screen.requestFullScreen() instead."},{name:"isAutoFullScreenEnabled"},{name:"setCanvasSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getCanvasSize",suggest:"please use screen.windowSize instead."},{name:"getFrameSize",suggest:"getting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"setFrameSize",suggest:"setting size in CSS pixels is not recommended, please use screen.windowSize instead."},{name:"getDevicePixelRatio",suggest:"use screen.devicePixelRatio instead."},{name:"convertToLocationInView"},{name:"enableRetina"},{name:"isRetinaEnabled"}]),H(u,"cc",[{name:"winSize",suggest:"please use view.getVisibleSize() instead."}]),H(hh,"sys",[{name:"capabilities",suggest:"please use sys.hasFeature() method instead."}]),k(hh,"sys",["UNKNOWN","ENGLISH","CHINESE","FRENCH","ITALIAN","GERMAN","SPANISH","DUTCH","RUSSIAN","KOREAN","JAPANESE","HUNGARIAN","PORTUGUESE","ARABIC","NORWEGIAN","POLISH","TURKISH","UKRAINIAN","ROMANIAN","BULGARIAN"].map((function(e){return{name:"LANGUAGE_"+e,newName:e,target:hh.Language,targetName:"sys.Language"}}))),k(hh,"sys",["UNKNOWN","IOS","ANDROID","WINDOWS","LINUX","OSX"].map((function(e){return{name:"OS_"+e,newName:e,target:hh.OS,targetName:"sys.OS"}}))),k(hh,"sys",["UNKNOWN","WECHAT","ANDROID","IE","EDGE","QQ","MOBILE_QQ","UC","UCBS","BAIDU_APP","BAIDU","MAXTHON","OPERA","OUPENG","MIUI","FIREFOX","SAFARI","CHROME","LIEBAO","QZONE","SOUGOU","HUAWEI"].map((function(e){return{name:"BROWSER_TYPE_"+e,newName:e,target:hh.BrowserType,targetName:"sys.BrowserType"}}))),k(hh,"sys",[{name:"BROWSER_TYPE_360",newName:"BROWSER_360",target:hh.BrowserType,targetName:"sys.BrowserType"}]),k(hh,"sys",["UNKNOWN","EDITOR_PAGE","EDITOR_CORE","MOBILE_BROWSER","DESKTOP_BROWSER","WIN32","MACOS","IOS","ANDROID","OHOS","WECHAT_GAME","BAIDU_MINI_GAME","XIAOMI_QUICK_GAME","ALIPAY_MINI_GAME","BYTEDANCE_MINI_GAME","OPPO_MINI_GAME","VIVO_MINI_GAME","HUAWEI_QUICK_GAME","COCOSPLAY","LINKSURE_MINI_GAME","QTT_MINI_GAME"].map((function(e){return{name:e,target:hh.Platform,targetName:"sys.Platform"}}))),k(hh,"sys",[{name:"IPHONE",newName:"IOS",target:hh.Platform,targetName:"sys.Platform"},{name:"IPAD",newName:"IOS",target:hh.Platform,targetName:"sys.Platform"}]),G(hh,"sys",["LINUX","BLACKBERRY","NACL","EMSCRIPTEN","TIZEN","WINRT","WP8","QQ_PLAY","FB_PLAYABLE_ADS"].map((function(e){return{name:e}}))),k(hh,"sys",[{name:"windowPixelResolution",target:uh,targetName:"screen",newName:"windowSize"}]),H(uh,"screen",[{name:"autoFullScreen",suggest:"please use screen.requestFullScreen() instead."},{name:"disableAutoFullScreen"}]);var nN=function(){function e(){this.name="",this.base="",this.importBase="",this.nativeBase="",this.deps=null,this.assetInfos=new yl,this.scenes=new yl,this.paths=new yl}var t=e.prototype;return t.init=function(e){var t=this;!function(e){var t=e.uuids,n=e.paths,i=e.types,r=e.deps,o=e.paths=Object.create(null);if(!1===e.debug){for(var a=0,s=t.length;a<s;a++)t[a]=Bl(t[a]);for(var c in n){var l=n[c],u=l[1];l[1]=i[u]}}else{for(var h=Object.create(null),f=0,_=t.length;f<_;f++){var p=t[f];t[f]=h[p]=Bl(p)}t=h}for(var d in n){var m=n[d];o[t[d]]=m}var v=e.scenes;for(var g in v){var y=v[g];v[g]=t[y]}var x=e.packs;for(var S in x)for(var T=x[S],b=0;b<T.length;++b)T[b]=t[T[b]];var E=e.versions;if(E)for(var C in E)for(var A=E[C],w=0;w<A.length;w+=2){var P=A[w];A[w]=t[P]||P}var R=e.redirect;if(R)for(var I=0;I<R.length;I+=2)R[I]=t[R[I]],R[I+1]=r[R[I+1]];if(e.extensionMap){var D=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(i,r){e.extensionMap[n][r]=t[i]||i}))};for(var O in e.extensionMap)D(O)}}(e),this.importBase=e.importBase||"",this.nativeBase=e.nativeBase||"",this.base=e.base||"",this.name=e.name||"",this.deps=e.deps||[],this._initUuid(e.uuids),this._initPath(e.paths),this._initScene(e.scenes),this._initPackage(e.packs),this._initVersion(e.versions),this._initRedirect(e.redirect);var n=function(n){if(!Object.prototype.hasOwnProperty.call(e.extensionMap,n))return"continue";e.extensionMap[n].forEach((function(e){var i=t.assetInfos.get(e);i&&(i.extension=n)}))};for(var i in e.extensionMap)n(i)},t.getInfoWithPath=function(e,t){if(!e)return null;e=Gl(e);var n=this.paths.get(e);if(n){if(!t)return n[0];for(var i=0,r=n.length;i<r;i++){var o=n[i];if(rt.isChildClassOf(o.ctor,t))return o}}return null},t.getDirWithPath=function(e,t,n){"/"===(e=Gl(e))[e.length-1]&&(e=e.slice(0,-1));var i=n||[];return this.paths.forEach((function(n,r){if(r.startsWith(e)&&function(e,t){return!(e.length>t.length)||47===e.charCodeAt(t.length)}(r,e)||!e)for(var o=0,a=n.length;o<a;o++){var s=n[o];t&&!rt.isChildClassOf(s.ctor,t)||i.push(s)}})),i},t.getAssetInfo=function(e){return this.assetInfos.get(e)||null},t.getSceneInfo=function(e){return e.endsWith(".scene")||(e+=".scene"),"/"===e[0]||e.startsWith("db://")||(e="/"+e),this.scenes.find((function(t,n){return n.endsWith(e)}))},t.destroy=function(){this.paths.destroy(),this.scenes.destroy(),this.assetInfos.destroy()},t._initUuid=function(e){if(e){this.assetInfos.clear();for(var t=0,n=e.length;t<n;t++){var i=e[t];this.assetInfos.add(i,{uuid:i})}}},t._initPath=function(e){if(e){var t=this.paths;for(var n in t.clear(),e){var i=e[n],r=i[0],o=i[1],a=3===i.length,s=this.assetInfos.get(n);s.path=r,s.ctor=rt._getClassById(o),t.has(r)?a?t.get(r).push(s):t.get(r).unshift(s):t.add(r,[s])}}},t._initScene=function(e){if(e){var t=this.scenes;t.clear();var n=this.assetInfos;for(var i in e){var r=e[i],o=n.get(r);o.url=i,t.add(i,o)}}},t._initPackage=function(e){if(e){var t=this.assetInfos;for(var n in e){var i=e[n],r={uuid:n,packedUuids:i,ext:".json"};t.add(n,r);for(var o=0,a=i.length;o<a;o++){var s=i[o],c=t.get(s),l=c.packs;l?1===a?l.unshift(r):l.push(r):c.packs=[r]}}}},t._initVersion=function(e){if(e){var t=this.assetInfos,n=e.import;if(n)for(var i=0,r=n.length;i<r;i+=2){var o=n[i];t.get(o).ver=n[i+1]}if(n=e.native)for(var a=0,s=n.length;a<s;a+=2){var c=n[a];t.get(c).nativeVer=n[a+1]}}},t._initRedirect=function(e){if(e)for(var t=this.assetInfos,n=0,i=e.length;n<i;n+=2){var r=e[n];t.get(r).redirect=e[n+1]}},e}();function iN(e,t){e._uuid&&t.push(e._uuid)}function rN(e,t){for(var n=Object.getOwnPropertyNames(e),i=0;i<n.length;i++){var r=n[i];if("node"!==r&&"__eventTargets"!==r){var o=e[r];if("object"==typeof o&&o)if(Array.isArray(o))for(var a=0;a<o.length;a++){var s=o[a];s instanceof Nu&&iN(s,t)}else if(o.constructor&&o.constructor!==Object)o instanceof Nu&&iN(o,t);else for(var c=Object.getOwnPropertyNames(o),l=0;l<c.length;l++){var u=o[c[l]];u instanceof Nu&&iN(u,t)}}}}function oN(e,t){for(var n=0;n<e._components.length;n++)rN(e._components[n],t);for(var i=0;i<e._children.length;i++)oN(e._children[i],t)}function aN(e,t,n,i){n.push(e._uuid);for(var r=cv.getDeps(e._uuid),o=0,a=r.length;o<a;o++){var s=Tl.get(r[o]);if(s){var c=s._uuid;c in t?t[c]+=i:t[c]=s.refCount+i,n.includes(c)||aN(s,t,n,i)}}}var sN=[],cN=new(function(){function e(){this._persistNodeDeps=new yl,this._toDelete=new yl,this._eventListener=!1}var t=e.prototype;return t.init=function(){this._persistNodeDeps.clear(),this._toDelete.clear()},t._addPersistNodeRef=function(e){var t=[];oN(e,t);for(var n=0,i=t.length;n<i;n++){var r=Tl.get(t[n]);r&&r.addRef()}this._persistNodeDeps.add(e.uuid,t)},t._removePersistNodeRef=function(e){if(this._persistNodeDeps.has(e.uuid)){for(var t=this._persistNodeDeps.get(e.uuid),n=0,i=t.length;n<i;n++){var r=Tl.get(t[n]);r&&r.decRef()}this._persistNodeDeps.remove(e.uuid)}},t._autoRelease=function(e,t,n){if(e){for(var i=cv.getDeps(e.uuid),r=0,o=i.length;r<o;r++){var a=Tl.get(i[r]);a&&a.decRef(e.autoReleaseAssets)}var s=cv._depends.get(e.uuid);if(s&&s.persistDeps)for(var c=s.persistDeps,l=0,u=c.length;l<u;l++){var h=Tl.get(c[l]);h&&h.decRef(e.autoReleaseAssets)}e.uuid!==t.uuid&&cv.remove(e.uuid)}var f=cv._depends.get(t.uuid);for(var _ in f&&(f.persistDeps=[]),n){for(var p,d,m=n[_],v=this._persistNodeDeps.get(m.uuid),g=se(v);!(d=g()).done;){var y=d.value,x=Tl.get(y);x&&x.addRef()}f&&(p=f.persistDeps).push.apply(p,v)}},t.tryRelease=function(e,t){void 0===t&&(t=!1),e instanceof Nu&&(t?this._free(e,t):(this._toDelete.add(e._uuid,e),this._eventListener||(this._eventListener=!0,Tt(this._freeAssets.bind(this)))))},t._freeAssets=function(){var e=this;this._eventListener=!1,this._toDelete.forEach((function(t){e._free(t)})),this._toDelete.clear()},t._free=function(e,t){void 0===t&&(t=!1);var n=e._uuid;if(this._toDelete.remove(n),gl(e,!0)&&!(!t&&e.refCount>0&&function(e){var t=Object.create(null);if(t[e._uuid]=e.refCount,aN(e,t,sN,-1),sN.length=0,0!==t[e._uuid])return t[e._uuid];for(var n in t)0!==t[n]&&aN(Tl.get(n),t,sN,1);return sN.length=0,t[e._uuid]}(e)>0)){Tl.remove(n);for(var i=cv.getDeps(n),r=0,o=i.length;r<o;r++){var a=Tl.get(i[r]);a&&(a.decRef(!1),this._free(a,!1))}e.destroy(),cv.remove(n)}},e}()),lN=null;function uN(e,t){for(var n=0,i=e.input.length;n<i;n++){var r=e.input[n];t&&!r.isNative&&r.content instanceof Nu&&r.content.decRef(!1),r.recycle()}e.input=null}function hN(e,t){return t?/\?/.test(e)?e+"&_t="+Date.now():e+"?_t="+Date.now():e}function fN(e,t,n,i,r){void 0===r&&(r=0),e(r,(function(o,a){r++,!o||r>t?i&&i(o,a):setTimeout((function(){fN(e,t,n,i,r)}),n)}))}function _N(e,t,n,i,r){try{for(var o=cv.parse(e,t),a=0,s=o.deps.length;a<s;a++){var c=o.deps[a];c in n||(n[c]=!0,i.push({uuid:c,bundle:r&&r.name}))}o.nativeDep&&(r&&(o.nativeDep.bundle=r.name),i.push(J({},o.nativeDep)))}catch(e){T(e.message,e.stack)}}function pN(e,t,n){t&&(n=void 0!==n?n:u.assetManager.cacheAsset,kl(t)||!n||t.isDefault||Tl.add(e,t))}function dN(e,t,n){var i=0,r=[],o=e.length;0===o&&n&&n(r);for(var a=function(e){e&&r.push(e),++i===o&&n&&n(r)},s=0;s<o;s++)t(e[s],a)}function mN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a="function"==typeof e;t?(o=t,a||(r=null)):void 0===t&&a&&(o=e,i=null,r=null),void 0!==t&&a&&(r=e,i=null)}return{options:i||Object.create(null),onProgress:r,onComplete:o}}function vN(e,t,n){var i=e,r=t,o=n;if(void 0===n){var a=rt.isChildClassOf(e,Nu);t?(o=t,a&&(r=null)):void 0!==t||a||(o=e,r=null,i=null),void 0===t||a||(r=e,i=null)}return{type:i,onProgress:r||lN,onComplete:o}}function gN(e,t,n,i){if(void 0===i&&(i={}),!n[t]||i[t])return!1;i[t]=!0;var r=!1,o=cv.getDeps(t);if(o)for(var a=0,s=o.length;a<s;a++){var c=o[a];if(c===e||gN(e,c,n,i)){r=!0;break}}return r}function yN(e){return function(t,n){if(e){var i=[];Array.isArray(n)?n.forEach((function(e){return e instanceof Nu&&i.push(e.addRef())})):n instanceof Nu&&i.push(n.addRef()),Tt((function(){i.forEach((function(e){return e.decRef(!1)})),e(t,n)}))}}}var xN=function(){function e(){this._config=new nN}var t=e.prototype;return t.getInfoWithPath=function(e,t){return this._config.getInfoWithPath(e,t)},t.getDirWithPath=function(e,t,n){return this._config.getDirWithPath(e,t,n)},t.getAssetInfo=function(e){return this._config.getAssetInfo(e)},t.getSceneInfo=function(e){return this._config.getSceneInfo(e)},t.init=function(e){this._config.init(e),Cl.add(e.name,this)},t.load=function(e,t,n,i){var r=vN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c={__requestType__:Sl.PATH,type:o,bundle:this.name,__outputAsArray__:Array.isArray(e)};u.assetManager.loadAny(e,c,a,s)},t.preload=function(e,t,n,i){var r=vN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.preloadAny(e,{__requestType__:Sl.PATH,type:o,bundle:this.name},a,s)},t.loadDir=function(e,t,n,i){var r=vN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.loadAny(e,{__requestType__:Sl.DIR,type:o,bundle:this.name,__outputAsArray__:!0},a,s)},t.preloadDir=function(e,t,n,i){var r=vN(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;u.assetManager.preloadAny(e,{__requestType__:Sl.DIR,type:o,bundle:this.name},a,s)},t.loadScene=function(e,t,n,i){var r=mN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"scene",o.bundle=this.name,u.assetManager.loadAny({scene:e},o,a,(function(e,t){if(e)T(e.message,e.stack);else if(t instanceof rO&&t.scene){var n=t.scene;n._id=t._uuid,n.name=t.name}else e=new Error("The asset "+t._uuid+" is not a scene");s&&s(e,t)}))},t.preloadScene=function(e,t,n,i){var r=mN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.bundle=this.name,u.assetManager.preloadAny({scene:e},o,a,(function(t){t&&M(1210,e,t.message),s&&s(t)}))},t.get=function(e,t){var n=this.getInfoWithPath(e,t);return n&&Tl.get(n.uuid)||null},t.release=function(e,t){var n=this.get(e,t);n&&cN.tryRelease(n,!0)},t.releaseUnusedAssets=function(){var e=this;Tl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&cN.tryRelease(t)}))},t.releaseAll=function(){var e=this;Tl.forEach((function(t){var n=e.getAssetInfo(t._uuid);n&&!n.redirect&&cN.tryRelease(t,!0)}))},t._destroy=function(){this._config.destroy()},Z(e,[{key:"config",get:function(){return this._config}},{key:"name",get:function(){return this._config.name}},{key:"deps",get:function(){return this._config.deps}},{key:"base",get:function(){return this._config.base}}]),e}(),SN=e("resources",new xN);function TN(e,t,n){var i=new Image;function r(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(null,i)}function o(){i.removeEventListener("load",r),i.removeEventListener("error",o),n&&n(new Error(F(4930,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.addEventListener("load",r),i.addEventListener("error",o),i.src=e,i}function bN(e,t,n,i){var r=new XMLHttpRequest,o="download failed: "+e+", status: ";if(r.open("GET",e,!0),void 0!==t.xhrResponseType&&(r.responseType=t.xhrResponseType),void 0!==t.xhrWithCredentials&&(r.withCredentials=t.xhrWithCredentials),void 0!==t.xhrMimeType&&r.overrideMimeType&&r.overrideMimeType(t.xhrMimeType),void 0!==t.xhrTimeout&&(r.timeout=t.xhrTimeout),t.xhrHeader)for(var a in t.xhrHeader)r.setRequestHeader(a,t.xhrHeader[a]);return r.onload=function(){200===r.status||0===r.status?i&&i(null,r.response):i&&i(new Error(""+o+r.status+"(no response)"))},n&&(r.onprogress=function(e){e.lengthComputable&&n(e.loaded,e.total)}),r.onerror=function(){i&&i(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){i&&i(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){i&&i(new Error(""+o+r.status+"(abort)"))},r.send(null),r}u.resources=SN;var EN={};function CN(e,t,n){if(EN[e])return n&&n(null),null;var i=document.createElement("script");function r(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),EN[e]=!0,n&&n(null)}function o(){i.parentNode.removeChild(i),i.removeEventListener("load",r,!1),i.removeEventListener("error",o,!1),n&&n(new Error(F(4928,e)))}return"file:"!==window.location.protocol&&(i.crossOrigin="anonymous"),i.async=t.scriptAsyncLoading||!1,i.src=e,i.addEventListener("load",r,!1),i.addEventListener("error",o,!1),document.body.appendChild(i),i}var AN=/^(?:\w+:\/\/|\.+\/).+/,wN=function(e,t,n){(hh.hasFeature(hh.Feature.IMAGE_BITMAP)&&u.assetManager.allowImageBitmap?PN:TN)(e,t,n)},PN=function(e,t,n){t.xhrResponseType="blob",bN(e,t,t.onFileProgress,n)},RN=function(e,t,n){t.xhrResponseType="json",bN(e,t,t.onFileProgress,n)},IN=function(e,t,n){t.xhrResponseType="arraybuffer",bN(e,t,t.onFileProgress,n)},DN=function(e,t,n){RN(e,t,(function(t,i){if(t)n(t);else{var r=dh(i);Promise.all(r.chunks.map((function(n){return new Promise((function(i,r){IN(""+bu(e)+n,{},(function(e,n){t?r(t):i(new Uint8Array(n))}))}))}))).then((function(e){var t=new ph(r.document,e);n(null,t)})).catch((function(e){n(e)}))}}))},ON=function(e,t,n){IN(e,t,(function(e,t){if(e)n(e);else try{var i=mh(new Uint8Array(t));n(null,i)}catch(e){n(e)}}))},MN=function(e,t,n){t.xhrResponseType="text",bN(e,t,t.onFileProgress,n)},NN=function(e,t,n){var i=Eu(e),r=e;AN.test(r)||(r=-1!==LN.remoteBundles.indexOf(i)?LN.remoteServerAddress+"remote/"+i:"assets/"+i);var o=t.version||LN.bundleVers[i],a=0,s=null,c=null;RN(r+"/config."+(o?o+".":"")+"json",t,(function(e,t){c=e,(s=t)&&(s.base=r+"/"),2==++a&&n(c,s)})),CN(r+"/index."+(o?o+".":"")+"js",t,(function(e){c=e,2==++a&&n(e,s)}))},LN=new(function(){function e(){this.maxConcurrency=6,this.maxRequestsPerFrame=6,this.maxRetryCount=3,this.appendTimeStamp=!1,this.limited=!0,this.retryInterval=2e3,this.bundleVers=null,this.remoteBundles=[],this.downloadDomImage=TN,this.downloadDomAudio=null,this.downloadFile=bN,this.downloadScript=CN,this._downloaders={".png":wN,".jpg":wN,".bmp":wN,".jpeg":wN,".gif":wN,".ico":wN,".tiff":wN,".webp":wN,".image":wN,".pvr":IN,".pkm":IN,".astc":IN,".txt":MN,".xml":MN,".vsh":MN,".fsh":MN,".atlas":MN,".tmx":MN,".tsx":MN,".json":RN,".ExportJson":RN,".plist":MN,".ccon":DN,".cconb":ON,".fnt":MN,".binary":IN,".bin":IN,".dbbin":IN,".skel":IN,".js":CN,bundle:NN,default:MN},this._downloading=new yl,this._queue=[],this._queueDirty=!1,this._totalNum=0,this._totalNumThisPeriod=0,this._lastDate=-1,this._checkNextPeriod=!1,this._remoteServerAddress="",this._maxInterval=1/30}var t=e.prototype;return t.init=function(e,t,n){void 0===e&&(e=""),void 0===t&&(t={}),void 0===n&&(n=[]),this._downloading.clear(),this._queue.length=0,this._remoteServerAddress=e,this.bundleVers=t,this.remoteBundles=n},t.register=function(e,t){"object"==typeof e?ke(this._downloaders,e):this._downloaders[e]=t},t.download=function(e,t,n,i,r){var o=this,a=bl.get(e);if(a)r(null,a);else{var s=this._downloading.get(e);if(s){s.push(r);var c=this._queue.find((function(t){return t.id===e}));if(!c)return;var l=i.priority||0;c.priority<l&&(c.priority=l,this._queueDirty=!0)}else{var u=void 0!==i.maxRetryCount?i.maxRetryCount:this.maxRetryCount,h=void 0!==i.maxConcurrency?i.maxConcurrency:this.maxConcurrency,f=void 0!==i.maxRequestsPerFrame?i.maxRequestsPerFrame:this.maxRequestsPerFrame,_=this._downloaders[n]||this._downloaders.default;fN((function(n,a){if(0===n&&o._downloading.add(e,[r]),o.limited){o._updateTime();var s=function(e,t){o._totalNum--,o._handleQueueInNextFrame(h,f),a(e,t)};o._totalNum<h&&o._totalNumThisPeriod<f?(_(hN(t,o.appendTimeStamp),i,s),o._totalNum++,o._totalNumThisPeriod++):(o._queue.push({id:e,priority:i.priority||0,url:t,options:i,done:s,handler:_}),o._queueDirty=!0,o._totalNum<h&&o._handleQueueInNextFrame(h,f))}else _(hN(t,o.appendTimeStamp),i,a)}),u,this.retryInterval,(function(t,n){t||bl.add(e,n);for(var i=o._downloading.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))}}},t.loadSubpackage=function(e,t){u.assetManager.loadBundle(e,null,t)},t._updateTime=function(){var e=performance.now(),t=u.game.deltaTime,n=t>this._maxInterval?this._maxInterval:t;e-this._lastDate>1e3*n&&(this._totalNumThisPeriod=0,this._lastDate=e)},t._handleQueue=function(e,t){for(this._checkNextPeriod=!1,this._updateTime();this._queue.length>0&&this._totalNum<e&&this._totalNumThisPeriod<t;){this._queueDirty&&(this._queue.sort((function(e,t){return e.priority-t.priority})),this._queueDirty=!1);var n=this._queue.pop();if(!n)break;this._totalNum++,this._totalNumThisPeriod++,n.handler(hN(n.url,this.appendTimeStamp),n.options,n.done)}this._handleQueueInNextFrame(e,t)},t._handleQueueInNextFrame=function(e,t){!this._checkNextPeriod&&this._queue.length>0&&(Tt(this._handleQueue.bind(this),e,t),this._checkNextPeriod=!0)},Z(e,[{key:"remoteServerAddress",get:function(){return this._remoteServerAddress}}]),e}());function BN(e,t,n,i){var r=null,o=null;try{(r=new nv)._nativeUrl=e,r._nativeAsset=t}catch(e){o=e}i(o,r)}function FN(e,t,n,i){var r=new uO;r.json=t,i(null,r)}function zN(e,t,n,i){var r=new lO;r.text=t,i(null,r)}function UN(e,t,n,i){var r=new LA;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function kN(e,t,n,i){var r=new Nu;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}function GN(e,n,i,r){var o=Cl.get(n.name);o||(o=n.name===Rl.RESOURCES?SN:new xN,n.base=n.base||e+"/",o.init(n)),t.import("virtual:///prerequisite-imports/"+o.name).then((function(){r(null,o)})).catch(r)}var HN=new(function(){function e(){this._creating=new yl,this._producers={".png":BN,".jpg":BN,".bmp":BN,".jpeg":BN,".gif":BN,".ico":BN,".tiff":BN,".webp":BN,".image":BN,".pvr":BN,".pkm":BN,".txt":zN,".xml":zN,".vsh":zN,".fsh":zN,".atlas":zN,".tmx":zN,".tsx":zN,".fnt":zN,".json":FN,".ExportJson":FN,".binary":UN,".bin":UN,".dbbin":UN,".skel":UN,bundle:GN,default:kN}}var t=e.prototype;return t.register=function(e,t){"object"==typeof e?rt.mixin(this._producers,e):this._producers[e]=t},t.create=function(e,t,n,i,r){var o=this,a=this._producers[n]||this._producers.default,s=Tl.get(e);if(i.reloadAsset||!s){var c=this._creating.get(e);c?c.push(r):(this._creating.add(e,[r]),a(e,t,i,(function(t,n){!t&&n instanceof Nu&&(n._uuid=e,pN(e,n,i.cacheAsset));for(var r=o._creating.remove(e),a=0,s=r.length;a<s;a++)r[a](t,n)})))}else r(null,s)},e}()),VN=new(function(){function e(){this._loading=new yl,this._unpackers={".json":this.unpackJson}}var t=e.prototype;return t.unpackJson=function(e,t,n,i){var r=rt.createMap(!0),o=null;if(Array.isArray(t)){(t=function(e){if(e[0]<1)throw new Error(F(5304,e[0]));Bh(e,!0,void 0,zh.reportMissingClass),Fh(e);for(var t=new Uh(e[0]),n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=0;s<a.length;++s)a[s].unshift(t,n,i,r,o);return a}(t)).length!==e.length&&M(4915);for(var a=0;a<e.length;a++)r[e[a]+"@import"]=t[a]}else{var s=rt._getClassId(Cv),c=rt._getClassId(nv);if(t.type===s&&t.data){var l=t.data;l.length!==e.length&&M(4915);for(var u=0;u<e.length;u++)r[e[u]+"@import"]=kh(s,{base:l[u][0],mipmaps:l[u][1]})}else if(t.type===c&&t.data){var h=t.data;h.length!==e.length&&M(4915);for(var f=0;f<e.length;f++)r[e[f]+"@import"]=h[f]}else o=new Error("unmatched type pack!"),r=null}i(o,r)},t.init=function(){this._loading.clear()},t.register=function(e,t){"object"==typeof e?rt.mixin(this._unpackers,e):this._unpackers[e]=t},t.unpack=function(e,t,n,i,r){t?(0,this._unpackers[n])(e,t,i,r):r(new Error("package data is wrong!"))},t.load=function(e,t,n){var i=this;if(!e.isNative&&e.info&&e.info.packs)if(bl.has(e.id))n(null,bl.get(e.id));else{var r=e.info.packs,o=r.find((function(e){return i._loading.has(e.uuid)}));if(o)this._loading.get(o.uuid).push({onComplete:n,id:e.id});else{o=r[0],this._loading.add(o.uuid,[{onComplete:n,id:e.id}]);var a=Hl(o.uuid,{ext:o.ext,bundle:e.config.name});LN.download(o.uuid,a,o.ext,e.options,(function(t,n){bl.remove(o.uuid),t&&T(t.message,t.stack),i.unpack(o.packedUuids,n,o.ext,e.options,(function(e,n){if(!e)for(var r in n)bl.add(r,n[r]);for(var a=i._loading.remove(o.uuid),s=0,c=a.length;s<c;s++){var l=a[s];if(t||e)l.onComplete(t||e);else{var u=n[l.id];u?l.onComplete(null,u):l.onComplete(new Error("can not retrieve data from package"))}}}))}))}}else LN.download(e.id,e.url,e.ext,e.options,n)},e}());function WN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress,o=[],a=r.total,s=i.__exclude__=i.__exclude__||Object.create(null);e.output=[],dN(e.input,(function(i,c){if(!i.isNative&&Tl.has(i.uuid)){var l=Tl.get(i.uuid);return i.content=l.addRef(),e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i),void c()}VN.load(i,e.options,(function(l,h){l?e.isFinish||(!u.assetManager.force||n?(T(l.message,l.stack),r.canInvoke=!1,t(l)):(e.output.push(i),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i))):e.isFinish||(i.file=h,e.output.push(i),i.isNative||(s[i.uuid]=!0,_N(i.uuid,h,s,o,i.config),r.total=a+o.length),r.canInvoke&&e.dispatch("progress",++r.finish,r.total,i)),c()}))}),(function(){if(e.isFinish)return uN(e,!0),void e.dispatch("error");if(o.length>0){var a=Dl.create({input:o,progress:r,options:i,onProgress:e.onProgress,onError:Dl.prototype.recycle,onComplete:function(i){var r;i||((r=e.output).push.apply(r,a.output),a.recycle()),n&&jN(e),t(i)}});wl.async(a)}else n&&jN(e),t()}))}function jN(e){for(var t=e.output,n=0,i=t.length;n<i;n++)t[n].content&&t[n].content.decRef(!1)}var qN=new(function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.parse=function(e){var t=this._parseXML(e).documentElement;if("plist"!==t.tagName)return D(5100),{};for(var n=null,i=0,r=t.childNodes.length;i<r&&1!==(n=t.childNodes[i]).nodeType;i++);return this._parseNode(n)},n._parseNode=function(e){var t=null,n=e.tagName;if("dict"===n)t=this._parseDict(e);else if("array"===n)t=this._parseArray(e);else if("string"===n)if(1===e.childNodes.length)t=e.firstChild.nodeValue;else{t="";for(var i=0;i<e.childNodes.length;i++)t+=e.childNodes[i].nodeValue}else"false"===n?t=!1:"true"===n?t=!0:"real"===n?t=parseFloat(e.firstChild.nodeValue):"integer"===n&&(t=parseInt(e.firstChild.nodeValue,10));return t},n._parseArray=function(e){for(var t=[],n=0,i=e.childNodes.length;n<i;n++){var r=e.childNodes[n];1===r.nodeType&&t.push(this._parseNode(r))}return t},n._parseDict=function(e){for(var t={},n="",i=0,r=e.childNodes.length;i<r;i++){var o=e.childNodes[i];1===o.nodeType&&("key"===o.tagName?n=o.firstChild.nodeValue:t[n]=this._parseNode(o))}return t},t}(function(){function e(){this._parser=null,window.DOMParser&&(this._parser=new DOMParser)}var t=e.prototype;return t.parse=function(e){return this._parseXML(e)},t._parseXML=function(e){if(this._parser)return this._parser.parseFromString(e,"text/xml");throw new Error("Dom parser is not supported in this platform!")},e}()));function XN(e,t){return e[t]<<8|e[t+1]}var YN=new(function(){function e(){this._parsing=new yl,this._parsers={".png":this.parseImage,".jpg":this.parseImage,".bmp":this.parseImage,".jpeg":this.parseImage,".gif":this.parseImage,".ico":this.parseImage,".tiff":this.parseImage,".webp":this.parseImage,".image":this.parseImage,".pvr":this.parsePVRTex,".pkm":this.parsePKMTex,".astc":this.parseASTCTex,".plist":this.parsePlist,import:this.parseImport,".ccon":this.parseImport,".cconb":this.parseImport}}var t=e.prototype;return t.parseImage=function(e,t,n){e instanceof HTMLImageElement?n(null,e):createImageBitmap(e,{premultiplyAlpha:"none"}).then((function(e){n(null,e)}),(function(e){n(e,null)}))},t.parsePVRTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Int32Array(o,0,13);if(55727696===a[0]){var s=a[7],c=a[6],l=a[12]+52;r={_data:new Uint8Array(o,l),_compressed:!0,width:s,height:c,format:0}}else{if(559044176!==a[11])throw new Error("Invalid magic number in PVR header");var u=a[0],h=a[1],f=a[2];r={_data:new Uint8Array(o,u),_compressed:!0,width:f,height:h,format:0}}}catch(e){i=e}n(i,r)},t.parsePKMTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o),s=XN(a,6);if(0!==s&&1!==s&&3!==s)throw new Error("Invalid magic number in ETC header");var c=XN(a,12),l=XN(a,14);XN(a,8),XN(a,10),r={_data:new Uint8Array(o,16),_compressed:!0,width:c,height:l,format:0}}catch(e){i=e}n(i,r)},t.parseASTCTex=function(e,t,n){var i=null,r=null;try{var o=e instanceof ArrayBuffer?e:e.buffer,a=new Uint8Array(o);if(1554098963!==a[0]+(a[1]<<8)+(a[2]<<16)+(a[3]<<24))throw new Error("Invalid magic number in ASTC header");var s=a[4],c=a[5],l=a[6];if((s<3||s>6||c<3||c>6||l<3||l>6)&&(s<4||7===s||9===s||11===s||s>12||c<4||7===c||9===c||11===c||c>12||1!==l))throw new Error("Invalid block number in ASTC header");var u=function(e,t){return 4===e?Mm.RGBA_ASTC_4x4:5===e?4===t?Mm.RGBA_ASTC_5x4:Mm.RGBA_ASTC_5x5:6===e?5===t?Mm.RGBA_ASTC_6x5:Mm.RGBA_ASTC_6x6:8===e?5===t?Mm.RGBA_ASTC_8x5:6===t?Mm.RGBA_ASTC_8x6:Mm.RGBA_ASTC_8x8:10===e?5===t?Mm.RGBA_ASTC_10x5:6===t?Mm.RGBA_ASTC_10x6:8===t?Mm.RGBA_ASTC_10x8:Mm.RGBA_ASTC_10x10:10===t?Mm.RGBA_ASTC_12x10:Mm.RGBA_ASTC_12x12}(s,c),h=a[7]+(a[8]<<8)+(a[9]<<16),f=a[10]+(a[11]<<8)+(a[12]<<16);a[13],a[14],a[15],r={_data:new Uint8Array(o,16),_compressed:!0,width:h,height:f,format:u}}catch(e){i=e}n(i,r)},t.parsePlist=function(e,t,n){var i=null,r=qN.parse(e);r||(i=new Error("parse failed")),n(i,r)},t.parseImport=function(e,t,n){if(e){var i=null,r=null;try{i=av(e,t)}catch(e){r=e}n(r,i)}else n(new Error("The json file of asset "+t.__uuid__+" is empty or missing"))},t.init=function(){this._parsing.clear()},t.register=function(e,t){"object"==typeof e?ke(this._parsers,e):this._parsers[e]=t},t.parse=function(e,t,n,i,r){var o=this,a=El.get(e);if(a)r(null,a);else{var s=this._parsing.get(e);if(s)s.push(r);else{var c=this._parsers[n];c?(this._parsing.add(e,[r]),c(t,i,(function(t,n){t?bl.remove(e):kl(n)||El.add(e,n);for(var i=o._parsing.remove(e),r=0,a=i.length;r<a;r++)i[r](t,n)}))):r(null,t)}}},e}());function KN(e,t){var n=!1;e.progress||(e.progress={finish:0,total:e.input.length,canInvoke:!0},n=!0);var i=e.options,r=e.progress;i.__exclude__=i.__exclude__||Object.create(null),e.output=[],dN(e.input,(function(o,a){var s=Dl.create({input:o,onProgress:e.onProgress,options:i,progress:r,onComplete:function(i,c){i&&!e.isFinish&&(!u.assetManager.force||n?(T(i.message,i.stack),r.canInvoke=!1,t(i)):r.canInvoke&&e.dispatch("progress",++r.finish,r.total,o)),e.output.push(c),s.recycle(),a(null)}});QN.async(s)}),(function(){if(i.__exclude__=null,e.isFinish)return uN(e,!0),void e.dispatch("error");!function(e){var t=e.source;if(e.options.__outputAsArray__||1!==t.length)for(var n=e.output=[],i=0,r=t.length;i<r;i++)n.push(t[i].content);else e.output=t[0].content}(e),uN(e,!0),t()}))}var QN=new xl("loadOneAsset",[function(e,t){var n=e.output=e.input,i=n.options,r=n.isNative,o=n.uuid,a=n.file,s=i.reloadAsset;a||!s&&!r&&Tl.has(o)?t():VN.load(n,e.options,(function(e,i){n.file=i,t(e)}))},function(e,t){var n=e.output=e.input,i=e.progress,r=e.options.__exclude__,o=n.id,a=n.file,s=n.options;if(n.isNative)YN.parse(o,a,n.ext,s,(function(r,a){r?t(r):(n.content=a,i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),bl.remove(o),El.remove(o),t())}));else{var c=n.uuid;if(c in r){var l=r[c],u=l.finish,h=l.content,f=l.err,_=l.callbacks;i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),u||gN(c,c,r)?(h&&h.addRef(),n.content=h,t(f)):_.push({done:t,item:n})}else if(!s.reloadAsset&&Tl.has(c)){var p=Tl.get(c);n.content=p.addRef(),i.canInvoke&&e.dispatch("progress",++i.finish,i.total,n),t()}else s.__uuid__=c,YN.parse(o,a,"import",s,(function(n,i){n?t(n):function(e,t,n){var i=e.input,r=e.progress,o=i,a=o.uuid,s=o.id,c=o.options,l=o.config,u=c.cacheAsset,h=[];t.addRef&&t.addRef(),_N(a,t,Object.create(null),h,l),r.canInvoke&&e.dispatch("progress",++r.finish,r.total+=h.length,i);var f=e.options.__exclude__[a]={content:t,finish:!1,callbacks:[{done:n,item:i}]},_=Dl.create({input:h,options:e.options,onProgress:e.onProgress,onError:Dl.prototype.recycle,progress:r,onComplete:function(e){if(t.decRef&&t.decRef(!1),f.finish=!0,f.err=e,!e){for(var n,i=Array.isArray(_.output)?_.output:[_.output],r=Object.create(null),o=se(i);!(n=o()).done;){var c=n.value;c&&(r[c instanceof Nu?c._uuid+"@import":a+"@native"]=c)}!function(e,t,n){var i=iv.get(t);if(i){for(var r=0,o=i.length;r<o;r++){var a=i[r],s=n[a.uuid+"@import"];if(s)a.owner[a.prop]=s.addRef();else{if(T("The asset "+a.uuid+" is missing!"),a.type&&a.type!==Nu){var c=new a.type;c.initDefault(a.uuid),a.owner[a.prop]=c}!0}}iv.delete(t)}rv.has(t)&&(n[e+"@native"]?t._nativeAsset=n[e+"@native"]:(!0,console.error("the native asset of "+e+" is missing!")),rv.delete(t))}(a,t,r);try{"function"!=typeof t.onLoaded||ov.has(t)||rv.has(t)||(t.onLoaded(),ov.add(t))}catch(e){T("The asset "+a+" is invalid for some reason, detail message: "+e.message+", stack: "+e.stack)}bl.remove(s),El.remove(s),pN(a,t,u),_.recycle()}for(var l=f.callbacks,h=0,p=l.length;h<p;h++){var d=l[h];t.addRef&&t.addRef(),d.item.content=t,d.done(e)}l.length=0}});Al.async(_)}(e,i,t)}))}}]);function ZN(e,t){var n=e.options,i=Object.create(null),r=Object.create(null);for(var o in n)switch(o){case Sl.PATH:case Sl.UUID:case Sl.DIR:case Sl.SCENE:case Sl.URL:break;case"__requestType__":case"__isNative__":case"ext":case"type":case"__nativeName__":case"audioLoadMode":case"bundle":i[o]=n[o];break;case"__exclude__":case"__outputAsArray__":r[o]=n[o];break;default:i[o]=n[o],r[o]=n[o]}e.options=r;var a=Dl.create({input:e.input,options:i}),s=null;try{e.output=e.source=Pl.sync(a)}catch(e){s=e;for(var c=0,l=a.output.length;c<l;c++)a.output[c].recycle()}a.recycle(),t(s)}var JN=function(){function e(){this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),this._id=""}return e.create=function(){return 0!==e._deadPool.length?e._deadPool.pop():new e},e.prototype.recycle=function(){e._deadPool.length!==e.MAX_DEAD_NUM&&(this._id="",this.uuid="",this.url="",this.ext=".json",this.content=null,this.file=null,this.info=null,this.config=null,this.isNative=!1,this.options=Object.create(null),e._deadPool.push(this))},Z(e,[{key:"id",get:function(){return this._id||(this._id=this.uuid+"@"+(this.isNative?"native":"import")),this._id}}]),e}();JN.MAX_DEAD_NUM=500,JN._deadPool=[];var $N=[];function eL(e){var t=e.options,n=Array.isArray(e.input)?e.input:[e.input];e.output=[];for(var i=function(i){var r,o=n[i],a=JN.create(),s=null,c=null;if("string"==typeof o&&((o=Object.create(null))[t.__requestType__||Sl.UUID]=n[i]),"object"==typeof o)for(var l in Ue(o,t),o.preset&&Ue(o,Il[o.preset]),o){switch(l){case Sl.UUID:if("break"===function(){var e,t=a.uuid=Bl(o.uuid);if(!o.bundle){var n=Cl.find((function(e){return!!e.getAssetInfo(t)}));o.bundle=n&&n.name}if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getAssetInfo(t))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("Please load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(t)}a.config=s,a.info=c}return a.ext=o.ext||(null===(e=c)||void 0===e?void 0:e.extension)||".json","break"}())break;case"__requestType__":case"ext":case"bundle":case"preset":case"type":break;case Sl.DIR:if(Cl.has(o.bundle)){Cl.get(o.bundle).config.getDirWithPath(o.dir,o.type,$N);for(var u,h=se($N);!(u=h()).done;){var f=u.value;n.push({uuid:f.uuid,__isNative__:!1,ext:f.extension||".json",bundle:o.bundle})}$N.length=0}a.recycle(),a=null;break;case Sl.PATH:if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getInfoWithPath(o.path,o.type))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+o.bundle+" doesn't contain "+o.path);a.config=s,a.uuid=c.uuid,a.info=c}a.ext=o.ext||(null===(r=c)||void 0===r?void 0:r.extension)||".json";break;case Sl.SCENE:if(!o.bundle){var _=Cl.find((function(e){return!!e.getSceneInfo(o.scene)}));o.bundle=_&&_.name}if(Cl.has(o.bundle)){if(s=Cl.get(o.bundle).config,(c=s.getSceneInfo(o.scene))&&c.redirect){if(!Cl.has(c.redirect))throw new Error("you need to load bundle "+c.redirect+" first");s=Cl.get(c.redirect).config,c=s.getAssetInfo(c.uuid)}if(!c)throw a.recycle(),new Error("Bundle "+s.name+" doesn't contain scene "+o.scene);a.config=s,a.uuid=c.uuid,a.info=c}break;case"__isNative__":a.isNative=o.__isNative__;break;case Sl.URL:a.url=o.url,a.uuid=o.uuid||o.url,a.ext=o.ext||Tu(o.url),a.isNative=void 0===o.__isNative__||o.__isNative__;break;default:a.options[l]=o[l]}if(!a)break}if(!a)return"continue";if(e.output.push(a),!a.uuid&&!a.url)throw new Error("Can not parse this input:"+JSON.stringify(o))},r=0;r<n.length;r++)i(r);return null}function tL(e){for(var t=e.output=e.input,n=0;n<t.length;n++){var i=t[n];if(!i.url){var r,o,a=i.config;o=i.isNative?a&&a.nativeBase?a.base+a.nativeBase:u.assetManager.generalNativeBase:a&&a.importBase?a.base+a.importBase:u.assetManager.generalImportBase;var s=i.uuid,c="";i.info&&(c=i.isNative?i.info.nativeVer?"."+i.info.nativeVer:"":i.info.ver?"."+i.info.ver:""),r=".ttf"===i.ext?o+"/"+s.slice(0,2)+"/"+s+c+"/"+i.options.__nativeName__:o+"/"+s.slice(0,2)+"/"+s+c+i.ext,i.url=r}}return null}var nL=e("AssetManager",function(){function e(){this.pipeline=Al.append(ZN).append(KN),this.fetchPipeline=wl.append(ZN).append(WN),this.transformPipeline=Pl.append(eL).append(tL),this.bundles=Cl,this.assets=Tl,this.generalImportBase="",this.generalNativeBase="",this.dependUtil=cv,this.force=!1,this.allowImageBitmap=!hh.isMobile,this.utils=Vl,this.downloader=LN,this.parser=YN,this.packManager=VN,this.cacheAsset=!0,this.cacheManager=null,this.presets=Il,this.factory=HN,this.preprocessPipe=ZN,this.fetchPipe=WN,this.loadPipe=KN,this.references=null,this._releaseManager=cN,this._files=bl,this._parsed=El,this._parsePipeline=null}var t=e.prototype;return t.init=function(e){void 0===e&&(e={}),this._files.clear(),this._parsed.clear(),this._releaseManager.init(),this.assets.clear(),this.bundles.clear(),this.packManager.init(),this.downloader.init(e.server,e.bundleVers,e.remoteBundles),this.parser.init(),this.dependUtil.init();var t=e.importBase||"";t&&t.endsWith("/")&&(t=t.substr(0,t.length-1));var n=e.nativeBase||"";n&&n.endsWith("/")&&(n=n.substr(0,n.length-1)),this.generalImportBase=t,this.generalNativeBase=n},t.getBundle=function(e){return Cl.get(e)||null},t.removeBundle=function(e){e._destroy(),Cl.remove(e.name)},t.loadAny=function(e,t,n,i){var r=mN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"default",e=Array.isArray(e)?e.slice():e;var c=Dl.create({input:e,onProgress:a,onComplete:yN(s),options:o});Al.async(c)},t.preloadAny=function(e,t,n,i){var r=mN(t,n,i),o=r.options,a=r.onProgress,s=r.onComplete;o.preset=o.preset||"preload",e=Array.isArray(e)?e.slice():e;var c=Dl.create({input:e,onProgress:a,onComplete:yN(s),options:o});wl.async(c)},t.loadRemote=function(e,t,n){var i=mN(t,void 0,n),r=i.options,o=i.onComplete;r.reloadAsset||!this.assets.has(e)?(r.__isNative__=!0,r.preset=r.preset||"remote",this.loadAny({url:e},r,null,(function(t,n){t?(T(t.message,t.stack),o&&o(t,n)):HN.create(e,n,r.ext||Tu(e),r,(function(e,t){o&&o(e,t)}))}))):yN(o)(null,this.assets.get(e))},t.loadBundle=function(e,t,n){var i=mN(t,void 0,n),r=i.options,o=i.onComplete,a=Eu(e);this.bundles.has(a)?yN(o)(null,this.getBundle(a)):(r.preset=r.preset||"bundle",r.ext="bundle",r.__isNative__=!0,this.loadAny({url:e},r,null,(function(t,n){t?(T(t.message,t.stack),o&&o(t,n)):HN.create(e,n,"bundle",r,(function(e,t){o&&o(e,t)}))})))},t.releaseAsset=function(e){cN.tryRelease(e,!0)},t.releaseUnusedAssets=function(){Tl.forEach((function(e){cN.tryRelease(e)}))},t.releaseAll=function(){Tl.forEach((function(e){cN.tryRelease(e,!0)}))},t.loadWithJson=function(){throw new Error("Only valid in Editor")},Z(e,[{key:"main",get:function(){return Cl.get(Rl.MAIN)||null}},{key:"resources",get:function(){return Cl.get(Rl.RESOURCES)||null}}]),e}());nL.Pipeline=xl,nL.Task=Dl,nL.Cache=yl,nL.RequestItem=JN,nL.Bundle=xN,nL.BuiltinBundleName=Rl;var iL=e("assetManager",u.assetManager=new nL);u.AssetManager=nL;var rL=[".png",".jpg",".bmp",".jpeg",".gif",".ico",".tiff",".webp",".image",".pvr",".pkm",".astc"],oL=[".mp3",".ogg",".wav",".m4a"];function aL(){return!0}var sL={transformURL:function(e){var t=zl(e);if(!t)return e;var n=Cl.find((function(e){return!!e.getAssetInfo(t)}));if(!n)return e;var i,r=n.getAssetInfo(t);if(!(i=e.startsWith(n.base+n.config.nativeBase)?r.nativeVer||"":r.ver||"")||-1!==e.indexOf(i))return e;var o=!1;if(".ttf"===Tu(e)&&(o=!0),o){var a=Cu(e),s=Eu(e);e=a+"."+i+"/"+s}else e=e.replace(/.*[/\\][0-9a-fA-F]{2}[/\\]([0-9a-fA-F-@]{8,})/,(function(e){return e+"."+i}));return e}},cL=e("CCLoader",function(){function e(){this._autoReleaseSetting=Object.create(null),this._parseLoadResArgs=vN}var t=e.prototype;return t.load=function(e,t,n){void 0===n&&void 0!==t&&(n=t,t=null);for(var i=Array.isArray(e)?e:[e],r=0;r<i.length;r++){var o=i[r];"string"==typeof o?i[r]={url:o,__isNative__:!0}:(o.type&&(o.ext="."+o.type,o.type=void 0),o.url&&(o.__isNative__=!0))}var a=[],s=[];iL.loadAny(i,null,(function(e,n,i){i.content&&(rL.includes(i.ext)?a.push(i.content):oL.includes(i.ext)&&s.push(i.content)),t&&t(e,n,i)}),(function(e,t){var r=null;if(!e){t=Array.isArray(t)?t:[t];for(var o=function(e){var n=t[e];if(!(n instanceof Nu)){var r=n,o=i[e].url;a.includes(r)?HN.create(o,n,".png",{},(function(n,i){r=t[e]=i})):s.includes(r)&&HN.create(o,n,".mp3",{},(function(n,i){r=t[e]=i})),Tl.add(o,r)}},c=0;c<t.length;c++)o(c);if(t.length>1){var l=Object.create(null);t.forEach((function(e){l[e._uuid]=e})),r={isCompleted:aL,_map:l}}else r=t[0]}n&&n(e,r)}))},t.getXMLHttpRequest=function(){return new XMLHttpRequest},t.getItem=function(e){return iL.assets.has(e)?{content:iL.assets.get(e)}:null},t.loadRes=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete,c=Tu(e);c&&!SN.getInfoWithPath(e,o)&&(e=e.slice(0,-c.length)),SN.load(e,o,a,s)},t.loadResArray=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;e.forEach((function(t,n){var i=Tu(t);i&&!SN.getInfoWithPath(t,o)&&(e[n]=t.slice(0,-i.length))})),SN.load(e,o,a,s)},t.loadResDir=function(e,t,n,i){var r=this._parseLoadResArgs(t,n,i),o=r.type,a=r.onProgress,s=r.onComplete;SN.loadDir(e,o,a,(function(t,n){var i=[];t||(i=SN.getDirWithPath(e,o).map((function(e){return e.path}))),s&&s(t,n,i)}))},t.getRes=function(e,t){return Tl.has(e)?Tl.get(e):SN.get(e,t)},t.getResCount=function(){return Tl.count},t.getDependsRecursively=function(e){if(!e)return[];var t="string"==typeof e?e:e._uuid;return cv.getDepsRecursively(t).concat([t])},t.addDownloadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({url:e},n)}};for(var i in e)n(i);LN.register(t)},t.addLoadHandlers=function(e){var t=Object.create(null),n=function(n){var i=e[n];t["."+n]=function(e,t,n){i({content:e},n)}};for(var i in e)n(i);YN.register(t)},t.release=function(e){if(Array.isArray(e))for(var t=0;t<e.length;t++){var n=e[t];"string"==typeof n&&(n=Tl.get(n)),iL.releaseAsset(n)}else e&&("string"==typeof e&&(e=Tl.get(e)),iL.releaseAsset(e))},t.releaseAsset=function(e){iL.releaseAsset(e)},t.releaseRes=function(e,t){SN.release(e,t)},t.releaseAll=function(){iL.releaseAll(),Tl.clear()},t.removeItem=function(e){return!!Tl.remove(e)},t.setAutoRelease=function(e,t){"object"==typeof e&&(e=e._uuid),this._autoReleaseSetting[e]=!!t},t.setAutoReleaseRecursively=function(e,t){"object"==typeof e&&(e=e._uuid),t=!!t,this._autoReleaseSetting[e]=t;for(var n=cv.getDepsRecursively(e),i=0;i<n.length;i++)this._autoReleaseSetting[n[i]]=t},t.isAutoRelease=function(e){return"object"==typeof e&&(e=e._uuid),!!this._autoReleaseSetting[e]},Z(e,[{key:"onProgress",set:function(e){lN=e}},{key:"_cache",get:function(){if(Tl instanceof yl)return Tl._map;var e={};return Tl.forEach((function(t,n){e[n]=t})),e}},{key:"md5Pipe",get:function(){return sL}},{key:"downloader",get:function(){return LN}},{key:"loader",get:function(){return iL.parser}}]),e}()),lL=e("loader",new cL),uL=e("AssetLibrary",{init:function(e){e.importBase=e.libraryPath,e.nativeBase=e.rawAssetsBase,iL.init(e),e.rawAssets&&SN.init({base:"",deps:[],scenes:{},redirect:[],debug:!0,packs:{},types:[],versions:{import:[],native:[]},name:Rl.RESOURCES,importBase:e.importBase,nativeBase:e.nativeBase,paths:e.rawAssets.assets,uuids:Object.keys(e.rawAssets.assets),extensionMap:{}})},loadAsset:function(e,t){iL.loadAny(e,t)}}),hL=e("url",{});k(hL,"url",[{name:"normalize",target:iL.utils,targetName:"assetManager.utils",newName:"normalize"},{name:"raw",targetName:"Asset.prototype",newName:"nativeUrl",customFunction:function(e){return e.startsWith("resources/")?Hl({path:Au(e.substr(10)),bundle:Rl.RESOURCES,__isNative__:!0,ext:Tu(e)}):""}}]),G(uL,"AssetLibrary",[{name:"getLibUrlNoExt",suggest:"AssetLibrary.getLibUrlNoExt was removed, if you want to transform url, please use cc.assetManager.utils.getUrlWithUuid instead"},{name:"queryAssetInfo",suggest:"AssetLibrary.queryAssetInfo was removed"}]),G(lL,"loader",[{name:"releaseResDir",suggest:"loader.releaseResDir was removed, please use assetManager.releaseAsset instead"},{name:"flowInDeps",suggest:"loader.flowInDeps was removed"},{name:"assetLoader",suggest:"cc.loader.assetLoader was removed, assetLoader and md5Pipe were merged into cc.assetManager.transformPipeline"}]),k(u,"cc",[{name:"loader",newName:"assetManager",logTimes:1,customGetter:function(){return lL}},{name:"AssetLibrary",newName:"assetManager",logTimes:1,customGetter:function(){return uL}},{name:"Pipeline",target:nL,targetName:"AssetManager",newName:"Pipeline",logTimes:1},{name:"url",targetName:"assetManager",newName:"utils",logTimes:1,customGetter:function(){return hL}}]),G(u,"cc",[{name:"LoadingItems",suggest:F(1400,"cc.LoadingItems","cc.AssetManager.Task")}]),k(ft,"macro",[{name:"DOWNLOAD_MAX_CONCURRENT",target:LN,targetName:"assetManager.downloader",newName:"maxConcurrency"}]),k(jM,"director",[{name:"_getSceneUuid",targetName:"assetManager.main",newName:"getSceneInfo",customFunction:function(e){var t;return iL.main?null===(t=iL.main.getSceneInfo(e))||void 0===t?void 0:t.uuid:""}}]),k(VM,"game",[{name:"_sceneInfos",targetName:"assetManager.main",newName:"getSceneInfo",customGetter:function(){var e=[];return iL.main&&iL.main.config.scenes.forEach((function(t){e.push(t)})),e}}]);var fL,_L,pL,dL,mL,vL,gL,yL,xL,SL,TL,bL,EL,CL,AL=cN._autoRelease;cN._autoRelease=function(e,t,n){AL.call(cN,e,t,n);for(var i=lL._autoReleaseSetting,r=Object.keys(i),o=0;o<r.length;o++){var a=r[o];if(!0===i[a]){var s=Tl.get(a);s&&cN.tryRelease(s)}}};var wL,PL,RL,IL,DL,OL,ML,NL,LL,BL,FL,zL,UL,kL,GL,HL,VL,WL,jL,qL,XL,YL,KL,QL,ZL,JL,$L,eB,tB,nB,iB,rB,oB,aB,sB,cB,lB,uB,hB,fB,_B,pB,dB,mB,vB,gB,yB,xB,SB,TB,bB,EB,CB,AB,wB,PB,RB,IB,DB,OB,MB,NB,LB,BB,FB,zB,UB,kB=e("EventHandler",(fL=mc("cc.ClickEvent"),_L=Zc(u.Node),pL=Fc(),dL=Fc(),mL=Fc(),vL=Fc(),fL((CL=function(){function e(){ce(this,"target",xL,this),ce(this,"component",SL,this),ce(this,"_componentId",TL,this),ce(this,"handler",bL,this),ce(this,"customEventData",EL,this)}e.emitEvents=function(t){for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0,a=t.length;o<a;o++){var s=t[o];s instanceof e&&s.emit(i)}};var t=e.prototype;return t.emit=function(e){var t=this.target;if(u.isValid(t)){this._genCompIdIfNeeded();var n=u.js._getClassById(this._componentId),i=t.getComponent(n);if(u.isValid(i)){var r=i[this.handler];"function"==typeof r&&(null!=this.customEventData&&""!==this.customEventData&&(e=e.slice()).push(this.customEventData),r.apply(i,e))}}},t._compName2Id=function(e){var t=u.js.getClassByName(e);return u.js._getClassId(t)},t._compId2Name=function(e){var t=u.js._getClassById(e);return u.js.getClassName(t)},t._genCompIdIfNeeded=function(){this._componentId||(this._componentName=this.component,this.component="")},Z(e,[{key:"_componentName",get:function(){return this._genCompIdIfNeeded(),this._compId2Name(this._componentId)},set:function(e){this._componentId=this._compName2Id(e)}}]),e}(),xL=le((yL=CL).prototype,"target",[Tc,_L,Tc,pL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SL=le(yL.prototype,"component",[Tc,Mc,dL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),TL=le(yL.prototype,"_componentId",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),bL=le(yL.prototype,"handler",[Tc,Mc,mL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),EL=le(yL.prototype,"customEventData",[Tc,Mc,vL],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),gL=yL))||gL));u.Component.EventHandler=kB;var GB,HB,VB,WB,jB,qB,XB,YB,KB,QB,ZB,JB=new In,$B=st(og),eF=st(rg),tF=st(ag),nF=st(cg),iF=st(sg),rF=st({SKYBOX:vg|Ki.DEPTH_STENCIL,SOLID_COLOR:Ki.ALL,DEPTH_ONLY:Ki.DEPTH_STENCIL,DONT_CLEAR:Ki.NONE}),oF=(wL=mc("cc.Camera"),PL=Oc(),RL=Pc(),IL=Vc(),DL=Fc(),OL=Zc(Fp.BitMask),ML=Vc(),NL=Fc(),LL=Zc(rF),BL=Vc(),FL=Fc(),zL=Vc(),UL=Fc(),kL=Vc(),GL=Fc(),HL=Vc(),VL=Fc(),WL=Zc($B),jL=Vc(),qL=Fc(),XL=Zc(eF),YL=Vc(),KL=Fc(),QL=Vc(),ZL=Fc(),JL=Vc(),$L=Fc(),eB=Vc(),tB=Fc(),nB=Vc(),iB=Fc(),rB=Zc(tF),oB=Vc(),aB=Fc(),sB=Zc(nF),cB=Vc(),lB=Fc(),uB=Zc(iF),hB=Vc(),fB=Fc(),_B=Vc(),pB=Fc(),dB=Zc(GS),mB=Vc(),vB=Fc(),GB=wL(gB=PL(gB=RL(gB=wc((UB=zB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_projection",xB,oe(t)),ce(t,"_priority",SB,oe(t)),ce(t,"_fov",TB,oe(t)),ce(t,"_fovAxis",bB,oe(t)),ce(t,"_orthoHeight",EB,oe(t)),ce(t,"_near",CB,oe(t)),ce(t,"_far",AB,oe(t)),ce(t,"_color",wB,oe(t)),ce(t,"_depth",PB,oe(t)),ce(t,"_stencil",RB,oe(t)),ce(t,"_clearFlags",IB,oe(t)),ce(t,"_rect",DB,oe(t)),ce(t,"_aperture",OB,oe(t)),ce(t,"_shutter",MB,oe(t)),ce(t,"_iso",NB,oe(t)),ce(t,"_screenScale",LB,oe(t)),ce(t,"_visibility",BB,oe(t)),ce(t,"_targetTexture",FB,oe(t)),t._camera=null,t._inEditorMode=!1,t._flows=void 0,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._createCamera()},n.onEnable=function(){this.node.hasChangedFlags|=oy.POSITION,this._camera&&this._attachToScene()},n.onDisable=function(){this._camera&&this._detachFromScene()},n.onDestroy=function(){this._camera&&(this._camera.destroy(),this._camera=null),this._targetTexture&&this._targetTexture.off("resize")},n.screenPointToRay=function(e,t,n){return n||(n=na.create()),this._camera&&this._camera.screenPointToRay(n,e,t),n},n.worldToScreen=function(e,t){return t||(t=new In),this._camera&&this._camera.worldToScreen(t,e),t},n.screenToWorld=function(e,t){return t||(t=this.node.getWorldPosition()),this._camera&&this._camera.screenToWorld(t,e),t},n.convertToUINode=function(e,t,n){if(n||(n=new In),!this._camera)return n;this.worldToScreen(e,JB);var i=t.getComponent("cc.UITransform"),r=tN.getVisibleSize(),o=JB.x-.5*this._camera.width,a=JB.y-.5*this._camera.height;return JB.x=o/u.view.getScaleX()+.5*r.width,JB.y=a/u.view.getScaleY()+.5*r.height,i&&i.convertToNodeSpaceAR(JB,n),n},n._createCamera=function(){this._camera||(this._camera=u.director.root.createCamera(),this._camera.initialize({name:this.node.name,node:this.node,projection:this._projection,window:this._inEditorMode?u.director.root&&u.director.root.mainWindow:u.director.root&&u.director.root.tempWindow,priority:this._priority}),this._camera.setViewportInOrientedSpace(this._rect),this._camera.fovAxis=this._fovAxis,this._camera.fov=fn(this._fov),this._camera.orthoHeight=this._orthoHeight,this._camera.nearClip=this._near,this._camera.farClip=this._far,this._camera.clearColor=this._color,this._camera.clearDepth=this._depth,this._camera.clearStencil=this._stencil,this._camera.clearFlag=this._clearFlags,this._camera.visibility=this._visibility,this._camera.aperture=this._aperture,this._camera.shutter=this._shutter,this._camera.iso=this._iso),this._updateTargetTexture()},n._attachToScene=function(){this.node.scene&&this._camera&&(this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera),this._getRenderScene().addCamera(this._camera))},n._detachFromScene=function(){this._camera&&this._camera.scene&&this._camera.scene.removeCamera(this._camera)},n._checkTargetTextureEvent=function(e){var t=this;e&&e.off("resize"),this._targetTexture&&this._targetTexture.on("resize",(function(e){t._camera&&t._camera.setFixedSize(e.width,e.height)}),this)},n._updateTargetTexture=function(){if(this._camera&&this._targetTexture){var e=this._targetTexture.window;this._camera.changeTargetWindow(e),this._camera.setFixedSize(e.width,e.height)}},Z(t,[{key:"camera",get:function(){return this._camera}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority=e,this._camera&&(this._camera.priority=e)}},{key:"visibility",get:function(){return this._visibility},set:function(e){this._visibility=e,this._camera&&(this._camera.visibility=e)}},{key:"clearFlags",get:function(){return this._clearFlags},set:function(e){this._clearFlags=e,this._camera&&(this._camera.clearFlag=e)}},{key:"clearColor",get:function(){return this._color},set:function(e){this._color.set(e),this._camera&&(this._camera.clearColor=this._color)}},{key:"clearDepth",get:function(){return this._depth},set:function(e){this._depth=e,this._camera&&(this._camera.clearDepth=e)}},{key:"clearStencil",get:function(){return this._stencil},set:function(e){this._stencil=e,this._camera&&(this._camera.clearStencil=e)}},{key:"projection",get:function(){return this._projection},set:function(e){this._projection=e,this._camera&&(this._camera.projectionType=e)}},{key:"fovAxis",get:function(){return this._fovAxis},set:function(e){e!==this._fovAxis&&(this._fovAxis=e,this._camera&&(this._camera.fovAxis=e,e===rg.VERTICAL?this.fov=this._fov*this._camera.aspect:this.fov=this._fov/this._camera.aspect))}},{key:"fov",get:function(){return this._fov},set:function(e){this._fov=e,this._camera&&(this._camera.fov=fn(e))}},{key:"orthoHeight",get:function(){return this._orthoHeight},set:function(e){this._orthoHeight=e,this._camera&&(this._camera.orthoHeight=e)}},{key:"near",get:function(){return this._near},set:function(e){this._near=e,this._camera&&(this._camera.nearClip=e)}},{key:"far",get:function(){return this._far},set:function(e){this._far=e,this._camera&&(this._camera.farClip=e)}},{key:"aperture",get:function(){return this._aperture},set:function(e){this._aperture=e,this._camera&&(this._camera.aperture=e)}},{key:"shutter",get:function(){return this._shutter},set:function(e){this._shutter=e,this._camera&&(this._camera.shutter=e)}},{key:"iso",get:function(){return this._iso},set:function(e){this._iso=e,this._camera&&(this._camera.iso=e)}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect=e,this._camera&&this._camera.setViewportInOrientedSpace(e)}},{key:"targetTexture",get:function(){return this._targetTexture},set:function(e){if(this._targetTexture!==e){var n=this._targetTexture;this._targetTexture=e,this._checkTargetTextureEvent(n),this._updateTargetTexture(),!e&&this._camera&&(this._camera.changeTargetWindow(null),this._camera.isWindowSize=!0),this.node.emit(t.TARGET_TEXTURE_CHANGE,this)}}},{key:"screenScale",get:function(){return this._screenScale},set:function(e){this._screenScale=e,this._camera&&(this._camera.screenScale=e)}},{key:"inEditorMode",get:function(){return this._inEditorMode},set:function(e){this._inEditorMode=e,this._camera&&this._camera.changeTargetWindow(e?u.director.root&&u.director.root.mainWindow:u.director.root&&u.director.root.tempWindow)}}]),t}(th),zB.ProjectionType=$B,zB.FOVAxis=eF,zB.ClearFlag=rF,zB.Aperture=tF,zB.Shutter=nF,zB.ISO=iF,zB.TARGET_TEXTURE_CHANGE="tex-change",xB=le((yB=UB).prototype,"_projection",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return $B.PERSPECTIVE}}),SB=le(yB.prototype,"_priority",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),TB=le(yB.prototype,"_fov",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 45}}),bB=le(yB.prototype,"_fovAxis",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return eF.VERTICAL}}),EB=le(yB.prototype,"_orthoHeight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),CB=le(yB.prototype,"_near",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),AB=le(yB.prototype,"_far",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1e3}}),wB=le(yB.prototype,"_color",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn("#333333")}}),PB=le(yB.prototype,"_depth",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),RB=le(yB.prototype,"_stencil",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IB=le(yB.prototype,"_clearFlags",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return rF.SOLID_COLOR}}),DB=le(yB.prototype,"_rect",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ri(0,0,1,1)}}),OB=le(yB.prototype,"_aperture",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tF.F16_0}}),MB=le(yB.prototype,"_shutter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return nF.D125}}),NB=le(yB.prototype,"_iso",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return iF.ISO100}}),LB=le(yB.prototype,"_screenScale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),BB=le(yB.prototype,"_visibility",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Jd}}),FB=le(yB.prototype,"_targetTexture",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(yB.prototype,"priority",[IL,DL],Object.getOwnPropertyDescriptor(yB.prototype,"priority"),yB.prototype),le(yB.prototype,"visibility",[OL,ML,NL],Object.getOwnPropertyDescriptor(yB.prototype,"visibility"),yB.prototype),le(yB.prototype,"clearFlags",[LL,BL,FL],Object.getOwnPropertyDescriptor(yB.prototype,"clearFlags"),yB.prototype),le(yB.prototype,"clearColor",[zL,UL],Object.getOwnPropertyDescriptor(yB.prototype,"clearColor"),yB.prototype),le(yB.prototype,"clearDepth",[kL,GL],Object.getOwnPropertyDescriptor(yB.prototype,"clearDepth"),yB.prototype),le(yB.prototype,"clearStencil",[HL,VL],Object.getOwnPropertyDescriptor(yB.prototype,"clearStencil"),yB.prototype),le(yB.prototype,"projection",[WL,jL,qL],Object.getOwnPropertyDescriptor(yB.prototype,"projection"),yB.prototype),le(yB.prototype,"fovAxis",[XL,YL,KL],Object.getOwnPropertyDescriptor(yB.prototype,"fovAxis"),yB.prototype),le(yB.prototype,"fov",[QL,ZL],Object.getOwnPropertyDescriptor(yB.prototype,"fov"),yB.prototype),le(yB.prototype,"orthoHeight",[JL,$L],Object.getOwnPropertyDescriptor(yB.prototype,"orthoHeight"),yB.prototype),le(yB.prototype,"near",[eB,tB],Object.getOwnPropertyDescriptor(yB.prototype,"near"),yB.prototype),le(yB.prototype,"far",[nB,iB],Object.getOwnPropertyDescriptor(yB.prototype,"far"),yB.prototype),le(yB.prototype,"aperture",[rB,oB,aB],Object.getOwnPropertyDescriptor(yB.prototype,"aperture"),yB.prototype),le(yB.prototype,"shutter",[sB,cB,lB],Object.getOwnPropertyDescriptor(yB.prototype,"shutter"),yB.prototype),le(yB.prototype,"iso",[uB,hB,fB],Object.getOwnPropertyDescriptor(yB.prototype,"iso"),yB.prototype),le(yB.prototype,"rect",[_B,pB],Object.getOwnPropertyDescriptor(yB.prototype,"rect"),yB.prototype),le(yB.prototype,"targetTexture",[dB,mB,vB],Object.getOwnPropertyDescriptor(yB.prototype,"targetTexture"),yB.prototype),gB=yB))||gB)||gB)||gB)||gB,e({Camera:GB,CameraComponent:GB}),GB);u.Camera=oF;var aF,sF,cF,lF,uF,hF,fF,_F,pF={parent:null,owner:null,subModelIdx:0},dF=e("RenderableComponent",(HB=mc("cc.RenderableComponent"),VB=Zc([ug]),WB=Zc(ug),jB=Vc(),qB=Bc(),HB((ZB=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_materials",KB,oe(t)),ce(t,"_visFlags",QB,oe(t)),t._materialInstances=[],t._models=[],t}$(t,e);var n=t.prototype;return n.getMaterial=function(e){return e<0||e>=this._materials.length?null:this._materials[e]},n.setMaterial=function(e,t){e&&e instanceof gT&&console.error("Can't set a material instance to a sharedMaterial slot"),this._materials[t]=e;var n=this._materialInstances[t];n&&(n.destroy(),this._materialInstances[t]=null),this._onMaterialModified(t,this._materials[t])},n.getMaterialInstance=function(e){if(!this._materials[e])return null;if(!this._materialInstances[e]){pF.parent=this._materials[e],pF.owner=this,pF.subModelIdx=e;var t=new gT(pF);pF.parent=null,pF.owner=null,pF.subModelIdx=0,this.setMaterialInstance(t,e)}return this._materialInstances[e]},n.setMaterialInstance=function(e,t){if("number"==typeof e){D(12007);var n=e;e=t,t=n}var i=this._materialInstances[t];e&&e.parent?e!==i&&(this._materialInstances[t]=e,this._onMaterialModified(t,e)):(e!==this._materials[t]||i)&&this.setMaterial(e,t)},n.getRenderMaterial=function(e){return this._materialInstances[e]||this._materials[e]},n._collectModels=function(){return this._models},n._attachToScene=function(){},n._detachFromScene=function(){},n._onMaterialModified=function(){},n._onRebuildPSO=function(){},n._clearMaterials=function(){},n._onVisibilityChange=function(){},Z(t,[{key:"visibility",get:function(){return this._visFlags},set:function(e){this._visFlags=e,this._onVisibilityChange(e)}},{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"materials",get:function(){for(var e=0;e<this._materials.length;e++)this._materialInstances[e]=this.getMaterialInstance(e);return this._materialInstances},set:function(e){var t=e.length-this._materials.length;if(t>0)this._materials.length=e.length,this._materialInstances.length=e.length;else if(t<0)for(var n=this._materials.length-t;n<this._materials.length;++n)this.setMaterialInstance(null,n);for(var i=0;i<this._materialInstances.length;i++)this._materialInstances[i]!=e[i]&&this.setMaterialInstance(e[i],i)}},{key:"sharedMaterial",get:function(){return this.getMaterial(0)}},{key:"material",get:function(){return this.getMaterialInstance(0)},set:function(e){(1!==this._materials.length||this._materialInstances[0]||this._materials[0]!==e)&&this.setMaterialInstance(e,0)}}]),t}(th),KB=le((YB=ZB).prototype,"_materials",[VB],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),QB=le(YB.prototype,"_visFlags",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fp.Enum.NONE}}),le(YB.prototype,"sharedMaterials",[WB,jB,qB],Object.getOwnPropertyDescriptor(YB.prototype,"sharedMaterials"),YB.prototype),XB=YB))||XB));function mF(e){return"string"==typeof e||"number"==typeof e}u.RenderableComponent=dF,k(oF,"Camera",[{name:"CameraClearFlag",newName:"ClearFlag"}]),k(oF.prototype,"Camera.prototype",[{name:"color",newName:"clearColor"},{name:"depth",newName:"clearDepth"},{name:"stencil",newName:"clearStencil"}]),u.CameraComponent=oF,rt.setClassAlias(oF,"cc.CameraComponent");var vF,gF,yF,xF,SF,TF,bF,EF,CF,AF,wF,PF,RF,IF,DF,OF,MF,NF,LF,BF,FF,zF,UF=mc("cc.animation.HierarchyPath")((lF=function(){function e(e){ce(this,"path",cF,this),this.path=e||""}return e.prototype.get=function(e){return e instanceof qC?e.getChildByPath(this.path)||(D(3926,e.name,this.path),null):(D(3925),null)},e}(),cF=le((sF=lF).prototype,"path",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aF=sF))||aF,kF=mc("cc.animation.ComponentPath")((_F=function(){function e(e){ce(this,"component",fF,this),this.component=e||""}return e.prototype.get=function(e){return e instanceof qC?e.getComponent(this.component)||(D(3928,e.name,this.component),null):(D(3927),null)},e}(),fF=le((hF=_F).prototype,"component",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),uF=hF))||uF,GF=mc("cc.animation.UniformProxyFactory")((TF=function(){function e(e,t){ce(this,"passIndex",yF,this),ce(this,"uniformName",xF,this),ce(this,"channelIndex",SF,this),this.passIndex=t||0,this.uniformName=e||""}return e.prototype.forTarget=function(e){var t=e.passes[this.passIndex],n=t.getHandle(this.uniformName);if(!n)throw new Error('Material "'+e.name+'" has no uniform "'+this.uniformName+'"');if(Gv.getTypeFromHandle(n)<mi.SAMPLER1D){var i=void 0===this.channelIndex?n:t.getHandle(this.uniformName,this.channelIndex,mi.FLOAT);if(!i)throw new Error('Uniform "'+this.uniformName+" (in material "+e.name+") has no channel "+this.channelIndex+'"');return function(e,t){for(var n,i=se(e.shaderInfo.blocks);!(n=i()).done;)for(var r,o=se(n.value.members);!(r=o()).done;){var a=r.value;if(a.name===t)return a.count>1}return!1}(t,this.uniformName)?{set:function(e){t.setUniformArray(i,e)}}:{set:function(e){t.setUniform(i,e)}}}var r=Gv.getBindingFromHandle(n),o=t.properties[this.uniformName],a=o&&o.value?o.value+"-texture":pm(o.type),s=Nv.get(a);return s||(S("Illegal texture default value: "+a+"."),s=Nv.get("default-texture")),{set:function(e){e||(e=s);var n=e.getGFXTexture();n&&n.width&&n.height&&(t.bindTexture(r,n),e instanceof ev&&t.bindSampler(r,u.game._gfxDevice.getSampler(e.getSamplerInfo())))}}},e}(),yF=le((gF=TF).prototype,"passIndex",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xF=le(gF.prototype,"uniformName",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),SF=le(gF.prototype,"channelIndex",[Yc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){}}),vF=gF))||vF,HF=mc("cc.animation.MorphWeightValueProxy")((wF=function(){function e(){ce(this,"subMeshIndex",CF,this),ce(this,"shapeIndex",AF,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeight(n,t.subMeshIndex,t.shapeIndex)}}},e}(),CF=le((EF=wF).prototype,"subMeshIndex",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),AF=le(EF.prototype,"shapeIndex",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bF=EF))||bF,VF=mc("cc.animation.MorphWeightsValueProxy")((DF=function(){function e(){ce(this,"subMeshIndex",IF,this)}return e.prototype.forTarget=function(e){var t=this;return{set:function(n){e.setWeights(n,t.subMeshIndex)}}},e}(),IF=le((RF=DF).prototype,"subMeshIndex",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),PF=RF))||PF,WF=mc("cc.animation.MorphWeightsAllValueProxy")(OF=function(){function e(){}return e.prototype.forTarget=function(e){return{set:function(t){for(var n,i,r=null!==(n=null===(i=e.mesh)||void 0===i?void 0:i.struct.primitives.length)&&void 0!==n?n:0,o=0;o<r;++o)e.setWeights(t,o)}}},e}())||OF;function jF(e,t,n,i){var r,o,a,s,c,l,u=new t,h=new t,f=new t,_=mc(e)((l=function(){function e(e,n,i){ce(this,"dataPoint",a,this),ce(this,"inTangent",s,this),ce(this,"outTangent",c,this),this.dataPoint=e||new t,this.inTangent=n||new t,this.outTangent=i||new t}var r=e.prototype;return r.lerp=function(e,t,r){var o=this.dataPoint,a=e.dataPoint;h=n(h,this.inTangent,r),f=n(f,e.outTangent,r);var s=t*t*t,c=t*t,l=s-2*c+t,_=-2*s+3*c,p=s-c;return u=n(u,o,2*s-3*c+1),u=i(u,u,h,l),u=i(u,u,a,_),u=i(u,u,f,p)},r.getNoLerp=function(){return this.dataPoint},e}(),a=le((o=l).prototype,"dataPoint",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),s=le(o.prototype,"inTangent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),c=le(o.prototype,"outTangent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new t}}),r=o))||r;if(t===Fn){var p=_.prototype.lerp;_.prototype.lerp=function(e,t,n){var i=p.call(this,e,t,n);return Fn.normalize(i,i),i}}return _}var qF=e("CubicSplineVec2Value",jF("cc.CubicSplineVec2Value",Kn,Kn.multiplyScalar,Kn.scaleAndAdd));u.CubicSplineVec2Value=qF;var XF=e("CubicSplineVec3Value",jF("cc.CubicSplineVec3Value",In,In.multiplyScalar,In.scaleAndAdd));u.CubicSplineVec3Value=XF;var YF=e("CubicSplineVec4Value",jF("cc.CubicSplineVec4Value",$n,$n.multiplyScalar,$n.scaleAndAdd));u.CubicSplineVec4Value=YF;var KF=e("CubicSplineQuatValue",jF("cc.CubicSplineQuatValue",Fn,Fn.multiplyScalar,Fn.scaleAndAdd));u.CubicSplineQuatValue=KF;var QF=e("CubicSplineNumberValue",mc("cc.CubicSplineNumberValue")((zF=function(){function e(e,t,n){ce(this,"dataPoint",LF,this),ce(this,"inTangent",BF,this),ce(this,"outTangent",FF,this),this.dataPoint=e,this.inTangent=t,this.outTangent=n}var t=e.prototype;return t.lerp=function(e,t,n){var i=this.dataPoint,r=e.dataPoint,o=t*t*t,a=t*t;return i*(2*o-3*a+1)+this.outTangent*n*(o-2*a+t)+r*(-2*o+3*a)+e.inTangent*n*(o-a)},t.getNoLerp=function(){return this.dataPoint},e}(),LF=le((NF=zF).prototype,"dataPoint",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),BF=le(NF.prototype,"inTangent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),FF=le(NF.prototype,"outTangent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MF=NF))||MF);u.CubicSplineNumberValue=QF;var ZF,JF,$F,ez,tz,nz,iz,rz,oz,az,sz,cz,lz,uz,hz,fz,_z,pz,dz,mz,vz,gz,yz,xz,Sz,Tz,bz,Ez=Symbol("CreateEval"),Cz=Symbol("NormalizedFollow"),Az=Symbol("ConvertAsTrsPath"),wz=Symbol("TrackBinding"),Pz=mc("cc.animation.TrackPath")((ez=function(){function e(){ce(this,"_paths",$F,this)}var t=e.prototype;return t.toProperty=function(e){return this._paths.push(e),this},t.toElement=function(e){return this._paths.push(e),this},t.toHierarchy=function(e){return this._paths.push(new UF(e)),this},t.toComponent=function(e){var t=new kF("string"==typeof e?e:rt.getClassName(e));return this._paths.push(t),this},t.toCustomized=function(e){return this._paths.push(e),this},t.append=function(){for(var e,t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];var r=(e=this._paths).concat.apply(e,n.map((function(e){return e._paths})));return this._paths=r,this},t.isPropertyAt=function(e){return"string"==typeof this._paths[e]},t.parsePropertyAt=function(e){return this._paths[e]},t.isElementAt=function(e){return"number"==typeof this._paths[e]},t.parseElementAt=function(e){return this._paths[e]},t.isHierarchyAt=function(e){return this._paths[e]instanceof UF},t.parseHierarchyAt=function(e){return this.isHierarchyAt(e),this._paths[e].path},t.isComponentAt=function(e){return this._paths[e]instanceof kF},t.parseComponentAt=function(e){return this.isComponentAt(e),this._paths[e].component},t.slice=function(t,n){var i=new e;return i._paths=this._paths.slice(t,n),i},t.trace=function(e,t,n){var i,r;return null!==(i=t)&&void 0!==i||(t=0),null!==(r=n)&&void 0!==r||(n=this._paths.length),this[Cz](e,t,n)},t[Az]=function(){for(var e,t=this._paths,n=t.length,i=0,r="";i<n;++i){var o=t[i];if(!(o instanceof UF))break;o.path&&(r?r+="/"+o.path:r=o.path)}if(i===n)return null;if(i!==n-1)return null;switch(t[i]){case"position":case"scale":case"rotation":case"eulerAngles":e=t[i];break;default:return null}return{node:r,property:e}},t[Cz]=function(e,t,n){for(var i=this._paths,r=e,o=t;o<n;++o){var a=i[o];if(mF(a)){if(!(a in r))return D(3929,a),null;r=r[a]}else r=a.get(r);if(null===r)break}return r},Z(e,[{key:"length",get:function(){return this._paths.length}}]),e}(),$F=le((JF=ez).prototype,"_paths",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ZF=JF))||ZF,Rz=mc("cc.animation.TrackBinding")(tz=Ac((oz=function(){function e(){ce(this,"path",iz,this),ce(this,"proxy",rz,this)}var t=e.prototype;return t.parseTrsPath=function(){return this.proxy?null:this.path[Az]()},t.createRuntimeBinding=function(e,t,n){var i=this.path,r=this.proxy,o=i.length,a=o-1;if(0===o||!i.isPropertyAt(a)&&!i.isElementAt(a)||r){if(r){var s=i[Cz](e,0,o);if(null===s)return null;var c=r.forTarget(s),l={setValue:function(e){c.set(e)}},u=c.get;return u&&(l.getValue=function(){return u.call(c)}),l}return M(3921),null}var h,f=i.isPropertyAt(a)?i.parsePropertyAt(a):i.parseElementAt(a),_=i[Cz](e,0,o-1);return null===_?null:t&&_ instanceof qC&&("position"===(h=f)||"rotation"===h||"scale"===h||"eulerAngles"===h)?t.createPoseWriter(_,f,n):{setValue:function(e){_[f]=e},getValue:function(){return _[f]}}},e}(),iz=le((nz=oz).prototype,"path",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pz}}),rz=le(nz.prototype,"proxy",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),tz=nz))||tz)||tz,Iz=mc("cc.animation.Track")((lz=function(){function e(){ce(this,"_binding",cz,this)}var t=e.prototype;return t.channels=function(){return[]},t.range=function(){for(var e,t={min:1/0,max:-1/0},n=se(this.channels());!(e=n()).done;){var i=e.value;t.min=Math.min(t.min,i.curve.rangeMin),t.max=Math.max(t.max,i.curve.rangeMax)}return t},Z(e,[{key:"path",get:function(){return this._binding.path},set:function(e){this._binding.path=e}},{key:"proxy",get:function(){return this._binding.proxy},set:function(e){this._binding.proxy=e}},{key:wz,get:function(){return this._binding}}]),e}(),cz=le((sz=lz).prototype,"_binding",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Rz}}),az=sz))||az,Dz=mc("cc.animation.Channel")((_z=function(){function e(e){this.name="",ce(this,"_curve",fz,this),this._curve=e}return Z(e,[{key:"curve",get:function(){return this._curve}}]),e}(),fz=le((hz=_z).prototype,"_curve",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uz=hz))||uz,Oz=mc("cc.animation.SingleChannelTrack")((vz=function(e){function t(){var t;return ce(t=e.call(this)||this,"_channel",mz,oe(t)),t._channel=new Dz(t.createCurve()),t}$(t,e);var n=t.prototype;return n.channels=function(){return[this._channel]},n.createCurve=function(){throw new Error("Not impl")},n[Ez]=function(){var e=this._channel.curve;return new Mz(e)},Z(t,[{key:"channel",get:function(){return this._channel}}]),t}(Iz),mz=le((dz=vz).prototype,"_channel",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),pz=dz))||pz,Mz=function(){function e(e){this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e)},e}(),Nz=mc("cc.animation.RealTrack")(gz=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t.prototype.createCurve=function(){return new v_},t}(Oz))||gz;function Lz(e){return 0===e.keyFramesCount?void 0:e}var Bz,Fz,zz,Uz,kz,Gz,Hz,Vz,Wz,jz,qz=["X","Y","Z","W"],Xz=mc("cc.animation.VectorTrack")((bz=function(e){function t(){var t;ce(t=e.call(this)||this,"_channels",Sz,oe(t)),ce(t,"_nComponents",Tz,oe(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Dz(new v_);i.name=qz[n],t._channels[n]=i}return t}$(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Ez]=function(){switch(this._nComponents){default:case 2:return new Yz(Lz(this._channels[0].curve),Lz(this._channels[1].curve));case 3:return new Kz(Lz(this._channels[0].curve),Lz(this._channels[1].curve),Lz(this._channels[2].curve));case 4:return new Qz(Lz(this._channels[0].curve),Lz(this._channels[1].curve),Lz(this._channels[2].curve),Lz(this._channels[3].curve))}},Z(t,[{key:"componentsCount",get:function(){return this._nComponents},set:function(e){this._nComponents=e}}]),t}(Iz),Sz=le((xz=bz).prototype,"_channels",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Tz=le(xz.prototype,"_nComponents",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 4}}),yz=xz))||yz,Yz=function(){function e(e,t){this._result=new Kn,this._x=e,this._y=t}return e.prototype.evaluate=function(e,t){return this._x&&this._y||!t.getValue||Kn.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._result},e}(),Kz=function(){function e(e,t,n){this._result=new In,this._x=e,this._y=t,this._z=n}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z||!t.getValue||In.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._result},e}(),Qz=function(){function e(e,t,n,i){this._result=new $n,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||$n.copy(this._result,t.getValue()),this._x&&(this._result.x=this._x.evaluate(e)),this._y&&(this._result.y=this._y.evaluate(e)),this._z&&(this._result.z=this._z.evaluate(e)),this._w&&(this._result.w=this._w.evaluate(e)),this._result},e}(),Zz=mc("cc.animation.QuatTrack")(Bz=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.createCurve=function(){return new ip},n[Ez]=function(){return new Jz(this.channels()[0].curve)},t}(Oz))||Bz,Jz=function(){function e(e){this._result=new Fn,this._curve=e}return e.prototype.evaluate=function(e){return this._curve.evaluate(e,this._result),this._result},e}(),$z=["Red","Green","Blue","Alpha"],eU=mc("cc.animation.ColorTrack")((kz=function(e){function t(){var t;ce(t=e.call(this)||this,"_channels",Uz,oe(t)),t._channels=new Array(4);for(var n=0;n<t._channels.length;++n){var i=new Dz(new v_);i.name=$z[n],t._channels[n]=i}return t}$(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Ez]=function(){return new tU(Lz(this._channels[0].curve),Lz(this._channels[1].curve),Lz(this._channels[2].curve),Lz(this._channels[3].curve))},t}(Iz),Uz=le((zz=kz).prototype,"_channels",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Fz=zz))||Fz,tU=function(){function e(e,t,n,i){this._result=new Pn,this._x=e,this._y=t,this._z=n,this._w=i}return e.prototype.evaluate=function(e,t){return this._x&&this._y&&this._z&&this._w||!t.getValue||Pn.copy(this._result,t.getValue()),this._x&&(this._result.r=this._x.evaluate(e)),this._y&&(this._result.g=this._y.evaluate(e)),this._z&&(this._result.b=this._z.evaluate(e)),this._w&&(this._result.a=this._w.evaluate(e)),this._result},e}(),nU=["Width","Height"],iU=mc("cc.animation.SizeTrack")((Wz=function(e){function t(){var t;ce(t=e.call(this)||this,"_channels",Vz,oe(t)),t._channels=new Array(2);for(var n=0;n<t._channels.length;++n){var i=new Dz(new v_);i.name=nU[n],t._channels[n]=i}return t}$(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Ez]=function(){return new rU(Lz(this._channels[0].curve),Lz(this._channels[1].curve))},t}(Iz),Vz=le((Hz=Wz).prototype,"_channels",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),Gz=Hz))||Gz,rU=function(){function e(e,t){this._result=new ni,this._width=e,this._height=t}return e.prototype.evaluate=function(e,t){if((!this._width||!this._height)&&t.getValue){var n=t.getValue();this._result.x=n.x,this._result.y=n.y}return this._width&&(this._result.width=this._width.evaluate(e)),this._height&&(this._result.height=this._height.evaluate(e)),this._result},e}(),oU=mc("cc.animation.ObjectTrack")(jz=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t.prototype.createCurve=function(){return new gp},t}(Oz))||jz,aU=Symbol("[[Owner]]");function sU(e){e[aU]}var cU,lU,uU,hU,fU,_U,pU,dU,mU,vU,gU,yU,xU,SU,TU,bU,EU,CU,AU,wU=function(e){function t(t){var n;return(n=e.call(this,t+" transition is invalid")||this).name="TransitionRejectError",n}return $(t,e),t}(re(Error)),PU=function(e){function t(t){return e.call(this,"Graph variable "+t+" is not defined")||this}return $(t,e),t}(re(Error)),RU=function(e){function t(t,n,i){return e.call(this,"Expect graph variable "+t+" to have type '"+n+"' instead of received '"+(null!=i?i:typeof i)+"'")||this}return $(t,e),t}(re(Error)),IU=Symbol("[[createEval]]"),DU=Symbol("[[Outgoing transitions]]"),OU=Symbol("[[Incoming transitions]]"),MU=mc("cc.animation.State")((hU=function(e){function t(){var t;return ce(t=e.call(this)||this,"name",uU,oe(t)),t[DU]=[],t[OU]=[],t}return $(t,e),t}(fl),uU=le((lU=hU).prototype,"name",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),cU=lU))||cU,NU=mc("cc.animation.InteractiveState")((dU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_components",pU,oe(t)),t}$(t,e);var n=t.prototype;return n.addComponent=function(e){var t=new e;return this._components.push(t),t},n.removeComponent=function(e){_e(this._components,e)},n.instantiateComponents=function(){return this._components.map((function(e){return tf(e)}))},Z(t,[{key:"components",get:function(){return this._components}}]),t}(MU),pU=le((_U=dU).prototype,"_components",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fU=_U))||fU;!function(e){e[e.FLOAT=0]="FLOAT",e[e.BOOLEAN=1]="BOOLEAN",e[e.TRIGGER=2]="TRIGGER",e[e.INTEGER=3]="INTEGER"}(AU||(AU={}));var LU,BU,FU,zU,UU,kU=mc("cc.animation.BindableNumber")((xU=function(){function e(e){void 0===e&&(e=0),ce(this,"variable",gU,this),ce(this,"value",yU,this),this.value=e}return e.prototype.clone=function(){var t=new e;return t.value=this.value,t.variable=this.variable,t},e}(),gU=le((vU=xU).prototype,"variable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yU=le(vU.prototype,"value",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),mU=vU))||mU,GU=mc("cc.animation.BindableBoolean")((CU=function(){function e(e){void 0===e&&(e=!1),ce(this,"variable",bU,this),ce(this,"value",EU,this),this.value=e}return e.prototype.clone=function(){var t=new e;return t.value=this.value,t.variable=this.variable,t},e}(),bU=le((TU=CU).prototype,"variable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),EU=le(TU.prototype,"value",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),SU=TU))||SU;function HU(e,t,n,i,r){var o=t.variable,a=t.value;if(!o)return a;var s=e.getVar(o);if(!WU(s,o))return a;if(s.type!==n)throw new RU(o,"number");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function VU(e,t,n,i,r){var o=t.variable,a=t.value;if(!o)return a;var s=e.getVar(o);if(!WU(s,o))return a;if(n!==AU.FLOAT&&n!==AU.INTEGER)throw new RU(o,"number or integer");for(var c=arguments.length,l=new Array(c>5?c-5:0),u=5;u<c;u++)l[u-5]=arguments[u];var h=s.bind.apply(s,[i,r].concat(l));return h}function WU(e,t){if(e)return!0;throw new PU(t)}var jU,qU,XU,YU,KU,QU,ZU,JU,$U,ek,tk,nk,ik,rk,ok,ak,sk,ck,lk,uk,hk,fk,_k,pk,dk,mk,vk,gk,yk,xk,Sk,Tk,bk,Ek,Ck,Ak,wk,Pk,Rk,Ik,Dk,Ok,Mk,Nk=mc("cc.animation.Motion")((UU=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"motion",FU,oe(t)),ce(t,"speed",zU,oe(t)),t}return $(t,e),t.prototype.clone=function(){var e,n,i=new t;return i.motion=null!==(e=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==e?e:null,i.speed=this.speed.clone(),i},t}(NU),FU=le((BU=UU).prototype,"motion",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zU=le(BU.prototype,"speed",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kU(1)}}),LU=BU))||LU,Lk=Symbol("[[OnAfterDeserialized]]"),Bk=mc("cc.animation.Transition")((QU=function(e){function t(t,n,i){var r;return ce(r=e.call(this)||this,"from",XU,oe(r)),ce(r,"to",YU,oe(r)),ce(r,"conditions",KU,oe(r)),r[aU]=void 0,r.from=t,r.to=n,i&&(r.conditions=i),r}return $(t,e),t}(fl),XU=le((qU=QU).prototype,"from",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),YU=le(qU.prototype,"to",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),KU=le(qU.prototype,"conditions",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jU=qU))||jU,Fk=mc("cc.animation.AnimationTransition")((ik=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"duration",$U,oe(t)),ce(t,"relativeDuration",ek,oe(t)),ce(t,"exitConditionEnabled",tk,oe(t)),ce(t,"_exitCondition",nk,oe(t)),t}return $(t,e),Z(t,[{key:"exitCondition",get:function(){return this._exitCondition},set:function(e){this._exitCondition=e}}]),t}(Bk),$U=le((JU=ik).prototype,"duration",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),ek=le(JU.prototype,"relativeDuration",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tk=le(JU.prototype,"exitConditionEnabled",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),nk=le(JU.prototype,"_exitCondition",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),ZU=JU))||ZU;function zk(e){return e instanceof Fk}var Uk,kk=mc("cc.animation.StateMachine")((hk=function(e){$(n,e);var t=n.prototype;function n(){var t;return ce(t=e.call(this)||this,"_states",ak,oe(t)),ce(t,"_transitions",sk,oe(t)),ce(t,"_entryState",ck,oe(t)),ce(t,"_exitState",lk,oe(t)),ce(t,"_anyState",uk,oe(t)),t._entryState=t._addState(new MU),t._entryState.name="Entry",t._exitState=t._addState(new MU),t._exitState.name="Exit",t._anyState=t._addState(new MU),t._anyState.name="Any",t}return t.__callOnAfterDeserializeRecursive=function(){this[Lk]();for(var e=this._states.length,t=0;t<e;++t){var n=this._states[t];n instanceof Gk&&n.stateMachine.__callOnAfterDeserializeRecursive()}},t[Lk]=function(){this._states.forEach((function(){})),this._transitions.forEach((function(e){e.from[DU].push(e),e.to[OU].push(e)}))},t[IU]=function(){throw new Error("Method not implemented.")},t.states=function(){return this._states},t.transitions=function(){return this._transitions},t.getTransitionsBetween=function(e,t){return sU(e),sU(t),e[DU].filter((function(e){return e.to===t}))},t.getOutgoings=function(e){return sU(e),e[DU]},t.getIncomings=function(e){return sU(e),e[OU]},t.addMotion=function(){return this._addState(new Nk)},t.addSubStateMachine=function(){return this._addState(new Gk)},t.remove=function(e){sU(e),e!==this.entryState&&e!==this.exitState&&e!==this.anyState&&(this.eraseTransitionsIncludes(e),_e(this._states,e))},t.connect=function(e,t,n){if(sU(e),sU(t),t===this.entryState)throw new wU("to-entry");if(t===this.anyState)throw new wU("to-any");if(e===this.exitState)throw new wU("from-exit");var i=e instanceof Nk||e===this._anyState?new Fk(e,t,n):new Bk(e,t,n);return this._transitions.push(i),e[DU].push(i),t[OU].push(i),i},t.disconnect=function(e,t){sU(e),sU(t);for(var n=e[DU],i=t[OU],r=this._transitions,o=n.filter((function(e){return e.to===t})),a=o.length,s=function(e){var t=o[e];_e(n,t),_e(r,t),pe(i,(function(e){return e===t}))},c=0;c<a;++c)s(c)},t.removeTransition=function(e){_e(this._transitions,e),pe(e.from[DU],(function(t){return t===e})),pe(e.to[OU],(function(t){return t===e}))},t.eraseOutgoings=function(e){var t=this;sU(e);for(var n=e[DU],i=function(e){var i=n[e],r=i.to;_e(t._transitions,i),pe(r[OU],(function(e){return e===i}))},r=0;r<n.length;++r)i(r);n.length=0},t.eraseIncomings=function(e){var t=this;sU(e);for(var n=e[OU],i=function(e){var i=n[e],r=i.from;_e(t._transitions,i),pe(r[DU],(function(e){return e===i}))},r=0;r<n.length;++r)i(r);n.length=0},t.eraseTransitionsIncludes=function(e){this.eraseIncomings(e),this.eraseOutgoings(e)},t.clone=function(){for(var e,t=new n,i=new Map,r=se(this._states);!(e=r()).done;){var o=e.value;switch(o){case this._entryState:i.set(o,t._entryState);break;case this._exitState:i.set(o,t._exitState);break;case this._anyState:i.set(o,t._anyState);break;default:if(o instanceof Nk||o instanceof Gk){var a=o.clone();t._addState(a),i.set(o,a)}}}for(var s,c=se(this._transitions);!(s=c()).done;){var l=s.value,u=i.get(l.from),h=i.get(l.to),f=t.connect(u,h);f.conditions=l.conditions.map((function(e){return e.clone()})),f instanceof Fk&&(f.duration=l.duration,f.exitConditionEnabled=l.exitConditionEnabled,f.exitCondition=l.exitCondition)}return t},t._addState=function(e){return this._states.push(e),e},Z(n,[{key:"entryState",get:function(){return this._entryState}},{key:"exitState",get:function(){return this._exitState}},{key:"anyState",get:function(){return this._anyState}}]),n}(fl),ak=le((ok=hk).prototype,"_states",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),sk=le(ok.prototype,"_transitions",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ck=le(ok.prototype,"_entryState",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),lk=le(ok.prototype,"_exitState",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),uk=le(ok.prototype,"_anyState",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),rk=ok))||rk,Gk=mc("cc.animation.SubStateMachine")((dk=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_stateMachine",pk,oe(t)),t}return $(t,e),t.prototype.clone=function(){var e=new t;return e._stateMachine=this._stateMachine.clone(),e},Z(t,[{key:"stateMachine",get:function(){return this._stateMachine}}]),t}(NU),pk=le((_k=dk).prototype,"_stateMachine",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kk}}),fk=_k))||fk,Hk=mc("cc.animation.Layer")((bk=function(){function e(){this[aU]=void 0,ce(this,"_stateMachine",gk,this),ce(this,"name",yk,this),ce(this,"weight",xk,this),ce(this,"mask",Sk,this),ce(this,"blending",Tk,this),this._stateMachine=new kk}return Z(e,[{key:"stateMachine",get:function(){return this._stateMachine}}]),e}(),gk=le((vk=bk).prototype,"_stateMachine",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),yk=le(vk.prototype,"name",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xk=le(vk.prototype,"weight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Sk=le(vk.prototype,"mask",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Tk=le(vk.prototype,"blending",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uk.additive}}),mk=vk))||mk;!function(e){e[e.override=0]="override",e[e.additive=1]="additive"}(Uk||(Uk={}));var Vk=mc("cc.animation.Variable")((Pk=function(){function e(e){if(ce(this,"_type",Ak,this),ce(this,"_value",wk,this),void 0!==e)switch(this._type=e,e){default:break;case AU.FLOAT:case AU.INTEGER:this._value=0;break;case AU.BOOLEAN:case AU.TRIGGER:this._value=!1}}return Z(e,[{key:"type",get:function(){return this._type}},{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),Ak=le((Ck=Pk).prototype,"_type",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return AU.FLOAT}}),wk=le(Ck.prototype,"_value",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ek=Ck))||Ek,Wk=mc("cc.animation.AnimationGraph")((Mk=function(e){function t(){var t;return ce(t=e.call(this)||this,"_layers",Dk,oe(t)),ce(t,"_variables",Ok,oe(t)),t}$(t,e);var n=t.prototype;return n.onLoaded=function(){for(var e=this._layers,t=e.length,n=0;n<t;++n)e[n].stateMachine.__callOnAfterDeserializeRecursive()},n.addLayer=function(){var e=new Hk;return this._layers.push(e),e},n.removeLayer=function(e){it.removeAt(this._layers,e)},n.moveLayer=function(e,t){!function(e,t,n){if(at(e,t),at(e,n),t===n)return e;var i=e[t];if(t<n)for(var r=t+1;r<=n;++r)e[r-1]=e[r];else for(var o=t;o!==n;--o)e[o]=e[o-1];e[n]=i}(this._layers,e,t)},n.addVariable=function(e,t,n){var i=new Vk(t);void 0!==n&&(i.value=n),this._variables[e]=i},n.removeVariable=function(e){delete this._variables[e]},n.getVariable=function(e){return this._variables[e]},Z(t,[{key:"layers",get:function(){return this._layers}},{key:"variables",get:function(){return Object.entries(this._variables)}}]),t}(Nu),Dk=le((Ik=Mk).prototype,"_layers",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),Ok=le(Ik.prototype,"_variables",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),Rk=Ik))||Rk,jk=Symbol("BakeNodeCurves"),qk=e("SkelAnimDataHub",function(){function e(){}return e.getOrExtract=function(t){var n=e.pool.get(t);if(!n||n.samples!==t.sample){n&&u.director.root.dataPoolManager.releaseAnimationClip(t);var i=Math.ceil(t.sample*t.duration)+1,r=t.sample;n=t[jk](0,r,i),e.pool.set(t,n)}return n},e.destroy=function(t){e.pool.delete(t)},e}());qk.pool=new Map;var Xk=e("RatioSampler",function(){function e(e){var t,n;this.ratios=void 0,this._findRatio=void 0,this.ratios=e;for(var i=!0,r=1,o=e.length;r<o;r++)if(t=e[r]-e[r-1],1===r)n=t;else if(Math.abs(t-n)>1e-6){i=!1;break}this._findRatio=i?Zk:sc}return e.prototype.sample=function(e){return this._findRatio(this.ratios,e)},e}());u.RatioSampler=Xk;var Yk=e("AnimCurve",function(){function e(t,n){this.types=void 0,this.type=null,this._values=[],this._lerp=void 0,this._duration=void 0,this._array=void 0,this._duration=n,this._values=t.values;var i=function(t){return"string"==typeof t?t:Array.isArray(t)?t[0]===t[1]&&t[2]===t[3]?e.Linear:e.Bezier(t):e.Linear};if(void 0!==t.easingMethod)this.type=i(t.easingMethod);else if(Array.isArray(t.easingMethods))this.types=t.easingMethods.map(i);else if(void 0!==t.easingMethods){this.types=new Array(this._values.length).fill(null);for(var r=0,o=Object.keys(t.easingMethods);r<o.length;r++){var a=o[r];this.types[a]=i(t.easingMethods[a])}}else this.type=null;var s=t.values[0];(void 0===t.interpolate||t.interpolate)&&(this._lerp=aG(s)),void 0!==t._arrayLength&&(this._array=new Array(t._arrayLength))}e.Bezier=function(e){return e};var t=e.prototype;return t.hasLerp=function(){return!!this._lerp},t.valueAt=function(e){if(void 0===this._array){var t=this._values[e];return t&&t.getNoLerp?t.getNoLerp():t}for(var n=0;n<this._array.length;++n)this._array[n]=this._values[this._array.length*e+n];return this._array},t.valueBetween=function(e,t,n,i,r){if(this._lerp){var o=this.types?this.types[t]:this.type,a=r-n,s=(e-n)/a;if(o&&(s=Qk(s,o)),void 0===this._array){var c=this._values[t],l=this._values[i];return this._lerp(c,l,s,a*this._duration)}for(var u=0;u<this._array.length;++u){var h=this._values[this._array.length*t+u],f=this._values[this._array.length*i+u];this._array[u]=this._lerp(h,f,s,a*this._duration)}return this._array}if(void 0===this._array)return this.valueAt(t);for(var _=0;_<this._array.length;++_)this._array[_]=this._values[this._array.length*t+_];return this._array},t.empty=function(){return 0===this._values.length},t.constant=function(){return 1===this._values.length},e}());function Kk(e,t,n){var i=t.sample(n);if(i<0)if((i=~i)<=0)i=0;else{if(!(i>=t.ratios.length))return e.valueBetween(n,i-1,t.ratios[i-1],i,t.ratios[i]);i=t.ratios.length-1}return e.valueAt(i)}function Qk(e,t){if("string"==typeof t){var n=i_[t];n?e=n(e):M(3906,t)}else Array.isArray(t)&&(e=$_(t,e));return e}function Zk(e,t){var n=e.length-1;if(0===n)return 0;var i=e[0];if(t<i)return 0;var r=e[n];if(t>r)return n;var o=(t=(t-i)/(r-i))/(1/n),a=0|o,s=1e-6;return o-a<s?a:a+1-o<s?a+1:~(a+1)}Yk.Linear=null,u.AnimCurve=Yk,e("EventInfo",function(){function e(){this.events=[]}return e.prototype.add=function(e,t){this.events.push({func:e||"",params:t||[]})},e}()),u.sampleAnimationCurve=Kk;var Jk,$k,eG,tG,nG,iG,rG,oG,aG=function(){function e(e,t,n,i){return e.lerp(t,n,i)}return function(t){if(null!==t){if("number"==typeof t)return hn;if("object"==typeof t&&t.constructor){if(t instanceof Fn)return n=new Fn,function(e,t,i){return Fn.slerp(n,e,t,i)};if(t instanceof ht)return function(e){var t=new e;return function(n,i,r){return e.lerp(t,n,i,r),t}}(t.constructor);if(t.constructor===Number)return hn;if("function"==typeof t.lerp)return e}var n}}}(),sG=mc("cc.animation.UntypedTrackChannel")((tG=function(e){function t(){var t;return ce(t=e.call(this,new v_)||this,"property",eG,oe(t)),t}return $(t,e),t}(Dz),eG=le(($k=tG).prototype,"property",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),Jk=$k))||Jk,cG=mc("cc.animation.UntypedTrack")((oG=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_channels",rG,oe(t)),t}$(t,e);var n=t.prototype;return n.channels=function(){return this._channels},n[Ez]=function(e){var t=this;if(!e.getValue)throw new Error(F(3930));var n=function(e){var n;return null===(n=t._channels.find((function(t){return t.property===e})))||void 0===n?void 0:n.curve},i=e.getValue();switch(!0){default:throw new Error(F(3931));case i instanceof Kn:return new Yz(n("x"),n("y"));case i instanceof In:return new Kz(n("x"),n("y"),n("z"));case i instanceof $n:return new Qz(n("x"),n("y"),n("z"),n("w"));case i instanceof Pn:return new tU(n("r"),n("g"),n("b"),n("a"));case i instanceof ni:return new rU(n("width"),n("height"))}},n.addChannel=function(e){var t=new sG;return t.property=e,this._channels.push(t),t},n.upgrade=function(e){var t=this,n=function(e,n){var i=t.channels().find((function(t){return t.property===e}));i&&(n.name=i.name,n.curve.assignSorted(Array.from(i.curve.times()),Array.from(i.curve.values())))},i=e(this.path,this.proxy);switch(i){default:break;case"vec2":case"vec3":case"vec4":var r=new Xz;r.path=this.path,r.proxy=this.proxy,r.componentsCount="vec2"===i?2:"vec3"===i?3:4;var o=r.channels(),a=o[0],s=o[1],c=o[2],l=o[3];switch(i){case"vec4":n("w",l);case"vec3":n("z",c);default:case"vec2":n("x",a),n("y",s)}return r;case"color":var u=new eU,h=u.channels(),f=h[0],_=h[1],p=h[2],d=h[3];return n("r",f),n("g",_),n("b",p),n("a",d),n("x",f),n("y",_),n("z",p),n("w",d),u;case"size":}return null},t}(Iz),rG=le((iG=oG).prototype,"_channels",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nG=iG))||nG,lG=function(){function e(e){this._keys=[],this._curves=[],this._commonTargets=[],this._ratioSamplers=[],this._runtimeCurves=void 0,this._data=null,this._duration=void 0,this._duration=e}var t=e.prototype;return t.getPropertyCurves=function(){return this._runtimeCurves||this._createPropertyCurves(),this._runtimeCurves},t.toTracks=function(){for(var e,t=[],n=this.keys,i=this.curves,r=this.commonTargets,o=function(e,t,n){for(var i,r=new Pz,o=se(t);!(i=o()).done;){var a=i.value;"string"==typeof a?r.toProperty(a):"number"==typeof a?r.toElement(a):a instanceof UF?r.toHierarchy(a.path):a instanceof kF?r.toComponent(a.component):r.toCustomized(a)}e.path=r,e.proxy=n},a=r.map((function(e){var n=new cG;return o(n,e.modifiers,e.valueAdapter),t.push(n),n})),s=function(){var i,r=e.value,s=r.data,c=s.values;if(0===c.length)return"continue";var l=s.keys<0?[0]:n[s.keys],u=c[0],h=null===(i=s.interpolate)||void 0===i||i;s._arrayLength;var f=new hG(s,l.length),_=function(e){o(e,r.modifiers,r.valueAdapter)},p=void 0;if("number"==typeof r.commonTarget){if(!c.every((function(e){return"number"==typeof e})))return D(3932),"continue";if(r.valueAdapter||1!==r.modifiers.length||"string"!=typeof r.modifiers[0])return D(3933),"continue";var d=r.modifiers[0],m=a[r.commonTarget].addChannel(d).curve;p=m}!function(){if("number"==typeof u){if(!c.every((function(e){return"number"==typeof e})))return void D(3934);var e;if(p)e=p;else{var n=new Nz;_(n),t.push(n),e=n.channel.curve}var i=h?rl.LINEAR:rl.CONSTANT;return e.assignSorted(l,c.map((function(e){return{value:e,interpolationMode:i}}))),void f.convert(e)}if("object"==typeof u)switch(!0){default:break;case uG(c,Kn):case uG(c,In):case uG(c,$n):var r=u instanceof Kn?2:u instanceof In?3:4,o=new Xz;_(o),o.componentsCount=r;var a=o.channels(),s=a[0].curve,d=a[1].curve,m=a[2].curve,v=a[3].curve,g=h?rl.LINEAR:rl.CONSTANT,y=function(e){return{value:e,interpolationMode:g}};switch(r){case 4:v.assignSorted(l,c.map((function(e){return y(e.w)}))),f.convert(v);case 3:m.assignSorted(l,c.map((function(e){return y(e.z)}))),f.convert(m);default:s.assignSorted(l,c.map((function(e){return y(e.x)}))),f.convert(s),d.assignSorted(l,c.map((function(e){return y(e.y)}))),f.convert(d)}return void t.push(o);case uG(c,Fn):var x=new Zz;_(x);var S=h?q_.SLERP:q_.CONSTANT;return x.channel.curve.assignSorted(l,c.map((function(e){return{value:Fn.clone(e),interpolationMode:S}}))),f.convertQuatCurve(x.channel.curve),void t.push(x);case uG(c,Pn):var T=new eU;_(T);var b=T.channels(),E=b[0].curve,C=b[1].curve,A=b[2].curve,w=b[3].curve,P=h?rl.LINEAR:rl.CONSTANT,R=function(e){return{value:e,interpolationMode:P}};return E.assignSorted(l,c.map((function(e){return R(e.r)}))),f.convert(E),C.assignSorted(l,c.map((function(e){return R(e.g)}))),f.convert(C),A.assignSorted(l,c.map((function(e){return R(e.b)}))),f.convert(A),w.assignSorted(l,c.map((function(e){return R(e.a)}))),f.convert(w),void t.push(T);case uG(c,ni):var I=new iU;_(I);var O=I.channels(),M=O[0].curve,N=O[1].curve,L=h?rl.LINEAR:rl.CONSTANT,B=function(e){return{value:e,interpolationMode:L}};return M.assignSorted(l,c.map((function(e){return B(e.width)}))),f.convert(M),N.assignSorted(l,c.map((function(e){return B(e.height)}))),f.convert(N),void t.push(I);case uG(c,QF):var F=new Nz;_(F);var z=h?rl.CUBIC:rl.CONSTANT;return F.channel.curve.assignSorted(l,c.map((function(e){return{value:e.dataPoint,leftTangent:e.inTangent,rightTangent:e.outTangent,interpolationMode:z}}))),void t.push(F);case uG(c,qF):case uG(c,XF):case uG(c,YF):var U=u instanceof qF?2:u instanceof XF?3:4,k=new Xz;_(k),k.componentsCount=U;var G=k.channels(),H=G[0],V=G[1],W=G[2],j=G[3],q=h?rl.LINEAR:rl.CONSTANT,X=function(e,t,n){return{value:e,leftTangent:t,rightTangent:n,interpolationMode:q}};switch(U){case 4:j.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.w,e.inTangent.w,e.outTangent.w)})));case 3:W.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.z,e.inTangent.z,e.outTangent.z)})));default:H.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.y,e.inTangent.y,e.outTangent.y)}))),V.curve.assignSorted(l,c.map((function(e){return X(e.dataPoint.x,e.inTangent.x,e.outTangent.x)})))}return void t.push(k);case c.every((function(e){return e instanceof KF})):D(3935)}var Y=new oU;_(Y),Y.channel.curve.assignSorted(l,c),t.push(Y)}()},c=se(i);!(e=c()).done;)s();return t},t._createPropertyCurves=function(){var e=this;this._ratioSamplers=this._keys.map((function(t){return new Xk(t.map((function(t){return t/e._duration})))})),this._runtimeCurves=this._curves.map((function(t){return{curve:new Yk(t.data,e._duration),modifiers:t.modifiers,valueAdapter:t.valueAdapter,sampler:e._ratioSamplers[t.data.keys],commonTarget:t.commonTarget}}))},Z(e,[{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"curves",get:function(){return this._curves},set:function(e){this._curves=e,delete this._runtimeCurves}},{key:"commonTargets",get:function(){return this._commonTargets},set:function(e){this._commonTargets=e}},{key:"data",get:function(){return this._data}}]),e}();function uG(e,t){return e.every((function(e){return e instanceof t}))}var hG=function(){function e(e,t){this._easingMethods=void 0;var n=e.easingMethods;Array.isArray(n)?0===n.length&&0!==t?this._easingMethods=new Array(t).fill(null):this._easingMethods=n:this._easingMethods=void 0===n?new Array(t).fill(e.easingMethod):Array.from({length:t},(function(e,t){var i;return null!==(i=n[t])&&void 0!==i?i:null}))}var t=e.prototype;return t.convert=function(e){var t,n,i,r,o,a,s,c,l,u,h,f,_,p,d,m,v,g,y,x,S,T,b=this._easingMethods;if(b){var E=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(b)&&b.length;for(var C=E-1,A=0;A<C;++A){var w=b[A];w&&(Array.isArray(w)?(t=w,n=e.getKeyframeTime(A),i=e.getKeyframeValue(A),r=e.getKeyframeTime(A+1),o=e.getKeyframeValue(A+1),a=void 0,s=void 0,c=void 0,l=void 0,u=void 0,h=void 0,f=void 0,_=void 0,p=void 0,d=void 0,m=void 0,v=void 0,g=void 0,y=void 0,x=void 0,S=void 0,T=void 0,s=t[0],c=t[1],l=t[2],u=t[3],h=i.value,f=3*(r-n),_=3*(o.value-h),m=(1-l)*f,v=(1-u)*_,g=1/3,y=(d=c*_)/(p=s*f),x=Math.sqrt(p*p+d*d)*g,S=v/m,T=Math.sqrt(m*m+v*v)*g,i.interpolationMode=rl.CUBIC,i.tangentWeightMode=(a=i.tangentWeightMode)===al.NONE?al.RIGHT:a===al.LEFT?al.BOTH:a,i.rightTangent=y,i.rightTangentWeight=x,o.tangentWeightMode=function(e){return e===al.NONE?al.LEFT:e===al.RIGHT?al.BOTH:e}(o.tangentWeightMode),o.leftTangent=S,o.leftTangentWeight=T):fG(w,e,A))}}}},t.convertQuatCurve=function(e){var t=this._easingMethods;if(t){var n=e.keyFramesCount;if(!(e.keyFramesCount<2)){Array.isArray(t)&&t.length;for(var i=n-1,r=0;r<i;++r){var o=t[r];o&&(Array.isArray(o)?e.getKeyframeValue(r).easingMethod=o.slice():_G(o,e,r))}}}},Z(e,[{key:"nil",get:function(){return!this._easingMethods||this._easingMethods.every((function(e){return null==e}))}}]),e}();function fG(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=VG[e];r===n_.CONSTANT?i.interpolationMode=rl.CONSTANT:(i.interpolationMode=rl.LINEAR,i.easingMethod=r)}function _G(e,t,n){t.keyFramesCount;var i=t.getKeyframeValue(n),r=VG[e];i.easingMethod=r}var pG,dG,mG,vG,gG,yG,xG,SG,TG,bG,EG,CG,AG,wG,PG,RG,IG,DG,OG,MG,NG,LG,BG,FG,zG,UG,kG,GG,HG,VG={constant:n_.CONSTANT,linear:n_.LINEAR,quadIn:n_.QUAD_IN,quadOut:n_.QUAD_OUT,quadInOut:n_.QUAD_IN_OUT,quadOutIn:n_.QUAD_OUT_IN,cubicIn:n_.CUBIC_IN,cubicOut:n_.CUBIC_OUT,cubicInOut:n_.CUBIC_IN_OUT,cubicOutIn:n_.CUBIC_OUT_IN,quartIn:n_.QUART_IN,quartOut:n_.QUART_OUT,quartInOut:n_.QUART_IN_OUT,quartOutIn:n_.QUART_OUT_IN,quintIn:n_.QUINT_IN,quintOut:n_.QUINT_OUT,quintInOut:n_.QUINT_IN_OUT,quintOutIn:n_.QUINT_OUT_IN,sineIn:n_.SINE_IN,sineOut:n_.SINE_OUT,sineInOut:n_.SINE_IN_OUT,sineOutIn:n_.SINE_OUT_IN,expoIn:n_.EXPO_IN,expoOut:n_.EXPO_OUT,expoInOut:n_.EXPO_IN_OUT,expoOutIn:n_.EXPO_OUT_IN,circIn:n_.CIRC_IN,circOut:n_.CIRC_OUT,circInOut:n_.CIRC_IN_OUT,circOutIn:n_.CIRC_OUT_IN,elasticIn:n_.ELASTIC_IN,elasticOut:n_.ELASTIC_OUT,elasticInOut:n_.ELASTIC_IN_OUT,elasticOutIn:n_.ELASTIC_OUT_IN,backIn:n_.BACK_IN,backOut:n_.BACK_OUT,backInOut:n_.BACK_IN_OUT,backOutIn:n_.BACK_OUT_IN,bounceIn:n_.BOUNCE_IN,bounceOut:n_.BOUNCE_OUT,bounceInOut:n_.BOUNCE_IN_OUT,bounceOutIn:n_.BOUNCE_OUT_IN,smooth:n_.SMOOTH,fade:n_.FADE};function WG(){throw new Error("split() only valid in Editor.")}mc("cc.animation.ExoticAnimation")((mG=function(){function e(){ce(this,"_nodeAnimations",dG,this)}var t=e.prototype;return t.createEvaluator=function(e){return new eH(this._nodeAnimations,e)},t.addNodeAnimation=function(e){var t=new jG(e);return this._nodeAnimations.push(t),t},t.collectAnimatedJoints=function(){return Array.from(new Set(this._nodeAnimations.map((function(e){return e.path}))))},t.split=function(){return WG()},t.toHashString=function(){return this._nodeAnimations.map((function(e){return e.toHashString()})).join("\n")},e}(),dG=le((pG=mG).prototype,"_nodeAnimations",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pG));var jG=mc("cc.animation.ExoticNodeAnimation")((bG=function(){function e(e){ce(this,"_path",yG,this),ce(this,"_position",xG,this),ce(this,"_rotation",SG,this),ce(this,"_scale",TG,this),this._path=e}var t=e.prototype;return t.createPosition=function(e,t){this._position=new ZG(e,new KG(t))},t.createRotation=function(e,t){this._rotation=new ZG(e,new QG(t))},t.createScale=function(e,t){this._scale=new ZG(e,new KG(t))},t.createEvaluator=function(e){return new tH(this._path,this._position,this._rotation,this._scale,e)},t.split=function(){return WG()},t.toHashString=function(){var e,t,n,i,r,o;return this._path+"\n"+(null!==(e=null===(t=this._position)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"")+(null!==(n=null===(i=this._scale)||void 0===i?void 0:i.toHashString())&&void 0!==n?n:"")+(null!==(r=null===(o=this._rotation)||void 0===o?void 0:o.toHashString())&&void 0!==r?r:"")},Z(e,[{key:"path",get:function(){return this._path}}]),e}(),yG=le((gG=bG).prototype,"_path",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),xG=le(gG.prototype,"_position",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SG=le(gG.prototype,"_rotation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),TG=le(gG.prototype,"_scale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vG=gG))||vG;function qG(e){return e.toPrecision(2)}function XG(e){return e.map(qG).join(" ")}var YG=mc("cc.animation.ExoticVectorLikeTrackValues")((PG=function(){function e(e){ce(this,"_values",AG,this),ce(this,"_isQuantized",wG,this),this._values=e,this._isQuantized=!1}var t=e.prototype;return t.quantize=function(e){this._isQuantized,this._values=function(e,t){var n=iH[t],i=1<<n.BYTES_PER_ELEMENT,r=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY;e.forEach((function(e){r=Math.min(e,r),o=Math.max(e,o)}));var a=o-r,s=n.from(e,(function(e){return(e-r)/a*i}));return new gH(rH(e),s,a,r)}(this._values,e),this._isQuantized=!0},t.toHashString=function(){var e=this._isQuantized,t=this._values;return e+" "+(e?t.toHashString():XG(t))},Z(e,[{key:"precision",get:function(){return this._isQuantized?this._values.originalPrecision:rH(this._values)}}]),e}(),AG=le((CG=PG).prototype,"_values",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),wG=le(CG.prototype,"_isQuantized",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),EG=CG))||EG,KG=mc("cc.animation.ExoticVec3TrackValues")(RG=function(e){function t(){return e.apply(this,arguments)||this}$(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?SH(n,e,t):In.fromArray(t,n,3*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(SH(a,e,i),SH(a,t,r)):(In.fromArray(i,a,3*e),In.fromArray(r,a,3*t)),In.lerp(o,i,r,n)},t}(YG))||RG,QG=mc("cc.animation.ExoticQuatTrackValues")(IG=function(e){function t(){return e.apply(this,arguments)||this}$(t,e),t.imitate=function(e,n){var i=new t(e);return n._isQuantized&&i.quantize(n._values.quantizationType),i};var n=t.prototype;return n.get=function(e,t){var n=this._values;this._isQuantized?TH(n,e,t):Fn.fromArray(t,n,4*e)},n.lerp=function(e,t,n,i,r,o){var a=this._values;this._isQuantized?(TH(a,e,i),TH(a,t,r)):(Fn.fromArray(i,a,4*e),Fn.fromArray(r,a,4*t)),Fn.slerp(o,i,r,n)},t}(YG))||IG,ZG=mc("cc.animation.ExoticTrack")((LG=function(){function e(e,t){ce(this,"times",MG,this),ce(this,"values",NG,this),this.times=e,this.values=t}return e.prototype.toHashString=function(){var e=this.times,t=this.values;return"times: "+XG(e)+"; values: "+t.toHashString()},e}(),MG=le((OG=LG).prototype,"times",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),NG=le(OG.prototype,"values",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),DG=OG))||DG;function JG(e,t){e.length,e.length;var n=0,i=0,r=sc(e,t);if(r>=0)n=r;else{var o=~r,a=o-1;n=a;var s=e[o],c=e[a];i=(t-c)/(s-c)}return{index:n,ratio:i}}!function(){function e(){this._reset()}var t=e.prototype;t.transformTime=function(e){return e-this._timeOffset},t.calculate=function(e,t,n){this._reset();var i=e.length;if(i){var r=e[0],o=e[i-1],a=ln(t,r,o),s=ln(n,r,o);this._timeOffset=a;var c=function(e,t,n){var i=e.length;n>=t&&t>=e[0]&&e[i-1];var r=JG(e,t),o=r.index,a=r.ratio,s=JG(e,n);return{fromIndex:o,fromRatio:a,toIndex:s.index,toRatio:s.ratio}}(e,a,s),l=c.fromIndex,u=c.fromRatio,h=c.toIndex,f=c.toRatio,_=!u,p=!f;l!==h||u!==f?(_||(this.preLerpIndex=l,this.preLerpRatio=u),this.directKeyframesBegin=_?l:l+1,this.directKeyframesEnd=h+1,p||(this.postLerpIndex=h,this.postLerpRatio=f)):_?(this.directKeyframesBegin=l,this.directKeyframesEnd=l+1):(this.preLerpIndex=l,this.preLerpRatio=u)}},t._reset=function(){this.preLerpIndex=-1,this.preLerpRatio=0,this.directKeyframesBegin=0,this.directKeyframesEnd=0,this.postLerpIndex=-1,this.postLerpRatio=0,this._timeOffset=0},Z(e,[{key:"keyframesCount",get:function(){var e=this.preLerpIndex,t=this.directKeyframesBegin;return 0+(e<0?0:1)+(this.directKeyframesEnd-t)+(this.postLerpIndex<0?0:1)}}])}();var $G,eH=function(){function e(e,t){this._nodeEvaluations=void 0,this._nodeEvaluations=e.map((function(e){return e.createEvaluator(t)}))}return e.prototype.evaluate=function(e){this._nodeEvaluations.forEach((function(t){t.evaluate(e)}))},e}(),tH=function(){function e(e,t,n,i,r){this._position=null,this._rotation=null,this._scale=null,t&&(this._position=xH(t.times,t.values,In,e,"position",r)),n&&(this._rotation=xH(n.times,n.values,Fn,e,"rotation",r)),i&&(this._scale=xH(i.times,i.values,In,e,"scale",r))}return e.prototype.evaluate=function(e){if(this._position){var t=this._position.evaluator.evaluate(e);this._position.runtimeBinding.setValue(t)}if(this._rotation){var n=this._rotation.evaluator.evaluate(e);this._rotation.runtimeBinding.setValue(n)}if(this._scale){var i=this._scale.evaluator.evaluate(e);this._scale.runtimeBinding.setValue(i)}},e}(),nH=function(){function e(e,t,n){this._times=void 0,this._inputSampleResultCache={just:!1,index:-1,nextIndex:-1,ratio:0},this._values=void 0,this._prevValue=void 0,this._nextValue=void 0,this._resultValue=void 0,this._times=e,this._values=t,this._prevValue=new n,this._nextValue=new n,this._resultValue=new n}return e.prototype.evaluate=function(e){var t=this._times,n=this._values,i=this._resultValue;if(0===t.length)return i;var r=function(e,t,n){var i=e.length,r=e[0],o=e[i-1];if(t<r)n.just=!0,n.index=0;else if(t>o)n.just=!0,n.index=i-1;else{var a=sc(e,t);if(a>=0)n.just=!0,n.index=a;else{var s=~a,c=s-1,l=e[c],u=e[s],h=(t-e[c])/(u-l);n.just=!1,n.index=c,n.nextIndex=s,n.ratio=h}}return n}(t,e,this._inputSampleResultCache);return r.just?n.get(r.index,i):n.lerp(r.index,r.nextIndex,r.ratio,this._prevValue,this._nextValue,i),i},e}(),iH={uint8:Uint8Array,uint16:Uint16Array};function rH(e){switch(e.BYTES_PER_ELEMENT){default:case 4:return $G.FLOAT_32;case 8:return $G.FLOAT_64}}!function(e){e[e.FLOAT_32=0]="FLOAT_32",e[e.FLOAT_64=1]="FLOAT_64"}($G||($G={}));var oH,aH,sH,cH,lH,uH,hH,fH,_H,pH,dH,mH,vH,gH=mc("cc.animation.QuantizedFloatArray")((HG=function(){function e(e,t,n,i){void 0===i&&(i=0),ce(this,"originalPrecision",zG,this),ce(this,"min",UG,this),ce(this,"extent",kG,this),ce(this,"values",GG,this),this.originalPrecision=e,this.values=t,this.extent=n,this.min=i}return e.prototype.toHashString=function(){var e=this.originalPrecision,t=this.min,n=this.extent,i=this.values;return e+" "+qG(t)+" "+qG(n)+" "+i.join(" ")},Z(e,[{key:"quantizationType",get:function(){switch(this.values.BYTES_PER_ELEMENT){default:case 1:return"uint8";case 2:return"uint16"}}}]),e}(),zG=le((FG=HG).prototype,"originalPrecision",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),UG=le(FG.prototype,"min",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),kG=le(FG.prototype,"extent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),GG=le(FG.prototype,"values",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:null}),BG=FG))||BG;function yH(e,t){return e.values[t]/(1<<e.values.BYTES_PER_ELEMENT)*e.extent+e.min}function xH(e,t,n,i,r,o){var a=new Rz;a.path=(new Pz).toHierarchy(i).toProperty(r);var s=o(a);return s?{runtimeBinding:s,evaluator:new nH(e,t,n)}:null}function SH(e,t,n){In.set(n,yH(e,3*t+0),yH(e,3*t+1),yH(e,3*t+2))}function TH(e,t,n){Fn.set(n,yH(e,4*t+0),yH(e,4*t+1),yH(e,4*t+2),yH(e,4*t+3))}var bH=Symbol("SearchForRootBonePath"),EH=Symbol("ExoticAnimation"),CH=e("AnimationClip",mc("cc.AnimationClip")((vH=mH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"sample",sH,oe(t)),ce(t,"speed",cH,oe(t)),ce(t,"wrapMode",lH,oe(t)),ce(t,"enableTrsBlending",uH,oe(t)),ce(t,"_duration",hH,oe(t)),ce(t,"_hash",fH,oe(t)),t.frameRate=0,ce(t,"_tracks",_H,oe(t)),ce(t,"_exoticAnimation",pH,oe(t)),t._legacyData=void 0,t._legacyDataDirty=!1,ce(t,"_events",dH,oe(t)),t._runtimeEvents={ratios:[],eventGroups:[]},t}$(t,e),t.createWithSpriteFrames=function(e,n){var i=new t;i.sample=n||i.sample,i.duration=e.length/i.sample;var r=1/i.sample,o=new oU;return o.path=(new Pz).toComponent("cc.Sprite").toProperty("spriteFrame"),o.channels()[0].curve.assignSorted(e.map((function(e,t){return[r*t,e]}))),i.addTrack(o),i};var n=t.prototype;return n.onLoaded=function(){this.frameRate=this.sample,this.events=this._events},n.range=function(){for(var e={min:1/0,max:-1/0},t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i].range();e.min=Math.min(e.min,r.min),e.max=Math.max(e.max,r.max)}return e},n.getTrack=function(e){return this._tracks[e]},n.addTrack=function(e){var t=this._tracks.length;return this._tracks.push(e),t},n.removeTrack=function(e){this._tracks.splice(e,1)},n.clearTracks=function(){this._tracks.length=0},n.createEventEvaluator=function(e){return new MH(e,this._runtimeEvents.ratios,this._runtimeEvents.eventGroups,this.wrapMode)},n.createEvaluator=function(e){var t=this,n=e.target;return this._createEvalWithBinder(n,(function(i){var r=i.createRuntimeBinding(n,t.enableTrsBlending?e.pose:void 0,!1);return null!=r?r:void 0}),e.rootMotion)},n.destroy=function(){var t;return(null===(t=u.director.root)||void 0===t?void 0:t.dataPoolManager)&&u.director.root.dataPoolManager.releaseAnimationClip(this),qk.destroy(this),e.prototype.destroy.call(this)},n[jk]=function(e,t,n){for(var i=1/t,r=this._collectAnimatedJoints(),o=r.length,a={},s=0;s<o;++s)a[r[s]]={transforms:Array.from({length:n},(function(){return new jn}))};var c=r.reduce((function(e,t){return e[t]=new PH,e}),{});for(var l in c){var u=c[l],h=l.lastIndexOf("/");if(h>=0){var f=l.substring(0,h),_=c[f];_&&(u.parent=_)}}for(var p=this._createEvalWithBinder(void 0,(function(e){var t=e.parseTrsPath();if(t){var n=c[t.node];if(n)return OH(n,t.property)}}),void 0),d=0;d<n;++d){var m=e+i*d;p.evaluate(m);for(var v=0;v<o;++v){var g=r[v];jn.copy(a[g].transforms[d],c[g].globalTransform)}for(var y=0;y<o;++y){var x=r[y];c[x].invalidate()}}return{samples:t,frames:n,joints:a}},n.upgradeUntypedTracks=function(e){for(var t=[],n=[],i=this._tracks,r=i.length,o=0;o<r;++o){var a=i[o];if(a instanceof cG){var s=a.upgrade(e);s&&(t.push(s),n.push(a))}}for(var c=n.length,l=0;l<c;++l)it.remove(i,n[l]);i.push.apply(i,t)},n[bH]=function(){return this._searchForRootBonePath()},n.getPropertyCurves=function(){return this._getLegacyData().getPropertyCurves()},n.updateEventDatas=function(){this.events=this._events},n.hasEvents=function(){return 0!==this.events.length},n.syncLegacyData=function(){this._legacyData&&(this._fromLegacy(this._legacyData),this._legacyData=void 0)},n._createEvalWithBinder=function(e,t,n){this._legacyDataDirty&&(this._legacyDataDirty=!1,this.syncLegacyData());var i,r=[];n&&(i=this._createRootMotionEvaluation(e,n,r));for(var o,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l];if(!r.includes(u)&&!Array.from(u.channels()).every((function(e){return 0===e.curve.keyFramesCount}))){var h=t(u[wz]);if(h){var f=u[Ez](h);a.push({binding:h,trackEval:f})}}}return this._exoticAnimation&&(o=this._exoticAnimation.createEvaluator(t)),new AH(a,o,i)},n._createRootMotionEvaluation=function(e,t,n){if(e instanceof qC){var i=this._searchForRootBonePath();if(i){var r=e.getChildByPath(i);if(r){for(var o=new wH,a=[],s=this._tracks,c=s.length,l=0;l<c;++l){var u=s[l],h=u[wz].parseTrsPath();if(h&&h.node===i){n.push(u);var f=OH(o,h.property);if(f){var _=u[Ez](f);a.push({binding:f,trackEval:_})}}}return new IH(r,this._duration,o,a)}D(3924)}else D(3923)}else M(3920)},n._searchForRootBonePath=function(){var e=this._tracks.map((function(e){var t=e[wz].parseTrsPath();if(t){var n=t.node;return{path:n,rank:n.split("/").length}}return{path:"",rank:0}}));e.sort((function(e,t){return e.rank-t.rank}));var t=e.findIndex((function(e){return 0!==e.rank}));if(t<0)return"";for(var n=e.length,i=e[t],r=!0,o=t+1;o<n;++o){var a=e[o];if(a.rank!==i.rank)break;if(a.path!==i.path){r=!1;break}}return r?i.path:""},n._getLegacyData=function(){return this._legacyData||(this._legacyData=this._toLegacy()),this._legacyData},n._toLegacy=function(){var e=new lG(this._duration);return e.keys=[],e.curves=[],e.commonTargets=[],e},n._fromLegacy=function(e){for(var t=e.toTracks(),n=t.length,i=0;i<n;++i)this.addTrack(t[i])},n._collectAnimatedJoints=function(){for(var e=new Set,t=this._tracks,n=t.length,i=0;i<n;++i){var r=t[i][wz].parseTrsPath();r&&e.add(r.node)}if(this._exoticAnimation)for(var o=this._exoticAnimation.collectAnimatedJoints(),a=o.length,s=0;s<a;++s)e.add(o[s]);return Array.from(e)},Z(t,[{key:"duration",get:function(){return this._duration},set:function(e){this._duration=e}},{key:"tracksCount",get:function(){return this._tracks.length}},{key:"tracks",get:function(){return this._tracks}},{key:"hash",get:function(){var e,t;if(this._hash)return this._hash;var n="Exotic:"+(null!==(e=null===(t=this._exoticAnimation)||void 0===t?void 0:t.toHashString())&&void 0!==e?e:"");return this._hash=xo(n,666)}},{key:"events",get:function(){return this._events},set:function(e){var t=this;this._events=e;for(var n=[],i=[],r=this.events.sort((function(e,t){return e.frame-t.frame})),o=r.length,a=function(e){var o=r[e],a=o.frame/t._duration,s=n.findIndex((function(e){return e===a}));s<0&&(s=n.length,n.push(a),i.push({events:[]})),i[s].events.push({functionName:o.func,parameters:o.params})},s=0;s<o;++s)a(s);this._runtimeEvents={ratios:n,eventGroups:i}}},{key:EH,get:function(){return this._exoticAnimation}},{key:EH,set:function(e){this._exoticAnimation=e}},{key:"keys",get:function(){return this._getLegacyData().keys}},{key:"keys",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().keys=e}},{key:"curves",get:function(){return this._legacyDataDirty=!0,this._getLegacyData().curves}},{key:"curves",set:function(e){this._getLegacyData().curves=e}},{key:"commonTargets",get:function(){return this._getLegacyData().commonTargets}},{key:"commonTargets",set:function(e){this._legacyDataDirty=!0,this._getLegacyData().commonTargets=e}},{key:"data",get:function(){return this._getLegacyData().data}},{key:"eventGroups",get:function(){return this._runtimeEvents.eventGroups}}]),t}(Nu),mH.WrapMode=tc,sH=le((aH=vH).prototype,"sample",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),cH=le(aH.prototype,"speed",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),lH=le(aH.prototype,"wrapMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return tc.Normal}}),uH=le(aH.prototype,"enableTrsBlending",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),hH=le(aH.prototype,"_duration",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fH=le(aH.prototype,"_hash",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),_H=le(aH.prototype,"_tracks",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pH=le(aH.prototype,"_exoticAnimation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dH=le(aH.prototype,"_events",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),oH=aH))||oH);u.AnimationClip=CH;var AH=function(){function e(e,t,n){this._exoticAnimationEvaluator=void 0,this._trackEvalStatues=[],this._rootMotionEvaluation=void 0,this._trackEvalStatues=e,this._exoticAnimationEvaluator=t,this._rootMotionEvaluation=n}var t=e.prototype;return t.evaluate=function(e){for(var t=this._trackEvalStatues,n=this._exoticAnimationEvaluator,i=t.length,r=0;r<i;++r){var o=t[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}n&&n.evaluate(e)},t.evaluateRootMotion=function(e,t){var n=this._rootMotionEvaluation;n&&n.evaluate(e,t)},e}(),wH=function(){function e(){this.position=new In,this.scale=new In(1,1,1),this.rotation=new Fn,this.eulerAngles=new In}return e.prototype.getTransform=function(e){jn.fromRTS(e,this.rotation,this.position,this.scale)},e}(),PH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).parent=null,t._dirty=!0,t._transform=new jn,t}return $(t,e),t.prototype.invalidate=function(){this._dirty=!0},Z(t,[{key:"globalTransform",get:function(){var e=this._transform;return this._dirty&&(this._dirty=!1,jn.fromRTS(e,this.rotation,this.position,this.scale),this.parent&&jn.multiply(e,this.parent.globalTransform,e)),this._transform}}]),t}(wH),RH=new jn,IH=function(){function e(e,t,n,i){this._initialTransformCache=new jn,this._clipEndTransformCache=new jn,this._startTransformCache=new jn,this._endTransformCache=new jn,this._motionTransformCache=new jn,this._translationMotionCache=new In,this._rotationMotionCache=new Fn,this._scaleMotionCache=new In,this._rootBone=e,this._duration=t,this._boneTransform=n,this._trackEvalStatuses=i}var t=e.prototype;return t.evaluate=function(e,t){var n=this._calcMotionTransform(e,t,this._motionTransformCache),i=this._translationMotionCache,r=this._rotationMotionCache,o=this._scaleMotionCache,a=this._rootBone;jn.toRTS(n,r,i,o),In.add(i,i,a.position),a.setPosition(i),Fn.multiply(r,r,a.rotation),a.setRotation(r),In.multiply(o,o,a.scale),a.setScale(o)},t._calcMotionTransform=function(e,t,n){var i=this._duration,r=i-e,o=this._evaluateAt(e,this._startTransformCache);if(t<r){var a=this._evaluateAt(e+t,this._endTransformCache);DH(n,o,a)}else{jn.identity(n);var s=function(e,t){DH(RH,e,t),jn.multiply(n,n,RH)},c=t-r,l=Math.floor(c/i),u=c-l*i,h=this._evaluateAt(0,this._initialTransformCache),f=this._evaluateAt(i,this._clipEndTransformCache),_=this._evaluateAt(u,this._endTransformCache);s(o,f),DH(RH,h,f);for(var p=0;p<l;++p)jn.multiply(n,n,RH);s(h,_)}return n},t._evaluateAt=function(e,t){for(var n=this._trackEvalStatuses,i=n.length,r=0;r<i;++r){var o=n[r],a=o.trackEval,s=o.binding,c=a.evaluate(e,s);s.setValue(c)}return this._boneTransform.getTransform(t),t},e}();function DH(e,t,n){jn.invert(e,t),jn.multiply(e,n,e)}function OH(e,t){switch(t){default:return;case"position":return{setValue:function(t){In.copy(e.position,t)}};case"rotation":return{setValue:function(t){Fn.copy(e.rotation,t)}};case"scale":return{setValue:function(t){In.copy(e.scale,t)}};case"eulerAngles":return{setValue:function(t){In.copy(e.eulerAngles,t)}}}}var MH=function(){function e(e,t,n,i){this._lastFrameIndex=-1,this._lastIterations=0,this._lastDirection=0,this._ignoreIndex=-1,this._sampled=!1,this._targetNode=e,this._ratios=t,this._eventGroups=n,this._wrapMode=i}var t=e.prototype;return t.setWrapMode=function(e){this._wrapMode=e},t.ignore=function(e,t){this._ignoreIndex=-1,this._sampled=!1;var n=LH(e,this._ratios);n<0&&(n=~n-1,t<0&&(n+=1),this._ignoreIndex=n)},t.sample=function(e,t,n){var i=this._eventGroups.length,r=LH(e,this._ratios);if(r<0&&(r=~r-1,t<0&&(r+=1)),this._ignoreIndex!==r&&(this._ignoreIndex=-1),!this._sampled)return this._sampled=!0,this._doFire(r,!1),this._lastFrameIndex=r,this._lastIterations=n,void(this._lastDirection=t);var o=this._wrapMode,a=NH(n),s=NH(this._lastIterations),c=this._lastFrameIndex,l=this._lastDirection,u=-1!==s&&a!==s;if(c===r&&u&&1===i)this._doFire(0,!1);else if(c!==r||u){t=l;do{if(c!==r){if(-1===t&&0===c&&r>0?((o&ec.PingPong)===ec.PingPong?t*=-1:c=i,s++):1===t&&c===i-1&&r<i-1&&((o&ec.PingPong)===ec.PingPong?t*=-1:c=-1,s++),c===r)break;if(s>a)break}c+=t,this._doFire(c,!0)}while(c!==r&&c>-1&&c<i)}this._lastFrameIndex=r,this._lastIterations=n,this._lastDirection=t},t._doFire=function(e,t){t?u.director.getAnimationManager().pushDelayEvent(this._checkAndFire,this,[e]):this._checkAndFire(e)},t._checkAndFire=function(e){if(this._targetNode&&this._targetNode.isValid){var t=this._eventGroups;if(!(e<0||e>=t.length||this._ignoreIndex===e))for(var n=t[e],i=this._targetNode.components,r=n.events.length,o=0;o<r;++o)for(var a=n.events[o],s=a.functionName,c=i.length,l=0;l<c;++l){var u=i[l],h=u[s];"function"==typeof h&&h.apply(u,a.parameters)}}},e}();function NH(e){return e-(0|e)==0&&(e-=1),0|e}function LH(e,t){return sc(t,e)}var BH,FH=function(){function e(){this._isPlaying=!1,this._isPaused=!1,this._stepOnce=!1}var t=e.prototype;return t.play=function(){this._isPlaying?this._isPaused?(this._isPaused=!1,this.onResume()):this.onError(F(3912)):(this._isPlaying=!0,this.onPlay())},t.stop=function(){this._isPlaying&&(this._isPlaying=!1,this.onStop(),this._isPaused=!1)},t.pause=function(){this._isPlaying&&!this._isPaused&&(this._isPaused=!0,this.onPause())},t.resume=function(){this._isPlaying&&this._isPaused&&(this._isPaused=!1,this.onResume())},t.step=function(){this.pause(),this._stepOnce=!0,this._isPlaying||this.play()},t.update=function(){},t.onPlay=function(){},t.onPause=function(){},t.onResume=function(){},t.onStop=function(){},t.onError=function(){},Z(e,[{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isMotionless",get:function(){return!this.isPlaying||this.isPaused}}]),e}(),zH=function(){function e(e){this.weight=0,this._pose=void 0,this._blendStateWriters=[],this._pose=e}var t=e.prototype;return t.destroy=function(){for(var e=0;e<this._blendStateWriters.length;++e)this._pose.destroyWriter(this._blendStateWriters[e]);this._blendStateWriters.length=0},t.createPoseWriter=function(e,t,n){var i=this._pose.createWriter(e,t,this,n);return this._blendStateWriters.push(i),i},e}();!function(e){e.PLAY="play",e.STOP="stop",e.PAUSE="pause",e.RESUME="resume",e.LASTFRAME="lastframe",e.FINISHED="finished"}(BH||(BH={})),ut(BH);var UH=e("AnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this)||this).duration=1,i.speed=1,i.time=0,i.frameRate=0,i._targetNode=null,i._curveLoaded=!1,i._clip=void 0,i._useSimpleProcess=!1,i._target=null,i._wrapMode=tc.Normal,i._repeatCount=1,i._delay=0,i._delayTime=0,i._currentFramePlayed=!1,i._name=void 0,i._lastIterations=NaN,i._lastWrapInfo=null,i._wrappedInfo=new ac,i._allowLastFrame=!1,i._blendStateWriterHost={weight:0},i._playbackDuration=0,i._invDuration=1,i._poseOutput=null,i._weight=1,i._clipEval=void 0,i._clipEventEval=void 0,i._doNotCreateEval=!1,i._clip=t,i._name=n||t&&t.name,i._playbackRange={min:0,max:t.duration},i._playbackDuration=t.duration,t.duration||E("Clip "+t.name+" has zero duration."),i}$(t,e);var n=t.prototype;return n.initialize=function(e,t){if(!this._curveLoaded){this._curveLoaded=!0,this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval&&(this._clipEval=void 0),this._targetNode=e;var n=this._clip;if(this.duration=n.duration,this._invDuration=1/this.duration,this.speed=n.speed,this.wrapMode=n.wrapMode,this.frameRate=n.sample,this._playbackRange.min=0,this._playbackRange.max=n.duration,this._playbackDuration=n.duration,(this.wrapMode&ec.Loop)===ec.Loop?this.repeatCount=1/0:this.repeatCount=1,!this._doNotCreateEval){var i,r,o,a=null!==(i=null!=t?t:null===(r=u.director.getAnimationManager())||void 0===r?void 0:r.blendState)&&void 0!==i?i:null;a&&(this._poseOutput=new zH(a)),this._clipEval=n.createEvaluator({target:e,pose:null!==(o=this._poseOutput)&&void 0!==o?o:void 0})}this._clipEventEval=n.createEventEvaluator(this._targetNode)}},n.destroy=function(){this.isMotionless||u.director.getAnimationManager().removeAnimation(this),this._poseOutput&&(this._poseOutput.destroy(),this._poseOutput=null),this._clipEval=void 0},n.emit=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];u.director.getAnimationManager().pushDelayEvent(this._emit,this,t)},n.on=function(e,t,n){return this._target&&this._target.isValid?this._target.on(e,t,n):null},n.once=function(e,t,n){return this._target&&this._target.isValid?this._target.once(e,t,n):null},n.off=function(e,t,n){this._target&&this._target.isValid&&this._target.off(e,t,n)},n.allowLastFrameEvent=function(e){this._allowLastFrame=e},n._setEventTarget=function(e){this._target=e},n.setTime=function(e){this._currentFramePlayed=!1,this.time=e||0;var t,n=this.getWrappedInfo(e,this._wrappedInfo);null===(t=this._clipEventEval)||void 0===t||t.ignore(n.ratio,n.direction)},n.update=function(e){this._delayTime>0&&(this._delayTime-=e,this._delayTime>0)||(this._currentFramePlayed?this.time+=e*this.speed:this._currentFramePlayed=!0,this._process())},n.sample=function(){var e=this.getWrappedInfo(this.time,this._wrappedInfo);return this._sampleCurves(e.time),this._sampleEvents(e),e},n.onPlay=function(){this.setTime(this._getPlaybackStart()),this._delayTime=this._delay,this._onReplayOrResume(),this.emit(BH.PLAY,this)},n.onStop=function(){this.isPaused||this._onPauseOrStop(),this.emit(BH.STOP,this)},n.onResume=function(){this._onReplayOrResume(),this.emit(BH.RESUME,this)},n.onPause=function(){this._onPauseOrStop(),this.emit(BH.PAUSE,this)},n._sampleCurves=function(e){var t=this._poseOutput,n=this._clipEval;t&&(t.weight=this.weight),n&&n.evaluate(e)},n._process=function(){this._useSimpleProcess?this.simpleProcess():this.process()},n.process=function(){var e,t=this.sample();this._allowLastFrame&&(e=this._lastWrapInfo?this._lastWrapInfo:this._lastWrapInfo=new ac(t),this.repeatCount>1&&(0|t.iterations)>(0|e.iterations)&&this.emit(BH.LASTFRAME,this),e.set(t)),t.stopped&&(this.stop(),this.emit(BH.FINISHED,this))},n.simpleProcess=function(){var e=this._playbackRange.min,t=this._playbackDuration,n=this.time%t;n<0&&(n+=t);var i=(e+n)*this._invDuration;this._sampleCurves(e+n),this._sampleEvents(this.getWrappedInfo(this.time,this._wrappedInfo)),this._allowLastFrame&&(Number.isNaN(this._lastIterations)&&(this._lastIterations=i),(this.time>0&&this._lastIterations>i||this.time<0&&this._lastIterations<i)&&this.emit(BH.LASTFRAME,this),this._lastIterations=i)},n._needReverse=function(e){var t=this.wrapMode,n=!1;return(t&ec.PingPong)===ec.PingPong&&(e-(0|e)==0&&e>0&&(e-=1),1&e&&(n=!n)),(t&ec.Reverse)===ec.Reverse&&(n=!n),n},n.getWrappedInfo=function(e,t){t=t||new ac;var n=this._getPlaybackStart(),i=this._getPlaybackEnd()-n,r=!1,o=this.repeatCount,a=(e-=n)>0?e/i:-e/i;if(a>=o){a=o,r=!0;var s=o-(0|o);0===s&&(s=1),e=s*i*(e>0?1:-1)}if(e>i){var c=e%i;e=0===c?i:c}else e<0&&0!=(e%=i)&&(e+=i);var l=!1,u=this._wrapMode&ec.ShouldWrap;u&&(l=this._needReverse(a));var h=l?-1:1;return this.speed<0&&(h*=-1),u&&l&&(e=i-e),t.time=n+e,t.ratio=t.time/this.duration,t.direction=h,t.stopped=r,t.iterations=a,t},n._getPlaybackStart=function(){return this._playbackRange.min},n._getPlaybackEnd=function(){return this._playbackRange.max},n._sampleEvents=function(e){var t;null===(t=this._clipEventEval)||void 0===t||t.sample(e.ratio,e.direction,e.iterations)},n._emit=function(e,t){this._target&&this._target.isValid&&this._target.emit(e,e,t)},n._onReplayOrResume=function(){u.director.getAnimationManager().addAnimation(this)},n._onPauseOrStop=function(){u.director.getAnimationManager().removeAnimation(this)},Z(t,[{key:"clip",get:function(){return this._clip}},{key:"name",get:function(){return this._name}},{key:"length",get:function(){return this.duration}},{key:"wrapMode",get:function(){return this._wrapMode},set:function(e){var t;this._wrapMode=e,this.time=0,e&ec.Loop?this.repeatCount=1/0:this.repeatCount=1,null===(t=this._clipEventEval)||void 0===t||t.setWrapMode(e)}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e;var t=this._wrapMode&ec.ShouldWrap,n=(this.wrapMode&ec.Reverse)===ec.Reverse;this._useSimpleProcess=e===1/0&&!t&&!n}},{key:"delay",get:function(){return this._delay},set:function(e){this._delayTime=this._delay=e}},{key:"playbackRange",get:function(){return this._playbackRange},set:function(e){e.max,e.min,this._playbackRange.min=Math.max(e.min,0),this._playbackRange.max=Math.min(e.max,this.duration),this._playbackDuration=this._playbackRange.max-this._playbackRange.min,this.setTime(0)}},{key:"current",get:function(){return this.getWrappedInfo(this.time).time}},{key:"ratio",get:function(){return this.current/this.duration}},{key:"weight",get:function(){return this._weight},set:function(e){this._weight=e,this._poseOutput&&(this._poseOutput.weight=e)}},{key:"curveLoaded",get:function(){return this._curveLoaded}}]),t}(FH));u.AnimationState=UH;var kH,GH,HH,VH,WH,jH=XH,qH=XH;function XH(){}kH=mc("cc.animation.ClipMotion"),GH=Zc(CH),kH((WH=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"clip",VH,oe(t)),t}$(t,e);var n=t.prototype;return n[IU]=function(e){return this.clip?new _V(e,this.clip):null},n.clone=function(){var e=new t;return e.clip=this.clip,e},t}(fl),VH=le((HH=WH).prototype,"clip",[GH],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),HH));var YH,KH,QH,ZH,JH,$H,eV,tV,nV,iV,rV,oV,aV,sV,cV,lV,uV,hV,fV,_V=function(){function e(e,t){this.duration=t.duration,this._state=new UH(t),this._state.initialize(e.node,e.blendBuffer)}var t=e.prototype;return t.getClipStatuses=function(e){var t=this,n=!1;return{next:function(){return n?{done:!0,value:void 0}:(n=!0,{done:!1,value:{__DEBUG_ID__:t.__DEBUG__ID__,clip:t._state.clip,weight:e}})}}},t.sample=function(e,t){if(0!==t){this._state.name;var n=this._state.duration*e;this._state.time=n,this._state.weight=t,this._state.sample(),this._state.weight=0}},Z(e,[{key:"progress",get:function(){return this._state.time/this.duration}}]),e}(),pV=mc("cc.animation.AnimationBlendItem")((ZH=function(){function e(){ce(this,"motion",QH,this)}var t=e.prototype;return t.clone=function(){var t=new e;return this._assign(t),t},t._assign=function(e){var t,n;return e.motion=null!==(t=null===(n=this.motion)||void 0===n?void 0:n.clone())&&void 0!==t?t:null,e},e}(),QH=le((KH=ZH).prototype,"motion",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),YH=KH))||YH,dV=mc("cc.animation.AnimationBlend")((tV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"name",eV,oe(t)),t}return $(t,e),t}(fl),eV=le(($H=tV).prototype,"name",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),JH=$H))||JH,mV=function(){function e(e,t,n){this._childEvaluators=t.map((function(t){var n,i;return null!==(n=null===(i=t.motion)||void 0===i?void 0:i[IU](e))&&void 0!==n?n:null})),this._weights=new Array(this._childEvaluators.length).fill(0),this._inputs=[].concat(n)}var t=e.prototype;return t.getClipStatuses=function(e){var t,n=this._childEvaluators,i=this._weights,r=n.length,o=0;return{next:function(){for(;;){if(t){var a=t.next();if(!a.done)return a}if(o>=r)return{done:!0,value:void 0};var s=n[o];t=null==s?void 0:s.getClipStatuses(e*i[o]),++o}}}},t.sample=function(e,t){for(var n=0;n<this._childEvaluators.length;++n){var i;null===(i=this._childEvaluators[n])||void 0===i||i.sample(e,t*this._weights[n])}},t.setInput=function(e,t){this._inputs[t]=e,this.doEval()},t.doEval=function(){this.eval(this._weights,this._inputs)},t.eval=function(){},Z(e,[{key:"duration",get:function(){for(var e=0,t=0;t<this._childEvaluators.length;++t){var n,i;e+=(null!==(n=null===(i=this._childEvaluators[t])||void 0===i?void 0:i.duration)&&void 0!==n?n:0)*this._weights[t]}return e}}]),e}(),vV=mc("cc.animation.AnimationBlend1DItem")((oV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"threshold",rV,oe(t)),t}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),t.threshold=this.threshold,t},t}(pV),rV=le((iV=oV).prototype,"threshold",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nV=iV))||nV,gV=(mc("cc.animation.AnimationBlend1D")((uV=lV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_items",sV,oe(t)),ce(t,"param",cV,oe(t)),t}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){return e.clone()})),e.param=this.param.clone(),e},n[IU]=function(e){var t=new gV(e,this._items,this._items.map((function(e){return e.threshold})),0),n=HU(e,this.param,AU.FLOAT,t.setInput,t,0);return t.setInput(n,0),t},Z(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e).sort((function(e,t){return e.threshold-t.threshold}))}}]),t}(dV),lV.Item=vV,sV=le((aV=uV).prototype,"_items",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),cV=le(aV.prototype,"param",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kU}}),aV)),function(e){function t(t,n,i,r){var o;return(o=e.call(this,t,n,[r])||this)._thresholds=i,o.doEval(),o}return $(t,e),t.prototype.eval=function(e,t){var n=t[0];!function(e,t,n){if(e.fill(0),0===t.length);else if(n<=t[0])e[0]=1;else if(n>=t[t.length-1])e[e.length-1]=1;else{for(var i=0,r=1;r<t.length;++r)if(t[r]>n){i=r;break}var o=t[i-1],a=t[i],s=a-o;e[i-1]=(a-n)/s,e[i]=(n-o)/s}}(e,this._thresholds,n)},t}(mV)),yV=(hV=new Kn,fV={wA:0,wB:0},function(e,t,n){if(e.length,t.length,0!==t.length)if(1!==t.length)if(Kn.strictEquals(n,Kn.ZERO)){var i=t.findIndex((function(e){return Kn.strictEquals(e,Kn.ZERO)}));i>=0?e[i]=1:e.fill(1/t.length)}else{for(var r=-1,o=-1,a=-1,s=Number.NEGATIVE_INFINITY,c=Number.NEGATIVE_INFINITY,l=n.x,u=n.y,h=0;h<t.length;++h){var f=t[h];if(Kn.equals(f,Kn.ZERO))a=h;else{var _=Kn.normalize(hV,f),p=Kn.dot(_,n);_.x*u-_.y*l>0?p>=c&&(c=p,r=h):p>=s&&(s=p,o=h)}}var d=0;if(r<0||o<0)d=1;else{var m=(E=t[r],C=t[o],A=n,w=fV,(P=Kn.cross(E,C))?(w.wA=Kn.cross(A,C)/P,w.wB=Kn.cross(A,E)/-P):(w.wA=0,w.wB=0),w),v=m.wA,g=m.wB,y=0,x=0,S=v+g;S>1?(y=v/S,x=g/S):S<0?(y=0,x=0,d=1):(y=v,x=g,d=1-S),e[r]=y,e[o]=x}if(d>0)if(a>=0)e[a]=d;else for(var T=d/e.length,b=0;b<e.length;++b)e[b]+=T}else e[0]=1;var E,C,A,w,P});function xV(e,t,n,i){e.fill(0);for(var r=new Kn(0,0),o=new Kn(0,0),a=0,s=t.length,c=0;c<s;++c){for(var l=Number.MAX_VALUE,u=!1,h=0;h<s;++h)if(c!==h){i(t[c],t[h],n,r,o);var f=1-Kn.dot(r,o)/Kn.lengthSqr(o);if(f<0){u=!0;break}l=Math.min(l,f)}u||(e[c]=l,a+=l)}a>0&&e.forEach((function(t,n){return e[n]=t/a}))}var SV,TV,bV,EV,CV,AV,wV,PV,RV,IV,DV,OV,MV,NV,LV,BV,FV,zV,UV=function(e,t,n,i,r){Kn.subtract(i,n,e),Kn.subtract(r,t,e)},kV=(SV=new In(0,0,0),TV=new In(0,0,0),bV=new In(0,0,0),EV=new In(0,0,0),CV=new In(0,0,0),AV=new In(0,0,0),function(e,t,n,i,r){var o=0,a=0,s=2;In.set(bV,n.x,n.y,0),Kn.equals(e,Kn.ZERO)?(o=Kn.angle(n,t),a=0,s=1):Kn.equals(t,Kn.ZERO)?(a=o=Kn.angle(n,e),s=1):(o=Kn.angle(e,t))<=0?a=0:Kn.equals(n,Kn.ZERO)?a=o:(In.set(EV,e.x,e.y,0),In.set(CV,t.x,t.y,0),In.set(AV,n.x,n.y,0),In.cross(SV,EV,CV),In.projectOnPlane(bV,AV,SV),a=In.angle(EV,bV),o<.99*Math.PI&&In.dot(In.cross(TV,EV,bV),SV)<0&&(a=-a));var c=Kn.len(e),l=Kn.len(t),u=(l+c)/2;Kn.set(r,(l-c)/u,o*s),Kn.set(i,(In.len(bV)-c)/u,a*s)});!function(e){e[e.SIMPLE_DIRECTIONAL=0]="SIMPLE_DIRECTIONAL",e[e.FREEFORM_CARTESIAN=1]="FREEFORM_CARTESIAN",e[e.FREEFORM_DIRECTIONAL=2]="FREEFORM_DIRECTIONAL"}(zV||(zV={})),ut(zV);var GV,HV,VV,WV,jV,qV,XV,YV,KV,QV,ZV,JV,$V,eW,tW,nW,iW,rW,oW,aW,sW,cW,lW,uW,hW=mc("cc.animation.AnimationBlend2DItem")((IV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"threshold",RV,oe(t)),t}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),Kn.copy(t.threshold,this.threshold),t},t}(pV),RV=le((PV=IV).prototype,"threshold",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn}}),wV=PV))||wV,fW=(mc("cc.animation.AnimationBlend2D")((FV=BV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"algorithm",OV,oe(t)),ce(t,"_items",MV,oe(t)),ce(t,"paramX",NV,oe(t)),ce(t,"paramY",LV,oe(t)),t}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){var t;return null!==(t=null==e?void 0:e.clone())&&void 0!==t?t:null})),e.paramX=this.paramX.clone(),e.paramY=this.paramY.clone(),e},n[IU]=function(e){var t=new fW(e,this._items,this._items.map((function(e){return e.threshold})),this.algorithm,[0,0]),n=HU(e,this.paramX,AU.FLOAT,t.setInput,t,0),i=HU(e,this.paramY,AU.FLOAT,t.setInput,t,1);return t.setInput(n,0),t.setInput(i,1),t},Z(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e)}}]),t}(dV),BV.Algorithm=zV,BV.Item=hW,OV=le((DV=FV).prototype,"algorithm",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zV.SIMPLE_DIRECTIONAL}}),MV=le(DV.prototype,"_items",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),NV=le(DV.prototype,"paramX",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kU}}),LV=le(DV.prototype,"paramY",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kU}}),DV)),function(e){function t(t,n,i,r,o){var a;return(a=e.call(this,t,n,o)||this)._thresholds=void 0,a._algorithm=void 0,a._value=new Kn,a._thresholds=i,a._algorithm=r,a.doEval(),a}return $(t,e),t.prototype.eval=function(e,t){var n=t[0],i=t[1];switch(Kn.set(this._value,n,i),e.fill(0),this._algorithm){case zV.SIMPLE_DIRECTIONAL:yV(e,this._thresholds,this._value);break;case zV.FREEFORM_CARTESIAN:!function(e,t,n){xV(e,t,n,UV)}(e,this._thresholds,this._value);break;case zV.FREEFORM_DIRECTIONAL:!function(e,t,n){xV(e,t,n,kV)}(e,this._thresholds,this._value)}},t}(mV)),_W=mc("cc.animation.AnimationBlendDirectItem")((WV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"weight",VV,oe(t)),t}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return this._assign(e),e},n._assign=function(t){return e.prototype._assign.call(this,t),t.weight=this.weight,t},t}(pV),VV=le((HV=WV).prototype,"weight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GV=HV))||GV,pW=(mc("cc.animation.AnimationBlendDirect")((YV=XV=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_items",qV,oe(t)),t}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._items=this._items.map((function(e){var t;return null!==(t=null==e?void 0:e.clone())&&void 0!==t?t:null})),e},n[IU]=function(e){return new pW(e,this._items,this._items.map((function(e){return e.weight})))},Z(t,[{key:"items",get:function(){return this._items},set:function(e){this._items=Array.from(e)}}]),t}(dV),XV.Item=_W,qV=le((jV=YV).prototype,"_items",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),jV)),function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).doEval(),t}return $(t,e),t.prototype.eval=function(e,t){for(var n=e.length,i=0;i<n;++i)e[i]=t[i]},t}(mV));!function(e){e[e.EQUAL_TO=0]="EQUAL_TO",e[e.NOT_EQUAL_TO=1]="NOT_EQUAL_TO",e[e.LESS_THAN=2]="LESS_THAN",e[e.LESS_THAN_OR_EQUAL_TO=3]="LESS_THAN_OR_EQUAL_TO",e[e.GREATER_THAN=4]="GREATER_THAN",e[e.GREATER_THAN_OR_EQUAL_TO=5]="GREATER_THAN_OR_EQUAL_TO"}(uW||(uW={})),mc("cc.animation.BinaryCondition")((eW=$V=function(){function e(){ce(this,"operator",QV,this),ce(this,"lhs",ZV,this),ce(this,"rhs",JV,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.operator=this.operator,t.lhs=this.lhs.clone(),t.rhs=this.rhs.clone(),t},t[IU]=function(e){var t=this.operator,n=this.lhs,i=this.rhs,r=new mW(t,0,0),o=VU(e,n,AU.FLOAT,r.setLhs,r),a=VU(e,i,AU.FLOAT,r.setRhs,r);return r.reset(o,a),r},e}(),$V.Operator=uW,QV=le((KV=eW).prototype,"operator",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uW.EQUAL_TO}}),ZV=le(KV.prototype,"lhs",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kU}}),JV=le(KV.prototype,"rhs",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new kU}}),KV));var dW,mW=function(){function e(e,t,n){this._operator=e,this._lhs=t,this._rhs=n,this._eval()}var t=e.prototype;return t.reset=function(e,t){this._lhs=e,this._rhs=t,this._eval()},t.setLhs=function(e){this._lhs=e,this._eval()},t.setRhs=function(e){this._rhs=e,this._eval()},t.eval=function(){return this._result},t._eval=function(){var e=this._lhs,t=this._rhs;switch(this._operator){default:case uW.EQUAL_TO:this._result=e===t;break;case uW.NOT_EQUAL_TO:this._result=e!==t;break;case uW.LESS_THAN:this._result=e<t;break;case uW.LESS_THAN_OR_EQUAL_TO:this._result=e<=t;break;case uW.GREATER_THAN:this._result=e>t;break;case uW.GREATER_THAN_OR_EQUAL_TO:this._result=e>=t}},e}();!function(e){e[e.TRUTHY=0]="TRUTHY",e[e.FALSY=1]="FALSY"}(dW||(dW={})),mc("cc.animation.UnaryCondition")((oW=rW=function(){function e(){ce(this,"operator",nW,this),ce(this,"operand",iW,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.operator=this.operator,t.operand=this.operand.clone(),t},t[IU]=function(e){var t=this.operator,n=this.operand,i=new xW(t,!1),r=HU(e,n,AU.BOOLEAN,i.setOperand,i);return i.reset(r),i},e}(),rW.Operator=dW,nW=le((tW=oW).prototype,"operator",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dW.TRUTHY}}),iW=le(tW.prototype,"operand",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new GU}}),tW));var vW,gW,yW,xW=function(){function e(e,t){this._operator=e,this._operand=t,this._eval()}var t=e.prototype;return t.reset=function(e){this.setOperand(e)},t.setOperand=function(e){this._operand=e,this._eval()},t.eval=function(){return this._result},t._eval=function(){var e=this._operand;switch(this._operator){default:case dW.TRUTHY:this._result=!!e;break;case dW.FALSY:this._result=!e}},e}(),SW=mc("cc.animation.TriggerCondition")((lW=function(){function e(){ce(this,"trigger",cW,this)}var t=e.prototype;return t.clone=function(){var t=new e;return t.trigger=this.trigger,t},t[IU]=function(e){var t=new TW(!1),n=e.getVar(this.trigger);return WU(n,this.trigger)&&(function(e,t,n){if(e!==t)throw new RU(n,"number")}(n.type,AU.TRIGGER,this.trigger),t.setTrigger(n.bind(t.setTrigger,t))),t},e}(),cW=le((sW=lW).prototype,"trigger",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),aW=sW))||aW,TW=function(){function e(e){this._triggered=!1,this._triggered=e}var t=e.prototype;return t.setTrigger=function(e){this._triggered=e},t.eval=function(){return this._triggered},e}(),bW=function(){function e(){this._nodeBlendStates=new Map}var t=e.prototype;return t.createWriter=function(e,t,n,i){var r=this.ref(e,t);return new EW(e,t,r,n,i)},t.destroyWriter=function(e){var t=e;this.deRef(t.node,t.property)},t.ref=function(e,t){var n=this._nodeBlendStates.get(e);return n||(n=new PW,this._nodeBlendStates.set(e,n)),n.refProperty(t)},t.deRef=function(e,t){var n=this._nodeBlendStates.get(e);n&&(n.deRefProperty(t),n.empty&&this._nodeBlendStates.delete(e))},t.apply=function(){this._nodeBlendStates.forEach((function(e,t){e.apply(t)}))},e}(),EW=function(){function e(e,t,n,i,r){this._node=e,this._property=t,this._propertyBlendState=n,this._host=i,this._constants=r}var t=e.prototype;return t.getValue=function(){return this._node[this._property]},t.setValue=function(e){var t=this._propertyBlendState,n=this._host.weight;t.blend(e,n)},Z(e,[{key:"node",get:function(){return this._node}},{key:"property",get:function(){return this._property}}]),e}(),CW=function(e){this.blendedWeight=0,this.blendedValue=void 0,this.refCount=0,this.blendedValue=e},AW=function(e){function t(){return e.call(this,new In)||this}$(t,e);var n=t.prototype;return n.blend=function(e,t){var n=this.blendedValue;1===t?In.copy(n,e):In.scaleAndAdd(n,n,e,t),this.blendedWeight+=t},n.reset=function(){this.blendedWeight=0,In.zero(this.blendedValue)},t}(CW),wW=function(e){function t(){return e.call(this,new Fn)||this}$(t,e);var n=t.prototype;return n.blend=function(e,t){if(0!==t){var n=this.blendedValue,i=this.blendedWeight;if(1===t)Fn.copy(n,e);else{var r=t/(i+t);Fn.slerp(n,n,e,r)}this.blendedWeight+=t}},n.reset=function(){this.blendedWeight=0,Fn.identity(this.blendedValue)},t}(CW),PW=function(){function e(){this._properties={}}var t=e.prototype;return t.refProperty=function(e){var t,n,i,r=this._properties;switch(e){default:case"position":case"scale":case"eulerAngles":i=null!==(t=r[e])&&void 0!==t?t:r[e]=new AW;break;case"rotation":i=null!==(n=r[e])&&void 0!==n?n:r[e]=new wW}return++i.refCount,i},t.deRefProperty=function(e){var t=this._properties,n=t[e];n&&(--n.refCount,n.refCount>0||delete t[e])},t.apply=function(e){var t,n,i,r=this._properties,o=r.position,a=r.scale,s=r.rotation,c=r.eulerAngles,l=!1,u=!1,h=!1,f=!1;o&&o.blendedWeight&&(l=!0,o.blendedWeight<1&&o.blend(e.position,1-o.blendedWeight),t=o.blendedValue),a&&a.blendedWeight&&(u=!0,a.blendedWeight<1&&a.blend(e.scale,1-a.blendedWeight),n=a.blendedValue),c&&c.blendedWeight&&(f=!0,c.blendedWeight<1&&c.blend(e.eulerAngles,1-c.blendedWeight),i=c.blendedValue),s&&s.blendedWeight&&(h=!0,s.blendedWeight<1&&s.blend(e.rotation,1-s.blendedWeight),i=s.blendedValue),(i||t||n)&&e.setRTS(i,t,n),l&&o.reset(),u&&a.reset(),h&&s.reset(),f&&c.reset()},Z(e,[{key:"empty",get:function(){var e=this._properties;return!(e.position||e.rotation||e.eulerAngles||e.scale)}}]),e}(),RW=mc("cc.animation.StateMachineComponent")(vW=function(){function e(){}var t=e.prototype;return t.onMotionStateEnter=function(){},t.onMotionStateExit=function(){},t.onMotionStateUpdate=function(){},t.onStateMachineEnter=function(){},t.onStateMachineExit=function(){},e}())||vW,IW=function(){function e(e,t,n){var i=this;this._blendBuffer=new bW,this._currentTransitionCache={duration:0,time:0},this._varInstances={};for(var r,o=se(e.variables);!(r=o()).done;){var a=r.value,s=a[0],c=a[1],l=c.type,u=c.value;this._varInstances[s]=new ZW(l,u)}var h={controller:n,blendBuffer:this._blendBuffer,node:t,getVar:function(e){return i._varInstances[e]},triggerResetFn:function(e){i.setValue(e,!1)}};this._layerEvaluations=Array.from(e.layers).map((function(e){var t;return new DW(e,J({},h,{mask:null!==(t=e.mask)&&void 0!==t?t:void 0}))}))}var t=e.prototype;return t.update=function(e){for(var t,n=se(this._layerEvaluations);!(t=n()).done;)t.value.update(e);this._blendBuffer.apply()},t.getVariables=function(){return Object.entries(this._varInstances)},t.getCurrentStateStatus=function(e){return this._layerEvaluations[e].getCurrentStateStatus()},t.getCurrentClipStatuses=function(e){return this._layerEvaluations[e].getCurrentClipStatuses()},t.getCurrentTransition=function(e){var t=this._layerEvaluations,n=this._currentTransitionCache;return t[e].getCurrentTransition(n)?n:null},t.getNextStateStatus=function(e){return this._layerEvaluations[e].getNextStateStatus()},t.getNextClipStatuses=function(e){return this.getCurrentTransition(e),this._layerEvaluations[e].getNextClipStatuses()},t.getValue=function(e){var t=this._varInstances[e];return t?t.value:void 0},t.setValue=function(e,t){var n=this._varInstances[e];n&&(n.value=t)},e}(),DW=function(){function e(e,t){this._weight=void 0,this._nodes=[],this._topLevelEntry=void 0,this._topLevelExit=void 0,this._currentNode=void 0,this._currentTransitionToNode=null,this._currentTransitionPath=[],this._transitionProgress=0,this._fromWeight=0,this._toWeight=0,this._fromUpdated=!1,this._toUpdated=!1,this.name=e.name,this._controller=t.controller,this._weight=e.weight;var n=this._addStateMachine(e.stateMachine,null,J({},t),e.name),i=n.entry,r=n.exit;this._topLevelEntry=i,this._topLevelExit=r,this._currentNode=i,this._resetTrigger=t.triggerResetFn}var t=e.prototype;return t.update=function(e){this.exited||(this._fromWeight=1,this._toWeight=0,this._eval(e),this._sample())},t.getCurrentStateStatus=function(){var e=this._currentNode;return e.kind===yW.animation?e.getFromPortStatus():null},t.getCurrentClipStatuses=function(){var e=this._currentNode;return e.kind===yW.animation?e.getClipStatuses(this._fromWeight):MW},t.getCurrentTransition=function(e){var t=this._currentTransitionPath;if(0!==t.length){if(t[t.length-1].to.kind!==yW.animation)return!1;var n=t[0],i=n.duration,r=n.normalizedDuration,o=e.duration=r?i*(this._currentNode.kind===yW.animation?this._currentNode.duration:0):i;return e.time=this._transitionProgress*o,!0}return!1},t.getNextStateStatus=function(){return this._currentTransitionToNode,this._currentTransitionToNode.getToPortStatus()},t.getNextClipStatuses=function(){var e,t=this._currentTransitionPath,n=t[t.length-1].to;return n.kind,yW.animation,null!==(e=n.getClipStatuses(this._toWeight))&&void 0!==e?e:MW},t._addStateMachine=function(e,t,n,i){for(var r,o,a,s=this,c=Array.from(e.states()),l=c.map((function(t){return t instanceof Nk?new kW(t,n):t===e.entryState?r=new QW(t,yW.entry,t.name):t===e.exitState?a=new QW(t,yW.exit,t.name):t===e.anyState?o=new QW(t,yW.any,t.name):null})),u={components:null,parent:t,entry:r,exit:a,any:o},h=0;h<c.length;++h){var f=l[h];f&&(f.stateMachine=u)}for(var _=c.map((function(e){if(e instanceof Gk){var t=s._addStateMachine(e.stateMachine,u,n,i+"/"+e.name);return t.components=new UW(e),t}return null})),p=0;p<c.length;++p){var d=c[p],m=e.getOutgoings(d),v=[],g=void 0;g=d instanceof Gk?_[p].exit:l[p];for(var y,x=function(){var e=y.value,t=e.to,i=c.findIndex((function(t){return t===e.to})),r={to:t instanceof Gk?_[i].entry:l[i],conditions:e.conditions.map((function(e){return e[IU](n)})),duration:zk(e)?e.duration:0,normalizedDuration:!!zk(e)&&e.relativeDuration,exitConditionEnabled:!!zk(e)&&e.exitConditionEnabled,exitCondition:zk(e)?e.exitCondition:0,triggers:void 0};r.conditions.forEach((function(t,n){var i,o=e.conditions[n];o instanceof SW&&o.trigger&&(null!==(i=r.triggers)&&void 0!==i?i:r.triggers=[]).push(o.trigger)})),v.push(r)},S=se(m);!(y=S()).done;)x();g.outgoingTransitions=v}return u},t._eval=function(e){if(this.exited,qH("[Layer "+this.name+"]: UpdateStart "+e+"s"),this._continueDanglingTransition())return 0;for(var t=e,n=!0,i=0;n||t>0;){if(n=!1,100===i){D(14e3,100);break}if(++i,this._currentTransitionPath.length>0){if(t-=this._updateCurrentTransition(t),this._currentNode.kind===yW.exit)break;0===this._currentTransitionPath.length&&(n=!0)}else{var r=this._currentNode,o=this._matchCurrentNodeTransition(t);if(o){var a=o.transition,s=o.requires;if(jH("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),t-=s,r.kind===yW.animation&&(r.updateFromPort(s),this._fromUpdated=!0),this._switchTo(a))break;n=!0}else jH("[SubStateMachine "+this.name+"]: CurrentNodeUpdate: "+r.name),r.kind===yW.animation&&(r.updateFromPort(t),this._fromUpdated=!0,t=0)}}return jH("[SubStateMachine "+this.name+"]: UpdateEnd"),this._fromUpdated&&this._currentNode.kind===yW.animation&&(this._fromUpdated=!1,this._currentNode.triggerFromPortUpdate(this._controller)),this._currentTransitionToNode&&this._toUpdated&&this._currentNode.kind===yW.animation&&(this._toUpdated=!1,this._currentTransitionToNode.triggerToPortUpdate(this._controller)),t},t._sample=function(){var e=this._currentNode,t=this._currentTransitionToNode,n=this._fromWeight;e.kind===yW.animation&&e.sampleFromPort(n),t&&t.kind===yW.animation&&t.sampleToPort(this._toWeight)},t._matchCurrentNodeTransition=function(e){var t=this._currentNode,n=1/0,i=null,r=this._matchTransition(t,t,e,BW);if(r&&(n=r.requires,i=r.transition),t.kind===yW.animation)for(var o=t.stateMachine;null!==o;o=o.parent){var a=this._matchTransition(o.any,t,e,FW);a&&a.requires<n&&(n=a.requires,i=a.transition)}return i?LW.set(i,n):null},t._matchTransition=function(e,t,n,i){e===t||(e.kind,yW.any);for(var r=e.outgoingTransitions,o=r.length,a=1/0,s=null,c=0;c<o;++c){var l=r[c],u=l.conditions,h=u.length;if(0===h){if(e.kind===yW.entry||e.kind===yW.exit)return i.set(l,0);if(!l.exitConditionEnabled)continue}var f=0;if(t.kind===yW.animation&&l.exitConditionEnabled){var _=t.duration*l.exitCondition;if((f=Math.max(_-t.fromPortTime,0))>n)continue}for(var p=!0,d=0;d<h;++d)if(!u[d].eval()){p=!1;break}if(p){if(0===f)return i.set(l,0);f<a&&(a=f,s=l)}}return s?i.set(s,a):null},t._switchTo=function(e){var t=this._currentNode;qH("[SubStateMachine "+this.name+"]: STARTED "+t.name+" -> "+e.to.name+".");var n=this._currentTransitionPath;this._consumeTransition(e),n.push(e);var i=this._matchTransitionPathUntilMotion();return!i||(this._doTransitionToMotion(i),!1)},t._continueDanglingTransition=function(){var e=this._currentTransitionPath,t=e.length;if(0===t)return!1;if(e[t-1].to.kind!==yW.animation){var n=this._matchTransitionPathUntilMotion();return!n||(this._doTransitionToMotion(n),!1)}return!1},t._matchTransitionPathUntilMotion=function(){for(var e=this._currentTransitionPath,t=e[e.length-1].to;t.kind!==yW.animation;){var n=this._matchTransition(t,t,0,LW);if(!n)break;var i=n.transition;this._consumeTransition(i),e.push(i),t=i.to}return t.kind===yW.animation?t:null},t._consumeTransition=function(e){var t=e.to;t.kind===yW.entry&&this._callEnterMethods(t)},t._resetTriggersAlongThePath=function(){for(var e=this._currentTransitionPath,t=e.length,n=0;n<t;++n){var i=e[n];this._resetTriggersOnTransition(i)}},t._doTransitionToMotion=function(e){this._resetTriggersAlongThePath(),this._transitionProgress=0,this._currentTransitionToNode=e,this._toUpdated=!1,e.resetToPort(),this._callEnterMethods(e)},t._updateCurrentTransition=function(e){var t,n=this._currentTransitionPath,i=this._currentTransitionToNode;n.length;var r=n[0],o=r.duration,a=r.normalizedDuration,s=this._currentNode,c=i,l=0,u=0;if(o<=0)l=0,u=1;else{s.kind,yW.animation;var h=this._transitionProgress,f=a?o*s.duration:o,_=h*f,p=f-_;l=Math.min(p,e),u=this._transitionProgress=(_+l)/f}var d=null!==(t=null==c?void 0:c.name)&&void 0!==t?t:"<Empty>",m=this._weight;qH("[SubStateMachine "+this.name+"]: TransitionUpdate: "+s.name+" -> "+d+"with ratio "+u+" in base weight "+this._weight+"."),this._fromWeight=m*(1-u),this._toWeight=m*u;var v=0!==l,g=1===u;if(s.kind===yW.animation&&v&&(qH("Update "+s.name),s.updateFromPort(l),this._fromUpdated=!0),c&&v&&(qH("Update "+c.name),c.updateToPort(l),this._toUpdated=!0),g){jH("[SubStateMachine "+this.name+"]: Transition finished:  "+s.name+" -> "+d+"."),this._callExitMethods(s);for(var y=this._currentTransitionPath,x=y.length,S=0;S<x;++S){var T=y[S].to;T.kind===yW.exit&&this._callExitMethods(T)}this._fromUpdated=this._toUpdated,this._toUpdated=!1,c.finishTransition(),this._currentNode=c,this._currentTransitionToNode=null,this._currentTransitionPath.length=0,this._fromWeight=1,this._toWeight=0}return l},t._resetTriggersOnTransition=function(e){var t=e.triggers;if(t)for(var n=t.length,i=0;i<n;++i){var r=t[i];this._resetTrigger(r)}},t._resetTrigger=function(e){(0,this._triggerReset)(e)},t._callEnterMethods=function(e){var t,n=this._controller;switch(e.kind){default:break;case yW.animation:e.components.callMotionStateEnterMethods(n,e.getToPortStatus());break;case yW.entry:null===(t=e.stateMachine.components)||void 0===t||t.callStateMachineEnterMethods(n)}},t._callExitMethods=function(e){var t,n=this._controller;switch(e.kind){default:break;case yW.animation:e.components.callMotionStateExitMethods(n,e.getFromPortStatus());break;case yW.exit:null===(t=e.stateMachine.components)||void 0===t||t.callStateMachineExitMethods(n)}},Z(e,[{key:"exited",get:function(){return this._currentNode===this._topLevelExit}}]),e}(),OW=Object.freeze({next:function(){return{done:!0,value:void 0}}}),MW=Object.freeze(((gW={})[Symbol.iterator]=function(){return OW},gW)),NW=function(){function e(){this.transition=null,this.requires=0}return e.prototype.set=function(e,t){return this.transition=e,this.requires=t,this},e}(),LW=new NW,BW=new NW,FW=new NW;!function(e){e[e.entry=0]="entry",e[e.exit=1]="exit",e[e.any=2]="any",e[e.animation=3]="animation"}(yW||(yW={}));var zW=function(e){this.name=void 0,this.outgoingTransitions=[],this.name=e.name},UW=function(){function e(e){this._components=e.instantiateComponents()}var t=e.prototype;return t.callMotionStateEnterMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateEnter",e,t)},t.callMotionStateUpdateMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateUpdate",e,t)},t.callMotionStateExitMethods=function(e,t){this._callMotionStateCallbackIfNonDefault("onMotionStateExit",e,t)},t.callStateMachineEnterMethods=function(e){this._callStateMachineCallbackIfNonDefault("onStateMachineEnter",e)},t.callStateMachineExitMethods=function(e){this._callStateMachineCallbackIfNonDefault("onStateMachineExit",e)},t._callMotionStateCallbackIfNonDefault=function(e,t,n){for(var i=this._components,r=i.length,o=0;o<r;++o){var a=i[o];a[e]!==RW.prototype[e]&&a[e](t,n)}},t._callStateMachineCallbackIfNonDefault=function(e,t){for(var n=this._components,i=n.length,r=0;r<i;++r){var o=n[r];o[e]!==RW.prototype[e]&&o[e](t)}},e}(),kW=function(e){function t(t,n){var i,r,o;(o=e.call(this,t)||this).kind=yW.animation,o._source=null,o._speed=1,o._fromPort={progress:0,statusCache:{progress:0}},o._toPort={progress:0,statusCache:{progress:0}};var a=HU(n,t.speed,AU.FLOAT,o._setSpeed,oe(o));o._speed=a;var s=J({},n),c=null!==(i=null===(r=t.motion)||void 0===r?void 0:r[IU](s))&&void 0!==i?i:null;return c&&Object.defineProperty(c,"__DEBUG_ID__",{value:o.name}),o._source=c,o.components=new UW(t),o}$(t,e);var n=t.prototype;return n.updateFromPort=function(e){this._fromPort.progress=GW(this._fromPort.progress,this.duration,e*this._speed)},n.updateToPort=function(e){this._toPort.progress=GW(this._toPort.progress,this.duration,e*this._speed)},n.triggerFromPortUpdate=function(e){this.components.callMotionStateUpdateMethods(e,this.getFromPortStatus())},n.triggerToPortUpdate=function(e){this.components.callMotionStateUpdateMethods(e,this.getToPortStatus())},n.getFromPortStatus=function(){var e=this._fromPort.statusCache;return e.progress=HW(this._fromPort.progress),e},n.getToPortStatus=function(){var e=this._toPort.statusCache;return e.progress=HW(this._toPort.progress),e},n.resetToPort=function(){this._toPort.progress=0},n.finishTransition=function(){this._fromPort.progress=this._toPort.progress},n.sampleFromPort=function(e){var t;null===(t=this._source)||void 0===t||t.sample(this._fromPort.progress,e)},n.sampleToPort=function(e){var t;null===(t=this._source)||void 0===t||t.sample(this._toPort.progress,e)},n.getClipStatuses=function(e){var t,n=this._source;return n?((t={})[Symbol.iterator]=function(){return n.getClipStatuses(e)},t):MW},n._setSpeed=function(e){this._speed=e},Z(t,[{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._source)||void 0===t?void 0:t.duration)&&void 0!==e?e:0}},{key:"fromPortTime",get:function(){return this._fromPort.progress*this.duration}}]),t}(zW);function GW(e,t,n){return 0===t?0:e+n/t}function HW(e){return e-Math.trunc(e)}var VW,WW,jW,qW,XW,YW,KW,QW=function(e){function t(t,n){var i;return(i=e.call(this,t)||this).kind=void 0,i.kind=n,i}return $(t,e),t}(zW),ZW=function(){function e(e,t){this.type=void 0,this._value=void 0,this._refs=[],this.type=e,this._value=t}return e.prototype.bind=function(e,t){for(var n=arguments.length,i=new Array(n>2?n-2:0),r=2;r<n;r++)i[r-2]=arguments[r];return this._refs.push({fn:e,thisArg:t,args:i}),this._value},Z(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e;for(var t,n=se(this._refs);!(t=n()).done;){var i=t.value,r=i.fn,o=i.thisArg,a=i.args;r.call.apply(r,[o,e].concat(a))}}}]),e}(),JW=(VW=mc("cc.animation.AnimationController"),WW=Pc(),jW=xc(Wk),VW(qW=WW((KW=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"graph",YW,oe(t)),t._graphEval=null,t}$(t,e);var n=t.prototype;return n.start=function(){this.graph&&(this._graphEval=new IW(this.graph,this.node,this))},n.update=function(e){var t;null===(t=this._graphEval)||void 0===t||t.update(e)},n.getVariables=function(){return this._graphEval.getVariables()},n.setValue=function(e,t){this._graphEval.setValue(e,t)},n.getValue=function(e){return this._graphEval.getValue(e)},n.getCurrentStateStatus=function(e){return this._graphEval.getCurrentStateStatus(e)},n.getCurrentClipStatuses=function(e){return this._graphEval.getCurrentClipStatuses(e)},n.getCurrentTransition=function(e){return this._graphEval.getCurrentTransition(e)},n.getNextStateStatus=function(e){return this._graphEval.getNextStateStatus(e)},n.getNextClipStatuses=function(e){return this._graphEval.getNextClipStatuses(e)},t}(th),YW=le((XW=KW).prototype,"graph",[jW],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qW=XW))||qW)||qW);e("animation",Object.freeze({__proto__:null,UniformProxyFactory:GF,MorphWeightValueProxy:HF,MorphWeightsValueProxy:VF,MorphWeightsAllValueProxy:WF,Track:Iz,TrackPath:Pz,RealTrack:Nz,VectorTrack:Xz,QuatTrack:Zz,ColorTrack:eU,SizeTrack:iU,ObjectTrack:oU,isPropertyPath:mF,isCustomPath:function(e,t){return e instanceof t},HierarchyPath:UF,ComponentPath:kF,CubicSplineVec2Value:qF,CubicSplineVec3Value:XF,CubicSplineVec4Value:YF,CubicSplineQuatValue:KF,CubicSplineNumberValue:QF,AnimationController:JW,get VariableType(){return AU},StateMachineComponent:RW}));var $W,ej,tj,nj,ij,rj,oj,aj,sj,cj,lj,uj,hj,fj,_j,pj,dj,mj=function(e){function t(t){var n;return(n=e.call(this)||this)._managedStates=[],n._fadings=[],n._scheduled=!1,n._scheduler=null!=t?t:u.director.getAnimationManager(),n}$(t,e);var n=t.prototype;return n.update=function(e){if(!this.isMotionless){var t=this._managedStates,n=this._fadings;if(1===t.length&&1===n.length){var i=t[0].state;i&&(i.weight=1)}else this._calculateWeights(e);1===t.length&&1===n.length&&this._unscheduleThis()}},n.crossFade=function(e,t){var n;0===this._managedStates.length&&(t=0),0===t&&this.clear();var i=this._managedStates.find((function(t){return t.state===e}));i?(null===(n=i.state)||void 0===n?void 0:n.isMotionless)&&i.state.play():(i={state:e,reference:0},e&&e.play(),this._managedStates.push(i)),++i.reference,this._fadings.unshift({easeDuration:t,easeTime:0,target:i}),this.isMotionless||this._scheduleThis()},n.clear=function(){for(var e=0;e<this._managedStates.length;++e){var t=this._managedStates[e].state;t&&t.stop()}this._managedStates.length=0,this._fadings.length=0},n.onPlay=function(){e.prototype.onPlay.call(this),this._scheduleThis()},n.onPause=function(){e.prototype.onPause.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.pause()}this._unscheduleThis()},n.onResume=function(){e.prototype.onResume.call(this);for(var t=0;t<this._managedStates.length;++t){var n=this._managedStates[t].state;n&&n.resume()}this._scheduleThis()},n.onStop=function(){e.prototype.onStop.call(this),this.clear()},n._calculateWeights=function(e){for(var t=this._managedStates,n=this._fadings,i=0;i<t.length;++i){var r=t[i].state;r&&(r.weight=0)}for(var o=1,a=n.length,s=0;s<n.length;++s){var c=n[s];c.easeTime+=e;var l=0===c.easeDuration?1:un(c.easeTime/c.easeDuration),u=l*o;if(o*=1-l,c.target.state&&(c.target.state.weight+=u),c.easeTime>=c.easeDuration){a=s+1,c.easeTime=c.easeDuration;break}}if(a!==n.length){for(var h=a;h<n.length;++h){var f=n[h];--f.target.reference,f.target.reference<=0&&(f.target.state&&f.target.state.stop(),_e(this._managedStates,f.target))}n.splice(a)}},n._scheduleThis=function(){this._scheduled||(this._scheduler.addCrossFade(this),this._scheduled=!0)},n._unscheduleThis=function(){this._scheduled&&(this._scheduler.removeCrossFade(this),this._scheduled=!1)},t}(FH),vj=function(t){return e({AnimationComponent:t,Animation:t}),t}(($W=mc("cc.Animation"),ej=Oc(),tj=gc(99),nj=Pc(),ij=Zc([CH]),rj=Fc(),oj=Zc(CH),aj=Fc(),sj=Fc(),cj=Zc([CH]),$W(lj=ej(lj=tj(lj=wc(lj=nj((dj=pj=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"playOnLoad",hj,oe(t)),t._crossFade=new mj,t._nameToState=Re(!0),ce(t,"_clips",fj,oe(t)),ce(t,"_defaultClip",_j,oe(t)),t._hasBeenPlayed=!1,t}$(t,e);var n=t.prototype;return n.onLoad=function(){for(var e in this.clips=this._clips,this._nameToState)this._nameToState[e].initialize(this.node)},n.start=function(){this.playOnLoad&&!this._hasBeenPlayed&&this._defaultClip&&this.crossFade(this._defaultClip.name,0)},n.onEnable=function(){this._crossFade.resume()},n.onDisable=function(){this._crossFade.pause()},n.onDestroy=function(){for(var e in this._crossFade.stop(),this._nameToState)this._nameToState[e].destroy();this._nameToState=Re(!0)},n.play=function(e){if(this._hasBeenPlayed=!0,!e){if(!this._defaultClip)return;e=this._defaultClip.name}this.crossFade(e,0)},n.crossFade=function(e,t){void 0===t&&(t=.3),this._hasBeenPlayed=!0;var n=this._nameToState[e];n&&this.doPlayOrCrossFade(n,t)},n.pause=function(){this._crossFade.pause()},n.resume=function(){this._crossFade.resume()},n.stop=function(){this._crossFade.stop()},n.getAnimationState=function(e){return this.getState(e)},n.getState=function(e){var t=this._nameToState[e];return t&&!t.curveLoaded&&t.initialize(this.node),t||null},n.createState=function(e,t){return t=t||e.name,this.removeState(t),this._doCreateState(e,t)},n.removeState=function(e){var t=this._nameToState[e];t&&(t.allowLastFrameEvent(!1),t.stop(),delete this._nameToState[e])},n.addClip=function(e,t){return de(this._clips,e)||this._clips.push(e),this.createState(e,t)},n.removeClip=function(e,t){var n;for(var i in this._nameToState){var r=this._nameToState[i];if(r.clip===e){n=r;break}}if(e===this._defaultClip){if(!t)return void D(3902);this._defaultClip=null}if(n&&n.isPlaying){if(!t)return void D(3903);n.stop()}this._clips=this._clips.filter((function(t){return t!==e})),n&&delete this._nameToState[n.name]},n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return t===BH.LASTFRAME&&this._syncAllowLastFrameEvent(),o},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return t===BH.LASTFRAME&&this._syncAllowLastFrameEvent(),r},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),t===BH.LASTFRAME&&this._syncDisallowLastFrameEvent()},n._createState=function(e,t){return new UH(e,t)},n._doCreateState=function(e,t){var n=this._createState(e,t);return n._setEventTarget(this),n.allowLastFrameEvent(this.hasEventListener(BH.LASTFRAME)),this.node&&n.initialize(this.node),this._nameToState[n.name]=n,n},n.doPlayOrCrossFade=function(e,t){this._crossFade.play(),this._crossFade.crossFade(e,t)},n._removeStateOfAutomaticClip=function(e){for(var t in this._nameToState){var n=this._nameToState[t];gj(e,n.clip)&&(n.stop(),delete this._nameToState[t])}},n._syncAllowLastFrameEvent=function(){if(this.hasEventListener(BH.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!0)},n._syncDisallowLastFrameEvent=function(){if(!this.hasEventListener(BH.LASTFRAME))for(var e in this._nameToState)this._nameToState[e].allowLastFrameEvent(!1)},Z(t,[{key:"clips",get:function(){return this._clips},set:function(e){var t=this;this._crossFade&&this._crossFade.clear();for(var n,i=se(this._clips);!(n=i()).done;){var r=n.value;r&&this._removeStateOfAutomaticClip(r)}for(var o,a=se(e);!(o=a()).done;){var s=o.value;s&&this.createState(s)}var c=e.find((function(e){return gj(e,t._defaultClip)}));this._defaultClip=c||null,this._clips=e}},{key:"defaultClip",get:function(){return this._defaultClip},set:function(e){this._defaultClip=e,e&&(this._clips.findIndex((function(t){return gj(t,e)}))>=0||(this._clips.push(e),this.createState(e)))}}]),t}(nu(th)),pj.EventType=BH,le((uj=dj).prototype,"clips",[ij,rj],Object.getOwnPropertyDescriptor(uj.prototype,"clips"),uj.prototype),le(uj.prototype,"defaultClip",[oj,aj],Object.getOwnPropertyDescriptor(uj.prototype,"defaultClip"),uj.prototype),hj=le(uj.prototype,"playOnLoad",[Tc,sj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fj=le(uj.prototype,"_clips",[cj],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_j=le(uj.prototype,"_defaultClip",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),lj=uj))||lj)||lj)||lj)||lj)||lj));function gj(e,t){return e===t||!!e&&!!t&&e._uuid===t._uuid&&e._uuid}u.Animation=vj,k(vj.prototype,"Animation",[{name:"getAnimationState",newName:"getState"},{name:"addClip",newName:"createState"},{name:"removeClip",newName:"removeState",customFunction:function(){var e=arguments.length<=0?void 0:arguments[0];return vj.prototype.removeState.call(this,e.name)}}]),u.AnimationComponent=vj,rt.setClassAlias(vj,"cc.AnimationComponent");var yj,xj,Sj,Tj=[],bj=new Map;function Ej(e,t){for(var n=0,i=jn.IDENTITY;e;){if(e.stamp===t||e.stamp+1===t&&!e.node.hasChangedFlags){i=e.world,e.stamp=t;break}e.stamp=t,Tj[n++]=e,e=e.parent}for(;n>0;){e=Tj[--n],Tj[n]=null;var r=e.node;jn.fromRTS(e.local,r.rotation,r.position,r.scale),i=jn.multiply(e.world,i,e.local)}return i}function Cj(e,t){for(var n,i=null,r=0;e!==t;){var o=e.uuid;if(bj.has(o)){i=bj.get(o);break}i={node:e,local:new jn,world:new jn,stamp:-1,parent:null},bj.set(o,i),Tj[r++]=i,e=e.parent,i=null}for(;r>0;)n=Tj[--r],Tj[r]=null,n.parent=i,i=n;return i}function Aj(e){for(var t=bj.get(e.uuid)||null;t;)bj.delete(t.node.uuid),t=t.parent}var wj=e("AnimationManager",mc((Sj=xj=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._anims=new ue([]),t._crossFades=new ue([]),t._delayEvents=[],t._blendStateBuffer=new bW,t._sockets=[],t}$(t,e);var n=t.prototype;return n.addCrossFade=function(e){-1===this._crossFades.array.indexOf(e)&&this._crossFades.push(e)},n.removeCrossFade=function(e){var t=this._crossFades.array.indexOf(e);t>=0?this._crossFades.fastRemoveAt(t):M(3907)},n.update=function(e){var t=this._delayEvents,n=this._crossFades,i=this._sockets,r=n.array;for(n.i=0;n.i<r.length;++n.i)r[n.i].update(e);var o=this._anims,a=o.array;for(o.i=0;o.i<a.length;++o.i){var s=a[o.i];s.isMotionless||s.update(e)}this._blendStateBuffer.apply();for(var c=u.director.getTotalFrames(),l=0,h=i.length;l<h;l++){var f=i[l],_=f.target,p=f.transform;_.matrix=Ej(p,c)}for(var d=0,m=t.length;d<m;d++){var v=t[d];v.fn.apply(v.thisArg,v.args)}t.length=0},n.destruct=function(){},n.addAnimation=function(e){-1===this._anims.array.indexOf(e)&&this._anims.push(e)},n.removeAnimation=function(e){var t=this._anims.array.indexOf(e);t>=0?this._anims.fastRemoveAt(t):M(3907)},n.pushDelayEvent=function(e,t,n){this._delayEvents.push({fn:e,thisArg:t,args:n})},n.addSockets=function(e,t){for(var n=this,i=function(i){var r=t[i];if(n._sockets.find((function(e){return e.target===r.target})))return"continue";var o=e.getChildByPath(r.path),a=r.target&&o&&Cj(o,e);a&&n._sockets.push({target:r.target,transform:a})},r=0;r<t.length;++r)i(r)},n.removeSockets=function(e,t){for(var n=0;n<t.length;++n)for(var i=t[n],r=0;r<this._sockets.length;++r){var o=this._sockets[r];if(o.target===i.target){Aj(o.transform.node),this._sockets[r]=this._sockets[this._sockets.length-1],this._sockets.length--;break}}},Z(t,[{key:"blendState",get:function(){return this._blendStateBuffer}}]),t}(DM),xj.ID="animation",yj=Sj))||yj);jM.on(WM.EVENT_INIT,(function(){var e=new wj;jM.registerSystem(wj.ID,e,DM.Priority.HIGH)})),u.AnimationManager=wj;var Pj,Rj,Ij,Dj,Oj=new jn;function Mj(e,t,n){for(jn.identity(n);e!==t;)jn.fromRTS(Oj,e.rotation,e.position,e.scale),jn.multiply(n,Oj,n),e=e.parent;return n}u.easing=i_;var Nj=e("HierachyModifier",mc("cc.HierachyModifier")(Pj=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(UF))||Pj);u.HierachyModifier=Nj;var Lj=e("ComponentModifier",mc("cc.ComponentModifier")(Rj=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(kF))||Rj);u.ComponentModifier=Lj;var Bj=e("CurveValueAdapter",mc("cc.CurveValueAdapter")(Ij=function(){function e(){}return e.prototype.forTarget=function(){return{set:function(){}}},e}())||Ij);u.CurveValueAdapter=Bj;var Fj=e("UniformCurveValueAdapter",mc("cc.UniformCurveValueAdapter")(Dj=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(GF))||Dj);function zj(e){return"string"==typeof e}function Uj(e){return"number"==typeof e}function kj(e,t){return e instanceof t}u.UniformCurveValueAdapter=Fj,u.isPropertyModifier=zj,u.isElementModifier=Uj,u.isCustomTargetModifier=kj,u.math=ci,u.geometry=Lp;var Gj=new In,Hj=new jn;function Vj(e,t,n,i){var r=n.chunk,o=n.data,a=r.vb,s=n.vertexCount;e.getWorldMatrix(Hj);for(var c=0,l=0;l<s;l++){var u=o[l];In.set(Gj,u.x,u.y,0),In.transformMat4(Gj,Gj,Hj),a[c++]=Gj.x,a[c++]=Gj.y,a[c++]=Gj.z,Pn.toArray(a,i,c+2),c+=6}for(var h=r.bufferId,f=r.vertexOffset,_=r.vertexAccessor.getMeshBuffer(r.bufferId),p=r.vertexAccessor.getIndexBuffer(h),d=_.indexOffset,m=0,v=s/4;m<v;m++){var g=f+4*m;p[d++]=g,p[d++]=g+1,p[d++]=g+2,p[d++]=g+1,p[d++]=g+3,p[d++]=g+2}_.indexOffset+=n.indexCount,_.setDirty()}var Wj=function(){function e(e,t){this._texture=void 0,this._width=void 0,this._height=void 0,this._x=void 0,this._y=void 0,this._nexty=void 0,this._innerTextureInfos={},this._innerSpriteFrames=void 0,this._count=void 0;var n=new jj;n.initWithSize(e,t),this._texture=n,this._width=e,this._height=t,this._x=2,this._y=2,this._nexty=2,this._innerTextureInfos={},this._innerSpriteFrames=[],this._count=0}var t=e.prototype;return t.insertSpriteFrame=function(e){var t=e.rect,n=e.texture,i=this._innerTextureInfos[n.getId()],r=t.x,o=t.y;if(i)r+=i.x,o+=i.y;else{var a=n.width,s=n.height;if(this._x+a+2>this._width&&(this._x=2,this._y=this._nexty),this._y+s+2>this._nexty&&(this._nexty=this._y+s+2),this._nexty>this._height)return null;u.internal.dynamicAtlasManager.textureBleeding&&((a<=8||s<=8)&&(this._texture.drawTextureAt(n.image,this._x-1,this._y-1),this._texture.drawTextureAt(n.image,this._x-1,this._y+1),this._texture.drawTextureAt(n.image,this._x+1,this._y-1),this._texture.drawTextureAt(n.image,this._x+1,this._y+1)),this._texture.drawTextureAt(n.image,this._x-1,this._y),this._texture.drawTextureAt(n.image,this._x+1,this._y),this._texture.drawTextureAt(n.image,this._x,this._y-1),this._texture.drawTextureAt(n.image,this._x,this._y+1)),this._texture.drawTextureAt(n.image,this._x,this._y),this._innerTextureInfos[n.getId()]={x:this._x,y:this._y,texture:n},this._count++,r+=this._x,o+=this._y,this._x+=a+2}var c={x:r,y:o,texture:this._texture};return this._innerSpriteFrames.push(e),c},t.deleteInnerTexture=function(e){e&&this._innerTextureInfos[e.getId()]&&(delete this._innerTextureInfos[e.getId()],this._count--)},t.isEmpty=function(){return this._count<=0},t.reset=function(){this._x=2,this._y=2,this._nexty=2;for(var e=this._innerSpriteFrames,t=0,n=e.length;t<n;t++){var i=e[t];i.isValid&&i._resetDynamicAtlasFrame()}this._innerSpriteFrames.length=0,this._innerTextureInfos={}},t.destroy=function(){this.reset(),this._texture.destroy()},e}(),jj=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=Mm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new sr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(Cv),qj=function(){function e(){this._atlases=[],this._atlasIndex=-1,this._maxAtlasCount=5,this._textureSize=2048,this._maxFrameSize=512,this._textureBleeding=!0,this._enabled=!1}var t=e.prototype;return t.newAtlas=function(){var e=this._atlases[++this._atlasIndex];return e||(e=new Wj(this._textureSize,this._textureSize),this._atlases.push(e)),e},t.beforeSceneLoad=function(){this.reset()},t.insertSpriteFrame=function(e){if(!this._enabled||this._atlasIndex===this._maxAtlasCount||!e||e._original)return null;if(!e.packable)return null;var t=e.texture.getSamplerInfo();if(t.minFilter!==Lm.LINEAR||t.magFilter!==Lm.LINEAR||t.mipFilter!==Lm.NONE)return null;var n=this._atlases[this._atlasIndex];n||(n=this.newAtlas());var i=n.insertSpriteFrame(e);return i||this._atlasIndex===this._maxAtlasCount?i:(n=this.newAtlas()).insertSpriteFrame(e)},t.reset=function(){for(var e=0,t=this._atlases.length;e<t;e++)this._atlases[e].destroy();this._atlases.length=0,this._atlasIndex=-1},t.deleteAtlasSpriteFrame=function(e){if(e._original){for(var t,n=this._atlases.length-1;n>=0;n--)t=this._atlases[n],rt.array.fastRemove(t._innerSpriteFrames,e);var i=e._original._texture;this.deleteAtlasTexture(i)}},t.deleteAtlasTexture=function(e){if(e)for(var t=this._atlases.length-1;t>=0;t--)this._atlases[t].deleteInnerTexture(e),this._atlases[t].isEmpty()&&(this._atlases[t].destroy(),this._atlases.splice(t,1),this._atlasIndex--)},t.packToDynamicAtlas=function(e,t){if(t&&!t._original&&t.packable&&t.texture&&t.texture.width>0&&t.texture.height>0){var n=this.insertSpriteFrame(t);n&&t._setDynamicAtlasFrame(n)}},Z(e,[{key:"enabled",get:function(){return this._enabled},set:function(e){this._enabled!==e&&(e?(this.reset(),u.director.on(u.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)):(this.reset(),u.director.off(u.Director.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)),this._enabled=e)}},{key:"maxAtlasCount",get:function(){return this._maxAtlasCount},set:function(e){this._maxAtlasCount=e}},{key:"atlasCount",get:function(){return this._atlases.length}},{key:"textureBleeding",get:function(){return this._textureBleeding},set:function(e){this._textureBleeding=e}},{key:"textureSize",get:function(){return this._textureSize},set:function(e){this._textureSize=e}},{key:"maxFrameSize",get:function(){return this._maxFrameSize},set:function(e){this._maxFrameSize=e}}]),e}();qj.instance=void 0;var Xj,Yj,Kj,Qj=e("dynamicAtlasManager",qj.instance=new qj);u.internal.dynamicAtlasManager=Qj;var Zj,Jj,$j,eq,tq=[{u:0,v:0},{u:0,v:0},{u:0,v:0},{u:0,v:0}],nq=e("SpriteFrame",mc("cc.SpriteFrame")((Kj=Yj=function(e){function t(){var t;return(t=e.call(this)||this).vertices=null,t.uv=[],t.unbiasUV=[],t.uvSliced=[],t._rect=new ri,t._offset=new Kn,t._originalSize=new ni,t._rotated=!1,t._capInsets=[0,0,0,0],t._atlasUuid="",t._texture=void 0,t._isFlipUVY=!1,t._isFlipUVX=!1,t._original=null,t._packable=!0,t}$(t,e),t.createWithImage=function(e){var n=e instanceof nv?e:new nv(e),i=new Cv;i.image=n;var r=new t;return r.texture=i,r};var n=t.prototype;return n.textureLoaded=function(){return!!this.texture},n.isRotated=function(){return this._rotated},n.setRotated=function(e){this.rotated=e},n.getRect=function(e){return e?(e.set(this._rect),e):this._rect.clone()},n.setRect=function(e){this.rect=e},n.getOriginalSize=function(e){return e?(e.set(this._originalSize),e):this._originalSize.clone()},n.setOriginalSize=function(e){this.originalSize=e},n.getOffset=function(e){return e?(e.set(this._offset),e):this._offset.clone()},n.setOffset=function(e){this.offset=e},n.getGFXTexture=function(){return this._texture.getGFXTexture()},n.getGFXSampler=function(){return this._texture.getGFXSampler()},n.getHash=function(){return this._texture.getHash()},n.getSamplerInfo=function(){return this._texture.getSamplerInfo()},n.reset=function(e,t){void 0===t&&(t=!1);var n=!1;t&&(this._originalSize.set(0,0),this._rect.set(0,0,0,0),this._offset.set(0,0),this._capInsets=[0,0,0,0],this._rotated=!1,n=!0),e&&(e.texture&&(this._rect.x=this._rect.y=0,this._rect.width=e.texture.width,this._rect.height=e.texture.height,this._refreshTexture(e.texture),this.checkRect(this._texture)),e.originalSize&&this._originalSize.set(e.originalSize),e.rect&&this._rect.set(e.rect),e.offset&&this._offset.set(e.offset),void 0!==e.borderTop&&(this._capInsets[1]=e.borderTop),void 0!==e.borderBottom&&(this._capInsets[3]=e.borderBottom),void 0!==e.borderLeft&&(this._capInsets[0]=e.borderLeft),void 0!==e.borderRight&&(this._capInsets[2]=e.borderRight),void 0!==e.isRotate&&(this._rotated=!!e.isRotate),void 0!==e.isFlipUv&&(this._isFlipUVY=!!e.isFlipUv),n=!0),n&&this.texture&&this._calculateUV()},n.checkRect=function(e){var t=this._rect,n=t.x,i=t.y;return this._rotated?(n+=t.height,i+=t.width):(n+=t.width,i+=t.height),n>e.width?(M(3300,this.name+"/"+e.name,n,e.width),!1):!(i>e.height&&(M(3301,this.name+"/"+e.name,i,e.height),1))},n.destroy=function(){return this._packable&&Qj&&Qj.deleteAtlasSpriteFrame(this),e.prototype.destroy.call(this)},n._calculateSlicedUV=function(){var e=this._rect,n=this.texture,i=n.width,r=n.height,o=this._capInsets[0],a=this._capInsets[2],s=e.width-o-a,c=this._capInsets[1],l=this._capInsets[3],u=e.height-c-l,h=this.uvSliced;if(h.length=0,this._rotated){tq[0].u=e.x/i,tq[1].u=(e.x+l)/i,tq[2].u=(e.x+l+u)/i,tq[3].u=(e.x+e.height)/i,tq[3].v=e.y/r,tq[2].v=(e.y+o)/r,tq[1].v=(e.y+o+s)/r,tq[0].v=(e.y+e.width)/r;for(var f=0;f<4;++f)for(var _=tq[f],p=0;p<4;++p){var d=tq[3-p];h.push({u:_.u,v:d.v})}}else{tq[0].u=e.x/i,tq[1].u=(e.x+o)/i,tq[2].u=(e.x+o+s)/i,tq[3].u=(e.x+e.width)/i,tq[3].v=e.y/r,tq[2].v=(e.y+c)/r,tq[1].v=(e.y+c+u)/r,tq[0].v=(e.y+e.height)/r;for(var m=0;m<4;++m)for(var v=tq[m],g=0;g<4;++g){var y=tq[g];h.push({u:y.u,v:v.v})}}this.emit(t.EVENT_UV_UPDATED,this)},n._calculateUV=function(){var e=this._rect,t=this.uv,n=this.unbiasUV,i=this.texture,r=i.width,o=i.height;if(this._rotated){var a=0===r?0:e.x/r,s=0===r?1:(e.x+e.height)/r,c=0===o?0:e.y/o,l=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=s,t[1]=l,t[2]=s,t[3]=c,t[4]=a,t[5]=l,t[6]=a,t[7]=c):this._isFlipUVX?(t[0]=s,t[1]=c,t[2]=s,t[3]=l,t[4]=a,t[5]=c,t[6]=a,t[7]=l):this._isFlipUVY?(t[0]=a,t[1]=l,t[2]=a,t[3]=c,t[4]=s,t[5]=l,t[6]=s,t[7]=c):(t[0]=a,t[1]=c,t[2]=a,t[3]=l,t[4]=s,t[5]=c,t[6]=s,t[7]=l);var u=0===r?0:e.x/r,h=0===r?1:(e.x+e.height)/r,f=0===o?0:e.y/o,_=0===o?1:(e.y+e.width)/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=h,n[1]=_,n[2]=h,n[3]=f,n[4]=u,n[5]=_,n[6]=u,n[7]=f):this._isFlipUVX?(n[0]=h,n[1]=f,n[2]=h,n[3]=_,n[4]=u,n[5]=f,n[6]=u,n[7]=_):this._isFlipUVY?(n[0]=u,n[1]=_,n[2]=u,n[3]=f,n[4]=h,n[5]=_,n[6]=h,n[7]=f):(n[0]=u,n[1]=f,n[2]=u,n[3]=_,n[4]=h,n[5]=f,n[6]=h,n[7]=_)}else{var p=0===r?0:e.x/r,d=0===r?1:(e.x+e.width)/r,m=0===o?1:(e.y+e.height)/o,v=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(t[0]=d,t[1]=v,t[2]=p,t[3]=v,t[4]=d,t[5]=m,t[6]=p,t[7]=m):this._isFlipUVX?(t[0]=d,t[1]=m,t[2]=p,t[3]=m,t[4]=d,t[5]=v,t[6]=p,t[7]=v):this._isFlipUVY?(t[0]=p,t[1]=v,t[2]=d,t[3]=v,t[4]=p,t[5]=m,t[6]=d,t[7]=m):(t[0]=p,t[1]=m,t[2]=d,t[3]=m,t[4]=p,t[5]=v,t[6]=d,t[7]=v);var g=0===r?0:e.x/r,y=0===r?1:(e.x+e.width)/r,x=0===o?1:(e.y+e.height)/o,S=0===o?0:e.y/o;this._isFlipUVX&&this._isFlipUVY?(n[0]=y,n[1]=S,n[2]=g,n[3]=S,n[4]=y,n[5]=x,n[6]=g,n[7]=x):this._isFlipUVX?(n[0]=y,n[1]=x,n[2]=g,n[3]=x,n[4]=y,n[5]=S,n[6]=g,n[7]=S):this._isFlipUVY?(n[0]=g,n[1]=S,n[2]=y,n[3]=S,n[4]=g,n[5]=x,n[6]=y,n[7]=x):(n[0]=g,n[1]=x,n[2]=y,n[3]=x,n[4]=g,n[5]=S,n[6]=y,n[7]=S)}var T=this.vertices;if(T){T.nu.length=0,T.nv.length=0;for(var b=0;b<T.u.length;b++)T.nu[b]=T.u[b]/r,T.nv[b]=T.v[b]/o}this._calculateSlicedUV()},n._setDynamicAtlasFrame=function(e){e&&(this._original={_texture:this._texture,_x:this._rect.x,_y:this._rect.y},this._texture=e.texture,this._rect.x=e.x,this._rect.y=e.y,this._calculateUV())},n._resetDynamicAtlasFrame=function(){this._original&&(this._rect.x=this._original._x,this._rect.y=this._original._y,this._texture=this._original._texture,this._original=null,this._calculateUV())},n._checkPackable=function(){var e=Qj;if(e){var t=this._texture;if(t instanceof Cv&&!t.isCompressed){var n=this.width,i=this.height;!t.image||n>e.maxFrameSize||i>e.maxFrameSize?this._packable=!1:t.image&&t.image instanceof HTMLCanvasElement&&(this._packable=!0)}else this._packable=!1}},n._serialize=function(){return null},n._deserialize=function(e){var t=e,n=t.rect;n&&(this._rect=new ri(n.x,n.y,n.width,n.height));var i=t.offset;t.offset&&(this._offset=new Kn(i.x,i.y));var r=t.originalSize;t.originalSize&&(this._originalSize=new ni(r.width,r.height)),this._rotated=!!t.rotated,this._name=t.name,this._packable=!!t.packable;var o=t.capInsets;o&&(this._capInsets[0]=o[0],this._capInsets[1]=o[1],this._capInsets[2]=o[2],this._capInsets[3]=o[3]),this.vertices=t.vertices,this.vertices&&(this.vertices.nu=[],this.vertices.nv=[])},n.clone=function(){var e,n,i,r,o,a,s,c,l=new t,u=this.vertices;return l.vertices=u?{x:u.x,y:u.y,triangles:u.triangles,nu:null===(e=u.nu)||void 0===e?void 0:e.slice(0),u:null===(n=u.u)||void 0===n?void 0:n.slice(0),nv:null===(i=u.nv)||void 0===i?void 0:i.slice(0),v:null===(r=u.v)||void 0===r?void 0:r.slice(0)}:null,(o=l.uv).splice.apply(o,[0,l.uv.length].concat(this.uv)),(a=l.unbiasUV).splice.apply(a,[0,l.unbiasUV.length].concat(this.unbiasUV)),(s=l.uvSliced).splice.apply(s,[0,l.uvSliced.length].concat(this.uvSliced)),l._rect.set(this._rect),l._offset.set(this._offset),l._originalSize.set(this._originalSize),l._rotated=this._rotated,(c=l._capInsets).splice.apply(c,[0,l._capInsets.length].concat(this._capInsets)),l._atlasUuid=this._atlasUuid,l._texture=this._texture,l._isFlipUVX=this._isFlipUVX,l._isFlipUVY=this._isFlipUVY,l},n._refreshTexture=function(e){this._texture=e;var t=this._texture,n={},i=!1;0!==this._rect.width&&0!==this._rect.height&&this.checkRect(t)||(n.rect=new ri(0,0,t.width,t.height),i=!0),(0===this._originalSize.width||0===this._originalSize.height||i)&&(n.originalSize=new ni(t.width,t.height),i=!0),i&&(this.reset(n),this.onLoaded()),this._checkPackable()},n.initDefault=function(t){e.prototype.initDefault.call(this,t);var n=new Cv;n.initDefault(),this._refreshTexture(n),this._calculateUV()},n.validate=function(){return this._texture&&this._rect&&0!==this._rect.width&&0!==this._rect.height},Z(t,[{key:"insetTop",get:function(){return this._capInsets[1]},set:function(e){this._capInsets[1]!==e&&(this._capInsets[1]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetBottom",get:function(){return this._capInsets[3]},set:function(e){this._capInsets[3]!==e&&(this._capInsets[3]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetLeft",get:function(){return this._capInsets[0]},set:function(e){this._capInsets[0]!==e&&(this._capInsets[0]=e,this._texture&&this._calculateSlicedUV())}},{key:"insetRight",get:function(){return this._capInsets[2]},set:function(e){this._capInsets[2]!==e&&(this._capInsets[2]=e,this._texture&&this._calculateSlicedUV())}},{key:"rect",get:function(){return this._rect},set:function(e){this._rect.equals(e)||(this._rect.set(e),this._texture&&this._calculateUV())}},{key:"originalSize",get:function(){return this._originalSize},set:function(e){this._originalSize.equals(e)||(this._originalSize.set(e),this._texture&&this._calculateUV())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e)}},{key:"rotated",get:function(){return this._rotated},set:function(e){this._rotated!==e&&(this._rotated=e,this._texture&&this._calculateUV())}},{key:"texture",get:function(){return this._texture},set:function(e){e?this.reset({texture:e},!0):console.warn("Error Texture in "+this.name)}},{key:"atlasUuid",get:function(){return this._atlasUuid},set:function(e){this._atlasUuid=e}},{key:"width",get:function(){return this._texture.width}},{key:"height",get:function(){return this._texture.height}},{key:"_textureSource",set:function(e){window.Build?this._texture=e:e&&(this._refreshTexture(e),this._calculateUV())}},{key:"flipUVX",get:function(){return this._isFlipUVX},set:function(e){this._isFlipUVX=e,this._calculateUV()}},{key:"flipUVY",get:function(){return this._isFlipUVY},set:function(e){this._isFlipUVY=e,this._calculateUV()}},{key:"packable",get:function(){return this._packable},set:function(e){this._packable=e}},{key:"original",get:function(){return this._original}}]),t}(Nu),Yj.EVENT_UV_UPDATED="uv_updated",Xj=Kj))||Xj);u.SpriteFrame=nq;var iq,rq=e("SpriteAtlas",mc("cc.SpriteAtlas")((eq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"spriteFrames",$j,oe(t)),t}$(t,e);var n=t.prototype;return n.getTexture=function(){var e=Object.keys(this.spriteFrames);if(e.length>0){var t=this.spriteFrames[e[0]];return t&&t.texture}return null},n.getSpriteFrame=function(e){var t=this.spriteFrames[e];return t?(t.name||(t.name=e),t):null},n.getSpriteFrames=function(){for(var e=[],t=this.spriteFrames,n=0,i=Object.keys(t);n<i.length;n++){var r=i[n];e.push(t[r])}return e},n._serialize=function(){},n._deserialize=function(e,t){var n=e;this._name=n.name;var i=n.spriteFrames;this.spriteFrames=Re();for(var r=0;r<i.length;r+=2)t.result.push(this.spriteFrames,i[r],i[r+1],tt(nq))},t}(Nu),$j=le((Jj=eq).prototype,"spriteFrames",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Re()}}),Zj=Jj))||Zj);u.SpriteAtlas=rq;var oq,aq,sq,cq,lq=e("Font",mc("cc.Font")(iq=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(Nu))||iq);u.Font=lq;var uq,hq,fq,_q,pq,dq,mq,vq,gq,yq=e("TTFFont",mc("cc.TTFFont")((cq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_fontFamily",sq,oe(t)),t}return $(t,e),t.prototype.initDefault=function(t){this._fontFamily="Arial",e.prototype.initDefault.call(this,t)},Z(t,[{key:"_nativeAsset",get:function(){return this._fontFamily},set:function(e){this._fontFamily=e||"Arial"}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,__nativeName__:this._native,ext:Tu(this._native),__isNative__:!0}}}]),t}(lq),sq=le((aq=cq).prototype,"_fontFamily",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(aq.prototype,"_nativeAsset",[sl,Qc],Object.getOwnPropertyDescriptor(aq.prototype,"_nativeAsset"),aq.prototype),le(aq.prototype,"_nativeDep",[sl],Object.getOwnPropertyDescriptor(aq.prototype,"_nativeDep"),aq.prototype),oq=aq))||oq);u.TTFFont=yq;var xq,Sq=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.offsetX=0,this.offsetY=0,this.textureID=0,this.valid=!1,this.xAdvance=0},Tq=function(){function e(e){this.letterDefinitions={},this.texture=e}var t=e.prototype;return t.addLetterDefinitions=function(e,t){this.letterDefinitions[e]=t},t.cloneLetterDefinition=function(){for(var e={},t=0,n=Object.keys(this.letterDefinitions);t<n.length;t++){var i=n[t],r=new Sq;ke(r,this.letterDefinitions[i]),e[i]=r}return e},t.getTexture=function(){return this.texture},t.getLetter=function(e){return this.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e){var t=e.charCodeAt(0);return this.letterDefinitions.hasOwnProperty(t)?this.letterDefinitions[t]:null},t.clear=function(){this.letterDefinitions={}},e}(),bq=e("BitmapFont",(uq=mc("cc.BitmapFont"),hq=Zc(nq),uq((gq=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"fntDataStr",pq,oe(t)),ce(t,"spriteFrame",dq,oe(t)),ce(t,"fontSize",mq,oe(t)),ce(t,"fntConfig",vq,oe(t)),t}return $(t,e),t.prototype.onLoaded=function(){var e=this.spriteFrame;!this.fontDefDictionary&&e&&(this.fontDefDictionary=new Tq(e.texture));var t=this.fntConfig;if(t){var n=t.fontDefDictionary;for(var i in n){var r=new Sq,o=n[i].rect;r.offsetX=n[i].xOffset,r.offsetY=n[i].yOffset,r.w=o.width,r.h=o.height,r.u=o.x,r.v=o.y,r.textureID=0,r.valid=!0,r.xAdvance=n[i].xAdvance,this.fontDefDictionary.addLetterDefinitions(i,r)}}else S("The fnt config is not exists!")},t}(lq),pq=le((_q=gq).prototype,"fntDataStr",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),dq=le(_q.prototype,"spriteFrame",[hq],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mq=le(_q.prototype,"fontSize",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),vq=le(_q.prototype,"fntConfig",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fq=_q))||fq));u.BitmapFont=bq;var Eq=e("LabelAtlas",mc("cc.LabelAtlas")(xq=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(bq))||xq);u.LabelAtlas=Eq;var Cq=e("BASELINE_RATIO",.26),Aq=e("MIDDLE_RATIO",(Cq+1)/2-Cq);var wq=new nt(2);wq.get=function(){return this._get()||{key:"",value:0,prev:null,next:null}};var Pq,Rq=new(function(){function e(e){this.count=0,this.limit=0,this.datas={},this.limit=e}var t=e.prototype;return t.moveToHead=function(e){e.next=this.head,e.prev=null,this.head&&(this.head.prev=e),this.head=e,this.tail||(this.tail=e),this.count++,this.datas[e.key]=e},t.put=function(e,t){var n=wq.get();if(n.key=e,n.value=t,this.count>=this.limit){var i=this.tail;delete this.datas[i.key],this.count--,this.tail=i.prev,this.tail.next=null,i.prev=null,i.next=null,wq.put(i)}this.moveToHead(n)},t.remove=function(e){e.prev?e.prev.next=e.next:this.head=e.next,e.next?e.next.prev=e.prev:this.tail=e.prev,delete this.datas[e.key],this.count--},t.get=function(e){var t=this.datas[e];return t?(this.remove(t),this.moveToHead(t),t.value):null},t.clear=function(){this.count=0,this.datas={},this.head=null,this.tail=null},t.has=function(e){return!!this.datas[e]},t.delete=function(e){var t=this.datas[e];this.remove(t)},e}())(100),Iq=/([a-zA-Z0-9--]+|\S)/,Dq=/^[!,.:;'}\]%\?>]/,Oq=/([a-zA-Z0-9--]+|\S)$/,Mq=/[a-zA-Z0-9--]+$/,Nq=/^[a-zA-Z0-9--]/;function Lq(e){return/^[\u4E00-\u9FFF\u3400-\u4DFF]+$/.test(e)||/[\u3000-\u303F]|[\u3040-\u309F]|[\u30A0-\u30FF]|[\uFF00-\uFFEF]|[\u4E00-\u9FAF]|[\u2605-\u2606]|[\u2190-\u2195]|\u203B/g.test(e)||/^[\u1100-\u11FF]|[\u3130-\u318F]|[\uA960-\uA97F]|[\uAC00-\uD7AF]|[\uD7B0-\uD7FF]+$/.test(e)}function Bq(e){var t=e.charCodeAt(0);return t>=9&&t<=13||32===t||133===t||160===t||5760===t||t>=8192&&t<=8202||8232===t||8233===t||8239===t||8287===t||12288===t}function Fq(e,t,n){var i=(n||e.font)+""+t,r=Rq.get(i);if(null!==r)return r;var o=e.measureText(t),a=o&&o.width||0;return Rq.put(i,a),a}function zq(e,t,n){var i=t,r=n,o=e[t];if(o>="\udc00"&&o<="\udfff"&&i--,void 0!==n)if(n-1!==t){var a=e[n-1];a>="\ud800"&&a<="\udbff"&&r--}else o>="\ud800"&&o<="\udbff"&&r++;return e.substring(i,r)}function Uq(e,t,n,i){var r=[];if(0===e.length||n<0)return r.push(""),r;for(var o=e;t>n&&o.length>1;){for(var a=o.length*(n/t)|0,s=zq(o,a),c=t-i(s),l=s,u=0,h=0;c>n&&h++<10;)a*=n/c,c=t-i(s=zq(o,a|=0));for(h=0;c<=n&&h++<10;){if(s){var f=Iq.exec(s);u=f?f[0].length:1,l=s}c=t-i(s=zq(o,a+=u))}0==(a-=u)?(a=1,l=zq(o,1)):1===a&&o[0]>="\ud800"&&o[0]<="\udbff"&&(a=2,l=zq(o,2));var _=zq(o,0,a),p=void 0;Dq.test(l||s)&&(0==(a-=(p=Oq.exec(_))?p[0].length:0)&&(a=1),l=zq(o,a),_=zq(o,0,a)),Nq.test(l)&&(p=Mq.exec(_))&&_!==p[0]&&(l=zq(o,a-=p[0].length),_=zq(o,0,a)),(0===r.length||(_=_.trim()).length>0)&&r.push(_),t=i(o=l||s)}return(0===r.length||(o=o.trim()).length>0)&&r.push(o),r}var kq=e("CanvasPool",function(){function e(){this.pool=[]}e.getInstance=function(){return Pq||(Pq=new e),Pq};var t=e.prototype;return t.get=function(){var e=this.pool.pop();if(!e){var t=document.createElement("canvas"),n=t.getContext("2d");e={canvas:t,context:n}}return e},t.put=function(e){this.pool.length>=ft.MAX_LABEL_CANVAS_POOL_SIZE||this.pool.push(e)},e}()),Gq=Pn.WHITE.clone(),Hq=function(){this.u=0,this.v=0,this.w=0,this.h=0,this.texture=null,this.offsetX=0,this.offsetY=0,this.valid=!1,this.xAdvance=0},Vq="rgba(255, 255, 255, "+(1/255).toFixed(3)+")",Wq=function(){function e(e,t){this.image=null,this.labelInfo=void 0,this.char=void 0,this.data=null,this.canvas=null,this.context=null,this.width=0,this.height=0,this.offsetY=0,this.hash=void 0,this.char=e,this.labelInfo=t,this.hash=e.charCodeAt(0)+t.hash}var t=e.prototype;return t.updateRenderData=function(){this._updateProperties(),this._updateTexture()},t.destroy=function(){this.image=null},t._updateProperties=function(){if(this.data=kq.getInstance().get(),this.canvas=this.data.canvas,this.context=this.data.context,this.context){this.context.font=this.labelInfo.fontDesc;var e=Fq(this.context,this.char,this.labelInfo.fontDesc),t=2*this.labelInfo.margin+2;this.width=parseFloat(e.toFixed(2))+t,this.height=(1+Cq)*this.labelInfo.fontSize+t,this.offsetY=-this.labelInfo.fontSize*Cq/2}this.canvas.width!==this.width&&(this.canvas.width=this.width),this.canvas.height!==this.height&&(this.canvas.height=this.height),this.image||(this.image=new nv),this.image.reset(this.canvas)},t._updateTexture=function(){if(this.context&&this.canvas){var e=this.context,t=this.labelInfo,n=this.canvas.width,i=this.canvas.height;e.textAlign="center",e.textBaseline="alphabetic",e.clearRect(0,0,n,i),e.fillStyle=Vq,e.fillRect(0,0,n,i),e.font=t.fontDesc;var r=t.fontSize,o=n/2,a=i/2+r*Aq+0*r,s=t.color;if(e.lineJoin="round",e.fillStyle="rgba("+s.r+", "+s.g+", "+s.b+", 1)",t.isOutlined){var c=t.out||Gq;e.strokeStyle="rgba("+c.r+", "+c.g+", "+c.b+", "+c.a/255+")",e.lineWidth=2*t.margin,e.strokeText(this.char,o,a)}e.fillText(this.char,o,a)}},e}(),jq=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.initWithSize=function(e,t,n){void 0===n&&(n=Mm.RGBA8888),this.reset({width:e,height:t,format:n})},n.drawTextureAt=function(e,t,n){var i=this.getGFXTexture();if(e&&i){var r=this._getGFXDevice();if(r){var o=new sr;o.texOffset.x=t,o.texOffset.y=n,o.texExtent.width=e.width,o.texExtent.height=e.height,r.copyTexImagesToTexture([e.data],i,[o])}else console.warn("Unable to get device")}},t}(Cv),qq=function(){function e(e,t){this._x=0,this._y=0,this._nextY=0,this._width=0,this._height=0,this._halfBleed=0,this._dirty=!1;var n=new jq;n.initWithSize(e,t),this.fontDefDictionary=new Tq(n),this._halfBleed=1,this._width=e,this._height=t,jM.on(WM.EVENT_BEFORE_SCENE_LAUNCH,this.beforeSceneLoad,this)}var t=e.prototype;return t.insertLetterTexture=function(e){var t=e.image,n=jM.root.device;if(!t||!this.fontDefDictionary||!n)return null;var i=t.width,r=t.height;if(this._x+i+0>this._width&&(this._x=0,this._y=this._nextY),this._y+r>this._nextY&&(this._nextY=this._y+r+0),this._nextY>this._height)return D(12100),null;this.fontDefDictionary.texture.drawTextureAt(t,this._x,this._y),this._dirty=!0;var o=new Hq;return o.u=this._x+this._halfBleed,o.v=this._y+this._halfBleed,o.texture=this.fontDefDictionary.texture,o.valid=!0,o.w=e.width-2,o.h=e.height-2,o.xAdvance=o.w,o.offsetY=e.offsetY,this._x+=i+0,this.fontDefDictionary.addLetterDefinitions(e.hash,o),o},t.update=function(){this._dirty&&(this._dirty=!1)},t.reset=function(){this._x=0,this._y=0,this._nextY=0,this.fontDefDictionary.clear()},t.destroy=function(){this.reset(),this.fontDefDictionary&&(this.fontDefDictionary.texture.destroy(),this.fontDefDictionary.texture=null)},t.getTexture=function(){return this.fontDefDictionary.getTexture()},t.beforeSceneLoad=function(){this.clearAllCache()},t.clearAllCache=function(){this.destroy();var e=new jq;e.initWithSize(this._width,this._height),this.fontDefDictionary.texture=e},t.getLetter=function(e){return this.fontDefDictionary.letterDefinitions[e]},t.getLetterDefinitionForChar=function(e,t){var n=e.charCodeAt(0)+t.hash,i=this.fontDefDictionary.letterDefinitions[n];if(!i){var r=new Wq(e,t);r.updateRenderData(),i=this.insertLetterTexture(r),r.destroy()}return i},Z(e,[{key:"width",get:function(){return this._width}},{key:"height",get:function(){return this._height}}]),e}(),Xq={fontAtlas:null,fontSize:0,lineHeight:0,hAlign:0,vAlign:0,hash:"",fontFamily:"",fontDesc:"Arial",color:Pn.WHITE.clone(),isOutlined:!1,out:Pn.WHITE.clone(),margin:0},Yq=[new Ir(Zi.ATTR_POSITION,pi.RGB32F)],Kq=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_COLOR,pi.RGBA32F)],Qq=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RG32F),new Ir(Zi.ATTR_COLOR,pi.RGBA32F)],Zq=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RG32F),new Ir(Zi.ATTR_COLOR,pi.RGBA32F),new Ir(Zi.ATTR_COLOR2,pi.RGBA32F)];function Jq(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=eo[i.format].count}return t}function $q(e){for(var t=0,n=0;n<e.length;n++){var i=e[n];t+=eo[i.format].size}return t}u.internal.vfmtPosUvColor=Qq,u.internal.vfmtPosUvTwoColor=Zq,e("UIVertexFormat",Object.freeze({__proto__:null,vfmt:Yq,vfmtPosColor:Kq,vfmtPosUvColor:Qq,vfmtPosUvTwoColor:Zq,getComponentPerVertex:Jq,getAttributeStride:$q}));var eX,tX,nX,iX,rX,oX,aX,sX,cX,lX,uX,hX,fX,_X,pX,dX=$q(Qq)>>2,mX=new ql((function(){return{x:0,y:0,z:0,u:0,v:0,color:Pn.WHITE.clone()}}),128),vX=null,gX=e("BaseRenderData",function(){function e(e){void 0===e&&(e=Qq),this.material=null,this.chunk=null,this.dataHash=0,this.isMeshBuffer=!1,this._vc=0,this._ic=0,this._floatStride=0,this._vertexFormat=Qq,this._floatStride=e===Qq?dX:$q(e)>>2,this._vertexFormat=e}return e.prototype.isValid=function(){return this._ic>0&&this.chunk.vertexAccessor},Z(e,[{key:"vertexCount",get:function(){return this._vc}},{key:"indexCount",get:function(){return this._ic}},{key:"stride",get:function(){return this._floatStride<<2}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vertexFormat",get:function(){return this._vertexFormat}}]),e}()),yX=e("RenderData",function(e){function t(t,n){var i;return void 0===t&&(t=Qq),(i=e.call(this,t)||this).indices=null,i.vertDirty=!0,i.frame=void 0,i.layer=0,i.blendHash=-1,i.textureHash=0,i.nodeDirty=!0,i.passDirty=!0,i.textureDirty=!0,i.hashDirty=!0,i._data=[],i._pivotX=0,i._pivotY=0,i._width=0,i._height=0,i._accessor=null,n||(n=jM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i}$(t,e),t.add=function(e,n){void 0===e&&(e=Qq),vX||(vX=new Xl((function(){return new t}),32));var i=vX.add();return i._floatStride=e===Qq?dX:$q(e)>>2,i._vertexFormat=e,n||(n=jM.root.batcher2D.switchBufferAccessor(i._vertexFormat)),i._accessor=n,i},t.remove=function(e){var t=vX.data.indexOf(e);-1!==t&&(e.clear(),e._accessor=null,vX.removeAt(t))};var n=t.prototype;return n.resize=function(e,t){e===this._vc&&t===this._ic&&this.chunk||(this._vc=e,this._ic=t,this.chunk&&(this._accessor.recycleChunk(this.chunk),this.chunk=null),this.chunk=this._accessor.allocateChunk(e,t),this.updateHash())},n.resizeAndCopy=function(e,t){if(e!==this._vc||t!==this._ic||!this.chunk){this._vc=e,this._ic=t;var n=this.chunk;this.chunk=this._accessor.allocateChunk(e,t),n&&(this.chunk.vb.set(n.vb),this._accessor.recycleChunk(n)),this.updateHash()}},n.getMeshBuffer=function(){return this.chunk&&this._accessor?this._accessor.getMeshBuffer(this.chunk.bufferId):null},n.updateNode=function(e){this.layer=e.node.layer,this.nodeDirty=!1,this.hashDirty=!0},n.updatePass=function(e){this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0},n.updateTexture=function(e){this.frame=e,this.textureHash=e.getHash(),this.textureDirty=!1,this.hashDirty=!0},n.updateHash=function(){var e=""+(this.chunk?this.chunk.bufferId:-1)+this.layer+" "+this.blendHash+" "+this.textureHash;this.dataHash=xo(e,666),this.hashDirty=!1},n.updateRenderData=function(e,t){if(this.passDirty&&(this.material=e.getRenderMaterial(0),this.blendHash=e.blendHash,this.passDirty=!1,this.hashDirty=!0),this.nodeDirty){var n=e.node.scene?e._getRenderScene():null;this.layer=e.node.layer,null!==n&&(this.nodeDirty=!1),this.hashDirty=!0}this.textureDirty&&(this.frame=t,this.textureHash=t.getHash(),this.textureDirty=!1,this.hashDirty=!0),this.hashDirty&&this.updateHash()},n.updateSizeNPivot=function(e,t,n,i){e===this._width&&t===this._height&&n===this._pivotX&&i===this._pivotY||(this._width=e,this._height=t,this._pivotX=n,this._pivotY=i,this.vertDirty=!0)},n.clear=function(){this.resize(0,0),this._data.length=0,this._pivotX=0,this._pivotY=0,this._width=0,this._height=0,this.indices=null,this.vertDirty=!0,this.material=null,this.nodeDirty=!0,this.passDirty=!0,this.textureDirty=!0,this.hashDirty=!0,this.layer=0,this.blendHash=-1,this.frame=null,this.textureHash=0,this.dataHash=0},Z(t,[{key:"dataLength",get:function(){return this._data.length},set:function(e){var t=this._data;if(t.length!==e){var n=t.length,i=0;for(i=e;i<n;i++)mX.free(t[i]);for(i=n;i<e;i++)t[i]=mX.alloc();t.length=e}}},{key:"data",get:function(){return this._data}}]),t}(gX)),xX=e("MeshRenderData",function(e){function t(t){var n;return void 0===t&&(t=Qq),(n=e.call(this,t)||this).isMeshBuffer=!0,n.vData=void 0,n.iData=void 0,n.vertexStart=0,n.vertexRange=0,n.indexStart=0,n.indexRange=0,n.lastFilledIndex=0,n.lastFilledVertex=0,n._byteLength=0,n._vertexBuffers=[],n._indexBuffer=null,n._iaPool=null,n._iaInfo=null,n.vData=new Float32Array(256*n.stride),n.iData=new Uint16Array(1536),n}$(t,e),t.add=function(e){void 0===e&&(e=Qq);var t=SX.add();return t._floatStride=e===Qq?dX:$q(e)>>2,t._vertexFormat=e,t},t.remove=function(e){var t=SX.data.indexOf(e);-1!==t&&(SX.data[t].clear(),SX.removeAt(t))};var n=t.prototype;return n.request=function(e,t){var n=this._byteLength+e*this.stride;return!!this.reserve(e,t)&&(this._vc+=e,this._ic+=t,this._byteLength=n,this.vertexRange=this._vc,this.indexRange=this._ic,!0)},n.reserve=function(e,t){var n=this._byteLength+e*this.stride,i=this.indexCount+t;if(e+this.vertexCount>65535)return!1;var r=this.vData.byteLength,o=this.iData.length,a=this.vData.length,s=this.iData.length;if(n>r||i>o){for(;r<n||o<i;)r=4*(a*=2),o=s*=2;this._reallocBuffer(a,s)}return!0},n.resize=function(e,t){var n=e*this.stride;e>=0&&t>=0&&n<=this.vData.byteLength&&this.iData.length,this._vc=e,this._ic=t,this._byteLength=n,this.updateRange(0,e,0,t)},n.updateRange=function(e,t,n,i){t>=0&&i>=0&&t<=this._vc&&this._ic,this.vertexStart=e,this.indexStart=n,this.vertexRange=t,this.indexRange=i},n.requestIA=function(e){this._initIAInfo(e);var t=this._iaPool.add();return t.firstIndex=this.indexStart,t.indexCount=this.indexRange,t},n.uploadBuffers=function(){if(0!==this._byteLength&&this._vertexBuffers[0]&&this._indexBuffer){var e=this._ic,t=new Float32Array(this.vData.buffer,0,this._byteLength>>2),n=new Uint16Array(this.iData.buffer,0,e),i=this._vertexBuffers[0];this._byteLength>i.size&&i.resize(this._byteLength),i.update(t);var r=e<<1;r>this._indexBuffer.size&&this._indexBuffer.resize(r),this._indexBuffer.update(n)}},n.freeIAPool=function(){this._iaPool&&this._iaPool.reset()},n.reset=function(){this._vc=0,this._ic=0,this._byteLength=0,this.vertexStart=0,this.vertexRange=0,this.indexStart=0,this.indexRange=0,this.lastFilledIndex=0,this.lastFilledVertex=0,this.material=null,this.freeIAPool()},n.clear=function(){this.reset(),this._iaPool&&this._iaPool.destroy(),this._vertexBuffers[0]&&(this._vertexBuffers[0].destroy(),this._vertexBuffers=[]),this._iaInfo=null,this.vData=new Float32Array(256*this.stride),this.iData=new Uint16Array(1536)},n._initIAInfo=function(e){var t=this;if(!this._iaInfo){var n=this.stride,i=this._vertexBuffers;i.length||i.push(e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,n,n)));var r=Uint16Array.BYTES_PER_ELEMENT;this._indexBuffer||(this._indexBuffer=e.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,r,r))),this._iaInfo=new Or(this._vertexFormat,i,this._indexBuffer),this._iaPool=new Xl((function(){return e.createInputAssembler(t._iaInfo)}),1,(function(e){e.destroy()}))}},n._reallocBuffer=function(e,t){var n=this.vData;this.vData=new Float32Array(e),n&&this.vData.set(n,0);var i=this.iData;this.iData=new Uint16Array(t),i&&this.iData.set(i,0)},Z(t,[{key:"formatByte",get:function(){return this.stride},set:function(){}},{key:"floatStride",get:function(){return this._floatStride}},{key:"vDataOffset",get:function(){return this._byteLength>>>2}}]),t}(gX)),SX=new Xl((function(){return new xX}),32),TX=new Kn,bX=new Kn,EX=(new In,new jn),CX=new jn,AX=new jn,wX=new jn(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0),PX=new ri,RX=function(t){return e({UITransform:t,UITransformComponent:t}),t}((eX=mc("cc.UITransform"),tX=Oc(),nX=gc(110),iX=Pc(),rX=Vc(),oX=Fc(),aX=Vc(),sX=Fc(),eX(cX=tX(cX=nX(cX=iX(cX=yc(cX=wc((_X=fX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._priority=0,ce(t,"_contentSize",uX,oe(t)),ce(t,"_anchorPoint",hX,oe(t)),t}$(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiTransformComp=this},n.onLoad=function(){this.node.parent&&t.insertChangeMap(this.node.parent)},n.onEnable=function(){this.node.on(Wb.PARENT_CHANGED,this._parentChanged,this),this._markRenderDataDirty()},n.onDisable=function(){this.node.off(Wb.PARENT_CHANGED,this._parentChanged,this)},n.onDestroy=function(){this.node._uiProps.uiTransformComp=null},n.setContentSize=function(e,t){var n=this._contentSize;if(void 0===t){if((e=e).width===n.width&&e.height===n.height)return;n.width=e.width,n.height=e.height}else{if(e===n.width&&t===n.height)return;n.width=e,n.height=t}this.node.emit(Wb.SIZE_CHANGED),this._markRenderDataDirty()},n.setAnchorPoint=function(e,t){var n=this._anchorPoint;if(void 0===t){if((e=e).x===n.x&&e.y===n.y)return;n.x=e.x,n.y=e.y}else{if(e===n.x&&t===n.y)return;n.x=e,n.y=t}this.node.emit(Wb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty()},n.isHit=function(e){for(var t,n=this._contentSize.width,i=this._contentSize.height,r=TX,o=bX,a=null===(t=this.node)||void 0===t?void 0:t.eventProcessor,s=this._getRenderScene().cameras,c=0;c<s.length;c++){var l=s[c];if(l.visibility&this.node.layer){l.node.getWorldRT(EX);var u=EX.m12,h=EX.m13,f=YM.center;if(EX.m12=f.x-(EX.m00*u+EX.m04*h),EX.m13=f.y-(EX.m01*u+EX.m05*h),jn.invert(EX,EX),Kn.transformMat4(r,e,EX),this.node.getWorldMatrix(AX),jn.invert(EX,AX),!jn.strictEquals(EX,wX)){Kn.transformMat4(o,r,EX),o.x+=this._anchorPoint.x*n,o.y+=this._anchorPoint.y*i;var _=!1;if(o.x>=0&&o.y>=0&&o.x<=n&&o.y<=i&&(_=!0,a&&a.maskList))for(var p=a.maskList,d=this.node,m=p?p.length:0,v=0,g=0;d&&g<m;++v,d=d.parent){var y=p[g];if(v===y.index){if(d!==y.comp.node){p.length=g;break}var x=y.comp;if(x&&x._enabled&&!x.isHit(r)){_=!1;break}g++}else if(v>y.index){p.length=g;break}}if(_)return!0}}}return!1},n.convertToNodeSpaceAR=function(e,t){return this.node.getWorldMatrix(AX),jn.invert(EX,AX),t||(t=new In),In.transformMat4(t,e,EX)},n.convertToWorldSpaceAR=function(e,t){return this.node.getWorldMatrix(AX),t||(t=new In),In.transformMat4(t,e,AX)},n.getBoundingBox=function(){jn.fromRTS(CX,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var e=this._contentSize.width,t=this._contentSize.height,n=new ri(-this._anchorPoint.x*e,-this._anchorPoint.y*t,e,t);return n.transformMat4(CX),n},n.getBoundingBoxToWorld=function(){return this.node.parent?(this.node.parent.getWorldMatrix(AX),this.getBoundingBoxTo(AX)):this.getBoundingBox()},n.getBoundingBoxTo=function(e){jn.fromRTS(CX,this.node.getRotation(),this.node.getPosition(),this.node.getScale());var n=this._contentSize.width,i=this._contentSize.height,r=new ri(-this._anchorPoint.x*n,-this._anchorPoint.y*i,n,i);if(jn.multiply(AX,e,CX),r.transformMat4(AX),!this.node.children)return r;for(var o,a=se(this.node.children);!(o=a()).done;){var s=o.value;if(s&&s.active){var c=s.getComponent(t);if(c){var l=c.getBoundingBoxTo(e);l&&ri.union(r,r,l)}}}return r},n.getComputeAABB=function(e){var t=this._contentSize.width,n=this._contentSize.height;PX.set(-this._anchorPoint.x*t,-this._anchorPoint.y*n,t,n),PX.transformMat4(this.node.worldMatrix);var i=PX.x+.5*PX.width,r=PX.y+.5*PX.height,o=this.node.worldPosition.z,a=PX.width/2,s=PX.height/2;return null!=e?(Xs.set(e,i,r,o,a,s,.001),e):new Xs(i,r,o,a,s,.001)},n._parentChanged=function(){this.node.getComponent("cc.RenderRoot2D")||this.node.parent&&t.insertChangeMap(this.node.parent)},n._markRenderDataDirty=function(){var e=this.node._uiProps.uiComp;e&&(e.markForUpdateRenderData(),e.renderData&&(e.renderData.vertDirty=!0))},t.insertChangeMap=function(e){var n=e.uuid;t.priorityChangeNodeMap.has(n)||t.priorityChangeNodeMap.set(n,e)},t._sortChildrenSibling=function(e){var t=e.children;t&&t.sort((function(e,t){var n=e._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp,r=(n?n._priority:0)-(i?i._priority:0);return 0===r?e.getSiblingIndex()-t.getSiblingIndex():r}))},t._sortSiblings=function(){t.priorityChangeNodeMap.forEach((function(e){t._sortChildrenSibling(e),e._updateSiblingIndex(),e.emit("childrenSiblingOrderChanged")})),t.priorityChangeNodeMap.clear()},t._cleanChangeMap=function(){t.priorityChangeNodeMap.clear()},Z(t,[{key:"contentSize",get:function(){return this._contentSize},set:function(e){this._contentSize.equals(e)||(this._contentSize.set(e),this.node.emit(Wb.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"width",get:function(){return this._contentSize.width},set:function(e){this._contentSize.width!==e&&(this._contentSize.width=e,this.node.emit(Wb.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"height",get:function(){return this._contentSize.height},set:function(e){this.contentSize.height!==e&&(this._contentSize.height=e,this.node.emit(Wb.SIZE_CHANGED),this._markRenderDataDirty())}},{key:"anchorPoint",get:function(){return this._anchorPoint},set:function(e){this._anchorPoint.equals(e)||(this._anchorPoint.set(e),this.node.emit(Wb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorX",get:function(){return this._anchorPoint.x},set:function(e){this._anchorPoint.x!==e&&(this._anchorPoint.x=e,this.node.emit(Wb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"anchorY",get:function(){return this._anchorPoint.y},set:function(e){this._anchorPoint.y!==e&&(this._anchorPoint.y=e,this.node.emit(Wb.ANCHOR_CHANGED,this._anchorPoint),this._markRenderDataDirty())}},{key:"priority",get:function(){return this._priority},set:function(e){this._priority!==e&&(this.node.getComponent("cc.RenderRoot2D")?D(6706):(this._priority=e,this.node.parent&&t.insertChangeMap(this.node.parent)))}},{key:"visibility",get:function(){var e=jM.root.batcher2D.getFirstRenderCamera(this.node);return e?e.visibility:0}},{key:"cameraPriority",get:function(){var e=jM.root.batcher2D.getFirstRenderCamera(this.node);return e?e.priority:0}}]),t}(th),fX.EventType=Wb,fX.priorityChangeNodeMap=new Map,le((lX=_X).prototype,"contentSize",[rX,oX],Object.getOwnPropertyDescriptor(lX.prototype,"contentSize"),lX.prototype),le(lX.prototype,"anchorPoint",[aX,sX],Object.getOwnPropertyDescriptor(lX.prototype,"anchorPoint"),lX.prototype),uX=le(lX.prototype,"_contentSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(100,100)}}),hX=le(lX.prototype,"_anchorPoint",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(.5,.5)}}),cX=lX))||cX)||cX)||cX)||cX)||cX)||cX));jM.on(WM.EVENT_AFTER_UPDATE,RX._sortSiblings),jM.on(WM.EVENT_BEFORE_SCENE_LAUNCH,RX._cleanChangeMap),function(e){e[e.DISABLED=0]="DISABLED",e[e.CLEAR=1]="CLEAR",e[e.ENTER_LEVEL=2]="ENTER_LEVEL",e[e.ENABLED=3]="ENABLED",e[e.EXIT_LEVEL=4]="EXIT_LEVEL",e[e.CLEAR_INVERTED=5]="CLEAR_INVERTED",e[e.ENTER_LEVEL_INVERTED=6]="ENTER_LEVEL_INVERTED"}(pX||(pX={}));var IX,DX,OX,MX,NX,LX,BX,FX,zX,UX,kX,GX,HX,VX,WX,jX,qX,XX,YX,KX,QX=e("StencilManager",function(){function e(){this.stage=pX.DISABLED,this._maskStack=[],this._stencilPattern={stencilTest:!0,func:Pi.ALWAYS,stencilMask:65535,writeMask:65535,failOp:Ri.KEEP,zFailOp:Ri.KEEP,passOp:Ri.KEEP,ref:1},this.stencilStateMap=new Map,this.stencilStateMapWithDepth=new Map}var t=e.prototype;return t.pushMask=function(e){this._maskStack.push(e)},t.clear=function(e){e.stencilStage=e.inverted?pX.CLEAR_INVERTED:pX.CLEAR},t.enterLevel=function(e){e.graphics.stencilStage=e.inverted?pX.ENTER_LEVEL_INVERTED:pX.ENTER_LEVEL},t.enableMask=function(){this.stage=pX.ENABLED},t.exitMask=function(){0!==this._maskStack.length&&(this._maskStack.pop(),0===this._maskStack.length?this.stage=pX.DISABLED:this.stage=pX.ENABLED)},t.getWriteMask=function(){return 1<<this._maskStack.length-1},t.getExitWriteMask=function(){return 1<<this._maskStack.length},t.getStencilRef=function(){for(var e=0,t=0;t<this._maskStack.length;++t)e+=1<<t;return e},t.reset=function(){this._maskStack.length=0,this.stage=pX.DISABLED},t.destroy=function(){this.stencilStateMap.forEach((function(e){e.destroy()})),this.stencilStateMap.clear()},t.getStencilStage=function(e,t){var n=0,i=!1,r=!1,o=Pi.LESS,a=this.stencilStateMap;if(t&&t.passes[0]){var s=t.passes[0].depthStencilState,c=0,l=0;s.depthTest&&(c=1),s.depthWrite&&(l=1),n=c|l<<1|s.depthFunc<<2|e<<6|this._maskStack.length<<9,i=s.depthTest,r=s.depthWrite,o=s.depthFunc,a=this.stencilStateMapWithDepth}else n=e<<16|this._maskStack.length;if(a&&a.has(n))return a.get(n);this.setStateFromStage(e);var u=new Ao(i,r,o,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref,this._stencilPattern.stencilTest,this._stencilPattern.func,this._stencilPattern.stencilMask,this._stencilPattern.writeMask,this._stencilPattern.failOp,this._stencilPattern.zFailOp,this._stencilPattern.passOp,this._stencilPattern.ref);return a.set(n,u),u},t.getStencilHash=function(e){return e<<8|this._maskStack.length},t.setStateFromStage=function(e){var t=this._stencilPattern;e===pX.DISABLED?(t.stencilTest=!1,t.func=Pi.ALWAYS,t.failOp=Ri.KEEP,t.stencilMask=t.writeMask=65535,t.ref=1):(t.stencilTest=!0,e===pX.ENABLED?(t.func=Pi.EQUAL,t.failOp=Ri.KEEP,t.stencilMask=t.ref=this.getStencilRef(),t.writeMask=this.getWriteMask()):e===pX.CLEAR?(t.func=Pi.NEVER,t.failOp=Ri.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===pX.CLEAR_INVERTED||e===pX.ENTER_LEVEL?(t.func=Pi.NEVER,t.failOp=Ri.REPLACE,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()):e===pX.ENTER_LEVEL_INVERTED&&(t.func=Pi.NEVER,t.failOp=Ri.ZERO,t.writeMask=t.stencilMask=t.ref=this.getWriteMask()))},Z(e,[{key:"pattern",get:function(){return this._stencilPattern}}]),e}());QX.sharedManager=null,QX.sharedManager=new QX,ut(Ii),function(e){e[e.ADD_COLOR=0]="ADD_COLOR",e[e.ADD_COLOR_AND_TEXTURE=1]="ADD_COLOR_AND_TEXTURE",e[e.GRAYSCALE=2]="GRAYSCALE",e[e.USE_ALPHA_SEPARATED=3]="USE_ALPHA_SEPARATED",e[e.USE_ALPHA_SEPARATED_AND_GRAY=4]="USE_ALPHA_SEPARATED_AND_GRAY"}(KX||(KX=e("InstanceMaterialType",{})));var ZX,JX,$X,eY,tY,nY,iY,rY,oY,aY,sY,cY,lY,uY,hY,fY,_Y,pY,dY,mY,vY,gY,yY,xY,SY,TY,bY,EY,CY,AY,wY,PY,RY,IY,DY,OY,MY,NY,LY,BY,FY,zY,UY,kY,GY,HY,VY,WY,jY,qY,XY,YY,KY,QY,ZY,JY,$Y,eK,tK,nK,iK,rK,oK,aK,sK,cK,lK,uK,hK,fK,_K=function(t){return e({Renderable2D:t,RenderComponent:t,UIRenderable:t}),t}((IX=mc("cc.Renderable2D"),DX=vc(RX),OX=Nc(),MX=Zc(ug),NX=Zc(ug),LX=Vc(),BX=Fc(),FX=Bc(),zX=Vc(),UX=Fc(),IX(kX=DX(kX=yc(kX=wc((YX=XX=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_materials",HX,oe(t)),ce(t,"_customMaterial",VX,oe(t)),t.stencilStage=pX.DISABLED,ce(t,"_srcBlendFactor",WX,oe(t)),ce(t,"_dstBlendFactor",jX,oe(t)),ce(t,"_color",qX,oe(t)),t._assembler=null,t._postAssembler=null,t._renderData=null,t._renderDataFlag=!0,t._renderFlag=!0,t._delegateSrc=null,t._instanceMaterialType=-1,t._blendState=new Po,t._blendHash=0,t._lastParent=null,t}$(t,e);var n=t.prototype;return n.updateBlendHash=function(){var e=this._blendState.targets[0].blendDst<<4;this._blendHash=e|this._blendState.targets[0].blendSrc},n.__preload=function(){this.node._uiProps.uiComp=this,this._flushAssembler&&this._flushAssembler()},n.onEnable=function(){this.node.on(Wb.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.on(Wb.SIZE_CHANGED,this._nodeStateChange,this),this.updateMaterial(),this._renderFlag=this._canRender()},n.onRestore=function(){this.updateMaterial(),this.markForUpdateRenderData()},n.onDisable=function(){this.node.off(Wb.ANCHOR_CHANGED,this._nodeStateChange,this),this.node.off(Wb.SIZE_CHANGED,this._nodeStateChange,this),this._renderFlag=!1},n.onDestroy=function(){if(this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this.destroyRenderData(),this._materialInstances)for(var e=0;e<this._materialInstances.length;e++){var t=this._materialInstances[e];t&&t.destroy()}this._blendState&&this._blendState.destroy()},n.markForUpdateRenderData=function(e){if(void 0===e&&(e=!0),this._renderFlag=this._canRender(),e){var t=this._renderData;t&&(t.vertDirty=!0),this._renderDataFlag=e}else this._renderDataFlag=e},n.requestRenderData=function(){var e=yX.add();return this._renderData=e,e},n.destroyRenderData=function(){this._renderData&&(yX.remove(this._renderData),this._renderData=null)},n.updateAssembler=function(e){this._renderDataFlag&&(this._assembler.updateRenderData(this,e),this._renderDataFlag=!1),this._renderFlag&&this._render(e)},n.postUpdateAssembler=function(e){this._postAssembler&&this._renderFlag&&this._postRender(e)},n._render=function(){},n._postRender=function(){},n._canRender=function(){return this.isValid&&null!==this.getMaterial(0)&&this.enabled&&(this._delegateSrc?this._delegateSrc.activeInHierarchy:this.enabledInHierarchy)&&this._color.a>0},n._postCanRender=function(){},n.updateMaterial=function(){if(this._customMaterial)return this.setMaterial(this._customMaterial,0),this._renderData&&(this._renderData.material=this._customMaterial,this.markForUpdateRenderData(),this._renderData.passDirty=!0),void(this._blendHash=-1);var e=this._updateBuiltinMaterial();this.setMaterial(e,0),this._renderData&&(this._renderData.material=e,this.markForUpdateRenderData()),this._updateBlendFunc()},n._updateColor=function(){this.node._uiProps.colorDirty=!0,this._assembler&&(this._assembler.updateColor(this),this._renderFlag=this._canRender())},n._updateBlendFunc=function(){var e=this._blendState.targets[0];e||(e=new wo,this._blendState.setTarget(0,e)),e.blendDst===this._dstBlendFactor&&e.blendSrc===this._srcBlendFactor||(e.blend=!0,e.blendDstAlpha=Ii.ONE_MINUS_SRC_ALPHA,e.blendDst=this._dstBlendFactor,e.blendSrc=this._srcBlendFactor,this.renderData&&(this.renderData.passDirty=!0)),this.updateBlendHash()},n.getBlendState=function(){return this._blendState},n._nodeStateChange=function(){this._renderData&&this.markForUpdateRenderData();for(var e=0;e<this.node.children.length;++e){var n=this.node.children[e].getComponent(t);n&&n.markForUpdateRenderData()}},n._onMaterialModified=function(t,n){this._renderData&&(this.markForUpdateRenderData(),this._renderData.passDirty=!0),e.prototype._onMaterialModified.call(this,t,n)},n._updateBuiltinMaterial=function(){var e;switch(this._instanceMaterialType){case KX.ADD_COLOR:e=Nv.get("ui-base-material");break;case KX.GRAYSCALE:e=Nv.get("ui-sprite-gray-material");break;case KX.USE_ALPHA_SEPARATED:e=Nv.get("ui-sprite-alpha-sep-material");break;case KX.USE_ALPHA_SEPARATED_AND_GRAY:e=Nv.get("ui-sprite-gray-alpha-sep-material");break;default:e=Nv.get("ui-sprite-material")}return e},n.setNodeDirty=function(){this.renderData&&(this.renderData.nodeDirty=!0)},n.setTextureDirty=function(){this.renderData&&(this.renderData.textureDirty=!0)},Z(t,[{key:"sharedMaterials",get:function(){return this._materials},set:function(e){for(var t=0;t<e.length;t++)e[t]!==this._materials[t]&&this.setMaterial(e[t],t);if(e.length<this._materials.length){for(var n=e.length;n<this._materials.length;n++)this.setMaterial(null,n);this._materials.splice(e.length)}}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(e){this._customMaterial=e,this.updateMaterial()}},{key:"srcBlendFactor",get:function(){return this._customMaterial&&D(12001),this._srcBlendFactor},set:function(e){this._customMaterial?D(12001):this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"dstBlendFactor",get:function(){return this._customMaterial&&D(12001),this._dstBlendFactor},set:function(e){this._customMaterial?D(12001):this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color.equals(e)||(this._color.set(e),this._updateColor())}},{key:"renderData",get:function(){return this._renderData}},{key:"delegateSrc",set:function(e){this._delegateSrc=e}},{key:"blendHash",get:function(){return this._blendHash}}]),t}(dF),XX.BlendState=Ii,XX.Assembler=null,XX.PostAssembler=null,HX=le((GX=YX).prototype,"_materials",[sl],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),le(GX.prototype,"sharedMaterials",[sl,OX],Object.getOwnPropertyDescriptor(GX.prototype,"sharedMaterials"),GX.prototype),VX=le(GX.prototype,"_customMaterial",[MX],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(GX.prototype,"customMaterial",[NX,LX,BX,FX],Object.getOwnPropertyDescriptor(GX.prototype,"customMaterial"),GX.prototype),le(GX.prototype,"color",[zX,UX],Object.getOwnPropertyDescriptor(GX.prototype,"color"),GX.prototype),WX=le(GX.prototype,"_srcBlendFactor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ii.SRC_ALPHA}}),jX=le(GX.prototype,"_dstBlendFactor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ii.ONE_MINUS_SRC_ALPHA}}),qX=le(GX.prototype,"_color",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),kX=GX))||kX)||kX)||kX)||kX));u.internal.Renderable2D=_K,function(e){e[e.LEFT=0]="LEFT",e[e.CENTER=1]="CENTER",e[e.RIGHT=2]="RIGHT"}(lK||(lK=e("HorizontalTextAlignment",{}))),ut(lK),function(e){e[e.TOP=0]="TOP",e[e.CENTER=1]="CENTER",e[e.BOTTOM=2]="BOTTOM"}(uK||(uK=e("VerticalTextAlignment",{}))),ut(uK),function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.SHRINK=2]="SHRINK",e[e.RESIZE_HEIGHT=3]="RESIZE_HEIGHT"}(hK||(hK=e("Overflow",{}))),ut(hK),function(e){e[e.NONE=0]="NONE",e[e.BITMAP=1]="BITMAP",e[e.CHAR=2]="CHAR"}(fK||(fK=e("CacheMode",{}))),ut(fK);var pK=function(t){return e({Label:t,LabelComponent:t}),t}((ZX=mc("cc.Label"),JX=Oc(),$X=gc(110),eY=Pc(),tY=Vc(),nY=Fc(),iY=Zc(lK),rY=Vc(),oY=Fc(),aY=Zc(uK),sY=Vc(),cY=Fc(),lY=Vc(),uY=Fc(),hY=Vc(),fY=Nc(),_Y=Fc(),pY=Vc(),dY=Fc(),mY=Nc(),vY=Vc(),gY=Fc(),yY=Zc(hK),xY=Vc(),SY=Fc(),TY=Vc(),bY=Fc(),EY=Zc(lq),CY=Vc(),AY=Nc(),wY=Fc(),PY=Vc(),RY=Fc(),IY=Zc(fK),DY=Vc(),OY=Fc(),MY=Vc(),NY=Fc(),LY=Vc(),BY=Fc(),FY=Vc(),zY=Fc(),UY=Nc(),kY=Vc(),GY=Fc(),ZX(HY=JX(HY=$X(HY=eY((cK=sK=function(e){function t(){var t;return ce(t=e.call(this)||this,"_string",WY,oe(t)),ce(t,"_horizontalAlign",jY,oe(t)),ce(t,"_verticalAlign",qY,oe(t)),ce(t,"_actualFontSize",XY,oe(t)),ce(t,"_fontSize",YY,oe(t)),ce(t,"_fontFamily",KY,oe(t)),ce(t,"_lineHeight",QY,oe(t)),ce(t,"_overflow",ZY,oe(t)),ce(t,"_enableWrapText",JY,oe(t)),ce(t,"_font",$Y,oe(t)),ce(t,"_isSystemFontUsed",eK,oe(t)),ce(t,"_spacingX",tK,oe(t)),ce(t,"_isItalic",nK,oe(t)),ce(t,"_isBold",iK,oe(t)),ce(t,"_isUnderline",rK,oe(t)),ce(t,"_underlineHeight",oK,oe(t)),ce(t,"_cacheMode",aK,oe(t)),t._N$file=null,t._texture=null,t._ttfSpriteFrame=null,t._userDefinedFont=null,t._assemblerData=null,t._fontAtlas=null,t._letterTexture=null,t._ttfSpriteFrame=null,t}$(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this._font||this._isSystemFontUsed||(this.useSystemFont=!0),this._isSystemFontUsed&&!this._fontFamily&&(this.fontFamily="Arial"),this._applyFontTexture()},n.onDestroy=function(){if(this._assembler&&this._assembler.resetAssemblerData&&this._assembler.resetAssemblerData(this._assemblerData),this._assemblerData=null,this._ttfSpriteFrame){this._ttfSpriteFrame._resetDynamicAtlasFrame();var t=this._ttfSpriteFrame.texture;if(this._ttfSpriteFrame.destroy(),t){var n=t;n.image&&n.image.destroy(),t.destroy()}this._ttfSpriteFrame=null}this._letterTexture=null,e.prototype.onDestroy.call(this)},n.updateRenderData=function(e){void 0===e&&(e=!1),this.markForUpdateRenderData(),e&&(this._flushAssembler(),this.renderData&&(this.renderData.vertDirty=!0),this._applyFontTexture(),this._assembler&&this._assembler.updateRenderData(this))},n._render=function(e){e.commitComp(this,this.renderData,this._texture,this._assembler,null)},n._updateColor=function(){e.prototype._updateColor.call(this),this.updateRenderData(!1)},n._canRender=function(){if(!e.prototype._canRender.call(this)||!this._string)return!1;var t=this._font;if(t&&t instanceof bq){var n=t.spriteFrame;if(!n||!n.texture)return!1}return!0},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.material)},n._applyFontTexture=function(){this.markForUpdateRenderData();var e=this._font;if(e instanceof bq){var t=e.spriteFrame;t&&t.texture&&(this._texture=t,this.renderData&&(this.renderData.textureDirty=!0),this.changeMaterialForDefine(),this._assembler&&this._assembler.updateRenderData(this))}else{if(this.cacheMode===fK.CHAR)this._letterTexture=this._assembler.getAssemblerData(),this._texture=this._letterTexture;else if(!this._ttfSpriteFrame){this._ttfSpriteFrame=new nq,this._assemblerData=this._assembler.getAssemblerData();var n=new nv(this._assemblerData.canvas),i=new Cv;i.image=n,this._ttfSpriteFrame.texture=i}this.cacheMode!==fK.CHAR&&(this._texture=this._ttfSpriteFrame),this.changeMaterialForDefine()}},n.changeMaterialForDefine=function(){if(this._texture){var e=!1;if(this.cacheMode!==fK.CHAR){var t=this._texture.texture;if(t instanceof ev){var n=t.getPixelFormat();e=n===Mm.RGBA_ETC1||n===Mm.RGB_A_PVRTC_4BPPV1||n===Mm.RGB_A_PVRTC_2BPPV1}}this._instanceMaterialType=e?KX.USE_ALPHA_SEPARATED:KX.ADD_COLOR_AND_TEXTURE,this.updateMaterial()}},Z(t,[{key:"string",get:function(){return this._string},set:function(e){e=null==e?"":e.toString(),this._string!==e&&(this._string=e,this.updateRenderData())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this._horizontalAlign!==e&&(this._horizontalAlign=e,this.updateRenderData())}},{key:"verticalAlign",get:function(){return this._verticalAlign},set:function(e){this._verticalAlign!==e&&(this._verticalAlign=e,this.updateRenderData())}},{key:"actualFontSize",get:function(){return this._actualFontSize},set:function(e){this._actualFontSize=e}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this.updateRenderData())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this.updateRenderData())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this.updateRenderData())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this.updateRenderData())}},{key:"overflow",get:function(){return this._overflow},set:function(e){this._overflow!==e&&(this._overflow=e,this.updateRenderData())}},{key:"enableWrapText",get:function(){return this._enableWrapText},set:function(e){this._enableWrapText!==e&&(this._enableWrapText=e,this.updateRenderData())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._isSystemFontUsed=!e,this._font=e,this._renderData&&(this.destroyRenderData(),this._renderData=null),this._fontAtlas=null,this.updateRenderData(!0))}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this.destroyRenderData(),this._renderData=null,this._isSystemFontUsed=!!e,e&&(this.font=null),this._flushAssembler(),this.updateRenderData())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode!==fK.BITMAP||this._font instanceof bq||!this._ttfSpriteFrame||this._ttfSpriteFrame._resetDynamicAtlasFrame(),this._cacheMode===fK.CHAR&&(this._ttfSpriteFrame=null),this._cacheMode=e,this.updateRenderData(!0))}},{key:"isBold",get:function(){return this._isBold},set:function(e){this._isBold!==e&&(this._isBold=e,this.updateRenderData())}},{key:"isItalic",get:function(){return this._isItalic},set:function(e){this._isItalic!==e&&(this._isItalic=e,this.updateRenderData())}},{key:"isUnderline",get:function(){return this._isUnderline},set:function(e){this._isUnderline!==e&&(this._isUnderline=e,this.updateRenderData())}},{key:"underlineHeight",get:function(){return this._underlineHeight},set:function(e){this._underlineHeight!==e&&(this._underlineHeight=e,this.updateRenderData())}},{key:"spriteFrame",get:function(){return this._texture}},{key:"ttfSpriteFrame",get:function(){return this._ttfSpriteFrame}},{key:"assemblerData",get:function(){return this._assemblerData}},{key:"fontAtlas",get:function(){return this._fontAtlas},set:function(e){this._fontAtlas=e}},{key:"_bmFontOriginalSize",get:function(){return this._font instanceof bq?this._font.fontSize:-1}}]),t}(_K),sK.HorizontalAlign=lK,sK.VerticalAlign=uK,sK.Overflow=hK,sK.CacheMode=fK,sK._canvasPool=kq.getInstance(),le((VY=cK).prototype,"string",[tY,nY,jc],Object.getOwnPropertyDescriptor(VY.prototype,"string"),VY.prototype),le(VY.prototype,"horizontalAlign",[iY,rY,oY],Object.getOwnPropertyDescriptor(VY.prototype,"horizontalAlign"),VY.prototype),le(VY.prototype,"verticalAlign",[aY,sY,cY],Object.getOwnPropertyDescriptor(VY.prototype,"verticalAlign"),VY.prototype),le(VY.prototype,"fontSize",[lY,uY],Object.getOwnPropertyDescriptor(VY.prototype,"fontSize"),VY.prototype),le(VY.prototype,"fontFamily",[hY,fY,_Y],Object.getOwnPropertyDescriptor(VY.prototype,"fontFamily"),VY.prototype),le(VY.prototype,"lineHeight",[pY,dY],Object.getOwnPropertyDescriptor(VY.prototype,"lineHeight"),VY.prototype),le(VY.prototype,"spacingX",[mY,vY,gY],Object.getOwnPropertyDescriptor(VY.prototype,"spacingX"),VY.prototype),le(VY.prototype,"overflow",[yY,xY,SY],Object.getOwnPropertyDescriptor(VY.prototype,"overflow"),VY.prototype),le(VY.prototype,"enableWrapText",[TY,bY],Object.getOwnPropertyDescriptor(VY.prototype,"enableWrapText"),VY.prototype),le(VY.prototype,"font",[EY,CY,AY,wY],Object.getOwnPropertyDescriptor(VY.prototype,"font"),VY.prototype),le(VY.prototype,"useSystemFont",[PY,RY],Object.getOwnPropertyDescriptor(VY.prototype,"useSystemFont"),VY.prototype),le(VY.prototype,"cacheMode",[IY,DY,OY],Object.getOwnPropertyDescriptor(VY.prototype,"cacheMode"),VY.prototype),le(VY.prototype,"isBold",[MY,NY],Object.getOwnPropertyDescriptor(VY.prototype,"isBold"),VY.prototype),le(VY.prototype,"isItalic",[LY,BY],Object.getOwnPropertyDescriptor(VY.prototype,"isItalic"),VY.prototype),le(VY.prototype,"isUnderline",[FY,zY],Object.getOwnPropertyDescriptor(VY.prototype,"isUnderline"),VY.prototype),le(VY.prototype,"underlineHeight",[UY,Mc,kY,GY],Object.getOwnPropertyDescriptor(VY.prototype,"underlineHeight"),VY.prototype),WY=le(VY.prototype,"_string",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"label"}}),jY=le(VY.prototype,"_horizontalAlign",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lK.CENTER}}),qY=le(VY.prototype,"_verticalAlign",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uK.CENTER}}),XY=le(VY.prototype,"_actualFontSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YY=le(VY.prototype,"_fontSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),KY=le(VY.prototype,"_fontFamily",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),QY=le(VY.prototype,"_lineHeight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),ZY=le(VY.prototype,"_overflow",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hK.NONE}}),JY=le(VY.prototype,"_enableWrapText",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$Y=le(VY.prototype,"_font",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eK=le(VY.prototype,"_isSystemFontUsed",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tK=le(VY.prototype,"_spacingX",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),nK=le(VY.prototype,"_isItalic",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iK=le(VY.prototype,"_isBold",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),rK=le(VY.prototype,"_isUnderline",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oK=le(VY.prototype,"_underlineHeight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),aK=le(VY.prototype,"_cacheMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fK.NONE}}),HY=VY))||HY)||HY)||HY)||HY));u.Label=pK;var dK,mK,vK=0,gK={};function yK(e){return--e,e|=e>>16,e|=e>>8,e|=e>>4,e|=e>>2,e|=e>>1,++e}function xK(e,t){return Math.ceil(e/t)*t}!function(e){e[e.OPAQUE=0]="OPAQUE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OVERLAY=2]="OVERLAY"}(dK||(dK={})),function(e){e[e.DEFAULT=1]="DEFAULT",e[e.FORWARD=2]="FORWARD",e[e.SHADOWCAST=4]="SHADOWCAST"}(mK||(mK={}));var SK,TK,bK,EK=function(){function e(e){this._device=void 0,this._format=pi.UNKNOWN,this._formatSize=0,this._chunks=[],this._chunkCount=0,this._handles=[],this._region0=new sr,this._region1=new sr,this._region2=new sr,this._roundUpFn=null,this._bufferViewCtor=Uint8Array,this._channels=4,this._alignment=1,this._device=e}var t=e.prototype;return t.initialize=function(e){var t=eo[e.format];this._format=e.format,this._formatSize=t.size,this._channels=t.count,this._bufferViewCtor=uo(t),this._roundUpFn=e.roundUpFn||null,this._alignment=e.alignment||1,e.inOrderFree&&(this.alloc=this._McDonaldAlloc)},t.destroy=function(){for(var e=0;e<this._chunkCount;++e)this._chunks[e].texture.destroy();this._chunks.length=0,this._handles.length=0},t.alloc=function(e,t){e=xK(e,this._alignment);var n=-1,i=-1;if(void 0!==t&&(n=t,i=this._findAvailableSpace(e,n)),i<0)for(var r=0;r<this._chunkCount&&(n=r,!((i=this._findAvailableSpace(e,n))>=0));++r);if(i>=0){var o=this._chunks[n];o.start+=e;var a={chunkIdx:n,start:i,end:i+e,texture:o.texture};return this._handles.push(a),a}var s=Math.sqrt(e/this._formatSize),c=this._roundUpFn&&this._roundUpFn(s,this._formatSize)||Math.max(1024,yK(s)),l=this._chunks[this.createChunk(c)];l.start+=e;var u={chunkIdx:this._chunkCount-1,start:0,end:e,texture:l.texture};return this._handles.push(u),u},t.free=function(e){for(var t=0;t<this._handles.length;++t)if(this._handles[t]===e)return this._chunks[e.chunkIdx].end=e.end,void this._handles.splice(t,1)},t.createChunk=function(e){var t=e*e*this._formatSize;E("TextureBufferPool: Allocate chunk "+this._chunkCount+", size: "+t+", format: "+this._format);var n={texture:this._device.createTexture(new gr(Si.TEX2D,Ti.SAMPLED|Ti.TRANSFER_DST,this._format,e,e)),size:t,start:0,end:t};return this._chunks[this._chunkCount]=n,this._chunkCount++},t.update=function(e,t){var n=[],i=[],r=e.start/this._formatSize,o=t.byteLength/this._formatSize,a=r%e.texture.width,s=Math.floor(r/e.texture.width),c=Math.min(e.texture.width-a,o),l=0;a>0&&(this._region0.texOffset.x=a,this._region0.texOffset.y=s,this._region0.texExtent.width=c,this._region0.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region0),a=0,s+=1,o-=c,l+=c),o>0&&(this._region1.texOffset.x=a,this._region1.texOffset.y=s,o>e.texture.width?(this._region1.texExtent.width=e.texture.width,this._region1.texExtent.height=Math.floor(o/e.texture.width),c=this._region1.texExtent.width*this._region1.texExtent.height):(c=o,this._region1.texExtent.width=c,this._region1.texExtent.height=1),n.push(new this._bufferViewCtor(t,l*this._formatSize,c*this._channels)),i.push(this._region1),a=0,s+=this._region1.texExtent.height,o-=c,l+=c),o>0&&(this._region2.texOffset.x=a,this._region2.texOffset.y=s,this._region2.texExtent.width=o,this._region2.texExtent.height=1,n.push(new this._bufferViewCtor(t,l*this._formatSize,o*this._channels)),i.push(this._region2)),this._device.copyBuffersToTexture(n,e.texture,i)},t._findAvailableSpace=function(e,t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.size)i=!0;else{r=0;for(var o=this._handles.filter((function(e){return e.chunkIdx===t})).sort((function(e,t){return e.start-t.start})),a=0;a<o.length;a++){var s=o[a];if(r+e<=s.start){i=!0;break}r=s.end}!i&&r+e<=n.size&&(i=!0)}return i?r:-1},t._McDonaldAlloc=function(e){e=xK(e,this._alignment);for(var t=0;t<this._chunkCount;++t){var n=this._chunks[t],i=!1,r=n.start;if(r+e<=n.end?i=!0:r>n.end?r+e<=n.size?i=!0:e<=n.end&&(n.start=r=0,i=!0):r===n.end&&(n.start=r=0,n.end=n.size,e<=n.end&&(i=!0)),i){n.start+=e;var o={chunkIdx:t,start:r,end:r+e,texture:n.texture};return this._handles.push(o),o}}var a=Math.sqrt(e/this._formatSize),s=this._roundUpFn&&this._roundUpFn(a,this._formatSize)||Math.max(1024,yK(a)),c=this._chunks[this.createChunk(s)];c.start+=e;var l={chunkIdx:this._chunkCount,start:0,end:e,texture:c.texture};return this._handles.push(l),l},e}(),CK=function(e){if(void 0===gK[e]){var t=1<<vK;gK[e]=t,vK+=1}},AK=Object.freeze({__proto__:null,addStage:CK,scene:IT,createIA:function(e,t){if(!t.positions)return console.error("The data must have positions field"),null;for(var n=[],i=t.positions.length/3,r=0;r<i;++r)n.push(t.positions[3*r],t.positions[3*r+1],t.positions[3*r+2]),t.normals&&n.push(t.normals[3*r],t.normals[3*r+1],t.normals[3*r+2]),t.uvs&&n.push(t.uvs[2*r],t.uvs[2*r+1]),t.colors&&n.push(t.colors[3*r],t.colors[3*r+1],t.colors[3*r+2]);var o=[];o.push(new Ir(Zi.ATTR_POSITION,pi.RGB32F)),t.normals&&o.push(new Ir(Zi.ATTR_NORMAL,pi.RGB32F)),t.uvs&&o.push(new Ir(Zi.ATTR_TEX_COORD,pi.RG32F)),t.colors&&o.push(new Ir(Zi.ATTR_COLOR,pi.RGB32F));var a=e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,4*n.length,4*n.length/i));a.update(new Float32Array(n));var s=null;return t.indices&&(s=e.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,2*t.indices.length,2))).update(new Uint16Array(t.indices)),e.createInputAssembler(new Or(o,[a],s))},get RenderQueue(){return dK},get PassStage(){return mK},genHandle:om,getTypeFromHandle:am,getBindingFromHandle:sm,getCountFromHandle:cm,getOffsetFromHandle:lm,customizeType:um,type2reader:hm,type2writer:fm,getDefaultFromType:pm,overrideMacros:dm,get BatchingSchemes(){return Iv},Pass:Gv,getDeviceShaderVersion:Tm,programLib:Dm,nearestPOT:yK,TextureBufferPool:EK,MaterialInstance:gT,PassInstance:vT,get PoolType(){return ws},NULL_HANDLE:0,get NodeView(){return Ps},NodePool:Ms,get PassView(){return Is},PassPool:Fs,get AABBView(){return Ns},AABBPool:ks});e("renderer",AK),function(e){e[e.BUTT=0]="BUTT",e[e.ROUND=1]="ROUND",e[e.SQUARE=2]="SQUARE"}(SK||(SK={})),ut(SK),function(e){e[e.BEVEL=0]="BEVEL",e[e.ROUND=1]="ROUND",e[e.MITER=2]="MITER"}(TK||(TK={})),ut(TK),function(e){e[e.PT_CORNER=1]="PT_CORNER",e[e.PT_LEFT=2]="PT_LEFT",e[e.PT_BEVEL=4]="PT_BEVEL",e[e.PT_INNERBEVEL=8]="PT_INNERBEVEL"}(bK||(bK={})),ut(bK);var wK=Math.PI,PK=Math.min,RK=Math.max,IK=Math.cos,DK=Math.sin,OK=Math.abs,MK=Math.sign,NK=.5522847493;function LK(e,t,n,i,r){e.moveTo(t-i,n),e.bezierCurveTo(t-i,n+r*NK,t-i*NK,n+r,t,n+r),e.bezierCurveTo(t+i*NK,n+r,t+i,n+r*NK,t+i,n),e.bezierCurveTo(t+i,n-r*NK,t+i*NK,n-r,t,n-r),e.bezierCurveTo(t-i*NK,n-r,t-i,n-r*NK,t-i,n),e.close()}function BK(e,t,n,i,r,o,a,s,c,l,u){var h,f,_,p,d,m,v,g,y,x,S,T,b,E,C,A;l>10||(d=.5*(o+s),m=.5*(a+c),v=.5*((h=.5*(t+i))+(_=.5*(i+o))),g=.5*((f=.5*(n+r))+(p=.5*(r+a))),((C=OK((i-s)*(E=c-n)-(r-c)*(b=s-t)))+(A=OK((o-s)*E-(a-c)*b)))*(C+A)<e.tessTol*(b*b+E*E)?e.addPoint(s,c,0===u?u|bK.PT_BEVEL:u):(BK(e,t,n,h,f,v,g,S=.5*(v+(y=.5*(_+d))),T=.5*(g+(x=.5*(p+m))),l+1,0),BK(e,S,T,y,x,d,m,s,c,l+1,u)))}var FK,zK,UK,kK,GK,HK,VK,WK,jK,qK,XK,YK,KK,QK,ZK,JK,$K,eQ,tQ,nQ,iQ,rQ,oQ,aQ,sQ,cQ,lQ,uQ,hQ,fQ,_Q,pQ,dQ,mQ,vQ,gQ,yQ,xQ,SQ,TQ,bQ,EQ,CQ,AQ,wQ,PQ,RQ,IQ=function(e){function t(t,n){var i;return(i=e.call(this,t,n)||this).dx=0,i.dy=0,i.dmx=0,i.dmy=0,i.flags=0,i.len=0,i.reset(),i}return $(t,e),t.prototype.reset=function(){this.dx=0,this.dy=0,this.dmx=0,this.dmy=0,this.flags=0,this.len=0},t}(Kn),DQ=function(){function e(){this.closed=!1,this.bevel=0,this.complex=!0,this.points=[],this.reset()}return e.prototype.reset=function(){this.closed=!1,this.bevel=0,this.complex=!0,this.points?this.points.length=0:this.points=[]},e}(),OQ=function(){function e(){this.dataOffset=0,this.updatePathOffset=!1,this.pathLength=0,this.pathOffset=0,this.paths=[],this.tessTol=.25,this.distTol=.01,this.fillColor=Pn.WHITE.clone(),this.lineCap=SK.BUTT,this.strokeColor=Pn.BLACK.clone(),this.lineJoin=TK.MITER,this.lineWidth=0,this.pointsOffset=0,this._commandX=0,this._commandY=0,this._points=[],this._renderDataList=[],this._curPath=null}var t=e.prototype;return t.moveTo=function(e,t){this.updatePathOffset&&(this.pathOffset=this.pathLength,this.updatePathOffset=!1),this._addPath(),this.addPoint(e,t,bK.PT_CORNER),this._commandX=e,this._commandY=t},t.lineTo=function(e,t){this.addPoint(e,t,bK.PT_CORNER),this._commandX=e,this._commandY=t},t.bezierCurveTo=function(e,t,n,i,r,o){var a=this._curPath,s=a.points[a.points.length-1];s&&(s.x!==e||s.y!==t||n!==r||i!==o?(BK(this,s.x,s.y,e,t,n,i,r,o,0,bK.PT_CORNER),this._commandX=r,this._commandY=o):this.lineTo(r,o))},t.quadraticCurveTo=function(e,t,n,i){var r=this._commandX,o=this._commandY;this.bezierCurveTo(r+2/3*(e-r),o+2/3*(t-o),n+2/3*(e-n),i+2/3*(t-i),n,i)},t.arc=function(e,t,n,i,r,o){!function(e,t,n,i,r,o,a){var s,c,l=0,u=0,h=0,f=0,_=0,p=0,d=0,m=0,v=0,g=0,y=0,x=0,S=0,T=0;if(u=o-r,a=a||!1)if(OK(u)>=2*wK)u=2*wK;else for(;u<0;)u+=2*wK;else if(OK(u)>=2*wK)u=2*-wK;else for(;u>0;)u-=2*wK;for(c=0|RK(1,PK(OK(u)/(.5*wK)+.5,5)),h=OK(4/3*(1-IK(s=u/c/2))/DK(s)),a||(h=-h),T=0;T<=c;T++)p=t+(f=IK(l=r+u*(T/c)))*i,d=n+(_=DK(l))*i,m=-_*i*h,v=f*i*h,0===T?e.moveTo(p,d):e.bezierCurveTo(g+x,y+S,p-m,d-v,p,d),g=p,y=d,x=m,S=v}(this,e,t,n,i,r,o)},t.ellipse=function(e,t,n,i){LK(this,e,t,n,i),this._curPath.complex=!1},t.circle=function(e,t,n){LK(this,e,t,n,n),this._curPath.complex=!1},t.rect=function(e,t,n,i){this.moveTo(e,t),this.lineTo(e+n,t),this.lineTo(e+n,t+i),this.lineTo(e,t+i),this.close(),this._curPath.complex=!1},t.roundRect=function(e,t,n,i,r){!function(e,t,n,i,r,o){if(o<.1)e.rect(t,n,i,r);else{var a=PK(o,.5*OK(i))*MK(i),s=PK(o,.5*OK(r))*MK(r);e.moveTo(t,n+s),e.lineTo(t,n+r-s),e.bezierCurveTo(t,n+r-s*(1-NK),t+a*(1-NK),n+r,t+a,n+r),e.lineTo(t+i-a,n+r),e.bezierCurveTo(t+i-a*(1-NK),n+r,t+i,n+r-s*(1-NK),t+i,n+r-s),e.lineTo(t+i,n+s),e.bezierCurveTo(t+i,n+s*(1-NK),t+i-a*(1-NK),n,t+i-a,n),e.lineTo(t+a,n),e.bezierCurveTo(t+a*(1-NK),n,t,n+s*(1-NK),t,n+s),e.close()}}(this,e,t,n,i,r),this._curPath.complex=!1},t.clear=function(){this.pathLength=0,this.pathOffset=0,this.pointsOffset=0,this.dataOffset=0,this._curPath=null,this.paths.length=0,this._points.length=0;for(var e=this._renderDataList,t=0,n=e.length;t<n;t++){var i=e[t];i&&xX.remove(i)}this._renderDataList.length=0},t.close=function(){this._curPath.closed=!0},t.requestRenderData=function(){var e=xX.add();return this._renderDataList.push(e),e},t.getRenderDataList=function(){return 0===this._renderDataList.length&&this.requestRenderData(),this._renderDataList},t.addPoint=function(e,t,n){var i=this._curPath;if(i){var r=this._points,o=i.points,a=r[this.pointsOffset++];a?(a.x=e,a.y=t):(a=new IQ(e,t),r.push(a)),a.flags=n,o.push(a)}},t._addPath=function(){var e=this.pathLength,t=this.paths[e];return t?t.reset():(t=new DQ,this.paths.push(t)),this.pathLength++,this._curPath=t,t},e}(),MQ=Kq.concat([new Ir("a_dist",pi.R32F)]),NQ=Jq(MQ),LQ=$q(MQ),BQ=function(t){return e({Graphics:t,GraphicsComponent:t}),t}((FK=mc("cc.Graphics"),zK=Oc(),UK=gc(110),kK=Pc(),GK=Fc(),HK=Zc(TK),VK=Fc(),WK=Zc(SK),jK=Fc(),qK=Fc(),XK=Fc(),YK=Fc(),KK=Nc(),FK(QK=zK(QK=UK(QK=kK((oQ=rQ=function(e){function t(){var t;return(t=e.call(this)||this).impl=null,t.model=null,ce(t,"_lineWidth",JK,oe(t)),ce(t,"_strokeColor",$K,oe(t)),ce(t,"_lineJoin",eQ,oe(t)),ce(t,"_lineCap",tQ,oe(t)),ce(t,"_fillColor",nQ,oe(t)),ce(t,"_miterLimit",iQ,oe(t)),t._isDrawing=!1,t._isNeedUploadData=!0,t._graphicsUseSubMeshes=[],t._instanceMaterialType=KX.ADD_COLOR,t.impl=new OQ,t}$(t,e);var n=t.prototype;return n.onRestore=function(){this.impl||this._flushAssembler()},n.onLoad=function(){this.model=jM.root.createModel(uT),this.model.node=this.model.transform=this.node,this._flushAssembler()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateMtlForGraphics()},n.onDisable=function(){e.prototype.onDisable.call(this)},n.onDestroy=function(){this._sceneGetter=null,this.model&&(jM.root.destroyModel(this.model),this.model=null);var t=this._graphicsUseSubMeshes.length;if(t>0){for(var n=0;n<t;++n)this._graphicsUseSubMeshes[n].destroy();this._graphicsUseSubMeshes.length=0}this.impl&&(this._isDrawing=!1,this.impl.clear(),this.impl=null),e.prototype.onDestroy.call(this)},n.moveTo=function(e,t){this.impl&&this.impl.moveTo(e,t)},n.lineTo=function(e,t){this.impl&&this.impl.lineTo(e,t)},n.bezierCurveTo=function(e,t,n,i,r,o){this.impl&&this.impl.bezierCurveTo(e,t,n,i,r,o)},n.quadraticCurveTo=function(e,t,n,i){this.impl&&this.impl.quadraticCurveTo(e,t,n,i)},n.arc=function(e,t,n,i,r,o){this.impl&&this.impl.arc(e,t,n,i,r,o)},n.ellipse=function(e,t,n,i){this.impl&&this.impl.ellipse(e,t,n,i)},n.circle=function(e,t,n){this.impl&&this.impl.circle(e,t,n)},n.rect=function(e,t,n,i){this.impl&&this.impl.rect(e,t,n,i)},n.roundRect=function(e,t,n,i,r){this.impl&&this.impl.roundRect(e,t,n,i,r)},n.fillRect=function(e,t,n,i){this.rect(e,t,n,i),this.fill()},n.clear=function(){if(this.impl){if(this.impl.clear(),this._isDrawing=!1,this.model)for(var e=0;e<this.model.subModels.length;e++)this.model.subModels[e].inputAssembler.indexCount=0;this.markForUpdateRenderData()}},n.close=function(){this.impl&&this.impl.close()},n.stroke=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.stroke(this)},n.fill=function(){this._assembler||this._flushAssembler(),this._isDrawing=!0,this._isNeedUploadData=!0,this._assembler.fill(this)},n._updateMtlForGraphics=function(){var e;this._customMaterial?e=this.getMaterialInstance(0):(e=Nv.get("ui-graphics-material"),this.setMaterial(e,0),(e=this.getMaterialInstance(0)).recompileShaders({USE_LOCAL:!0}))},n.activeSubModel=function(e){if(this.model){if(this.model.subModels.length<=e){var t=u.director.root.device,n=t.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,65535*LQ,LQ)),i=t.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,131070*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),r=new VA([n],MQ,Ui.TRIANGLE_LIST,i);r.subMeshIdx=0,this.model.initSubModel(e,r,this.getMaterialInstance(0)),this._graphicsUseSubMeshes.push(r)}}else D(4500,this.node.name)},n._uploadData=function(){var e=this.impl;if(e){var t=e&&e.getRenderDataList();if(!(t.length<=0)&&this.model){for(var n=this.model.subModels,i=0;i<t.length;i++){var r=t[i],o=n[i].inputAssembler;if(r.lastFilledVertex!==r.vertexStart){var a=new Float32Array(r.vData.buffer,0,r.vertexStart*NQ);o.vertexBuffers[0].update(a),o.vertexCount=r.vertexStart;var s=new Uint16Array(r.iData.buffer,0,r.indexStart);o.indexBuffer.update(s),o.indexCount=r.indexStart,r.lastFilledVertex=r.vertexStart,r.lastFilledIndex=r.indexStart}}this._isNeedUploadData=!1}}},n._render=function(e){if(this._isNeedUploadData){if(this.impl){var t=this.impl.getRenderDataList(),n=this.model.subModels.length;if(t.length>n)for(var i=n;i<t.length;i++)this.activeSubModel(i)}this._uploadData()}e.commitModel(this,this.model,this.getMaterialInstance(0))},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this._assembler=e)},n._canRender=function(){return!!e.prototype._canRender.call(this)&&!!this.model&&this._isDrawing},Z(t,[{key:"lineWidth",get:function(){return this._lineWidth},set:function(e){this._lineWidth=e,this.impl&&(this.impl.lineWidth=e)}},{key:"lineJoin",get:function(){return this._lineJoin},set:function(e){this._lineJoin=e,this.impl&&(this.impl.lineJoin=e)}},{key:"lineCap",get:function(){return this._lineCap},set:function(e){this._lineCap=e,this.impl&&(this.impl.lineCap=e)}},{key:"strokeColor",get:function(){return this._strokeColor},set:function(e){this.impl&&(this._strokeColor.set(e),this.impl.strokeColor=this._strokeColor)}},{key:"fillColor",get:function(){return this._fillColor},set:function(e){this.impl&&(this._fillColor.set(e),this.impl.fillColor=this._fillColor)}},{key:"miterLimit",get:function(){return this._miterLimit},set:function(e){this._miterLimit=e}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(){}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(){}}]),t}(_K),rQ.LineJoin=TK,rQ.LineCap=SK,le((ZK=oQ).prototype,"lineWidth",[Mc,GK],Object.getOwnPropertyDescriptor(ZK.prototype,"lineWidth"),ZK.prototype),le(ZK.prototype,"lineJoin",[HK,VK],Object.getOwnPropertyDescriptor(ZK.prototype,"lineJoin"),ZK.prototype),le(ZK.prototype,"lineCap",[WK,jK],Object.getOwnPropertyDescriptor(ZK.prototype,"lineCap"),ZK.prototype),le(ZK.prototype,"strokeColor",[qK],Object.getOwnPropertyDescriptor(ZK.prototype,"strokeColor"),ZK.prototype),le(ZK.prototype,"fillColor",[XK],Object.getOwnPropertyDescriptor(ZK.prototype,"fillColor"),ZK.prototype),le(ZK.prototype,"miterLimit",[YK],Object.getOwnPropertyDescriptor(ZK.prototype,"miterLimit"),ZK.prototype),le(ZK.prototype,"color",[sl,KK],Object.getOwnPropertyDescriptor(ZK.prototype,"color"),ZK.prototype),JK=le(ZK.prototype,"_lineWidth",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),$K=le(ZK.prototype,"_strokeColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.BLACK.clone()}}),eQ=le(ZK.prototype,"_lineJoin",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return TK.MITER}}),tQ=le(ZK.prototype,"_lineCap",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return SK.BUTT}}),nQ=le(ZK.prototype,"_fillColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),iQ=le(ZK.prototype,"_miterLimit",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 10}}),QK=ZK))||QK)||QK)||QK)||QK));u.Graphics=BQ;var FQ,zQ=new jn,UQ=new Kn,kQ=new jn,GQ=[];!function(e){e[e.RECT=0]="RECT",e[e.ELLIPSE=1]="ELLIPSE",e[e.GRAPHICS_STENCIL=2]="GRAPHICS_STENCIL",e[e.IMAGE_STENCIL=3]="IMAGE_STENCIL"}(FQ||(FQ={})),ut(FQ);var HQ=function(t){return e({Mask:t,MaskComponent:t}),t}((aQ=mc("cc.Mask"),sQ=Oc(),cQ=gc(110),lQ=Pc(),uQ=Zc(FQ),hQ=Fc(),fQ=Vc(),_Q=Fc(),pQ=Nc(),dQ=Zc(nq),mQ=Nc(),vQ=Nc(),gQ=zc(),yQ=Nc(),xQ=Nc(),aQ(SQ=sQ(SQ=cQ(SQ=lQ((RQ=PQ=function(e){function t(){var t;return(t=e.call(this)||this)._clearStencilMtl=null,t._clearModel=null,ce(t,"_type",bQ,oe(t)),ce(t,"_inverted",EQ,oe(t)),ce(t,"_segments",CQ,oe(t)),ce(t,"_spriteFrame",AQ,oe(t)),ce(t,"_alphaThreshold",wQ,oe(t)),t._graphics=null,t._clearModelMesh=null,t._instanceMaterialType=KX.ADD_COLOR,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._createClearModel(),this._createGraphics(),this._graphics&&this._graphics.onLoad()},n.onEnable=function(){e.prototype.onEnable.call(this),this._updateGraphics(),this._enableGraphics()},n.onRestore=function(){this._createGraphics(),e.prototype.updateMaterial.call(this),this._updateGraphics(),this._renderFlag=this._canRender()},n.onDisable=function(){e.prototype.onDisable.call(this),this._disableGraphics()},n.onDestroy=function(){this._clearModel&&this._clearModelMesh&&(jM.root.destroyModel(this._clearModel),this._clearModelMesh.destroy()),this._clearStencilMtl&&this._clearStencilMtl.destroy(),this._removeGraphics(),e.prototype.onDestroy.call(this)},n.isHit=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=n.width,r=n.height,o=UQ;this.node.getWorldMatrix(zQ),jn.invert(kQ,zQ),Kn.transformMat4(o,e,kQ);var a=t.anchorPoint;o.x+=a.x*i,o.y+=a.y*r;var s=!1;if(this.type===FQ.RECT||this.type===FQ.GRAPHICS_STENCIL||this.type===FQ.IMAGE_STENCIL)s=o.x>=0&&o.y>=0&&o.x<=i&&o.y<=r;else if(this.type===FQ.ELLIPSE){var c=i/2,l=r/2,u=o.x-.5*i,h=o.y-.5*r;s=u*u/(c*c)+h*h/(l*l)<1}return this._inverted&&(s=!s),s},n._render=function(e){e.commitComp(this,this.renderData,null,this._assembler,null)},n._postRender=function(e){this._postAssembler&&e.commitComp(this,null,null,this._postAssembler,null)},n._nodeStateChange=function(t){e.prototype._nodeStateChange.call(this,t),this._updateGraphics()},n._canRender=function(){return!!e.prototype._canRender.call(this)&&null!==this._graphics&&(this._type!==FQ.IMAGE_STENCIL||null!==this._spriteFrame)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this),n=t.PostAssembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._postAssembler!==n&&(this._postAssembler=n),this._useRenderData()},n._createGraphics=function(){if(!this._graphics){var e=this._graphics=new BQ;e._objFlags|=ml.Flags.IsOnLoadCalled,e.node=this.node,e.node.getWorldMatrix(),e.lineWidth=0;var t=Pn.WHITE.clone();t.a=0,e.fillColor=t}this._updateMaterial()},n._updateGraphics=function(){if(this._graphics&&(this._type===FQ.RECT||this._type===FQ.ELLIPSE)){var e=this.node._uiProps.uiTransformComp,t=this._graphics;t.clear();var n=e.contentSize,i=n.width,r=n.height,o=e.anchorPoint,a=-i*o.x,s=-r*o.y;if(this._type===FQ.RECT)t.rect(a,s,i,r);else if(this._type===FQ.ELLIPSE){for(var c=function(e,t,n){GQ.length=0;for(var i=2*Math.PI/n,r=0;r<n;++r)GQ.push(new In(t.x*Math.cos(i*r)+e.x,t.y*Math.sin(i*r)+e.y,0));return GQ}(new In(a+i/2,s+r/2,0),new In(i/2,r/2,0),this._segments),l=0;l<c.length;++l){var u=c[l];0===l?t.moveTo(u.x,u.y):t.lineTo(u.x,u.y)}t.close()}t.fill()}},n._createClearModel=function(){if(!this._clearModel){var e=Nv.get("default-clear-stencil");this._clearStencilMtl=new gT({parent:e,owner:this,subModelIdx:0}),this._clearModel=jM.root.createModel(uT),this._clearModel.node=this._clearModel.transform=this.node;var t=$q(Yq),n=u.director.root.device,i=n.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,4*t,t)),r=new Float32Array([-1,-1,0,1,-1,0,-1,1,0,1,1,0]);i.update(r);var o=n.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,6*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT)),a=new Uint16Array([0,1,2,2,1,3]);o.update(a),this._clearModelMesh=new VA([i],Yq,Ui.TRIANGLE_LIST,o),this._clearModelMesh.subMeshIdx=0,this._clearModel.initSubModel(0,this._clearModelMesh,this._clearStencilMtl)}},n._updateMaterial=function(){if(this._graphics){var e,t=this._graphics;t.stencilStage=pX.DISABLED,this._type===FQ.IMAGE_STENCIL?(e=Nv.get("ui-alpha-test-material"),t.setMaterial(e,0),(e=t.getMaterialInstance(0)).setProperty("alphaThreshold",this._alphaThreshold)):(e=Nv.get("ui-graphics-material"),t.setMaterial(e,0),t.getMaterialInstance(0))}},n._enableGraphics=function(){this._graphics&&(this._graphics._renderFlag=this._graphics._canRender())},n._disableGraphics=function(){this._graphics&&this._graphics.onDisable()},n._removeGraphics=function(){this._graphics&&(this._graphics.destroy(),this._graphics._destroyImmediate(),this._graphics=null)},n._useRenderData=function(){this._type!==FQ.IMAGE_STENCIL||this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this.markForUpdateRenderData())},Z(t,[{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this.markForUpdateRenderData(!1),this._updateMaterial(),this._type!==FQ.IMAGE_STENCIL?(this._spriteFrame=null,this._updateGraphics(),this._renderData&&(this.destroyRenderData(),this._renderData=null)):(this._useRenderData(),this._graphics&&this._graphics.clear()))}},{key:"inverted",get:function(){return this._inverted},set:function(e){this._inverted=e,this.stencilStage=pX.DISABLED,this._graphics&&(this._graphics.stencilStage=pX.DISABLED)}},{key:"segments",get:function(){return this._segments},set:function(e){this._segments!==e&&(this._segments=ln(e,3,1e4),this._updateGraphics())}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this._type===FQ.IMAGE_STENCIL&&!t&&e&&this.markForUpdateRenderData()}}},{key:"alphaThreshold",get:function(){return this._alphaThreshold},set:function(e){this._alphaThreshold!==e&&(this._alphaThreshold=e,this.type===FQ.IMAGE_STENCIL&&this._graphics&&this._graphics.getMaterialInstance(0).setProperty("alphaThreshold",this._alphaThreshold))}},{key:"graphics",get:function(){return this._graphics}},{key:"dstBlendFactor",get:function(){return this._dstBlendFactor},set:function(e){this._dstBlendFactor!==e&&(this._dstBlendFactor=e,this._updateBlendFunc())}},{key:"srcBlendFactor",get:function(){return this._srcBlendFactor},set:function(e){this._srcBlendFactor!==e&&(this._srcBlendFactor=e,this._updateBlendFunc())}},{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this.markForUpdateRenderData())}},{key:"customMaterial",get:function(){return this._customMaterial},set:function(){}}]),t}(_K),PQ.Type=FQ,le((TQ=RQ).prototype,"type",[uQ,hQ],Object.getOwnPropertyDescriptor(TQ.prototype,"type"),TQ.prototype),le(TQ.prototype,"inverted",[fQ,_Q],Object.getOwnPropertyDescriptor(TQ.prototype,"inverted"),TQ.prototype),le(TQ.prototype,"segments",[pQ],Object.getOwnPropertyDescriptor(TQ.prototype,"segments"),TQ.prototype),le(TQ.prototype,"spriteFrame",[dQ,mQ],Object.getOwnPropertyDescriptor(TQ.prototype,"spriteFrame"),TQ.prototype),le(TQ.prototype,"alphaThreshold",[vQ,gQ,Hc],Object.getOwnPropertyDescriptor(TQ.prototype,"alphaThreshold"),TQ.prototype),le(TQ.prototype,"color",[sl,yQ],Object.getOwnPropertyDescriptor(TQ.prototype,"color"),TQ.prototype),le(TQ.prototype,"customMaterial",[sl,xQ],Object.getOwnPropertyDescriptor(TQ.prototype,"customMaterial"),TQ.prototype),bQ=le(TQ.prototype,"_type",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return FQ.RECT}}),EQ=le(TQ.prototype,"_inverted",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),CQ=le(TQ.prototype,"_segments",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),AQ=le(TQ.prototype,"_spriteFrame",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),wQ=le(TQ.prototype,"_alphaThreshold",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),SQ=TQ))||SQ)||SQ)||SQ)||SQ));RI._maskComp=HQ,u.Mask=HQ;var VQ,WQ,jQ,qQ,XQ,YQ,KQ,QQ,ZQ,JQ,$Q,eZ,tZ,nZ,iZ,rZ,oZ,aZ,sZ,cZ,lZ,uZ,hZ,fZ,_Z,pZ,dZ,mZ,vZ,gZ,yZ,xZ,SZ,TZ,bZ,EZ,CZ,AZ,wZ,PZ,RZ,IZ,DZ,OZ,MZ,NZ,LZ,BZ,FZ,zZ,UZ,kZ,GZ,HZ,VZ,WZ,jZ,qZ,XZ,YZ,KZ,QZ,ZZ=/^(click)(\s)*=|(param)(\s)*=/,JZ=/(\s)*src(\s)*=|(\s)*height(\s)*=|(\s)*width(\s)*=|(\s)*align(\s)*=|(\s)*offset(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/,$Z=e("HtmlTextParser",function(){function e(){this._specialSymbolArray=[],this._stack=[],this._resultObjectArray=[],this._specialSymbolArray.push([/&lt;/g,"<"]),this._specialSymbolArray.push([/&gt;/g,">"]),this._specialSymbolArray.push([/&amp;/g,"&"]),this._specialSymbolArray.push([/&quot;/g,'"']),this._specialSymbolArray.push([/&apos;/g,"'"])}var t=e.prototype;return t.parse=function(e){this._resultObjectArray.length=0,this._stack.length=0;for(var t=0,n=e.length;t<n;){var i=e.indexOf(">",t),r=-1;if(i>=0&&(r=e.lastIndexOf("<",i))<t-1&&(r=e.indexOf("<",i+1),i=e.indexOf(">",r+1)),r<0)this._stack.pop(),this._processResult(e.substring(t)),t=n;else{var o=e.substring(t,r),a=e.substring(r+1,i);""===a&&(o=e.substring(t,i+1)),this._processResult(o),-1===i?i=r:"/"===e.charAt(r+1)?this._stack.pop():this._addToStack(a),t=i+1}}return this._resultObjectArray},t._attributeToObject=function(e){e=e.trim();var t={},n=/^(color|size)(\s)*=/.exec(e),i="",r=0,o="";if(n){if(i=n[0],""===(e=e.substring(i.length).trim()))return t;switch(r=e.indexOf(" "),i[0]){case"c":t.color=r>-1?e.substring(0,r).trim():e;break;case"s":t.size=parseInt(e)}return r>-1&&(o=e.substring(r+1).trim(),t.event=this._processEventHandler(o)),t}if((n=/^(br(\s)*\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("br")&&"/"===i[i.length-1])return t.isNewLine=!0,this._resultObjectArray.push({text:"",style:{isNewLine:!0}}),t;var a="";if((n=/^(img(\s)*src(\s)*=[^>]+\/)/.exec(e))&&n[0].length>0&&(i=n[0].trim()).startsWith("img")&&"/"===i[i.length-1]){var s;n=JZ.exec(e);for(var c=!1;n;){if(i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),s=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),s.endsWith("/")&&(s=s.slice(0,-1)),"src"===i){switch(s.charCodeAt(0)){case 34:case 39:c=!0,s=s.slice(1,-1)}t.isImage=!0,t.src=s}else if("height"===i)t.imageHeight=parseInt(s);else if("width"===i)t.imageWidth=parseInt(s);else if("align"===i){switch(s.charCodeAt(0)){case 34:case 39:s=s.slice(1,-1)}t.imageAlign=s.toLowerCase()}else"offset"===i?t.imageOffset=s:"click"===i&&(t.event=this._processEventHandler(i+"="+s));t.event&&"param"===i&&(t.event[i]=s.replace(/^"|"$/g,"")),n=JZ.exec(e)}return c&&t.isImage&&this._resultObjectArray.push({text:"",style:t}),{}}if(n=/^(outline(\s)*[^>]*)/.exec(e)){var l={color:"#ffffff",width:1};if(e=n[0].substring("outline".length).trim()){var u,h=/(\s)*color(\s)*=|(\s)*width(\s)*=|(\s)*click(\s)*=|(\s)*param(\s)*=/;for(n=h.exec(e);n;)i=(e=e.substring(e.indexOf(n[0]))).substr(0,n[0].length),u=(r=(a=e.substring(i.length).trim()).indexOf(" "))>-1?a.substr(0,r):a,i=(i=i.replace(/[^a-zA-Z]/g,"").trim()).toLowerCase(),e=a.substring(r).trim(),"click"===i?t.event=this._processEventHandler(i+"="+u):"color"===i?l.color=u:"width"===i&&(l.width=parseInt(u)),t.event&&"param"===i&&(t.event[i]=u.replace(/^"|"$/g,"")),n=h.exec(e)}t.outline=l}if((n=/^(on|u|b|i)(\s)*/.exec(e))&&n[0].length>0){switch(i=n[0],e=e.substring(i.length).trim(),i[0]){case"u":t.underline=!0;break;case"i":t.italic=!0;break;case"b":t.bold=!0}if(""===e)return t;t.event=this._processEventHandler(e)}return t},t._processEventHandler=function(e){for(var t={},n=0,i=!1,r=ZZ.exec(e);r;){var o=r[0],a="";if(i=!1,'"'===(e=e.substring(o.length).trim()).charAt(0))(n=e.indexOf('"',1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else if("'"===e.charAt(0))(n=e.indexOf("'",1))>-1&&(a=e.substring(1,n).trim(),i=!0),n++;else{var s=/(\S)+/.exec(e);n=(a=s?s[0]:"").length}i&&(t[o=o.substring(0,o.length-1).trim()]=a),e=e.substring(n).trim(),r=ZZ.exec(e)}return t},t._addToStack=function(e){var t=this._attributeToObject(e);if(0===this._stack.length)this._stack.push(t);else{if(t.isNewLine||t.isImage)return;var n=this._stack[this._stack.length-1];for(var i in n)t[i]||(t[i]=n[i]);this._stack.push(t)}},t._processResult=function(e){0!==e.length&&(e=this._escapeSpecialSymbol(e),this._stack.length>0?this._resultObjectArray.push({text:e,style:this._stack[this._stack.length-1]}):this._resultObjectArray.push({text:e}))},t._escapeSpecialSymbol=function(e){for(var t,n=se(this._specialSymbolArray);!(t=n()).done;){var i=t.value,r=i[0],o=i[1];e=e.replace(r,o)}return e},e}()),eJ=function(t){return e({LabelOutline:t,LabelOutlineComponent:t}),t}((VQ=mc("cc.LabelOutline"),WQ=Oc(),jQ=gc(110),qQ=Pc(),XQ=vc(pK),YQ=Fc(),KQ=Fc(),VQ(QQ=WQ(QQ=jQ(QQ=qQ(QQ=XQ(QQ=wc((eZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_color",JQ,oe(t)),ce(t,"_width",$Q,oe(t)),t}$(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(pK);e&&e.updateRenderData(!0)},Z(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"width",get:function(){return this._width},set:function(e){this._width!==e&&(this._width=e,this._updateRenderData())}}]),t}(th),JQ=le((ZQ=eZ).prototype,"_color",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(0,0,0,255)}}),$Q=le(ZQ.prototype,"_width",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),le(ZQ.prototype,"color",[YQ],Object.getOwnPropertyDescriptor(ZQ.prototype,"color"),ZQ.prototype),le(ZQ.prototype,"width",[KQ],Object.getOwnPropertyDescriptor(ZQ.prototype,"width"),ZQ.prototype),QQ=ZQ))||QQ)||QQ)||QQ)||QQ)||QQ)||QQ));u.LabelOutline=eJ,function(e){e[e.SIMPLE=0]="SIMPLE",e[e.SLICED=1]="SLICED",e[e.TILED=2]="TILED",e[e.FILLED=3]="FILLED"}(XZ||(XZ={})),ut(XZ),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.RADIAL=2]="RADIAL"}(YZ||(YZ={})),ut(YZ),function(e){e[e.CUSTOM=0]="CUSTOM",e[e.TRIMMED=1]="TRIMMED",e[e.RAW=2]="RAW"}(KZ||(KZ={})),ut(KZ),function(e){e.SPRITE_FRAME_CHANGED="spriteframe-changed"}(QZ||(QZ={}));var tJ,nJ=function(t){return e({Sprite:t,SpriteComponent:t}),t}((tZ=mc("cc.Sprite"),nZ=Oc(),iZ=gc(110),rZ=Pc(),oZ=Zc(rq),aZ=Vc(),sZ=Fc(),cZ=Zc(nq),lZ=Vc(),uZ=Fc(),hZ=Zc(XZ),fZ=Vc(),_Z=Fc(),pZ=Zc(YZ),dZ=Vc(),mZ=Fc(),vZ=Vc(),gZ=Fc(),yZ=zc(),xZ=Vc(),SZ=Fc(),TZ=zc(),bZ=Vc(),EZ=Fc(),CZ=Nc(),AZ=Vc(),wZ=Fc(),PZ=Vc(),RZ=Fc(),IZ=Zc(KZ),DZ=Vc(),OZ=Fc(),tZ(MZ=nZ(MZ=iZ(MZ=rZ((qZ=jZ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_spriteFrame",LZ,oe(t)),ce(t,"_type",BZ,oe(t)),ce(t,"_fillType",FZ,oe(t)),ce(t,"_sizeMode",zZ,oe(t)),ce(t,"_fillCenter",UZ,oe(t)),ce(t,"_fillStart",kZ,oe(t)),ce(t,"_fillRange",GZ,oe(t)),ce(t,"_isTrimmedMode",HZ,oe(t)),ce(t,"_useGrayscale",VZ,oe(t)),ce(t,"_atlas",WZ,oe(t)),t}$(t,e);var n=t.prototype;return n.__preload=function(){this.changeMaterialForDefine(),e.prototype.__preload.call(this)},n.onEnable=function(){e.prototype.onEnable.call(this),this._activateMaterial();var t=this._spriteFrame;t&&(this._updateUVs(),this._type===XZ.SLICED&&t.on(nq.EVENT_UV_UPDATED,this._updateUVs,this))},n.onDisable=function(){this._spriteFrame&&this._type===XZ.SLICED&&this._spriteFrame.off(nq.EVENT_UV_UPDATED,this._updateUVs,this)},n.onDestroy=function(){e.prototype.onDestroy.call(this)},n.changeSpriteFrameFromAtlas=function(e){if(this._atlas){var t=this._atlas.getSpriteFrame(e);this.spriteFrame=t}else console.warn("SpriteAtlas is null.")},n.changeMaterialForDefine=function(){var e,t=this._instanceMaterialType;this._spriteFrame&&(e=this._spriteFrame.texture);var n=!1;if(e instanceof ev){var i=e.getPixelFormat();n=i===Mm.RGBA_ETC1||i===Mm.RGB_A_PVRTC_4BPPV1||i===Mm.RGB_A_PVRTC_2BPPV1}n&&this.grayscale?this._instanceMaterialType=KX.USE_ALPHA_SEPARATED_AND_GRAY:n?this._instanceMaterialType=KX.USE_ALPHA_SEPARATED:this.grayscale?this._instanceMaterialType=KX.GRAYSCALE:this._instanceMaterialType=KX.ADD_COLOR_AND_TEXTURE,t!==this._instanceMaterialType&&this.updateMaterial()},n._updateBuiltinMaterial=function(){var t=e.prototype._updateBuiltinMaterial.call(this);if(this.spriteFrame&&this.spriteFrame.texture instanceof GS){var n=J({SAMPLE_FROM_RT:!0},t.passes[0].defines),i=new ug;i.initialize({effectAsset:t.effectAsset,defines:n}),t=i}return t},n._render=function(e){e.commitComp(this,this.renderData,this._spriteFrame,this._assembler,null)},n._canRender=function(){if(!e.prototype._canRender.call(this))return!1;var t=this._spriteFrame;return!(!t||!t.texture)},n._flushAssembler=function(){var e=t.Assembler.getAssembler(this);this._assembler!==e&&(this.destroyRenderData(),this._assembler=e),this._renderData||this._assembler&&this._assembler.createData&&(this._renderData=this._assembler.createData(this),this._renderData.material=this.getRenderMaterial(0),this.markForUpdateRenderData(),this.spriteFrame&&this._assembler.updateUVs(this),this._updateColor()),this._spriteFrame&&(this._type===XZ.SLICED?this._spriteFrame.on(nq.EVENT_UV_UPDATED,this._updateUVs,this):this._spriteFrame.off(nq.EVENT_UV_UPDATED,this._updateUVs,this))},n._applySpriteSize=function(){if(this._spriteFrame){if(!this._spriteFrame.isDefault)if(KZ.RAW===this._sizeMode){var e=this._spriteFrame.originalSize;this.node._uiProps.uiTransformComp.setContentSize(e)}else if(KZ.TRIMMED===this._sizeMode){var t=this._spriteFrame.rect;this.node._uiProps.uiTransformComp.setContentSize(t.width,t.height)}this._activateMaterial()}},n._resized=function(){},n._activateMaterial=function(){var e=this._spriteFrame,t=this.getRenderMaterial(0);e&&t&&this.markForUpdateRenderData(),this._renderData&&(this._renderData.material=t)},n._updateUVs=function(){this._assembler&&this._assembler.updateUVs(this)},n._applySpriteFrame=function(e){var t=this._spriteFrame;e&&this._type===XZ.SLICED&&e.off(nq.EVENT_UV_UPDATED,this._updateUVs,this),this._updateUVs();var n=!1;t&&(e&&e.texture===t.texture||(n=!0),n&&(this._renderData&&(this._renderData.textureDirty=!0),this.changeMaterialForDefine()),this._applySpriteSize(),this._type===XZ.SLICED&&t.on(nq.EVENT_UV_UPDATED,this._updateUVs,this))},Z(t,[{key:"spriteAtlas",get:function(){return this._atlas},set:function(e){this._atlas!==e&&(this._atlas=e)}},{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){if(this._spriteFrame!==e){var t=this._spriteFrame;this._spriteFrame=e,this.markForUpdateRenderData(!1),this._applySpriteFrame(t)}}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._flushAssembler())}},{key:"fillType",get:function(){return this._fillType},set:function(e){this._fillType!==e&&(e===YZ.RADIAL||this._fillType===YZ.RADIAL?(this.destroyRenderData(),this._renderData=null):this._renderData&&this.markForUpdateRenderData(!0)),this._fillType=e,this._flushAssembler()}},{key:"fillCenter",get:function(){return this._fillCenter},set:function(e){this._fillCenter.x=e.x,this._fillCenter.y=e.y,this._type===XZ.FILLED&&this._renderData&&this.markForUpdateRenderData()}},{key:"fillStart",get:function(){return this._fillStart},set:function(e){this._fillStart=ln(e,0,1),this._type===XZ.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"fillRange",get:function(){return this._fillRange},set:function(e){this._fillRange=ln(e,-1,1),this._type===XZ.FILLED&&this._renderData&&(this.markForUpdateRenderData(),this._updateUVs())}},{key:"trim",get:function(){return this._isTrimmedMode},set:function(e){this._isTrimmedMode!==e&&(this._isTrimmedMode=e,this._type===XZ.SIMPLE&&this._renderData&&this.markForUpdateRenderData(!0))}},{key:"grayscale",get:function(){return this._useGrayscale},set:function(e){this._useGrayscale!==e&&(this._useGrayscale=e,this.changeMaterialForDefine(),this.updateMaterial())}},{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,e!==KZ.CUSTOM&&this._applySpriteSize())}}]),t}(_K),jZ.FillType=YZ,jZ.Type=XZ,jZ.SizeMode=KZ,jZ.EventType=QZ,le((NZ=qZ).prototype,"spriteAtlas",[oZ,aZ,sZ],Object.getOwnPropertyDescriptor(NZ.prototype,"spriteAtlas"),NZ.prototype),le(NZ.prototype,"spriteFrame",[cZ,lZ,uZ],Object.getOwnPropertyDescriptor(NZ.prototype,"spriteFrame"),NZ.prototype),le(NZ.prototype,"type",[hZ,fZ,_Z],Object.getOwnPropertyDescriptor(NZ.prototype,"type"),NZ.prototype),le(NZ.prototype,"fillType",[pZ,dZ,mZ],Object.getOwnPropertyDescriptor(NZ.prototype,"fillType"),NZ.prototype),le(NZ.prototype,"fillCenter",[vZ,gZ],Object.getOwnPropertyDescriptor(NZ.prototype,"fillCenter"),NZ.prototype),le(NZ.prototype,"fillStart",[yZ,xZ,SZ],Object.getOwnPropertyDescriptor(NZ.prototype,"fillStart"),NZ.prototype),le(NZ.prototype,"fillRange",[TZ,bZ,EZ],Object.getOwnPropertyDescriptor(NZ.prototype,"fillRange"),NZ.prototype),le(NZ.prototype,"trim",[CZ,AZ,wZ],Object.getOwnPropertyDescriptor(NZ.prototype,"trim"),NZ.prototype),le(NZ.prototype,"grayscale",[Mc,PZ,RZ],Object.getOwnPropertyDescriptor(NZ.prototype,"grayscale"),NZ.prototype),le(NZ.prototype,"sizeMode",[IZ,DZ,OZ],Object.getOwnPropertyDescriptor(NZ.prototype,"sizeMode"),NZ.prototype),LZ=le(NZ.prototype,"_spriteFrame",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),BZ=le(NZ.prototype,"_type",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XZ.SIMPLE}}),FZ=le(NZ.prototype,"_fillType",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return YZ.HORIZONTAL}}),zZ=le(NZ.prototype,"_sizeMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return KZ.TRIMMED}}),UZ=le(NZ.prototype,"_fillCenter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(0,0)}}),kZ=le(NZ.prototype,"_fillStart",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GZ=le(NZ.prototype,"_fillRange",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HZ=le(NZ.prototype,"_isTrimmedMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),VZ=le(NZ.prototype,"_useGrayscale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),WZ=le(NZ.prototype,"_atlas",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),MZ=NZ))||MZ)||MZ)||MZ)||MZ));u.Sprite=nJ;var iJ,rJ,oJ,aJ,sJ,cJ,lJ,uJ,hJ,fJ,_J,pJ,dJ,mJ,vJ,gJ,yJ,xJ,SJ,TJ,bJ,EJ,CJ,AJ,wJ,PJ,RJ,IJ,DJ,OJ,MJ,NJ,LJ,BJ,FJ,zJ,UJ,kJ,GJ,HJ,VJ,WJ,jJ,qJ,XJ,YJ,KJ,QJ,ZJ,JJ=e("RenderRoot2D",mc("cc.RenderRoot2D")(tJ=gc(100)(tJ=Pc()(tJ=vc(RX)(tJ=yc(tJ=wc(tJ=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.onEnable=function(){u.director.root.batcher2D.addScreen(this)},n.onDisable=function(){u.director.root.batcher2D.removeScreen(this)},n.onDestroy=function(){u.director.root.batcher2D.removeScreen(this)},t}(th))||tJ)||tJ)||tJ)||tJ)||tJ)||tJ),$J=new In,e$=st({OVERLAY:0,INTERSPERSE:1}),t$=function(t){return e({Canvas:t,CanvasComponent:t}),t}((iJ=mc("cc.Canvas"),rJ=Oc(),oJ=gc(100),aJ=Pc(),sJ=Zc(oF),cJ=Fc(),lJ=Fc(),uJ=Zc(oF),iJ(hJ=rJ(hJ=oJ(hJ=aJ(hJ=wc(hJ=yc((le((fJ=function(e){function t(){var t;return ce(t=e.call(this)||this,"_cameraComponent",_J,oe(t)),ce(t,"_alignCanvasWithScreen",pJ,oe(t)),t._thisOnCameraResized=void 0,t._fitDesignResolution=void 0,t._pos=new In,t._renderMode=e$.OVERLAY,t._thisOnCameraResized=t._onResizeCamera.bind(oe(t)),t}$(t,e);var n=t.prototype;return n.__preload=function(){var e=this.getComponent("cc.Widget");e&&e.updateAlignment(),this._cameraComponent&&(this._cameraComponent._createCamera(),this._cameraComponent.node.on(oF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)),this._onResizeCamera(),this.node.on(Wb.TRANSFORM_CHANGED,this._thisOnCameraResized)},n.onEnable=function(){e.prototype.onEnable.call(this),this._cameraComponent&&this._cameraComponent.node.on(oF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDisable=function(){e.prototype.onDisable.call(this),this._cameraComponent&&this._cameraComponent.node.off(oF.TARGET_TEXTURE_CHANGE,this._thisOnCameraResized)},n.onDestroy=function(){e.prototype.onDestroy.call(this),this.node.off(Wb.TRANSFORM_CHANGED,this._thisOnCameraResized)},n._onResizeCamera=function(){if(this._cameraComponent&&this._alignCanvasWithScreen){if(this._cameraComponent.targetTexture)this._cameraComponent.orthoHeight=YM.height/2;else{var e=uh.windowSize;this._cameraComponent.orthoHeight=e.height/tN.getScaleY()/2}this.node.getWorldPosition($J),this._cameraComponent.node.setWorldPosition($J.x,$J.y,1e3)}},n._getViewPriority=function(){if(this._cameraComponent){var e,t=null===(e=this.cameraComponent)||void 0===e?void 0:e.priority;return this._renderMode===e$.OVERLAY?t|1<<30:t&~(1<<30)}return 0},Z(t,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode=e,this._cameraComponent&&(this._cameraComponent.priority=this._getViewPriority())}},{key:"cameraComponent",get:function(){return this._cameraComponent},set:function(e){this._cameraComponent!==e&&(this._cameraComponent=e,this._onResizeCamera())}},{key:"alignCanvasWithScreen",get:function(){return this._alignCanvasWithScreen},set:function(e){this._alignCanvasWithScreen=e,this._onResizeCamera()}}]),t}(JJ)).prototype,"cameraComponent",[sJ,cJ],Object.getOwnPropertyDescriptor(fJ.prototype,"cameraComponent"),fJ.prototype),le(fJ.prototype,"alignCanvasWithScreen",[lJ],Object.getOwnPropertyDescriptor(fJ.prototype,"alignCanvasWithScreen"),fJ.prototype),_J=le(fJ.prototype,"_cameraComponent",[uJ],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pJ=le(fJ.prototype,"_alignCanvasWithScreen",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),hJ=fJ))||hJ)||hJ)||hJ)||hJ)||hJ)||hJ));u.Canvas=t$,G(e("UIComponent",mc("cc.UIComponent")(dJ=vc(RX)(dJ=gc(110)(dJ=yc(dJ=wc(dJ=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastParent=null,t.stencilStage=pX.DISABLED,t}$(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onEnable=function(){},n.onDisable=function(){},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null)},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},t}(th))||dJ)||dJ)||dJ)||dJ)||dJ).prototype,"UIComponent",[{name:"_visibility"},{name:"setVisibility"}]),k(t$.prototype,"Canvas.prototype",[{name:"camera",newName:"cameraComponent.camera",customGetter:function(){return this._cameraComponent.camera}},{name:"clearFlag",newName:"cameraComponent.clearFlags",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearFlags:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearFlags=e)}},{name:"color",newName:"cameraComponent.clearColor",customGetter:function(){return this._cameraComponent?this._cameraComponent.clearColor:Pn.BLACK},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.clearColor=e)}},{name:"priority",newName:"cameraComponent.priority",customGetter:function(){return this._cameraComponent?this._cameraComponent.priority:0},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.priority=e)}},{name:"targetTexture",newName:"cameraComponent.targetTexture",customGetter:function(){return this._cameraComponent?this._cameraComponent.targetTexture:null},customSetter:function(e){this._cameraComponent&&(this._cameraComponent.targetTexture=e)}},{name:"visibility",newName:"cameraComponent.visibility",customGetter:function(){return this._cameraComponent?this._cameraComponent.visibility:0}}]),H(_K.prototype,"Renderable2D.prototype",[{name:"srcBlendFactor",suggest:"Please use a custom material to specify blending options instead."},{name:"dstBlendFactor",suggest:"Please use a custom material to specify blending options instead."}]),H(RX.prototype,"UITransform.prototype",[{name:"priority",suggest:"Please use setSiblingIndex to change index of the current node in its parent's children array."}]),u.UITransformComponent=RX,rt.setClassAlias(RX,"cc.UITransformComponent"),rt.setClassAlias(_K,"cc.RenderComponent"),u.CanvasComponent=t$,rt.setClassAlias(t$,"cc.CanvasComponent");var n$=new $Z,i$="RICHTEXT_CHILD",r$="RICHTEXT_Image_CHILD",o$=new nt((function(e){if(!u.isValid(e.node))return!1;var t=e.node.getComponent(eJ);return t&&(t.width=0),!0}),20),a$=new nt((function(e){return u.isValid(e.node)}),10);function s$(e){return{node:new qC(e),comp:null,lineCount:0,styleIndex:0,imageOffset:"",clickParam:"",clickHandler:"",type:e}}function c$(e,t){var n;e===i$?n=o$._get():e===r$&&(n=a$._get());var i=(n=n||s$(e)).node;return i||(i=new qC(e)),i.hideFlags|=ml.Flags.DontSave|ml.Flags.HideInHierarchy,e===r$?(n.comp=i.getComponent(nJ)||i.addComponent(nJ),n.comp.spriteFrame=t,n.comp.type=nJ.Type.SLICED,n.comp.sizeMode=nJ.SizeMode.CUSTOM):(n.comp=i.getComponent(pK)||i.addComponent(pK),n.comp.string=t,n.comp.horizontalAlign=lK.LEFT,n.comp.verticalAlign=uK.TOP),i.setPosition(0,0,0),i._uiProps.uiTransformComp.setAnchorPoint(.5,.5),n.node=i,n.lineCount=0,n.styleIndex=0,n.imageOffset="",n.clickParam="",n.clickHandler="",n}var l$,u$=function(t){return e({RichText:t,RichTextComponent:t}),t}((mJ=mc("cc.RichText"),vJ=Oc(),gJ=gc(110),yJ=Pc(),xJ=Fc(),SJ=Zc(lK),TJ=Fc(),bJ=Fc(),EJ=Fc(),CJ=Zc(lq),AJ=Fc(),wJ=Fc(),PJ=Vc(),RJ=Zc(fK),IJ=Fc(),DJ=Fc(),OJ=Fc(),MJ=Zc(rq),NJ=Fc(),LJ=Fc(),mJ(BJ=vJ(BJ=gJ(BJ=yJ(BJ=wc((ZJ=QJ=function(e){function t(){var t;return ce(t=e.call(this)||this,"_lineHeight",zJ,oe(t)),ce(t,"_string",UJ,oe(t)),ce(t,"_horizontalAlign",kJ,oe(t)),ce(t,"_fontSize",GJ,oe(t)),ce(t,"_maxWidth",HJ,oe(t)),ce(t,"_fontFamily",VJ,oe(t)),ce(t,"_font",WJ,oe(t)),ce(t,"_isSystemFontUsed",jJ,oe(t)),ce(t,"_userDefinedFont",qJ,oe(t)),ce(t,"_cacheMode",XJ,oe(t)),ce(t,"_imageAtlas",YJ,oe(t)),ce(t,"_handleTouchEvent",KJ,oe(t)),t._textArray=[],t._segments=[],t._labelSegmentsCache=[],t._linesWidth=[],t._lineCount=1,t._labelWidth=0,t._labelHeight=0,t._layoutDirty=!0,t._lineOffsetX=0,t._updateRichTextStatus=void 0,t._updateRichTextStatus=t._updateRichText,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this.node.on(Wb.LAYER_CHANGED,this._applyLayer,this)},n.onEnable=function(){this.handleTouchEvent&&this._addEventListeners(),this._updateRichText(),this._activateChildren(!0)},n.onDisable=function(){this.handleTouchEvent&&this._removeEventListeners(),this._activateChildren(!1)},n.start=function(){this._onTTFLoaded(),this.node.on(Wb.ANCHOR_CHANGED,this._updateRichTextPosition,this)},n.onRestore=function(){},n.onDestroy=function(){for(var e,t=se(this._segments);!(e=t()).done;){var n=e.value;n.node.removeFromParent(),n.type===i$?o$.put(n):n.type===r$&&a$.put(n)}this.node.off(Wb.ANCHOR_CHANGED,this._updateRichTextPosition,this),this.node.off(Wb.LAYER_CHANGED,this._applyLayer,this)},n._addEventListeners=function(){this.node.on(Wb.TOUCH_END,this._onTouchEnded,this)},n._removeEventListeners=function(){this.node.off(Wb.TOUCH_END,this._onTouchEnded,this)},n._updateLabelSegmentTextAttributes=function(){var e=this;this._segments.forEach((function(t){e._applyTextAttribute(t)}))},n._createFontLabel=function(e){return c$(i$,e)},n._createImage=function(e){return c$(r$,e)},n._onTTFLoaded=function(){this._font,this._layoutDirty=!0,this._updateRichText()},n._measureText=function(e,t){var n=this,i=function(t){var i;return 0===n._labelSegmentsCache.length?(i=n._createFontLabel(t),n._labelSegmentsCache.push(i)):(i=n._labelSegmentsCache[0]).node.getComponent(pK).string=t,i.styleIndex=e,n._applyTextAttribute(i),i.node._uiProps.uiTransformComp.contentSize.width};return t?i(t):i},n._onTouchEnded=function(e){for(var t,n=this,i=this.node.getComponents(th),r=function(){var r=t.value,o=r.clickHandler,a=r.clickParam;o&&n._containsTouchLocation(r,e.touch.getUILocation())&&(i.forEach((function(t){var n=t[o];t.enabledInHierarchy&&n&&n.call(t,e,a)})),e.propagationStopped=!0)},o=se(this._segments);!(t=o()).done;)r()},n._containsTouchLocation=function(e,t){var n=e.node.getComponent(RX);return!!n&&n.getBoundingBoxToWorld().contains(t)},n._resetState=function(){for(var e=this.node.children,t=e.length-1;t>=0;t--){var n=e[t];if(n.name===i$||n.name===r$){n.parent===this.node?n.parent=null:e.splice(t,1);var i=s$(n.name);i.node=n,n.name===i$?(i.comp=n.getComponent(pK),o$.put(i)):(i.comp=n.getComponent(nJ),a$.put(i))}}e.length=0,this._segments.length=0,this._labelSegmentsCache.length=0,this._linesWidth.length=0,this._lineOffsetX=0,this._lineCount=1,this._labelWidth=0,this._labelHeight=0,this._layoutDirty=!0},n._activateChildren=function(e){for(var t=this.node.children.length-1;t>=0;t--){var n=this.node.children[t];n.name!==i$&&n.name!==r$||(n.active=e)}},n._addLabelSegment=function(e,t){var n;if(0===this._labelSegmentsCache.length)n=this._createFontLabel(e);else{var i=(n=this._labelSegmentsCache.pop()).node.getComponent(pK);i&&(i.string=e)}return n.styleIndex=t,n.lineCount=this._lineCount,n.node._uiProps.uiTransformComp.setAnchorPoint(0,0),n.node.layer=this.node.layer,this.node.addChild(n.node),this._applyTextAttribute(n),this._segments.push(n),n},n._updateRichTextWithMaxWidth=function(e,t,n){var i=t;if(this._lineOffsetX>0&&i+this._lineOffsetX>this._maxWidth)for(var r=0;this._lineOffsetX<=this._maxWidth;){var o=this._getFirstWordLen(e,r,e.length),a=e.substr(r,o),s=this._measureText(n,a);if(!(this._lineOffsetX+s<=this._maxWidth)){if(r>0){var c=e.substr(0,r);this._addLabelSegment(c,n),e=e.substr(r,e.length),i=this._measureText(n,e)}this._updateLineInfo();break}this._lineOffsetX+=s,r+=o}if(i>this._maxWidth)for(var l=Uq(e,i,this._maxWidth,this._measureText(n)),u=0;u<l.length;++u){var h=l[u],f=this._addLabelSegment(h,n).node._uiProps.uiTransformComp.contentSize;this._lineOffsetX+=f.width,l.length>1&&u<l.length-1&&this._updateLineInfo()}else this._lineOffsetX+=i,this._addLabelSegment(e,n)},n._isLastComponentCR=function(e){return e.length-1===e.lastIndexOf("\n")},n._updateLineInfo=function(){this._linesWidth.push(this._lineOffsetX),this._lineOffsetX=0,this._lineCount++},n._needsUpdateTextLayout=function(e){if(this._layoutDirty||!this._textArray||!e)return!0;if(this._textArray.length!==e.length)return!0;for(var t=0;t<this._textArray.length;t++){var n=this._textArray[t],i=e[t];if(n.text!==i.text)return!0;var r=n.style,o=i.style;if(r){if(o){if(!!o.outline!=!!r.outline)return!0;if(r.size!==o.size||r.italic!==o.italic||r.isImage!==o.isImage)return!0;if(r.src!==o.src||r.imageAlign!==o.imageAlign||r.imageHeight!==o.imageHeight||r.imageWidth!==o.imageWidth||r.imageOffset!==o.imageOffset)return!0}else if(r.size||r.italic||r.isImage||r.outline)return!0}else if(o&&(o.size||o.italic||o.isImage||o.outline))return!0}return!1},n._addRichTextImageElement=function(e){if(e.style){var t=e.style,n=t.src,i=this._imageAtlas&&n&&this._imageAtlas.getSpriteFrame(n);if(i){var r=this._createImage(i);switch(r.comp,t.imageAlign){case"top":r.node._uiProps.uiTransformComp.setAnchorPoint(0,1);break;case"center":r.node._uiProps.uiTransformComp.setAnchorPoint(0,.5);break;default:r.node._uiProps.uiTransformComp.setAnchorPoint(0,0)}t.imageOffset&&(r.imageOffset=t.imageOffset),r.node.layer=this.node.layer,this.node.addChild(r.node),this._segments.push(r);var o=i.rect.clone(),a=1,s=o.width,c=o.height,l=t.imageWidth||0,u=t.imageHeight||0;u>0?(s*=a=u/c,c*=a):(s*=a=this._lineHeight/c,c*=a),l>0&&(s=l),this._maxWidth>0?(this._lineOffsetX+s>this._maxWidth&&this._updateLineInfo(),this._lineOffsetX+=s):(this._lineOffsetX+=s,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX)),r.node._uiProps.uiTransformComp.setContentSize(s,c),r.lineCount=this._lineCount,r.clickHandler="",r.clickParam="";var h=t.event;h&&(r.clickHandler=h.click,r.clickParam=h.param)}else D(4400)}},n._updateRichText=function(){if(this.enabledInHierarchy){var e=n$.parse(this._string);if(!this._needsUpdateTextLayout(e))return this._textArray=e.slice(),void this._updateLabelSegmentTextAttributes();this._textArray=e.slice(),this._resetState();for(var t,n=!1,i=0;i<this._textArray.length;++i){var r=this._textArray[i],o=r.text;if(void 0!==o){if(""===o){if(r.style&&r.style.isNewLine){this._updateLineInfo();continue}if(r.style&&r.style.isImage&&this._imageAtlas){this._addRichTextImageElement(r);continue}}for(var a=o.split("\n"),s=0;s<a.length;++s){var c=a[s];if(""!==c)if(n=!1,this._maxWidth>0){var l=this._measureText(i,c);this._updateRichTextWithMaxWidth(c,l,i),a.length>1&&s<a.length-1&&this._updateLineInfo()}else t=this._addLabelSegment(c,i),this._lineOffsetX+=t.node._uiProps.uiTransformComp.width,this._lineOffsetX>this._labelWidth&&(this._labelWidth=this._lineOffsetX),a.length>1&&s<a.length-1&&this._updateLineInfo();else{if(this._isLastComponentCR(o)&&s===a.length-1)continue;this._updateLineInfo(),n=!0}}}}n||this._linesWidth.push(this._lineOffsetX),this._maxWidth>0&&(this._labelWidth=this._maxWidth),this._labelHeight=(this._lineCount+Cq)*this._lineHeight,this.node._uiProps.uiTransformComp.setContentSize(this._labelWidth,this._labelHeight),this._updateRichTextPosition(),this._layoutDirty=!1}},n._getFirstWordLen=function(e,t,n){var i=e.charAt(t);if(Lq(i)||Bq(i))return 1;for(var r=1,o=t+1;o<n&&!Bq(i=e.charAt(o))&&!Lq(i);++o)r++;return r},n._updateRichTextPosition=function(){for(var e=0,t=1,n=this._lineCount,i=this.node._uiProps.uiTransformComp,r=i.anchorX,o=i.anchorY,a=0;a<this._segments.length;++a){var s=this._segments[a],c=s.lineCount;c>t&&(e=0,t=c);var l=this._labelWidth*(.5*this._horizontalAlign-r);switch(this._horizontalAlign){case lK.LEFT:break;case lK.CENTER:l-=this._linesWidth[c-1]/2;break;case lK.RIGHT:l-=this._linesWidth[c-1]}var u=s.node.position;if(s.node.setPosition(e+l,this._lineHeight*(n-c)-this._labelHeight*o,u.z),c===t&&(e+=s.node._uiProps.uiTransformComp.width),s.node.getComponent(nJ)){var h=s.node.position.clone(),f=this._lineHeight,_=this._lineHeight*(1+Cq);switch(s.node._uiProps.uiTransformComp.anchorY){case 1:h.y+=f+(_-f)/2;break;case.5:h.y+=_/2;break;default:h.y+=(_-f)/2}if(s.imageOffset){var p=s.imageOffset.split(",");if(1===p.length&&p[0]){var d=parseFloat(p[0]);Number.isInteger(d)&&(h.y+=d)}else if(2===p.length){var m=parseFloat(p[0]),v=parseFloat(p[1]);Number.isInteger(m)&&(h.x+=m),Number.isInteger(v)&&(h.y+=v)}}s.node.position=h}var g=s.node.getComponent(eJ);if(g){var y=s.node.position.clone();y.y-=g.width,s.node.position=y}}},n._convertLiteralColorValue=function(e){var t=e.toUpperCase();return Pn[t]?Pn[t]:(new Pn).fromHEX(e)},n._applyTextAttribute=function(e){var t=e.node.getComponent(pK);if(t){this._resetLabelState(t);var n,i=e.styleIndex;if(this._textArray[i]&&(n=this._textArray[i].style),n){if(t.color=this._convertLiteralColorValue(n.color||"white"),t.isBold=!!n.bold,t.isItalic=!!n.italic,t.isUnderline=!!n.underline,n.outline){var r=e.node.getComponent(eJ);r||(r=e.node.addComponent(eJ)),r.color=this._convertLiteralColorValue(n.outline.color),r.width=n.outline.width}t.fontSize=n.size||this._fontSize,e.clickHandler="",e.clickParam="";var o=n.event;o&&(e.clickHandler=o.click||"",e.clickParam=o.param||"")}t.cacheMode=this._cacheMode,this._font instanceof lq&&!this._isSystemFontUsed?t.font=this._font:t.fontFamily=this._fontFamily,t.useSystemFont=this._isSystemFontUsed,t.lineHeight=this._lineHeight,t.updateRenderData(!0);var a=t._assembler;a&&a.updateRenderData(t)}},n._applyLayer=function(){for(var e,t=se(this._segments);!(e=t()).done;)e.value.node.layer=this.node.layer},n._resetLabelState=function(e){e.fontSize=this._fontSize,e.color=Pn.WHITE,e.isBold=!1,e.isItalic=!1,e.isUnderline=!1},Z(t,[{key:"string",get:function(){return this._string},set:function(e){this._string!==e&&(this._string=e,this._updateRichTextStatus())}},{key:"horizontalAlign",get:function(){return this._horizontalAlign},set:function(e){this.horizontalAlign!==e&&(this._horizontalAlign=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontSize",get:function(){return this._fontSize},set:function(e){this._fontSize!==e&&(this._fontSize=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"fontFamily",get:function(){return this._fontFamily},set:function(e){this._fontFamily!==e&&(this._fontFamily=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"font",get:function(){return this._font},set:function(e){this._font!==e&&(this._font=e,this._layoutDirty=!0,this._font?(this.useSystemFont=!1,this._onTTFLoaded()):this.useSystemFont=!0,this._updateRichTextStatus())}},{key:"useSystemFont",get:function(){return this._isSystemFontUsed},set:function(e){this._isSystemFontUsed!==e&&(this._isSystemFontUsed=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"cacheMode",get:function(){return this._cacheMode},set:function(e){this._cacheMode!==e&&(this._cacheMode=e,this._updateRichTextStatus())}},{key:"maxWidth",get:function(){return this._maxWidth},set:function(e){this._maxWidth!==e&&(this._maxWidth=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"lineHeight",get:function(){return this._lineHeight},set:function(e){this._lineHeight!==e&&(this._lineHeight=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"imageAtlas",get:function(){return this._imageAtlas},set:function(e){this._imageAtlas!==e&&(this._imageAtlas=e,this._layoutDirty=!0,this._updateRichTextStatus())}},{key:"handleTouchEvent",get:function(){return this._handleTouchEvent},set:function(e){this._handleTouchEvent!==e&&(this._handleTouchEvent=e,this.enabledInHierarchy&&(this.handleTouchEvent?this._addEventListeners():this._removeEventListeners()))}}]),t}(th),QJ.HorizontalAlign=lK,QJ.VerticalAlign=uK,le((FJ=ZJ).prototype,"string",[jc,xJ],Object.getOwnPropertyDescriptor(FJ.prototype,"string"),FJ.prototype),le(FJ.prototype,"horizontalAlign",[SJ,TJ],Object.getOwnPropertyDescriptor(FJ.prototype,"horizontalAlign"),FJ.prototype),le(FJ.prototype,"fontSize",[bJ],Object.getOwnPropertyDescriptor(FJ.prototype,"fontSize"),FJ.prototype),le(FJ.prototype,"fontFamily",[EJ],Object.getOwnPropertyDescriptor(FJ.prototype,"fontFamily"),FJ.prototype),le(FJ.prototype,"font",[CJ,AJ],Object.getOwnPropertyDescriptor(FJ.prototype,"font"),FJ.prototype),le(FJ.prototype,"useSystemFont",[wJ,PJ],Object.getOwnPropertyDescriptor(FJ.prototype,"useSystemFont"),FJ.prototype),le(FJ.prototype,"cacheMode",[RJ,IJ],Object.getOwnPropertyDescriptor(FJ.prototype,"cacheMode"),FJ.prototype),le(FJ.prototype,"maxWidth",[DJ],Object.getOwnPropertyDescriptor(FJ.prototype,"maxWidth"),FJ.prototype),le(FJ.prototype,"lineHeight",[OJ],Object.getOwnPropertyDescriptor(FJ.prototype,"lineHeight"),FJ.prototype),le(FJ.prototype,"imageAtlas",[MJ,NJ],Object.getOwnPropertyDescriptor(FJ.prototype,"imageAtlas"),FJ.prototype),le(FJ.prototype,"handleTouchEvent",[LJ],Object.getOwnPropertyDescriptor(FJ.prototype,"handleTouchEvent"),FJ.prototype),zJ=le(FJ.prototype,"_lineHeight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),UJ=le(FJ.prototype,"_string",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"<color=#00ff00>Rich</color><color=#0fffff>Text</color>"}}),kJ=le(FJ.prototype,"_horizontalAlign",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lK.LEFT}}),GJ=le(FJ.prototype,"_fontSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 40}}),HJ=le(FJ.prototype,"_maxWidth",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),VJ=le(FJ.prototype,"_fontFamily",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"Arial"}}),WJ=le(FJ.prototype,"_font",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jJ=le(FJ.prototype,"_isSystemFontUsed",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),qJ=le(FJ.prototype,"_userDefinedFont",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),XJ=le(FJ.prototype,"_cacheMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fK.NONE}}),YJ=le(FJ.prototype,"_imageAtlas",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KJ=le(FJ.prototype,"_handleTouchEvent",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),BJ=FJ))||BJ)||BJ)||BJ)||BJ)||BJ));u.RichText=u$;var h$=function(t){return e({UIMeshRenderer:t,UIModelComponent:t}),t}(mc("cc.UIMeshRenderer")(l$=Oc()(l$=gc(110)(l$=Pc()(l$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._models=null,t._modelComponent=null,t.stencilStage=pX.DISABLED,t}$(t,e);var n=t.prototype;return n.__preload=function(){this.node._uiProps.uiComp=this},n.onLoad=function(){this.node._uiProps.uiTransformComp||this.node.addComponent("cc.UITransform"),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent?this._models=this._modelComponent._collectModels():console.warn("node '"+(this.node&&this.node.name)+"' doesn't have any renderable component")},n.onDestroy=function(){this.node._uiProps.uiComp===this&&(this.node._uiProps.uiComp=null),this._modelComponent=this.getComponent("cc.RenderableComponent"),this._modelComponent&&(this._modelComponent._sceneGetter=null,this._models=null)},n.updateAssembler=function(e){if(this._models){this._modelComponent._detachFromScene();for(var t,n=se(this._models);!(t=n()).done;){var i=t.value;e.commitModel.call(e,this,i,this._modelComponent.material)}return!0}return!1},n.postUpdateAssembler=function(){},n.update=function(){this._fitUIRenderQueue()},n._fitUIRenderQueue=function(){if(this._modelComponent)for(var e=this._modelComponent.sharedMaterials.length,t=0;t<e;t++){var n=this._modelComponent.getMaterialInstance(t);if(null!=n)for(var i=n.passes,r=i.length,o=0;o<r;o++)i[o]._priority=Up.MAX-11,n.recompileShaders({CC_FORCE_FORWARD_SHADING:!0},o)}},n.markForUpdateRenderData=function(){},n.setNodeDirty=function(){},n.setTextureDirty=function(){},Z(t,[{key:"modelComponent",get:function(){return this._modelComponent}}]),t}(th))||l$)||l$)||l$)||l$);u.UIMeshRenderer=h$;var f$,_$,p$,d$,m$,v$,g$,y$,x$,S$,T$,b$,E$,C$,A$,w$,P$,R$,I$,D$,O$,M$,N$,L$,B$,F$,z$,U$,k$,G$=Fp.Enum.NONE|Fp.Enum.UI_3D,H$=e("UIDrawBatch",function(){function e(){this.bufferBatch=null,this.camera=null,this.renderScene=null,this.model=null,this.texture=null,this.sampler=null,this.useLocalData=null,this.isStatic=!1,this.textureHash=0,this.samplerHash=0,this._passes=[],this._shaders=[],this._visFlags=G$,this._inputAssembler=null,this._descriptorSet=null}var t=e.prototype;return t.destroy=function(){this._passes=[]},t.clear=function(){this.bufferBatch=null,this.inputAssembler=null,this.descriptorSet=null,this.camera=null,this.texture=null,this.sampler=null,this.textureHash=0,this.samplerHash=0,this.model=null,this.isStatic=!1,this.useLocalData=null,this.visFlags=G$,this.renderScene=null},t.fillPasses=function(e,t,n,i,r,o){if(e){var a=e.passes;if(!a)return;var s=0;this._shaders.length=a.length;for(var c=0;c<a.length;c++){this._passes[c]||(this._passes[c]=new Gv(u.director.root));var l=a[c],h=this._passes[c];l.update(),t||(t=l.depthStencilState,n=0),i||(i=l.blendState,r=0),-1===r&&(r=0),s=n<<16|r,h._initPassFromTarget(l,t,i,s),this._shaders[c]=h.getShaderVariant(o)}}},Z(e,[{key:"native",get:function(){return this._nativeObj}},{key:"inputAssembler",get:function(){return this._inputAssembler},set:function(e){this._inputAssembler=e}},{key:"descriptorSet",get:function(){return this._descriptorSet},set:function(e){this._descriptorSet=e}},{key:"visFlags",get:function(){return this._visFlags},set:function(e){this._visFlags=e}},{key:"passes",get:function(){return this._passes}},{key:"shaders",get:function(){return this._shaders}}]),e}()),V$=function(t){return e({UIStaticBatch:t,UIStaticBatchComponent:t}),t}((f$=mc("cc.UIStaticBatch"),_$=Oc(),p$=Pc(),d$=gc(110),m$=Nc(),f$(v$=_$(v$=p$(v$=d$((le((g$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._init=!1,t._bufferAccessor=null,t._dirty=!0,t._uiDrawBatchList=[],t}$(t,e);var n=t.prototype;return n.onLoad=function(){},n.onDestroy=function(){},n.updateAssembler=function(){},n.postUpdateAssembler=function(){},n.markAsDirty=function(){},n._requireDrawBatch=function(){var e=new H$;return e.isStatic=!0,this._uiDrawBatchList.push(e),e},n._clearData=function(){if(this._bufferAccessor){this._bufferAccessor.reset();for(var e=this._getBatcher(),t=0;t<this._uiDrawBatchList.length;t++)this._uiDrawBatchList[t].destroy(e)}this._uiDrawBatchList.length=0,this._init=!1},n._getBatcher=function(){return jM.root&&jM.root.batcher2D?jM.root.batcher2D:(D(9301),null)},Z(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&this._color.set(e)}},{key:"drawBatchList",get:function(){return this._uiDrawBatchList}}]),t}(_K)).prototype,"color",[sl,m$],Object.getOwnPropertyDescriptor(g$.prototype,"color"),g$.prototype),v$=g$))||v$)||v$)||v$)||v$)),W$=e("LabelShadow",(y$=mc("cc.LabelShadow"),x$=Oc(),S$=gc(110),T$=Pc(),b$=vc(pK),E$=Fc(),C$=Fc(),A$=Fc(),y$(w$=x$(w$=S$(w$=T$(w$=b$(w$=wc((O$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_color",R$,oe(t)),ce(t,"_offset",I$,oe(t)),ce(t,"_blur",D$,oe(t)),t}$(t,e);var n=t.prototype;return n.onEnable=function(){this._updateRenderData()},n.onDisable=function(){this._updateRenderData()},n._updateRenderData=function(){var e=this.node.getComponent(pK);e&&e.updateRenderData(!0)},Z(t,[{key:"color",get:function(){return this._color},set:function(e){this._color!==e&&(this._color.set(e),this._updateRenderData())}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset=e,this._updateRenderData()}},{key:"blur",get:function(){return this._blur},set:function(e){this._blur=e,this._updateRenderData()}}]),t}(th),R$=le((P$=O$).prototype,"_color",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(0,0,0,255)}}),I$=le(P$.prototype,"_offset",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(2,2)}}),D$=le(P$.prototype,"_blur",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),le(P$.prototype,"color",[E$],Object.getOwnPropertyDescriptor(P$.prototype,"color"),P$.prototype),le(P$.prototype,"offset",[C$],Object.getOwnPropertyDescriptor(P$.prototype,"offset"),P$.prototype),le(P$.prototype,"blur",[A$],Object.getOwnPropertyDescriptor(P$.prototype,"blur"),P$.prototype),w$=P$))||w$)||w$)||w$)||w$)||w$)||w$)),j$=function(t){return e({UIOpacity:t,UIOpacityComponent:t}),t}((M$=mc("cc.UIOpacity"),N$=Oc(),L$=gc(110),B$=Pc(),F$=Fc(),M$(z$=N$(z$=L$(z$=B$(z$=wc((le((U$=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_opacity",k$,oe(t)),t}$(t,e);var n=t.prototype;return n.onEnable=function(){this.node._uiProps.localOpacity=this._opacity/255},n.onDisable=function(){this.node._uiProps.localOpacity=1},Z(t,[{key:"opacity",get:function(){return this._opacity},set:function(e){this._opacity!==e&&(e=Et(e,0,255),this._opacity=e,this.node._uiProps.localOpacity=e/255)}}]),t}(th)).prototype,"opacity",[Mc,F$],Object.getOwnPropertyDescriptor(U$.prototype,"opacity"),U$.prototype),k$=le(U$.prototype,"_opacity",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 255}}),z$=U$))||z$)||z$)||z$)||z$)||z$));u.MaskComponent=HQ,rt.setClassAlias(HQ,"cc.MaskComponent"),u.LabelComponent=pK,rt.setClassAlias(pK,"cc.LabelComponent"),u.LabelOutlineComponent=eJ,rt.setClassAlias(eJ,"cc.LabelOutlineComponent"),u.RichTextComponent=u$,rt.setClassAlias(u$,"cc.RichTextComponent"),u.SpriteComponent=nJ,rt.setClassAlias(nJ,"cc.SpriteComponent"),u.UIModelComponent=h$,rt.setClassAlias(h$,"cc.UIModelComponent"),u.GraphicsComponent=BQ,rt.setClassAlias(BQ,"cc.GraphicsComponent"),rt.setClassAlias(V$,"cc.UIStaticBatchComponent"),rt.setClassAlias(j$,"cc.UIOpacityComponent");var q$=function(e,t,n){this.i=void 0,this.x=void 0,this.y=void 0,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1,this.i=e,this.x=t,this.y=n};function X$(e,t,n,i,r){var o=0,a=null;if(r===function(e,t,n,i){for(var r=0,o=t,a=n-i;o<n;o+=i)r+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return r}(e,t,n,i)>0)for(o=t;o<n;o+=i)a=h0(o,e[o],e[o+1],a);else for(o=n-i;o>=t;o-=i)a=h0(o,e[o],e[o+1],a);return a&&s0(a,a.next)&&(f0(a),a=a.next),a}function Y$(e,t){if(void 0===t&&(t=null),!e)return e;t||(t=e);var n=e,i=!1;do{if(i=!1,n.steiner||!s0(n,n.next)&&0!==a0(n.prev,n,n.next))n=n.next;else{if(f0(n),(n=t=n.prev)===n.next)return null;i=!0}}while(i||n!==t);return t}function K$(e,t,n,i,r,o,a){if(void 0===a&&(a=0),e){!a&&o&&function(e,t,n,i){var r=e;do{null===r.z&&(r.z=n0(r.x,r.y,t,n,i)),r.prevZ=r.prev,r.nextZ=r.next,r=r.next}while(r!==e);r.prevZ.nextZ=null,r.prevZ=null,function(e){var t=0,n=null,i=null,r=null,o=null,a=0,s=0,c=0,l=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,i=n,s=0,t=0;t<l&&(s++,i=i.nextZ);t++);for(c=l;s>0||c>0&&i;)0===s?(r=i,i=i.nextZ,c--):0!==c&&i?n.z<=i.z?(r=n,n=n.nextZ,s--):(r=i,i=i.nextZ,c--):(r=n,n=n.nextZ,s--),o?o.nextZ=r:e=r,r.prevZ=o,o=r;n=i}o.nextZ=null,l*=2}while(a>1)}(r)}(e,i,r,o);for(var s=e,c=null,l=null;e.prev!==e.next;)if(c=e.prev,l=e.next,o?Z$(e,i,r,o):Q$(e))t.push(c.i/n),t.push(e.i/n),t.push(l.i/n),f0(e),e=l.next,s=l.next;else if((e=l)===s){a?1===a?K$(e=J$(e,t,n),t,n,i,r,o,2):2===a&&$$(e,t,n,i,r,o):K$(Y$(e),t,n,i,r,o,1);break}}}function Q$(e){var t=e.prev,n=e,i=e.next;if(a0(t,n,i)>=0)return!1;for(var r=e.next.next;r!==e.prev;){if(r0(t.x,t.y,n.x,n.y,i.x,i.y,r.x,r.y)&&a0(r.prev,r,r.next)>=0)return!1;r=r.next}return!0}function Z$(e,t,n,i){var r=e.prev,o=e,a=e.next;if(a0(r,o,a)>=0)return!1;for(var s=r.x<o.x?r.x<a.x?r.x:a.x:o.x<a.x?o.x:a.x,c=r.y<o.y?r.y<a.y?r.y:a.y:o.y<a.y?o.y:a.y,l=r.x>o.x?r.x>a.x?r.x:a.x:o.x>a.x?o.x:a.x,u=r.y>o.y?r.y>a.y?r.y:a.y:o.y>a.y?o.y:a.y,h=n0(s,c,t,n,i),f=n0(l,u,t,n,i),_=e.nextZ;_&&_.z<=f;){if(_!==e.prev&&_!==e.next&&r0(r.x,r.y,o.x,o.y,a.x,a.y,_.x,_.y)&&a0(_.prev,_,_.next)>=0)return!1;_=_.nextZ}for(_=e.prevZ;_&&_.z>=h;){if(_!==e.prev&&_!==e.next&&r0(r.x,r.y,o.x,o.y,a.x,a.y,_.x,_.y)&&a0(_.prev,_,_.next)>=0)return!1;_=_.prevZ}return!0}function J$(e,t,n){var i=e;do{var r=i.prev,o=i.next.next;!s0(r,o)&&c0(r,i,i.next,o)&&l0(r,o)&&l0(o,r)&&(t.push(r.i/n),t.push(i.i/n),t.push(o.i/n),f0(i),f0(i.next),i=e=o),i=i.next}while(i!==e);return i}function $$(e,t,n,i,r,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&o0(a,s)){var c=u0(a,s);return a=Y$(a,a.next),c=Y$(c,c.next),K$(a,t,n,i,r,o),void K$(c,t,n,i,r,o)}s=s.next}a=a.next}while(a!==e)}function e0(e,t){return e.x-t.x}function t0(e,t){if(t=function(e,t){var n=t,i=e.x,r=e.y,o=-1/0,a=null;do{if(r<=n.y&&r>=n.next.y){var s=n.x+(r-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=i&&s>o){if(o=s,s===i){if(r===n.y)return n;if(r===n.next.y)return n.next}a=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!a)return null;if(i===o)return a.prev;var c,l=a,u=a.x,h=a.y,f=1/0;for(n=a.next;n!==l;)i>=n.x&&n.x>=u&&r0(r<h?i:o,r,u,h,r<h?o:i,r,n.x,n.y)&&((c=Math.abs(r-n.y)/(i-n.x))<f||c===f&&n.x>a.x)&&l0(n,e)&&(a=n,f=c),n=n.next;return a}(e,t)){var n=u0(t,e);Y$(n,n.next)}}function n0(e,t,n,i,r){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)/r)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-i)/r)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function i0(e){var t=e,n=e;do{t.x<n.x&&(n=t),t=t.next}while(t!==e);return n}function r0(e,t,n,i,r,o,a,s){return(r-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(i-s)-(n-a)*(t-s)>=0&&(n-a)*(o-s)-(r-a)*(i-s)>=0}function o0(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&c0(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&l0(e,t)&&l0(t,e)&&function(e,t){var n=e,i=!1,r=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&r<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(i=!i),n=n.next}while(n!==e);return i}(e,t)}function a0(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function s0(e,t){return e.x===t.x&&e.y===t.y}function c0(e,t,n,i){return!!(s0(e,t)&&s0(n,i)||s0(e,i)&&s0(n,t))||a0(e,t,n)>0!=a0(e,t,i)>0&&a0(n,i,e)>0!=a0(n,i,t)>0}function l0(e,t){return a0(e.prev,e,e.next)<0?a0(e,t,e.next)>=0&&a0(e,e.prev,t)>=0:a0(e,t,e.prev)<0||a0(e,e.next,t)<0}function u0(e,t){var n=new q$(e.i,e.x,e.y),i=new q$(t.i,t.x,t.y),r=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=r,r.prev=n,i.next=n,n.prev=i,o.next=i,i.prev=o,i}function h0(e,t,n,i){var r=new q$(e,t,n);return i?(r.next=i.next,r.prev=i,i.next.prev=r,i.next=r):(r.prev=r,r.next=r),r}function f0(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function _0(e,t,n){n=n||3;var i=t?t.length:0,r=i?t[0]*n:e.length,o=X$(e,0,r,n,!0),a=[];if(!o)return a;var s=0,c=0,l=0,u=0,h=0,f=0,_=0;if(i&&(o=function(e,t,n,i){var r,o=[],a=0,s=null;for(a=0,r=t.length;a<r;a++)(s=X$(e,t[a]*i,a<r-1?t[a+1]*i:e.length,i,!1))&&(s===s.next&&(s.steiner=!0),o.push(i0(s)));if(o.sort(e0),!n)return n;for(a=0;a<o.length;a++)t0(o[a],n),n=Y$(n,n.next);return n}(e,t,o,n)),e.length>80*n){s=l=e[0],c=u=e[1];for(var p=n;p<r;p+=n)(h=e[p])<s&&(s=h),(f=e[p+1])<c&&(c=f),h>l&&(l=h),f>u&&(u=f);_=Math.max(l-s,u-c)}return K$(o,a,n,s,c,_),a}for(var p0=Math.PI,d0=Math.min,m0=Math.max,v0=Math.ceil,g0=Math.acos,y0=Math.cos,x0=Math.sin,S0=Math.atan2,T0=null,b0=null,E0=new Pn,C0=[],A0=0;A0<4;A0++)C0.push(new In);function w0(e,t,n){return e<t?t:e>n?n:e}var P0={useModel:!0,updateRenderData:function(){},fillBuffers:function(){},renderIA:function(){},getRenderData:function(e,t){if(!b0)return null;var n=b0.getRenderDataList(),i=n[b0.dataOffset];if(!i)return null;var r=i,o=r?r.vertexStart+t:0;return(o>65535||3*o>131070)&&(++b0.dataOffset,b0.dataOffset<n.length?i=n[b0.dataOffset]:(i=b0.requestRenderData(),n[b0.dataOffset]=i),r=i),r&&r.vertexCount<o&&r.request(t,3*t),i},stroke:function(e){Pn.copy(E0,e.strokeColor),e.impl&&(this._flattenPaths(e.impl),this._expandStroke(e),e.impl.updatePathOffset=!0,this.end(e))},fill:function(e){Pn.copy(E0,e.fillColor),this._expandFill(e),e.impl&&(e.impl.updatePathOffset=!0),this.end(e)},end:function(e){e.markForUpdateRenderData()},_expandStroke:function(e){var t=.5*e.lineWidth,n=e.lineCap,i=e.lineJoin,r=e.miterLimit;if(b0=e.impl){var o=function(e,t,n){var i=2*g0(e/(e+n));return m0(2,v0(t/i))}(t,p0,b0.tessTol);this._calculateJoins(b0,t,i,r);for(var a=b0.paths,s=0,c=b0.pathOffset,l=b0.pathLength;c<l;c++){var u=a[c],h=u.points.length;i===TK.ROUND?s+=2*(h+u.bevel*(o+2)+1):s+=2*(h+5*u.bevel+1),u.closed||(n===SK.ROUND?s+=2*(2*o+2):s+=12)}var f=T0=this.getRenderData(e,s);if(f){for(var _=f.vData,p=f.iData,d=b0.pathOffset,m=b0.pathLength;d<m;d++){var v=a[d],g=v.points,y=g.length,x=f.vertexStart,S=void 0,T=void 0,b=0,E=0,C=v.closed;if(C?(S=g[y-1],T=g[0],b=0,E=y):(S=g[0],T=g[1],b=1,E=y-1),T=T||S,!C){var A=new IQ(T.x,T.y);A.subtract(S),A.normalize();var w=A.x,P=A.y;n===SK.BUTT?this._buttCapStart(S,w,P,t,0):n===SK.SQUARE?this._buttCapStart(S,w,P,t,t):n===SK.ROUND&&this._roundCapStart(S,w,P,t,o)}for(var R=b;R<E;++R)i===TK.ROUND?this._roundJoin(S,T,t,t,o):0!=(T.flags&(bK.PT_BEVEL|bK.PT_INNERBEVEL))?this._bevelJoin(S,T,t,t):(this._vSet(T.x+T.dmx*t,T.y+T.dmy*t,1),this._vSet(T.x-T.dmx*t,T.y-T.dmy*t,-1)),S=T,T=g[R+1];if(C){var I=8*x;this._vSet(_[I],_[I+1],1),this._vSet(_[I+8],_[I+8+1],-1)}else{var D=new IQ(T.x,T.y);D.subtract(S),D.normalize();var O=D.x,M=D.y;n===SK.BUTT?this._buttCapEnd(T,O,M,t,0):n===SK.SQUARE?this._buttCapEnd(T,O,M,t,t):n===SK.ROUND&&this._roundCapEnd(T,O,M,t,o)}for(var N=f.indexStart,L=x+2,B=f.vertexStart;L<B;L++)p[N++]=L-2,p[N++]=L-1,p[N++]=L;f.indexStart=N}T0=null,b0=null}}},_expandFill:function(e){if(b0=e.impl){for(var t=b0.paths,n=0,i=b0.pathOffset,r=b0.pathLength;i<r;i++)n+=t[i].points.length;var o=T0=this.getRenderData(e,n);if(o){for(var a=o,s=a.vData,c=a.iData,l=b0.pathOffset,u=b0.pathLength;l<u;l++){var h=t[l],f=h.points,_=f.length;if(0!==_){for(var p=o.vertexStart,d=0;d<_;++d)this._vSet(f[d].x,f[d].y);var m=o.indexStart;if(h.complex){for(var v=[],g=p,y=o.vertexStart;g<y;g++){var x=8*g;v.push(s[x++]),v.push(s[x++]),v.push(s[x++])}var S=_0(v,null,3);if(!S||0===S.length)continue;for(var T=0,b=S.length;T<b;T++)c[m++]=S[T]+p}else for(var E=p,C=p+2,A=a.vertexStart;C<A;C++)c[m++]=E,c[m++]=C-1,c[m++]=C;a.indexStart=m}}T0=null,b0=null}}},_calculateJoins:function(e,t,n,i){var r=0;t>0&&(r=1/t);for(var o=e.paths,a=e.pathOffset,s=e.pathLength;a<s;a++){var c=o[a],l=c.points,u=l.length,h=l[u-1],f=l[0];c.bevel=0;for(var _=0;_<u;_++){var p,d,m=h.dy,v=-h.dx,g=f.dy,y=-f.dx;if(f.dmx=.5*(m+g),f.dmy=.5*(v+y),(p=f.dmx*f.dmx+f.dmy*f.dmy)>1e-6){var x=1/p;x>600&&(x=600),f.dmx*=x,f.dmy*=x}f.dx*h.dy-h.dx*f.dy>0&&(f.flags|=bK.PT_LEFT),p*(d=m0(11,d0(h.len,f.len)*r))*d<1&&(f.flags|=bK.PT_INNERBEVEL),f.flags&bK.PT_CORNER&&(p*i*i<1||n===TK.BEVEL||n===TK.ROUND)&&(f.flags|=bK.PT_BEVEL),0!=(f.flags&(bK.PT_BEVEL|bK.PT_INNERBEVEL))&&c.bevel++,h=f,f=l[_+1]}}},_flattenPaths:function(e){for(var t=e.paths,n=e.pathOffset,i=e.pathLength;n<i;n++){var r=t[n],o=r.points,a=o[o.length-1],s=o[0];o.length>2&&a.equals(s)&&(r.closed=!0,o.pop(),a=o[o.length-1]);for(var c=0,l=o.length;c<l;c++){var u=new IQ(s.x,s.y);u.subtract(a),a.len=u.length(),(u.x||u.y)&&u.normalize(),a.dx=u.x,a.dy=u.y,a=s,s=o[c+1]}}},_chooseBevel:function(e,t,n,i){var r=n.x,o=n.y,a=0,s=0,c=0,l=0;return 0!==e?(a=r+t.dy*i,s=o-t.dx*i,c=r+n.dy*i,l=o-n.dx*i):(a=c=r+n.dmx*i,s=l=o+n.dmy*i),[a,s,c,l]},_buttCapStart:function(e,t,n,i,r){var o=e.x-t*r,a=e.y-n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_buttCapEnd:function(e,t,n,i,r){var o=e.x+t*r,a=e.y+n*r,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapStart:function(e,t,n,i,r){for(var o=e.x,a=e.y,s=n,c=-t,l=0;l<r;l++){var u=l/(r-1)*p0,h=y0(u)*i,f=x0(u)*i;this._vSet(o-s*h-t*f,a-c*h-n*f,1),this._vSet(o,a,0)}this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1)},_roundCapEnd:function(e,t,n,i,r){var o=e.x,a=e.y,s=n,c=-t;this._vSet(o+s*i,a+c*i,1),this._vSet(o-s*i,a-c*i,-1);for(var l=0;l<r;l++){var u=l/(r-1)*p0,h=y0(u)*i,f=x0(u)*i;this._vSet(o,a,0),this._vSet(o-s*h+t*f,a-c*h+n*f,1)}},_roundJoin:function(e,t,n,i,r){var o=e.dy,a=-e.dx,s=t.dy,c=-t.dx,l=t.x,u=t.y;if(0!=(t.flags&bK.PT_LEFT)){var h=this._chooseBevel(t.flags&bK.PT_INNERBEVEL,e,t,n),f=h[0],_=h[1],p=h[2],d=h[3],m=S0(-a,-o),v=S0(-c,-s);v>m&&(v-=2*p0),this._vSet(f,_,1),this._vSet(l-o*i,t.y-a*i,-1);for(var g=w0(v0((m-v)/p0)*r,2,r),y=0;y<g;y++){var x=m+y/(g-1)*(v-m),S=l+y0(x)*i,T=u+x0(x)*i;this._vSet(l,u,0),this._vSet(S,T,-1)}this._vSet(p,d,1),this._vSet(l-s*i,u-c*i,-1)}else{var b=this._chooseBevel(t.flags&bK.PT_INNERBEVEL,e,t,-i),E=b[0],C=b[1],A=b[2],w=b[3],P=S0(a,o),R=S0(c,s);R<P&&(R+=2*p0),this._vSet(l+o*i,u+a*i,1),this._vSet(E,C,-1);for(var I=w0(v0((R-P)/p0)*r,2,r),D=0;D<I;D++){var O=P+D/(I-1)*(R-P),M=l+y0(O)*n,N=u+x0(O)*n;this._vSet(M,N,1),this._vSet(l,u,0)}this._vSet(l+s*i,u+c*i,1),this._vSet(A,w,-1)}},_bevelJoin:function(e,t,n,i){var r=0,o=0,a=0,s=0,c=0,l=0,u=0,h=0,f=e.dy,_=-e.dx,p=t.dy,d=-t.dx;if(t.flags&bK.PT_LEFT){var m=this._chooseBevel(t.flags&bK.PT_INNERBEVEL,e,t,n);c=m[0],l=m[1],u=m[2],h=m[3],this._vSet(c,l,1),this._vSet(t.x-f*i,t.y-_*i,-1),this._vSet(u,h,1),this._vSet(t.x-p*i,t.y-d*i,-1)}else{var v=this._chooseBevel(t.flags&bK.PT_INNERBEVEL,e,t,-i);r=v[0],o=v[1],a=v[2],s=v[3],this._vSet(t.x+f*n,t.y+_*n,1),this._vSet(r,o,-1),this._vSet(t.x+p*n,t.y+d*n,1),this._vSet(a,s,-1)}},_vSet:function(e,t,n){if(void 0===n&&(n=0),T0){var i=T0,r=8*i.vertexStart,o=i.vData;o[r++]=e,o[r++]=t,o[r++]=0,Pn.toArray(o,E0,r),r+=4,o[r++]=n,i.vertexStart++}}},R0=e("graphicsAssembler",{getAssembler:function(){return P0}});BQ.Assembler=R0;var I0=function(){this.char="",this.valid=!0,this.x=0,this.y=0,this.line=0,this.hash=""},D0=new ri,O0=null,M0=null,N0=[],L0=[],B0=[],F0=[],z0=new ni,U0=new ni,k0=new Kn,G0=null,H0=0,V0=0,W0=0,j0=0,q0=0,X0=1,Y0=null,K0="",Q0=0,Z0=0,J0=0,$0=0,e1=0,t1=0,n1=0,i1=!1,r1=0,o1=0,a1=0,s1={updateRenderData:function(e){e.renderData&&O0!==e&&(e.renderData.vertDirty&&(M0=(O0=e).node._uiProps.uiTransformComp,this._updateFontFamily(e),this._updateProperties(e),this._updateLabelInfo(e),this._updateContent(),O0.actualFontSize=Q0,M0.setContentSize(U0),this.updateUVs(e),O0.renderData.vertDirty=!1,O0.markForUpdateRenderData(!1),O0=null,this._resetProperties()),e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame))},updateUVs:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.vertexCount,r=t.data,o=3,a=0;a<i;a++){var s=r[a];n[o]=s.u,n[o+1]=s.v,o+=9}},_updateFontScale:function(){X0=Q0/Z0},_updateFontFamily:function(e){var t=e.font;Y0=t.spriteFrame,G0=t.fntConfig,Xq.fontAtlas=t.fontDefDictionary,Qj.packToDynamicAtlas(e,Y0)},_updateLabelInfo:function(){Xq.hash="",Xq.margin=0},_updateProperties:function(e){K0=e.string.toString(),Q0=e.fontSize,Z0=G0?G0.fontSize:e.fontSize,J0=e.horizontalAlign,$0=e.verticalAlign,e1=e.spacingX,n1=e.overflow,t1=e._lineHeight;var t=M0.contentSize;U0.width=t.width,U0.height=t.height,n1===hK.NONE?(i1=!1,U0.width+=2*Xq.margin,U0.height+=2*Xq.margin):n1===hK.RESIZE_HEIGHT?(i1=!0,U0.height+=2*Xq.margin):i1=e.enableWrapText,Xq.lineHeight=t1,Xq.fontSize=Q0,this._setupBMFontOverflowMetrics()},_resetProperties:function(){G0=null,Y0=null,Xq.hash="",Xq.margin=0},_updateContent:function(){this._updateFontScale(),this._computeHorizontalKerningForText(),this._alignText()},_computeHorizontalKerningForText:function(){for(var e=K0,t=e.length,n=G0.kerningDict,i=N0,r=-1,o=0;o<t;++o){var a=e.charCodeAt(o),s=n[r<<16|65535&a]||0;i[o]=o<t-1?s:0,r=a}},_multilineTextWrap:function(e){for(var t=K0.length,n=0,i=0,r=0,o=0,a=0,s=0,c=0,l=null,u=0;u<t;){var h=K0.charAt(u);if("\n"!==h){for(var f=e(K0,u,t),_=s,p=c,d=a,m=i,v=!1,g=0;g<f;++g){var y=u+g;if("\r"!==(h=K0.charAt(y)))if(l=Xq.fontAtlas.getLetterDefinitionForChar(h,Xq)){var x=m+l.offsetX*X0-Xq.margin;if(i1&&a1>0&&i>0&&x+l.w*X0>a1&&!Bq(h)){B0.push(a),a=0,n++,i=0,r-=t1*this._getFontScale()+0,v=!0;break}k0.x=x,k0.y=r-l.offsetY*X0,this._recordLetterInfo(k0,h,y,n),y+1<N0.length&&y<t-1&&(m+=N0[y+1]),m+=l.xAdvance*X0+e1,d=k0.x+l.w*X0,_<k0.y&&(_=k0.y),p>k0.y-l.h*X0&&(p=k0.y-l.h*X0)}else this._recordPlaceholderInfo(y,h),console.log("Can't find letter definition in texture atlas "+G0.atlasName+" for letter:"+h);else this._recordPlaceholderInfo(y,h)}v||(i=m,s<_&&(s=_),c>p&&(c=p),o<(a=d)&&(o=a),u+=f)}else B0.push(a),a=0,n++,i=0,r-=t1*this._getFontScale()+0,this._recordPlaceholderInfo(u,h),u++}return B0.push(a),V0=(H0=n+1)*t1*this._getFontScale(),H0>1&&(V0+=0*(H0-1)),U0.width=r1,U0.height=o1,r1<=0&&(U0.width=parseFloat(o.toFixed(2))+2*Xq.margin),o1<=0&&(U0.height=parseFloat(V0.toFixed(2))+2*Xq.margin),j0=U0.height,q0=0,s>0&&(j0=U0.height+s),c<-V0&&(q0=V0+c),!0},_getFirstCharLen:function(){return 1},_getFontScale:function(){return n1===hK.SHRINK?X0:1},_getFirstWordLen:function(e,t,n){var i=e.charAt(t);if(Lq(i)||"\n"===i||Bq(i))return 1;var r=1,o=Xq.fontAtlas.getLetterDefinitionForChar(i,Xq);if(!o)return r;for(var a=o.xAdvance*X0+e1,s=t+1;s<n&&(i=e.charAt(s),o=Xq.fontAtlas.getLetterDefinitionForChar(i,Xq));++s){if(a+o.offsetX*X0+o.w*X0>a1&&!Bq(i)&&a1>0)return r;if(a+=o.xAdvance*X0+e1,"\n"===i||Bq(i)||Lq(i))break;r++}return r},_multilineTextWrapByWord:function(){return this._multilineTextWrap(this._getFirstWordLen)},_multilineTextWrapByChar:function(){return this._multilineTextWrap(this._getFirstCharLen)},_recordPlaceholderInfo:function(e,t){if(e>=L0.length){var n=new I0;L0.push(n)}L0[e].char=t,L0[e].hash=""+t.charCodeAt(0)+Xq.hash,L0[e].valid=!1},_recordLetterInfo:function(e,t,n,i){if(n>=L0.length){var r=new I0;L0.push(r)}var o=""+t.charCodeAt(0)+Xq.hash;L0[n].line=i,L0[n].char=t,L0[n].hash=o,L0[n].valid=Xq.fontAtlas.getLetter(o).valid,L0[n].x=e.x,L0[n].y=e.y},_alignText:function(){V0=0,B0.length=0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),n1===hK.SHRINK&&Q0>0&&this._isVerticalClamp()&&this._shrinkLabelToContentSize(this._isVerticalClamp),this._updateQuads()||n1===hK.SHRINK&&this._shrinkLabelToContentSize(this._isHorizontalClamp)},_scaleFontSizeDown:function(e){var t=!0;e||(e=.1,t=!1),Q0=e,t&&this._updateContent()},_shrinkLabelToContentSize:function(e){for(var t=0,n=0|Q0,i=0;t<n;){var r=i=t+n+1>>1;if(r<=0)break;X0=r/Z0,this._multilineTextWrapByWord(),this._computeAlignmentOffset(),e()?n=i-1:t=i}t>=0&&this._scaleFontSizeDown(t)},_isVerticalClamp:function(){return V0>U0.height},_isHorizontalClamp:function(){for(var e=!1,t=0,n=K0.length;t<n;++t){var i=L0[t];if(i.valid){var r=Xq.fontAtlas.getLetterDefinitionForChar(i.char,Xq);if(!r)continue;var o=i.x+r.w*X0,a=i.line;if(r1>0)if(i1){if(B0[a]>U0.width&&(o>U0.width||o<0)){e=!0;break}}else if(o>U0.width){e=!0;break}}}return e},_isHorizontalClamped:function(e,t){var n=B0[t],i=e>U0.width||e<0;return i1?n>U0.width&&i:i},_updateQuads:function(){if(!O0)return!1;var e=Y0?Y0.texture:Xq.fontAtlas.getTexture(),t=O0.renderData;t.dataLength=0,t.resize(0,0);for(var n=M0.anchorPoint,i=U0,r=n.x*i.width,o=n.y*i.height,a=!0,s=0,c=K0.length;s<c;++s){var l=L0[s];if(l.valid){var u=Xq.fontAtlas.getLetter(l.hash);if(u){D0.height=u.h,D0.width=u.w,D0.x=u.u,D0.y=u.v;var h=l.y+W0;if(o1>0){if(h>j0){var f=h-j0;D0.y+=f,D0.height-=f,h-=f}h-u.h*X0<q0&&n1===hK.CLAMP&&(D0.height=h<q0?0:(h-q0)/X0)}var _=l.line,p=l.x+u.w/2*X0+F0[_];if(r1>0&&this._isHorizontalClamped(p,_))if(n1===hK.CLAMP)D0.width=0;else if(n1===hK.SHRINK){if(U0.width>u.w){a=!1;break}D0.width=0}if(D0.height>0&&D0.width>0){var d=this._determineRect(),m=l.x+F0[l.line];this.appendQuad(O0,e,D0,d,m-r,h-o,X0)}}else console.warn("Can't find letter in this bitmap-font")}}return a},appendQuad:function(){},_determineRect:function(){var e=Y0.isRotated(),t=Y0.getOriginalSize(),n=Y0.getRect(),i=Y0.getOffset(),r=i.x+(t.width-n.width)/2,o=i.y-(t.height-n.height)/2;if(e){var a=D0.x;D0.x=n.x+n.height-D0.y-D0.height-o,D0.y=a+n.y-r,D0.y<0&&(D0.height+=o)}else D0.x+=n.x-r,D0.y+=n.y+o;return e},_computeAlignmentOffset:function(){switch(F0.length=0,J0){case lK.LEFT:for(var e=0;e<H0;++e)F0.push(0);break;case lK.CENTER:for(var t=0,n=B0.length;t<n;t++)F0.push((U0.width-B0[t])/2);break;case lK.RIGHT:for(var i=0,r=B0.length;i<r;i++)F0.push(U0.width-B0[i])}if(W0=U0.height,$0!==uK.TOP){var o=U0.height-V0+t1*this._getFontScale()-Z0*X0;$0===uK.BOTTOM?W0-=o:W0-=o/2}},_setupBMFontOverflowMetrics:function(){var e=U0.width,t=U0.height;n1===hK.RESIZE_HEIGHT&&(t=0),n1===hK.NONE&&(e=0,t=0),r1=e,o1=t,z0.width=e,z0.height=t,a1=e}},c1=new Pn(255,255,255,255),l1={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){var t=e.node;c1.set(e.color),c1.a=255*t._uiProps.opacity,Vj(t,0,e.renderData,c1)},appendQuad:function(e,t,n,i,r,o,a){var s=e.renderData;if(s){var c=s.dataLength;s.dataLength+=4,s.resize(s.dataLength,s.dataLength/2*3);var l=s.data,u=t.width,h=t.height,f=n.width,_=n.height,p=0,d=0,m=0,v=0;i?(p=n.x/u,v=(n.x+_)/u,d=(n.y+f)/h,m=n.y/h,l[c].u=p,l[c].v=m,l[c+1].u=p,l[c+1].v=d,l[c+2].u=v,l[c+2].v=m,l[c+3].u=v,l[c+3].v=d):(p=n.x/u,v=(n.x+f)/u,d=(n.y+_)/h,m=n.y/h,l[c].u=p,l[c].v=d,l[c+1].u=v,l[c+1].v=d,l[c+2].u=p,l[c+2].v=m,l[c+3].u=v,l[c+3].v=m),l[c].x=r,l[c].y=o-_*a,l[c+1].x=r+f*a,l[c+1].y=o-_*a,l[c+2].x=r,l[c+2].y=o,l[c+3].x=r+f*a,l[c+3].y=o}},updateColor:function(){}};Ue(l1,s1);var u1=null,h1=ke(s1,{getAssemblerData:function(){return u1||(u1=new qq(1024,1024)),u1.getTexture()},_updateFontFamily:function(e){Xq.fontAtlas=u1,Xq.fontFamily=this._getFontFamily(e);var t=e.getComponent(eJ);t&&t.enabled?(Xq.isOutlined=!0,Xq.margin=t.width,Xq.out=t.color.clone(),Xq.out.a=t.color.a*e.color.a/255):(Xq.isOutlined=!1,Xq.margin=0)},_getFontFamily:function(e){var t="Arial";return e.useSystemFont?t=e.fontFamily||"Arial":e.font&&(t=e.font._nativeAsset||"Arial"),t},_updateLabelInfo:function(e){Xq.fontDesc=this._getFontDesc(),Xq.color=e.color,Xq.hash=function(e){var t=e.color.toHEX(),n="";return e.isOutlined&&e.margin>0&&(n=n+e.margin+e.out.toHEX()),""+e.fontSize+e.fontFamily+t+n}(Xq)},_getFontDesc:function(){return Xq.fontSize.toString()+"px "+Xq.fontFamily},_computeHorizontalKerningForText:function(){},_determineRect:function(){return!1}}),f1=new Pn(255,255,255,255),_1={createData:function(e){return e.requestRenderData()},fillBuffers:function(e){if(e.renderData){var t=e.node;f1.a=255*t._uiProps.opacity,Vj(t,0,e.renderData,f1)}},updateColor:function(){},appendQuad:l1.appendQuad};Ue(_1,h1);var p1=pK.Overflow,d1=(1/255).toFixed(3),m1=null,v1=null,g1=null,y1="",x1="",S1=0,T1=0,b1=[],E1=new ni,C1=0,A1=0,w1=0,P1=new Pn,R1="",I1=p1.NONE,D1=!1,O1=null,M1=Pn.BLACK.clone(),N1=null,L1=Pn.BLACK.clone(),B1=new ri,F1=ni.ZERO.clone(),z1=ni.ZERO.clone(),U1=Kn.ZERO.clone(),k1=Kn.ZERO.clone(),G1=0,H1=0,V1=!1,W1=!1,j1=!1,q1=["left","center","right"],X1={getAssemblerData:function(){return pK._canvasPool.get()},resetAssemblerData:function(e){e&&pK._canvasPool.put(e)},updateRenderData:function(e){if(e.renderData){if(e.renderData.vertDirty){var t=e.node._uiProps.uiTransformComp;this._updateFontFamily(e),this._updateProperties(e,t),this._calculateLabelFont(),this._updateLabelDimensions(),this._updateTexture(e),this._calDynamicAtlas(e),e.actualFontSize=S1,t.setContentSize(E1),this.updateVertexData(e),this.updateUVs(e),e.markForUpdateRenderData(!1),m1=null,v1=null,g1=null}e.spriteFrame&&e.renderData.updateRenderData(e,e.spriteFrame)}},updateVertexData:function(){},updateUVs:function(){},_updateFontFamily:function(e){R1=e.useSystemFont?e.fontFamily||"Arial":e.font&&e.font._nativeAsset||"Arial"},_updateProperties:function(e,t){var n=e.assemblerData;n&&(m1=n.context,v1=n.canvas,g1=e.spriteFrame,x1=e.string.toString(),S1=e.fontSize,T1=S1,I1=e.overflow,z1.width=E1.width=t.width,z1.height=E1.height=t.height,H1=e.underlineHeight,C1=e.lineHeight,A1=e.horizontalAlign,w1=e.verticalAlign,P1=e.color,e.node._uiProps.opacity,V1=e.isBold,W1=e.isItalic,j1=e.isUnderline,D1=I1!==p1.NONE&&(I1===p1.RESIZE_HEIGHT||e.enableWrapText),(O1=(O1=eJ&&e.getComponent(eJ))&&O1.enabled&&O1.width>0?O1:null)&&M1.set(O1.color),(N1=(N1=W$&&e.getComponent(W$))&&N1.enabled?N1:null)&&L1.set(N1.color),this._updatePaddingRect())},_updatePaddingRect:function(){var e=0,t=0,n=0,i=0,r=0;if(F1.width=F1.height=0,O1&&(e=t=n=i=r=O1.width,F1.width=F1.height=2*r),N1){var o=N1.blur+r,a=N1.offset.x,s=N1.offset.y;n=Math.max(n,-a+o),i=Math.max(i,a+o),e=Math.max(e,s+o),t=Math.max(t,-s+o)}if(W1){var c=T1*Math.tan(.20943951);i+=c,F1.width+=c}B1.x=n,B1.y=e,B1.width=n+i,B1.height=e+t},_calculateFillTextStartPosition:function(){var e=0;A1===lK.RIGHT?e=E1.width-B1.width:A1===lK.CENTER&&(e=(E1.width-B1.width)/2);var t=this._getLineHeight()*(b1.length-1),n=S1*(1-Cq/2);if(w1!==uK.TOP){var i=t+B1.height+S1-E1.height;w1===uK.BOTTOM?n-=i+=Cq/2*S1:n-=i/2}n+=0*S1,U1.set(e+B1.x,n+B1.y)},_updateTexture:function(e){if(m1&&v1){m1.clearRect(0,0,v1.width,v1.height),m1.font=y1,this._calculateFillTextStartPosition();var t=this._getLineHeight();m1.lineJoin="round",O1?(m1.fillStyle="rgba("+M1.r+", "+M1.g+", "+M1.b+", "+d1+")",m1.fillRect(0,0,v1.width,v1.height)):e._srcBlendFactor===Ii.SRC_ALPHA&&(m1.fillStyle="rgba("+P1.r+", "+P1.g+", "+P1.b+", "+d1+")",m1.fillRect(0,0,v1.width,v1.height)),m1.fillStyle="rgb("+P1.r+", "+P1.g+", "+P1.b+")";var n=U1.x,i=0;this._drawTextEffect(U1,t);for(var r=0;r<b1.length;++r)i=U1.y+r*t,O1&&m1.strokeText(b1[r],n,i),m1.fillText(b1[r],n,i);N1&&(m1.shadowColor="transparent"),this._uploadTexture(e)}},_uploadTexture:function(e){if(e.cacheMode===pK.CacheMode.BITMAP){var t=e.ttfSpriteFrame;Qj.deleteAtlasSpriteFrame(t),t._resetDynamicAtlasFrame()}var n;g1&&v1&&(n=g1 instanceof nq?g1.texture:g1,0!==v1.width&&0!==v1.height&&(n.reset({width:v1.width,height:v1.height,mipmapLevel:1}),n.uploadData(v1),g1 instanceof nq&&(g1.rect=new ri(0,0,v1.width,v1.height),g1._calculateUV()),e.renderData&&(e.renderData.textureDirty=!0),u.director.root&&u.director.root.batcher2D&&u.director.root.batcher2D._releaseDescriptorSetCache(n.getHash())))},_calDynamicAtlas:function(e){if(!(e.cacheMode!==pK.CacheMode.BITMAP||!v1||v1.width<=0||v1.height<=0)){var t=e.ttfSpriteFrame;Qj.packToDynamicAtlas(e,t)}},_setupOutline:function(){m1.strokeStyle="rgba("+M1.r+", "+M1.g+", "+M1.b+", "+M1.a/255+")",m1.lineWidth=2*O1.width},_setupShadow:function(){m1.shadowColor="rgba("+L1.r+", "+L1.g+", "+L1.b+", "+L1.a/255+")",m1.shadowBlur=N1.blur,m1.shadowOffsetX=N1.offset.x,m1.shadowOffsetY=-N1.offset.y},_drawTextEffect:function(e,t){if(N1||O1||j1){var n=b1.length>1&&N1,i=this._measureText(m1,y1),r=0,o=0;N1&&this._setupShadow(),O1&&this._setupOutline();for(var a=0;a<b1.length;++a)r=e.x,o=e.y+a*t,n&&(O1&&m1.strokeText(b1[a],r,o),m1.fillText(b1[a],r,o)),j1&&(G1=i(b1[a]),A1===lK.RIGHT?k1.x=e.x-G1:A1===lK.CENTER?k1.x=e.x-G1/2:k1.x=e.x,k1.y=o+T1/8,m1.fillRect(k1.x,k1.y,G1,H1));n&&(m1.shadowColor="transparent")}},_updateLabelDimensions:function(){E1.width=Math.min(E1.width,2048),E1.height=Math.min(E1.height,2048);var e=!1;v1.width!==E1.width&&(v1.width=E1.width,e=!0),v1.height!==E1.height&&(v1.height=E1.height,e=!0),e&&(m1.font=y1),m1.textAlign=q1[A1],m1.textBaseline="alphabetic"},_getFontDesc:function(){var e=S1.toString()+"px ";return e+=R1,V1&&(e="bold "+e),W1&&(e="italic "+e),e},_getLineHeight:function(){return 0|(0===C1?S1:C1*S1/T1)},_calculateParagraphLength:function(e,t){for(var n,i=[],r=se(e);!(n=r()).done;){var o=Fq(t,n.value,y1);i.push(o)}return i},_measureText:function(e,t){return function(n){return Fq(e,n,t)}},_calculateShrinkFont:function(e){if(m1){var t=this._calculateParagraphLength(e,m1),n=0,i=0,r=0;if(D1){var o=z1.width,a=z1.height;if(o<0||a<0)return;i=a+1;for(var s=0,c=0|S1+1,l=0;s<c;){if((l=s+c+1>>1)<=0){R(4003);break}S1=l,y1=this._getFontDesc(),m1.font=y1;var u=this._getLineHeight();for(i=0,n=0;n<e.length;++n){var h=Fq(m1,e[n],y1);i+=Uq(e[n],h,o,this._measureText(m1,y1)).length*u}i>a?c=l-1:s=l}0===s?R(4003):(S1=s,y1=this._getFontDesc(),m1.font=y1)}else{for(i=e.length*this._getLineHeight(),n=0;n<e.length;++n)r<t[n]&&(r=t[n]);var f=(E1.width-B1.width)/r,_=E1.height/i;S1=T1*Math.min(1,f,_)|0,y1=this._getFontDesc(),m1.font=y1}}},_calculateWrapText:function(e){if(D1&&m1){b1=[];for(var t=z1.width,n=0;n<e.length;++n){var i=Fq(m1,e[n],y1),r=Uq(e[n],i,t,this._measureText(m1,y1));b1=b1.concat(r)}}},_calculateLabelFont:function(){if(m1){var e=x1.split("\n");switch(b1=e,y1=this._getFontDesc(),m1.font=y1,I1){case p1.NONE:for(var t=0,n=0,i=0;i<e.length;++i){var r=Fq(m1,e[i],y1);t=t>r?t:r}n=(b1.length+Cq)*this._getLineHeight();var o=parseFloat(t.toFixed(2)),a=parseFloat(n.toFixed(2));E1.width=o+B1.width,E1.height=a+B1.height,z1.width=o+F1.width,z1.height=a+F1.height;break;case p1.SHRINK:this._calculateShrinkFont(e),this._calculateWrapText(e);break;case p1.CLAMP:this._calculateWrapText(e);break;case p1.RESIZE_HEIGHT:this._calculateWrapText(e);var s=(b1.length+Cq)*this._getLineHeight();E1.height=s+B1.height,z1.height=s+F1.height}}}},Y1=Pn.WHITE.clone(),K1={createData:function(e){var t=e.requestRenderData();t.dataLength=2,t.resize(4,6);var n=t.chunk.vb;n[3]=n[21]=n[22]=n[31]=0,n[4]=n[12]=n[13]=n[30]=1;for(var i=5,r=0;r<4;r++)Pn.toArray(n,Y1,i),i+=9;return t},fillBuffers:function(e){var t=e.renderData.chunk,n=e.renderData.data,i=e.node,r=t.vb,o=n[0],a=n[1];i.updateWorldTransform();var s=i._pos,c=i._rot,l=i._scale,u=o.x*l.x,h=a.x*l.x,f=o.y*l.y,_=a.y*l.y,p=c.x,d=c.y,m=c.z,v=c.w,g=p*d,y=m*v,x=p*p-d*d,S=v*v-m*m,T=S+x,b=2*(g-y),E=S-x,C=2*(g+y),A=s.x,w=s.y;r[0]=T*u+b*f+A,r[1]=E*f+C*u+w,r[9]=T*h+b*f+A,r[10]=E*f+C*h+w,r[18]=T*u+b*_+A,r[19]=E*_+C*u+w,r[27]=T*h+b*_+A,r[28]=E*_+C*h+w;var P=t.bufferId,R=t.vertexOffset,I=t.vertexAccessor.getMeshBuffer(t.bufferId),D=t.vertexAccessor.getIndexBuffer(P),O=I.indexOffset;D[O++]=R,D[O++]=R+1,D[O++]=R+2,D[O++]=R+2,D[O++]=R+1,D[O++]=R+3,I.indexOffset+=6},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=t.data;s[0].x=-o,s[0].y=-a,s[1].x=i-o,s[1].y=r-a}},updateUVs:function(e){var t=e.renderData;if(t&&e.ttfSpriteFrame){var n=t.chunk.vb,i=e.ttfSpriteFrame.uv;n[3]=i[0],n[4]=i[1],n[12]=i[2],n[13]=i[3],n[21]=i[4],n[22]=i[5],n[30]=i[6],n[31]=i[7]}},updateColor:function(){}};Ue(K1,X1);var Q1=e("labelAssembler",{getAssembler:function(e){var t=K1;return e.font instanceof bq?t=l1:e.cacheMode===pK.CacheMode.CHAR&&(t=_1),t}});pK.Assembler=Q1;var Z1=nJ.FillType,J1=new jn,$1=new In,e2={updateRenderData:function(e){var t=e.spriteFrame;Qj.packToDynamicAtlas(e,t);var n=e.renderData;if(n&&t){if(n.updateRenderData(e,t),!n.vertDirty)return;var i=e.fillStart,r=e.fillRange;r<0&&(i+=r,r=-r),r=(r=(r=i+r)>1?1:r)<0?0:r;var o=(i=(i=i>1?1:i)<0?0:i)+(r=(r-=i)<0?0:r);o=o>1?1:o,this.updateUVs(e,i,o),this.updateVertexData(e,i,o)}},updateUVs:function(e,t,n){var i=e.spriteFrame,r=e.renderData.chunk.vb,o=i.width,a=i.height,s=i.rect,c=0,l=0,u=0,h=0,f=0,_=0,p=0,d=0,m=0,v=0;switch(i.isRotated()?(c=s.x/o,l=(s.y+s.width)/a,u=f=c,p=m=(s.x+s.height)/o,_=v=l,h=d=s.y/a):(c=s.x/o,l=(s.y+s.height)/a,u=p=c,f=m=(s.x+s.width)/o,h=_=l,d=v=s.y/a),e.fillType){case Z1.HORIZONTAL:r[3]=u+(f-u)*t,r[4]=h+(_-h)*t,r[12]=u+(f-u)*n,r[13]=h+(_-h)*n,r[21]=p+(m-p)*t,r[22]=d+(v-d)*t,r[30]=p+(m-p)*n,r[31]=d+(v-d)*n;break;case Z1.VERTICAL:r[3]=u+(p-u)*t,r[4]=h+(d-h)*t,r[12]=f+(m-f)*t,r[13]=_+(v-_)*t,r[21]=u+(p-u)*n,r[22]=h+(d-h)*n,r[30]=f+(m-f)*n,r[31]=_+(v-_)*n;break;default:M(2626)}},updateVertexData:function(e,t,n){var i=e.renderData.data,r=e.node._uiProps.uiTransformComp,o=r.width,a=r.height,s=r.anchorX*o,c=r.anchorY*a,l=-s,u=-c,h=o-s,f=a-c,_=0;switch(e.fillType){case Z1.HORIZONTAL:_=l+(h-l)*n,l+=(h-l)*t,h=_;break;case Z1.VERTICAL:_=u+(f-u)*n,u+=(f-u)*t,f=_;break;default:M(2626)}i[0].x=l,i[0].y=u,i[1].x=h,i[1].y=u,i[2].x=l,i[2].y=f,i[3].x=h,i[3].y=f},createData:function(e){var t=e.requestRenderData();t.dataLength=4,t.resize(4,6);for(var n,i=se(t.data);!(n=i()).done;)n.value.z=0;return t},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(J1);for(var n=e.renderData.floatStride,i=e.renderData.data,r=t.vb,o=0,a=0;a<4;a++){var s=i[a];In.transformMat4($1,s,J1),r[o=a*n]=$1.x,r[o+1]=$1.y,r[o+2]=$1.z}},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<4;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},t2=2*Math.PI,n2=1e-6,i2=new jn,r2=new In,o2=[new Kn,new Kn,new Kn,new Kn],a2=new Array(4),s2=new Array(8),c2=[new Kn,new Kn,new Kn,new Kn],l2=[new Kn,new Kn,new Kn,new Kn],u2=new Kn,h2=[new Kn,new Kn,new Kn,new Kn];function f2(e,t,n,i,r,o,a){var s=Math.sin(o);s=Math.abs(s)>n2?s:0;var c=Math.cos(o),l=0,u=0;if(0!==(c=Math.abs(c)>n2?c:0)){if(l=s/c,(e-r.x)*c>0){var h=r.y+l*(e-r.x);a[0].x=e,a[0].y=h}if((t-r.x)*c>0){var f=r.y+l*(t-r.x);a[2].x=t,a[2].y=f}}if(0!==s){if(u=c/s,(i-r.y)*s>0){var _=r.x+u*(i-r.y);a[3].x=_,a[3].y=i}if((n-r.y)*s>0){var p=r.x+u*(n-r.y);a[1].x=p,a[1].y=n}}}function _2(e,t){var n=t.x-e.x,i=t.y-e.y;if(0===n&&0===i)return 0;if(0===n)return i>0?.5*Math.PI:1.5*Math.PI;var r=Math.atan(i/n);return n<0&&(r+=Math.PI),r}function p2(e,t,n,i,r){var o=a2,a=o[0],s=o[1],c=o[2],l=o[3];e[t].x=n.x,e[t].y=n.y,e[t+1].x=i.x,e[t+1].y=i.y,e[t+2].x=r.x,e[t+2].y=r.y,d2((n.x-a)/(c-a),(n.y-s)/(l-s),e,t),d2((i.x-a)/(c-a),(i.y-s)/(l-s),e,t+1),d2((r.x-a)/(c-a),(r.y-s)/(l-s),e,t+2)}function d2(e,t,n,i){var r=s2,o=r[0]+(r[2]-r[0])*e,a=r[4]+(r[6]-r[4])*e,s=r[1]+(r[3]-r[1])*e,c=r[5]+(r[7]-r[5])*e,l=n[i];l.u=o+(a-o)*t,l.v=s+(c-s)*t}for(var m2={useModel:!1,createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.spriteFrame;Qj.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;if(n&&t){if(!n.vertDirty)return;var i=n.data,r=e.fillStart,o=e.fillRange;for(o<0&&(r+=o,o=-o);r>=1;)r-=1;for(;r<0;)r+=1;var a=(r*=t2)+(o*=t2);!function(e){var t=e.node._uiProps.uiTransformComp,n=t.width,i=t.height,r=t.anchorX*n,o=t.anchorY*i,a=-r,s=-o,c=n-r,l=i-o,u=a2;u[0]=a,u[1]=s,u[2]=c,u[3]=l;var h=e.fillCenter,f=u2.x=Math.min(Math.max(0,h.x),1)*(c-a)+a,_=u2.y=Math.min(Math.max(0,h.y),1)*(l-s)+s;o2[0].x=o2[3].x=a,o2[1].x=o2[2].x=c,o2[0].y=o2[1].y=s,o2[2].y=o2[3].y=l;for(var p,d=se(h2);!(p=d()).done;){var m=p.value;Kn.set(m,0,0)}f!==u[0]&&Kn.set(h2[0],3,0),f!==u[2]&&Kn.set(h2[2],1,2),_!==u[1]&&Kn.set(h2[1],0,1),_!==u[3]&&Kn.set(h2[3],2,3)}(e),function(e){var t=e.width,n=e.height,i=e.getRect(),r=0,o=0,a=0,s=0,c=s2;e.isRotated()?(r=i.x/t,o=(i.x+i.height)/t,a=i.y/n,s=(i.y+i.width)/n,c[0]=c[2]=r,c[4]=c[6]=o,c[3]=c[7]=s,c[1]=c[5]=a):(r=i.x/t,o=(i.x+i.width)/t,a=i.y/n,s=(i.y+i.height)/n,c[0]=c[4]=r,c[2]=c[6]=o,c[1]=c[3]=s,c[5]=c[7]=a)}(t),f2(a2[0],a2[2],a2[1],a2[3],u2,r,c2),f2(a2[0],a2[2],a2[1],a2[3],u2,r+o,l2);for(var s=0,c=0;c<4;++c){var l=h2[c];if(l)if(o>=t2)n.dataLength=s+3,p2(i,s,u2,o2[l.x],o2[l.y]),s+=3;else{var u=_2(u2,o2[l.x]),h=_2(u2,o2[l.y]);h<u&&(h+=t2),u-=t2,h-=t2;for(var f=0;f<3;++f)u>=a||(u>=r?(n.dataLength=s+3,p2(i,s,u2,o2[l.x],h>=a?l2[c]:o2[l.y]),s+=3):h>r&&(h<=a?(n.dataLength=s+3,p2(i,s,u2,c2[c],o2[l.y]),s+=3):(n.dataLength=s+3,p2(i,s,u2,c2[c],l2[c]),s+=3))),u+=t2,h+=t2}}n.resize(s,s),n.updateRenderData(e,t)}},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l++)s[c+l]=o+l;a.indexOffset+=n.indexCount,a.setDirty()},updateWorldVertexAndUVData:function(e,t){e.node.getWorldMatrix(i2);for(var n=e.renderData,i=n.floatStride,r=e.renderData.data,o=t.vb,a=n.vertexCount,s=0,c=0;c<a;c++){var l=r[c];In.set(r2,l.x,l.y,0),In.transformMat4(r2,r2,i2),o[s+0]=r2.x,o[s+1]=r2.y,o[s+2]=r2.z,o[s+3]=l.u,o[s+4]=l.v,s+=i}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},v2=[],g2=0;g2<4;g2++)v2.push(new In);for(var y2={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){var t=e.spriteFrame;Qj.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateWorldVerts:function(e,t){var n=e.renderData,i=t.vb,r=n.data,o=e.node,a=r[0],s=r[1],c=o.worldMatrix,l=c.m00,u=c.m01,h=c.m04,f=c.m05,_=1===l&&0===u&&0===h&&1===f,p=c.m12,d=c.m13,m=a.x,v=s.x,g=a.y,y=s.y;if(_){var x=m+p,S=v+p,T=g+d,b=y+d;i[0]=x,i[1]=T,i[9]=S,i[10]=T,i[18]=x,i[19]=b,i[27]=S,i[28]=b}else{var E=l*m,C=l*v,A=u*m,w=u*v,P=h*g+p,R=h*y+p,I=f*g+d,D=f*y+d;i[0]=E+P,i[1]=A+I,i[9]=C+P,i[10]=w+I,i[18]=E+R,i[19]=A+D,i[27]=C+R,i[28]=w+D}},fillBuffers:function(e){if(null!==e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVerts(e,n),t.vertDirty=!1);var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(i),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset;a[s++]=r,a[s++]=r+1,a[s++]=r+2,a[s++]=r+2,a[s++]=r+1,a[s++]=r+3,o.indexOffset+=6}},updateVertexData:function(e){var t=e.renderData;if(t){var n=e.node._uiProps.uiTransformComp,i=t.data,r=n.width,o=n.height,a=n.anchorX*r,s=n.anchorY*o,c=0,l=0,u=0,h=0;if(e.trim)c=-a,l=-s,u=r-a,h=o-s;else{var f=e.spriteFrame,_=f.getOriginalSize(),p=f.getRect(),d=_.width,m=_.height,v=p.width,g=p.height,y=f.getOffset(),x=r/d,S=o/m,T=y.x+(d-v)/2,b=y.x-(d-v)/2;c=T*x-a,l=(y.y+(m-g)/2)*S-s,u=r+b*x-a,h=o+(y.y-(m-g)/2)*S-s}i[0].x=c,i[0].y=l,i[1].x=u,i[1].y=h,t.vertDirty=!0}},updateUVs:function(e){if(e.spriteFrame){var t=e.renderData.chunk.vb,n=e.spriteFrame.uv;t[3]=n[0],t[4]=n[1],t[12]=n[2],t[13]=n[3],t[21]=n[4],t[22]=n[5],t[30]=n[6],t[31]=n[7]}},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=5,r=e.color,o=r.r/255,a=r.g/255,s=r.b/255,c=r.a/255,l=0;l<4;l++,i+=t.floatStride)n[i]=o,n[i+1]=a,n[i+2]=s,n[i+3]=c}},x2=new In,S2=new jn,T2={createData:function(e){var t=e.requestRenderData();return t.dataLength=4,t.resize(16,54),t},updateRenderData:function(e){var t=e.spriteFrame;Qj.packToDynamicAtlas(e,t),this.updateUVs(e);var n=e.renderData;n&&t&&(n.vertDirty&&this.updateVertexData(e),n.updateRenderData(e,t))},updateVertexData:function(e){var t=e.renderData.data,n=e.node._uiProps.uiTransformComp,i=n.width,r=n.height,o=n.anchorX*i,a=n.anchorY*r,s=e.spriteFrame,c=s.insetLeft,l=s.insetRight,u=s.insetTop,h=s.insetBottom,f=i-c-l,_=r-u-h,p=i/(c+l),d=r/(u+h);p=Number.isNaN(p)||p>1?1:p,d=Number.isNaN(d)||d>1?1:d,f=f<0?0:f,_=_<0?0:_,t[0].x=-o,t[0].y=-a,t[1].x=c*p-o,t[1].y=h*d-a,t[2].x=t[1].x+f,t[2].y=t[1].y+_,t[3].x=i-o,t[3].y=r-a},fillBuffers:function(e){var t=e.renderData,n=t.chunk;(e.node.hasChangedFlags||t.vertDirty)&&(this.updateWorldVertexData(e,n),t.vertDirty=!1);for(var i=n.bufferId,r=n.vertexOffset,o=n.vertexAccessor.getMeshBuffer(n.bufferId),a=n.vertexAccessor.getIndexBuffer(i),s=o.indexOffset,c=0;c<3;++c)for(var l=0;l<3;++l){var u=r+4*c+l;a[s++]=u,a[s++]=u+1,a[s++]=u+4,a[s++]=u+1,a[s++]=u+5,a[s++]=u+4}o.indexOffset=s},updateWorldVertexData:function(e,t){e.node.getWorldMatrix(S2);for(var n=e.renderData,i=n.floatStride,r=n.data,o=t.vb,a=0,s=0;s<4;++s)for(var c=r[s],l=0;l<4;++l){var u=r[l];In.set(x2,u.x,c.y,0),In.transformMat4(x2,x2,S2),a=(4*s+l)*i,o[a++]=x2.x,o[a++]=x2.y,o[a++]=x2.z}},updateUVs:function(e){if(e.spriteFrame)for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=e.spriteFrame.uvSliced,o=3,a=0;a<16;a++)n[o]=r[a].u,n[o+1]=r[a].v,o+=i},updateColor:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=5,o=e.color,a=o.r/255,s=o.g/255,c=o.b/255,l=e.node._uiProps.opacity,u=0;u<16;u++)n[r]=a,n[r+1]=s,n[r+2]=c,n[r+3]=l,r+=i}},b2=[],E2=0;E2<4;E2++)b2.push(new In);var C2=new jn,A2={createData:function(e){return e.requestRenderData()},updateRenderData:function(e){var t=e.renderData,n=e.spriteFrame;if(n&&t&&(t.updateRenderData(e,n),t.vertDirty)){var i=e.node._uiProps.uiTransformComp,r=Math.abs(i.width),o=Math.abs(i.height),a=n.getRect(),s=n.insetLeft,c=n.insetRight,l=a.width-s-c,u=n.insetTop,h=n.insetBottom,f=a.height-u-h,_=r-s-c,p=o-u-h;_=_>0?_:0,p=p>0?p:0;var d=0===l?_:_/l,m=0===f?p:p/f,v=Math.ceil(m+2),g=Math.ceil(d+2);t.dataLength=Math.max(8,v+1,g+1),this.updateVerts(e,_,p,v,g),t.resize(v*g*4,v*g*6)}},updateUVs:function(e){e.renderData.vertDirty=!0,e.markForUpdateRenderData()},fillBuffers:function(e){var t=e.node,n=e.renderData,i=n.chunk;(t.hasChangedFlags||n.vertDirty)&&(this.updateWorldVertexAndUVData(e,i),n.vertDirty=!1),this.updataColorLate(e);for(var r=i.bufferId,o=i.vertexOffset,a=i.vertexAccessor.getMeshBuffer(i.bufferId),s=i.vertexAccessor.getIndexBuffer(r),c=a.indexOffset,l=0;l<n.indexCount;l+=6)s[c++]=o,s[c++]=o+1,s[c++]=o+2,s[c++]=o+1,s[c++]=o+3,s[c++]=o+2,o+=4,a.indexOffset+=6;a.setDirty()},updateWorldVertexAndUVData:function(e,t){var n=e.node;n.getWorldMatrix(C2);var i=e.renderData,r=i.floatStride,o=i.data,a=t.vb,s=n._uiProps.uiTransformComp,c=Math.abs(s.width),l=Math.abs(s.height),u=e.spriteFrame,h=u.rotated,f=u.uv,_=u.uvSliced,p=u.rect,d=u.insetLeft,m=u.insetRight,v=p.width-d-m,g=u.insetTop,y=u.insetBottom,x=p.height-g-y,S=c-d-m,T=l-g-y;S=S>0?S:0,T=T>0?T:0;for(var b=0===v?S:S/v,E=0===x?T:T/x,C=Math.ceil(E+2),A=Math.ceil(b+2),w=0,P=0,R=0,I=0,D=0,O=0,M=C;O<M;++O){I=o[O].y,D=o[O+1].y;for(var N=0,L=A;N<L;++N){P=o[N].x,R=o[N+1].x,In.set(b2[0],P,I,0),In.set(b2[1],R,I,0),In.set(b2[2],P,D,0),In.set(b2[3],R,D,0);for(var B=0;B<4;B++){var F=b2[B];In.transformMat4(F,F,C2);var z=B*r;a[w+z]=F.x,a[w+z+1]=F.y,a[w+z+2]=F.z}w+=4*r}}w=0;for(var U=r,k=2*r,G=3*r,H=4*r,V=0,W=0,j=[],q=[],X=0,Y=C;X<Y;++X){W=T>x?T>=X*x?1:E%1:E;for(var K=0,Q=A;K<Q;++K){V=S>v?S>=K*v?1:b%1:b;var Z=w+3,J=Z+1;h?(0===X?(j[0]=_[0].u,j[1]=_[0].u,j[2]=_[4].u+(_[8].u-_[4].u)*W):X<C-1?(j[0]=_[4].u,j[1]=_[4].u,j[2]=_[4].u+(_[8].u-_[4].u)*W):X===C-1&&(j[0]=_[8].u,j[1]=_[8].u,j[2]=_[12].u),0===K?(q[0]=_[0].v,q[1]=_[1].v+(_[2].v-_[1].v)*V,q[2]=_[0].v):K<A-1?(q[0]=_[1].v,q[1]=_[1].v+(_[2].v-_[1].v)*V,q[2]=_[1].v):K===A-1&&(q[0]=_[2].v,q[1]=_[3].v,q[2]=_[2].v),j[3]=j[2],q[3]=q[1]):(0===K?(j[0]=_[0].u,j[1]=_[1].u+(_[2].u-_[1].u)*V,j[2]=f[0]):K<A-1?(j[0]=_[1].u,j[1]=_[1].u+(_[2].u-_[1].u)*V,j[2]=_[1].u):K===A-1&&(j[0]=_[2].u,j[1]=_[3].u,j[2]=_[2].u),0===X?(q[0]=_[0].v,q[1]=_[0].v,q[2]=_[4].v+(_[8].v-_[4].v)*W):X<C-1?(q[0]=_[4].v,q[1]=_[4].v,q[2]=_[4].v+(_[8].v-_[4].v)*W):X===C-1&&(q[0]=_[8].v,q[1]=_[8].v,q[2]=_[12].v),j[3]=j[1],q[3]=q[2]),a[Z]=j[0],a[J]=q[0],a[Z+U]=j[1],a[J+U]=q[1],a[Z+k]=j[2],a[J+k]=q[2],a[Z+G]=j[3],a[J+G]=q[3],w+=H}}},updateVerts:function(e,t,n,i,r){var o,a,s=e.node._uiProps.uiTransformComp,c=e.renderData.data,l=e.spriteFrame,u=l.rect,h=Math.abs(s.width),f=Math.abs(s.height),_=s.anchorX*h,p=s.anchorY*f,d=l.insetLeft,m=l.insetRight,v=u.width-d-m,g=l.insetTop,y=l.insetBottom,x=u.height-g-y,S=s.width/(d+m)>1?1:s.width/(d+m),T=s.height/(g+y)>1?1:s.height/(g+y);o=v>0?Math.floor(1e3*t)/1e3%v==0?v:t%v:t,a=x>0?Math.floor(1e3*n)/1e3%x==0?x:n%x:n;for(var b=0;b<=r;b++)0===b?c[b].x=-_:b>0&&b<r?c[b].x=1===b?d*S+Math.min(v,t)-_:v>0?b===r-1?d+o+v*(b-2)-_:d+Math.min(v,t)+v*(b-2)-_:d+t-_:b===r&&(c[b].x=Math.min(d+t+m,h)-_);for(var E=0;E<=i;E++)0===E?c[E].y=-p:E>0&&E<i?c[E].y=1===E?y*T+Math.min(x,n)-p:x>0?E===i-1?y+a+(E-2)*x-p:y+Math.min(x,n)+(E-2)*x-p:y+n-p:E===i&&(c[E].y=Math.min(y+n+g,f)-p)},updataColorLate:function(e){for(var t=e.renderData,n=t.chunk.vb,i=t.floatStride,r=t.vertexCount,o=5,a=e.color,s=a.r/255,c=a.g/255,l=a.b/255,u=e.node._uiProps.opacity,h=0;h<r;h++)n[o]=s,n[o+1]=c,n[o+2]=l,n[o+3]=u,o+=i},updateColor:function(){}},w2=nJ.Type,P2=nJ.FillType,R2=e("spriteAssembler",{getAssembler:function(e){var t=y2,n=e;switch(n.type){case w2.SLICED:t=T2;break;case w2.TILED:t=A2;break;case w2.FILLED:t=n.fillType===P2.RADIAL?m2:e2}return t}});nJ.Assembler=R2;var I2=QX.sharedManager,D2={createData:function(e){var t=e.requestRenderData();return t.dataLength=2,t.resize(4,6),t},updateRenderData:function(e){e.type===FQ.IMAGE_STENCIL&&(y2.updateRenderData(e),y2.updateColor(e))},fillBuffers:function(e,t){(e.type!==FQ.IMAGE_STENCIL||e.spriteFrame)&&(I2.pushMask(e),t.finishMergeBatches(),function(e,t){I2.clear(e),t.commitModel(e,e._clearModel,e._clearStencilMtl)}(e,t),function(e,t){if(I2.enterLevel(e),e.type===FQ.IMAGE_STENCIL){y2.fillBuffers(e,t);var n=e.graphics.getMaterialInstance(0);t.forceMergeBatches(n,e.spriteFrame,e.graphics)}else e.graphics.updateAssembler(t)}(e,t),I2.enableMask())}},O2={fillBuffers:function(){I2.exitMask()}},M2={getAssembler:function(){return D2}},N2={getAssembler:function(){return O2}};HQ.Assembler=M2,HQ.PostAssembler=N2;var L2=e("MeshBuffer",function(){function e(){this.byteOffset=0,this.vertexOffset=0,this.indexOffset=0,this.vData=null,this.iData=null,this._dirty=!1,this._vertexFormatBytes=0,this._floatsPerVertex=0,this._initVDataCount=0,this._initIDataCount=0,this._attributes=null,this._iaPool=[],this._iaInfo=null,this._nextFreeIAHandle=0}var t=e.prototype;return t.initialize=function(e,t,n,i){this._initVDataCount=n,this._initIDataCount=i,this._attributes=t,this._floatsPerVertex=Jq(t),this._initVDataCount,this._floatsPerVertex,F(9005),this.vData&&this.iData||(this.vData=new Float32Array(this._initVDataCount),this.iData=new Uint16Array(this._initIDataCount)),this._iaPool.push(this.createNewIA(e))},t.reset=function(){this._nextFreeIAHandle=0,this._dirty=!1},t.destroy=function(){this.reset(),this._attributes=null,this._iaInfo=null,this.vData=null,this.iData=null;for(var e=0;e<this._iaPool.length;++e){var t=this._iaPool[e];t.vertexBuffers[0]&&t.vertexBuffers[0].destroy(),t.indexBuffer&&t.indexBuffer.destroy(),t.ia.destroy()}this._iaPool.length=0},t.setDirty=function(){this._dirty=!0},t.request=function(){return D(9002),!1},t.requireFreeIA=function(e){return this._iaPool.length<=this._nextFreeIAHandle&&this._iaPool.push(this.createNewIA(e)),this._iaPool[this._nextFreeIAHandle++].ia},t.recycleIA=function(e){for(var t=this._iaPool,n=0;n<this._nextFreeIAHandle;++n)if(e===t[n].ia){var i=t[n];return t[n]=t[--this._nextFreeIAHandle],void(t[this._nextFreeIAHandle]=i)}},t.checkCapacity=function(e,t){var n=this.vertexOffset+e,i=this.indexOffset+t;return!(n>this._initVDataCount||i>this._initIDataCount)},t.uploadBuffers=function(){if(0!==this.byteOffset&&this._dirty){for(var e=hh.__isWebIOS14OrIPadOS14Env?this._nextFreeIAHandle:1,t=this.byteOffset,n=this.indexOffset,i=0;i<e;++i){var r=this._iaPool[i],o=new Float32Array(this.vData.buffer,0,t>>2),a=new Uint16Array(this.iData.buffer,0,n),s=r.vertexBuffers[0];t>s.size&&s.resize(t),s.update(o),2*n>r.indexBuffer.size&&r.indexBuffer.resize(2*n),r.indexBuffer.update(a)}this._dirty=!1}},t.createNewIA=function(e){var t,n,i;if(hh.__isWebIOS14OrIPadOS14Env||!this._iaPool[0]){var r=this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT,o=Uint16Array.BYTES_PER_ELEMENT,a=e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,r,r));i=e.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,o,o)),n=[a],this._iaInfo=new Or(this._attributes,n,i),t=e.createInputAssembler(this._iaInfo)}else t=e.createInputAssembler(this._iaInfo),n=this._iaInfo.vertexBuffers,i=this._iaInfo.indexBuffer;return{ia:t,vertexBuffers:n,indexBuffer:i}},Z(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}}]),e}()),B2=[hD.EventType.MOUSE_DOWN,hD.EventType.MOUSE_MOVE,hD.EventType.MOUSE_UP,hD.EventType.MOUSE_WHEEL],F2=[hD.EventType.TOUCH_START,hD.EventType.TOUCH_MOVE,hD.EventType.TOUCH_END,hD.EventType.TOUCH_CANCEL],z2=(new(function(){function e(){this.priority=tD.UI,this._isListDirty=!1,this._inDispatchCount=0,this._pointerEventProcessorList=[],this._processorListToAdd=[],this._processorListToRemove=[],fD._registerEventDispatcher(this),RI.callbacksInvoker.on(WA.ADD_POINTER_EVENT_PROCESSOR,this.addPointerEventProcessor,this),RI.callbacksInvoker.on(WA.REMOVE_POINTER_EVENT_PROCESSOR,this.removePointerEventProcessor,this),RI.callbacksInvoker.on(WA.MARK_LIST_DIRTY,this._markListDirty,this)}var t=e.prototype;return t.dispatchEvent=function(e){var t=e.type;return F2.includes(t)?this.dispatchEventTouch(e):!B2.includes(t)||this.dispatchEventMouse(e)},t.addPointerEventProcessor=function(e){0===this._inDispatchCount?this._pointerEventProcessorList.includes(e)||(this._pointerEventProcessorList.push(e),this._isListDirty=!0):this._processorListToAdd.includes(e)||this._processorListToAdd.push(e),rt.array.remove(this._processorListToRemove,e)},t.removePointerEventProcessor=function(e){0===this._inDispatchCount?(rt.array.remove(this._pointerEventProcessorList,e),this._isListDirty=!0):this._processorListToRemove.includes(e)||this._processorListToRemove.push(e),rt.array.remove(this._processorListToAdd,e)},t.dispatchEventMouse=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=!0,r=0;r<n;++r){var o=t[r];if(o.isEnabled&&o.shouldHandleEventMouse&&o._handleEventMouse(e)){if(i=!1,!e.preventSwallow)break;e.preventSwallow=!1}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),i},t.dispatchEventTouch=function(e){this._inDispatchCount++,this._sortPointerEventProcessorList();for(var t=this._pointerEventProcessorList,n=t.length,i=e.touch,r=!0,o=0;o<n;++o){var a=t[o];if(a.isEnabled&&a.shouldHandleEventTouch)if(e.type===HA.TOUCH_START){if(a._handleEventTouch(e)){if(a.claimedTouchIdList.push(i.getID()),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}else if(a.claimedTouchIdList.length>0){var s=a.claimedTouchIdList.indexOf(i.getID());if(-1!==s){if(a._handleEventTouch(e),e.type!==HA.TOUCH_END&&e.type!==HA.TOUCH_CANCEL||rt.array.removeAt(a.claimedTouchIdList,s),r=!1,!e.preventSwallow)break;e.preventSwallow=!1}}}return--this._inDispatchCount<=0&&this._updatePointerEventProcessorList(),r},t._updatePointerEventProcessorList=function(){for(var e=this._processorListToAdd,t=e.length,n=0;n<t;++n)this.addPointerEventProcessor(e[n]);e.length=0;for(var i=this._processorListToRemove,r=i.length,o=0;o<r;++o)this.removePointerEventProcessor(i[o]);i.length=0},t._sortPointerEventProcessorList=function(){if(this._isListDirty){for(var e=this._pointerEventProcessorList,t=e.length,n=0;n<t;++n){var i=e[n],r=i.node;if(r._uiProps){var o=r._uiProps.uiTransformComp;i.cachedCameraPriority=o.cameraPriority}}e.sort(this._sortByPriority),this._isListDirty=!1}},t._sortByPriority=function(e,t){var n=e.node,i=t.node;if(!(t&&i&&i.activeInHierarchy&&i._uiProps.uiTransformComp))return-1;if(!(e&&n&&n.activeInHierarchy&&n._uiProps.uiTransformComp))return 1;if(e.cachedCameraPriority!==t.cachedCameraPriority)return t.cachedCameraPriority-e.cachedCameraPriority;for(var r=n,o=i,a=!1;(null===(s=r.parent)||void 0===s?void 0:s._id)!==(null===(c=o.parent)||void 0===c?void 0:c._id);){var s,c,l,u,h,f;r=null===(null===(l=r)||void 0===l||null===(u=l.parent)||void 0===u?void 0:u.parent)?(a=!0)&&i:r&&r.parent,o=null===(null===(h=o)||void 0===h||null===(f=h.parent)||void 0===f?void 0:f.parent)?(a=!0)&&n:o&&o.parent}if(r._id===o._id){if(r._id===i._id)return-1;if(r._id===n._id)return 1}var _=r?r.getSiblingIndex():0,p=o?o.getSiblingIndex():0;return a?_-p:p-_},t._markListDirty=function(){this._isListDirty=!0},e}()),function(){function e(e,t){this._device=null,this._attributes=null,this._vertexFormatBytes=void 0,this._floatsPerVertex=void 0,this._buffers=[],this._device=e,this._attributes=t,this._floatsPerVertex=Jq(t),this._vertexFormatBytes=this._floatsPerVertex*Float32Array.BYTES_PER_ELEMENT}var t=e.prototype;return t.initialize=function(){},t.reset=function(){},t.request=function(){},t.appendBuffers=function(){},t.uploadBuffers=function(){},t.destroy=function(){this._attributes.length=0},Z(e,[{key:"attributes",get:function(){return this._attributes}},{key:"vertexFormatBytes",get:function(){return this._vertexFormatBytes}},{key:"floatsPerVertex",get:function(){return this._floatsPerVertex}}]),e}()),U2=new ql((function(){return{offset:0,length:0}}),32),k2=function(e,t,n,i){this.vertexAccessor=e,this.bufferId=t,this.vertexOffset=n,this.vb=i},G2=function(e){function t(n,i,r,o){var a;return(a=e.call(this,n,i)||this)._freeLists=[],a._vCount=0,a._iCount=0,a._vCount=r||Math.floor(1024*ft.BATCHER2D_MEM_INCREMENT/a._vertexFormatBytes),a._iCount=o||a._vCount*t.IB_SCALE,a._allocateBuffer(),a}$(t,e);var n=t.prototype;return n.destroy=function(){for(var t=0;t<this._buffers.length;++t){this._buffers[t].destroy();for(var n=this._freeLists[t],i=0;i<n.length;++i)U2.free(n[i])}this._buffers.length=0,this._freeLists.length=0,e.prototype.destroy.call(this)},n.reset=function(){for(var e=0;e<this._buffers.length;++e){var t=this._buffers[e];t.indexOffset=0,t.reset()}},n.getVertexBuffer=function(e){return this._buffers[e].vData},n.getIndexBuffer=function(e){return this._buffers[e].iData},n.getMeshBuffer=function(e){return this._buffers[e]},n.uploadBuffers=function(){for(var e=0;e<this._buffers.length;++e){var t=this._freeLists[e][0],n=this._buffers[e];(!t||t.length<n.vData.byteLength)&&n.uploadBuffers()}},n.appendIndices=function(e,t){var n=this._buffers[e];t.length&&(n.iData.set(t,n.indexOffset),n.indexOffset+=t.length)},n.allocateChunk=function(e,t){for(var n,i=e*this.vertexFormatBytes,r=null,o=0,a=-1,s=null,c=0;c<this._buffers.length;++c){r=this._buffers[c],n=this._freeLists[c];for(var l=0;l<n.length;++l)if(n[l].length>=i){s=n[l],o=c,a=l;break}if(s)break}if(s||(o=this._allocateBuffer(),(r=this._buffers[o])&&r.checkCapacity(e,t)&&(a=0,s=this._freeLists[o][a])),s){var u=s.offset/this.vertexFormatBytes,h=new Float32Array(r.vData.buffer,s.offset,i>>2).fill(0);return this._allocateChunkFromEntry(o,a,s,i),new k2(this,o,u,h,t)}return D(9004,i),null},n.recycleChunk=function(e){var t=this._freeLists[e.bufferId],n=this._buffers[e.bufferId],i=e.vertexOffset*this.vertexFormatBytes,r=e.vb.byteLength;if(0!==r){for(var o=!1,a=0,s=null,c=t[a];c&&c.offset<i;)s=c,c=t[++a];if(s&&0==i-(s.offset+s.length)&&(s.length+=r,i=s.offset,r=s.length,c&&c.offset-(i+r)==0&&(s.length+=c.length,t.splice(a,1),U2.free(c),c=null),o=!0),!o&&c){if(0==c.offset-(i+r))c.offset=i,c.length+=r;else{var l=U2.alloc();l.offset=i,l.length=r,t.splice(a,0,l)}o=!0}if(o)i+r===n.byteOffset&&(n.byteOffset=i);else{var u=U2.alloc();u.offset=i,u.length=r,t.push(u)}}},n._allocateChunkFromEntry=function(e,t,n,i){var r=n.length-i,o=n.offset+i,a=this._buffers[e];a.byteOffset<o&&(a.byteOffset=o),B(r>=0,9004,e,n.offset,n.length),0===r?(this._freeLists[e].splice(t,1),U2.free(n)):(n.offset+=i,n.length=r)},n._allocateBuffer=function(){B(this._buffers.length===this._freeLists.length,9003);var e=new L2,t=this._vCount*this._floatsPerVertex;e.initialize(this._device,this._attributes,t,this._iCount),this._buffers.push(e);var n=U2.alloc();n.offset=0,n.length=e.vData.byteLength;var i=[n];return this._freeLists.push(i),this._buffers.length-1},t}(z2);G2.IB_SCALE=4;var H2=new Vr(null),V2=new jn,W2=e("UI",function(){function e(e){var t=this;this.device=void 0,this._screens=[],this._staticVBBuffer=null,this._bufferAccessors=new Map,this._drawBatchPool=void 0,this._batches=void 0,this._currBID=-1,this._indexStart=0,this._emptyMaterial=new ug,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currStaticRoot=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0,this._currDepthStencilStateStage=null,this._currIsStatic=!1,this._currHash=0,this._pOpacity=1,this._opacityDirty=0,this._descriptorSetCache=new q2,this._meshDataArray=[],this._root=e,this.device=e.device,this._batches=new Yl(64),this._drawBatchPool=new ql((function(){return new H$}),128,(function(e){return e.destroy(t)}))}var t=e.prototype;return t.initialize=function(){return!0},t.destroy=function(){for(var e=0;e<this._batches.length;e++)this._batches.array[e]&&this._batches.array[e].destroy(this);this._batches.destroy(),this._bufferAccessors.forEach((function(e){e.destroy()})),this._bufferAccessors.clear(),this._drawBatchPool&&this._drawBatchPool.destroy(),this._descriptorSetCache.destroy(),QX.sharedManager.destroy()},t.addScreen=function(e){this._screens.push(e),this._screens.sort(this._screenSort)},t.removeScreen=function(e){var t=this._screens.indexOf(e);-1!==t&&this._screens.splice(t,1)},t.sortScreens=function(){this._screens.sort(this._screenSort)},t.getFirstRenderCamera=function(e){if(e.scene&&e.scene.renderScene)for(var t=e.scene.renderScene.cameras,n=0;n<t.length;n++){var i=t[n];if(i.visibility&e.layer)return i}return null},t.update=function(){for(var e=this._screens,t=0,n=0;n<e.length;++n){var i=e[n],r=i._getRenderScene();if(i.enabledInHierarchy&&r){this._opacityDirty=0,this._pOpacity=1,this.walk(i.node),this.autoMergeBatches(this._currComponent),this.resetRenderStates();var o=0;if(this._batches.length>t)for(;t<this._batches.length;++t){var a=this._batches.array[t];if(a.model)for(var s=a.model.subModels,c=0;c<s.length;c++)s[c].priority=o++;else a.descriptorSet=this._descriptorSetCache.getDescriptorSet(a);r.addBatch(a)}}}},t.uploadBuffers=function(){this._batches.length>0&&(this._meshDataArray.forEach((function(e){e.uploadBuffers()})),this._bufferAccessors.forEach((function(e){e.uploadBuffers(),e.reset()})),this._descriptorSetCache.update())},t.reset=function(){for(var e=0;e<this._batches.length;++e){var t=this._batches.array[e];t.isStatic||(t.clear(),this._drawBatchPool.free(t))}this._bufferAccessors.forEach((function(e){e.reset()})),this._meshDataArray.forEach((function(e){e.freeIAPool()})),this._meshDataArray.length=0,this._staticVBBuffer=null,this._currBID=-1,this._indexStart=0,this._currHash=0,this._currLayer=0,this._currRenderData=null,this._currMaterial=this._emptyMaterial,this._currTexture=null,this._currSampler=null,this._currComponent=null,this._currTransform=null,this._batches.clear(),QX.sharedManager.reset()},t.switchBufferAccessor=function(e){void 0===e&&(e=Qq);var t=e===Qq?36:$q(e);if(!this._staticVBBuffer||this._staticVBBuffer.vertexFormatBytes!==t){var n=this._bufferAccessors.get(t);n||(n=new G2(this.device,e),this._bufferAccessors.set(t,n)),this._staticVBBuffer=n,this._currBID=-1}return this._staticVBBuffer},t.registerBufferAccessor=function(e,t){this._bufferAccessors.set(e,t)},t.updateBuffer=function(e,t){var n=this.switchBufferAccessor(e);this._currBID!==t&&(this._currBID=t,this._indexStart=n.getMeshBuffer(t).indexOffset)},t.commitComp=function(e,t,n,i,r){var o,a=0,s=-1;if(t&&t.chunk){if(!t.isValid())return;a=t.dataHash,o=t.material,s=t.chunk.bufferId}e.stencilStage=QX.sharedManager.stage;var c=e.stencilStage;this._currHash===a&&0!==a&&this._currMaterial===o&&this._currDepthStencilStateStage===c||(this.autoMergeBatches(this._currComponent),t&&!t.isMeshBuffer&&this.updateBuffer(t.vertexFormat,s),this._currRenderData=t,this._currHash=t?t.dataHash:0,this._currComponent=e,this._currTransform=r,this._currMaterial=e.getRenderMaterial(0),this._currDepthStencilStateStage=c,this._currLayer=e.node.layer,n?(this._currTexture=n.getGFXTexture(),this._currSampler=n.getGFXSampler(),this._currTextureHash=n.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=null,this._currSampler=null,this._currTextureHash=0,this._currSamplerHash=0)),i.fillBuffers(e,this)},t.commitIA=function(e,t,n,i,r){var o,a;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var s=0,c=0;e&&(o=-1===e.blendHash?null:e.getBlendState(),c=e.blendHash,e.stencilStage=QX.sharedManager.stage,a=null!==e.customMaterial?QX.sharedManager.getStencilStage(e.stencilStage,i):QX.sharedManager.getStencilStage(e.stencilStage),s=QX.sharedManager.getStencilHash(e.stencilStage));var l=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();l.visFlags=e.node.layer,l.inputAssembler=t,l.useLocalData=r||null,n&&(l.texture=n.getGFXTexture(),l.sampler=n.getGFXSampler(),l.textureHash=n.getHash(),l.samplerHash=l.sampler.hash),l.fillPasses(i||null,a,s,o,c,null,this),this._batches.push(l)},t.commitModel=function(e,t,n){var i;this._currMaterial!==this._emptyMaterial&&(this.autoMergeBatches(this._currComponent),this.resetRenderStates());var r=0;n&&(e.stencilStage!==pX.ENABLED&&e.stencilStage!==pX.DISABLED||(e.stencilStage=QX.sharedManager.stage),i=QX.sharedManager.getStencilStage(e.stencilStage,n),r=QX.sharedManager.getStencilHash(e.stencilStage));var o=u.director.getTotalFrames();t&&(t.updateTransform(o),t.updateUBOs(o));for(var a=0;a<t.subModels.length;a++){var s=this._drawBatchPool.alloc(),c=t.subModels[a];s.visFlags=e.node.layer,s.model=t,s.texture=null,s.sampler=null,s.useLocalData=null,i||(i=null),s.fillPasses(n,i,r,null,0,c.patches,this),s.inputAssembler=c.inputAssembler,s.model.visFlags=s.visFlags,s.descriptorSet=c.descriptorSet,this._batches.push(s)}},t.setupStaticBatch=function(e,t){this.finishMergeBatches(),this._staticVBBuffer=t,this.currStaticRoot=e},t.endStaticBatch=function(){this.finishMergeBatches(),this.currStaticRoot=null,this._staticVBBuffer=null,this.switchBufferAccessor()},t.commitStaticBatch=function(e){this._batches.concat(e.drawBatchList),this.finishMergeBatches()},t.autoMergeBatches=function(e){var t=this._currMaterial;if(t){var n,i=this._currRenderData,r=this._staticVBBuffer;if(i&&i.isMeshBuffer)n=i.requestIA(this.device),-1===this._meshDataArray.indexOf(i)&&this._meshDataArray.push(i);else if(r){var o=this._currBID,a=r.getMeshBuffer(o);if(!a)return;var s=a.indexOffset-this._indexStart;if(s<=0)return;this._indexStart,a.indexOffset,a.setDirty(),(n=a.requireFreeIA(this.device)).firstIndex=this._indexStart,n.indexCount=s,this._indexStart=a.indexOffset}if(this._currBID=-1,n){var c,l,u=0,h=0;e&&(c=-1===e.blendHash?null:e.getBlendState(),h=e.blendHash,l=null!==e.customMaterial?QX.sharedManager.getStencilStage(e.stencilStage,t):QX.sharedManager.getStencilStage(e.stencilStage),u=QX.sharedManager.getStencilHash(e.stencilStage));var f=this._currStaticRoot?this._currStaticRoot._requireDrawBatch():this._drawBatchPool.alloc();f.visFlags=this._currLayer,f.texture=this._currTexture,f.sampler=this._currSampler,f.inputAssembler=n,f.useLocalData=this._currTransform,f.textureHash=this._currTextureHash,f.samplerHash=this._currSamplerHash,f.fillPasses(t,l,u,c,h,null,this),this._batches.push(f)}}},t.forceMergeBatches=function(e,t,n){this._currMaterial=e,t?(this._currTexture=t.getGFXTexture(),this._currSampler=t.getGFXSampler(),this._currTextureHash=t.getHash(),this._currSamplerHash=this._currSampler.hash):(this._currTexture=this._currSampler=null,this._currTextureHash=this._currSamplerHash=0),this._currLayer=n.node.layer,this.autoMergeBatches(n)},t.resetRenderStates=function(){this._currMaterial=this._emptyMaterial,this._currRenderData=null,this._currTexture=null,this._currComponent=null,this._currTransform=null,this._currTextureHash=0,this._currSamplerHash=0,this._currLayer=0},t.finishMergeBatches=function(){this.autoMergeBatches(),this.resetRenderStates()},t.flushMaterial=function(e){this._currMaterial=e},t.walk=function(e,t){if(void 0===t&&(t=0),e.activeInHierarchy){var n=e.children,i=e._uiProps,r=i.uiComp,o=this._pOpacity,a=o,s=r&&r.color?r.color.a/255:1;if(this._pOpacity=a*=s*i.localOpacity,i._opacity=a,i.colorDirty&&this._opacityDirty++,r&&r.enabledInHierarchy&&r.updateAssembler(this),this._opacityDirty&&r&&r.renderData&&r.renderData.vertexCount>0){!function(e,t){for(var n,i,r,o=e.vertexFormat,a=e.chunk.vb,s=0,c=0;c<o.length;++c){if(n=o[c],(i=eo[n.format]).hasAlpha)if(r=e.floatStride,i.size/i.count==1)for(var l=~~ln(Math.round(255*t),0,255),u=s;u<a.length;u+=r)a[u]=(4294967040&a[u]|l)>>>0;else if(i.size/i.count==4)for(var h=s+3;h<a.length;h+=r)a[h]=t;s+=i.size>>2}}(r.renderData,a);var c=r.renderData.getMeshBuffer();c&&c.setDirty()}if(n.length>0&&!e._static)for(var l=0;l<n.length;++l){var u=n[l];this.walk(u,t)}i.colorDirty&&(this._opacityDirty--,i.colorDirty=!1),this._pOpacity=o,r&&r.enabledInHierarchy&&r.postUpdateAssembler(this),t+=1}},t._screenSort=function(e,t){return e.node.getSiblingIndex()-t.node.getSiblingIndex()},t._releaseDescriptorSetCache=function(e){this._descriptorSetCache.releaseDescriptorSetCache(e)},Z(e,[{key:"currBufferAccessor",get:function(){return this._staticVBBuffer||(this._staticVBBuffer=this.switchBufferAccessor()),this._staticVBBuffer}},{key:"batches",get:function(){return this._batches}},{key:"currStaticRoot",set:function(e){this._currStaticRoot=e}},{key:"currIsStatic",set:function(e){this._currIsStatic=e}}]),e}()),j2=function(){function e(){this._descriptorSet=null,this._transform=null,this._textureHash=0,this._samplerHash=0,this._localBuffer=null,this._transformUpdate=!0;var e=u.director.root.device;this._localData=new Float32Array(pd.COUNT),this._localBuffer=e.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,pd.SIZE,pd.SIZE))}var t=e.prototype;return t.initialize=function(e){var t=u.director.root.device;this._transform=e.useLocalData,this._textureHash=e.textureHash,this._samplerHash=e.samplerHash,H2.layout=e.passes[0].localSetLayout,this._descriptorSet=t.createDescriptorSet(H2),this._descriptorSet.bindBuffer(pd.BINDING,this._localBuffer);var n=qp.SAMPLER_SPRITE;this._descriptorSet.bindTexture(n,e.texture),this._descriptorSet.bindSampler(n,e.sampler),this._descriptorSet.update(),this._transformUpdate=!0},t.updateTransform=function(e){e!==this._transform&&(this._transform=e,this._transformUpdate=!0,this.uploadLocalData())},t.equals=function(e,t,n){return this._transform===e&&this._textureHash===t&&this._samplerHash===n},t.reset=function(){this._transform=null,this._textureHash=0,this._samplerHash=0},t.destroy=function(){this._localBuffer&&(this._localBuffer.destroy(),this._localBuffer=null),this._descriptorSet&&(this._descriptorSet.destroy(),this._descriptorSet=null),this._localData=null},t.isValid=function(){return this._transform&&this._transform.isValid},t.uploadLocalData=function(){var e=this._transform;if((e.hasChangedFlags||e._dirtyFlags)&&(e.updateWorldTransform(),this._transformUpdate=!0),this._transformUpdate){var t=e.worldMatrix;jn.toArray(this._localData,t,pd.MAT_WORLD_OFFSET),jn.inverseTranspose(V2,t);var n=jn.determinant(V2),i=1/Math.sqrt(n);jn.multiplyScalar(V2,V2,i),jn.toArray(this._localData,V2,pd.MAT_WORLD_IT_OFFSET),this._localBuffer.update(this._localData),this._transformUpdate=!1}},Z(e,[{key:"descriptorSet",get:function(){return this._descriptorSet}}]),e}(),q2=function(){function e(){this._descriptorSetCache=new Map,this._dsCacheHashByTexture=new Map,this._localDescriptorSetCache=[],this._localCachePool=void 0,this._localCachePool=new ql((function(){return new j2}),16,(function(e){return e.destroy()}))}var t=e.prototype;return t.getDescriptorSet=function(e){var t,n=u.director.root;if(e.useLocalData){for(var i=this._localDescriptorSetCache,r=0,o=i.length;r<o;r++){var a=i[r];if(a.equals(e.useLocalData,e.textureHash,e.samplerHash))return a.descriptorSet}var s=this._localCachePool.alloc();return s.initialize(e),this._localDescriptorSetCache.push(s),s.descriptorSet}if(t=e.textureHash^e.samplerHash,this._descriptorSetCache.has(t))return this._descriptorSetCache.get(t);H2.layout=e.passes[0].localSetLayout;var c=n.device.createDescriptorSet(H2),l=qp.SAMPLER_SPRITE;return c.bindTexture(l,e.texture),c.bindSampler(l,e.sampler),c.update(),this._descriptorSetCache.set(t,c),this._dsCacheHashByTexture.set(e.textureHash,t),c},t.update=function(){var e=this._localDescriptorSetCache,t=[];e.forEach((function(n){if(n.isValid())n.uploadLocalData();else{n.reset();var i=e.indexOf(n);t.push(i)}}));for(var n=t.length-1;n>=0;n--)e.splice(t[n],1)},t.reset=function(){var e=this;this._localDescriptorSetCache.forEach((function(t){e._localCachePool.free(t)})),this._localDescriptorSetCache.length=0},t.releaseDescriptorSetCache=function(e){var t=this._dsCacheHashByTexture.get(e);t&&this._descriptorSetCache.has(t)&&(this._descriptorSetCache.get(t).destroy(),this._descriptorSetCache.delete(t),this._dsCacheHashByTexture.delete(e))},t.destroy=function(){this._descriptorSetCache.forEach((function(e){e.destroy()})),this._descriptorSetCache.clear(),this._dsCacheHashByTexture.clear(),this._localDescriptorSetCache.length=0,this._localCachePool.destroy()},e}();u.internal.Batcher2D=W2,H(L2.prototype,"MeshBuffer",["byteStart","vertexStart","indicesStart","request"].map((function(e){return{name:e,suggest:"please use meshBuffer.accessor."+e+" instead"}}))),k(L2.prototype,"MeshBuffer",[{name:"indicesOffset",newName:"indexOffset"}]),G(L2.prototype,"MeshBuffer",[{name:"vertexBuffers"},{name:"indexBuffer"}]),k(W2.prototype,"Batcher2D",[{name:"currBufferBatch",newName:"currBufferAccessor"},{name:"acquireBufferBatch",newName:"switchBufferAccessor"}]),G(xX.prototype,"MeshRenderData",[{name:"formatByte"},{name:"byteStart"},{name:"byteCount"}]),k(xX.prototype,"MeshRenderData",[{name:"indicesStart",newName:"indexStart"}]),e("QuadRenderData",function(e){function t(t){var n;return n=e.call(this,t)||this,D(9006),n}return $(t,e),t}(xX));var X2,Y2,K2=null,Q2=-1,Z2="BES bswy:->@123",J2=Object.create(null),$2=[],e4=3e3;function t4(){for(var e=!0,t=Date.now(),n=$2.length-1;n>=0;n--){var i=$2[n],r=i.fontFamilyName;if(t-i.startTime>e4)D(4933,r),i.onComplete(null,r),$2.splice(n,1);else{var o=i.refWidth,a="40px "+r;K2.font=a,o!==Fq(K2,Z2,a)?($2.splice(n,1),i.onComplete(null,r)):e=!1}}e&&(clearInterval(Q2),Q2=-1)}function n4(e,t,n){var i=function(e){var t=e.lastIndexOf(".ttf");if(-1===t)return e;var n,i=e.lastIndexOf("/");return-1!==(n=-1===i?e.substring(0,t)+"_LABEL":e.substring(i+1,t)+"_LABEL").indexOf(" ")&&(n='"'+n+'"'),n}(e);if(J2[i])n(null,i);else{if(!K2){var r=document.createElement("canvas");r.width=100,r.height=100,K2=r.getContext("2d")}var o=Fq(K2,Z2,"40px "+i),a=document.createElement("style");a.type="text/css";var s="";Number.isNaN(i)?s+="@font-face { font-family:"+i+"; src:":s+='@font-face { font-family:"'+i+'"; src:',s+='url("'+e+'");',a.textContent=s+"}",document.body.appendChild(a);var c=document.createElement("div"),l=c.style;if(l.fontFamily=i,c.innerHTML=".",l.position="absolute",l.left="-100px",l.top="-100px",document.body.appendChild(c),function(){if(void 0===X2)if("FontFace"in window){var e=/Gecko.*Firefox\/(\d+)/.exec(window.navigator.userAgent),t=/OS X.*Version\/10\..*Safari/.exec(window.navigator.userAgent)&&/Apple/.exec(window.navigator.vendor);X2=e?parseInt(e[1],10)>42:!t}else X2=!1;return X2}())!function(e,t,n){var i=new Promise((function(n,i){!function r(){Date.now()-e>=e4?i():document.fonts.load("40px "+t).then((function(e){e.length>=1?n():setTimeout(r,100)}),(function(){i()}))}()})),r=null,o=new Promise((function(e,t){r=setTimeout(t,e4)}));Promise.race([o,i]).then((function(){r&&(clearTimeout(r),r=null),n(null,t)}),(function(){D(4933,t),n(null,t)}))}(Date.now(),i,n);else{var u={fontFamilyName:i,refWidth:o,onComplete:n,startTime:Date.now()};$2.push(u),-1===Q2&&(Q2=setInterval(t4,100))}J2[i]=a}}function i4(e,t,n,i){var r=new yq;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}LN.register({".font":n4,".eot":n4,".ttf":n4,".woff":n4,".svg":n4,".ttc":n4}),HN.register({".font":i4,".eot":i4,".ttf":i4,".woff":i4,".svg":i4,".ttc":i4}),u.UI={MeshBuffer:L2,spriteAssembler:R2,graphicsAssembler:R0,labelAssembler:Q1,RenderData:yX,MeshRenderData:xX},function(e){e[e.positions=Zi.ATTR_POSITION]="positions",e[e.normals=Zi.ATTR_NORMAL]="normals",e[e.uvs=Zi.ATTR_TEX_COORD]="uvs",e[e.colors=Zi.ATTR_COLOR]="colors"}(Y2||(Y2={}));var r4,o4,a4,s4,c4,l4=function(){function e(){this._arrayBufferOrPaddings=[],this._length=0}var t=e.prototype;return t.setNextAlignment=function(e){if(0!==e){var t=this._length%e;if(0!==t){var n=e-t;this._arrayBufferOrPaddings.push(n),this._length+=n}}},t.addBuffer=function(e){var t=this._length;return this._arrayBufferOrPaddings.push(e),this._length+=e.byteLength,t},t.getLength=function(){return this._length},t.getCombined=function(){var e=new Uint8Array(this._length),t=0;return this._arrayBufferOrPaddings.forEach((function(n){"number"==typeof n?t+=n:(e.set(new Uint8Array(n),t),t+=n.byteLength)})),e.buffer},e}(),u4=function(){function e(e,t){if(this._mesh=void 0,this._subMeshRenderings=[],this._mesh=e,this._mesh.struct.morph){var n=this._mesh.struct.primitives.length;this._subMeshRenderings=new Array(n).fill(null);for(var i=0;i<n;++i){var r=this._mesh.struct.morph.subMeshMorphs[i];r&&(r.targets.length>Ed.MAX_MORPH_TARGET_COUNT?this._subMeshRenderings[i]=new f4(this._mesh,i,this._mesh.struct.morph,t):this._subMeshRenderings[i]=new h4(this._mesh,i,this._mesh.struct.morph,t))}}}return e.prototype.createInstance=function(){for(var e=this,t=this._mesh.struct.primitives.length,n=new Array(t),i=0;i<t;++i){var r,o;n[i]=null!==(r=null===(o=this._subMeshRenderings[i])||void 0===o?void 0:o.createInstance())&&void 0!==r?r:null}return{setWeights:function(e,t){var i;null===(i=n[e])||void 0===i||i.setWeights(t)},requiredPatches:function(t){e._mesh.struct.morph;var i=e._mesh.struct.morph.subMeshMorphs[t],r=n[t];if(null===r)return null;var o=[{name:"CC_USE_MORPH",value:!0},{name:"CC_MORPH_TARGET_COUNT",value:i.targets.length}];return i.attributes.includes(Zi.ATTR_POSITION)&&o.push({name:"CC_MORPH_TARGET_HAS_POSITION",value:!0}),i.attributes.includes(Zi.ATTR_NORMAL)&&o.push({name:"CC_MORPH_TARGET_HAS_NORMAL",value:!0}),i.attributes.includes(Zi.ATTR_TANGENT)&&o.push({name:"CC_MORPH_TARGET_HAS_TANGENT",value:!0}),o.push.apply(o,r.requiredPatches()),o},adaptPipelineState:function(e,t){var i;null===(i=n[e])||void 0===i||i.adaptPipelineState(t)},destroy:function(){for(var e,t=se(n);!(e=t()).done;){var i=e.value;null==i||i.destroy()}}}},e}(),h4=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._subMeshMorph=void 0,this._textureInfo=void 0,this._attributes=void 0,this._verticesCount=void 0,this._gfxDevice=i;var r=n.subMeshMorphs[t];this._subMeshMorph=r,m4(e,t,i);var o=e.struct.vertexBundles[e.struct.primitives[t].vertexBundelIndices[0]].view.count;this._verticesCount=o;var a=r.targets.length,s=d4(i,o*a);this._textureInfo={width:s.width,height:s.height},this._attributes=r.attributes.map((function(t,n){var i=s.create(),a=i.valueView;return r.targets.forEach((function(t,i){for(var r=t.displacements[n],s=new Float32Array(e.data.buffer,e.data.byteOffset+r.offset,r.count),c=o*i*4,l=0;l<o;++l)a[c+4*l+0]=s[3*l+0],a[c+4*l+1]=s[3*l+1],a[c+4*l+2]=s[3*l+2]})),i.updatePixels(),{name:t,morphTexture:i}}))}var t=e.prototype;return t.destroy=function(){for(var e,t=se(this._attributes);!(e=t()).done;)e.value.morphTexture.destroy()},t.createInstance=function(){var e=this,t=new p4(this._gfxDevice,this._subMeshMorph.targets.length);return t.setMorphTextureInfo(this._textureInfo.width,this._textureInfo.height),t.setVerticesCount(this._verticesCount),t.commit(),{setWeights:function(e){t.setWeights(e),t.commit()},requiredPatches:function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0}]},adaptPipelineState:function(n){for(var i,r=se(e._attributes);!(i=r()).done;){var o=i.value,a=void 0;switch(o.name){case Zi.ATTR_POSITION:a=Rd;break;case Zi.ATTR_NORMAL:a=Od;break;case Zi.ATTR_TANGENT:a=Ld;break;default:S("Unexpected attribute!")}void 0!==a&&(n.bindSampler(a,o.morphTexture.sampler),n.bindTexture(a,o.morphTexture.texture))}n.bindBuffer(Ed.BINDING,t.buffer),n.update()},destroy:function(){}}},e}(),f4=function(){function e(e,t,n,i){this._gfxDevice=void 0,this._attributes=[],this._gfxDevice=i;var r=n.subMeshMorphs[t];m4(e,t,i),this._attributes=r.attributes.map((function(t,n){return{name:t,targets:r.targets.map((function(t){return{displacements:new Float32Array(e.data.buffer,e.data.byteOffset+t.displacements[n].offset,t.displacements[n].count)}}))}}))}return e.prototype.createInstance=function(){return new _4(this,this._attributes[0].targets[0].displacements.length/3,this._gfxDevice)},Z(e,[{key:"data",get:function(){return this._attributes}}]),e}(),_4=function(){function e(e,t,n){this._attributes=void 0,this._owner=void 0,this._morphUniforms=void 0,this._owner=e,this._morphUniforms=new p4(n,0);var i=d4(n,t);this._morphUniforms.setMorphTextureInfo(i.width,i.height),this._morphUniforms.commit(),this._attributes=this._owner.data.map((function(e){var t=i.create();return{attributeName:e.name,morphTexture:t}}))}var t=e.prototype;return t.setWeights=function(e){for(var t=0;t<this._attributes.length;++t){var n=this._attributes[t],i=n.morphTexture.valueView,r=this._owner.data[t];e.length,r.targets.length;for(var o=0;o<r.targets.length;++o){var a=r.targets[o].displacements,s=e[o],c=a.length/3;if(0===o)for(var l=0;l<c;++l)i[4*l+0]=a[3*l+0]*s,i[4*l+1]=a[3*l+1]*s,i[4*l+2]=a[3*l+2]*s;else if(0!==s)for(var u=0;u<c;++u)i[4*u+0]+=a[3*u+0]*s,i[4*u+1]+=a[3*u+1]*s,i[4*u+2]+=a[3*u+2]*s}n.morphTexture.updatePixels()}},t.requiredPatches=function(){return[{name:"CC_MORPH_TARGET_USE_TEXTURE",value:!0},{name:"CC_MORPH_PRECOMPUTED",value:!0}]},t.adaptPipelineState=function(e){for(var t,n=se(this._attributes);!(t=n()).done;){var i=t.value,r=void 0;switch(i.attributeName){case Zi.ATTR_POSITION:r=Rd;break;case Zi.ATTR_NORMAL:r=Od;break;case Zi.ATTR_TANGENT:r=Ld;break;default:S("Unexpected attribute!")}void 0!==r&&(e.bindSampler(r,i.morphTexture.sampler),e.bindTexture(r,i.morphTexture.texture))}e.bindBuffer(Ed.BINDING,this._morphUniforms.buffer),e.update()},t.destroy=function(){this._morphUniforms.destroy();for(var e=0;e<this._attributes.length;++e)this._attributes[e].morphTexture.destroy()},e}(),p4=function(){function e(e,t){this._targetCount=void 0,this._localBuffer=void 0,this._remoteBuffer=void 0,this._targetCount=t,this._localBuffer=new DataView(new ArrayBuffer(Ed.SIZE)),this._remoteBuffer=e.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,Ed.SIZE,Ed.SIZE))}var t=e.prototype;return t.destroy=function(){this._remoteBuffer.destroy()},t.setWeights=function(e){e.length,this._targetCount;for(var t=0;t<e.length;++t)this._localBuffer.setFloat32(Ed.OFFSET_OF_WEIGHTS+4*t,e[t],u.sys.isLittleEndian)},t.setMorphTextureInfo=function(e,t){this._localBuffer.setFloat32(Ed.OFFSET_OF_DISPLACEMENT_TEXTURE_WIDTH,e,u.sys.isLittleEndian),this._localBuffer.setFloat32(Ed.OFFSET_OF_DISPLACEMENT_TEXTURE_HEIGHT,t,u.sys.isLittleEndian)},t.setVerticesCount=function(e){this._localBuffer.setFloat32(Ed.OFFSET_OF_VERTICES_COUNT,e,u.sys.isLittleEndian)},t.commit=function(){this._remoteBuffer.update(this._localBuffer.buffer)},Z(e,[{key:"buffer",get:function(){return this._remoteBuffer}}]),e}();function d4(e,t){var n,i,o,s;e.hasFeature(_i.TEXTURE_FLOAT)?(n=t,o=16,i=Cv.PixelFormat.RGBA32F,s=Float32Array):(n=4*t,o=4,i=Cv.PixelFormat.RGBA8888,s=Uint8Array);var c=function(e){e<5&&(e=5);var t=r(a(e)),n=t>>1;return{width:1<<(1&t?n+1:n),height:1<<n}}(n),l=c.width,u=c.height;return{width:l,height:u,create:function(){var t=new ArrayBuffer(l*u*o),n=new Float32Array(t),r=s===Float32Array?n:new s(t),a=new nv({width:l,height:u,_data:r,_compressed:!1,format:i}),c=new Cv;c.setFilters(Cv.Filter.NEAREST,Cv.Filter.NEAREST),c.setMipFilter(Cv.Filter.NONE),c.setWrapMode(Cv.WrapMode.CLAMP_TO_EDGE,Cv.WrapMode.CLAMP_TO_EDGE,Cv.WrapMode.CLAMP_TO_EDGE),c.image=a,c.getGFXTexture()||S("Unexpected: failed to create morph texture?");var h=e.getSampler(c.getSamplerInfo());return{get texture(){return c.getGFXTexture()},get sampler(){return h},get valueView(){return n},destroy:function(){c.destroy()},updatePixels:function(){c.uploadData(r)}}}}}function m4(e,t,n){e.renderingSubMeshes[t].enableVertexIdChannel(n)}function v4(e){switch(e){case 1:return Uint8Array;case 2:return Uint16Array;case 4:return Uint32Array;default:return Uint8Array}}var g4=new In,y4=new In,x4=new Uint8Array,S4=e("Mesh",mc("cc.Mesh")((c4=function(e){function t(){var t;return(t=e.call(this)||this).morphRendering=null,ce(t,"_struct",a4,oe(t)),ce(t,"_hash",s4,oe(t)),t._data=x4,t._initialized=!1,t._renderingSubMeshes=null,t._boneSpaceBounds=new Map,t._jointBufferIndices=null,t}$(t,e);var n=t.prototype;return n.onLoaded=function(){this.initialize()},n.initialize=function(){if(!this._initialized){this._initialized=!0;for(var e=this._data.buffer,t=u.director.root.device,n=this._createVertexBuffers(t,e),i=[],r=0;r<this._struct.primitives.length;r++){var o=this._struct.primitives[r];if(0!==o.vertexBundelIndices.length){var a=null,s=null;if(o.indexView){var c=o.indexView,l=c.stride,h=c.length;if(4===l&&!t.hasFeature(_i.ELEMENT_INDEX_UINT)){var f=this._struct.vertexBundles[o.vertexBundelIndices[0]].view.count;if(f>=65536){D(10001,f,65536);continue}l>>=1,h>>=1}a=t.createBuffer(new _r(vi.INDEX,xi.DEVICE,h,l)),s=new(v4(c.stride))(e,c.offset,c.count),c.stride!==l&&(s=v4(l).from(s)),a.update(s)}var _=o.vertexBundelIndices.map((function(e){return n[e]})),p=[];if(o.vertexBundelIndices.length>0)for(var d=o.vertexBundelIndices[0],m=this._struct.vertexBundles[d].attributes,v=0;v<m.length;++v){var g=m[v];p[v]=new Ir(g.name,g.format,g.isNormalized,g.stream,g.isInstanced,g.location)}var y=new VA(_,p,o.primitiveMode,a);y.mesh=this,y.subMeshIdx=r,i.push(y)}}this._renderingSubMeshes=i,this._struct.morph&&(this.morphRendering=function(e,t){return new u4(e,t)}(this,t))}},n.destroy=function(){return this.destroyRenderingMesh(),e.prototype.destroy.call(this)},n.destroyRenderingMesh=function(){if(this._renderingSubMeshes){for(var e=0;e<this._renderingSubMeshes.length;e++)this._renderingSubMeshes[e].destroy();this._renderingSubMeshes=null,this._initialized=!1}},n.assign=function(e,t){this.reset({struct:e,data:t})},n.reset=function(e){this.destroyRenderingMesh(),this._struct=e.struct,this._data=e.data,this._hash=0},n.getBoneSpaceBounds=function(e){if(this._boneSpaceBounds.has(e.hash))return this._boneSpaceBounds.get(e.hash);var t=[];this._boneSpaceBounds.set(e.hash,t);for(var n=[],i=e.bindposes,r=0;r<i.length;r++)t.push(new Xs(1/0,1/0,1/0,-1/0,-1/0,-1/0)),n.push(!1);for(var o=this._struct.primitives,a=0;a<o.length;a++){var s=this.readAttribute(a,Zi.ATTR_JOINTS),c=this.readAttribute(a,Zi.ATTR_WEIGHTS),l=this.readAttribute(a,Zi.ATTR_POSITION);if(s&&c&&l)for(var u=Math.min(s.length/4,c.length/4,l.length/3),h=0;h<u;h++){In.set(g4,l[3*h+0],l[3*h+1],l[3*h+2]);for(var f=0;f<4;++f){var _=4*h+f,p=s[_];if(!(0===c[_]||p>=i.length)){In.transformMat4(y4,g4,i[p]),n[p]=!0;var d=t[p];In.min(d.center,d.center,y4),In.max(d.halfExtents,d.halfExtents,y4)}}}}for(var m=0;m<i.length;m++){var v=t[m];n[m]?Xs.fromPoints(v,v.center,v.halfExtents):t[m]=null}return t},n.merge=function(e,t,n){if(n&&!this.validateMergingMesh(e))return!1;var i=new In,r=t&&new Fn,o=t&&new Xs;if(r&&t.getRotation(r),!this._initialized){var a=JSON.parse(JSON.stringify(e._struct)),s=e._data.slice();if(t){a.maxPosition&&a.minPosition&&(In.add(o.center,a.maxPosition,a.minPosition),In.multiplyScalar(o.center,o.center,.5),In.subtract(o.halfExtents,a.maxPosition,a.minPosition),In.multiplyScalar(o.halfExtents,o.halfExtents,.5),Xs.transform(o,o,t),In.add(a.maxPosition,o.center,o.halfExtents),In.subtract(a.minPosition,o.center,o.halfExtents));for(var c=0;c<a.vertexBundles.length;c++)for(var l=a.vertexBundles[c],u=0;u<l.attributes.length;u++)if(l.attributes[u].name===Zi.ATTR_POSITION||l.attributes[u].name===Zi.ATTR_NORMAL){var h=l.attributes[u].format,f=new DataView(s.buffer,l.view.offset+T4(l.attributes,u)),_=C4(f,h),p=A4(f,h);if(!_||!p)continue;for(var d=l.view.count,m=l.view.stride,v=E4(h),g=0;g<d;g++){var y=g*m,x=y+v,S=x+v;switch(i.set(_(y),_(x),_(S)),l.attributes[u].name){case Zi.ATTR_POSITION:i.transformMat4(t);break;case Zi.ATTR_NORMAL:In.transformQuat(i,i,r)}p(y,i.x),p(x,i.y),p(S,i.z)}}}return this.reset({struct:a,data:s}),this.initialize(),!0}for(var T,b,E,C,A,w=new l4,P=0,R=0,I=0,D=0,O=0,M=0,N=0,L=0,B=!1,F=new Array(this._struct.vertexBundles.length),z=0;z<this._struct.vertexBundles.length;++z){var U=this._struct.vertexBundles[z],k=e._struct.vertexBundles[z];I=U.view.offset,D=k.view.offset,R=U.view.stride,P=U.view.count+k.view.count,T=new ArrayBuffer(P*R),b=new Uint8Array(T),I+=(E=this._data.subarray(I,I+U.view.length)).length,D+=(C=e._data.subarray(D,D+k.view.length)).length,b.set(E),O=0;for(var G,H=se(U.attributes);!(G=H()).done;){var V=G.value;N=0,B=!1;for(var W,j=se(k.attributes);!(W=j()).done;){var q=W.value;if(V.name===q.name&&V.format===q.format){B=!0;break}N+=eo[q.format].size}if(B){L=eo[V.format].size,M=U.view.length+O;for(var X=0;X<k.view.count;++X){if(A=C.subarray(N,N+L),b.set(A,M),(V.name===Zi.ATTR_POSITION||V.name===Zi.ATTR_NORMAL)&&t){var Y=new Float32Array(b.buffer,M,3);switch(i.set(Y[0],Y[1],Y[2]),V.name){case Zi.ATTR_POSITION:i.transformMat4(t);break;case Zi.ATTR_NORMAL:In.transformQuat(i,i,r)}Y[0]=i.x,Y[1]=i.y,Y[2]=i.z}M+=U.view.stride,N+=k.view.stride}}O+=eo[V.format].size}F[z]={attributes:U.attributes,view:{offset:w.getLength(),length:T.byteLength,count:P,stride:R}},w.addBuffer(T)}for(var K,Q,Z,J=0,$=2,ee=0,te=new Array(this._struct.primitives.length),ne=0;ne<this._struct.primitives.length;++ne){var ie=this._struct.primitives[ne],re=e._struct.primitives[ne];te[ne]={primitiveMode:ie.primitiveMode,vertexBundelIndices:ie.vertexBundelIndices};for(var oe,ae=se(ie.vertexBundelIndices);!(oe=ae()).done;){var ce=oe.value;ee=Math.max(ee,this._struct.vertexBundles[ce].view.count)}if(ie.indexView&&re.indexView){J=ie.indexView.count,J+=re.indexView.count,I=ie.indexView.offset,D=re.indexView.offset,$=J<256?1:J<65536?2:4;var le=new ArrayBuffer(J*$);if(K=2===$?new Uint16Array(le):1===$?new Uint8Array(le):new Uint32Array(le),Q=2===ie.indexView.stride?new Uint16Array(this._data.buffer,I,ie.indexView.count):1===ie.indexView.stride?new Uint8Array(this._data.buffer,I,ie.indexView.count):new Uint32Array(this._data.buffer,I,ie.indexView.count),$===ie.indexView.stride)K.set(Q);else for(var ue=0;ue<ie.indexView.count;++ue)K[ue]=Q[ue];I+=ie.indexView.length,Z=2===re.indexView.stride?new Uint16Array(e._data.buffer,D,re.indexView.count):1===re.indexView.stride?new Uint8Array(e._data.buffer,D,re.indexView.count):new Uint32Array(e._data.buffer,D,re.indexView.count);for(var he=0;he<re.indexView.count;++he)K[ie.indexView.count+he]=ee+Z[he];D+=re.indexView.length,te[ne].indexView={offset:w.getLength(),length:le.byteLength,count:J,stride:$},w.setNextAlignment($),w.addBuffer(le)}}var fe={vertexBundles:F,primitives:te,minPosition:this._struct.minPosition,maxPosition:this._struct.maxPosition};return fe.minPosition&&e._struct.minPosition&&fe.maxPosition&&e._struct.maxPosition&&(t?(In.add(o.center,e._struct.maxPosition,e._struct.minPosition),In.multiplyScalar(o.center,o.center,.5),In.subtract(o.halfExtents,e._struct.maxPosition,e._struct.minPosition),In.multiplyScalar(o.halfExtents,o.halfExtents,.5),Xs.transform(o,o,t),In.add(i,o.center,o.halfExtents),In.max(fe.maxPosition,fe.maxPosition,i),In.subtract(i,o.center,o.halfExtents),In.min(fe.minPosition,fe.minPosition,i)):(In.min(fe.minPosition,fe.minPosition,e._struct.minPosition),In.max(fe.maxPosition,fe.maxPosition,e._struct.maxPosition))),this.reset({struct:fe,data:new Uint8Array(w.getCombined())}),this.initialize(),!0},n.validateMergingMesh=function(e){if(this._struct.vertexBundles.length!==e._struct.vertexBundles.length)return!1;for(var t=0;t<this._struct.vertexBundles.length;++t){var n=this._struct.vertexBundles[t],i=e._struct.vertexBundles[t];if(n.attributes.length!==i.attributes.length)return!1;for(var r=0;r<n.attributes.length;++r)if(n.attributes[r].format!==i.attributes[r].format)return!1}if(this._struct.primitives.length!==e._struct.primitives.length)return!1;for(var o=0;o<this._struct.primitives.length;++o){var a=this._struct.primitives[o],s=e._struct.primitives[o];if(a.vertexBundelIndices.length!==s.vertexBundelIndices.length)return!1;for(var c=0;c<a.vertexBundelIndices.length;++c)if(a.vertexBundelIndices[c]!==s.vertexBundelIndices[c])return!1;if(a.primitiveMode!==s.primitiveMode)return!1;if(a.indexView){if(void 0===s.indexView)return!1}else if(s.indexView)return!1}return!0},n.readAttribute=function(e,t){var n=this,i=null;return this._accessAttribute(e,t,(function(e,t){var r=e.view.count,o=e.attributes[t].format,a=uo(eo[o]);if(0!==r){var s=new DataView(n._data.buffer,e.view.offset+T4(e.attributes,t)),c=eo[o],l=C4(s,o);if(a&&l){for(var u=c.count,h=new a(r*u),f=e.view.stride,_=0;_<r;++_)for(var p=0;p<u;++p)h[u*_+p]=l(f*_+h.BYTES_PER_ELEMENT*p);i=h}}})),i},n.copyAttribute=function(e,t,n,i,r){var o=this,a=!1;return this._accessAttribute(e,t,(function(e,t){var s=e.view.count;if(0!==s){var c=e.attributes[t].format,l=new DataView(o._data.buffer,e.view.offset+T4(e.attributes,t)),u=new DataView(n,r),h=eo[c],f=C4(l,c),_=A4(u,c);if(f&&_){for(var p=h.count,d=e.view.stride,m=E4(c),v=i,g=m,y=0;y<s;++y)for(var x=0;x<p;++x)_(v*y+g*x,f(d*y+m*x));a=!0}}else a=!0})),a},n.readIndices=function(e){if(e>=this._struct.primitives.length)return null;var t=this._struct.primitives[e];if(!t.indexView)return null;var n=t.indexView.stride;return new(1===n?Uint8Array:2===n?Uint16Array:Uint32Array)(this._data.buffer,t.indexView.offset,t.indexView.count)},n.copyIndices=function(e,t){if(e>=this._struct.primitives.length)return!1;var n=this._struct.primitives[e];if(!n.indexView)return!1;for(var i=n.indexView.count,r=1===n.indexView.stride?pi.R8UI:2===n.indexView.stride?pi.R16UI:pi.R32UI,o=C4(new DataView(this._data.buffer),r),a=0;a<i;++a)t[a]=o(n.indexView.offset+eo[r].size*a);return!0},n._accessAttribute=function(e,t,n){if(!(e>=this._struct.primitives.length))for(var i,r=se(this._struct.primitives[e].vertexBundelIndices);!(i=r()).done;){var o=i.value,a=this._struct.vertexBundles[o],s=a.attributes.findIndex((function(e){return e.name===t}));if(!(s<0)){n(a,s);break}}},n._createVertexBuffers=function(e,t){return this._struct.vertexBundles.map((function(n){var i=e.createBuffer(new _r(vi.VERTEX,xi.DEVICE,n.view.length,n.view.stride)),r=new Uint8Array(t,n.view.offset,n.view.length);return i.update(r),i}))},n.initDefault=function(t){e.prototype.initDefault.call(this,t),this.reset({struct:{vertexBundles:[],primitives:[]},data:x4})},Z(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data=new Uint8Array(e)}},{key:"subMeshCount",get:function(){var e=this.renderingSubMeshes;return e?e.length:0}},{key:"minPosition",get:function(){return this.struct.minPosition}},{key:"maxPosition",get:function(){return this.struct.maxPosition}},{key:"struct",get:function(){return this._struct}},{key:"data",get:function(){return this._data}},{key:"hash",get:function(){return this._hash||(this._hash=xo(this._data,666)),this._hash}},{key:"jointBufferIndices",get:function(){return this._jointBufferIndices?this._jointBufferIndices:this._jointBufferIndices=this._struct.primitives.map((function(e){return e.jointMapIndex||0}))}},{key:"renderingSubMeshes",get:function(){return this.initialize(),this._renderingSubMeshes}}]),t}(Nu),a4=le((o4=c4).prototype,"_struct",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{vertexBundles:[],primitives:[]}}}),s4=le(o4.prototype,"_hash",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),r4=o4))||r4);function T4(e,t){for(var n=0,i=0;i<t;++i){var r=e[i];n+=eo[r.format].size}return n}u.Mesh=S4;var b4=hh.isLittleEndian;function E4(e){var t=eo[e];return t.size/t.count}function C4(e,t){var n=eo[t],i=n.size/n.count;switch(n.type){case di.UNORM:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,b4)};case 4:return function(t){return e.getUint32(t,b4)}}break;case di.SNORM:case di.INT:switch(i){case 1:return function(t){return e.getInt8(t)};case 2:return function(t){return e.getInt16(t,b4)};case 4:return function(t){return e.getInt32(t,b4)}}break;case di.UINT:switch(i){case 1:return function(t){return e.getUint8(t)};case 2:return function(t){return e.getUint16(t,b4)};case 4:return function(t){return e.getUint32(t,b4)}}break;case di.FLOAT:return function(t){return e.getFloat32(t,b4)}}return null}function A4(e,t){var n=eo[t],i=n.size/n.count;switch(n.type){case di.UNORM:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,b4)};case 4:return function(t,n){return e.setUint32(t,n,b4)}}break;case di.SNORM:case di.INT:switch(i){case 1:return function(t,n){return e.setInt8(t,n)};case 2:return function(t,n){return e.setInt16(t,n,b4)};case 4:return function(t,n){return e.setInt32(t,n,b4)}}break;case di.UINT:switch(i){case 1:return function(t,n){return e.setUint8(t,n)};case 2:return function(t,n){return e.setUint16(t,n,b4)};case 4:return function(t,n){return e.setUint32(t,n,b4)}}break;case di.FLOAT:return function(t,n){return e.setFloat32(t,n,b4)}}return null}var w4=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_NORMAL,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RG32F),new Ir(Zi.ATTR_TANGENT,pi.RGBA32F),new Ir(Zi.ATTR_COLOR,pi.RGBA32F)],P4=new In;function R4(e,t,n){n=n||{};var i,r=[],o=0,a=[],s=0,c=e.positions.slice();if(c.length>0){if(i=null,e.attributes)for(var l,u=se(e.attributes);!(l=u()).done;){var h=l.value;if(h.name===Zi.ATTR_POSITION){i=h;break}}i||(i=w4[0]),r.push(i);var f=eo[i.format];s=Math.max(s,Math.floor(c.length/f.count)),a.push({offset:o,data:c,attribute:i}),o+=f.size}if(e.normals&&e.normals.length>0){if(i=null,e.attributes)for(var _,p=se(e.attributes);!(_=p()).done;){var d=_.value;if(d.name===Zi.ATTR_NORMAL){i=d;break}}i||(i=w4[1]);var m=eo[i.format];r.push(i),s=Math.max(s,Math.floor(e.normals.length/m.count)),a.push({offset:o,data:e.normals,attribute:i}),o+=m.size}if(e.uvs&&e.uvs.length>0){if(i=null,e.attributes)for(var v,g=se(e.attributes);!(v=g()).done;){var y=v.value;if(y.name===Zi.ATTR_TEX_COORD){i=y;break}}i||(i=w4[2]);var x=eo[i.format];r.push(i),s=Math.max(s,Math.floor(e.uvs.length/x.count)),a.push({offset:o,data:e.uvs,attribute:i}),o+=x.size}if(e.tangents&&e.tangents.length>0){if(i=null,e.attributes)for(var S,T=se(e.attributes);!(S=T()).done;){var b=S.value;if(b.name===Zi.ATTR_TANGENT){i=b;break}}i||(i=w4[3]);var E=eo[i.format];r.push(i),s=Math.max(s,Math.floor(e.tangents.length/E.count)),a.push({offset:o,data:e.tangents,attribute:i}),o+=E.size}if(e.colors&&e.colors.length>0){if(i=null,e.attributes)for(var C,A=se(e.attributes);!(C=A()).done;){var w=C.value;if(w.name===Zi.ATTR_COLOR){i=w;break}}i||(i=w4[4]);var P=eo[i.format];r.push(i),s=Math.max(s,Math.floor(e.colors.length/P.count)),a.push({offset:o,data:e.colors,attribute:i}),o+=P.size}if(e.customAttributes)for(var R,I=se(e.customAttributes);!(R=I()).done;){var D=R.value,O=eo[D.attr.format];r.push(D.attr),s=Math.max(s,Math.floor(D.values.length/O.count)),a.push({offset:o,data:D.values,attribute:D.attr}),o+=O.size}for(var M=new l4,N=new ArrayBuffer(s*o),L=new DataView(N),B=0,F=a;B<F.length;B++){var z=F[B];zA(L,z.data,z.attribute.format,z.offset,o)}M.setNextAlignment(0);var U={attributes:r,view:{offset:M.getLength(),length:N.byteLength,count:s,stride:o}};M.addBuffer(N);var k=null,G=0;if(e.indices){var H=e.indices;G=H.length,k=new ArrayBuffer(2*G),zA(new DataView(k),H,pi.R16UI)}var V={primitiveMode:e.primitiveMode||Ui.TRIANGLE_LIST,vertexBundelIndices:[0]};k&&(M.setNextAlignment(2),V.indexView={offset:M.getLength(),length:k.byteLength,count:G,stride:2},M.addBuffer(k));var W=e.minPos;if(!W&&n.calculateBounds){W=In.set(new In,1/0,1/0,1/0);for(var j=0;j<s;++j)In.set(P4,c[3*j+0],c[3*j+1],c[3*j+2]),In.min(W,W,P4)}var q=e.maxPos;if(!q&&n.calculateBounds){q=In.set(new In,-1/0,-1/0,-1/0);for(var X=0;X<s;++X)In.set(P4,c[3*X+0],c[3*X+1],c[3*X+2]),In.max(q,q,P4)}var Y={vertexBundles:[U],primitives:[V]};return W&&(Y.minPosition=new In(W.x,W.y,W.z)),q&&(Y.maxPosition=new In(q.x,q.y,q.z)),t||(t=new S4),t.reset({struct:Y,data:new Uint8Array(M.getCombined())}),t}var I4=Object.freeze({__proto__:null,find:ED,toPPM:function(e,t,n){return"P3 "+t+" "+n+" 255\n"+e.filter((function(e,t){return t%4<3})).toString()+"\n"},readMesh:function(e,t){void 0===t&&(t=0);for(var n,i={positions:[]},r=new DataView(e.data.buffer,e.data.byteOffset,e.data.byteLength),o=e.struct,a=o.primitives[t],s=se(a.vertexBundelIndices);!(n=s()).done;)for(var c,l=n.value,u=o.vertexBundles[l],h=u.view.offset,f=u.view,_=f.length,p=f.stride,d=se(u.attributes);!(c=d()).done;){var m=c.value,v=Y2[m.name];v&&(i[v]=(i[v]||[]).concat(UA(r,m.format,h,_,p))),h+=eo[m.format].size}var g=a.indexView;return i.indices=UA(r,pi["R"+8*g.stride+"UI"],g.offset,g.length),i},createMesh:R4,readBuffer:UA,writeBuffer:zA,mapBuffer:kA});e("utils",I4);var D4,O4,M4,N4,L4,B4,F4,z4,U4,k4,G4,H4,V4,W4,j4,q4,X4,Y4,K4,Q4,Z4,J4,$4,e3,t3,n3,i3,r3,o3,a3,s3,c3,l3,u3,h3,f3,_3,p3,d3,m3,v3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._morphRenderingInstance=null,t._usedMaterials=new Set,t}$(t,e);var n=t.prototype;return n.getMacroPatches=function(t){return this._morphRenderingInstance?this._morphRenderingInstance.requiredPatches(t):e.prototype.getMacroPatches.call(this,t)},n.initSubModel=function(t,n,i){return e.prototype.initSubModel.call(this,t,n,this._launderMaterial(i))},n.destroy=function(){e.prototype.destroy.call(this),this._morphRenderingInstance=null},n.setSubModelMaterial=function(t,n){return e.prototype.setSubModelMaterial.call(this,t,this._launderMaterial(n))},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n),this._morphRenderingInstance&&this._morphRenderingInstance.adaptPipelineState(t,n)},n._launderMaterial=function(e){return e},n.setMorphRendering=function(e){this._morphRenderingInstance=e},t}(uT),g3=st({OFF:0,ON:1}),y3=st({OFF:0,ON:1}),x3=(D4=mc("cc.ModelLightmapSettings"),O4=bc("_recieveShadow"),D4((G4=function(){function e(){ce(this,"texture",L4,this),ce(this,"uvParam",B4,this),ce(this,"_bakeable",F4,this),ce(this,"_castShadow",z4,this),ce(this,"_receiveShadow",U4,this),ce(this,"_lightmapSize",k4,this)}return Z(e,[{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e}},{key:"lightmapSize",get:function(){return this._lightmapSize},set:function(e){this._lightmapSize=e}}]),e}(),L4=le((N4=G4).prototype,"texture",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),B4=le(N4.prototype,"uvParam",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new $n}}),F4=le(N4.prototype,"_bakeable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),z4=le(N4.prototype,"_castShadow",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),U4=le(N4.prototype,"_receiveShadow",[O4],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k4=le(N4.prototype,"_lightmapSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 64}}),le(N4.prototype,"bakeable",[Mc],Object.getOwnPropertyDescriptor(N4.prototype,"bakeable"),N4.prototype),le(N4.prototype,"castShadow",[Mc],Object.getOwnPropertyDescriptor(N4.prototype,"castShadow"),N4.prototype),le(N4.prototype,"receiveShadow",[Mc],Object.getOwnPropertyDescriptor(N4.prototype,"receiveShadow"),N4.prototype),le(N4.prototype,"lightmapSize",[Mc],Object.getOwnPropertyDescriptor(N4.prototype,"lightmapSize"),N4.prototype),M4=N4))||M4),S3=function(t){return e({MeshRenderer:t,ModelComponent:t}),t}((H4=mc("cc.MeshRenderer"),V4=Oc(),W4=gc(100),j4=Pc(),q4=Zc(g3),X4=Fc(),Y4=Zc(y3),K4=Fc(),Q4=Zc(S4),Z4=Fc(),J4=Nc(),H4($4=V4($4=W4($4=j4($4=wc((s3=a3=function(e){function t(){var t;return ce(t=e.call(this)||this,"lightmapSettings",t3,oe(t)),ce(t,"_mesh",n3,oe(t)),ce(t,"_shadowCastingMode",i3,oe(t)),ce(t,"_shadowReceivingMode",r3,oe(t)),t._subMeshShapesWeights=[],t._modelType=void 0,t._model=null,t._morphInstance=null,ce(t,"_enableMorph",o3,oe(t)),t._modelType=uT,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._mesh&&this._mesh.initialize(),this._validateShapeWeights()||this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onRestore=function(){this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow()},n.onEnable=function(){this._model||this._updateModels(),this._updateCastShadow(),this._updateReceiveShadow(),this._attachToScene()},n.onDisable=function(){this._model&&this._detachFromScene()},n.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0),this._morphInstance&&this._morphInstance.destroy()},n.getWeight=function(e,t){this._subMeshShapesWeights.length;var n=this._subMeshShapesWeights[e];return n.length,n[t]},n.setWeights=function(e,t){var n=this._subMeshShapesWeights;t>=n.length||n[t].length===e.length&&(n[t]=e.slice(0),this._uploadSubMeshShapesWeights(t))},n.setWeight=function(e,t,n){var i=this._subMeshShapesWeights;if(!(t>=i.length)){var r=i[t];n>=r.length||(r[n]=e,this._uploadSubMeshShapesWeights(t))}},n.setInstancedAttribute=function(e,t){if(this.model)for(var n=this.model.instancedAttributes,i=n.attributes,r=n.views,o=0;o<i.length;o++)if(i[o].name===e){r[o].set(t);break}},n._updateLightmap=function(e,t,n,i,r){this.lightmapSettings.texture=e,this.lightmapSettings.uvParam.x=t,this.lightmapSettings.uvParam.y=n,this.lightmapSettings.uvParam.z=i,this.lightmapSettings.uvParam.w=r,this._onUpdateLightingmap()},n._updateModels=function(){if(this.enabledInHierarchy&&this._mesh){var e=this._model;e?(e.destroy(),e.initialize(),e.node=e.transform=this.node):this._createModel(),this._model&&(this._model.createBoundingShape(this._mesh.struct.minPosition,this._mesh.struct.maxPosition),this._updateModelParams(),this._onUpdateLightingmap())}},n._createModel=function(){var e=this._morphInstance&&this._modelType===uT?v3:this._modelType,t=this._model=u.director.root.createModel(e);t.visFlags=this.visibility,t.node=t.transform=this.node,this._models.length=0,this._models.push(this._model),this._morphInstance&&t instanceof v3&&t.setMorphRendering(this._morphInstance)},n._attachToScene=function(){if(this.node.scene&&this._model){var e=this._getRenderScene();null!==this._model.scene&&this._detachFromScene(),e.addModel(this._model)}},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n._updateModelParams=function(){if(this._mesh&&this._model){this.node.hasChangedFlags|=oy.POSITION,this._model.transform.hasChangedFlags|=oy.POSITION,this._model.isDynamicBatching=this._isBatchingEnabled();var e=this._mesh?this._mesh.renderingSubMeshes.length:0,t=this._mesh.renderingSubMeshes;if(t)for(var n=0;n<e;++n){var i=this.getRenderMaterial(n);i&&!i.isValid&&(i=null);var r=t[n];r&&this._model.initSubModel(n,r,i||this._getBuiltinMaterial())}this._model.enabled=!0}},n._onUpdateLightingmap=function(){null!==this.model&&this.model.updateLightingmap(this.lightmapSettings.texture,this.lightmapSettings.uvParam),this.setInstancedAttribute("a_lightingMapUVParam",[this.lightmapSettings.uvParam.x,this.lightmapSettings.uvParam.y,this.lightmapSettings.uvParam.z,this.lightmapSettings.uvParam.w])},n._onMaterialModified=function(e,t){this._model&&this._model.inited&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.inited&&(this._model.isDynamicBatching=this._isBatchingEnabled(),this._model.setSubModelMaterial(e,t),this._onUpdateLightingmap())},n._onMeshChanged=function(){},n._clearMaterials=function(){if(this._model)for(var e=this._model.subModels,t=0;t<e.length;++t)this._onMaterialModified(t,null)},n._getBuiltinMaterial=function(){return Nv.get("missing-material")},n._onVisibilityChange=function(e){this._model&&(this._model.visFlags=e)},n._updateCastShadow=function(){this._model&&(this._shadowCastingMode===g3.OFF?this._model.castShadow=!1:(this._shadowCastingMode,g3.ON,this._shadowCastingMode,this._model.castShadow=!0))},n._updateReceiveShadow=function(){this._model&&(this._shadowReceivingMode===y3.OFF?this._model.receiveShadow=!1:this._model.receiveShadow=!0)},n._isBatchingEnabled=function(){for(var e=0;e<this._materials.length;++e){var t=this._materials[e];if(t)for(var n=0;n<t.passes.length;++n)if(t.passes[n].batchingScheme)return!0}return!1},n._watchMorphInMesh=function(){if(this._morphInstance&&(this._morphInstance.destroy(),this._morphInstance=null),this._enableMorph&&this._mesh&&this._mesh.struct.morph&&this._mesh.morphRendering){this._morphInstance=this._mesh.morphRendering.createInstance();for(var e=this._mesh.struct.primitives.length,t=0;t<e;++t)this._uploadSubMeshShapesWeights(t);this._model&&this._model instanceof v3&&this._model.setMorphRendering(this._morphInstance)}},n._initSubMeshShapesWeights=function(){var e=this._mesh;if(this._subMeshShapesWeights.length=0,e){var t=e.struct.morph;if(t){var n=t.weights;this._subMeshShapesWeights=t.subMeshMorphs.map((function(e){return e?e.weights?e.weights.slice(0):n?(n.length,e.targets.length,n.slice(0)):new Array(e.targets.length).fill(0):[]}))}}},n._validateShapeWeights=function(){var e=this._mesh,t=this._subMeshShapesWeights;if(!e||!e.struct.morph)return 0===t.length;var n=e.struct.morph;return n.subMeshMorphs.length===t.length&&t.every((function(e,t){var i,r,o=e.length;return(null!==(i=null===(r=n.subMeshMorphs[t])||void 0===r?void 0:r.targets.length)&&void 0!==i?i:0)===o}))},n._uploadSubMeshShapesWeights=function(e){var t;null===(t=this._morphInstance)||void 0===t||t.setWeights(e,this._subMeshShapesWeights[e])},Z(t,[{key:"shadowCastingMode",get:function(){return this._shadowCastingMode},set:function(e){this._shadowCastingMode=e,this._updateCastShadow()}},{key:"receiveShadow",get:function(){return this._shadowReceivingMode},set:function(e){this._shadowReceivingMode=e,this._updateReceiveShadow()}},{key:"mesh",get:function(){return this._mesh},set:function(e){var t=this._mesh,n=this._mesh=e;null==n||n.initialize(),this._initSubMeshShapesWeights(),this._watchMorphInMesh(),this._onMeshChanged(t),this._updateModels(),this.enabledInHierarchy&&this._attachToScene(),this._updateCastShadow(),this._updateReceiveShadow()}},{key:"model",get:function(){return this._model}},{key:"enableMorph",get:function(){return this._enableMorph},set:function(e){this._enableMorph=e}}]),t}(dF),a3.ShadowCastingMode=g3,a3.ShadowReceivingMode=y3,t3=le((e3=s3).prototype,"lightmapSettings",[Tc,Mc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new x3}}),n3=le(e3.prototype,"_mesh",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),i3=le(e3.prototype,"_shadowCastingMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return g3.OFF}}),r3=le(e3.prototype,"_shadowReceivingMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return y3.ON}}),le(e3.prototype,"shadowCastingMode",[q4,X4,qc],Object.getOwnPropertyDescriptor(e3.prototype,"shadowCastingMode"),e3.prototype),le(e3.prototype,"receiveShadow",[Y4,K4,qc],Object.getOwnPropertyDescriptor(e3.prototype,"receiveShadow"),e3.prototype),le(e3.prototype,"mesh",[Q4,Z4],Object.getOwnPropertyDescriptor(e3.prototype,"mesh"),e3.prototype),le(e3.prototype,"enableMorph",[J4,qc],Object.getOwnPropertyDescriptor(e3.prototype,"enableMorph"),e3.prototype),o3=le(e3.prototype,"_enableMorph",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$4=e3))||$4)||$4)||$4)||$4)||$4));function T3(e,t){var n=e.sharedMaterials.length;if(n!==t.sharedMaterials.length)return!1;for(var i=0;i<n;i++)if(e.getRenderMaterial(i)!==t.getRenderMaterial(i))return!1;return!0}e("BatchingUtility",function(){function e(){}return e.batchStaticModel=function(e,t){var n=e.getComponentsInChildren(S3);if(n.length<2)return console.error("the number of static models to batch is less than 2,it needn't batch."),!1;for(var i=1;i<n.length;i++){if(!n[0].mesh.validateMergingMesh(n[i].mesh))return console.error("the meshes of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1;if(!T3(n[0],n[i]))return console.error("the materials of "+n[0].node.name+" and "+n[i].node.name+" can't be merged"),!1}var r=new S4,o=new jn,a=new jn;e.getWorldMatrix(a),jn.invert(a,a);for(var s=0;s<n.length;s++){var c=n[s];c.node.getWorldMatrix(o),jn.multiply(o,a,o),r.merge(n[s].mesh,o),c.enabled=!1}var l=t.addComponent(S3);return l.mesh=r,l.sharedMaterials=n[0].sharedMaterials,!0},e.unbatchStaticModel=function(e,t){for(var n=e.getComponentsInChildren(S3),i=0;i<n.length;i++)n[i].enabled=!0;var r=t.getComponent(S3);return r&&(r.mesh&&r.mesh.destroyRenderingMesh(),r.destroy()),!0},e}()),k(S4.prototype,"Mesh.prototype",[{name:"renderingMesh",newName:"renderingSubMeshes"}]),G(S4.prototype,"Mesh.prototype",[{name:"hasFlatBuffers"},{name:"destroyFlatBuffers"}]);var b3,E3,C3,A3,w3,P3,R3,I3,D3,O3,M3,N3,L3,B3,F3,z3,U3,k3,G3,H3,V3,W3,j3=e("Skeleton",(c3=mc("cc.Skeleton"),l3=Zc([Ft]),u3=Zc([jn]),c3((m3=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_joints",_3,oe(t)),ce(t,"_bindposes",p3,oe(t)),ce(t,"_hash",d3,oe(t)),t._invBindposes=null,t}$(t,e);var n=t.prototype;return n.destroy=function(){var t,n;return null===(t=null===(n=u.director.root)||void 0===n?void 0:n.dataPoolManager)||void 0===t||t.releaseSkeleton(this),e.prototype.destroy.call(this)},n.validate=function(){return this.joints.length>0&&this.bindposes.length>0},Z(t,[{key:"joints",get:function(){return this._joints},set:function(e){this._joints=e}},{key:"bindposes",get:function(){return this._bindposes},set:function(e){this._bindposes=e}},{key:"inverseBindposes",get:function(){if(!this._invBindposes){this._invBindposes=[];for(var e=0;e<this._bindposes.length;e++){var t=new jn;jn.invert(t,this._bindposes[e]),this._invBindposes.push(t)}}return this._invBindposes}},{key:"hash",get:function(){if(!this._hash){for(var e="",t=0;t<this._bindposes.length;t++){var n=this._bindposes[t];e+=n.m00.toPrecision(2)+" "+n.m01.toPrecision(2)+" "+n.m02.toPrecision(2)+" "+n.m03.toPrecision(2)+" "+n.m04.toPrecision(2)+" "+n.m05.toPrecision(2)+" "+n.m06.toPrecision(2)+" "+n.m07.toPrecision(2)+" "+n.m08.toPrecision(2)+" "+n.m09.toPrecision(2)+" "+n.m10.toPrecision(2)+" "+n.m11.toPrecision(2)+" "+n.m12.toPrecision(2)+" "+n.m13.toPrecision(2)+" "+n.m14.toPrecision(2)+" "+n.m15.toPrecision(2)+"\n"}this._hash=xo(e,666)}return this._hash}}]),t}(Nu),_3=le((f3=m3).prototype,"_joints",[l3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),p3=le(f3.prototype,"_bindposes",[u3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),d3=le(f3.prototype,"_hash",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),h3=f3))||h3));u.Skeleton=j3,G(S3.prototype,"MeshRenderer.prototype",[{name:"enableDynamicBatching"},{name:"recieveShadows"}]),u.ModelComponent=S3,rt.setClassAlias(S3,"cc.ModelComponent");var q3,X3,Y3,K3,Q3,Z3,J3,$3,e5,t5,n5,i5,r5,o5,a5,s5,c5,l5,u5,h5,f5,_5,p5,d5,m5,v5,g5,y5,x5,S5,T5,b5,E5,C5,A5,w5,P5,R5,I5,D5,O5,M5,N5,L5,B5,F5,z5,U5,k5,G5,H5,V5,W5,j5,q5,X5=st({LUMINOUS_FLUX:0,LUMINANCE:1}),Y5=new In,K5=mc("cc.StaticLightSettings")((R3=function(){function e(){ce(this,"_baked",C3,this),ce(this,"_editorOnly",A3,this),ce(this,"_bakeable",w3,this),ce(this,"_castShadow",P3,this)}return Z(e,[{key:"editorOnly",get:function(){return this._editorOnly},set:function(e){this._editorOnly=e}},{key:"baked",get:function(){return this._baked},set:function(e){this._baked=e}},{key:"bakeable",get:function(){return this._bakeable},set:function(e){this._bakeable=e}},{key:"castShadow",get:function(){return this._castShadow},set:function(e){this._castShadow=e}}]),e}(),C3=le((E3=R3).prototype,"_baked",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),A3=le(E3.prototype,"_editorOnly",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),w3=le(E3.prototype,"_bakeable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),P3=le(E3.prototype,"_castShadow",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(E3.prototype,"editorOnly",[Mc],Object.getOwnPropertyDescriptor(E3.prototype,"editorOnly"),E3.prototype),le(E3.prototype,"bakeable",[Mc],Object.getOwnPropertyDescriptor(E3.prototype,"bakeable"),E3.prototype),le(E3.prototype,"castShadow",[Mc],Object.getOwnPropertyDescriptor(E3.prototype,"castShadow"),E3.prototype),b3=E3))||b3,Q5=function(t){return e({Light:t,LightComponent:t}),t}((I3=mc("cc.Light"),D3=Fc(),O3=Fc(),M3=zc(),N3=Fc(),L3=Zc(K5),B3=Vc(),I3((W3=V3=function(e){function t(){var t;return ce(t=e.call(this)||this,"_color",U3,oe(t)),ce(t,"_useColorTemperature",k3,oe(t)),ce(t,"_colorTemperature",G3,oe(t)),ce(t,"_staticSettings",H3,oe(t)),t._type=ay.UNKNOWN,t._lightType=void 0,t._light=null,t._lightType=Ty,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._createLight()},n.onEnable=function(){this._attachToScene()},n.onDisable=function(){this._detachFromScene()},n.onDestroy=function(){this._destroyLight()},n._createLight=function(){this._light||(this._light=u.director.root.createLight(this._lightType)),this.color=this._color,this.useColorTemperature=this._useColorTemperature,this.colorTemperature=this._colorTemperature,this._light.node=this.node,this._light.baked=this.baked},n._destroyLight=function(){this._light&&(u.director.root.destroyLight(this),this._light=null)},n._attachToScene=function(){if(this._detachFromScene(),this._light&&!this._light.scene&&this.node.scene){var e=this._getRenderScene();switch(this._type){case ay.DIRECTIONAL:e.addDirectionalLight(this._light),e.setMainLight(this._light);break;case ay.SPHERE:e.addSphereLight(this._light);break;case ay.SPOT:e.addSpotLight(this._light)}}},n._detachFromScene=function(){if(this._light&&this._light.scene){var e=this._light.scene;switch(this._type){case ay.DIRECTIONAL:e.removeDirectionalLight(this._light),e.unsetMainLight(this._light);break;case ay.SPHERE:e.removeSphereLight(this._light);break;case ay.SPOT:e.removeSpotLight(this._light)}}},Z(t,[{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._light&&(Y5.x=e.r/255,Y5.y=e.g/255,Y5.z=e.b/255,this._light.color=Y5)}},{key:"useColorTemperature",get:function(){return this._useColorTemperature},set:function(e){this._useColorTemperature=e,this._light&&(this._light.useColorTemperature=e)}},{key:"colorTemperature",get:function(){return this._colorTemperature},set:function(e){this._colorTemperature=e,this._light&&(this._light.colorTemperature=e)}},{key:"staticSettings",get:function(){return this._staticSettings},set:function(e){this._staticSettings=e}},{key:"type",get:function(){return this._type}},{key:"baked",get:function(){return this.staticSettings.baked},set:function(e){this.staticSettings.baked=e,null!==this._light&&(this._light.baked=e)}}]),t}(th),V3.Type=ay,V3.PhotometricTerm=X5,U3=le((z3=W3).prototype,"_color",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),k3=le(z3.prototype,"_useColorTemperature",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),G3=le(z3.prototype,"_colorTemperature",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 6550}}),H3=le(z3.prototype,"_staticSettings",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new K5}}),le(z3.prototype,"color",[D3],Object.getOwnPropertyDescriptor(z3.prototype,"color"),z3.prototype),le(z3.prototype,"useColorTemperature",[O3],Object.getOwnPropertyDescriptor(z3.prototype,"useColorTemperature"),z3.prototype),le(z3.prototype,"colorTemperature",[Hc,M3,N3],Object.getOwnPropertyDescriptor(z3.prototype,"colorTemperature"),z3.prototype),le(z3.prototype,"staticSettings",[L3,B3],Object.getOwnPropertyDescriptor(z3.prototype,"staticSettings"),z3.prototype),F3=z3))||F3)),Z5=function(t){return e({DirectionalLight:t,DirectionalLightComponent:t}),t}((q3=mc("cc.DirectionalLight"),X3=Oc(),Y3=Pc(),K3=bc("_illuminance"),Q3=Fc(),q3(Z3=X3(Z3=Y3(Z3=wc((t5=function(e){function t(){var t;return ce(t=e.call(this)||this,"_illuminanceHDR",$3,oe(t)),ce(t,"_illuminanceLDR",e5,oe(t)),t._type=ay.DIRECTIONAL,t._light=null,t._lightType=mT,t}return $(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this._illuminanceLDR=this._illuminanceHDR*yg.standardExposureValue,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR,this._light.illuminanceLDR=this._illuminanceLDR)},Z(t,[{key:"illuminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._illuminanceHDR:this._illuminanceLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?(this._illuminanceHDR=e,this._light&&(this._light.illuminanceHDR=this._illuminanceHDR)):(this._illuminanceLDR=e,this._light&&(this._light.illuminanceLDR=this._illuminanceLDR))}}]),t}(Q5),$3=le((J3=t5).prototype,"_illuminanceHDR",[xc,K3],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 65e3}}),e5=le(J3.prototype,"_illuminanceLDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),le(J3.prototype,"illuminance",[Q3],Object.getOwnPropertyDescriptor(J3.prototype,"illuminance"),J3.prototype),Z3=J3))||Z3)||Z3)||Z3)||Z3)),J5=function(t){return e({SphereLight:t,SphereLightComponent:t}),t}((n5=mc("cc.SphereLight"),i5=Oc(),r5=Pc(),o5=bc("_luminance"),a5=Vc(),s5=Fc(),c5=Vc(),l5=Fc(),u5=Zc(X5),h5=Vc(),f5=Fc(),_5=Fc(),p5=Fc(),n5(d5=i5(d5=r5(d5=wc((T5=function(e){function t(){var t;return ce(t=e.call(this)||this,"_size",v5,oe(t)),ce(t,"_luminanceHDR",g5,oe(t)),ce(t,"_luminanceLDR",y5,oe(t)),ce(t,"_term",x5,oe(t)),ce(t,"_range",S5,oe(t)),t._type=ay.SPHERE,t._light=null,t._lightType=TT,t}return $(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*yg.standardExposureValue*yg.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/yg.standardExposureValue/yg.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Z(t,[{key:"luminousFlux",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Sy(this._size):this._luminanceLDR},set:function(e){var t=0;u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Sy(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}}]),t}(Q5),v5=le((m5=T5).prototype,"_size",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),g5=le(m5.prototype,"_luminanceHDR",[Tc,o5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Sy(.15)}}),y5=le(m5.prototype,"_luminanceLDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),x5=le(m5.prototype,"_term",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return X5.LUMINOUS_FLUX}}),S5=le(m5.prototype,"_range",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),le(m5.prototype,"luminousFlux",[a5,s5],Object.getOwnPropertyDescriptor(m5.prototype,"luminousFlux"),m5.prototype),le(m5.prototype,"luminance",[c5,l5],Object.getOwnPropertyDescriptor(m5.prototype,"luminance"),m5.prototype),le(m5.prototype,"term",[u5,h5,f5],Object.getOwnPropertyDescriptor(m5.prototype,"term"),m5.prototype),le(m5.prototype,"size",[_5],Object.getOwnPropertyDescriptor(m5.prototype,"size"),m5.prototype),le(m5.prototype,"range",[p5],Object.getOwnPropertyDescriptor(m5.prototype,"range"),m5.prototype),d5=m5))||d5)||d5)||d5)||d5)),$5=function(t){return e({SpotLight:t,SpotLightComponent:t}),t}((b5=mc("cc.SpotLight"),E5=Oc(),C5=Pc(),A5=bc("_luminance"),w5=Fc(),P5=Vc(),R5=Fc(),I5=Vc(),D5=Zc(X5),O5=Vc(),M5=Fc(),N5=Fc(),L5=Fc(),B5=zc(),F5=Fc(),b5(z5=E5(z5=C5(z5=wc((q5=function(e){function t(){var t;return ce(t=e.call(this)||this,"_size",k5,oe(t)),ce(t,"_luminanceHDR",G5,oe(t)),ce(t,"_luminanceLDR",H5,oe(t)),ce(t,"_term",V5,oe(t)),ce(t,"_range",W5,oe(t)),ce(t,"_spotAngle",j5,oe(t)),t._type=ay.SPOT,t._light=null,t._lightType=RT,t}return $(t,e),t.prototype._createLight=function(){e.prototype._createLight.call(this),this.size=this._size,this.range=this._range,this.spotAngle=this._spotAngle,u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceLDR=this._luminanceHDR*yg.standardExposureValue*yg.standardLightMeterScale:this._luminanceHDR=this._luminanceLDR/yg.standardExposureValue/yg.standardLightMeterScale,this._light&&(this._light.luminanceHDR=this._luminanceHDR,this._light.luminanceLDR=this._luminanceLDR)},Z(t,[{key:"luminousFlux",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR*Sy(this._size):this._luminanceLDR},set:function(e){var t=0;u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e/Sy(this._size),t=this._luminanceHDR):(this._luminanceLDR=e,t=this._luminanceLDR),this._light&&(this._light.luminance=t)}},{key:"luminance",get:function(){return u.director.root.pipeline.pipelineSceneData.isHDR?this._luminanceHDR:this._luminanceLDR},set:function(e){u.director.root.pipeline.pipelineSceneData.isHDR?(this._luminanceHDR=e,this._light&&(this._light.luminanceHDR=this._luminanceHDR)):(this._luminanceLDR=e,this._light&&(this._light.luminanceLDR=this._luminanceLDR))}},{key:"term",get:function(){return this._term},set:function(e){this._term=e}},{key:"size",get:function(){return this._size},set:function(e){this._size=e,this._light&&(this._light.size=e)}},{key:"range",get:function(){return this._range},set:function(e){this._range=e,this._light&&(this._light.range=e)}},{key:"spotAngle",get:function(){return this._spotAngle},set:function(e){this._spotAngle=e,this._light&&(this._light.spotAngle=fn(e))}}]),t}(Q5),k5=le((U5=q5).prototype,"_size",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.15}}),G5=le(U5.prototype,"_luminanceHDR",[Tc,A5],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1700/Sy(.15)}}),H5=le(U5.prototype,"_luminanceLDR",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),V5=le(U5.prototype,"_term",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return X5.LUMINOUS_FLUX}}),W5=le(U5.prototype,"_range",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),j5=le(U5.prototype,"_spotAngle",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),le(U5.prototype,"luminousFlux",[w5,P5],Object.getOwnPropertyDescriptor(U5.prototype,"luminousFlux"),U5.prototype),le(U5.prototype,"luminance",[R5,I5],Object.getOwnPropertyDescriptor(U5.prototype,"luminance"),U5.prototype),le(U5.prototype,"term",[D5,O5,M5],Object.getOwnPropertyDescriptor(U5.prototype,"term"),U5.prototype),le(U5.prototype,"size",[N5],Object.getOwnPropertyDescriptor(U5.prototype,"size"),U5.prototype),le(U5.prototype,"range",[L5],Object.getOwnPropertyDescriptor(U5.prototype,"range"),U5.prototype),le(U5.prototype,"spotAngle",[Hc,B5,F5],Object.getOwnPropertyDescriptor(U5.prototype,"spotAngle"),U5.prototype),z5=U5))||z5)||z5)||z5)||z5));u.LightComponent=Q5,rt.setClassAlias(Q5,"cc.LightComponent"),u.DirectionalLightComponent=Z5,rt.setClassAlias(Z5,"cc.DirectionalLightComponent"),u.SphereLightComponent=J5,rt.setClassAlias(J5,"cc.SphereLightComponent"),u.SpotLightComponent=$5,rt.setClassAlias($5,"cc.SpotLightComponent"),k($5.prototype,"SpotLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),k(J5.prototype,"SphereLight.prototype",[{name:"luminousPower",newName:"luminousFlux",customGetter:function(){return this.luminousFlux},customSetter:function(e){this.luminousFlux=e}}]),k(Q5.PhotometricTerm,"Light.PhotometricTerm",[{name:"LUMINOUS_POWER",newName:"LUMINOUS_FLUX"}]);var e8=function(e,t,n){e[t+0]=n.m00,e[t+1]=n.m01,e[t+2]=n.m02,e[t+3]=n.m12,e[t+4]=n.m04,e[t+5]=n.m05,e[t+6]=n.m06,e[t+7]=n.m13,e[t+8]=n.m08,e[t+9]=n.m09,e[t+10]=n.m10,e[t+11]=n.m14};function t8(e,t){var n=4/Math.sqrt(t);return 12*Math.ceil(Math.max(480*n,e)/12)}new Fn,new Fn,new In,new Fn,new In;var n8=new xr(Ai.POINT,Ai.POINT,Ai.NONE,wi.CLAMP,wi.CLAMP,wi.CLAMP),i8=new In,r8=new In,o8=new In,a8=new In,s8=new jn,c8=new jn,l8=new Xs,u8=Number.MAX_SAFE_INTEGER,h8=function(){function e(e){this._device=void 0,this._pool=void 0,this._textureBuffers=new Map,this._formatSize=void 0,this._pixelsPerJoint=void 0,this._customPool=void 0,this._chunkIdxMap=new Map,this._device=e;var t=function(e){return e.hasFeature(_i.TEXTURE_FLOAT)?pi.RGBA32F:pi.RGBA8}(this._device);this._formatSize=eo[t].size,this._pixelsPerJoint=48/this._formatSize,this._pool=new EK(e),this._pool.initialize({format:t,roundUpFn:t8}),this._customPool=new EK(e),this._customPool.initialize({format:t,roundUpFn:t8})}var t=e.prototype;return t.clear=function(){this._pool.destroy(),this._textureBuffers.clear()},t.registerCustomTextureLayouts=function(e){for(var t=0;t<e.length;t++)for(var n=e[t],i=this._customPool.createChunk(n.textureLength),r=0;r<n.contents.length;r++){var o=n.contents[r],a=o.skeleton;this._chunkIdxMap.set(a,i);for(var s=0;s<o.clips.length;s++){var c=o.clips[s];this._chunkIdxMap.set(a^c,i)}}},t.getDefaultPoseTexture=function(e,t,n){var i=0^e.hash,r=this._textureBuffers.get(i)||null;if(r&&r.bounds.has(t.hash))return r.refCount++,r;var o=e.joints,a=e.bindposes,s=null,c=!1,l=o.length;if(r)r.refCount++;else{var u=12*l,h=this._chunkIdxMap.get(i),f=void 0!==h?this._customPool.alloc(u*Float32Array.BYTES_PER_ELEMENT,h):this._pool.alloc(u*Float32Array.BYTES_PER_ELEMENT);if(!f)return r;r={pixelOffset:f.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:0,readyToBeDeleted:!1,handle:f},s=new Float32Array(u),c=!0}In.set(o8,u8,u8,u8),In.set(a8,-u8,-u8,-u8);for(var _=t.getBoneSpaceBounds(e),p=0,d=0;p<l;p++,d+=12){var m=n.getChildByPath(o[p]),v=m?Mj(m,n,s8):e.inverseBindposes[p],g=_[p];g&&(Xs.transform(l8,g,v),l8.getBoundary(i8,r8),In.min(o8,o8,i8),In.max(a8,a8,r8)),c&&(m&&jn.multiply(v,v,a[p]),e8(s,d,m?v:jn.IDENTITY))}var y=[new Xs];return r.bounds.set(t.hash,y),Xs.fromPoints(y[0],o8,a8),c&&(this._pool.update(r.handle,s.buffer),this._textureBuffers.set(i,r)),r},t.getSequencePoseTexture=function(e,t,n,i){var r=e.hash^t.hash,o=this._textureBuffers.get(r)||null;if(o&&o.bounds.has(n.hash))return o.refCount++,o;var a=e.joints,s=e.bindposes,c=qk.getOrExtract(t).frames,l=null,u=!1,h=a.length;if(o)o.refCount++;else{var f=12*h*c,_=this._chunkIdxMap.get(r),p=void 0!==_?this._customPool.alloc(f*Float32Array.BYTES_PER_ELEMENT,_):this._pool.alloc(f*Float32Array.BYTES_PER_ELEMENT);if(!p)return null;var d=this._createAnimInfos(e,t,i);o={pixelOffset:p.start/this._formatSize,refCount:1,bounds:new Map,skeletonHash:e.hash,clipHash:t.hash,readyToBeDeleted:!1,handle:p,animInfos:d},l=new Float32Array(f),u=!0}var m=n.getBoneSpaceBounds(e),v=[];o.bounds.set(n.hash,v);for(var g=0;g<c;g++)v.push(new Xs(u8,u8,u8,-u8,-u8,-u8));for(var y=0,x=0;y<c;y++){for(var S=v[y],T=0;T<h;T++,x+=12){var b=o.animInfos[T],E=b.curveData,C=b.downstream,A=b.bindposeIdx,w=b.bindposeCorrection,P=void 0,R=!0;E&&C?P=jn.multiply(s8,E[y],C):E?P=E[y]:C?P=C:(P=e.inverseBindposes[A],R=!1);var I=m[T];if(I){var D=w?jn.multiply(c8,P,w):P;Xs.transform(l8,I,D),l8.getBoundary(i8,r8),In.min(S.center,S.center,i8),In.max(S.halfExtents,S.halfExtents,r8)}u&&(R&&jn.multiply(s8,P,s[A]),e8(l,x,R?s8:jn.IDENTITY))}Xs.fromPoints(S,S.center,S.halfExtents)}return u&&(this._pool.update(o.handle,l.buffer),this._textureBuffers.set(r,o)),o},t.releaseHandle=function(e){if(e.refCount>0&&e.refCount--,!e.refCount&&e.readyToBeDeleted){var t=e.skeletonHash^e.clipHash;(void 0!==this._chunkIdxMap.get(t)?this._customPool:this._pool).free(e.handle),this._textureBuffers.get(t)===e&&this._textureBuffers.delete(t)}},t.releaseSkeleton=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.skeletonHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t.releaseAnimationClip=function(e){for(var t=this._textureBuffers.values(),n=t.next();!n.done;){var i=n.value;i.clipHash===e.hash&&(i.readyToBeDeleted=!0,i.refCount?this._textureBuffers.delete(i.skeletonHash^i.clipHash):this.releaseHandle(i)),n=t.next()}},t._createAnimInfos=function(e,t,n){for(var i=[],r=e.joints,o=e.bindposes,a=r.length,s=qk.getOrExtract(t),c=0;c<a;c++){for(var l=r[c],u=s.joints[l],h=n.getChildByPath(l),f=void 0,_=void 0;!u;){var p=l.lastIndexOf("/");if(l=l.substring(0,p),u=s.joints[l],h?(f||(f=new jn),jn.fromRTS(s8,h.rotation,h.position,h.scale),jn.multiply(f,s8,f),h=h.parent):_=l,p<0)break}var d=c,m=void 0;if(void 0!==_&&u){d=c-1;for(var v=0;v<a;v++)if(r[v]===_){d=v,m=new jn,jn.multiply(m,o[v],e.inverseBindposes[c]);break}}i.push({curveData:u&&u.transforms,downstream:f,bindposeIdx:d,bindposeCorrection:m})}return i},Z(e,[{key:"pixelsPerJoint",get:function(){return this._pixelsPerJoint}}]),e}(),f8=function(){function e(e){this._pool=new Map,this._device=void 0,this._device=e}var t=e.prototype;return t.getData=function(e){void 0===e&&(e="-1");var t=this._pool.get(e);if(t)return t;var n=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,Sd.SIZE,Sd.SIZE)),i=new Float32Array([0,0,0,0]);n.update(i);var r={buffer:n,data:i,dirty:!1,currentClip:null};return this._setAnimInfoDirty(r,!1),this._pool.set(e,r),r},t.destroy=function(e){var t=this._pool.get(e);t&&(t.buffer.destroy(),this._pool.delete(e))},t._setAnimInfoDirty=function(e,t){e.dirty=t},t.switchClip=function(e,t){return e.currentClip=t,e.data[0]=-1,e.buffer.update(e.data),this._setAnimInfoDirty(e,!1),e},t.clear=function(){for(var e,t=se(this._pool.values());!(e=t()).done;)e.value.buffer.destroy();this._pool.clear()},e}(),_8=function(){function e(e){this.jointTexturePool=void 0,this.jointAnimationInfo=void 0,this.jointTexturePool=new h8(e),this.jointAnimationInfo=new f8(e)}var t=e.prototype;return t.releaseSkeleton=function(e){this.jointTexturePool.releaseSkeleton(e)},t.releaseAnimationClip=function(e){this.jointTexturePool.releaseAnimationClip(e)},t.clear=function(){this.jointTexturePool.clear(),this.jointAnimationInfo.clear()},e}();u.internal.DataPoolManager=_8;var p8=[{name:"CC_USE_SKINNING",value:!0}];function d8(e,t,n,i){for(var r=0;r<n.length;r++){for(var o=n[r],a=-1,s=0;s<o.length;s++)if(o[s]===i){a=s;break}a>=0&&(t.push(r),e.push(a))}}var m8,v8,g8,y8,x8,S8,T8,b8,E8,C8,A8,w8,P8,R8,I8,D8,O8,M8,N8,L8,B8,F8,z8,U8,k8,G8,H8,V8,W8,j8,q8,X8,Y8,K8,Q8,Z8,J8,$8,e6,t6,n6,i6,r6,o6,a6,s6=new In,c6=new In,l6=new In,u6=new In,h6=new jn,f6=new Xs,_6=function(e){function t(){var t;return(t=e.call(this)||this).uploadAnimation=null,t._buffers=[],t._dataArray=[],t._joints=[],t._bufferIndices=null,t.type=nT.SKINNING,t}$(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){if(this.bindSkeleton(),this._buffers.length){for(var t=0;t<this._buffers.length;t++)this._buffers[t].destroy();this._buffers.length=0}e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null);for(var i=0;i<this._joints.length;i++)Aj(this._joints[i].target);if(this._bufferIndices=null,this._joints.length=0,e&&t&&n){this.transform=t;var r=n.getBoneSpaceBounds(e),o=n.struct.jointMaps;this._ensureEnoughBuffers(o&&o.length||1),this._bufferIndices=n.jointBufferIndices;for(var a=0;a<e.joints.length;a++){var s=r[a],c=t.getChildByPath(e.joints[a]);if(s&&c){var l=Cj(c,t),u=e.bindposes[a],h=[],f=[];o?d8(h,f,o,a):(h.push(a),f.push(0)),this._joints.push({indices:h,buffers:f,bound:s,target:c,bindpose:u,transform:l})}}}},n.updateTransform=function(e){var t=this.transform;(t.hasChangedFlags||t._dirtyFlags)&&(t.updateWorldTransform(),this._localDataUpdated=!0),In.set(s6,1/0,1/0,1/0),In.set(c6,-1/0,-1/0,-1/0);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.bound,o=Ej(i.transform,e);Xs.transform(f6,r,o),f6.getBoundary(l6,u6),In.min(s6,s6,l6),In.max(c6,c6,u6)}var a=this._worldBounds;this._modelBounds&&a&&(Xs.fromPoints(this._modelBounds,s6,c6),this._modelBounds.transform(t._mat,t._pos,t._rot,t._scale,this._worldBounds),this._updateNativeBounds())},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);for(var n=0;n<this._joints.length;n++){var i=this._joints[n],r=i.indices,o=i.buffers,a=i.transform,s=i.bindpose;jn.multiply(h6,a.world,s);for(var c=0;c<o.length;c++)e8(this._dataArray[o[c]],12*r[c],h6)}for(var l=0;l<this._buffers.length;l++)this._buffers[l].update(this._dataArray[l]);return!0},n.initSubModel=function(t,n,i){var r=n.vertexBuffers,o=n.iaInfo;o.vertexBuffers=n.jointMappedBuffers,e.prototype.initSubModel.call(this,t,n,i),o.vertexBuffers=r},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?p8.concat(n):p8},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._buffers[this._bufferIndices[t]];i&&n.bindBuffer(bd.BINDING,i)},n._updateInstancedAttributes=function(t,n){n.batchingScheme!==Iv.NONE&&D(3936,this.node.name),e.prototype._updateInstancedAttributes.call(this,t,n)},n._ensureEnoughBuffers=function(e){for(var t=0;t<e;t++)this._buffers[t]||(this._buffers[t]=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,bd.SIZE,bd.SIZE))),this._dataArray[t]||(this._dataArray[t]=new Float32Array(bd.COUNT))},t}(v3),p6=[{name:"CC_USE_SKINNING",value:!0},{name:"CC_USE_BAKED_ANIMATION",value:!0}],d6=function(e){function t(){var t;(t=e.call(this)||this).uploadedAnim=void 0,t._jointsMedium=void 0,t._skeleton=null,t._mesh=null,t._dataPoolManager=void 0,t._instAnimInfoIdx=-1,t.type=nT.BAKED_SKINNING,t._dataPoolManager=u.director.root.dataPoolManager;var n=new Float32Array(4),i=t._dataPoolManager.jointAnimationInfo.getData();return t._jointsMedium={buffer:null,jointTextureInfo:n,animInfo:i,texture:null,boundsInfo:null},t}$(t,e);var n=t.prototype;return n._init=function(){},n.destroy=function(){this.uploadedAnim=void 0,this._jointsMedium.boundsInfo=null,this._jointsMedium.buffer&&(this._jointsMedium.buffer.destroy(),this._jointsMedium.buffer=null),this._applyJointTexture(),this._applyNativeJointMedium(),e.prototype.destroy.call(this)},n.bindSkeleton=function(e,t,n){if(void 0===e&&(e=null),void 0===t&&(t=null),void 0===n&&(n=null),this._skeleton=e,this._mesh=n,e&&t&&n){this.transform=t;var i=this._dataPoolManager;this._jointsMedium.animInfo=i.jointAnimationInfo.getData(t.uuid),this._jointsMedium.buffer||(this._jointsMedium.buffer=this._device.createBuffer(new _r(vi.UNIFORM|vi.TRANSFER_DST,xi.DEVICE,xd.SIZE,xd.SIZE)))}},n.updateTransform=function(t){if(e.prototype.updateTransform.call(this,t),this.uploadedAnim){var n=this._jointsMedium,i=n.animInfo,r=n.boundsInfo[i.data[0]],o=this._worldBounds;if(o&&r){var a=this.transform;r.transform(a._mat,a._pos,a._rot,a._scale,o)}}},n.updateUBOs=function(t){e.prototype.updateUBOs.call(this,t);var n=this._jointsMedium.animInfo,i=this._instAnimInfoIdx;return i>=0?this.instancedAttributes.views[i][0]=n.data[0]:n.dirty&&(n.buffer.update(n.data),n.dirty=!1),!0},n._applyNativeJointMedium=function(){},n._updateModelBounds=function(e){this._modelBounds=e},n.uploadAnimation=function(e){if(this._skeleton&&this._mesh&&this.uploadedAnim!==e){this.uploadedAnim=e;var t=this._dataPoolManager,n=null;e?(n=t.jointTexturePool.getSequencePoseTexture(this._skeleton,e,this._mesh,this.transform),this._jointsMedium.boundsInfo=n&&n.bounds.get(this._mesh.hash),this._updateModelBounds(null)):(n=t.jointTexturePool.getDefaultPoseTexture(this._skeleton,this._mesh,this.transform),this._jointsMedium.boundsInfo=null,this._updateModelBounds(n&&n.bounds.get(this._mesh.hash)[0])),this._applyJointTexture(n),this._applyNativeJointMedium()}},n._applyJointTexture=function(e){void 0===e&&(e=null);var t=this._jointsMedium.texture;if(t&&t!==e&&this._dataPoolManager.jointTexturePool.releaseHandle(t),this._jointsMedium.texture=e,e){var n=this._jointsMedium,i=n.buffer,r=n.jointTextureInfo;r[0]=e.handle.texture.width,r[1]=this._skeleton.joints.length,r[2]=e.pixelOffset+.1,r[3]=1/r[0],this.updateInstancedJointTextureInfo(),i&&i.update(r);for(var o=e.handle.texture,a=0;a<this._subModels.length;++a)this._subModels[a].descriptorSet.bindTexture(Ad,o)}},n.getMacroPatches=function(t){var n=e.prototype.getMacroPatches.call(this,t);return n?n.concat(p6):p6},n._updateLocalDescriptors=function(t,n){e.prototype._updateLocalDescriptors.call(this,t,n);var i=this._jointsMedium,r=i.buffer,o=i.texture,a=i.animInfo;if(n.bindBuffer(xd.BINDING,r),n.bindBuffer(Sd.BINDING,a.buffer),o){var s=this._device.getSampler(n8);n.bindTexture(Ad,o.handle.texture),n.bindSampler(Ad,s)}},n._setInstAnimInfoIdx=function(e){this._instAnimInfoIdx=e},n._updateInstancedAttributes=function(t,n){e.prototype._updateInstancedAttributes.call(this,t,n),this._setInstAnimInfoIdx(this._getInstancedAttributeIndex(Td)),this.updateInstancedJointTextureInfo()},n.updateInstancedJointTextureInfo=function(){var e=this._jointsMedium,t=e.jointTextureInfo,n=e.animInfo,i=this._instAnimInfoIdx;if(i>=0){var r=this.instancedAttributes.views[i];r[0]=n.data[0],r[1]=t[1],r[2]=t[2]}},t}(v3),m6=function(t){return e({SkinnedMeshRenderer:t,SkinningModelComponent:t}),t}((m8=mc("cc.SkinnedMeshRenderer"),v8=Oc(),g8=gc(100),y8=Pc(),x8=Zc(j3),S8=Zc(qC),T8=Zc(j3),b8=Zc(qC),E8=Fc(),m8(C8=v8(C8=g8(C8=wc(C8=y8((R8=function(e){function t(){var t;return ce(t=e.call(this)||this,"_skeleton",w8,oe(t)),ce(t,"_skinningRoot",P8,oe(t)),t._clip=null,t.associatedAnimation=null,t._modelType=d6,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._tryBindAnimation()},n.onDestroy=function(){this.associatedAnimation&&(this.associatedAnimation.notifySkinnedMeshRemoved(this),this.associatedAnimation),e.prototype.onDestroy.call(this)},n.uploadAnimation=function(e){this._clip=e,this.model&&this.model.uploadAnimation&&this.model.uploadAnimation(e)},n.setUseBakedAnimation=function(e,t){void 0===e&&(e=!0),void 0===t&&(t=!1);var n=e?d6:_6;(t||this._modelType!==n)&&(this._modelType=n,this._model&&(u.director.root.destroyModel(this._model),this._model=null,this._models.length=0,this._updateModels(),this._updateCastShadow(),this.enabledInHierarchy&&this._attachToScene()))},n.setMaterial=function(t,n){e.prototype.setMaterial.call(this,t,n),this._modelType===_6&&this.getMaterialInstance(n)},n._updateModelParams=function(){this._update(),e.prototype._updateModelParams.call(this)},n._tryBindAnimation=function(){var e=this._skinningRoot;if(e){for(var t=!1,n=this.node;n;n=n.parent)if(n===e){t=!0;break}if(t){var i=e.getComponent("cc.SkeletalAnimation");i?i.notifySkinnedMeshAdded(this):this.setUseBakedAnimation(!1)}}},n._update=function(){this.model&&(this.model.bindSkeleton(this._skeleton,this._skinningRoot,this._mesh),this.model.uploadAnimation&&this.model.uploadAnimation(this._clip))},Z(t,[{key:"skeleton",get:function(){return this._skeleton},set:function(e){e!==this._skeleton&&(this._skeleton=e,this._update())}},{key:"skinningRoot",get:function(){return this._skinningRoot},set:function(e){this._skinningRoot=e,this._tryBindAnimation(),e!==this._skinningRoot&&this._update()}},{key:"model",get:function(){return this._model}}]),t}(S3),w8=le((A8=R8).prototype,"_skeleton",[x8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),P8=le(A8.prototype,"_skinningRoot",[S8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(A8.prototype,"skeleton",[T8],Object.getOwnPropertyDescriptor(A8.prototype,"skeleton"),A8.prototype),le(A8.prototype,"skinningRoot",[b8,E8],Object.getOwnPropertyDescriptor(A8.prototype,"skinningRoot"),A8.prototype),C8=A8))||C8)||C8)||C8)||C8)||C8)),v6=new Ir(Zi.ATTR_BATCH_ID,pi.R32F),g6=new Ir(Zi.ATTR_BATCH_UV,pi.RG32F),y6=eo[v6.format].size+eo[g6.format].size,x6=function(t){return e({SkinnedMeshUnit:t,SkinningModelUnit:t}),t}((I8=mc("cc.SkinnedMeshUnit"),D8=Zc(S4),O8=Zc(j3),M8=Zc(ug),N8=Zc(m6),I8((V8=function(){function e(){ce(this,"mesh",F8,this),ce(this,"skeleton",z8,this),ce(this,"material",U8,this),ce(this,"_localTransform",k8,this),ce(this,"_offset",G8,this),ce(this,"_size",H8,this)}return Z(e,[{key:"offset",get:function(){return this._offset},set:function(e){Kn.copy(this._offset,e)}},{key:"size",get:function(){return this._size},set:function(e){Kn.copy(this._size,e)}},{key:"copyFrom",get:function(){return null},set:function(e){e&&(this.mesh=e.mesh,this.skeleton=e.skeleton,this.material=e.getMaterial(0),e.skinningRoot&&Mj(e.node,e.skinningRoot,this._localTransform))}}]),e}(),F8=le((B8=V8).prototype,"mesh",[D8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),z8=le(B8.prototype,"skeleton",[O8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U8=le(B8.prototype,"material",[M8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),k8=le(B8.prototype,"_localTransform",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new jn}}),G8=le(B8.prototype,"_offset",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(0,0)}}),H8=le(B8.prototype,"_size",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(1,1)}}),le(B8.prototype,"offset",[Mc],Object.getOwnPropertyDescriptor(B8.prototype,"offset"),B8.prototype),le(B8.prototype,"size",[Mc],Object.getOwnPropertyDescriptor(B8.prototype,"size"),B8.prototype),le(B8.prototype,"copyFrom",[N8],Object.getOwnPropertyDescriptor(B8.prototype,"copyFrom"),B8.prototype),L8=B8))||L8)),S6=new jn,T6=(new jn,new In),b6=function(t){return e({SkinnedMeshBatchRenderer:t,BatchedSkinningModelComponent:t}),t}((W8=mc("cc.SkinnedMeshBatchRenderer"),j8=Oc(),q8=gc(100),X8=Pc(),Y8=Fc(),K8=Zc([Ft]),Q8=Fc(),Z8=Zc([x6]),J8=Fc(),$8=Nc(),e6=Nc(),W8(t6=j8(t6=q8(t6=wc(t6=X8((a6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"atlasSize",i6,oe(t)),ce(t,"batchableTextureNames",r6,oe(t)),ce(t,"units",o6,oe(t)),t._textures={},t._batchMaterial=null,t}$(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this),this.cook()},n.onDestroy=function(){for(var t in this._textures)this._textures[t].destroy();this._textures={},this._mesh&&(this._mesh.destroy(),this._mesh=null),e.prototype.onDestroy.call(this)},n._onMaterialModified=function(t){this.cookMaterials(),e.prototype._onMaterialModified.call(this,t,this.getMaterialInstance(t))},n.cook=function(){this.cookMaterials(),this.cookSkeletons(),this.cookMeshes()},n.cookMaterials=function(){var e=this;this._batchMaterial||(this._batchMaterial=this.getMaterial(0));var t=this.getMaterialInstance(0);if(t&&this._batchMaterial&&this._batchMaterial.effectAsset){t.copy(this._batchMaterial),this.resizeAtlases();for(var n=t.effectAsset.techniques[t.technique],i=function(i){var r=n.passes[i];if(!r.properties)return"continue";var o=function(n){if(r.properties[n].type>=mi.SAMPLER1D){var o=null;e.batchableTextureNames.find((function(e){return e===n}))?((o=e._textures[n])||(o=e.createTexture(n)),e.cookTextures(o,n,i)):e.units.some((function(e){return o=e.material&&e.material.getProperty(n,i)})),o&&t.setProperty(n,o,i)}else{for(var a=[],s=0;s<e.units.length;s++){var c=e.units[s];c.material&&a.push(c.material.getProperty(n.slice(0,-3),i))}t.setProperty(n,a,i)}};for(var a in r.properties)o(a)},r=0;r<n.passes.length;r++)i(r)}else console.warn("incomplete batch material!")},n.cookSkeletons=function(){if(this._skinningRoot){for(var e=[],t=[],n=0;n<this.units.length;n++){var i=this.units[n];if(i&&i.skeleton){var r=i.skeleton;jn.invert(S6,i._localTransform);for(var o=function(n){var i=r.joints[n];if(e.findIndex((function(e){return e===i}))>=0)return"continue";e.push(i),t.push(jn.multiply(new jn,r.bindposes[n]||jn.IDENTITY,S6))},a=0;a<r.joints.length;a++)o(a)}}var s=Array.from(Array(e.length).keys()).sort((function(t,n){return e[t]>e[n]?1:e[t]<e[n]?-1:0})),c=new j3;c.joints=e.map((function(e,t,n){return n[s[t]]})),c.bindposes=t.map((function(e,t,n){return n[s[t]]})),this._skeleton&&this._skeleton.destroy(),this.skeleton=c}else console.warn("no skinning root specified!")},n.cookMeshes=function(){for(var e=this,t=!1,n=0;n<this.units.length;n++)if(this.units[n].mesh){t=!0;break}if(t&&this._skinningRoot){this._mesh?this._mesh.destroyRenderingMesh():this._mesh=new S4;for(var i=0,r=pi.UNKNOWN,o=0,a=pi.UNKNOWN,s=0,c=pi.UNKNOWN,l=0,u=pi.UNKNOWN,h=0,f=pi.UNKNOWN,_=new Array(this.units.length),p=this.units.length,d=0;d<p;d++){var m=this.units[d];m&&m.skeleton&&(_[d]=m.skeleton.joints.map((function(t){return e._skeleton.joints.findIndex((function(e){return t===e}))})))}for(var v=function(t){var n=e.units[t];if(!n||!n.mesh||!n.mesh.data)return"continue";var p=e._createUnitMesh(t,n.mesh),d=new DataView(p.data.buffer);jn.inverseTranspose(S6,n._localTransform);for(var m=n.offset,v=n.size,g=function(e){var g=p.struct.vertexBundles[e];i=g.view.offset,r=pi.UNKNOWN;for(var y=0;y<g.attributes.length;y++){var x=g.attributes[y];if(x.name===Zi.ATTR_POSITION){r=x.format;break}i+=eo[x.format].size}if(r){for(var S=UA(d,r,i,g.view.length,g.view.stride),T=0;T<S.length;T+=3)In.fromArray(T6,S,T),In.transformMat4(T6,T6,n._localTransform),In.toArray(S,T6,T);zA(d,S,r,i,g.view.stride)}o=g.view.offset,a=pi.UNKNOWN;for(var b=0;b<g.attributes.length;b++){var E=g.attributes[b];if(E.name===Zi.ATTR_NORMAL){a=E.format;break}o+=eo[E.format].size}if(a){for(var C=UA(d,a,o,g.view.length,g.view.stride),A=0;A<C.length;A+=3)In.fromArray(T6,C,A),In.transformMat4Normal(T6,T6,S6),In.toArray(C,T6,A);zA(d,C,a,o,g.view.stride)}s=g.view.offset,c=pi.UNKNOWN;for(var w=0;w<g.attributes.length;w++){var P=g.attributes[w];if(P.name===Zi.ATTR_TANGENT){c=P.format;break}s+=eo[P.format].size}if(c){for(var R=UA(d,c,s,g.view.length,g.view.stride),I=0;I<R.length;I+=3)In.fromArray(T6,R,I),In.transformMat4Normal(T6,T6,S6),In.toArray(R,T6,I);zA(d,R,c,s,g.view.stride)}l=g.view.offset,u=pi.UNKNOWN;for(var D=0;D<g.attributes.length;D++){var O=g.attributes[D];if(O.name===Zi.ATTR_BATCH_UV){u=O.format;break}l+=eo[O.format].size}u&&kA(d,(function(e,t){var n,i=0===t?"x":"y";return(e=(n=e)-Math.floor(n))*v[i]+m[i]}),u,l,g.view.length,g.view.stride,d);var M=_[t];if(!M)return"continue";h=g.view.offset,f=pi.UNKNOWN;for(var N=0;N<g.attributes.length;N++){var L=g.attributes[N];if(L.name===Zi.ATTR_JOINTS){f=L.format;break}h+=eo[L.format].size}f&&kA(d,(function(e){return M[e]}),f,h,g.view.length,g.view.stride,d)},y=0;y<p.struct.vertexBundles.length;y++)g(y);e._mesh.merge(p)},g=0;g<p;g++)v(g);this._onMeshChanged(this._mesh),this._updateModels()}},n.cookTextures=function(e,t,n){for(var i=[],r=[],o=[],a=[],s=0;s<this.units.length;s++){var c=this.units[s];if(c.material){var l=c.material.getProperty(t,n);if(l&&l.image&&l.image.data){var h=new sr;h.texOffset.x=c.offset.x*this.atlasSize,h.texOffset.y=c.offset.y*this.atlasSize,h.texExtent.width=c.size.x*this.atlasSize,h.texExtent.height=c.size.y*this.atlasSize;var f=l.image.data;ArrayBuffer.isView(f)?(o.push(f),a.push(h)):(i.push(f),r.push(h))}}}var _=e.getGFXTexture(),p=u.director.root.device;o.length>0&&p.copyBuffersToTexture(o,_,a),i.length>0&&p.copyTexImagesToTexture(i,_,r)},n.createTexture=function(e){var t=new Cv;return t.setFilters(Lm.LINEAR,Lm.LINEAR),t.setMipFilter(Lm.NEAREST),t.reset({width:this.atlasSize,height:this.atlasSize,format:Mm.RGBA8888}),this._textures[e]=t,t},n.resizeAtlases=function(){for(var e in this._textures)this._textures[e].reset({width:this.atlasSize,height:this.atlasSize,format:Mm.RGBA8888})},n._createUnitMesh=function(e,t){for(var n=JSON.parse(JSON.stringify(t.struct)),i={},r=0;r<t.struct.primitives.length;r++){for(var o=t.struct.primitives[r],a=0,s=pi.UNKNOWN,c=0;c<o.vertexBundelIndices.length;c++){var l=t.struct.vertexBundles[o.vertexBundelIndices[c]];a=l.view.offset,s=pi.UNKNOWN;for(var h=0;h<l.attributes.length;h++){var f=l.attributes[h];if(f.name===Zi.ATTR_TEX_COORD){s=f.format;break}a+=eo[f.format].size}if(s)break}if(void 0===i[c]){i[c]=[s,a];var _=n.vertexBundles[c];_.attributes.push(v6),_.attributes.push(g6),_.view.offset=0,_.view.length+=_.view.count*y6,_.view.stride+=y6}}for(var p=0,d=0;d<n.vertexBundles.length;d++)p+=n.vertexBundles[d].view.length;for(var m=0;m<n.primitives.length;m++){var v=n.primitives[m];v.indexView&&(v.indexView.offset=p,p+=v.indexView.length)}var g=new Uint8Array(p),y=t.data,x=new DataView(g.buffer),S=new DataView(y.buffer),T=u.sys.isLittleEndian;for(var b in i)for(var E=n.vertexBundles[b],C=t.struct.vertexBundles[b],A=i[b],w=UA(S,A[0],A[1],C.view.length,C.view.stride),P=C.view,R=E.view,I=P.stride,D=R.stride,O=P.offset,M=R.offset,N=0;N<R.count;N++){var L=y.subarray(O,O+I);g.set(L,M),x.setFloat32(M+I,e),x.setFloat32(M+I+4,w[2*N],T),x.setFloat32(M+I+8,w[2*N+1],T),M+=D,O+=I}for(var B=0;B<n.primitives.length;B++){var F=t.struct.primitives[B],z=n.primitives[B];if(F.indexView&&z.indexView)for(var U=F.indexView.stride,k=z.indexView.stride,G=F.indexView.offset,H=z.indexView.offset,V=0;V<z.indexView.count;V++){var W=y.subarray(G,G+U);g.set(W,H),H+=k,G+=U}}var j=new S4;return j.reset({struct:n,data:g}),j},Z(t,[{key:"mesh",get:function(){return e.prototype.mesh},set:function(e){this.mesh=e}},{key:"skeleton",get:function(){return e.prototype.skeleton},set:function(e){this.skeleton=e}}]),t}(m6),i6=le((n6=a6).prototype,"atlasSize",[Tc,Y8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1024}}),r6=le(n6.prototype,"batchableTextureNames",[K8,Tc,Q8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),o6=le(n6.prototype,"units",[Z8,Tc,J8],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),le(n6.prototype,"mesh",[sl,$8],Object.getOwnPropertyDescriptor(n6.prototype,"mesh"),n6.prototype),le(n6.prototype,"skeleton",[sl,e6],Object.getOwnPropertyDescriptor(n6.prototype,"skeleton"),n6.prototype),t6=n6))||t6)||t6)||t6)||t6)||t6));u.SkinningModelComponent=m6,rt.setClassAlias(m6,"cc.SkinningModelComponent"),u.SkinningModelUnit=x6,rt.setClassAlias(x6,"cc.SkinningModelUnit"),u.BatchedSkinningModelComponent=b6,rt.setClassAlias(b6,"cc.BatchedSkinningModelComponent");var E6,C6,A6,w6,P6,R6,I6,D6,O6,M6,N6,L6,B6,F6,z6,U6,k6,G6,H6,V6,W6=new jn,j6=new jn,q6=e("SkeletalAnimationState",function(e){function t(t,n){var i;return void 0===n&&(n=""),(i=e.call(this,t,n)||this)._frames=1,i._bakedDuration=0,i._animInfo=null,i._sockets=[],i._animInfoMgr=void 0,i._parent=null,i._curvesInited=!1,i._animInfoMgr=u.director.root.dataPoolManager.jointAnimationInfo,i}$(t,e);var n=t.prototype;return n.initialize=function(t){if(!this._curveLoaded){this._parent=t.getComponent("cc.SkeletalAnimation");var n=this._parent.useBakedAnimation;this._doNotCreateEval=n,e.prototype.initialize.call(this,t),this._curvesInited=!n;var i=qk.getOrExtract(this.clip),r=i.frames,o=i.samples;this._frames=r-1,this._animInfo=this._animInfoMgr.getData(t.uuid),this._bakedDuration=this._frames/o,this.setUseBaked(n)}},n.setUseBaked=function(t){t?(this._sampleCurves=this._sampleCurvesBaked,this.duration=this._bakedDuration):(this._sampleCurves=e.prototype._sampleCurves,this.duration=this.clip.duration,this._curvesInited||(this._curveLoaded=!1,e.prototype.initialize.call(this,this._targetNode),this._curvesInited=!0))},n.rebuildSocketCurves=function(e){if(this._sockets.length=0,this._targetNode)for(var t=this._targetNode,n=0;n<e.length;++n){var i=e[n],r=t.getChildByPath(i.path);if(i.target){for(var o=qk.getOrExtract(this.clip),a=i.path,s=o.joints[a],c=r,l=void 0;!s;){var u=a.lastIndexOf("/");if(a=a.substring(0,u),s=o.joints[a],c&&(l||(l=jn.identity(j6)),jn.fromRTS(W6,c.rotation,c.position,c.scale),jn.multiply(l,W6,l),c=c.parent),u<0)break}for(var h=s&&s.transforms,f=o.frames,_=[],p=0;p<f;p++){var d;d=h&&l?jn.multiply(W6,h[p],l):h?h[p]:l||new jn;var m={pos:new In,rot:new Fn,scale:new In};jn.toRTS(d,m.rot,m.pos,m.scale),_.push(m)}this._sockets.push({target:i.target,frames:_})}}},n._setAnimInfoDirty=function(e,t){e.dirty=t},n._sampleCurvesBaked=function(e){var t=e/this.duration,n=this._animInfo,i=this.clip;n.currentClip!==i&&(this._animInfoMgr.switchClip(this._animInfo,i),this._parent.getUsers().forEach((function(e){e.uploadAnimation(i)})));var r=t*this._frames+.5|0;if(r!==n.data[0]){n.data[0]=r,this._setAnimInfoDirty(n,!0);for(var o=0;o<this._sockets.length;++o){var a=this._sockets[o],s=a.target,c=a.frames[r],l=c.pos,u=c.rot,h=c.scale;s.setRTS(u,l,h)}}},t}(UH)),X6=e("Socket",(E6=mc("cc.SkeletalAnimation.Socket"),C6=Zc(qC),E6((P6=le((w6=function(e,t){void 0===e&&(e=""),void 0===t&&(t=null),ce(this,"path",P6,this),ce(this,"target",R6,this),this.path=e,this.target=t}).prototype,"path",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),R6=le(w6.prototype,"target",[C6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),A6=w6))||A6));rt.setClassAlias(X6,"cc.SkeletalAnimationComponent.Socket");var Y6=new jn,K6=new jn;function Q6(e,t,n){void 0===t&&(t=""),void 0===n&&(n=[]);for(var i=0;i<e.children.length;i++){var r=e.children[i];if(r){var o=t?t+"/"+r.name:r.name;n.push(o),Q6(r,o,n)}}return n}var Z6,J6,$6,e7=function(t){return e({SkeletalAnimation:t,SkeletalAnimationComponent:t}),t}((I6=mc("cc.SkeletalAnimation"),D6=Oc(),O6=gc(99),M6=Pc(),N6=Zc([X6]),L6=Fc(),B6=Fc(),F6=Zc([X6]),I6(z6=D6(z6=O6(z6=wc(z6=M6((V6=H6=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_useBakedAnimation",k6,oe(t)),ce(t,"_sockets",G6,oe(t)),t._users=new Set,t._currentBakedState=null,t}$(t,e);var n=t.prototype;return n.onLoad=function(){e.prototype.onLoad.call(this);for(var t=this.node.getComponentsInChildren(m6),n=0;n<t.length;++n){var i=t[n];i.skinningRoot===this.node&&this.notifySkinnedMeshAdded(i)}},n.onDestroy=function(){e.prototype.onDestroy.call(this),u.director.root.dataPoolManager.jointAnimationInfo.destroy(this.node.uuid),u.director.getAnimationManager().removeSockets(this.node,this._sockets),this._removeAllUsers()},n.start=function(){this.sockets=this._sockets,this.useBakedAnimation=this._useBakedAnimation,e.prototype.start.call(this)},n.pause=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.pause():e.prototype.pause.call(this)},n.resume=function(){var t;this._useBakedAnimation?null===(t=this._currentBakedState)||void 0===t||t.resume():e.prototype.resume.call(this)},n.stop=function(){this._useBakedAnimation?this._currentBakedState&&(this._currentBakedState.stop(),this._currentBakedState=null):e.prototype.stop.call(this)},n.querySockets=function(){var e=this._defaultClip&&Object.keys(qk.getOrExtract(this._defaultClip).joints).sort().reduce((function(e,t){return t.startsWith(e[e.length-1])||e.push(t),e}),[])||[];if(!e.length)return["please specify a valid default animation clip first"];for(var t=[],n=0;n<e.length;n++){var i=e[n],r=this.node.getChildByPath(i);r&&(t.push(i),Q6(r,i,t))}return t},n.rebuildSocketAnimations=function(){for(var e,t=se(this._sockets);!(e=t()).done;){var n=e.value,i=this.node.getChildByPath(n.path),r=n.target;i&&r&&(r.name=n.path.substring(n.path.lastIndexOf("/")+1)+" Socket",r.parent=this.node,Mj(i,this.node,Y6),jn.fromRTS(K6,r.rotation,r.position,r.scale),jn.equals(K6,Y6)||(r.matrix=Y6))}for(var o=0,a=Object.keys(this._nameToState);o<a.length;o++){var s=a[o];this._nameToState[s].rebuildSocketCurves(this._sockets)}},n.createSocket=function(e){var t=this._sockets.find((function(t){return t.path===e}));if(t)return t.target;if(!this.node.getChildByPath(e))return console.warn("illegal socket path"),null;var n=new qC;return n.parent=this.node,this._sockets.push(new X6(e,n)),this.rebuildSocketAnimations(),n},n.notifySkinnedMeshAdded=function(e){var t=this._useBakedAnimation,n=e.associatedAnimation;if(n&&n._users.delete(e),e.associatedAnimation=this,e.setUseBakedAnimation(t,!0),t){var i=this._currentBakedState;i&&e.uploadAnimation(i.clip)}this._users.add(e)},n.notifySkinnedMeshRemoved=function(e){e.associatedAnimation,e.setUseBakedAnimation(!1),e.associatedAnimation=null,this._users.delete(e)},n.getUsers=function(){return this._users},n._createState=function(e,t){return new q6(e,t)},n._doCreateState=function(t,n){var i=e.prototype._doCreateState.call(this,t,n);return i.rebuildSocketCurves(this._sockets),i},n.doPlayOrCrossFade=function(t,n){if(this._useBakedAnimation){this._currentBakedState&&this._currentBakedState.stop();var i=t;this._currentBakedState=i,i.play()}else e.prototype.doPlayOrCrossFade.call(this,t,n)},n._removeAllUsers=function(){var e=this;Array.from(this._users).forEach((function(t){e.notifySkinnedMeshRemoved(t)}))},Z(t,[{key:"sockets",get:function(){return this._sockets},set:function(e){if(!this._useBakedAnimation){var t=u.director.getAnimationManager();t.removeSockets(this.node,this._sockets),t.addSockets(this.node,e)}this._sockets=e,this.rebuildSocketAnimations()}},{key:"useBakedAnimation",get:function(){return this._useBakedAnimation},set:function(e){for(var t in this._useBakedAnimation=e,this._nameToState)this._nameToState[t].setUseBaked(e);this._users.forEach((function(t){t.setUseBakedAnimation(e)})),this._useBakedAnimation?u.director.getAnimationManager().removeSockets(this.node,this._sockets):(u.director.getAnimationManager().addSockets(this.node,this._sockets),this._currentBakedState=null)}}]),t}(vj),H6.Socket=X6,le((U6=V6).prototype,"sockets",[N6,L6],Object.getOwnPropertyDescriptor(U6.prototype,"sockets"),U6.prototype),le(U6.prototype,"useBakedAnimation",[B6],Object.getOwnPropertyDescriptor(U6.prototype,"useBakedAnimation"),U6.prototype),k6=le(U6.prototype,"_useBakedAnimation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G6=le(U6.prototype,"_sockets",[F6],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),z6=U6))||z6)||z6)||z6)||z6)||z6));u.SkeletalAnimationComponent=e7,rt.setClassAlias(e7,"cc.SkeletalAnimationComponent"),u.utils=I4,function(e){e.PLAYED="play",e.PAUSED="pause",e.STOPPED="stop",e.SEEKED="seeked",e.ENDED="ended",e.INTERRUPTION_BEGIN="interruptionBegin",e.INTERRUPTION_END="interruptionEnd",e.USER_GESTURE="on_gesture"}(Z6||(Z6={})),function(e){e[e.DOM_AUDIO=0]="DOM_AUDIO",e[e.WEB_AUDIO=1]="WEB_AUDIO",e[e.MINIGAME_AUDIO=2]="MINIGAME_AUDIO",e[e.NATIVE_AUDIO=3]="NATIVE_AUDIO",e[e.UNKNOWN_AUDIO=4]="UNKNOWN_AUDIO"}(J6||(J6={})),function(e){e[e.INIT=0]="INIT",e[e.PLAYING=1]="PLAYING",e[e.PAUSED=2]="PAUSED",e[e.STOPPED=3]="STOPPED",e[e.INTERRUPTED=4]="INTERRUPTED"}($6||($6={}));var t7,n7=0;function i7(e,t){var n;t.invoking||(t.invoking=!0,(n=t.func).call.apply(n,[e].concat(t.args)).then((function(){t.invoking=!1,e._operationQueue.shift(),e._eventTarget.emit(t.id.toString());var n=e._operationQueue[0];n&&i7(e,n)})).catch((function(){})))}function r7(e,t,n){var i=n.value;n.value=function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];return new Promise((function(t){var r=n7++,o=e;o._operationQueue.push({id:r,func:i,args:n,invoking:!1}),o._eventTarget.once(r.toString(),t),i7(o,o._operationQueue[0])}))}}function o7(e){return new Promise((function(t){var n=e.play();return void 0===n?t():(n.then(t).catch((function(){var n=function(){e.play().catch((function(){})),t()},i=document.getElementById("GameCanvas");null==i||i.addEventListener("touchend",n,{once:!0}),null==i||i.addEventListener("mousedown",n,{once:!0})})),null)}))}var a7,s7,c7=function(){function e(e,t){this._domAudio=void 0,this._onPlayCb=void 0,this._onEndCb=void 0,this._domAudio=e,e.volume=t}var t=e.prototype;return t.play=function(){var e=this;o7(this._domAudio).then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e)})).catch((function(){}))},t.stop=function(){this._domAudio.pause()},Z(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb&&this._domAudio.removeEventListener("ended",this._onEndCb),this._onEndCb=e,e&&this._domAudio.addEventListener("ended",e)}}]),e}(),l7=(le((t7=function(){function e(e){var t=this;this._domAudio=void 0,this._state=$6.INIT,this._onEnded=void 0,this._eventTarget=new iu,this._operationQueue=[],this._domAudio=e,vu.on("hide",this._onHide,this),vu.on("show",this._onShow,this),this._onEnded=function(){t.seek(0).catch((function(){})),t._state=$6.INIT,t._eventTarget.emit(Z6.ENDED)},this._domAudio.addEventListener("ended",this._onEnded)}var t=e.prototype;return t.destroy=function(){vu.off("hide",this._onHide,this),vu.off("show",this._onShow,this),this._domAudio.removeEventListener("ended",this._onEnded),this._domAudio=null},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(t){n(new e(t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=document.createElement("audio"),r="canplaythrough";vu.os===cu.IOS?r="loadedmetadata":vu.browserType===ou.FIREFOX&&(r="canplay");var o=setTimeout((function(){0===i.readyState?c():s()}),8e3),a=function(){clearTimeout(o),i.removeEventListener(r,s,!1),i.removeEventListener("error",c,!1)},s=function(){a(),t(i)},c=function(){a(),n("load audio failure - "+e)};i.addEventListener(r,s,!1),i.addEventListener("error",c,!1),i.src=e}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var t=new c7(e,n);i(t)})).catch(r)}))},t._onHide=function(){var e=this;this._state===$6.PLAYING&&this.pause().then((function(){e._state=$6.INTERRUPTED,e._eventTarget.emit(Z6.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===$6.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(Z6.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){return e=ln(e,0,this.duration),this._domAudio.currentTime=e,Promise.resolve()},t.play=function(){var e=this;return new Promise((function(t){o7(e._domAudio).then((function(){e._state=$6.PLAYING,t()})).catch((function(){}))}))},t.pause=function(){return this._domAudio.pause(),this._state=$6.PAUSED,Promise.resolve()},t.stop=function(){var e=this;return new Promise((function(t){e._domAudio.pause(),e._domAudio.currentTime=0,e._state=$6.STOPPED,t()}))},t.onInterruptionBegin=function(e){this._eventTarget.on(Z6.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(Z6.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(Z6.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(Z6.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(Z6.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(Z6.ENDED,e)},Z(e,[{key:"src",get:function(){return this._domAudio?this._domAudio.src:""}},{key:"type",get:function(){return J6.DOM_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._domAudio.loop},set:function(e){this._domAudio.loop=e}},{key:"volume",get:function(){return this._domAudio.volume},set:function(e){e=un(e),this._domAudio.volume=e}},{key:"duration",get:function(){return this._domAudio.duration}},{key:"currentTime",get:function(){return this._domAudio.currentTime}}]),e}()).prototype,"seek",[r7],Object.getOwnPropertyDescriptor(t7.prototype,"seek"),t7.prototype),le(t7.prototype,"play",[r7],Object.getOwnPropertyDescriptor(t7.prototype,"play"),t7.prototype),le(t7.prototype,"pause",[r7],Object.getOwnPropertyDescriptor(t7.prototype,"pause"),t7.prototype),le(t7.prototype,"stop",[r7],Object.getOwnPropertyDescriptor(t7.prototype,"stop"),t7.prototype),t7),u7=function(){function e(e){this._nativeAudio=void 0,this._startTime=0,this._startOffset=0,this._isPaused=!0,this._nativeAudio=e}var t=e.prototype;return t.destroy=function(){this._nativeAudio=void 0},t._now=function(){return performance.now()/1e3},t._calculateCurrentTime=function(){var e=this._now()-this._startTime,t=this._startOffset+e;return t>=this.duration&&(this._startTime=this._now(),this._startOffset=0),t%this.duration},t.start=function(){this._isPaused=!1,this._startTime=this._now()},t.pause=function(){this._isPaused||(this._isPaused=!0,this._startOffset=this._calculateCurrentTime())},t.stop=function(){this._isPaused=!0,this._startOffset=0},t.seek=function(e){this._startTime=this._now(),this._startOffset=ln(e,0,this.duration)},Z(e,[{key:"duration",get:function(){return this._nativeAudio.duration}},{key:"currentTime",get:function(){return this._isPaused?this._startOffset:this._calculateCurrentTime()}}]),e}(),h7=new(function(){function e(){this._audioBufferDataMap={}}var t=e.prototype;return t.addCache=function(e,t){this._audioBufferDataMap[e]?console.warn("Audio buffer "+e+" has been cached"):this._audioBufferDataMap[e]={usedCount:1,audioBuffer:t}},t.retainCache=function(e){var t=this._audioBufferDataMap[e];t?t.usedCount++:console.warn("Audio buffer cache "+e+" has not been added.")},t.getCache=function(e){var t=this._audioBufferDataMap[e];return null==t?void 0:t.audioBuffer},t.tryReleasingCache=function(e){var t=this._audioBufferDataMap[e];t?--t.usedCount<=0&&delete this._audioBufferDataMap[e]:console.warn("Audio buffer cache "+e+" has not been added.")},e}()),f7=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,_7=function(){function e(){this._context=void 0,this._context=new(window.AudioContext||window.webkitAudioContext||window.mozAudioContext)}var t=e.prototype;return t.decodeAudioData=function(e){var t=this;return new Promise((function(n){var i=t._context.decodeAudioData(e,(function(e){n(e)}),(function(e){console.error("failed to load Web Audio",e)}));null==i||i.catch((function(){}))}))},t.runContext=function(){var e=this;return new Promise((function(t){var n=e._context;if(n.resume)if("running"!==n.state){var i=document.getElementById("GameCanvas"),r=function(){n.resume().then(t).catch((function(){}))};null==i||i.addEventListener("touchend",r,{once:!0,capture:!0}),null==i||i.addEventListener("mouseup",r,{once:!0,capture:!0})}else t();else t()}))},t.createBufferSource=function(e,t){var n=this._context.createBufferSource();return void 0!==e&&(n.buffer=e),void 0!==t&&(n.loop=t),n},t.createGain=function(e){void 0===e&&(e=1);var t=this._context.createGain();return this.setGainValue(t,e),t},t.setGainValue=function(e,t){if(e.gain.setTargetAtTime)try{e.gain.setTargetAtTime(t,this._context.currentTime,0)}catch(n){e.gain.setTargetAtTime(t,this._context.currentTime,.01)}else e.gain.value=t},t.connectContext=function(e){this._context&&e.connect(this._context.destination)},Z(e,[{key:"currentTime",get:function(){return this._context.currentTime}}]),e}();_7.support=!!f7,_7.support&&(s7=new _7);var p7,d7,m7,v7,g7,y7=function(){function e(e,t,n){this._duration=void 0,this._bufferSourceNode=void 0,this._onPlayCb=void 0,this._currentTimer=0,this._url=void 0,this._onEndCb=void 0,this._duration=e.duration,this._url=n,this._bufferSourceNode=s7.createBufferSource(e,!1);var i=s7.createGain(t);this._bufferSourceNode.connect(i),s7.connectContext(i)}var t=e.prototype;return t.play=function(){var e=this;this._bufferSourceNode.start(),s7.runContext().then((function(){var t;null===(t=e.onPlay)||void 0===t||t.call(e),e._currentTimer=window.setTimeout((function(){var t;h7.tryReleasingCache(e._url),null===(t=e.onEnd)||void 0===t||t.call(e)}),1e3*e._duration)})).catch((function(){}))},t.stop=function(){clearTimeout(this._currentTimer),h7.tryReleasingCache(this._url),this._bufferSourceNode.stop(),this._bufferSourceNode.buffer=null},Z(e,[{key:"onPlay",get:function(){return this._onPlayCb},set:function(e){this._onPlayCb=e}},{key:"onEnd",get:function(){return this._onEndCb},set:function(e){this._onEndCb=e}}]),e}(),x7=(le((a7=function(){function e(e,t){this._src=void 0,this._audioBuffer=void 0,this._sourceNode=void 0,this._gainNode=void 0,this._currentTimer=0,this._volume=1,this._loop=!1,this._state=$6.INIT,this._audioTimer=void 0,this._eventTarget=new iu,this._operationQueue=[],this._audioBuffer=e,this._audioTimer=new u7(e),this._gainNode=s7.createGain(),s7.connectContext(this._gainNode),this._src=t,vu.on("hide",this._onHide,this),vu.on("show",this._onShow,this)}var t=e.prototype;return t.destroy=function(){this._audioTimer.destroy(),this._audioBuffer&&(this._audioBuffer=null),h7.tryReleasingCache(this._src),vu.off("hide",this._onHide,this),vu.off("show",this._onShow,this)},e.load=function(t){return new Promise((function(n){e.loadNative(t).then((function(i){n(new e(i,t))})).catch((function(){}))}))},e.loadNative=function(e){return new Promise((function(t,n){var i=h7.getCache(e);if(i)return h7.retainCache(e),void t(i);var r=new XMLHttpRequest,o="load audio failed: "+e+", status: ";r.open("GET",e,!0),r.responseType="arraybuffer",r.onload=function(){200===r.status||0===r.status?s7.decodeAudioData(r.response).then((function(n){h7.addCache(e,n),t(n)})).catch((function(){})):n(new Error(""+o+r.status+"(no response)"))},r.onerror=function(){n(new Error(""+o+r.status+"(error)"))},r.ontimeout=function(){n(new Error(""+o+r.status+"(time out)"))},r.onabort=function(){n(new Error(""+o+r.status+"(abort)"))},r.send(null)}))},e.loadOneShotAudio=function(t,n){return new Promise((function(i,r){e.loadNative(t).then((function(e){var r=new y7(e,n,t);i(r)})).catch(r)}))},t._onHide=function(){var e=this;this._state===$6.PLAYING&&this.pause().then((function(){e._state=$6.INTERRUPTED,e._eventTarget.emit(Z6.INTERRUPTION_BEGIN)})).catch((function(){}))},t._onShow=function(){var e=this;this._state===$6.INTERRUPTED&&this.play().then((function(){e._eventTarget.emit(Z6.INTERRUPTION_END)})).catch((function(){}))},t.seek=function(e){var t=this;return new Promise((function(n){t._audioTimer.seek(e),t._state===$6.PLAYING?t._doPlay().then(n).catch((function(){})):n()}))},t.play=function(){return this._doPlay()},t._doPlay=function(){var e=this;return new Promise((function(t){e._stopSourceNode(),e._sourceNode=s7.createBufferSource(e._audioBuffer,e.loop),e._sourceNode.connect(e._gainNode),e._sourceNode.start(0,e._audioTimer.currentTime),s7.runContext().then((function(){e._state=$6.PLAYING,e._audioTimer.start(),window.clearTimeout(e._currentTimer),e._currentTimer=window.setTimeout((function t(){e.loop?e._currentTimer=window.setTimeout(t,1e3*e._audioBuffer.duration):(e._audioTimer.stop(),e._eventTarget.emit(Z6.ENDED),e._state=$6.INIT)}),1e3*(e._audioBuffer.duration-e._audioTimer.currentTime)),t()})).catch((function(){}))}))},t._stopSourceNode=function(){try{this._sourceNode&&(this._sourceNode.stop(),this._sourceNode.buffer=null)}catch(e){}},t.pause=function(){return this._state===$6.PLAYING&&this._sourceNode?(this._audioTimer.pause(),this._state=$6.PAUSED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.stop=function(){return this._sourceNode?(this._audioTimer.stop(),this._state=$6.STOPPED,window.clearTimeout(this._currentTimer),this._stopSourceNode(),Promise.resolve()):Promise.resolve()},t.onInterruptionBegin=function(e){this._eventTarget.on(Z6.INTERRUPTION_BEGIN,e)},t.offInterruptionBegin=function(e){this._eventTarget.off(Z6.INTERRUPTION_BEGIN,e)},t.onInterruptionEnd=function(e){this._eventTarget.on(Z6.INTERRUPTION_END,e)},t.offInterruptionEnd=function(e){this._eventTarget.off(Z6.INTERRUPTION_END,e)},t.onEnded=function(e){this._eventTarget.on(Z6.ENDED,e)},t.offEnded=function(e){this._eventTarget.off(Z6.ENDED,e)},Z(e,[{key:"src",get:function(){return this._src}},{key:"type",get:function(){return J6.WEB_AUDIO}},{key:"state",get:function(){return this._state}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._sourceNode&&(this._sourceNode.loop=e)}},{key:"volume",get:function(){return this._volume},set:function(e){e=un(e),this._volume=e,s7.setGainValue(this._gainNode,e)}},{key:"duration",get:function(){return this._audioBuffer.duration}},{key:"currentTime",get:function(){return this._audioTimer.currentTime}}]),e}()).prototype,"seek",[r7],Object.getOwnPropertyDescriptor(a7.prototype,"seek"),a7.prototype),le(a7.prototype,"play",[r7],Object.getOwnPropertyDescriptor(a7.prototype,"play"),a7.prototype),le(a7.prototype,"pause",[r7],Object.getOwnPropertyDescriptor(a7.prototype,"pause"),a7.prototype),le(a7.prototype,"stop",[r7],Object.getOwnPropertyDescriptor(a7.prototype,"stop"),a7.prototype),a7),S7=function(){function e(e){this._audio=void 0,this._audio=e}var t=e.prototype;return t.play=function(){this._audio.play()},t.stop=function(){this._audio.stop()},Z(e,[{key:"onPlay",get:function(){return this._audio.onPlay},set:function(e){this._audio.onPlay=e}},{key:"onEnd",get:function(){return this._audio.onEnd},set:function(e){this._audio.onEnd=e}}]),e}(),T7=function(){function e(e){this._player=void 0,this._player=e}e.load=function(t,n){return new Promise((function(i){(null==n?void 0:n.audioLoadMode)!==J6.DOM_AUDIO&&_7.support?x7.load(t).then((function(t){i(new e(t))})).catch((function(){})):(_7.support||D(5201),l7.load(t).then((function(t){i(new e(t))})).catch((function(){})))}))};var t=e.prototype;return t.destroy=function(){this._player.destroy()},e.loadNative=function(e,t){return(null==t?void 0:t.audioLoadMode)!==J6.DOM_AUDIO&&_7.support?x7.loadNative(e):(_7.support||D(5201),l7.loadNative(e))},e.loadOneShotAudio=function(e,t,n){return new Promise((function(i,r){(null==n?void 0:n.audioLoadMode)!==J6.DOM_AUDIO&&_7.support?x7.loadOneShotAudio(e,t).then((function(e){i(new S7(e))})).catch(r):(_7.support||D(5201),l7.loadOneShotAudio(e,t).then((function(e){i(new S7(e))})).catch(r))}))},t.seek=function(e){return this._player.seek(e)},t.play=function(){return this._player.play()},t.pause=function(){return this._player.pause()},t.stop=function(){return this._player.stop()},t.onInterruptionBegin=function(e){this._player.onInterruptionBegin(e)},t.offInterruptionBegin=function(e){this._player.offInterruptionBegin(e)},t.onInterruptionEnd=function(e){this._player.onInterruptionEnd(e)},t.offInterruptionEnd=function(e){this._player.offInterruptionEnd(e)},t.onEnded=function(e){this._player.onEnded(e)},t.offEnded=function(e){this._player.offEnded(e)},Z(e,[{key:"src",get:function(){return this._player.src}},{key:"type",get:function(){return this._player.type}},{key:"state",get:function(){return this._player.state}},{key:"loop",get:function(){return this._player.loop},set:function(e){this._player.loop=e}},{key:"volume",get:function(){return this._player.volume},set:function(e){this._player.volume=e}},{key:"duration",get:function(){return this._player.duration}},{key:"currentTime",get:function(){return this._player.currentTime}}]),e}();T7.maxAudioChannel=24;var b7=e("AudioClip",mc("cc.AudioClip")((g7=v7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_duration",m7,oe(t)),t._loadMode=J6.UNKNOWN_AUDIO,t._meta=null,t._player=null,t}$(t,e);var n=t.prototype;return n.destroy=function(){var t,n=e.prototype.destroy.call(this);return null===(t=this._player)||void 0===t||t.destroy(),this._player=null,this._meta&&(this._meta.player=null),n},n.validate=function(){return!!this._meta},n.getDuration=function(){return this._duration?this._duration:this._meta?this._meta.duration:0},n.getCurrentTime=function(){return this._player?this._player.currentTime:0},n.getVolume=function(){return this._player?this._player.volume:0},n.getLoop=function(){return!!this._player&&this._player.loop},n.setCurrentTime=function(e){var t;null===(t=this._player)||void 0===t||t.seek(e).catch((function(){}))},n.setVolume=function(e){this._player&&(this._player.volume=e)},n.setLoop=function(e){this._player&&(this._player.loop=e)},n.play=function(){var e;null===(e=this._player)||void 0===e||e.play().catch((function(){}))},n.pause=function(){var e;null===(e=this._player)||void 0===e||e.pause().catch((function(){}))},n.stop=function(){var e;null===(e=this._player)||void 0===e||e.stop().catch((function(){}))},n.playOneShot=function(e){void 0===e&&(e=1),this._nativeAsset&&T7.loadOneShotAudio(this._nativeAsset.url,e).then((function(e){e.play()})).catch((function(){}))},Z(t,[{key:"_nativeAsset",get:function(){return this._meta},set:function(e){this._meta=e,e?(this._loadMode=e.type,this._player=e.player):(this._meta=null,this._loadMode=J6.UNKNOWN_AUDIO,this._duration=0)}},{key:"_nativeDep",get:function(){return{uuid:this._uuid,audioLoadMode:this.loadMode,ext:this._native,__isNative__:!0}}},{key:"loadMode",get:function(){return this._loadMode}},{key:"state",get:function(){return this._player?this._player.state:$6.INIT}}]),t}(Nu),v7.AudioType=J6,m7=le((d7=g7).prototype,"_duration",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(d7.prototype,"_nativeDep",[sl],Object.getOwnPropertyDescriptor(d7.prototype,"_nativeDep"),d7.prototype),p7=d7))||p7);function E7(e,t,n){T7.load(e,{audioLoadMode:t.audioLoadMode}).then((function(t){var i={player:t,url:e,duration:t.duration,type:t.type};n(null,i)})).catch((function(e){n(e)}))}function C7(e,t,n,i){var r=new b7;r._nativeUrl=e,r._nativeAsset=t,r._duration=t.duration,i(null,r)}u.AudioClip=b7,LN.register({".mp3":E7,".ogg":E7,".wav":E7,".m4a":E7}),HN.register({".mp3":C7,".ogg":C7,".wav":C7,".m4a":C7});var A7,w7,P7,R7,I7,D7,O7,M7,N7,L7,B7,F7,z7,U7,k7,G7,H7,V7,W7,j7=new(function(){function e(){this._oneShotAudioInfoList=[],this._audioPlayerInfoList=[]}var t=e.prototype;return t._findIndex=function(e,t){return e.findIndex((function(e){return e.audio===t}))},t._tryAddPlaying=function(e,t){var n=this._findIndex(e,t);return n>-1?(e[n].playTime=performance.now(),!1):(e.push({audio:t,playTime:performance.now()}),!0)},t.addPlaying=function(e){if(e instanceof T7){if(this._tryAddPlaying(this._audioPlayerInfoList,e))return}else this._tryAddPlaying(this._oneShotAudioInfoList,e)},t._tryRemovePlaying=function(e,t){var n=this._findIndex(e,t);return-1!==n&&(fe(e,n),!0)},t.removePlaying=function(e){if(e instanceof T7){if(this._tryRemovePlaying(this._audioPlayerInfoList,e))return}else this._tryRemovePlaying(this._oneShotAudioInfoList,e)},t.discardOnePlayingIfNeeded=function(){var e;this._audioPlayerInfoList.length+this._oneShotAudioInfoList.length<T7.maxAudioChannel||(this._oneShotAudioInfoList.length>0?this._oneShotAudioInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})):this._audioPlayerInfoList.forEach((function(t){(!e||t.playTime<e.playTime)&&(e=t)})),e&&(e.audio.stop(),this.removePlaying(e.audio)))},e}());!function(e){e.STARTED="started",e.ENDED="ended"}(W7||(W7={}));var q7=function(t){return e({AudioSource:t,AudioSourceComponent:t}),t}((A7=mc("cc.AudioSource"),w7=Oc(),P7=Pc(),R7=Zc(b7),I7=Zc(b7),D7=Fc(),O7=Fc(),M7=Fc(),N7=zc(),L7=Fc(),A7(B7=w7(B7=P7((V7=H7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_clip",z7,oe(t)),t._player=null,ce(t,"_loop",U7,oe(t)),ce(t,"_playOnAwake",k7,oe(t)),ce(t,"_volume",G7,oe(t)),t._cachedCurrentTime=0,t._operationsBeforeLoading=[],t._isLoaded=!1,t._lastSetClip=null,t}$(t,e);var n=t.prototype;return n._syncPlayer=function(){var e=this,t=this._clip;this._isLoaded=!1,this._lastSetClip!==t&&(t?t._nativeAsset?(this._lastSetClip=t,T7.load(t._nativeAsset.url,{audioLoadMode:t.loadMode}).then((function(n){e._lastSetClip===t?(e._isLoaded=!0,e._player&&(e._player.offEnded(),e._player.offInterruptionBegin(),e._player.offInterruptionEnd(),e._player.destroy()),e._player=n,n.onEnded((function(){j7.removePlaying(n),e.node.emit(W7.ENDED,e)})),n.onInterruptionBegin((function(){j7.removePlaying(n)})),n.onInterruptionEnd((function(){j7.addPlaying(n)})),e._syncStates()):n.destroy()})).catch((function(){}))):console.error("Invalid audio clip"):this._lastSetClip=null)},n.onLoad=function(){this._syncPlayer()},n.onEnable=function(){this._playOnAwake&&!this.playing&&this.play()},n.onDisable=function(){var e=this._getRootNode();(null==e?void 0:e._persistNode)||this.pause()},n.onDestroy=function(){var e;this.stop(),null===(e=this._player)||void 0===e||e.destroy(),this._player=null},n._getRootNode=function(){for(var e,t,n=this.node,i=null===(e=n)||void 0===e||null===(t=e.parent)||void 0===t?void 0:t.parent;i;){var r,o,a;i=null===(o=n=null===(r=n)||void 0===r?void 0:r.parent)||void 0===o||null===(a=o.parent)||void 0===a?void 0:a.parent}return n},n.play=function(){var e,t,n=this;this._isLoaded?(j7.discardOnePlayingIfNeeded(),this.state===$6.PLAYING&&(null===(t=this._player)||void 0===t||t.stop().catch((function(){}))),null===(e=this._player)||void 0===e||e.play().then((function(){j7.addPlaying(n._player),n.node.emit(W7.STARTED,n)})).catch((function(){}))):this._operationsBeforeLoading.push("play")},n.pause=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.pause().then((function(){j7.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("pause")},n.stop=function(){var e,t=this;this._isLoaded?null===(e=this._player)||void 0===e||e.stop().then((function(){j7.removePlaying(t._player)})).catch((function(){})):this._operationsBeforeLoading.push("stop")},n.playOneShot=function(e,t){void 0===t&&(t=1),e._nativeAsset?T7.loadOneShotAudio(e._nativeAsset.url,this._volume*t,{audioLoadMode:e.loadMode}).then((function(e){j7.discardOnePlayingIfNeeded(),e.onPlay=function(){j7.addPlaying(e)},e.onEnd=function(){j7.removePlaying(e)},e.play()})).catch((function(){})):console.error("Invalid audio clip")},n._syncStates=function(){var e=this;this._player&&this._player.seek(this._cachedCurrentTime).then((function(){e._player&&(e._player.loop=e._loop,e._player.volume=e._volume,e._operationsBeforeLoading.forEach((function(t){var n;null===(n=e[t])||void 0===n||n.call(e)})),e._operationsBeforeLoading.length=0)})).catch((function(){}))},Z(t,[{key:"clip",get:function(){return this._clip},set:function(e){e!==this._clip&&(this._clip=e,this._syncPlayer())}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._player&&(this._player.loop=e)}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"volume",get:function(){return this._volume},set:function(e){Number.isNaN(e)?console.warn("illegal audio volume!"):(e=ln(e,0,1),this._player?(this._player.volume=e,this._volume=this._player.volume):this._volume=e)}},{key:"currentTime",get:function(){return this._player?this._player.currentTime:this._cachedCurrentTime},set:function(e){var t;Number.isNaN(e)?console.warn("illegal audio time!"):(e=ln(e,0,this.duration),this._cachedCurrentTime=e,null===(t=this._player)||void 0===t||t.seek(this._cachedCurrentTime).catch((function(){})))}},{key:"duration",get:function(){var e,t;return null!==(e=null===(t=this._clip)||void 0===t?void 0:t.getDuration())&&void 0!==e?e:this._player?this._player.currentTime:0}},{key:"state",get:function(){return this._player?this._player.state:$6.INIT}},{key:"playing",get:function(){return this.state===t.AudioState.PLAYING}}],[{key:"maxAudioChannel",get:function(){return T7.maxAudioChannel}}]),t}(th),H7.AudioState=$6,H7.EventType=W7,z7=le((F7=V7).prototype,"_clip",[R7],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),U7=le(F7.prototype,"_loop",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),k7=le(F7.prototype,"_playOnAwake",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),G7=le(F7.prototype,"_volume",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),le(F7.prototype,"clip",[I7,D7],Object.getOwnPropertyDescriptor(F7.prototype,"clip"),F7.prototype),le(F7.prototype,"loop",[O7],Object.getOwnPropertyDescriptor(F7.prototype,"loop"),F7.prototype),le(F7.prototype,"playOnAwake",[M7],Object.getOwnPropertyDescriptor(F7.prototype,"playOnAwake"),F7.prototype),le(F7.prototype,"volume",[N7,L7],Object.getOwnPropertyDescriptor(F7.prototype,"volume"),F7.prototype),B7=F7))||B7)||B7)||B7));k(b7,"AudioClip",[{name:"PlayingState",newName:"AudioState",target:q7,targetName:"AudioSource"}]),H(b7.prototype,"AudioClip.prototype",["state","play","pause","stop","playOneShot","setCurrentTime","setVolume","setLoop","getCurrentTime","getVolume","getLoop"].map((function(e){return{name:e,suggest:"please use AudioSource.prototype."+e+" instead"}}))),u.AudioSourceComponent=q7,rt.setClassAlias(q7,"cc.AudioSourceComponent"),u.log=x,u.warn=S,u.error=T,u.assert=b,u._throw=A,u.logID=R,u.warnID=D,u.errorID=M,u.assertID=B,u.debug=q,u.path={join:Su,extname:Tu,mainFileName:bu,basename:Eu,dirname:Cu,changeExtname:Au,changeBasename:wu,_normalize:Pu,stripSep:Ru,get sep(){return Iu()}};var X7=e("NodePool",function(){function e(e){this.poolHandlerComp=void 0,this._pool=void 0,this.poolHandlerComp=e,this._pool=[]}var t=e.prototype;return t.size=function(){return this._pool.length},t.clear=function(){for(var e=this._pool.length,t=0;t<e;++t)this._pool[t].destroy();this._pool.length=0},t.put=function(e){if(e&&-1===this._pool.indexOf(e)){e.removeFromParent();var t=this.poolHandlerComp?e.getComponent(this.poolHandlerComp):null;t&&t.unuse&&t.unuse(),this._pool.push(e)}},t.get=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var i=this._pool.length-1;if(i<0)return null;var r=this._pool[i];this._pool.length=i;var o=this.poolHandlerComp?r.getComponent(this.poolHandlerComp):null;return o&&o.reuse&&o.reuse(arguments),r},e}());u.NodePool=X7,u.renderer=AK;var Y7,K7=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)if(e[t].type&to){var n=this._buffers[t];n&&(e[t].gpuBuffer=n.gpuBuffer||n.gpuBufferView)}else e[t].type&no&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},Z(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(To);!function(e){e[e.RGBA16F_EXT=34842]="RGBA16F_EXT",e[e.RGB16F_EXT=34843]="RGB16F_EXT",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(Y7||(Y7={}));var Q7=function(){function e(){}return e.setInstance=function(t){e._instance=t},Z(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();function Z7(e,t){switch(e){case pi.R8:return t.UNSIGNED_BYTE;case pi.R8SN:return t.BYTE;case pi.R8UI:return t.UNSIGNED_BYTE;case pi.R8I:return t.BYTE;case pi.R16F:return Y7.HALF_FLOAT_OES;case pi.R16UI:return t.UNSIGNED_SHORT;case pi.R16I:return t.SHORT;case pi.R32F:return t.FLOAT;case pi.R32UI:return t.UNSIGNED_INT;case pi.R32I:return t.INT;case pi.RG8:return t.UNSIGNED_BYTE;case pi.RG8SN:return t.BYTE;case pi.RG8UI:return t.UNSIGNED_BYTE;case pi.RG8I:return t.BYTE;case pi.RG16F:return Y7.HALF_FLOAT_OES;case pi.RG16UI:return t.UNSIGNED_SHORT;case pi.RG16I:return t.SHORT;case pi.RG32F:return t.FLOAT;case pi.RG32UI:return t.UNSIGNED_INT;case pi.RG32I:return t.INT;case pi.RGB8:case pi.SRGB8:return t.UNSIGNED_BYTE;case pi.RGB8SN:return t.BYTE;case pi.RGB8UI:return t.UNSIGNED_BYTE;case pi.RGB8I:return t.BYTE;case pi.RGB16F:return Y7.HALF_FLOAT_OES;case pi.RGB16UI:return t.UNSIGNED_SHORT;case pi.RGB16I:return t.SHORT;case pi.RGB32F:return t.FLOAT;case pi.RGB32UI:return t.UNSIGNED_INT;case pi.RGB32I:return t.INT;case pi.BGRA8:case pi.RGBA8:case pi.SRGB8_A8:return t.UNSIGNED_BYTE;case pi.RGBA8SN:return t.BYTE;case pi.RGBA8UI:return t.UNSIGNED_BYTE;case pi.RGBA8I:return t.BYTE;case pi.RGBA16F:return Y7.HALF_FLOAT_OES;case pi.RGBA16UI:return t.UNSIGNED_SHORT;case pi.RGBA16I:return t.SHORT;case pi.RGBA32F:return t.FLOAT;case pi.RGBA32UI:return t.UNSIGNED_INT;case pi.RGBA32I:return t.INT;case pi.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case pi.R11G11B10F:return t.FLOAT;case pi.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case pi.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case pi.RGB10A2:return t.UNSIGNED_BYTE;case pi.RGB10A2UI:return t.UNSIGNED_INT;case pi.RGB9E5:return t.UNSIGNED_BYTE;case pi.DEPTH:return t.UNSIGNED_INT;case pi.DEPTH_STENCIL:return Y7.UNSIGNED_INT_24_8_WEBGL;case pi.BC1:case pi.BC1_SRGB:case pi.BC2:case pi.BC2_SRGB:case pi.BC3:case pi.BC3_SRGB:case pi.BC4:return t.UNSIGNED_BYTE;case pi.BC4_SNORM:return t.BYTE;case pi.BC5:return t.UNSIGNED_BYTE;case pi.BC5_SNORM:return t.BYTE;case pi.BC6H_SF16:case pi.BC6H_UF16:return t.FLOAT;case pi.BC7:case pi.BC7_SRGB:case pi.ETC_RGB8:case pi.ETC2_RGB8:case pi.ETC2_SRGB8:case pi.ETC2_RGB8_A1:case pi.ETC2_SRGB8_A1:case pi.EAC_R11:return t.UNSIGNED_BYTE;case pi.EAC_R11SN:return t.BYTE;case pi.EAC_RG11:return t.UNSIGNED_BYTE;case pi.EAC_RG11SN:return t.BYTE;case pi.PVRTC_RGB2:case pi.PVRTC_RGBA2:case pi.PVRTC_RGB4:case pi.PVRTC_RGBA4:case pi.PVRTC2_2BPP:case pi.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case pi.ASTC_RGBA_4X4:case pi.ASTC_RGBA_5X4:case pi.ASTC_RGBA_5X5:case pi.ASTC_RGBA_6X5:case pi.ASTC_RGBA_6X6:case pi.ASTC_RGBA_8X5:case pi.ASTC_RGBA_8X6:case pi.ASTC_RGBA_8X8:case pi.ASTC_RGBA_10X5:case pi.ASTC_RGBA_10X6:case pi.ASTC_RGBA_10X8:case pi.ASTC_RGBA_10X10:case pi.ASTC_RGBA_12X10:case pi.ASTC_RGBA_12X12:case pi.ASTC_SRGBA_4X4:case pi.ASTC_SRGBA_5X4:case pi.ASTC_SRGBA_5X5:case pi.ASTC_SRGBA_6X5:case pi.ASTC_SRGBA_6X6:case pi.ASTC_SRGBA_8X5:case pi.ASTC_SRGBA_8X6:case pi.ASTC_SRGBA_8X8:case pi.ASTC_SRGBA_10X5:case pi.ASTC_SRGBA_10X6:case pi.ASTC_SRGBA_10X8:case pi.ASTC_SRGBA_10X10:case pi.ASTC_SRGBA_12X10:case pi.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function J7(e,t){switch(e){case mi.BOOL:return t.BOOL;case mi.BOOL2:return t.BOOL_VEC2;case mi.BOOL3:return t.BOOL_VEC3;case mi.BOOL4:return t.BOOL_VEC4;case mi.INT:return t.INT;case mi.INT2:return t.INT_VEC2;case mi.INT3:return t.INT_VEC3;case mi.INT4:return t.INT_VEC4;case mi.UINT:return t.UNSIGNED_INT;case mi.FLOAT:return t.FLOAT;case mi.FLOAT2:return t.FLOAT_VEC2;case mi.FLOAT3:return t.FLOAT_VEC3;case mi.FLOAT4:return t.FLOAT_VEC4;case mi.MAT2:return t.FLOAT_MAT2;case mi.MAT3:return t.FLOAT_MAT3;case mi.MAT4:return t.FLOAT_MAT4;case mi.SAMPLER2D:return t.SAMPLER_2D;case mi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),mi.UNKNOWN}}function $7(e){switch(e){case mi.BOOL:case mi.BOOL2:case mi.BOOL3:case mi.BOOL4:case mi.INT:case mi.INT2:case mi.INT3:case mi.INT4:case mi.UINT:return Int32Array;case mi.FLOAT:case mi.FLOAT2:case mi.FLOAT3:case mi.FLOAT4:case mi.MAT2:case mi.MAT3:case mi.MAT4:return Float32Array;default:return console.error("Unsupported GLType, convert to TypedArrayConstructor failed."),Float32Array}}function e9(e,t){switch(e){case t.BOOL:return mi.BOOL;case t.BOOL_VEC2:return mi.BOOL2;case t.BOOL_VEC3:return mi.BOOL3;case t.BOOL_VEC4:return mi.BOOL4;case t.INT:return mi.INT;case t.INT_VEC2:return mi.INT2;case t.INT_VEC3:return mi.INT3;case t.INT_VEC4:return mi.INT4;case t.UNSIGNED_INT:return mi.UINT;case t.FLOAT:return mi.FLOAT;case t.FLOAT_VEC2:return mi.FLOAT2;case t.FLOAT_VEC3:return mi.FLOAT3;case t.FLOAT_VEC4:return mi.FLOAT4;case t.FLOAT_MAT2:return mi.MAT2;case t.FLOAT_MAT3:return mi.MAT3;case t.FLOAT_MAT4:return mi.MAT4;case t.SAMPLER_2D:return mi.SAMPLER2D;case t.SAMPLER_CUBE:return mi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),mi.UNKNOWN}}function t9(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function n9(e,t){switch(e){case t.FLOAT_MAT2:return 2;case t.FLOAT_MAT3:return 3;case t.FLOAT_MAT4:return 4;default:return 1}}Q7._instance=null;var i9,r9=[512,513,514,515,516,517,518,519],o9=[0,7680,7681,7682,7683,5386,34055,34056],a9=[32774,32778,32779,32775,32776],s9=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(i9||(i9={}));var c9=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},l9=function(e){function t(){var t;return(t=e.call(this,i9.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new tr,t.clearFlag=Ki.NONE,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return $(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(c9),u9=function(e){function t(){var t;return(t=e.call(this,i9.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new Jr,t}return $(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuDescriptorSets.length=0,this.gpuInputAssembler=null,this.dynamicOffsets.length=0},t}(c9),h9=function(e){function t(){var t;return(t=e.call(this,i9.DRAW)||this).drawInfo=new dr,t}return $(t,e),t.prototype.clear=function(){},t}(c9),f9=function(e){function t(){var t;return(t=e.call(this,i9.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return $(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(c9),_9=function(e){function t(){var t;return(t=e.call(this,i9.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return $(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(c9),p9=function(){function e(){this.cmds=new Yl(1),this.beginRenderPassCmds=new Yl(1),this.bindStatesCmds=new Yl(1),this.drawCmds=new Yl(1),this.updateBufferCmds=new Yl(1),this.copyBufferToTextureCmds=new Yl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function d9(e,t,n,i,r){if(t.usage&vi.UNIFORM)ArrayBuffer.isView(n)?t.vf32.set(n,i/Float32Array.BYTES_PER_ELEMENT):t.vf32.set(new Float32Array(n),i/Float32Array.BYTES_PER_ELEMENT);else if(t.usage&vi.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),m9.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer);break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),l.glVAO=null),m9.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer);break;default:return void console.error("Unsupported BufferType, update buffer failed.")}r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r))}}var m9={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0};function v9(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height);var u=r.length;e.extensions.WEBGL_draw_buffers||(u=1);for(var h=0;h<u;++h){var f=t.colorAttachments[h];if(f.format!==pi.UNKNOWN)switch(f.loadOp){case Ni.LOAD:break;case Ni.CLEAR:c.bs.targets[0].blendColorMask!==Oi.ALL&&s.colorMask(!0,!0,!0,!0);var _=r[0];s.clearColor(_.x,_.y,_.z,_.w),l|=s.COLOR_BUFFER_BIT;break;case Ni.DISCARD:}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==pi.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Ni.LOAD:break;case Ni.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Ni.DISCARD:}if(eo[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Ni.LOAD:break;case Ni.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Ni.DISCARD:}}if(l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var p=c.bs.targets[0].blendColorMask;if(p!==Oi.ALL){var d=(p&Oi.R)!==Oi.NONE,m=(p&Oi.G)!==Oi.NONE,v=(p&Oi.B)!==Oi.NONE,g=(p&Oi.A)!==Oi.NONE;s.colorMask(d,m,v,g)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function g9(e,t,n,i,r,o){var a,s,c,l=e.gl,u=e.stateCache,h=t&&t.gpuShader,f=!1;if(t&&m9.gpuPipelineState!==t){if(m9.gpuPipelineState=t,m9.glPrimitive=t.glPrimitive,t.gpuShader){var _=t.gpuShader.glProgram;u.glProgram!==_&&(l.useProgram(_),u.glProgram=_,f=!0)}var p=t.rs;if(p){if(u.rs.cullMode!==p.cullMode){switch(p.cullMode){case Hi.NONE:l.disable(l.CULL_FACE);break;case Hi.FRONT:l.enable(l.CULL_FACE),l.cullFace(l.FRONT);break;case Hi.BACK:l.enable(l.CULL_FACE),l.cullFace(l.BACK)}u.rs.cullMode=p.cullMode}var d=p.isFrontFaceCCW;u.rs.isFrontFaceCCW!==d&&(l.frontFace(d?l.CCW:l.CW),u.rs.isFrontFaceCCW=d),u.rs.depthBias===p.depthBias&&u.rs.depthBiasSlop===p.depthBiasSlop||(l.polygonOffset(p.depthBias,p.depthBiasSlop),u.rs.depthBias=p.depthBias,u.rs.depthBiasSlop=p.depthBiasSlop),u.rs.lineWidth!==p.lineWidth&&(l.lineWidth(p.lineWidth),u.rs.lineWidth=p.lineWidth)}var m=t.dss;m&&(u.dss.depthTest!==m.depthTest&&(m.depthTest?l.enable(l.DEPTH_TEST):l.disable(l.DEPTH_TEST),u.dss.depthTest=m.depthTest),u.dss.depthWrite!==m.depthWrite&&(l.depthMask(m.depthWrite),u.dss.depthWrite=m.depthWrite),u.dss.depthFunc!==m.depthFunc&&(l.depthFunc(r9[m.depthFunc]),u.dss.depthFunc=m.depthFunc),u.dss.stencilTestFront===m.stencilTestFront&&u.dss.stencilTestBack===m.stencilTestBack||(m.stencilTestFront||m.stencilTestBack?l.enable(l.STENCIL_TEST):l.disable(l.STENCIL_TEST),u.dss.stencilTestFront=m.stencilTestFront,u.dss.stencilTestBack=m.stencilTestBack),u.dss.stencilFuncFront===m.stencilFuncFront&&u.dss.stencilRefFront===m.stencilRefFront&&u.dss.stencilReadMaskFront===m.stencilReadMaskFront||(l.stencilFuncSeparate(l.FRONT,r9[m.stencilFuncFront],m.stencilRefFront,m.stencilReadMaskFront),u.dss.stencilFuncFront=m.stencilFuncFront,u.dss.stencilRefFront=m.stencilRefFront,u.dss.stencilReadMaskFront=m.stencilReadMaskFront),u.dss.stencilFailOpFront===m.stencilFailOpFront&&u.dss.stencilZFailOpFront===m.stencilZFailOpFront&&u.dss.stencilPassOpFront===m.stencilPassOpFront||(l.stencilOpSeparate(l.FRONT,o9[m.stencilFailOpFront],o9[m.stencilZFailOpFront],o9[m.stencilPassOpFront]),u.dss.stencilFailOpFront=m.stencilFailOpFront,u.dss.stencilZFailOpFront=m.stencilZFailOpFront,u.dss.stencilPassOpFront=m.stencilPassOpFront),u.dss.stencilWriteMaskFront!==m.stencilWriteMaskFront&&(l.stencilMaskSeparate(l.FRONT,m.stencilWriteMaskFront),u.dss.stencilWriteMaskFront=m.stencilWriteMaskFront),u.dss.stencilFuncBack===m.stencilFuncBack&&u.dss.stencilRefBack===m.stencilRefBack&&u.dss.stencilReadMaskBack===m.stencilReadMaskBack||(l.stencilFuncSeparate(l.BACK,r9[m.stencilFuncBack],m.stencilRefBack,m.stencilReadMaskBack),u.dss.stencilFuncBack=m.stencilFuncBack,u.dss.stencilRefBack=m.stencilRefBack,u.dss.stencilReadMaskBack=m.stencilReadMaskBack),u.dss.stencilFailOpBack===m.stencilFailOpBack&&u.dss.stencilZFailOpBack===m.stencilZFailOpBack&&u.dss.stencilPassOpBack===m.stencilPassOpBack||(l.stencilOpSeparate(l.BACK,o9[m.stencilFailOpBack],o9[m.stencilZFailOpBack],o9[m.stencilPassOpBack]),u.dss.stencilFailOpBack=m.stencilFailOpBack,u.dss.stencilZFailOpBack=m.stencilZFailOpBack,u.dss.stencilPassOpBack=m.stencilPassOpBack),u.dss.stencilWriteMaskBack!==m.stencilWriteMaskBack&&(l.stencilMaskSeparate(l.BACK,m.stencilWriteMaskBack),u.dss.stencilWriteMaskBack=m.stencilWriteMaskBack));var v=t.bs;if(v){u.bs.isA2C!==v.isA2C&&(v.isA2C?l.enable(l.SAMPLE_ALPHA_TO_COVERAGE):l.disable(l.SAMPLE_ALPHA_TO_COVERAGE),u.bs.isA2C=v.isA2C),u.bs.blendColor.x===v.blendColor.x&&u.bs.blendColor.y===v.blendColor.y&&u.bs.blendColor.z===v.blendColor.z&&u.bs.blendColor.w===v.blendColor.w||(l.blendColor(v.blendColor.x,v.blendColor.y,v.blendColor.z,v.blendColor.w),u.bs.blendColor.x=v.blendColor.x,u.bs.blendColor.y=v.blendColor.y,u.bs.blendColor.z=v.blendColor.z,u.bs.blendColor.w=v.blendColor.w);var g=v.targets[0],y=u.bs.targets[0];y.blend!==g.blend&&(g.blend?l.enable(l.BLEND):l.disable(l.BLEND),y.blend=g.blend),y.blendEq===g.blendEq&&y.blendAlphaEq===g.blendAlphaEq||(l.blendEquationSeparate(a9[g.blendEq],a9[g.blendAlphaEq]),y.blendEq=g.blendEq,y.blendAlphaEq=g.blendAlphaEq),y.blendSrc===g.blendSrc&&y.blendDst===g.blendDst&&y.blendSrcAlpha===g.blendSrcAlpha&&y.blendDstAlpha===g.blendDstAlpha||(l.blendFuncSeparate(s9[g.blendSrc],s9[g.blendDst],s9[g.blendSrcAlpha],s9[g.blendDstAlpha]),y.blendSrc=g.blendSrc,y.blendDst=g.blendDst,y.blendSrcAlpha=g.blendSrcAlpha,y.blendDstAlpha=g.blendDstAlpha),y.blendColorMask!==g.blendColorMask&&(l.colorMask((g.blendColorMask&Oi.R)!==Oi.NONE,(g.blendColorMask&Oi.G)!==Oi.NONE,(g.blendColorMask&Oi.B)!==Oi.NONE,(g.blendColorMask&Oi.A)!==Oi.NONE),y.blendColorMask=g.blendColorMask)}}if(t&&t.gpuPipelineLayout&&h){for(var x=h.glBlocks.length,S=t.gpuPipelineLayout.dynamicOffsetIndices,b=0;b<x;b++){var E=h.glBlocks[b],C=i[E.set],A=C&&C.descriptorIndices[E.binding],w=A>=0&&C.gpuDescriptors[A],P=null,R=0;if(w&&w.gpuBuffer){var I=w.gpuBuffer,D=S[E.set],O=D&&D[E.binding];O>=0&&(R=r[O]),"vf32"in I?P=I.vf32:(R+=I.offset,P=I.gpuBuffer.vf32),R>>=2}if(P)for(var M=E.glActiveUniforms.length,N=0;N<M;N++){var L=E.glActiveUniforms[N];switch(L.glType){case l.BOOL:case l.INT:for(var B=0;B<L.array.length;++B){var F=L.offset+R+B;if(P[F]!==L.array[B]){for(var z=B,U=F;z<L.array.length;++z,++U)L.array[z]=P[U];l.uniform1iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC2:case l.INT_VEC2:for(var k=0;k<L.array.length;++k){var G=L.offset+R+k;if(P[G]!==L.array[k]){for(var H=k,V=G;H<L.array.length;++H,++V)L.array[H]=P[V];l.uniform2iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC3:case l.INT_VEC3:for(var W=0;W<L.array.length;++W){var j=L.offset+R+W;if(P[j]!==L.array[W]){for(var q=W,X=j;q<L.array.length;++q,++X)L.array[q]=P[X];l.uniform3iv(L.glLoc,L.array);break}}break;case l.BOOL_VEC4:case l.INT_VEC4:for(var Y=0;Y<L.array.length;++Y){var K=L.offset+R+Y;if(P[K]!==L.array[Y]){for(var Q=Y,Z=K;Q<L.array.length;++Q,++Z)L.array[Q]=P[Z];l.uniform4iv(L.glLoc,L.array);break}}break;case l.FLOAT:for(var J=0;J<L.array.length;++J){var $=L.offset+R+J;if(P[$]!==L.array[J]){for(var ee=J,te=$;ee<L.array.length;++ee,++te)L.array[ee]=P[te];l.uniform1fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC2:for(var ne=0;ne<L.array.length;++ne){var ie=L.offset+R+ne;if(P[ie]!==L.array[ne]){for(var re=ne,oe=ie;re<L.array.length;++re,++oe)L.array[re]=P[oe];l.uniform2fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC3:for(var ae=0;ae<L.array.length;++ae){var se=L.offset+R+ae;if(P[se]!==L.array[ae]){for(var ce=ae,le=se;ce<L.array.length;++ce,++le)L.array[ce]=P[le];l.uniform3fv(L.glLoc,L.array);break}}break;case l.FLOAT_VEC4:for(var ue=0;ue<L.array.length;++ue){var he=L.offset+R+ue;if(P[he]!==L.array[ue]){for(var fe=ue,_e=he;fe<L.array.length;++fe,++_e)L.array[fe]=P[_e];l.uniform4fv(L.glLoc,L.array);break}}break;case l.FLOAT_MAT2:for(var pe=0;pe<L.array.length;++pe){var de=L.offset+R+pe;if(P[de]!==L.array[pe]){for(var me=pe,ve=de;me<L.array.length;++me,++ve)L.array[me]=P[ve];l.uniformMatrix2fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT3:for(var ge=0;ge<L.array.length;++ge){var ye=L.offset+R+ge;if(P[ye]!==L.array[ge]){for(var xe=ge,Se=ye;xe<L.array.length;++xe,++Se)L.array[xe]=P[Se];l.uniformMatrix3fv(L.glLoc,!1,L.array);break}}break;case l.FLOAT_MAT4:for(var Te=0;Te<L.array.length;++Te){var be=L.offset+R+Te;if(P[be]!==L.array[Te]){for(var Ee=Te,Ce=be;Ee<L.array.length;++Ee,++Ce)L.array[Ee]=P[Ce];l.uniformMatrix4fv(L.glLoc,!1,L.array);break}}}}else T("Buffer binding '"+E.name+"' at set "+E.set+" binding "+E.binding+" is not bounded")}for(var Ae=h.glSamplerTextures.length,we=0;we<Ae;we++)for(var Pe=h.glSamplerTextures[we],Re=i[Pe.set],Ie=Re&&Re.descriptorIndices[Pe.binding],De=Ie>=0&&Re.gpuDescriptors[Ie],Oe=Pe.units.length,Me=0;Me<Oe;Me++){var Ne=Pe.units[Me];if(De&&De.gpuSampler){if(De.gpuTexture&&De.gpuTexture.size>0){var Le=De.gpuTexture,Be=u.glTexUnits[Ne];Be.glTexture!==Le.glTexture&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),Le.glTexture?l.bindTexture(Le.glTarget,Le.glTexture):l.bindTexture(Le.glTarget,e.nullTex2D.gpuTexture.glTexture),Be.glTexture=Le.glTexture);var Fe=De.gpuSampler;Le.isPowerOf2?(a=Fe.glWrapS,s=Fe.glWrapT):(a=l.CLAMP_TO_EDGE,s=l.CLAMP_TO_EDGE),c=Le.isPowerOf2?Le.mipLevel<=1&&(Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR)?l.LINEAR:Fe.glMinFilter:Fe.glMinFilter===l.LINEAR||Fe.glMinFilter===l.LINEAR_MIPMAP_NEAREST||Fe.glMinFilter===l.LINEAR_MIPMAP_LINEAR?l.LINEAR:l.NEAREST,Le.glWrapS!==a&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_S,a),Le.glWrapS=a),Le.glWrapT!==s&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_WRAP_T,s),Le.glWrapT=s),Le.glMinFilter!==c&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MIN_FILTER,c),Le.glMinFilter=c),Le.glMagFilter!==Fe.glMagFilter&&(u.texUnit!==Ne&&(l.activeTexture(l.TEXTURE0+Ne),u.texUnit=Ne),l.texParameteri(Le.glTarget,l.TEXTURE_MAG_FILTER,Fe.glMagFilter),Le.glMagFilter=Fe.glMagFilter)}De=Re.gpuDescriptors[++Ie]}else T("Sampler binding '"+Pe.name+"' at set "+Pe.set+" binding "+Pe.binding+" index "+Me+" is not bounded")}}if(n&&h&&(f||m9.gpuInputAssembler!==n)){m9.gpuInputAssembler=n;var ze=e.extensions.ANGLE_instanced_arrays;if(e.extensions.useVAO){var Ue=e.extensions.OES_vertex_array_object,ke=n.glVAOs.get(h.glProgram);if(!ke){var Ge;ke=Ue.createVertexArrayOES(),n.glVAOs.set(h.glProgram,ke),Ue.bindVertexArrayOES(ke),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null;for(var He=h.glInputs.length,Ve=0;Ve<He;Ve++){var We=h.glInputs[Ve];Ge=null;for(var je=n.glAttribs.length,qe=0;qe<je;qe++){var Xe=n.glAttribs[qe];if(Xe.name===We.name){Ge=Xe;break}}if(Ge){u.glArrayBuffer!==Ge.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,Ge.glBuffer),u.glArrayBuffer=Ge.glBuffer);for(var Ye=0;Ye<Ge.componentCount;++Ye){var Ke=We.glLoc+Ye,Qe=Ge.offset+Ge.size*Ye;l.enableVertexAttribArray(Ke),u.glCurrentAttribLocs[Ke]=!0,l.vertexAttribPointer(Ke,Ge.count,Ge.glType,Ge.isNormalized,Ge.stride,Qe),ze&&ze.vertexAttribDivisorANGLE(Ke,Ge.isInstanced?1:0)}}}var Ze=n.gpuIndexBuffer;Ze&&l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,Ze.glBuffer),Ue.bindVertexArrayOES(null),l.bindBuffer(l.ARRAY_BUFFER,null),l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,null),u.glArrayBuffer=null,u.glElementArrayBuffer=null}u.glVAO!==ke&&(Ue.bindVertexArrayOES(ke),u.glVAO=ke)}else{for(var Je=0;Je<e.capabilities.maxVertexAttributes;++Je)u.glCurrentAttribLocs[Je]=!1;for(var $e=h.glInputs.length,et=0;et<$e;et++){for(var tt=h.glInputs[et],nt=null,it=n.glAttribs.length,rt=0;rt<it;rt++){var ot=n.glAttribs[rt];if(ot.name===tt.name){nt=ot;break}}if(nt){u.glArrayBuffer!==nt.glBuffer&&(l.bindBuffer(l.ARRAY_BUFFER,nt.glBuffer),u.glArrayBuffer=nt.glBuffer);for(var at=0;at<nt.componentCount;++at){var st=tt.glLoc+at,ct=nt.offset+nt.size*at;!u.glEnabledAttribLocs[st]&&st>=0&&(l.enableVertexAttribArray(st),u.glEnabledAttribLocs[st]=!0),u.glCurrentAttribLocs[st]=!0,l.vertexAttribPointer(st,nt.count,nt.glType,nt.isNormalized,nt.stride,ct),ze&&ze.vertexAttribDivisorANGLE(st,nt.isInstanced?1:0)}}}var lt=n.gpuIndexBuffer;lt&&u.glElementArrayBuffer!==lt.glBuffer&&(l.bindBuffer(l.ELEMENT_ARRAY_BUFFER,lt.glBuffer),u.glElementArrayBuffer=lt.glBuffer);for(var ut=0;ut<e.capabilities.maxVertexAttributes;++ut)u.glEnabledAttribLocs[ut]!==u.glCurrentAttribLocs[ut]&&(l.disableVertexAttribArray(ut),u.glEnabledAttribLocs[ut]=!1)}}if(t&&t.dynamicStates.length)for(var ht=t.dynamicStates.length,ft=0;ft<ht;ft++)switch(t.dynamicStates[ft]){case Vi.LINE_WIDTH:u.rs.lineWidth!==o.lineWidth&&(l.lineWidth(o.lineWidth),u.rs.lineWidth=o.lineWidth);break;case Vi.DEPTH_BIAS:u.rs.depthBias===o.depthBiasConstant&&u.rs.depthBiasSlop===o.depthBiasSlope||(l.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),u.rs.depthBias=o.depthBiasConstant,u.rs.depthBiasSlop=o.depthBiasSlope);break;case Vi.BLEND_CONSTANTS:var _t=o.blendConstant;u.bs.blendColor.x===_t.x&&u.bs.blendColor.y===_t.y&&u.bs.blendColor.z===_t.z&&u.bs.blendColor.w===_t.w||(l.blendColor(_t.x,_t.y,_t.z,_t.w),u.bs.blendColor.copy(_t));break;case Vi.STENCIL_WRITE_MASK:var pt=o.stencilStatesFront,dt=o.stencilStatesBack;u.dss.stencilWriteMaskFront!==pt.writeMask&&(l.stencilMaskSeparate(l.FRONT,pt.writeMask),u.dss.stencilWriteMaskFront=pt.writeMask),u.dss.stencilWriteMaskBack!==dt.writeMask&&(l.stencilMaskSeparate(l.BACK,dt.writeMask),u.dss.stencilWriteMaskBack=dt.writeMask);break;case Vi.STENCIL_COMPARE_MASK:var mt=o.stencilStatesFront,vt=o.stencilStatesBack;u.dss.stencilRefFront===mt.reference&&u.dss.stencilReadMaskFront===mt.compareMask||(l.stencilFuncSeparate(l.FRONT,r9[u.dss.stencilFuncFront],mt.reference,mt.compareMask),u.dss.stencilRefFront=mt.reference,u.dss.stencilReadMaskFront=mt.compareMask),u.dss.stencilRefBack===vt.reference&&u.dss.stencilReadMaskBack===vt.compareMask||(l.stencilFuncSeparate(l.BACK,r9[u.dss.stencilFuncBack],vt.reference,vt.compareMask),u.dss.stencilRefBack=vt.reference,u.dss.stencilReadMaskBack=vt.compareMask)}}function y9(e,t){var n=e.gl,i=e.extensions,r=i.ANGLE_instanced_arrays,o=i.WEBGL_multi_draw,a=m9.gpuInputAssembler,s=m9.glPrimitive;if(a){var c=a.gpuIndexBuffer;if(a.gpuIndirectBuffer){var l=a.gpuIndirectBuffer.indirects;if(l.drawByIndex){for(var u=0;u<l.drawCount;u++)l.byteOffsets[u]=l.offsets[u]*c.stride;if(o)l.instancedDraw?o.multiDrawElementsInstancedWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.instances,0,l.drawCount):o.multiDrawElementsWEBGL(s,l.counts,0,a.glIndexType,l.byteOffsets,0,l.drawCount);else for(var h=0;h<l.drawCount;h++)l.instances[h]&&r?r.drawElementsInstancedANGLE(s,l.counts[h],a.glIndexType,l.byteOffsets[h],l.instances[h]):n.drawElements(s,l.counts[h],a.glIndexType,l.byteOffsets[h])}else if(o)l.instancedDraw?o.multiDrawArraysInstancedWEBGL(s,l.offsets,0,l.counts,0,l.instances,0,l.drawCount):o.multiDrawArraysWEBGL(s,l.offsets,0,l.counts,0,l.drawCount);else for(var f=0;f<l.drawCount;f++)l.instances[f]&&r?r.drawArraysInstancedANGLE(s,l.offsets[f],l.counts[f],l.instances[f]):n.drawArrays(s,l.offsets[f],l.counts[f])}else if(t.instanceCount&&r)if(c){if(t.indexCount>0){var _=t.firstIndex*c.stride;r.drawElementsInstancedANGLE(s,t.indexCount,a.glIndexType,_,t.instanceCount)}}else t.vertexCount>0&&r.drawArraysInstancedANGLE(s,t.firstVertex,t.vertexCount,t.instanceCount);else if(c){if(t.indexCount>0){var p=t.firstIndex*c.stride;n.drawElements(s,t.indexCount,a.glIndexType,p)}}else t.vertexCount>0&&n.drawArrays(s,t.firstVertex,t.vertexCount)}}var x9=new Array(i9.COUNT);function S9(e,t){x9.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=x9[i]++;switch(i){case i9.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];v9(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case i9.BIND_STATES:var a=t.bindStatesCmds.array[r];g9(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case i9.DRAW:y9(e,t.drawCmds.array[r].drawInfo);break;case i9.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];d9(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case i9.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];T9(e,c.buffers,c.gpuTexture,c.regions)}}}function T9(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=eo[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var _=t[a++];u?n.glInternalFmt===Y7.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,_):r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,_):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt===Y7.COMPRESSED_RGB_ETC1_WEBGL||e.extensions.noCompressedTexSubImage2D?r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var b9=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=a(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),E9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t._gpuBufferView=null,t._uniformBuffer=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBufferView={gpuBuffer:t.gpuBuffer,offset:e.offset,range:e.range}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._usage&vi.UNIFORM&&this._size>0&&(this._uniformBuffer=new Uint8Array(this._size)),this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,vf32:null,indirects:new b9,glTarget:0,glBuffer:null},this._usage&vi.UNIFORM&&(this._gpuBuffer.buffer=this._uniformBuffer),function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&xi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&vi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),m9.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&vi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),m9.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else t.usage&vi.UNIFORM?(t.glTarget=n.NONE,t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer))):(t.usage&vi.INDIRECT||t.usage&vi.TRANSFER_DST||t.usage&vi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(Q7.instance,this._gpuBuffer),Q7.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),m9.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),e.stateCache.glVAO=null),m9.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(Q7.instance,this._gpuBuffer),Q7.instance.memoryStatus.bufferSize-=this._size,this._gpuBuffer=null),this._gpuBufferView&&(this._gpuBufferView=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._uniformBuffer&&(this._uniformBuffer=new Uint8Array(e)),this._gpuBuffer&&(this._uniformBuffer&&(this._gpuBuffer.buffer=this._uniformBuffer),this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&xi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&vi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),m9.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null):t.usage&vi.INDEX?(e.extensions.useVAO&&i.glVAO&&(e.extensions.OES_vertex_array_object.bindVertexArrayOES(null),i.glVAO=null),m9.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&vi.UNIFORM?t.buffer&&(t.vf32=new Float32Array(t.buffer.buffer)):(t.usage&vi.INDIRECT||t.usage&vi.TRANSFER_DST||t.usage&vi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(Q7.instance,this._gpuBuffer),Q7.instance.memoryStatus.bufferSize-=t,Q7.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&vi.INDIRECT?0:e.byteLength,d9(Q7.instance,this._gpuBuffer,e,0,n))},Z(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}},{key:"gpuBufferView",get:function(){return this._gpuBufferView}}]),t}(fo),C9=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Yl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),A9=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new C9(l9,1),this.bindStatesCmdPool=new C9(u9,1),this.drawCmdPool=new C9(h9,1),this.updateBufferCmdPool=new C9(f9,1),this.copyBufferToTextureCmdPool=new C9(_9,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),w9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new p9,t._cmdAllocator=new A9,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUInputAssembler=null,t._curGPUDescriptorSets=[],t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new Jr,t._isStateInvalied=!1,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=Q7.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(l9);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n,a.clearColors.length=i.length;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(i9.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Wi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Wi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Yi.PRIMARY&&this._isInRenderPass||this._type===Yi.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(h9);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(i9.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(f9),a=0;e.usage&vi.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(i9.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(_9);r&&(r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(i9.COPY_BUFFER_TO_TEXTURE))}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var _=i.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(u9);e&&(e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates.copy(this._curDynamicStates),this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(i9.BIND_STATES),this._isStateInvalied=!1)},t}(_o),P9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;++n){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=eo[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}e.extensions.WEBGL_draw_buffers&&e.extensions.WEBGL_draw_buffers.drawBuffersWEBGL(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(Q7.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=Q7.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},Z(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(vo),R9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Error index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=Z7(o.format,n),l=eo[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:eo[o.format].count,stride:s.stride,componentCount:n9(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(Q7.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=Q7.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.extensions.OES_vertex_array_object,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArrayOES(i.value),o===i.value&&(r.bindVertexArrayOES(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},Z(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(So),I9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&io)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},Z(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(bo),D9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},Z(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Eo),O9=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],M9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:O9[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},Z(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Io),N9=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){v9(Q7.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;y9(Q7.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=Q7.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=Q7.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&vi.INDIRECT?0:t.byteLength,d9(Q7.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&T9(Q7.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];S9(Q7.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){g9(Q7.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(w9),L9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=e.length,n=0;n<t;n++){var i=e[n];this.numDrawCalls+=i.numDrawCalls,this.numInstances+=i.numInstances,this.numTris+=i.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Do),B9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},Z(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Oo),F9=[10497,33648,33071,33071],z9=function(e){function t(t,n){var i;(i=e.call(this,t,n)||this)._gpuSampler=null;var r,o,a=i._info.minFilter,s=i._info.magFilter,c=i._info.mipFilter;r=a===Ai.LINEAR||a===Ai.ANISOTROPIC?c===Ai.LINEAR||c===Ai.ANISOTROPIC?9987:c===Ai.POINT?9985:9729:c===Ai.LINEAR||c===Ai.ANISOTROPIC?9986:c===Ai.POINT?9984:9728,o=s===Ai.LINEAR||s===Ai.ANISOTROPIC?9729:9728;var l=F9[i._info.addressU],u=F9[i._info.addressV],h=F9[i._info.addressW];return i._gpuSampler={glMinFilter:r,glMagFilter:o,glWrapS:l,glWrapT:u,glWrapR:h},i}return $(t,e),Z(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Mo),U9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Mi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Mi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}if(n.linkProgram(t.glProgram),e.extensions.destroyShadersImmediately)for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));E("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var f=0;f<h;++f){var _=n.getActiveAttrib(t.glProgram,f);if(_){var p,d=_.name.indexOf("[");p=-1!==d?_.name.substr(0,d):_.name;var m=n.getAttribLocation(t.glProgram,p),v=e9(_.type,n),g=t9(_.type,n);t.glInputs[f]={binding:m,name:p,type:v,stride:g,count:_.size,size:g*_.size,glType:_.type,glLoc:m}}}if(t.blocks.length>0){t.glBlocks=new Array(t.blocks.length);for(var y=0;y<t.blocks.length;++y){var x=t.blocks[y],S={set:x.set,binding:x.binding,name:x.name,size:0,glUniforms:new Array(x.members.length),glActiveUniforms:[]};t.glBlocks[y]=S;for(var T=0;T<x.members.length;++T){var b=x.members[T],C=J7(b.type,n),A=t9(C,n),w=A*b.count;S.glUniforms[T]={binding:-1,name:b.name,type:b.type,stride:A,count:b.count,size:w,offset:0,glType:C,glLoc:null,array:null}}}}for(var P=0;P<t.subpassInputs.length;++P){var R=t.subpassInputs[P];t.samplerTextures.push(new br(R.set,R.binding,R.name,mi.SAMPLER2D,R.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var I=0;I<t.samplerTextures.length;++I){var D=t.samplerTextures[I];t.glSamplerTextures[I]={set:D.set,binding:D.binding,name:D.name,type:D.type,count:D.count,units:[],glUnits:null,glType:J7(D.type,n),glLoc:null}}}for(var O=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORMS),M=0;M<O;++M){var N=n.getActiveUniform(t.glProgram,M);if(N&&N.type!==n.SAMPLER_2D&&N.type!==n.SAMPLER_CUBE){var L=n.getUniformLocation(t.glProgram,N.name);if(e.extensions.isLocationActive(L)){var B,F=N.name.indexOf("[");B=-1!==F?N.name.substr(0,F):N.name;for(var z=0;z<t.glBlocks.length;z++)for(var U=t.glBlocks[z],k=0;k<U.glUniforms.length;k++){var G=U.glUniforms[k];if(G.name===B){G.glLoc=L,G.count=N.size,G.size=G.stride*G.count,G.array=new($7(G.type))(G.size/4),U.glActiveUniforms.push(G);break}}}}}for(var H=0;H<t.glBlocks.length;H++)for(var V=t.glBlocks[H],W=0;W<V.glUniforms.length;W++){var j=V.glUniforms[W];j.offset=V.size/4,V.size+=j.size}for(var q=[],X=[],Y=e.bindingMappingInfo,K=e.stateCache.texUnitCacheMap,Q=0,Z=0;Z<t.blocks.length;++Z)t.blocks[Z].set===Y.flexibleSet&&Q++;for(var J=0,$=0;$<t.samplerTextures.length;++$){var ee=t.samplerTextures[$],te=n.getUniformLocation(t.glProgram,ee.name);if(e.extensions.isLocationActive(te)&&(q.push(t.glSamplerTextures[$]),X.push(te)),void 0===K[ee.name]){var ne=ee.binding+Y.samplerOffsets[ee.set]+J;ee.set===Y.flexibleSet&&(ne-=Q),K[ee.name]=ne%e.capabilities.maxTextureUnits,J+=ee.count-1}}if(q.length){for(var ie=[],re=0;re<q.length;++re){var oe=q[re],ae=K[oe.name];if(void 0!==ae){oe.glLoc=X[re];for(var se=0;se<oe.count;++se){for(;ie[ae];)ae=(ae+1)%e.capabilities.maxTextureUnits;oe.units.push(ae),ie[ae]=!0}}}for(var ce=0,le=0;le<q.length;++le){var ue=q[le];if(!e.extensions.isLocationActive(ue.glLoc)){ue.glLoc=X[le];for(var he=0;he<ue.count;++he){for(;ie[ce];)ce=(ce+1)%e.capabilities.maxTextureUnits;void 0===K[ue.name]&&(K[ue.name]=ce),ue.units.push(ce),ie[ce]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var fe=0;fe<q.length;fe++){var _e=q[fe];_e.glUnits=new Int32Array(_e.units),n.uniform1iv(_e.glLoc,_e.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}for(var pe=0;pe<t.glBlocks.length;)t.glBlocks[pe].glActiveUniforms.length?pe++:(t.glBlocks[pe]=t.glBlocks[t.glBlocks.length-1],t.glBlocks.length--);t.glSamplerTextures=q}}(Q7.instance,this._gpuShader)},n.destroy=function(){this._gpuShader&&(function(e,t){if(t.glProgram){var n=e.gl;if(!e.extensions.destroyShadersImmediately)for(var i=0;i<t.gpuStages.length;i++){var r=t.gpuStages[i];r.glShader&&(n.detachShader(t.glProgram,r.glShader),n.deleteShader(r.glShader),r.glShader=null)}n.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null}}(Q7.instance,this._gpuShader),this._gpuShader=null)},Z(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(No),k9=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.viewport=new cr,this.scissorRect=new tr(0,0,0,0),this.rs=new Co,this.dss=new Ao,this.bs=new Po,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t){for(var n=0;n<e;++n)this.glTexUnits.push({glTexture:null});this.glEnabledAttribLocs.length=t,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=t,this.glCurrentAttribLocs.fill(!1)},e}(),G9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=oo(this._width)&&oo(this._height),this._size=so(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},function(e,t){var n=e.gl;t.glFormat=t.glInternalFmt=function(e,t){switch(e){case pi.A8:return t.ALPHA;case pi.L8:return t.LUMINANCE;case pi.LA8:return t.LUMINANCE_ALPHA;case pi.RGB8:case pi.RGB16F:case pi.RGB32F:return t.RGB;case pi.BGRA8:case pi.RGBA8:case pi.SRGB8_A8:case pi.RGBA16F:case pi.RGBA32F:return t.RGBA;case pi.R5G6B5:return t.RGB;case pi.RGB5A1:case pi.RGBA4:return t.RGBA;case pi.DEPTH:return t.DEPTH_COMPONENT;case pi.DEPTH_STENCIL:return t.DEPTH_STENCIL;case pi.BC1:return Y7.COMPRESSED_RGB_S3TC_DXT1_EXT;case pi.BC1_ALPHA:return Y7.COMPRESSED_RGBA_S3TC_DXT1_EXT;case pi.BC1_SRGB:return Y7.COMPRESSED_SRGB_S3TC_DXT1_EXT;case pi.BC1_SRGB_ALPHA:return Y7.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case pi.BC2:return Y7.COMPRESSED_RGBA_S3TC_DXT3_EXT;case pi.BC2_SRGB:return Y7.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case pi.BC3:return Y7.COMPRESSED_RGBA_S3TC_DXT5_EXT;case pi.BC3_SRGB:return Y7.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case pi.ETC_RGB8:return Y7.COMPRESSED_RGB_ETC1_WEBGL;case pi.ETC2_RGB8:return Y7.COMPRESSED_RGB8_ETC2;case pi.ETC2_SRGB8:return Y7.COMPRESSED_SRGB8_ETC2;case pi.ETC2_RGB8_A1:return Y7.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case pi.ETC2_SRGB8_A1:return Y7.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case pi.ETC2_RGBA8:return Y7.COMPRESSED_RGBA8_ETC2_EAC;case pi.ETC2_SRGB8_A8:return Y7.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case pi.EAC_R11:return Y7.COMPRESSED_R11_EAC;case pi.EAC_R11SN:return Y7.COMPRESSED_SIGNED_R11_EAC;case pi.EAC_RG11:return Y7.COMPRESSED_RG11_EAC;case pi.EAC_RG11SN:return Y7.COMPRESSED_SIGNED_RG11_EAC;case pi.PVRTC_RGB2:return Y7.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case pi.PVRTC_RGBA2:return Y7.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case pi.PVRTC_RGB4:return Y7.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case pi.PVRTC_RGBA4:return Y7.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case pi.ASTC_RGBA_4X4:return Y7.COMPRESSED_RGBA_ASTC_4x4_KHR;case pi.ASTC_RGBA_5X4:return Y7.COMPRESSED_RGBA_ASTC_5x4_KHR;case pi.ASTC_RGBA_5X5:return Y7.COMPRESSED_RGBA_ASTC_5x5_KHR;case pi.ASTC_RGBA_6X5:return Y7.COMPRESSED_RGBA_ASTC_6x5_KHR;case pi.ASTC_RGBA_6X6:return Y7.COMPRESSED_RGBA_ASTC_6x6_KHR;case pi.ASTC_RGBA_8X5:return Y7.COMPRESSED_RGBA_ASTC_8x5_KHR;case pi.ASTC_RGBA_8X6:return Y7.COMPRESSED_RGBA_ASTC_8x6_KHR;case pi.ASTC_RGBA_8X8:return Y7.COMPRESSED_RGBA_ASTC_8x8_KHR;case pi.ASTC_RGBA_10X5:return Y7.COMPRESSED_RGBA_ASTC_10x5_KHR;case pi.ASTC_RGBA_10X6:return Y7.COMPRESSED_RGBA_ASTC_10x6_KHR;case pi.ASTC_RGBA_10X8:return Y7.COMPRESSED_RGBA_ASTC_10x8_KHR;case pi.ASTC_RGBA_10X10:return Y7.COMPRESSED_RGBA_ASTC_10x10_KHR;case pi.ASTC_RGBA_12X10:return Y7.COMPRESSED_RGBA_ASTC_12x10_KHR;case pi.ASTC_RGBA_12X12:return Y7.COMPRESSED_RGBA_ASTC_12x12_KHR;case pi.ASTC_SRGBA_4X4:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case pi.ASTC_SRGBA_5X4:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case pi.ASTC_SRGBA_5X5:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case pi.ASTC_SRGBA_6X5:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case pi.ASTC_SRGBA_6X6:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case pi.ASTC_SRGBA_8X5:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case pi.ASTC_SRGBA_8X6:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case pi.ASTC_SRGBA_8X8:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case pi.ASTC_SRGBA_10X5:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case pi.ASTC_SRGBA_10X6:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case pi.ASTC_SRGBA_10X8:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case pi.ASTC_SRGBA_10X10:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case pi.ASTC_SRGBA_12X10:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case pi.ASTC_SRGBA_12X12:return Y7.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=Z7(t.format,n);var i=t.width,r=t.height;switch(t.type){case Si.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),!e.extensions.WEBGL_depth_texture&&eo[t.format].hasDepth)t.glInternalFmt=function(e,t){switch(e){case pi.R5G6B5:return t.RGB565;case pi.RGB5A1:return t.RGB5_A1;case pi.RGBA4:return t.RGBA4;case pi.RGBA16F:return Y7.RGBA16F_EXT;case pi.RGBA32F:return Y7.RGBA32F_EXT;case pi.SRGB8_A8:return Y7.SRGB8_ALPHA8_EXT;case pi.DEPTH:return t.DEPTH_COMPONENT16;case pi.DEPTH_STENCIL:return t.DEPTH_STENCIL;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r));else if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),eo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ao(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1);t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;case Si.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);if(h>e.capabilities.maxCubeMapTextureSize&&M(9100,h,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),eo[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=ao(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}t.isPowerOf2?(t.glWrapS=n.REPEAT,t.glWrapT=n.REPEAT):(t.glWrapS=n.CLAMP_TO_EDGE,t.glWrapT=n.CLAMP_TO_EDGE),t.glMinFilter=n.LINEAR,t.glMagFilter=n.LINEAR,n.texParameteri(t.glTarget,n.TEXTURE_WRAP_S,t.glWrapS),n.texParameteri(t.glTarget,n.TEXTURE_WRAP_T,t.glWrapT),n.texParameteri(t.glTarget,n.TEXTURE_MIN_FILTER,t.glMinFilter),n.texParameteri(t.glTarget,n.TEXTURE_MAG_FILTER,t.glMagFilter)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}(Q7.instance,this._gpuTexture),Q7.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(function(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;o++)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}(Q7.instance,this._gpuTexture),Q7.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=so(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Si.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),t.glRenderbuffer)e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorage(n.RENDERBUFFER,t.glInternalFmt,i,r);else if(t.glTexture){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),eo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ao(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else for(var u=0;u<t.mipLevel;++u)n.texImage2D(n.TEXTURE_2D,u,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;case Si.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var h=Math.max(i,r);h>e.capabilities.maxCubeMapTextureSize&&M(9100,h,e.capabilities.maxTextureSize);var f=e.stateCache.glTexUnits[e.stateCache.texUnit];if(f.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),f.glTexture=t.glTexture),eo[t.format].isCompressed)for(var _=0;_<6;++_){i=t.width,r=t.height;for(var p=0;p<t.mipLevel;++p){var d=ao(t.format,i,r,1),m=new Uint8Array(d);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+_,p,t.glInternalFmt,i,r,0,m),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else for(var v=0;v<6;++v){i=t.width,r=t.height;for(var g=0;g<t.mipLevel;++g)n.texImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+v,g,t.glInternalFmt,i,r,0,t.glFormat,t.glType,null),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}}(Q7.instance,this._gpuTexture),Q7.instance.memoryStatus.textureSize-=n,Q7.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new gr;t.format=e.format,t.usage=eo[e.format].hasDepth?Ti.DEPTH_STENCIL_ATTACHMENT:Ti.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},Z(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Lo),H9="webglcontextlost";function V9(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function W9(e){var t={EXT_texture_filter_anisotropic:V9(e,"EXT_texture_filter_anisotropic"),EXT_blend_minmax:V9(e,"EXT_blend_minmax"),EXT_frag_depth:V9(e,"EXT_frag_depth"),EXT_shader_texture_lod:V9(e,"EXT_shader_texture_lod"),EXT_sRGB:V9(e,"EXT_sRGB"),OES_vertex_array_object:V9(e,"OES_vertex_array_object"),EXT_color_buffer_half_float:V9(e,"EXT_color_buffer_half_float"),WEBGL_color_buffer_float:V9(e,"WEBGL_color_buffer_float"),WEBGL_compressed_texture_etc1:V9(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:V9(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:V9(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_s3tc:V9(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:V9(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:V9(e,"WEBGL_debug_shaders"),WEBGL_draw_buffers:V9(e,"WEBGL_draw_buffers"),WEBGL_lose_context:V9(e,"WEBGL_lose_context"),WEBGL_depth_texture:V9(e,"WEBGL_depth_texture"),OES_texture_half_float:V9(e,"OES_texture_half_float"),OES_texture_half_float_linear:V9(e,"OES_texture_half_float_linear"),OES_texture_float:V9(e,"OES_texture_float"),OES_texture_float_linear:V9(e,"OES_texture_float_linear"),OES_standard_derivatives:V9(e,"OES_standard_derivatives"),OES_element_index_uint:V9(e,"OES_element_index_uint"),ANGLE_instanced_arrays:V9(e,"ANGLE_instanced_arrays"),WEBGL_debug_renderer_info:V9(e,"WEBGL_debug_renderer_info"),WEBGL_multi_draw:null,WEBGL_compressed_texture_astc:null,destroyShadersImmediately:!0,noCompressedTexSubImage2D:!1,isLocationActive:function(e){return!!e},useVAO:!1};return vu.os===cu.IOS&&14===vu.osMainVersion&&vu.isBrowser||(t.WEBGL_compressed_texture_astc=V9(e,"WEBGL_compressed_texture_astc")),vu.os!==cu.ANDROID&&vu.os!==cu.IOS&&(t.WEBGL_multi_draw=V9(e,"WEBGL_multi_draw")),vu.browserType===ou.UC&&(t.ANGLE_instanced_arrays=null),vu.os===cu.IOS&&vu.osMainVersion<=10&&(t.destroyShadersImmediately=!1),t.OES_vertex_array_object&&(t.useVAO=!0),t}var j9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new k9,t.cmdAllocator=new A9,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGLContextLostHandler=null,t._extensions=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGLContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(H9,this._onWebGLContextLost);var t=Q7.instance.gl;this.stateCache.initialize(Q7.instance.capabilities.maxTextureUnits,Q7.instance.capabilities.maxVertexAttributes),this._extensions=W9(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.disable(e.POLYGON_OFFSET_FILL),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.depthRange(0,1),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=pi.RGBA8,i=pi.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=pi.DEPTH_STENCIL:r&&(i=pi.DEPTH),this._colorTexture=new G9,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new G9,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=Q7.instance.createTexture(new gr(Si.TEX2D,Ti.SAMPLED,pi.RGBA8,2,2,bi.GEN_MIPMAP)),this.nullTexCube=Q7.instance.createTexture(new gr(Si.CUBE,Ti.SAMPLED,pi.RGBA8,2,2,bi.GEN_MIPMAP,6));var a=new sr;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),Q7.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,Q7.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGLContextLostHandler&&(this._canvas.removeEventListener(H9,this._webGLContextLostHandler),this._webGLContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(E("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){D(11e3),S(e)},Z(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(mo),q9=e("WebGLDevice",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){Q7.setInstance(this),this._gfxAPI=hi.WEBGL,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:ft.ENABLE_TRANSPARENT_CANVAS,antialias:ft.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl",n)}catch(e){return null}return t}(po.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Xr(qi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new qr(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.maxUniformBufferBindings=16;var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=se(n);!(r=o()).done;)i+=r.value+" ";var a=W9(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),a.EXT_sRGB&&(this._features[_i.FORMAT_SRGB]=!0),a.EXT_blend_minmax&&(this._features[_i.BLEND_MINMAX]=!0),a.WEBGL_color_buffer_float&&(this._features[_i.COLOR_FLOAT]=!0),a.EXT_color_buffer_half_float&&(this._features[_i.COLOR_HALF_FLOAT]=!0),a.OES_texture_float&&(this._features[_i.TEXTURE_FLOAT]=!0),a.OES_texture_half_float&&(this._features[_i.TEXTURE_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[_i.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[_i.TEXTURE_HALF_FLOAT_LINEAR]=!0),this._features[_i.FORMAT_RGB8]=!0,a.OES_element_index_uint&&(this._features[_i.ELEMENT_INDEX_UINT]=!0),a.ANGLE_instanced_arrays&&(this._features[_i.INSTANCED_ARRAYS]=!0),a.WEBGL_draw_buffers&&(this._features[_i.MULTIPLE_RENDER_TARGETS]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[_i.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[_i.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[_i.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[_i.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[_i.FORMAT_ASTC]=!0,c+="astc "),E("WebGL device initialized."),E("RENDERER: "+this._renderer),E("VENDOR: "+this._vendor),E("VERSION: "+s),E("COMPRESSED_FORMAT: "+c),E("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null)},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===Yi.PRIMARY?N9:w9);return t.initialize(e),t},n.createSwapchain=function(e){var t=new j9;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new E9;return t.initialize(e),t},n.createTexture=function(e){var t=new G9;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new K7;return t.initialize(e),t},n.createShader=function(e){var t=new U9;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new R9;return t.initialize(e),t},n.createRenderPass=function(e){var t=new B9;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new P9;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new I9;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new D9;return t.initialize(e),t},n.createPipelineState=function(e){var t=new M9;return t.initialize(e),t},n.createQueue=function(e){var t=new L9;return t.initialize(e),t},n.getSampler=function(e){var t=Mo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new z9(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=Bo.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Bo(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Fo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Fo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){T9(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&n.isPowerOf2&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},Z(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(po));u.WebGLDevice=q9;var X9,Y9=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSet=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._layout=e.layout;var t=e.layout.gpuDescriptorSetLayout,n=t.bindings,i=t.descriptorIndices,r=t.descriptorCount;this._buffers=Array(r).fill(null),this._textures=Array(r).fill(null),this._samplers=Array(r).fill(null);var o=[];this._gpuDescriptorSet={gpuDescriptors:o,descriptorIndices:i};for(var a=0;a<n.length;++a)for(var s=n[a],c=0;c<s.count;c++)o.push({type:s.descriptorType,gpuBuffer:null,gpuTexture:null,gpuSampler:null})},n.destroy=function(){this._layout=null,this._gpuDescriptorSet=null},n.update=function(){if(this._isDirty&&this._gpuDescriptorSet){for(var e=this._gpuDescriptorSet.gpuDescriptors,t=0;t<e.length;++t)e[t].type&to?this._buffers[t]&&(e[t].gpuBuffer=this._buffers[t].gpuBuffer):e[t].type&no&&(this._textures[t]&&(e[t].gpuTexture=this._textures[t].gpuTexture),this._samplers[t]&&(e[t].gpuSampler=this._samplers[t].gpuSampler));this._isDirty=!1}},Z(t,[{key:"gpuDescriptorSet",get:function(){return this._gpuDescriptorSet}}]),t}(To);!function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_SRGB_S3TC_DXT1_EXT=35916]="COMPRESSED_SRGB_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT=35917]="COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT=35918]="COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT",e[e.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT=35919]="COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGBA_ASTC_4x4_KHR=37808]="COMPRESSED_RGBA_ASTC_4x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x4_KHR=37809]="COMPRESSED_RGBA_ASTC_5x4_KHR",e[e.COMPRESSED_RGBA_ASTC_5x5_KHR=37810]="COMPRESSED_RGBA_ASTC_5x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x5_KHR=37811]="COMPRESSED_RGBA_ASTC_6x5_KHR",e[e.COMPRESSED_RGBA_ASTC_6x6_KHR=37812]="COMPRESSED_RGBA_ASTC_6x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x5_KHR=37813]="COMPRESSED_RGBA_ASTC_8x5_KHR",e[e.COMPRESSED_RGBA_ASTC_8x6_KHR=37814]="COMPRESSED_RGBA_ASTC_8x6_KHR",e[e.COMPRESSED_RGBA_ASTC_8x8_KHR=37815]="COMPRESSED_RGBA_ASTC_8x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x5_KHR=37816]="COMPRESSED_RGBA_ASTC_10x5_KHR",e[e.COMPRESSED_RGBA_ASTC_10x6_KHR=37817]="COMPRESSED_RGBA_ASTC_10x6_KHR",e[e.COMPRESSED_RGBA_ASTC_10x8_KHR=37818]="COMPRESSED_RGBA_ASTC_10x8_KHR",e[e.COMPRESSED_RGBA_ASTC_10x10_KHR=37819]="COMPRESSED_RGBA_ASTC_10x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x10_KHR=37820]="COMPRESSED_RGBA_ASTC_12x10_KHR",e[e.COMPRESSED_RGBA_ASTC_12x12_KHR=37821]="COMPRESSED_RGBA_ASTC_12x12_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR=37840]="COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR=37841]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR=37842]="COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR=37843]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR=37844]="COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR=37845]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR=37846]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR=37847]="COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR=37848]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR=37849]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR=37850]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR=37851]="COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR=37852]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR",e[e.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR=37853]="COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR"}(X9||(X9={}));var K9=function(){function e(){}return e.setInstance=function(t){e._instance=t},Z(e,null,[{key:"instance",get:function(){return e._instance}}]),e}();K9._instance=null;var Q9=[10497,33648,33071,33071],Z9=new Float32Array(4);function J9(e,t){switch(e){case pi.R8:return t.UNSIGNED_BYTE;case pi.R8SN:return t.BYTE;case pi.R8UI:return t.UNSIGNED_BYTE;case pi.R8I:return t.BYTE;case pi.R16F:return t.HALF_FLOAT;case pi.R16UI:return t.UNSIGNED_SHORT;case pi.R16I:return t.SHORT;case pi.R32F:return t.FLOAT;case pi.R32UI:return t.UNSIGNED_INT;case pi.R32I:return t.INT;case pi.RG8:return t.UNSIGNED_BYTE;case pi.RG8SN:return t.BYTE;case pi.RG8UI:return t.UNSIGNED_BYTE;case pi.RG8I:return t.BYTE;case pi.RG16F:return t.HALF_FLOAT;case pi.RG16UI:return t.UNSIGNED_SHORT;case pi.RG16I:return t.SHORT;case pi.RG32F:return t.FLOAT;case pi.RG32UI:return t.UNSIGNED_INT;case pi.RG32I:return t.INT;case pi.RGB8:case pi.SRGB8:return t.UNSIGNED_BYTE;case pi.RGB8SN:return t.BYTE;case pi.RGB8UI:return t.UNSIGNED_BYTE;case pi.RGB8I:return t.BYTE;case pi.RGB16F:return t.HALF_FLOAT;case pi.RGB16UI:return t.UNSIGNED_SHORT;case pi.RGB16I:return t.SHORT;case pi.RGB32F:return t.FLOAT;case pi.RGB32UI:return t.UNSIGNED_INT;case pi.RGB32I:return t.INT;case pi.BGRA8:case pi.RGBA8:case pi.SRGB8_A8:return t.UNSIGNED_BYTE;case pi.RGBA8SN:return t.BYTE;case pi.RGBA8UI:return t.UNSIGNED_BYTE;case pi.RGBA8I:return t.BYTE;case pi.RGBA16F:return t.HALF_FLOAT;case pi.RGBA16UI:return t.UNSIGNED_SHORT;case pi.RGBA16I:return t.SHORT;case pi.RGBA32F:return t.FLOAT;case pi.RGBA32UI:return t.UNSIGNED_INT;case pi.RGBA32I:return t.INT;case pi.R5G6B5:return t.UNSIGNED_SHORT_5_6_5;case pi.R11G11B10F:return t.UNSIGNED_INT_10F_11F_11F_REV;case pi.RGB5A1:return t.UNSIGNED_SHORT_5_5_5_1;case pi.RGBA4:return t.UNSIGNED_SHORT_4_4_4_4;case pi.RGB10A2:case pi.RGB10A2UI:return t.UNSIGNED_INT_2_10_10_10_REV;case pi.RGB9E5:case pi.DEPTH:return t.FLOAT;case pi.DEPTH_STENCIL:return t.UNSIGNED_INT_24_8;case pi.BC1:case pi.BC1_SRGB:case pi.BC2:case pi.BC2_SRGB:case pi.BC3:case pi.BC3_SRGB:case pi.BC4:return t.UNSIGNED_BYTE;case pi.BC4_SNORM:return t.BYTE;case pi.BC5:return t.UNSIGNED_BYTE;case pi.BC5_SNORM:return t.BYTE;case pi.BC6H_SF16:case pi.BC6H_UF16:return t.FLOAT;case pi.BC7:case pi.BC7_SRGB:case pi.ETC_RGB8:case pi.ETC2_RGB8:case pi.ETC2_SRGB8:case pi.ETC2_RGB8_A1:case pi.ETC2_SRGB8_A1:case pi.EAC_R11:return t.UNSIGNED_BYTE;case pi.EAC_R11SN:return t.BYTE;case pi.EAC_RG11:return t.UNSIGNED_BYTE;case pi.EAC_RG11SN:return t.BYTE;case pi.PVRTC_RGB2:case pi.PVRTC_RGBA2:case pi.PVRTC_RGB4:case pi.PVRTC_RGBA4:case pi.PVRTC2_2BPP:case pi.PVRTC2_4BPP:return t.UNSIGNED_BYTE;case pi.ASTC_RGBA_4X4:case pi.ASTC_RGBA_5X4:case pi.ASTC_RGBA_5X5:case pi.ASTC_RGBA_6X5:case pi.ASTC_RGBA_6X6:case pi.ASTC_RGBA_8X5:case pi.ASTC_RGBA_8X6:case pi.ASTC_RGBA_8X8:case pi.ASTC_RGBA_10X5:case pi.ASTC_RGBA_10X6:case pi.ASTC_RGBA_10X8:case pi.ASTC_RGBA_10X10:case pi.ASTC_RGBA_12X10:case pi.ASTC_RGBA_12X12:case pi.ASTC_SRGBA_4X4:case pi.ASTC_SRGBA_5X4:case pi.ASTC_SRGBA_5X5:case pi.ASTC_SRGBA_6X5:case pi.ASTC_SRGBA_6X6:case pi.ASTC_SRGBA_8X5:case pi.ASTC_SRGBA_8X6:case pi.ASTC_SRGBA_8X8:case pi.ASTC_SRGBA_10X5:case pi.ASTC_SRGBA_10X6:case pi.ASTC_SRGBA_10X8:case pi.ASTC_SRGBA_10X10:case pi.ASTC_SRGBA_12X10:case pi.ASTC_SRGBA_12X12:default:return t.UNSIGNED_BYTE}}function $9(e,t){switch(e){case mi.BOOL:return t.BOOL;case mi.BOOL2:return t.BOOL_VEC2;case mi.BOOL3:return t.BOOL_VEC3;case mi.BOOL4:return t.BOOL_VEC4;case mi.INT:return t.INT;case mi.INT2:return t.INT_VEC2;case mi.INT3:return t.INT_VEC3;case mi.INT4:return t.INT_VEC4;case mi.UINT:return t.UNSIGNED_INT;case mi.FLOAT:return t.FLOAT;case mi.FLOAT2:return t.FLOAT_VEC2;case mi.FLOAT3:return t.FLOAT_VEC3;case mi.FLOAT4:return t.FLOAT_VEC4;case mi.MAT2:return t.FLOAT_MAT2;case mi.MAT2X3:return t.FLOAT_MAT2x3;case mi.MAT2X4:return t.FLOAT_MAT2x4;case mi.MAT3X2:return t.FLOAT_MAT3x2;case mi.MAT3:return t.FLOAT_MAT3;case mi.MAT3X4:return t.FLOAT_MAT3x4;case mi.MAT4X2:return t.FLOAT_MAT4x2;case mi.MAT4X3:return t.FLOAT_MAT4x3;case mi.MAT4:return t.FLOAT_MAT4;case mi.SAMPLER2D:return t.SAMPLER_2D;case mi.SAMPLER2D_ARRAY:return t.SAMPLER_2D_ARRAY;case mi.SAMPLER3D:return t.SAMPLER_3D;case mi.SAMPLER_CUBE:return t.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to GL type failed."),mi.UNKNOWN}}function eee(e,t){switch(e){case t.BOOL:return mi.BOOL;case t.BOOL_VEC2:return mi.BOOL2;case t.BOOL_VEC3:return mi.BOOL3;case t.BOOL_VEC4:return mi.BOOL4;case t.INT:return mi.INT;case t.INT_VEC2:return mi.INT2;case t.INT_VEC3:return mi.INT3;case t.INT_VEC4:return mi.INT4;case t.UNSIGNED_INT:return mi.UINT;case t.UNSIGNED_INT_VEC2:return mi.UINT2;case t.UNSIGNED_INT_VEC3:return mi.UINT3;case t.UNSIGNED_INT_VEC4:return mi.UINT4;case t.FLOAT:return mi.FLOAT;case t.FLOAT_VEC2:return mi.FLOAT2;case t.FLOAT_VEC3:return mi.FLOAT3;case t.FLOAT_VEC4:return mi.FLOAT4;case t.FLOAT_MAT2:return mi.MAT2;case t.FLOAT_MAT2x3:return mi.MAT2X3;case t.FLOAT_MAT2x4:return mi.MAT2X4;case t.FLOAT_MAT3x2:return mi.MAT3X2;case t.FLOAT_MAT3:return mi.MAT3;case t.FLOAT_MAT3x4:return mi.MAT3X4;case t.FLOAT_MAT4x2:return mi.MAT4X2;case t.FLOAT_MAT4x3:return mi.MAT4X3;case t.FLOAT_MAT4:return mi.MAT4;case t.SAMPLER_2D:return mi.SAMPLER2D;case t.SAMPLER_2D_ARRAY:return mi.SAMPLER2D_ARRAY;case t.SAMPLER_3D:return mi.SAMPLER3D;case t.SAMPLER_CUBE:return mi.SAMPLER_CUBE;default:return console.error("Unsupported GLType, convert to Type failed."),mi.UNKNOWN}}function tee(e,t){switch(e){case t.BOOL:return 4;case t.BOOL_VEC2:return 8;case t.BOOL_VEC3:return 12;case t.BOOL_VEC4:return 16;case t.INT:return 4;case t.INT_VEC2:return 8;case t.INT_VEC3:return 12;case t.INT_VEC4:return 16;case t.UNSIGNED_INT:return 4;case t.UNSIGNED_INT_VEC2:return 8;case t.UNSIGNED_INT_VEC3:return 12;case t.UNSIGNED_INT_VEC4:return 16;case t.FLOAT:return 4;case t.FLOAT_VEC2:return 8;case t.FLOAT_VEC3:return 12;case t.FLOAT_VEC4:case t.FLOAT_MAT2:return 16;case t.FLOAT_MAT2x3:return 24;case t.FLOAT_MAT2x4:return 32;case t.FLOAT_MAT3x2:return 24;case t.FLOAT_MAT3:return 36;case t.FLOAT_MAT3x4:return 48;case t.FLOAT_MAT4x2:return 32;case t.FLOAT_MAT4x3:return 48;case t.FLOAT_MAT4:return 64;case t.SAMPLER_2D:case t.SAMPLER_2D_ARRAY:case t.SAMPLER_2D_ARRAY_SHADOW:case t.SAMPLER_3D:case t.SAMPLER_CUBE:case t.INT_SAMPLER_2D:case t.INT_SAMPLER_2D_ARRAY:case t.INT_SAMPLER_3D:case t.INT_SAMPLER_CUBE:case t.UNSIGNED_INT_SAMPLER_2D:case t.UNSIGNED_INT_SAMPLER_2D_ARRAY:case t.UNSIGNED_INT_SAMPLER_3D:case t.UNSIGNED_INT_SAMPLER_CUBE:return 4;default:return console.error("Unsupported GLType, get type failed."),0}}function nee(e,t){switch(e){case t.FLOAT_MAT2:case t.FLOAT_MAT2x3:case t.FLOAT_MAT2x4:return 2;case t.FLOAT_MAT3x2:case t.FLOAT_MAT3:case t.FLOAT_MAT3x4:return 3;case t.FLOAT_MAT4x2:case t.FLOAT_MAT4x3:case t.FLOAT_MAT4:return 4;default:return 1}}var iee,ree=[512,513,514,515,516,517,518,519],oee=[0,7680,7681,7682,7683,5386,34055,34056],aee=[32774,32778,32779,32775,32776],see=[0,1,770,772,771,773,768,774,769,775,776,32769,32770,32771,32772];!function(e){e[e.BEGIN_RENDER_PASS=0]="BEGIN_RENDER_PASS",e[e.END_RENDER_PASS=1]="END_RENDER_PASS",e[e.BIND_STATES=2]="BIND_STATES",e[e.DRAW=3]="DRAW",e[e.UPDATE_BUFFER=4]="UPDATE_BUFFER",e[e.COPY_BUFFER_TO_TEXTURE=5]="COPY_BUFFER_TO_TEXTURE",e[e.COUNT=6]="COUNT"}(iee||(iee={}));var cee=function(e){this.cmdType=void 0,this.refCount=0,this.cmdType=e},lee=function(e){function t(){var t;return(t=e.call(this,iee.BEGIN_RENDER_PASS)||this).gpuRenderPass=null,t.gpuFramebuffer=null,t.renderArea=new tr,t.clearColors=[],t.clearDepth=1,t.clearStencil=0,t}return $(t,e),t.prototype.clear=function(){this.gpuFramebuffer=null,this.clearColors.length=0},t}(cee),uee=function(e){function t(){var t;return(t=e.call(this,iee.BIND_STATES)||this).gpuPipelineState=null,t.gpuInputAssembler=null,t.gpuDescriptorSets=[],t.dynamicOffsets=[],t.dynamicStates=new Jr,t}return $(t,e),t.prototype.clear=function(){this.gpuPipelineState=null,this.gpuInputAssembler=null,this.gpuDescriptorSets.length=0,this.dynamicOffsets.length=0},t}(cee),hee=function(e){function t(){var t;return(t=e.call(this,iee.DRAW)||this).drawInfo=new dr,t}return $(t,e),t.prototype.clear=function(){},t}(cee),fee=function(e){function t(){var t;return(t=e.call(this,iee.UPDATE_BUFFER)||this).gpuBuffer=null,t.buffer=null,t.offset=0,t.size=0,t}return $(t,e),t.prototype.clear=function(){this.gpuBuffer=null,this.buffer=null},t}(cee),_ee=function(e){function t(){var t;return(t=e.call(this,iee.COPY_BUFFER_TO_TEXTURE)||this).gpuTexture=null,t.buffers=[],t.regions=[],t}return $(t,e),t.prototype.clear=function(){this.gpuTexture=null,this.buffers.length=0,this.regions.length=0},t}(cee),pee=function(){function e(){this.cmds=new Yl(1),this.beginRenderPassCmds=new Yl(1),this.bindStatesCmds=new Yl(1),this.drawCmds=new Yl(1),this.updateBufferCmds=new Yl(1),this.copyBufferToTextureCmds=new Yl(1)}return e.prototype.clearCmds=function(e){this.beginRenderPassCmds.length&&(e.beginRenderPassCmdPool.freeCmds(this.beginRenderPassCmds),this.beginRenderPassCmds.clear()),this.bindStatesCmds.length&&(e.bindStatesCmdPool.freeCmds(this.bindStatesCmds),this.bindStatesCmds.clear()),this.drawCmds.length&&(e.drawCmdPool.freeCmds(this.drawCmds),this.drawCmds.clear()),this.updateBufferCmds.length&&(e.updateBufferCmdPool.freeCmds(this.updateBufferCmds),this.updateBufferCmds.clear()),this.copyBufferToTextureCmds.length&&(e.copyBufferToTextureCmdPool.freeCmds(this.copyBufferToTextureCmds),this.copyBufferToTextureCmds.clear()),this.cmds.clear()},e}();function dee(e,t,n,i,r){if(t.usage&vi.INDIRECT){t.indirects.clearDraws();for(var o=n.drawInfos,a=0;a<o.length;++a)t.indirects.setDrawInfo(i+a,o[a])}else{var s=n,c=e.gl,l=e.stateCache;switch(t.glTarget){case c.ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),gee.gpuInputAssembler=null,l.glArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ARRAY_BUFFER,t.glBuffer),l.glArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&l.glVAO&&(c.bindVertexArray(null),l.glVAO=null),gee.gpuInputAssembler=null,l.glElementArrayBuffer!==t.glBuffer&&(c.bindBuffer(c.ELEMENT_ARRAY_BUFFER,t.glBuffer),l.glElementArrayBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,s.slice(0,r));break;case c.UNIFORM_BUFFER:l.glUniformBuffer!==t.glBuffer&&(c.bindBuffer(c.UNIFORM_BUFFER,t.glBuffer),l.glUniformBuffer=t.glBuffer),r===s.byteLength?c.bufferSubData(t.glTarget,i,s):c.bufferSubData(t.glTarget,i,new Float32Array(s,0,r/4));break;default:console.error("Unsupported BufferType, update buffer failed.")}}}function mee(e,t){var n=e.gl;t.glInternalFmt=function(e,t){switch(e){case pi.A8:return t.ALPHA;case pi.L8:return t.LUMINANCE;case pi.LA8:return t.LUMINANCE_ALPHA;case pi.R8:return t.R8;case pi.R8SN:return t.R8_SNORM;case pi.R8UI:return t.R8UI;case pi.R8I:return t.R8I;case pi.RG8:return t.RG8;case pi.RG8SN:return t.RG8_SNORM;case pi.RG8UI:return t.RG8UI;case pi.RG8I:return t.RG8I;case pi.RGB8:return t.RGB8;case pi.RGB8SN:return t.RGB8_SNORM;case pi.RGB8UI:return t.RGB8UI;case pi.RGB8I:return t.RGB8I;case pi.BGRA8:case pi.RGBA8:return t.RGBA8;case pi.RGBA8SN:return t.RGBA8_SNORM;case pi.RGBA8UI:return t.RGBA8UI;case pi.RGBA8I:return t.RGBA8I;case pi.R16I:return t.R16I;case pi.R16UI:return t.R16UI;case pi.R16F:return t.R16F;case pi.RG16I:return t.RG16I;case pi.RG16UI:return t.RG16UI;case pi.RG16F:return t.RG16F;case pi.RGB16I:return t.RGB16I;case pi.RGB16UI:return t.RGB16UI;case pi.RGB16F:return t.RGB16F;case pi.RGBA16I:return t.RGBA16I;case pi.RGBA16UI:return t.RGBA16UI;case pi.RGBA16F:return t.RGBA16F;case pi.R32I:return t.R32I;case pi.R32UI:return t.R32UI;case pi.R32F:return t.R32F;case pi.RG32I:return t.RG32I;case pi.RG32UI:return t.RG32UI;case pi.RG32F:return t.RG32F;case pi.RGB32I:return t.RGB32I;case pi.RGB32UI:return t.RGB32UI;case pi.RGB32F:return t.RGB32F;case pi.RGBA32I:return t.RGBA32I;case pi.RGBA32UI:return t.RGBA32UI;case pi.RGBA32F:return t.RGBA32F;case pi.R5G6B5:return t.RGB565;case pi.RGB5A1:return t.RGB5_A1;case pi.RGBA4:return t.RGBA4;case pi.SRGB8:return t.SRGB8;case pi.SRGB8_A8:return t.SRGB8_ALPHA8;case pi.RGB10A2:return t.RGB10_A2;case pi.RGB10A2UI:return t.RGB10_A2UI;case pi.R11G11B10F:return t.R11F_G11F_B10F;case pi.DEPTH:return t.DEPTH_COMPONENT32F;case pi.DEPTH_STENCIL:return t.DEPTH24_STENCIL8;case pi.BC1:return X9.COMPRESSED_RGB_S3TC_DXT1_EXT;case pi.BC1_ALPHA:return X9.COMPRESSED_RGBA_S3TC_DXT1_EXT;case pi.BC1_SRGB:return X9.COMPRESSED_SRGB_S3TC_DXT1_EXT;case pi.BC1_SRGB_ALPHA:return X9.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case pi.BC2:return X9.COMPRESSED_RGBA_S3TC_DXT3_EXT;case pi.BC2_SRGB:return X9.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case pi.BC3:return X9.COMPRESSED_RGBA_S3TC_DXT5_EXT;case pi.BC3_SRGB:return X9.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case pi.ETC_RGB8:return X9.COMPRESSED_RGB_ETC1_WEBGL;case pi.ETC2_RGB8:return X9.COMPRESSED_RGB8_ETC2;case pi.ETC2_SRGB8:return X9.COMPRESSED_SRGB8_ETC2;case pi.ETC2_RGB8_A1:return X9.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case pi.ETC2_SRGB8_A1:return X9.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case pi.ETC2_RGBA8:return X9.COMPRESSED_RGBA8_ETC2_EAC;case pi.ETC2_SRGB8_A8:return X9.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case pi.EAC_R11:return X9.COMPRESSED_R11_EAC;case pi.EAC_R11SN:return X9.COMPRESSED_SIGNED_R11_EAC;case pi.EAC_RG11:return X9.COMPRESSED_RG11_EAC;case pi.EAC_RG11SN:return X9.COMPRESSED_SIGNED_RG11_EAC;case pi.PVRTC_RGB2:return X9.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case pi.PVRTC_RGBA2:return X9.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case pi.PVRTC_RGB4:return X9.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case pi.PVRTC_RGBA4:return X9.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case pi.ASTC_RGBA_4X4:return X9.COMPRESSED_RGBA_ASTC_4x4_KHR;case pi.ASTC_RGBA_5X4:return X9.COMPRESSED_RGBA_ASTC_5x4_KHR;case pi.ASTC_RGBA_5X5:return X9.COMPRESSED_RGBA_ASTC_5x5_KHR;case pi.ASTC_RGBA_6X5:return X9.COMPRESSED_RGBA_ASTC_6x5_KHR;case pi.ASTC_RGBA_6X6:return X9.COMPRESSED_RGBA_ASTC_6x6_KHR;case pi.ASTC_RGBA_8X5:return X9.COMPRESSED_RGBA_ASTC_8x5_KHR;case pi.ASTC_RGBA_8X6:return X9.COMPRESSED_RGBA_ASTC_8x6_KHR;case pi.ASTC_RGBA_8X8:return X9.COMPRESSED_RGBA_ASTC_8x8_KHR;case pi.ASTC_RGBA_10X5:return X9.COMPRESSED_RGBA_ASTC_10x5_KHR;case pi.ASTC_RGBA_10X6:return X9.COMPRESSED_RGBA_ASTC_10x6_KHR;case pi.ASTC_RGBA_10X8:return X9.COMPRESSED_RGBA_ASTC_10x8_KHR;case pi.ASTC_RGBA_10X10:return X9.COMPRESSED_RGBA_ASTC_10x10_KHR;case pi.ASTC_RGBA_12X10:return X9.COMPRESSED_RGBA_ASTC_12x10_KHR;case pi.ASTC_RGBA_12X12:return X9.COMPRESSED_RGBA_ASTC_12x12_KHR;case pi.ASTC_SRGBA_4X4:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case pi.ASTC_SRGBA_5X4:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case pi.ASTC_SRGBA_5X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case pi.ASTC_SRGBA_6X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case pi.ASTC_SRGBA_6X6:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case pi.ASTC_SRGBA_8X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case pi.ASTC_SRGBA_8X6:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case pi.ASTC_SRGBA_8X8:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case pi.ASTC_SRGBA_10X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case pi.ASTC_SRGBA_10X6:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case pi.ASTC_SRGBA_10X8:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case pi.ASTC_SRGBA_10X10:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case pi.ASTC_SRGBA_12X10:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case pi.ASTC_SRGBA_12X12:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL internal format failed."),t.RGBA}}(t.format,n),t.glFormat=function(e,t){switch(e){case pi.A8:return t.ALPHA;case pi.L8:return t.LUMINANCE;case pi.LA8:return t.LUMINANCE_ALPHA;case pi.R8:case pi.R8SN:return t.RED;case pi.R8UI:case pi.R8I:return t.RED;case pi.RG8:case pi.RG8SN:case pi.RG8UI:case pi.RG8I:return t.RG;case pi.RGB8:case pi.RGB8SN:case pi.RGB8UI:case pi.RGB8I:return t.RGB;case pi.BGRA8:case pi.RGBA8:case pi.RGBA8SN:case pi.RGBA8UI:case pi.RGBA8I:return t.RGBA;case pi.R16UI:case pi.R16I:case pi.R16F:return t.RED;case pi.RG16UI:case pi.RG16I:case pi.RG16F:return t.RG;case pi.RGB16UI:case pi.RGB16I:case pi.RGB16F:return t.RGB;case pi.RGBA16UI:case pi.RGBA16I:case pi.RGBA16F:return t.RGBA;case pi.R32UI:case pi.R32I:case pi.R32F:return t.RED;case pi.RG32UI:case pi.RG32I:case pi.RG32F:return t.RG;case pi.RGB32UI:case pi.RGB32I:case pi.RGB32F:return t.RGB;case pi.RGBA32UI:case pi.RGBA32I:case pi.RGBA32F:case pi.RGB10A2:return t.RGBA;case pi.R11G11B10F:case pi.R5G6B5:return t.RGB;case pi.RGB5A1:case pi.RGBA4:return t.RGBA;case pi.SRGB8:return t.RGB;case pi.SRGB8_A8:return t.RGBA;case pi.DEPTH:return t.DEPTH_COMPONENT;case pi.DEPTH_STENCIL:return t.DEPTH_STENCIL;case pi.BC1:return X9.COMPRESSED_RGB_S3TC_DXT1_EXT;case pi.BC1_ALPHA:return X9.COMPRESSED_RGBA_S3TC_DXT1_EXT;case pi.BC1_SRGB:return X9.COMPRESSED_SRGB_S3TC_DXT1_EXT;case pi.BC1_SRGB_ALPHA:return X9.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case pi.BC2:return X9.COMPRESSED_RGBA_S3TC_DXT3_EXT;case pi.BC2_SRGB:return X9.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case pi.BC3:return X9.COMPRESSED_RGBA_S3TC_DXT5_EXT;case pi.BC3_SRGB:return X9.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case pi.ETC_RGB8:return X9.COMPRESSED_RGB_ETC1_WEBGL;case pi.ETC2_RGB8:return X9.COMPRESSED_RGB8_ETC2;case pi.ETC2_SRGB8:return X9.COMPRESSED_SRGB8_ETC2;case pi.ETC2_RGB8_A1:return X9.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2;case pi.ETC2_SRGB8_A1:return X9.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2;case pi.ETC2_RGBA8:return X9.COMPRESSED_RGBA8_ETC2_EAC;case pi.ETC2_SRGB8_A8:return X9.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC;case pi.EAC_R11:return X9.COMPRESSED_R11_EAC;case pi.EAC_R11SN:return X9.COMPRESSED_SIGNED_R11_EAC;case pi.EAC_RG11:return X9.COMPRESSED_RG11_EAC;case pi.EAC_RG11SN:return X9.COMPRESSED_SIGNED_RG11_EAC;case pi.PVRTC_RGB2:return X9.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;case pi.PVRTC_RGBA2:return X9.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;case pi.PVRTC_RGB4:return X9.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;case pi.PVRTC_RGBA4:return X9.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;case pi.ASTC_RGBA_4X4:return X9.COMPRESSED_RGBA_ASTC_4x4_KHR;case pi.ASTC_RGBA_5X4:return X9.COMPRESSED_RGBA_ASTC_5x4_KHR;case pi.ASTC_RGBA_5X5:return X9.COMPRESSED_RGBA_ASTC_5x5_KHR;case pi.ASTC_RGBA_6X5:return X9.COMPRESSED_RGBA_ASTC_6x5_KHR;case pi.ASTC_RGBA_6X6:return X9.COMPRESSED_RGBA_ASTC_6x6_KHR;case pi.ASTC_RGBA_8X5:return X9.COMPRESSED_RGBA_ASTC_8x5_KHR;case pi.ASTC_RGBA_8X6:return X9.COMPRESSED_RGBA_ASTC_8x6_KHR;case pi.ASTC_RGBA_8X8:return X9.COMPRESSED_RGBA_ASTC_8x8_KHR;case pi.ASTC_RGBA_10X5:return X9.COMPRESSED_RGBA_ASTC_10x5_KHR;case pi.ASTC_RGBA_10X6:return X9.COMPRESSED_RGBA_ASTC_10x6_KHR;case pi.ASTC_RGBA_10X8:return X9.COMPRESSED_RGBA_ASTC_10x8_KHR;case pi.ASTC_RGBA_10X10:return X9.COMPRESSED_RGBA_ASTC_10x10_KHR;case pi.ASTC_RGBA_12X10:return X9.COMPRESSED_RGBA_ASTC_12x10_KHR;case pi.ASTC_RGBA_12X12:return X9.COMPRESSED_RGBA_ASTC_12x12_KHR;case pi.ASTC_SRGBA_4X4:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_4x4_KHR;case pi.ASTC_SRGBA_5X4:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_5x4_KHR;case pi.ASTC_SRGBA_5X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_5x5_KHR;case pi.ASTC_SRGBA_6X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_6x5_KHR;case pi.ASTC_SRGBA_6X6:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_6x6_KHR;case pi.ASTC_SRGBA_8X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x5_KHR;case pi.ASTC_SRGBA_8X6:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x6_KHR;case pi.ASTC_SRGBA_8X8:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_8x8_KHR;case pi.ASTC_SRGBA_10X5:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x5_KHR;case pi.ASTC_SRGBA_10X6:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x6_KHR;case pi.ASTC_SRGBA_10X8:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x8_KHR;case pi.ASTC_SRGBA_10X10:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_10x10_KHR;case pi.ASTC_SRGBA_12X10:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_12x10_KHR;case pi.ASTC_SRGBA_12X12:return X9.COMPRESSED_SRGB8_ALPHA8_ASTC_12x12_KHR;default:return console.error("Unsupported Format, convert to WebGL format failed."),t.RGBA}}(t.format,n),t.glType=J9(t.format,n);var i=t.width,r=t.height;switch(t.type){case Si.TEX2D:if(t.glTarget=n.TEXTURE_2D,t.isSwapchainTexture)break;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),t.samples===Ei.ONE){if(t.glTexture=n.createTexture(),t.size>0){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),eo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ao(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_2D,t.mipLevel,t.glInternalFmt,i,r)}}else t.glRenderbuffer=n.createRenderbuffer(),t.size>0&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Si.CUBE:t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);if(u>e.capabilities.maxCubeMapTextureSize&&M(9100,u,e.capabilities.maxTextureSize),t.glTexture=n.createTexture(),t.size>0){var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),eo[t.format].isCompressed)for(var f=0;f<t.mipLevel;++f){for(var _=ao(t.format,i,r,1),p=new Uint8Array(_),d=0;d<6;++d)n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+d,f,t.glInternalFmt,i,r,0,p);i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else n.texStorage2D(n.TEXTURE_CUBE_MAP,t.mipLevel,t.glInternalFmt,i,r)}break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}function vee(e,t){var n=e.gl;if(t.glTexture){var i=e.stateCache.glTexUnits,r=e.stateCache.texUnit;n.deleteTexture(t.glTexture);for(var o=0;o<i.length;++o)i[o].glTexture===t.glTexture&&(n.activeTexture(n.TEXTURE0+o),r=o,n.bindTexture(t.glTarget,null),i[o].glTexture=null);e.stateCache.texUnit=r,t.glTexture=null}if(t.glRenderbuffer){var a=e.stateCache.glRenderbuffer;n.deleteRenderbuffer(t.glRenderbuffer),a===t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,null),a=null),t.glRenderbuffer=null}}var gee={gpuPipelineState:null,gpuInputAssembler:null,glPrimitive:0,invalidateAttachments:[]};function yee(e,t,n,i,r,o,a){var s=e.gl,c=e.stateCache,l=0;if(n&&t){c.glFramebuffer!==n.glFramebuffer&&(s.bindFramebuffer(s.FRAMEBUFFER,n.glFramebuffer),c.glFramebuffer=n.glFramebuffer),c.viewport.left===i.x&&c.viewport.top===i.y&&c.viewport.width===i.width&&c.viewport.height===i.height||(s.viewport(i.x,i.y,i.width,i.height),c.viewport.left=i.x,c.viewport.top=i.y,c.viewport.width=i.width,c.viewport.height=i.height),c.scissorRect.x===i.x&&c.scissorRect.y===i.y&&c.scissorRect.width===i.width&&c.scissorRect.height===i.height||(s.scissor(i.x,i.y,i.width,i.height),c.scissorRect.x=i.x,c.scissorRect.y=i.y,c.scissorRect.width=i.width,c.scissorRect.height=i.height),gee.invalidateAttachments.length=0;for(var u=0;u<r.length;++u){var h=t.colorAttachments[u];if(h.format!==pi.UNKNOWN)switch(h.loadOp){case Ni.LOAD:break;case Ni.CLEAR:if(c.bs.targets[0].blendColorMask!==Oi.ALL&&s.colorMask(!0,!0,!0,!0),n.isOffscreen)Z9[0]=r[u].x,Z9[1]=r[u].y,Z9[2]=r[u].z,Z9[3]=r[u].w,s.clearBufferfv(s.COLOR,u,Z9);else{var f=r[0];s.clearColor(f.x,f.y,f.z,f.w),l|=s.COLOR_BUFFER_BIT}break;case Ni.DISCARD:gee.invalidateAttachments.push(s.COLOR_ATTACHMENT0+u)}}if(t.depthStencilAttachment&&t.depthStencilAttachment.format!==pi.UNKNOWN){switch(t.depthStencilAttachment.depthLoadOp){case Ni.LOAD:break;case Ni.CLEAR:c.dss.depthWrite||s.depthMask(!0),s.clearDepth(o),l|=s.DEPTH_BUFFER_BIT;break;case Ni.DISCARD:gee.invalidateAttachments.push(s.DEPTH_ATTACHMENT)}if(eo[t.depthStencilAttachment.format].hasStencil)switch(t.depthStencilAttachment.stencilLoadOp){case Ni.LOAD:break;case Ni.CLEAR:c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,65535),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,65535),s.clearStencil(a),l|=s.STENCIL_BUFFER_BIT;break;case Ni.DISCARD:gee.invalidateAttachments.push(s.STENCIL_ATTACHMENT)}}if(n.glFramebuffer&&gee.invalidateAttachments.length&&s.invalidateFramebuffer(s.FRAMEBUFFER,gee.invalidateAttachments),l&&s.clear(l),l&s.COLOR_BUFFER_BIT){var _=c.bs.targets[0].blendColorMask;if(_!==Oi.ALL){var p=(_&Oi.R)!==Oi.NONE,d=(_&Oi.G)!==Oi.NONE,m=(_&Oi.B)!==Oi.NONE,v=(_&Oi.A)!==Oi.NONE;s.colorMask(p,d,m,v)}}l&s.DEPTH_BUFFER_BIT&&!c.dss.depthWrite&&s.depthMask(!1),l&s.STENCIL_BUFFER_BIT&&(c.dss.stencilWriteMaskFront||s.stencilMaskSeparate(s.FRONT,0),c.dss.stencilWriteMaskBack||s.stencilMaskSeparate(s.BACK,0))}}function xee(e,t,n,i,r,o){var a=e.gl,s=e.stateCache,c=t&&t.gpuShader,l=!1;if(t&&gee.gpuPipelineState!==t){if(gee.gpuPipelineState=t,gee.glPrimitive=t.glPrimitive,c){var u=c.glProgram;s.glProgram!==u&&(a.useProgram(u),s.glProgram=u,l=!0)}var h=t.rs;if(h){if(s.rs.cullMode!==h.cullMode){switch(h.cullMode){case Hi.NONE:a.disable(a.CULL_FACE);break;case Hi.FRONT:a.enable(a.CULL_FACE),a.cullFace(a.FRONT);break;case Hi.BACK:a.enable(a.CULL_FACE),a.cullFace(a.BACK)}e.stateCache.rs.cullMode=h.cullMode}var f=h.isFrontFaceCCW;e.stateCache.rs.isFrontFaceCCW!==f&&(a.frontFace(f?a.CCW:a.CW),e.stateCache.rs.isFrontFaceCCW=f),e.stateCache.rs.depthBias===h.depthBias&&e.stateCache.rs.depthBiasSlop===h.depthBiasSlop||(a.polygonOffset(h.depthBias,h.depthBiasSlop),e.stateCache.rs.depthBias=h.depthBias,e.stateCache.rs.depthBiasSlop=h.depthBiasSlop),e.stateCache.rs.lineWidth!==h.lineWidth&&(a.lineWidth(h.lineWidth),e.stateCache.rs.lineWidth=h.lineWidth)}var _=t.dss;_&&(s.dss.depthTest!==_.depthTest&&(_.depthTest?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST),s.dss.depthTest=_.depthTest),s.dss.depthWrite!==_.depthWrite&&(a.depthMask(_.depthWrite),s.dss.depthWrite=_.depthWrite),s.dss.depthFunc!==_.depthFunc&&(a.depthFunc(ree[_.depthFunc]),s.dss.depthFunc=_.depthFunc),s.dss.stencilTestFront===_.stencilTestFront&&s.dss.stencilTestBack===_.stencilTestBack||(_.stencilTestFront||_.stencilTestBack?a.enable(a.STENCIL_TEST):a.disable(a.STENCIL_TEST),s.dss.stencilTestFront=_.stencilTestFront,s.dss.stencilTestBack=_.stencilTestBack),s.dss.stencilFuncFront===_.stencilFuncFront&&s.dss.stencilRefFront===_.stencilRefFront&&s.dss.stencilReadMaskFront===_.stencilReadMaskFront||(a.stencilFuncSeparate(a.FRONT,ree[_.stencilFuncFront],_.stencilRefFront,_.stencilReadMaskFront),s.dss.stencilFuncFront=_.stencilFuncFront,s.dss.stencilRefFront=_.stencilRefFront,s.dss.stencilReadMaskFront=_.stencilReadMaskFront),s.dss.stencilFailOpFront===_.stencilFailOpFront&&s.dss.stencilZFailOpFront===_.stencilZFailOpFront&&s.dss.stencilPassOpFront===_.stencilPassOpFront||(a.stencilOpSeparate(a.FRONT,oee[_.stencilFailOpFront],oee[_.stencilZFailOpFront],oee[_.stencilPassOpFront]),s.dss.stencilFailOpFront=_.stencilFailOpFront,s.dss.stencilZFailOpFront=_.stencilZFailOpFront,s.dss.stencilPassOpFront=_.stencilPassOpFront),s.dss.stencilWriteMaskFront!==_.stencilWriteMaskFront&&(a.stencilMaskSeparate(a.FRONT,_.stencilWriteMaskFront),s.dss.stencilWriteMaskFront=_.stencilWriteMaskFront),s.dss.stencilFuncBack===_.stencilFuncBack&&s.dss.stencilRefBack===_.stencilRefBack&&s.dss.stencilReadMaskBack===_.stencilReadMaskBack||(a.stencilFuncSeparate(a.BACK,ree[_.stencilFuncBack],_.stencilRefBack,_.stencilReadMaskBack),s.dss.stencilFuncBack=_.stencilFuncBack,s.dss.stencilRefBack=_.stencilRefBack,s.dss.stencilReadMaskBack=_.stencilReadMaskBack),s.dss.stencilFailOpBack===_.stencilFailOpBack&&s.dss.stencilZFailOpBack===_.stencilZFailOpBack&&s.dss.stencilPassOpBack===_.stencilPassOpBack||(a.stencilOpSeparate(a.BACK,oee[_.stencilFailOpBack],oee[_.stencilZFailOpBack],oee[_.stencilPassOpBack]),s.dss.stencilFailOpBack=_.stencilFailOpBack,s.dss.stencilZFailOpBack=_.stencilZFailOpBack,s.dss.stencilPassOpBack=_.stencilPassOpBack),s.dss.stencilWriteMaskBack!==_.stencilWriteMaskBack&&(a.stencilMaskSeparate(a.BACK,_.stencilWriteMaskBack),s.dss.stencilWriteMaskBack=_.stencilWriteMaskBack));var p=t.bs;if(p){s.bs.isA2C!==p.isA2C&&(p.isA2C?a.enable(a.SAMPLE_ALPHA_TO_COVERAGE):a.disable(a.SAMPLE_ALPHA_TO_COVERAGE),s.bs.isA2C=p.isA2C),s.bs.blendColor.x===p.blendColor.x&&s.bs.blendColor.y===p.blendColor.y&&s.bs.blendColor.z===p.blendColor.z&&s.bs.blendColor.w===p.blendColor.w||(a.blendColor(p.blendColor.x,p.blendColor.y,p.blendColor.z,p.blendColor.w),s.bs.blendColor.x=p.blendColor.x,s.bs.blendColor.y=p.blendColor.y,s.bs.blendColor.z=p.blendColor.z,s.bs.blendColor.w=p.blendColor.w);var d=p.targets[0],m=s.bs.targets[0];m.blend!==d.blend&&(d.blend?a.enable(a.BLEND):a.disable(a.BLEND),m.blend=d.blend),m.blendEq===d.blendEq&&m.blendAlphaEq===d.blendAlphaEq||(a.blendEquationSeparate(aee[d.blendEq],aee[d.blendAlphaEq]),m.blendEq=d.blendEq,m.blendAlphaEq=d.blendAlphaEq),m.blendSrc===d.blendSrc&&m.blendDst===d.blendDst&&m.blendSrcAlpha===d.blendSrcAlpha&&m.blendDstAlpha===d.blendDstAlpha||(a.blendFuncSeparate(see[d.blendSrc],see[d.blendDst],see[d.blendSrcAlpha],see[d.blendDstAlpha]),m.blendSrc=d.blendSrc,m.blendDst=d.blendDst,m.blendSrcAlpha=d.blendSrcAlpha,m.blendDstAlpha=d.blendDstAlpha),m.blendColorMask!==d.blendColorMask&&(a.colorMask((d.blendColorMask&Oi.R)!==Oi.NONE,(d.blendColorMask&Oi.G)!==Oi.NONE,(d.blendColorMask&Oi.B)!==Oi.NONE,(d.blendColorMask&Oi.A)!==Oi.NONE),m.blendColorMask=d.blendColorMask)}}if(t&&t.gpuPipelineLayout&&c){for(var v=c.glBlocks.length,g=t.gpuPipelineLayout.dynamicOffsetIndices,y=0;y<v;y++){var x=c.glBlocks[y],S=i[x.set],b=S&&S.descriptorIndices[x.binding],E=b>=0&&S.gpuDescriptors[b];if(E&&E.gpuBuffer){var C=g[x.set],A=C&&C[x.binding],w=E.gpuBuffer.glOffset;A>=0&&(w+=r[A]),s.glBindUBOs[x.glBinding]===E.gpuBuffer.glBuffer&&s.glBindUBOOffsets[x.glBinding]===w||(w?a.bindBufferRange(a.UNIFORM_BUFFER,x.glBinding,E.gpuBuffer.glBuffer,w,E.gpuBuffer.size):a.bindBufferBase(a.UNIFORM_BUFFER,x.glBinding,E.gpuBuffer.glBuffer),s.glUniformBuffer=s.glBindUBOs[x.glBinding]=E.gpuBuffer.glBuffer,s.glBindUBOOffsets[x.glBinding]=w)}else T("Buffer binding '"+x.name+"' at set "+x.set+" binding "+x.binding+" is not bounded")}for(var P=c.glSamplerTextures.length,R=0;R<P;R++)for(var I=c.glSamplerTextures[R],D=i[I.set],O=D&&D.descriptorIndices[I.binding],M=O>=0&&D.gpuDescriptors[O],N=0;N<I.units.length;N++){var L=I.units[N],B=s.glTexUnits[L];if(M&&M.gpuTexture&&M.gpuSampler){if(M.gpuTexture&&M.gpuTexture.size>0){var F=M.gpuTexture;B.glTexture!==F.glTexture&&(s.texUnit!==L&&(a.activeTexture(a.TEXTURE0+L),s.texUnit=L),F.glTexture?a.bindTexture(F.glTarget,F.glTexture):a.bindTexture(F.glTarget,e.nullTex2D.gpuTexture.glTexture),B.glTexture=F.glTexture);var z=M.gpuSampler;s.glSamplerUnits[L]!==z.glSampler&&(a.bindSampler(L,z.glSampler),s.glSamplerUnits[L]=z.glSampler)}M=D.gpuDescriptors[++O]}else T("Sampler binding '"+I.name+"' at set "+I.set+" binding "+I.binding+" index "+N+" is not bounded")}}if(n&&c&&(l||gee.gpuInputAssembler!==n))if(gee.gpuInputAssembler=n,e.extensions.useVAO){var U=n.glVAOs.get(c.glProgram);if(!U){var k;U=a.createVertexArray(),n.glVAOs.set(c.glProgram,U),a.bindVertexArray(U),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null;for(var G=0;G<c.glInputs.length;G++){var H=c.glInputs[G];k=null;for(var V=0;V<n.glAttribs.length;V++){var W=n.glAttribs[V];if(W.name===H.name){k=W;break}}if(k){s.glArrayBuffer!==k.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,k.glBuffer),s.glArrayBuffer=k.glBuffer);for(var j=0;j<k.componentCount;++j){var q=H.glLoc+j,X=k.offset+k.size*j;a.enableVertexAttribArray(q),s.glCurrentAttribLocs[q]=!0,a.vertexAttribPointer(q,k.count,k.glType,k.isNormalized,k.stride,X),a.vertexAttribDivisor(q,k.isInstanced?1:0)}}}var Y=n.gpuIndexBuffer;Y&&a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,Y.glBuffer),a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),s.glArrayBuffer=null,s.glElementArrayBuffer=null}s.glVAO!==U&&(a.bindVertexArray(U),s.glVAO=U)}else{for(var K=0;K<e.capabilities.maxVertexAttributes;++K)s.glCurrentAttribLocs[K]=!1;for(var Q=0;Q<c.glInputs.length;Q++){for(var Z=c.glInputs[Q],J=null,$=0;$<n.glAttribs.length;$++){var ee=n.glAttribs[$];if(ee.name===Z.name){J=ee;break}}if(J){s.glArrayBuffer!==J.glBuffer&&(a.bindBuffer(a.ARRAY_BUFFER,J.glBuffer),s.glArrayBuffer=J.glBuffer);for(var te=0;te<J.componentCount;++te){var ne=Z.glLoc+te,ie=J.offset+J.size*te;!s.glEnabledAttribLocs[ne]&&ne>=0&&(a.enableVertexAttribArray(ne),s.glEnabledAttribLocs[ne]=!0),s.glCurrentAttribLocs[ne]=!0,a.vertexAttribPointer(ne,J.count,J.glType,J.isNormalized,J.stride,ie),a.vertexAttribDivisor(ne,J.isInstanced?1:0)}}}var re=n.gpuIndexBuffer;re&&s.glElementArrayBuffer!==re.glBuffer&&(a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,re.glBuffer),s.glElementArrayBuffer=re.glBuffer);for(var oe=0;oe<e.capabilities.maxVertexAttributes;++oe)s.glEnabledAttribLocs[oe]!==s.glCurrentAttribLocs[oe]&&(a.disableVertexAttribArray(oe),s.glEnabledAttribLocs[oe]=!1)}if(t&&t.dynamicStates.length)for(var ae=t.dynamicStates.length,se=0;se<ae;se++)switch(t.dynamicStates[se]){case Vi.LINE_WIDTH:s.rs.lineWidth!==o.lineWidth&&(a.lineWidth(o.lineWidth),s.rs.lineWidth=o.lineWidth);break;case Vi.DEPTH_BIAS:s.rs.depthBias===o.depthBiasConstant&&s.rs.depthBiasSlop===o.depthBiasSlope||(a.polygonOffset(o.depthBiasConstant,o.depthBiasSlope),s.rs.depthBias=o.depthBiasConstant,s.rs.depthBiasSlop=o.depthBiasSlope);break;case Vi.BLEND_CONSTANTS:var ce=o.blendConstant;s.bs.blendColor.x===ce.x&&s.bs.blendColor.y===ce.y&&s.bs.blendColor.z===ce.z&&s.bs.blendColor.w===ce.w||(a.blendColor(ce.x,ce.y,ce.z,ce.w),s.bs.blendColor.copy(ce));break;case Vi.STENCIL_WRITE_MASK:var le=o.stencilStatesFront,ue=o.stencilStatesBack;s.dss.stencilWriteMaskFront!==le.writeMask&&(a.stencilMaskSeparate(a.FRONT,le.writeMask),s.dss.stencilWriteMaskFront=le.writeMask),s.dss.stencilWriteMaskBack!==ue.writeMask&&(a.stencilMaskSeparate(a.BACK,ue.writeMask),s.dss.stencilWriteMaskBack=ue.writeMask);break;case Vi.STENCIL_COMPARE_MASK:var he=o.stencilStatesFront,fe=o.stencilStatesBack;s.dss.stencilRefFront===he.reference&&s.dss.stencilReadMaskFront===he.compareMask||(a.stencilFuncSeparate(a.FRONT,ree[s.dss.stencilFuncFront],he.reference,he.compareMask),s.dss.stencilRefFront=he.reference,s.dss.stencilReadMaskFront=he.compareMask),s.dss.stencilRefBack===fe.reference&&s.dss.stencilReadMaskBack===fe.compareMask||(a.stencilFuncSeparate(a.BACK,ree[s.dss.stencilFuncBack],fe.reference,fe.compareMask),s.dss.stencilRefBack=fe.reference,s.dss.stencilReadMaskBack=fe.compareMask)}}function See(e,t){var n=e.gl,i=gee.gpuInputAssembler,r=gee.glPrimitive,o=e.extensions.WEBGL_multi_draw;if(i){var a=i.gpuIndexBuffer;if(i.gpuIndirectBuffer){var s=i.gpuIndirectBuffer.indirects;if(s.drawByIndex){for(var c=0;c<s.drawCount;c++)s.byteOffsets[c]=s.offsets[c]*a.stride;if(o)s.instancedDraw?o.multiDrawElementsInstancedWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.instances,0,s.drawCount):o.multiDrawElementsWEBGL(r,s.counts,0,i.glIndexType,s.byteOffsets,0,s.drawCount);else for(var l=0;l<s.drawCount;l++)s.instances[l]?n.drawElementsInstanced(r,s.counts[l],i.glIndexType,s.byteOffsets[l],s.instances[l]):n.drawElements(r,s.counts[l],i.glIndexType,s.byteOffsets[l])}else if(o)s.instancedDraw?o.multiDrawArraysInstancedWEBGL(r,s.offsets,0,s.counts,0,s.instances,0,s.drawCount):o.multiDrawArraysWEBGL(r,s.offsets,0,s.counts,0,s.drawCount);else for(var u=0;u<s.drawCount;u++)s.instances[u]?n.drawArraysInstanced(r,s.offsets[u],s.counts[u],s.instances[u]):n.drawArrays(r,s.offsets[u],s.counts[u])}else if(t.instanceCount)if(a){if(t.indexCount>0){var h=t.firstIndex*a.stride;n.drawElementsInstanced(r,t.indexCount,i.glIndexType,h,t.instanceCount)}}else t.vertexCount>0&&n.drawArraysInstanced(r,t.firstVertex,t.vertexCount,t.instanceCount);else if(a){if(t.indexCount>0){var f=t.firstIndex*a.stride;n.drawElements(r,t.indexCount,i.glIndexType,f)}}else t.vertexCount>0&&n.drawArrays(r,t.firstVertex,t.vertexCount)}}var Tee=new Array(iee.COUNT);function bee(e,t){Tee.fill(0);for(var n=0;n<t.cmds.length;++n){var i=t.cmds.array[n],r=Tee[i]++;switch(i){case iee.BEGIN_RENDER_PASS:var o=t.beginRenderPassCmds.array[r];yee(e,o.gpuRenderPass,o.gpuFramebuffer,o.renderArea,o.clearColors,o.clearDepth,o.clearStencil);break;case iee.BIND_STATES:var a=t.bindStatesCmds.array[r];xee(e,a.gpuPipelineState,a.gpuInputAssembler,a.gpuDescriptorSets,a.dynamicOffsets,a.dynamicStates);break;case iee.DRAW:See(e,t.drawCmds.array[r].drawInfo);break;case iee.UPDATE_BUFFER:var s=t.updateBufferCmds.array[r];dee(e,s.gpuBuffer,s.buffer,s.offset,s.size);break;case iee.COPY_BUFFER_TO_TEXTURE:var c=t.copyBufferToTextureCmds.array[r];Eee(e,c.buffers,c.gpuTexture,c.regions)}}}function Eee(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=1,c=1,l=0,u=eo[n.format].isCompressed;switch(n.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];s=f.texExtent.width,c=f.texExtent.height;var _=t[a++];u?n.glInternalFmt!==X9.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,_):r.compressedTexImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,n.glInternalFmt,s,c,0,_):r.texSubImage2D(r.TEXTURE_2D,f.texSubres.mipLevel,f.texOffset.x,f.texOffset.y,s,c,n.glFormat,n.glType,_)}break;case r.TEXTURE_CUBE_MAP:for(var p=0;p<i.length;p++){var d=i[p],m=d.texSubres.baseArrayLayer+d.texSubres.layerCount;for(l=d.texSubres.baseArrayLayer;l<m;++l){s=d.texExtent.width,c=d.texExtent.height;var v=t[a++];u?n.glInternalFmt!==X9.COMPRESSED_RGB_ETC1_WEBGL?r.compressedTexSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,v):r.compressedTexImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,n.glInternalFmt,s,c,0,v):r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+l,d.texSubres.mipLevel,d.texOffset.x,d.texOffset.y,s,c,n.glFormat,n.glType,v)}}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}var Cee=function(){function e(){this.counts=void 0,this.offsets=void 0,this.instances=void 0,this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1,this.byteOffsets=void 0,this._capacity=4,this.counts=new Int32Array(this._capacity),this.offsets=new Int32Array(this._capacity),this.instances=new Int32Array(this._capacity),this.byteOffsets=new Int32Array(this._capacity)}var t=e.prototype;return t.clearDraws=function(){this.drawCount=0,this.drawByIndex=!1,this.instancedDraw=!1},t.setDrawInfo=function(e,t){this._ensureCapacity(e),this.drawByIndex=t.indexCount>0,this.instancedDraw=!!t.instanceCount,this.drawCount=Math.max(e+1,this.drawCount),this.drawByIndex?(this.counts[e]=t.indexCount,this.offsets[e]=t.firstIndex):(this.counts[e]=t.vertexCount,this.offsets[e]=t.firstVertex),this.instances[e]=Math.max(1,t.instanceCount)},t._ensureCapacity=function(e){if(!(this._capacity>e)){this._capacity=a(e);var t=new Int32Array(this._capacity),n=new Int32Array(this._capacity),i=new Int32Array(this._capacity);this.byteOffsets=new Int32Array(this._capacity),t.set(this.counts),n.set(this.offsets),i.set(this.instances),this.counts=t,this.offsets=n,this.instances=i}},e}(),Aee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuBuffer=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){if("buffer"in e){this._isBufferView=!0;var t=e.buffer;this._usage=t.usage,this._memUsage=t.memUsage,this._size=this._stride=e.range,this._count=1,this._flags=t.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:t.gpuBuffer.indirects,glTarget:t.gpuBuffer.glTarget,glBuffer:t.gpuBuffer.glBuffer,glOffset:e.offset}}else this._usage=e.usage,this._memUsage=e.memUsage,this._size=e.size,this._stride=Math.max(e.stride||this._size,1),this._count=this._size/this._stride,this._flags=e.flags,this._gpuBuffer={usage:this._usage,memUsage:this._memUsage,size:this._size,stride:this._stride,buffer:null,indirects:new Cee,glTarget:0,glBuffer:null,glOffset:0},function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&xi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;if(t.usage&vi.VERTEX){t.glTarget=n.ARRAY_BUFFER;var o=n.createBuffer();o&&(t.glBuffer=o,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),gee.gpuInputAssembler=null,e.stateCache.glArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),e.stateCache.glArrayBuffer=t.glBuffer),n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null))}else if(t.usage&vi.INDEX){t.glTarget=n.ELEMENT_ARRAY_BUFFER;var a=n.createBuffer();a&&(t.glBuffer=a,t.size>0&&(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),gee.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&(n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),e.stateCache.glElementArrayBuffer=t.glBuffer),n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null))}else if(t.usage&vi.UNIFORM){t.glTarget=n.UNIFORM_BUFFER;var s=n.createBuffer();s&&t.size>0&&(t.glBuffer=s,e.stateCache.glUniformBuffer!==t.glBuffer&&(n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),e.stateCache.glUniformBuffer=t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null)}else t.usage&vi.INDIRECT||t.usage&vi.TRANSFER_DST||t.usage&vi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE}(K9.instance,this._gpuBuffer),K9.instance.memoryStatus.bufferSize+=this._size},n.destroy=function(){this._gpuBuffer&&(this._isBufferView||(function(e,t){var n=e.gl,i=e.stateCache;if(t.glBuffer){switch(t.glTarget){case n.ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),gee.gpuInputAssembler=null,n.bindBuffer(n.ARRAY_BUFFER,null),e.stateCache.glArrayBuffer=null;break;case n.ELEMENT_ARRAY_BUFFER:e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),e.stateCache.glVAO=null),gee.gpuInputAssembler=null,n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null;break;case n.UNIFORM_BUFFER:n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null}n.deleteBuffer(t.glBuffer),t.glBuffer=null}}(K9.instance,this._gpuBuffer),K9.instance.memoryStatus.bufferSize-=this._size),this._gpuBuffer=null)},n.resize=function(e){if(this._isBufferView)console.warn("cannot resize buffer views!");else{var t=this._size;t!==e&&(this._size=e,this._count=this._size/this._stride,this._gpuBuffer&&(this._gpuBuffer.size=e,e>0&&(function(e,t){var n=e.gl,i=e.stateCache,r=t.memUsage&xi.HOST?n.DYNAMIC_DRAW:n.STATIC_DRAW;t.usage&vi.VERTEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),gee.gpuInputAssembler=null,i.glArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ARRAY_BUFFER,null),i.glArrayBuffer=null):t.usage&vi.INDEX?(e.extensions.useVAO&&i.glVAO&&(n.bindVertexArray(null),i.glVAO=null),gee.gpuInputAssembler=null,e.stateCache.glElementArrayBuffer!==t.glBuffer&&n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,t.glBuffer),t.buffer?n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.buffer,r):n.bufferData(n.ELEMENT_ARRAY_BUFFER,t.size,r),n.bindBuffer(n.ELEMENT_ARRAY_BUFFER,null),e.stateCache.glElementArrayBuffer=null):t.usage&vi.UNIFORM?(e.stateCache.glUniformBuffer!==t.glBuffer&&n.bindBuffer(n.UNIFORM_BUFFER,t.glBuffer),n.bufferData(n.UNIFORM_BUFFER,t.size,r),n.bindBuffer(n.UNIFORM_BUFFER,null),e.stateCache.glUniformBuffer=null):(t.usage&vi.INDIRECT||t.usage&vi.TRANSFER_DST||t.usage&vi.TRANSFER_SRC||console.error("Unsupported BufferType, create buffer failed."),t.glTarget=n.NONE)}(K9.instance,this._gpuBuffer),K9.instance.memoryStatus.bufferSize-=t,K9.instance.memoryStatus.bufferSize+=e)))}},n.update=function(e,t){var n;this._isBufferView?console.warn("cannot update through buffer views!"):(n=void 0!==t?t:this._usage&vi.INDIRECT?0:e.byteLength,dee(K9.instance,this._gpuBuffer,e,0,n))},Z(t,[{key:"gpuBuffer",get:function(){return this._gpuBuffer}}]),t}(fo),wee=function(){function e(e,t){this._frees=void 0,this._freeIdx=0,this._freeCmds=void 0,this._frees=new Array(t),this._freeCmds=new Yl(t);for(var n=0;n<t;++n)this._frees[n]=new e;this._freeIdx=t-1}var t=e.prototype;return t.alloc=function(e){if(this._freeIdx<0){var t=2*this._frees.length,n=this._frees;this._frees=new Array(t);for(var i=t-n.length,r=0;r<i;++r)this._frees[r]=new e;for(var o=i,a=0;o<t;++o,++a)this._frees[o]=n[a];this._freeIdx+=i}var s=this._frees[this._freeIdx];return this._frees[this._freeIdx--]=null,++s.refCount,s},t.free=function(e){0==--e.refCount&&this._freeCmds.push(e)},t.freeCmds=function(e){for(var t=0;t<e.length;++t)0==--e.array[t].refCount&&this._freeCmds.push(e.array[t])},t.release=function(){for(var e=0;e<this._freeCmds.length;++e){var t=this._freeCmds.array[e];t.clear(),this._frees[++this._freeIdx]=t}this._freeCmds.clear()},e}(),Pee=function(){function e(){this.beginRenderPassCmdPool=void 0,this.bindStatesCmdPool=void 0,this.drawCmdPool=void 0,this.updateBufferCmdPool=void 0,this.copyBufferToTextureCmdPool=void 0,this.beginRenderPassCmdPool=new wee(lee,1),this.bindStatesCmdPool=new wee(uee,1),this.drawCmdPool=new wee(hee,1),this.updateBufferCmdPool=new wee(fee,1),this.copyBufferToTextureCmdPool=new wee(_ee,1)}var t=e.prototype;return t.clearCmds=function(e){e.beginRenderPassCmds.length&&(this.beginRenderPassCmdPool.freeCmds(e.beginRenderPassCmds),e.beginRenderPassCmds.clear()),e.bindStatesCmds.length&&(this.bindStatesCmdPool.freeCmds(e.bindStatesCmds),e.bindStatesCmds.clear()),e.drawCmds.length&&(this.drawCmdPool.freeCmds(e.drawCmds),e.drawCmds.clear()),e.updateBufferCmds.length&&(this.updateBufferCmdPool.freeCmds(e.updateBufferCmds),e.updateBufferCmds.clear()),e.copyBufferToTextureCmds.length&&(this.copyBufferToTextureCmdPool.freeCmds(e.copyBufferToTextureCmds),e.copyBufferToTextureCmds.clear()),e.cmds.clear()},t.releaseCmds=function(){this.beginRenderPassCmdPool.release(),this.bindStatesCmdPool.release(),this.drawCmdPool.release(),this.updateBufferCmdPool.release(),this.copyBufferToTextureCmdPool.release()},e}(),Ree=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).cmdPackage=new pee,t._cmdAllocator=new Pee,t._isInRenderPass=!1,t._curGPUPipelineState=null,t._curGPUDescriptorSets=[],t._curGPUInputAssembler=null,t._curDynamicOffsets=Array(8).fill(0),t._curDynamicStates=new Jr,t._isStateInvalied=!1,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type,this._queue=e.queue;for(var t=K9.instance.bindingMappingInfo.bufferOffsets.length,n=0;n<t;n++)this._curGPUDescriptorSets.push(null)},n.destroy=function(){this._cmdAllocator.clearCmds(this.cmdPackage)},n.begin=function(){this._cmdAllocator.clearCmds(this.cmdPackage),this._curGPUPipelineState=null,this._curGPUInputAssembler=null,this._curGPUDescriptorSets.length=0,this._numDrawCalls=0,this._numInstances=0,this._numTris=0},n.end=function(){this._isStateInvalied&&this.bindStates(),this._isInRenderPass=!1},n.beginRenderPass=function(e,t,n,i,r,o){var a=this._cmdAllocator.beginRenderPassCmdPool.alloc(lee);a.gpuRenderPass=e.gpuRenderPass,a.gpuFramebuffer=t.gpuFramebuffer,a.renderArea=n;for(var s=0;s<i.length;++s)a.clearColors[s]=i[s];a.clearDepth=r,a.clearStencil=o,this.cmdPackage.beginRenderPassCmds.push(a),this.cmdPackage.cmds.push(iee.BEGIN_RENDER_PASS),this._isInRenderPass=!0},n.endRenderPass=function(){this._isInRenderPass=!1},n.bindPipelineState=function(e){var t=e.gpuPipelineState;t!==this._curGPUPipelineState&&(this._curGPUPipelineState=t,this._isStateInvalied=!0)},n.bindDescriptorSet=function(e,t,n){var i=t.gpuDescriptorSet;if(i!==this._curGPUDescriptorSets[e]&&(this._curGPUDescriptorSets[e]=i,this._isStateInvalied=!0),n){var r,o=null===(r=this._curGPUPipelineState)||void 0===r?void 0:r.gpuPipelineLayout;if(o){for(var a=this._curDynamicOffsets,s=o.dynamicOffsetOffsets[e],c=0;c<n.length;c++)a[s+c]=n[c];this._isStateInvalied=!0}}},n.bindInputAssembler=function(e){var t=e.gpuInputAssembler;this._curGPUInputAssembler=t,this._isStateInvalied=!0},n.setViewport=function(e){var t=this._curDynamicStates.viewport;t.left===e.left&&t.top===e.top&&t.width===e.width&&t.height===e.height&&t.minDepth===e.minDepth&&t.maxDepth===e.maxDepth||(t.left=e.left,t.top=e.top,t.width=e.width,t.height=e.height,t.minDepth=e.minDepth,t.maxDepth=e.maxDepth,this._isStateInvalied=!0)},n.setScissor=function(e){var t=this._curDynamicStates.scissor;t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height||(t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,this._isStateInvalied=!0)},n.setLineWidth=function(e){this._curDynamicStates.lineWidth!==e&&(this._curDynamicStates.lineWidth=e,this._isStateInvalied=!0)},n.setDepthBias=function(e,t,n){var i=this._curDynamicStates;i.depthBiasConstant===e&&i.depthBiasClamp===t&&i.depthBiasSlope===n||(i.depthBiasConstant=e,i.depthBiasClamp=t,i.depthBiasSlope=n,this._isStateInvalied=!0)},n.setBlendConstants=function(e){var t=this._curDynamicStates.blendConstant;t.x===e.x&&t.y===e.y&&t.z===e.z&&t.w===e.w||(t.copy(e),this._isStateInvalied=!0)},n.setDepthBound=function(e,t){var n=this._curDynamicStates;n.depthMinBounds===e&&n.depthMaxBounds===t||(n.depthMinBounds=e,n.depthMaxBounds=t,this._isStateInvalied=!0)},n.setStencilWriteMask=function(e,t){var n=this._curDynamicStates.stencilStatesFront,i=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&n.writeMask!==t&&(n.writeMask=t,this._isStateInvalied=!0),e&Wi.BACK&&i.writeMask!==t&&(i.writeMask=t,this._isStateInvalied=!0)},n.setStencilCompareMask=function(e,t,n){var i=this._curDynamicStates.stencilStatesFront,r=this._curDynamicStates.stencilStatesBack;e&Wi.FRONT&&(i.compareMask===n&&i.reference===t||(i.reference=t,i.compareMask=n,this._isStateInvalied=!0)),e&Wi.BACK&&(r.compareMask===n&&r.reference===t||(r.reference=t,r.compareMask=n,this._isStateInvalied=!0))},n.draw=function(e){if(this._type===Yi.PRIMARY&&this._isInRenderPass||this._type===Yi.SECONDARY){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e,n=this._cmdAllocator.drawCmdPool.alloc(hee);n.drawInfo.copy(t),this.cmdPackage.drawCmds.push(n),this.cmdPackage.cmds.push(iee.DRAW),++this._numDrawCalls,this._numInstances+=t.instanceCount;var i=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=i/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(i-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.updateBuffer=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=e.gpuBuffer;if(i){var r,o=this._cmdAllocator.updateBufferCmdPool.alloc(fee),a=0;e.usage&vi.INDIRECT||(a=void 0!==n?n:t.byteLength),r=t,o.gpuBuffer=i,o.buffer=r,o.offset=0,o.size=a,this.cmdPackage.updateBufferCmds.push(o),this.cmdPackage.cmds.push(iee.UPDATE_BUFFER)}}else console.error("Command 'updateBuffer' must be recorded outside a render pass.")},n.copyBuffersToTexture=function(e,t,n){if(this._type===Yi.PRIMARY&&!this._isInRenderPass||this._type===Yi.SECONDARY){var i=t.gpuTexture;if(i){var r=this._cmdAllocator.copyBufferToTextureCmdPool.alloc(_ee);r.gpuTexture=i,r.regions=n,r.buffers=e,this.cmdPackage.copyBufferToTextureCmds.push(r),this.cmdPackage.cmds.push(iee.COPY_BUFFER_TO_TEXTURE)}}else console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.")},n.execute=function(e,t){for(var n=0;n<t;++n){for(var i=e[n],r=0;r<i.cmdPackage.beginRenderPassCmds.length;++r){var o=i.cmdPackage.beginRenderPassCmds.array[r];++o.refCount,this.cmdPackage.beginRenderPassCmds.push(o)}for(var a=0;a<i.cmdPackage.bindStatesCmds.length;++a){var s=i.cmdPackage.bindStatesCmds.array[a];++s.refCount,this.cmdPackage.bindStatesCmds.push(s)}for(var c=0;c<i.cmdPackage.drawCmds.length;++c){var l=i.cmdPackage.drawCmds.array[c];++l.refCount,this.cmdPackage.drawCmds.push(l)}for(var u=0;u<i.cmdPackage.updateBufferCmds.length;++u){var h=i.cmdPackage.updateBufferCmds.array[u];++h.refCount,this.cmdPackage.updateBufferCmds.push(h)}for(var f=0;f<i.cmdPackage.copyBufferToTextureCmds.length;++f){var _=i.cmdPackage.copyBufferToTextureCmds.array[f];++_.refCount,this.cmdPackage.copyBufferToTextureCmds.push(_)}this.cmdPackage.cmds.concat(i.cmdPackage.cmds.array),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.pipelineBarrier=function(){},n.bindStates=function(){var e=this._cmdAllocator.bindStatesCmdPool.alloc(uee);e.gpuPipelineState=this._curGPUPipelineState,Array.prototype.push.apply(e.gpuDescriptorSets,this._curGPUDescriptorSets),Array.prototype.push.apply(e.dynamicOffsets,this._curDynamicOffsets),e.gpuInputAssembler=this._curGPUInputAssembler,e.dynamicStates=this._curDynamicStates,this.cmdPackage.bindStatesCmds.push(e),this.cmdPackage.cmds.push(iee.BIND_STATES),this._isStateInvalied=!1},t}(_o),Iee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuFramebuffer=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._renderPass=e.renderPass,this._colorTextures=e.colorTextures||[],this._depthStencilTexture=e.depthStencilTexture||null;for(var t=[],n=0;n<e.colorTextures.length;n++){var i=e.colorTextures[n];i&&t.push(i.gpuTexture)}var r=null;e.depthStencilTexture&&(r=e.depthStencilTexture.gpuTexture);var o=Number.MAX_SAFE_INTEGER,a=Number.MAX_SAFE_INTEGER;this._gpuFramebuffer={gpuRenderPass:e.renderPass.gpuRenderPass,gpuColorTextures:t,gpuDepthStencilTexture:r,glFramebuffer:null,isOffscreen:!0,get width(){return this.isOffscreen?o:this.gpuColorTextures[0].width},set width(e){o=e},get height(){return this.isOffscreen?a:this.gpuColorTextures[0].height},set height(e){a=e}},function(e,t){for(var n=0;n<t.gpuColorTextures.length;++n)if(t.gpuColorTextures[n].isSwapchainTexture)return void(t.isOffscreen=!1);var i=e.gl,r=[],o=i.createFramebuffer();if(o){t.glFramebuffer=o,e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,t.glFramebuffer);for(var a=0;a<t.gpuColorTextures.length;++a){var s=t.gpuColorTextures[a];s&&(s.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,s.glTarget,s.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0+a,i.RENDERBUFFER,s.glRenderbuffer),r.push(i.COLOR_ATTACHMENT0+a),t.width=Math.min(t.width,s.width),t.height=Math.min(t.height,s.height))}var c=t.gpuDepthStencilTexture;if(c){var l=eo[c.format].hasStencil?i.DEPTH_STENCIL_ATTACHMENT:i.DEPTH_ATTACHMENT;c.glTexture?i.framebufferTexture2D(i.FRAMEBUFFER,l,c.glTarget,c.glTexture,0):i.framebufferRenderbuffer(i.FRAMEBUFFER,l,i.RENDERBUFFER,c.glRenderbuffer),t.width=Math.min(t.width,c.width),t.height=Math.min(t.height,c.height)}i.drawBuffers(r);var u=i.checkFramebufferStatus(i.FRAMEBUFFER);if(u!==i.FRAMEBUFFER_COMPLETE)switch(u){case i.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case i.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case i.FRAMEBUFFER_UNSUPPORTED:console.error("glCheckFramebufferStatus() - FRAMEBUFFER_UNSUPPORTED")}e.stateCache.glFramebuffer!==t.glFramebuffer&&i.bindFramebuffer(i.FRAMEBUFFER,e.stateCache.glFramebuffer)}}(K9.instance,this._gpuFramebuffer)},n.destroy=function(){var e,t;this._gpuFramebuffer&&(e=K9.instance,(t=this._gpuFramebuffer).glFramebuffer&&(e.gl.deleteFramebuffer(t.glFramebuffer),e.stateCache.glFramebuffer===t.glFramebuffer&&(e.gl.bindFramebuffer(e.gl.FRAMEBUFFER,null),e.stateCache.glFramebuffer=null),t.glFramebuffer=null),this._gpuFramebuffer=null)},Z(t,[{key:"gpuFramebuffer",get:function(){return this._gpuFramebuffer}}]),t}(vo),Dee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuInputAssembler=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){if(0!==e.vertexBuffers.length){if(this._attributes=e.attributes,this._attributesHash=this.computeAttributesHash(),this._vertexBuffers=e.vertexBuffers,e.indexBuffer)this._indexBuffer=e.indexBuffer,this._drawInfo.indexCount=this._indexBuffer.size/this._indexBuffer.stride,this._drawInfo.firstIndex=0;else{var t=this._vertexBuffers[0];this._drawInfo.vertexCount=t.size/t.stride,this._drawInfo.firstVertex=0,this._drawInfo.vertexOffset=0}this._drawInfo.instanceCount=0,this._drawInfo.firstInstance=0,this._indirectBuffer=e.indirectBuffer||null;for(var n=new Array(e.vertexBuffers.length),i=0;i<e.vertexBuffers.length;++i){var r=e.vertexBuffers[i];r.gpuBuffer&&(n[i]=r.gpuBuffer)}var o=null,a=0;if(e.indexBuffer&&(o=e.indexBuffer.gpuBuffer))switch(o.stride){case 1:a=5121;break;case 2:a=5123;break;case 4:a=5125;break;default:console.error("Illegal index buffer stride.")}var s=null;e.indirectBuffer&&(s=e.indirectBuffer.gpuBuffer),this._gpuInputAssembler={attributes:e.attributes,gpuVertexBuffers:n,gpuIndexBuffer:o,gpuIndirectBuffer:s,glAttribs:[],glIndexType:a,glVAOs:new Map},function(e,t){var n=e.gl;t.glAttribs=new Array(t.attributes.length);for(var i=[0,0,0,0,0,0,0,0],r=0;r<t.attributes.length;++r){var o=t.attributes[r],a=void 0!==o.stream?o.stream:0,s=t.gpuVertexBuffers[a],c=J9(o.format,n),l=eo[o.format].size;t.glAttribs[r]={name:o.name,glBuffer:s.glBuffer,glType:c,size:l,count:eo[o.format].count,stride:s.stride,componentCount:nee(c,n),isNormalized:void 0!==o.isNormalized&&o.isNormalized,isInstanced:void 0!==o.isInstanced&&o.isInstanced,offset:i[a]},i[a]+=l}}(K9.instance,this._gpuInputAssembler)}else console.error("InputAssemblerInfo.vertexBuffers is null.")},n.destroy=function(){var e=K9.instance;this._gpuInputAssembler&&e.extensions.useVAO&&function(e,t){for(var n=t.glVAOs.values(),i=n.next(),r=e.gl,o=e.stateCache.glVAO;!i.done;)r.deleteVertexArray(i.value),o===i.value&&(r.bindVertexArray(null),o=null),i=n.next();e.stateCache.glVAO=o,t.glVAOs.clear()}(e,this._gpuInputAssembler),this._gpuInputAssembler=null},Z(t,[{key:"gpuInputAssembler",get:function(){return this._gpuInputAssembler}}]),t}(So),Oee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuDescriptorSetLayout=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._bindings,e.bindings);for(var t=0,n=-1,i=[],r=0;r<this._bindings.length;r++){var o=this._bindings[r];i.push(t),t+=o.count,o.binding>n&&(n=o.binding)}this._bindingIndices=Array(n+1).fill(-1);for(var a=this._descriptorIndices=Array(n+1).fill(-1),s=0;s<this._bindings.length;s++){var c=this._bindings[s];this._bindingIndices[c.binding]=s,a[c.binding]=i[s]}for(var l=[],u=0;u<this._bindings.length;u++){var h=this._bindings[u];if(h.descriptorType&io)for(var f=0;f<h.count;f++)l.push(h.binding)}this._gpuDescriptorSetLayout={bindings:this._bindings,dynamicBindings:l,descriptorIndices:a,descriptorCount:t}},n.destroy=function(){this._bindings.length=0},Z(t,[{key:"gpuDescriptorSetLayout",get:function(){return this._gpuDescriptorSetLayout}}]),t}(bo),Mee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineLayout=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){Array.prototype.push.apply(this._setLayouts,e.setLayouts);for(var t=[],n=[],i=0,r=[],o=0;o<this._setLayouts.length;o++){for(var a=this._setLayouts[o],s=a.gpuDescriptorSetLayout.dynamicBindings,c=Array(a.bindingIndices.length).fill(-1),l=0;l<s.length;l++){var u=s[l];c[u]<0&&(c[u]=i+l)}n.push(a.gpuDescriptorSetLayout),t.push(c),r.push(i),i+=s.length}this._gpuPipelineLayout={gpuSetLayouts:n,dynamicOffsetIndices:t,dynamicOffsetCount:i,dynamicOffsetOffsets:r}},n.destroy=function(){this._setLayouts.length=0},Z(t,[{key:"gpuPipelineLayout",get:function(){return this._gpuPipelineLayout}}]),t}(Eo),Nee=[0,1,3,2,0,0,0,4,5,6,0,0,0,0],Lee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuPipelineState=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._primitive=e.primitive,this._shader=e.shader,this._pipelineLayout=e.pipelineLayout;var t=this._bs;if(e.blendState){var n=e.blendState,i=n.targets;i&&i.forEach((function(e,n){t.setTarget(n,e)})),void 0!==n.isA2C&&(t.isA2C=n.isA2C),void 0!==n.isIndepend&&(t.isIndepend=n.isIndepend),void 0!==n.blendColor&&(t.blendColor=n.blendColor)}Object.assign(this._rs,e.rasterizerState),Object.assign(this._dss,e.depthStencilState),this._is=e.inputState,this._renderPass=e.renderPass,this._dynamicStates=e.dynamicStates;for(var r=[],o=0;o<31;o++)this._dynamicStates&1<<o&&r.push(1<<o);this._gpuPipelineState={glPrimitive:Nee[e.primitive],gpuShader:e.shader.gpuShader,gpuPipelineLayout:e.pipelineLayout.gpuPipelineLayout,rs:e.rasterizerState,dss:e.depthStencilState,bs:e.blendState,gpuRenderPass:e.renderPass.gpuRenderPass,dynamicStates:r}},n.destroy=function(){this._gpuPipelineState=null},Z(t,[{key:"gpuPipelineState",get:function(){return this._gpuPipelineState}}]),t}(Io),Bee=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.beginRenderPass=function(e,t,n,i,r,o){yee(K9.instance,e.gpuRenderPass,t.gpuFramebuffer,n,i,r,o),this._isInRenderPass=!0},n.draw=function(e){if(this._isInRenderPass){this._isStateInvalied&&this.bindStates();var t="drawInfo"in e?e.drawInfo:e;See(K9.instance,t),++this._numDrawCalls,this._numInstances+=t.instanceCount;var n=t.indexCount||t.vertexCount;if(this._curGPUPipelineState)switch(this._curGPUPipelineState.glPrimitive){case 4:this._numTris+=n/3*Math.max(t.instanceCount,1);break;case 5:case 6:this._numTris+=(n-2)*Math.max(t.instanceCount,1)}}else console.error("Command 'draw' must be recorded inside a render pass.")},n.setViewport=function(e){var t=K9.instance,n=t.stateCache,i=t.gl;n.viewport.left===e.left&&n.viewport.top===e.top&&n.viewport.width===e.width&&n.viewport.height===e.height||(i.viewport(e.left,e.top,e.width,e.height),n.viewport.left=e.left,n.viewport.top=e.top,n.viewport.width=e.width,n.viewport.height=e.height)},n.setScissor=function(e){var t=K9.instance,n=t.stateCache,i=t.gl;n.scissorRect.x===e.x&&n.scissorRect.y===e.y&&n.scissorRect.width===e.width&&n.scissorRect.height===e.height||(i.scissor(e.x,e.y,e.width,e.height),n.scissorRect.x=e.x,n.scissorRect.y=e.y,n.scissorRect.width=e.width,n.scissorRect.height=e.height)},n.updateBuffer=function(e,t,n){if(this._isInRenderPass)console.error("Command 'updateBuffer' must be recorded outside a render pass.");else{var i,r=e.gpuBuffer;r&&(i=void 0!==n?n:e.usage&vi.INDIRECT?0:t.byteLength,dee(K9.instance,r,t,0,i))}},n.copyBuffersToTexture=function(e,t,n){if(this._isInRenderPass)console.error("Command 'copyBufferToTexture' must be recorded outside a render pass.");else{var i=t.gpuTexture;i&&Eee(K9.instance,e,i,n)}},n.execute=function(e,t){for(var n=0;n<t;++n){var i=e[n];bee(K9.instance,i.cmdPackage),this._numDrawCalls+=i._numDrawCalls,this._numInstances+=i._numInstances,this._numTris+=i._numTris}},n.bindStates=function(){xee(K9.instance,this._curGPUPipelineState,this._curGPUInputAssembler,this._curGPUDescriptorSets,this._curDynamicOffsets,this._curDynamicStates),this._isStateInvalied=!1},t}(Ree),Fee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).numDrawCalls=0,t.numInstances=0,t.numTris=0,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._type=e.type},n.destroy=function(){},n.submit=function(e){for(var t=0;t<e.length;t++){var n=e[t];this.numDrawCalls+=n.numDrawCalls,this.numInstances+=n.numInstances,this.numTris+=n.numTris}},n.clear=function(){this.numDrawCalls=0,this.numInstances=0,this.numTris=0},t}(Do),zee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuRenderPass=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._colorInfos=e.colorAttachments,this._depthStencilInfo=e.depthStencilAttachment,this._subpasses=e.subpasses,this._gpuRenderPass={colorAttachments:this._colorInfos,depthStencilAttachment:this._depthStencilInfo},this._hash=this.computeHash()},n.destroy=function(){this._gpuRenderPass=null},Z(t,[{key:"gpuRenderPass",get:function(){return this._gpuRenderPass}}]),t}(Oo),Uee=function(e){function t(t,n){var i,r,o,a,s;return(i=e.call(this,t,n)||this)._gpuSampler=null,i._gpuSampler={glSampler:null,minFilter:i._info.minFilter,magFilter:i._info.magFilter,mipFilter:i._info.mipFilter,addressU:i._info.addressU,addressV:i._info.addressV,addressW:i._info.addressW,glMinFilter:0,glMagFilter:0,glWrapS:0,glWrapT:0,glWrapR:0},r=K9.instance,o=i._gpuSampler,(s=(a=r.gl).createSampler())&&(o.minFilter===Ai.LINEAR||o.minFilter===Ai.ANISOTROPIC?o.mipFilter===Ai.LINEAR||o.mipFilter===Ai.ANISOTROPIC?o.glMinFilter=a.LINEAR_MIPMAP_LINEAR:o.mipFilter===Ai.POINT?o.glMinFilter=a.LINEAR_MIPMAP_NEAREST:o.glMinFilter=a.LINEAR:o.mipFilter===Ai.LINEAR||o.mipFilter===Ai.ANISOTROPIC?o.glMinFilter=a.NEAREST_MIPMAP_LINEAR:o.mipFilter===Ai.POINT?o.glMinFilter=a.NEAREST_MIPMAP_NEAREST:o.glMinFilter=a.NEAREST,o.magFilter===Ai.LINEAR||o.magFilter===Ai.ANISOTROPIC?o.glMagFilter=a.LINEAR:o.glMagFilter=a.NEAREST,o.glWrapS=Q9[o.addressU],o.glWrapT=Q9[o.addressV],o.glWrapR=Q9[o.addressW],o.glSampler=s,a.samplerParameteri(s,a.TEXTURE_MIN_FILTER,o.glMinFilter),a.samplerParameteri(s,a.TEXTURE_MAG_FILTER,o.glMagFilter),a.samplerParameteri(s,a.TEXTURE_WRAP_S,o.glWrapS),a.samplerParameteri(s,a.TEXTURE_WRAP_T,o.glWrapT),a.samplerParameteri(s,a.TEXTURE_WRAP_R,o.glWrapR),a.samplerParameterf(s,a.TEXTURE_MIN_LOD,0),a.samplerParameterf(s,a.TEXTURE_MAX_LOD,1e3)),i}return $(t,e),t.prototype.destroy=function(){this._gpuSampler&&(function(e,t){var n=e.gl;if(t.glSampler){n.deleteSampler(t.glSampler);for(var i=e.stateCache.glSamplerUnits,r=0;r<i.length;++r)i[r]===t.glSampler&&(n.bindSampler(r,null),i[r]=null);t.glSampler=null}}(K9.instance,this._gpuSampler),this._gpuSampler=null)},Z(t,[{key:"gpuSampler",get:function(){return this._gpuSampler}}]),t}(Mo),kee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuShader=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._name=e.name,this._stages=e.stages,this._attributes=e.attributes,this._blocks=e.blocks,this._samplers=e.samplers,this._gpuShader={name:e.name,blocks:e.blocks.slice(),samplerTextures:e.samplerTextures.slice(),subpassInputs:e.subpassInputs.slice(),gpuStages:new Array(e.stages.length),glProgram:null,glInputs:[],glUniforms:[],glBlocks:[],glSamplerTextures:[]};for(var t=0;t<e.stages.length;++t){var n=e.stages[t];this._gpuShader.gpuStages[t]={type:n.stage,source:n.source,glShader:null}}!function(e,t){for(var n=e.gl,i=function(e){var i=t.gpuStages[e],r=0,o="",a=1;switch(i.type){case Mi.VERTEX:o="VertexShader",r=n.VERTEX_SHADER;break;case Mi.FRAGMENT:o="FragmentShader",r=n.FRAGMENT_SHADER;break;default:return console.error("Unsupported ShaderType."),{v:void 0}}var s=n.createShader(r);if(s&&(i.glShader=s,n.shaderSource(i.glShader,"#version 300 es\n"+i.source),n.compileShader(i.glShader),!n.getShaderParameter(i.glShader,n.COMPILE_STATUS))){console.error(o+" in '"+t.name+"' compilation failed."),console.error("Shader source dump:",i.source.replace(/^|\n/g,(function(){return"\n"+a+++" "}))),console.error(n.getShaderInfoLog(i.glShader));for(var c=0;c<t.gpuStages.length;c++){var l=t.gpuStages[e];l.glShader&&(n.deleteShader(l.glShader),l.glShader=null)}return{v:void 0}}},r=0;r<t.gpuStages.length;r++){var o=i(r);if("object"==typeof o)return o.v}var a=n.createProgram();if(a){t.glProgram=a;for(var s=0;s<t.gpuStages.length;s++){var c=t.gpuStages[s];n.attachShader(t.glProgram,c.glShader)}n.linkProgram(t.glProgram);for(var l=0;l<t.gpuStages.length;l++){var u=t.gpuStages[l];u.glShader&&(n.detachShader(t.glProgram,u.glShader),n.deleteShader(u.glShader),u.glShader=null)}if(!n.getProgramParameter(t.glProgram,n.LINK_STATUS))return console.error("Failed to link shader '"+t.name+"'."),void console.error(n.getProgramInfoLog(t.glProgram));E("Shader '"+t.name+"' compilation succeeded.");var h=n.getProgramParameter(t.glProgram,n.ACTIVE_ATTRIBUTES);t.glInputs=new Array(h);for(var f=0;f<h;++f){var _=n.getActiveAttrib(t.glProgram,f);if(_){var p,d=_.name.indexOf("[");p=-1!==d?_.name.substr(0,d):_.name;var m=n.getAttribLocation(t.glProgram,p),v=eee(_.type,n),g=tee(_.type,n);t.glInputs[f]={name:p,type:v,stride:g,count:_.size,size:g*_.size,glType:_.type,glLoc:m}}}var y,x,S,b,C=n.getProgramParameter(t.glProgram,n.ACTIVE_UNIFORM_BLOCKS);if(C){t.glBlocks=new Array(C);for(var A=0;A<C;++A){var w=(y=n.getActiveUniformBlockName(t.glProgram,A)).indexOf("[");-1!==w&&(y=y.substr(0,w)),b=null;for(var P=0;P<t.blocks.length;P++)if(t.blocks[P].name===y){b=t.blocks[P];break}if(b){x=A,S=n.getActiveUniformBlockParameter(t.glProgram,x,n.UNIFORM_BLOCK_DATA_SIZE);var R=b.binding+(e.bindingMappingInfo.bufferOffsets[b.set]||0);n.uniformBlockBinding(t.glProgram,x,R),t.glBlocks[A]={set:b.set,binding:b.binding,idx:x,name:y,size:S,glBinding:R}}else T("Block '"+y+"' does not bound")}}for(var I=0;I<t.subpassInputs.length;++I){var D=t.subpassInputs[I];t.samplerTextures.push(new br(D.set,D.binding,D.name,mi.SAMPLER2D,D.count))}if(t.samplerTextures.length>0){t.glSamplerTextures=new Array(t.samplerTextures.length);for(var O=0;O<t.samplerTextures.length;++O){var M=t.samplerTextures[O];t.glSamplerTextures[O]={set:M.set,binding:M.binding,name:M.name,type:M.type,count:M.count,units:[],glUnits:null,glType:$9(M.type,n),glLoc:null}}}for(var N=[],L=[],B=e.stateCache.texUnitCacheMap,F=0,z=0;z<t.blocks.length;++z)t.blocks[z].set===e.bindingMappingInfo.flexibleSet&&F++;for(var U=0,k=0;k<t.samplerTextures.length;++k){var G=t.samplerTextures[k],H=n.getUniformLocation(t.glProgram,G.name);if(H&&-1!==H.id&&(N.push(t.glSamplerTextures[k]),L.push(H)),void 0===B[G.name]){var V=G.binding+e.bindingMappingInfo.samplerOffsets[G.set]+U;G.set===e.bindingMappingInfo.flexibleSet&&(V-=F),B[G.name]=V%e.capabilities.maxTextureUnits,U+=G.count-1}}if(N.length){for(var W=[],j=0;j<N.length;++j){var q=N[j],X=B[q.name];if(void 0!==X){q.glLoc=L[j];for(var Y=0;Y<q.count;++Y){for(;W[X];)X=(X+1)%e.capabilities.maxTextureUnits;q.units.push(X),W[X]=!0}}}for(var K=0,Q=0;Q<N.length;++Q){var Z=N[Q];if(!Z.glLoc){for(Z.glLoc=L[Q];W[K];)K++;for(var J=0;J<Z.count;++J){for(;W[K];)K=(K+1)%e.capabilities.maxTextureUnits;void 0===B[Z.name]&&(B[Z.name]=K),Z.units.push(K),W[K]=!0}}}e.stateCache.glProgram!==t.glProgram&&n.useProgram(t.glProgram);for(var $=0;$<N.length;$++){var ee=N[$];ee.glUnits=new Int32Array(ee.units),n.uniform1iv(ee.glLoc,ee.glUnits)}e.stateCache.glProgram!==t.glProgram&&n.useProgram(e.stateCache.glProgram)}t.glSamplerTextures=N}}(K9.instance,this._gpuShader)},n.destroy=function(){var e,t;this._gpuShader&&(e=K9.instance,(t=this._gpuShader).glProgram&&(e.gl.deleteProgram(t.glProgram),e.stateCache.glProgram===t.glProgram&&(e.gl.useProgram(null),e.stateCache.glProgram=null),t.glProgram=null),this._gpuShader=null)},Z(t,[{key:"gpuShader",get:function(){return this._gpuShader}}]),t}(No),Gee=function(){function e(){this.glArrayBuffer=null,this.glElementArrayBuffer=null,this.glUniformBuffer=null,this.glBindUBOs=[],this.glBindUBOOffsets=[],this.glVAO=null,this.texUnit=0,this.glTexUnits=[],this.glSamplerUnits=[],this.glRenderbuffer=null,this.glFramebuffer=null,this.glReadFramebuffer=null,this.viewport=new cr,this.scissorRect=new tr(0,0,0,0),this.rs=new Co,this.dss=new Ao,this.bs=new Po,this.glProgram=null,this.glEnabledAttribLocs=[],this.glCurrentAttribLocs=[],this.texUnitCacheMap={}}return e.prototype.initialize=function(e,t,n){for(var i=0;i<e;++i)this.glTexUnits.push({glTexture:null});this.glSamplerUnits.length=e,this.glSamplerUnits.fill(null),this.glBindUBOs.length=t,this.glBindUBOs.fill(null),this.glBindUBOOffsets.length=t,this.glBindUBOOffsets.fill(0),this.glEnabledAttribLocs.length=n,this.glEnabledAttribLocs.fill(!1),this.glCurrentAttribLocs.length=n,this.glCurrentAttribLocs.fill(!1)},e}(),Hee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._gpuTexture=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e,t){"texture"in e?console.log("WebGL2 does not support texture view."):(this._type=e.type,this._usage=e.usage,this._format=e.format,this._width=e.width,this._height=e.height,this._depth=e.depth,this._layerCount=e.layerCount,this._levelCount=e.levelCount,this._samples=e.samples,this._flags=e.flags,this._isPowerOf2=oo(this._width)&&oo(this._height),this._size=so(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture={type:this._type,format:this._format,usage:this._usage,width:this._width,height:this._height,depth:this._depth,size:this._size,arrayLayer:this._layerCount,mipLevel:this._levelCount,samples:this._samples,flags:this._flags,isPowerOf2:this._isPowerOf2,glTarget:0,glInternalFmt:0,glFormat:0,glType:0,glUsage:0,glTexture:null,glRenderbuffer:null,glWrapS:0,glWrapT:0,glMinFilter:0,glMagFilter:0,isSwapchainTexture:t||!1},mee(K9.instance,this._gpuTexture),K9.instance.memoryStatus.textureSize+=this._size)},n.destroy=function(){this._gpuTexture&&(vee(K9.instance,this._gpuTexture),K9.instance.memoryStatus.textureSize-=this._size,this._gpuTexture=null)},n.resize=function(e,t){var n=this._size;this._width=e,this._height=t,this._size=so(this._format,this.width,this.height,this.depth,this._levelCount)*this._layerCount,this._gpuTexture&&(this._gpuTexture.width=e,this._gpuTexture.height=t,this._gpuTexture.size=this._size,function(e,t){if(t.size){var n=e.gl,i=t.width,r=t.height;switch(t.type){case Si.TEX2D:t.glTarget=n.TEXTURE_2D;var o=Math.max(i,r);if(o>e.capabilities.maxTextureSize&&M(9100,o,e.capabilities.maxTextureSize),t.samples===Ei.ONE){var a=e.stateCache.glTexUnits[e.stateCache.texUnit];if(a.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_2D,t.glTexture),a.glTexture=t.glTexture),eo[t.format].isCompressed)for(var s=0;s<t.mipLevel;++s){var c=ao(t.format,i,r,1),l=new Uint8Array(c);n.compressedTexImage2D(n.TEXTURE_2D,s,t.glInternalFmt,i,r,0,l),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}else vee(e,t),mee(e,t)}else t.glRenderbuffer&&(e.stateCache.glRenderbuffer!==t.glRenderbuffer&&(n.bindRenderbuffer(n.RENDERBUFFER,t.glRenderbuffer),e.stateCache.glRenderbuffer=t.glRenderbuffer),n.renderbufferStorageMultisample(n.RENDERBUFFER,t.samples,t.glInternalFmt,t.width,t.height));break;case Si.CUBE:t.type=Si.CUBE,t.glTarget=n.TEXTURE_CUBE_MAP;var u=Math.max(i,r);u>e.capabilities.maxCubeMapTextureSize&&M(9100,u,e.capabilities.maxTextureSize);var h=e.stateCache.glTexUnits[e.stateCache.texUnit];if(h.glTexture!==t.glTexture&&(n.bindTexture(n.TEXTURE_CUBE_MAP,t.glTexture),h.glTexture=t.glTexture),eo[t.format].isCompressed)for(var f=0;f<6;++f){i=t.width,r=t.height;for(var _=0;_<t.mipLevel;++_){var p=ao(t.format,i,r,1),d=new Uint8Array(p);n.compressedTexImage2D(n.TEXTURE_CUBE_MAP_POSITIVE_X+f,_,t.glInternalFmt,i,r,0,d),i=Math.max(1,i>>1),r=Math.max(1,r>>1)}}else vee(e,t),mee(e,t);break;default:console.error("Unsupported TextureType, create texture failed."),t.type=Si.TEX2D,t.glTarget=n.TEXTURE_2D}}}(K9.instance,this._gpuTexture),K9.instance.memoryStatus.textureSize-=n,K9.instance.memoryStatus.textureSize+=this._size)},n.initAsSwapchainTexture=function(e){var t=new gr;t.format=e.format,t.usage=eo[e.format].hasDepth?Ti.DEPTH_STENCIL_ATTACHMENT:Ti.COLOR_ATTACHMENT,t.width=e.width,t.height=e.height,this.initialize(t,!0)},Z(t,[{key:"gpuTexture",get:function(){return this._gpuTexture}}]),t}(Lo),Vee="webglcontextlost";function Wee(e,t){for(var n=["","WEBKIT_","MOZ_"],i=0;i<n.length;++i){var r=e.getExtension(n[i]+t);if(r)return r}return null}function jee(e){var t={EXT_texture_filter_anisotropic:Wee(e,"EXT_texture_filter_anisotropic"),EXT_color_buffer_half_float:Wee(e,"EXT_color_buffer_half_float"),EXT_color_buffer_float:Wee(e,"EXT_color_buffer_float"),WEBGL_compressed_texture_etc1:Wee(e,"WEBGL_compressed_texture_etc1"),WEBGL_compressed_texture_etc:Wee(e,"WEBGL_compressed_texture_etc"),WEBGL_compressed_texture_pvrtc:Wee(e,"WEBGL_compressed_texture_pvrtc"),WEBGL_compressed_texture_astc:Wee(e,"WEBGL_compressed_texture_astc"),WEBGL_compressed_texture_s3tc:Wee(e,"WEBGL_compressed_texture_s3tc"),WEBGL_compressed_texture_s3tc_srgb:Wee(e,"WEBGL_compressed_texture_s3tc_srgb"),WEBGL_debug_shaders:Wee(e,"WEBGL_debug_shaders"),WEBGL_lose_context:Wee(e,"WEBGL_lose_context"),WEBGL_debug_renderer_info:Wee(e,"WEBGL_debug_renderer_info"),OES_texture_half_float_linear:Wee(e,"OES_texture_half_float_linear"),OES_texture_float_linear:Wee(e,"OES_texture_float_linear"),WEBGL_multi_draw:null,useVAO:!0};return vu.os!==cu.ANDROID&&vu.os!==cu.IOS&&(t.WEBGL_multi_draw=Wee(e,"WEBGL_multi_draw")),t}var qee=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).stateCache=new Gee,t.nullTex2D=null,t.nullTexCube=null,t._canvas=null,t._webGL2ContextLostHandler=null,t._extensions=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){this._canvas=e.windowHandle,this._webGL2ContextLostHandler=this._onWebGLContextLost.bind(this),this._canvas.addEventListener(Vee,this._onWebGLContextLost);var t=K9.instance.gl;this.stateCache.initialize(K9.instance.capabilities.maxTextureUnits,K9.instance.capabilities.maxUniformBufferBindings,K9.instance.capabilities.maxVertexAttributes),this._extensions=jee(t),function(e){e.activeTexture(e.TEXTURE0),e.pixelStorei(e.PACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_ALIGNMENT,1),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.bindFramebuffer(e.FRAMEBUFFER,null),e.enable(e.SCISSOR_TEST),e.enable(e.CULL_FACE),e.cullFace(e.BACK),e.frontFace(e.CCW),e.polygonOffset(0,0),e.enable(e.DEPTH_TEST),e.depthMask(!0),e.depthFunc(e.LESS),e.stencilFuncSeparate(e.FRONT,e.ALWAYS,1,65535),e.stencilOpSeparate(e.FRONT,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.FRONT,65535),e.stencilFuncSeparate(e.BACK,e.ALWAYS,1,65535),e.stencilOpSeparate(e.BACK,e.KEEP,e.KEEP,e.KEEP),e.stencilMaskSeparate(e.BACK,65535),e.disable(e.STENCIL_TEST),e.disable(e.SAMPLE_ALPHA_TO_COVERAGE),e.disable(e.BLEND),e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ZERO,e.ONE,e.ZERO),e.colorMask(!0,!0,!0,!0),e.blendColor(0,0,0,0)}(t);var n=pi.RGBA8,i=pi.DEPTH_STENCIL,r=t.getParameter(t.DEPTH_BITS),o=t.getParameter(t.STENCIL_BITS);r&&o?i=pi.DEPTH_STENCIL:r&&(i=pi.DEPTH),this._colorTexture=new Hee,this._colorTexture.initAsSwapchainTexture({swapchain:this,format:n,width:e.width,height:e.height}),this._depthStencilTexture=new Hee,this._depthStencilTexture.initAsSwapchainTexture({swapchain:this,format:i,width:e.width,height:e.height}),this.nullTex2D=K9.instance.createTexture(new gr(Si.TEX2D,Ti.SAMPLED,pi.RGBA8,2,2,bi.NONE)),this.nullTexCube=K9.instance.createTexture(new gr(Si.CUBE,Ti.SAMPLED,pi.RGBA8,2,2,bi.NONE,6));var a=new sr;a.texExtent.width=2,a.texExtent.height=2;var s=new Uint8Array(this.nullTex2D.size);s.fill(0),K9.instance.copyBuffersToTexture([s],this.nullTex2D,[a]),a.texSubres.layerCount=6,K9.instance.copyBuffersToTexture([s,s,s,s,s,s],this.nullTexCube,[a])},n.destroy=function(){this._canvas&&this._webGL2ContextLostHandler&&(this._canvas.removeEventListener(Vee,this._webGL2ContextLostHandler),this._webGL2ContextLostHandler=null),this.nullTex2D&&(this.nullTex2D.destroy(),this.nullTex2D=null),this.nullTexCube&&(this.nullTexCube.destroy(),this.nullTexCube=null),this._extensions=null,this._canvas=null},n.resize=function(e,t){this._colorTexture.width===e&&this._colorTexture.height===t||(E("Resizing swapchain: "+e+"x"+t),this._canvas.width=e,this._canvas.height=t,this._colorTexture.resize(e,t),this._depthStencilTexture.resize(e,t))},n._onWebGLContextLost=function(e){D(11e3),S(e)},Z(t,[{key:"extensions",get:function(){return this._extensions}}]),t}(mo),Xee=e("WebGL2Device",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._swapchain=null,t._context=null,t}$(t,e);var n=t.prototype;return n.initialize=function(e){K9.setInstance(this),this._gfxAPI=hi.WEBGL2,this._bindingMappingInfo=e.bindingMappingInfo,this._bindingMappingInfo.bufferOffsets.length||this._bindingMappingInfo.bufferOffsets.push(0),this._bindingMappingInfo.samplerOffsets.length||this._bindingMappingInfo.samplerOffsets.push(0);var t=this._context=function(e){var t=null;try{var n={alpha:ft.ENABLE_TRANSPARENT_CANVAS,antialias:ft.ENABLE_WEBGL_ANTIALIAS,depth:!0,stencil:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!1,powerPreference:"default",failIfMajorPerformanceCaveat:!1};t=e.getContext("webgl2",n)}catch(e){return null}return t}(po.canvas);if(!t)return console.error("This device does not support WebGL."),!1;this._queue=this.createQueue(new Xr(qi.GRAPHICS)),this._cmdBuff=this.createCommandBuffer(new qr(this._queue)),this._caps.maxVertexAttributes=t.getParameter(t.MAX_VERTEX_ATTRIBS),this._caps.maxVertexUniformVectors=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this._caps.maxFragmentUniformVectors=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this._caps.maxTextureUnits=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this._caps.maxVertexTextureUnits=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this._caps.maxUniformBufferBindings=t.getParameter(t.MAX_UNIFORM_BUFFER_BINDINGS),this._caps.maxUniformBlockSize=t.getParameter(t.MAX_UNIFORM_BLOCK_SIZE),this._caps.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this._caps.maxCubeMapTextureSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this._caps.uboOffsetAlignment=t.getParameter(t.UNIFORM_BUFFER_OFFSET_ALIGNMENT);var n=t.getSupportedExtensions(),i="";if(n)for(var r,o=se(n);!(r=o()).done;)i+=r.value+" ";var a=jee(t);a.WEBGL_debug_renderer_info?(this._renderer=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_RENDERER_WEBGL),this._vendor=t.getParameter(a.WEBGL_debug_renderer_info.UNMASKED_VENDOR_WEBGL)):(this._renderer=t.getParameter(t.RENDERER),this._vendor=t.getParameter(t.VENDOR));var s=t.getParameter(t.VERSION);this._features.fill(!1),this._features[_i.TEXTURE_FLOAT]=!0,this._features[_i.TEXTURE_HALF_FLOAT]=!0,this._features[_i.FORMAT_R11G11B10F]=!0,this._features[_i.FORMAT_SRGB]=!0,this._features[_i.FORMAT_RGB8]=!0,this._features[_i.ELEMENT_INDEX_UINT]=!0,this._features[_i.INSTANCED_ARRAYS]=!0,this._features[_i.MULTIPLE_RENDER_TARGETS]=!0,this._features[_i.BLEND_MINMAX]=!0,a.EXT_color_buffer_float&&(this._features[_i.COLOR_FLOAT]=!0,this._features[_i.COLOR_HALF_FLOAT]=!0),a.OES_texture_float_linear&&(this._features[_i.TEXTURE_FLOAT_LINEAR]=!0),a.OES_texture_half_float_linear&&(this._features[_i.TEXTURE_HALF_FLOAT_LINEAR]=!0);var c="";return a.WEBGL_compressed_texture_etc1&&(this._features[_i.FORMAT_ETC1]=!0,c+="etc1 "),a.WEBGL_compressed_texture_etc&&(this._features[_i.FORMAT_ETC2]=!0,c+="etc2 "),a.WEBGL_compressed_texture_s3tc&&(this._features[_i.FORMAT_DXT]=!0,c+="dxt "),a.WEBGL_compressed_texture_pvrtc&&(this._features[_i.FORMAT_PVRTC]=!0,c+="pvrtc "),a.WEBGL_compressed_texture_astc&&(this._features[_i.FORMAT_ASTC]=!0,c+="astc "),E("WebGL2 device initialized."),E("RENDERER: "+this._renderer),E("VENDOR: "+this._vendor),E("VERSION: "+s),E("COMPRESSED_FORMAT: "+c),E("EXTENSIONS: "+i),!0},n.destroy=function(){this._queue&&(this._queue.destroy(),this._queue=null),this._cmdBuff&&(this._cmdBuff.destroy(),this._cmdBuff=null);for(var e=this._samplers.values(),t=e.next();!t.done;)t.value.destroy(),t=e.next();this._swapchain=null},n.flushCommands=function(){},n.acquire=function(){},n.present=function(){var e=this._queue;this._numDrawCalls=e.numDrawCalls,this._numInstances=e.numInstances,this._numTris=e.numTris,e.clear()},n.createCommandBuffer=function(e){var t=new(e.type===Yi.PRIMARY?Bee:Ree);return t.initialize(e),t},n.createSwapchain=function(e){var t=new qee;return this._swapchain=t,t.initialize(e),t},n.createBuffer=function(e){var t=new Aee;return t.initialize(e),t},n.createTexture=function(e){var t=new Hee;return t.initialize(e),t},n.createDescriptorSet=function(e){var t=new Y9;return t.initialize(e),t},n.createShader=function(e){var t=new kee;return t.initialize(e),t},n.createInputAssembler=function(e){var t=new Dee;return t.initialize(e),t},n.createRenderPass=function(e){var t=new zee;return t.initialize(e),t},n.createFramebuffer=function(e){var t=new Iee;return t.initialize(e),t},n.createDescriptorSetLayout=function(e){var t=new Oee;return t.initialize(e),t},n.createPipelineLayout=function(e){var t=new Mee;return t.initialize(e),t},n.createPipelineState=function(e){var t=new Lee;return t.initialize(e),t},n.createQueue=function(e){var t=new Fee;return t.initialize(e),t},n.getSampler=function(e){var t=Mo.computeHash(e);return this._samplers.has(t)||this._samplers.set(t,new Uee(e,t)),this._samplers.get(t)},n.getGlobalBarrier=function(e){var t=Bo.computeHash(e);return this._globalBarriers.has(t)||this._globalBarriers.set(t,new Bo(e,t)),this._globalBarriers.get(t)},n.getTextureBarrier=function(e){var t=Fo.computeHash(e);return this._textureBarriers.has(t)||this._textureBarriers.set(t,new Fo(e,t)),this._textureBarriers.get(t)},n.copyBuffersToTexture=function(e,t,n){Eee(this,e,t.gpuTexture,n)},n.copyTextureToBuffers=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache,a=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,a);var s=0,c=0,l=1,u=1;switch(t.glTarget){case r.TEXTURE_2D:for(var h=0;h<i.length;h++){var f=i[h];r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,t.glTarget,t.glTexture,f.texSubres.mipLevel),s=f.texOffset.x,c=f.texOffset.y,l=f.texExtent.width,u=f.texExtent.height,r.readPixels(s,c,l,u,t.glFormat,t.glType,n[h])}break;default:console.error("Unsupported GL texture type, copy texture to buffers failed.")}r.bindFramebuffer(r.FRAMEBUFFER,null),o.glFramebuffer=null,r.deleteFramebuffer(a)}(this,e.gpuTexture,t,n)},n.copyTexImagesToTexture=function(e,t,n){!function(e,t,n,i){var r=e.gl,o=e.stateCache.glTexUnits[e.stateCache.texUnit];o.glTexture!==n.glTexture&&(r.bindTexture(n.glTarget,n.glTexture),o.glTexture=n.glTexture);var a=0,s=0;switch(n.glTarget){case r.TEXTURE_2D:for(var c=0;c<i.length;c++){var l=i[c];r.texSubImage2D(r.TEXTURE_2D,l.texSubres.mipLevel,l.texOffset.x,l.texOffset.y,n.glFormat,n.glType,t[a++])}break;case r.TEXTURE_CUBE_MAP:for(var u=0;u<i.length;u++){var h=i[u],f=h.texSubres.baseArrayLayer+h.texSubres.layerCount;for(s=h.texSubres.baseArrayLayer;s<f;++s)r.texSubImage2D(r.TEXTURE_CUBE_MAP_POSITIVE_X+s,h.texSubres.mipLevel,h.texOffset.x,h.texOffset.y,n.glFormat,n.glType,t[a++])}break;default:console.error("Unsupported GL texture type, copy buffer to texture failed.")}n.flags&bi.GEN_MIPMAP&&r.generateMipmap(n.glTarget)}(this,e,t.gpuTexture,n)},Z(t,[{key:"gl",get:function(){return this._context}},{key:"extensions",get:function(){return this._swapchain.extensions}},{key:"stateCache",get:function(){return this._swapchain.stateCache}},{key:"nullTex2D",get:function(){return this._swapchain.nullTex2D}},{key:"nullTexCube",get:function(){return this._swapchain.nullTexCube}}]),t}(po));function Yee(e,t,n,i){var r=(i.x-n.x)*(e.y-n.y)-(i.y-n.y)*(e.x-n.x),o=(t.x-e.x)*(e.y-n.y)-(t.y-e.y)*(e.x-n.x),a=(i.y-n.y)*(t.x-e.x)-(i.x-n.x)*(t.y-e.y);if(0!==a){var s=r/a,c=o/a;if(s>=0&&s<=1&&c>=0&&c<=1)return!0}return!1}u.WebGL2Device=Xee;var Kee=new Kn,Qee=new Kn,Zee=new Kn,Jee=new Kn;function $ee(e,t,n){for(var i=n.length,r=0;r<i;++r)if(Yee(e,t,n[r],n[(r+1)%i]))return!0;return!1}function ete(e,t){for(var n=!1,i=e.x,r=e.y,o=t.length,a=0,s=o-1;a<o;s=a++){var c=t[a].x,l=t[a].y,u=t[s].x,h=t[s].y;l>r!=h>r&&i<(u-c)*(r-l)/(h-l)+c&&(n=!n)}return n}function tte(e,t,n,i){var r,o=n.x-t.x,a=n.y-t.y,s=o*o+a*a,c=((e.x-t.x)*o+(e.y-t.y)*a)/s;return r=i?s?c<0?t:c>1?n:Kee.set(t.x+c*o,t.y+c*a):t:Kee.set(t.x+c*o,t.y+c*a),o=e.x-r.x,a=e.y-r.y,Math.sqrt(o*o+a*a)}var nte,ite,rte,ote,ate,ste,cte,lte,ute,hte,fte,_te,pte,dte,mte,vte,gte=e("Intersection2D",(function(){}));gte.lineLine=Yee,gte.lineRect=function(e,t,n){var i=Kee.set(n.x,n.y),r=Qee.set(n.x,n.yMax),o=Zee.set(n.xMax,n.yMax),a=Jee.set(n.xMax,n.y);return!!(Yee(e,t,i,r)||Yee(e,t,r,o)||Yee(e,t,o,a)||Yee(e,t,a,i))},gte.linePolygon=$ee,gte.rectRect=function(e,t){var n=e.x,i=e.y,r=e.x+e.width,o=e.y+e.height,a=t.x,s=t.y,c=t.x+t.width,l=t.y+t.height;return n<=c&&r>=a&&i<=l&&o>=s},gte.rectPolygon=function(e,t){var n=Kee.set(e.x,e.y),i=Qee.set(e.x,e.yMax),r=Zee.set(e.xMax,e.yMax),o=Jee.set(e.xMax,e.y);if($ee(n,i,t))return!0;if($ee(i,r,t))return!0;if($ee(r,o,t))return!0;if($ee(o,n,t))return!0;for(var a=0,s=t.length;a<s;++a)if(e.contains(t[a]))return!0;return!!(ete(n,t)||ete(i,t)||ete(r,t)||ete(o,t))},gte.rectCircle=function(e,t,n){var i=t.x,r=t.y,o=e.x,a=e.y,s=e.width,c=e.height,l=i,u=r;i<o?l=o:i>o+s&&(l=o+s),r<a?u=a:r>a+c&&(u=a+c);var h=i-l,f=r-u;return Math.sqrt(h*h+f*f)<=n},gte.polygonPolygon=function(e,t){var n,i;for(n=0,i=e.length;n<i;++n)if($ee(e[n],e[(n+1)%i],t))return!0;for(n=0,i=t.length;n<i;++n)if(ete(t[n],e))return!0;for(n=0,i=e.length;n<i;++n)if(ete(e[n],t))return!0;return!1},gte.circleCircle=function(e,t,n,i){return Kn.distance(e,n)<t+i},gte.polygonCircle=function(e,t,n){var i=t;if(ete(i,e))return!0;for(var r=0,o=e.length;r<o;r++)if(tte(i,0===r?e[e.length-1]:e[r-1],e[r],!0)<n)return!0;return!1},gte.pointInPolygon=ete,gte.pointLineDistance=tte;var yte,xte,Ste,Tte,bte,Ete,Cte,Ate,wte,Pte,Rte,Ite,Dte,Ote,Mte,Nte,Lte,Bte,Fte,zte,Ute,kte,Gte,Hte,Vte,Wte,jte,qte,Xte,Yte,Kte,Qte,Zte=function(t){return e({Billboard:t,BillboardComponent:t}),t}((nte=mc("cc.Billboard"),ite=Oc(),rte=Pc(),ote=Zc(Cv),ate=Zc(Cv),ste=Fc(),cte=Fc(),lte=Fc(),ute=Fc(),nte(hte=ite(hte=rte(hte=wc((vte=function(e){function t(){var t;return ce(t=e.call(this)||this,"_texture",_te,oe(t)),ce(t,"_height",pte,oe(t)),ce(t,"_width",dte,oe(t)),ce(t,"_rotation",mte,oe(t)),t._model=null,t._mesh=null,t._material=null,t._uniform=new $n(1,1,0,0),t}$(t,e);var n=t.prototype;return n.onLoad=function(){this.createModel()},n.onEnable=function(){this.attachToScene(),this._model.enabled=!0,this.width=this._width,this.height=this._height,this.rotation=this.rotation,this.texture=this.texture},n.onDisable=function(){this.detachFromScene()},n.attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this.detachFromScene(),this._getRenderScene().addModel(this._model))},n.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},n.createModel=function(){this._mesh=R4({primitiveMode:Ui.TRIANGLE_LIST,positions:[0,0,0,0,0,0,0,0,0,0,0,0],uvs:[0,0,1,0,0,1,1,1],colors:[Pn.WHITE.r,Pn.WHITE.g,Pn.WHITE.b,Pn.WHITE.a,Pn.WHITE.r,Pn.WHITE.g,Pn.WHITE.b,Pn.WHITE.a,Pn.WHITE.r,Pn.WHITE.g,Pn.WHITE.b,Pn.WHITE.a,Pn.WHITE.r,Pn.WHITE.g,Pn.WHITE.b,Pn.WHITE.a],attributes:[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RG32F),new Ir(Zi.ATTR_COLOR,pi.RGBA8UI,!0)],indices:[0,1,2,1,2,3]},void 0,{calculateBounds:!1});var e=this._model=u.director.root.createModel(uT,this.node);e.node=e.transform=this.node,null==this._material&&(this._material=new ug,this._material.copy(Nv.get("default-billboard-material"))),e.initSubModel(0,this._mesh.renderingSubMeshes[0],this._material)},Z(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._material&&this._material.setProperty("mainTexture",e)}},{key:"height",get:function(){return this._height},set:function(e){this._height=e,this._material&&(this._uniform.y=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._material&&(this._uniform.x=e,this._material.setProperty("cc_size_rotation",this._uniform))}},{key:"rotation",get:function(){return Math.round(100*_n(this._rotation))/100},set:function(e){this._rotation=fn(e),this._material&&(this._uniform.z=this._rotation,this._material.setProperty("cc_size_rotation",this._uniform))}}]),t}(th),_te=le((fte=vte).prototype,"_texture",[ote],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(fte.prototype,"texture",[ate,ste],Object.getOwnPropertyDescriptor(fte.prototype,"texture"),fte.prototype),pte=le(fte.prototype,"_height",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(fte.prototype,"height",[cte],Object.getOwnPropertyDescriptor(fte.prototype,"height"),fte.prototype),dte=le(fte.prototype,"_width",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(fte.prototype,"width",[lte],Object.getOwnPropertyDescriptor(fte.prototype,"width"),fte.prototype),mte=le(fte.prototype,"_rotation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(fte.prototype,"rotation",[ute],Object.getOwnPropertyDescriptor(fte.prototype,"rotation"),fte.prototype),hte=fte))||hte)||hte)||hte)||hte)),Jte=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RGBA32F),new Ir(Zi.ATTR_TEX_COORD1,pi.RGB32F),new Ir(Zi.ATTR_COLOR,pi.RGBA8,!0)],$te=new In,ene=new In,tne=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=null,t._vertCount=0,t._indexCount=0,t._material=null,t.type=nT.LINE,t._capacity=100,t._iaInfo=new vr([new dr]),t._iaInfoBuffer=t._device.createBuffer(new _r(vi.INDIRECT,xi.DEVICE,ro,ro)),t}$(t,e);var n=t.prototype;return n.setCapacity=function(e){this._capacity=e,this.createBuffer()},n.createBuffer=function(){this._vertSize=0;for(var e,t=se(Jte);!(e=t()).done;){var n=e.value;n.offset=this._vertSize,this._vertSize+=eo[n.format].size}this._vertAttrsFloatCount=this._vertSize/4,this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.updateMaterial=function(t){this._material=t,e.prototype.setSubModelMaterial.call(this,0,t)},n.createSubMeshData=function(){this._subMeshData&&this.destroySubMeshData(),this._vertCount=2,this._indexCount=6;var e=this._device.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);e.update(t);for(var n=new Uint16Array((this._capacity-1)*this._indexCount),i=0,r=0;r<this._capacity-1;++r){var o=2*r;n[i++]=o,n[i++]=o+1,n[i++]=o+2,n[i++]=o+3,n[i++]=o+2,n[i++]=o+1}var a=this._device.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,(this._capacity-1)*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return a.update(n),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=(this._capacity-1)*this._indexCount,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new VA([e],Jte,Ui.TRIANGLE_LIST,a,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.addLineVertexData=function(e,t,n){if(e.length>1){var i=0;In.subtract($te,e[1],e[0]),this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=0,this._vdataF32[i++]=$te.x,this._vdataF32[i++]=$te.y,this._vdataF32[i++]=$te.z,this._vdataUint32[i++]=n.evaluate(0,1)._val,this._vdataF32[i++]=e[0].x,this._vdataF32[i++]=e[0].y,this._vdataF32[i++]=e[0].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(0,1),this._vdataF32[i++]=0,this._vdataF32[i++]=1,this._vdataF32[i++]=$te.x,this._vdataF32[i++]=$te.y,this._vdataF32[i++]=$te.z,this._vdataUint32[i++]=n.evaluate(0,1)._val;for(var r=1;r<e.length-1;r++){In.subtract($te,e[r-1],e[r]),In.subtract(ene,e[r+1],e[r]),In.subtract(ene,ene,$te);var o=r/e.length;this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=0,this._vdataF32[i++]=ene.x,this._vdataF32[i++]=ene.y,this._vdataF32[i++]=ene.z,this._vdataUint32[i++]=n.evaluate(o,1)._val,this._vdataF32[i++]=e[r].x,this._vdataF32[i++]=e[r].y,this._vdataF32[i++]=e[r].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(o,1),this._vdataF32[i++]=o,this._vdataF32[i++]=1,this._vdataF32[i++]=ene.x,this._vdataF32[i++]=ene.y,this._vdataF32[i++]=ene.z,this._vdataUint32[i++]=n.evaluate(o,1)._val}In.subtract($te,e[e.length-1],e[e.length-2]),this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=0,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=0,this._vdataF32[i++]=$te.x,this._vdataF32[i++]=$te.y,this._vdataF32[i++]=$te.z,this._vdataUint32[i++]=n.evaluate(1,1)._val,this._vdataF32[i++]=e[e.length-1].x,this._vdataF32[i++]=e[e.length-1].y,this._vdataF32[i++]=e[e.length-1].z,this._vdataF32[i++]=1,this._vdataF32[i++]=t.evaluate(1,1),this._vdataF32[i++]=1,this._vdataF32[i++]=1,this._vdataF32[i++]=$te.x,this._vdataF32[i++]=$te.y,this._vdataF32[i++]=$te.z,this._vdataUint32[i++]=n.evaluate(1,1)._val}this.updateIA(Math.max(0,e.length-1))},n.updateIA=function(e){this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},t}(uT),nne=[["mode","constant","multiplier"],["mode","spline","multiplier"],["mode","splineMin","splineMax","multiplier"],["mode","constantMin","constantMax","multiplier"]],ine=st({Constant:0,Curve:1,TwoCurves:2,TwoConstants:3}),rne=e("CurveRange",(yte=mc("cc.CurveRange"),xte=Zc(ine),Ste=Zc(v_),Tte=Zc(v_),bte=Zc(v_),yte((Lte=Nte=function(){function e(){ce(this,"mode",Ate,this),ce(this,"spline",wte,this),ce(this,"splineMin",Pte,this),ce(this,"splineMax",Rte,this),ce(this,"constant",Ite,this),ce(this,"constantMin",Dte,this),ce(this,"constantMax",Ote,this),ce(this,"multiplier",Mte,this),this._curve=new Sp(this.spline),this._curveMin=new Sp(this.splineMin),this._curveMax=new Sp(this.splineMax)}var t=e.prototype;return t.evaluate=function(e,t){switch(this.mode){default:case ine.Constant:return this.constant;case ine.Curve:return this.spline.evaluate(e)*this.multiplier;case ine.TwoCurves:return hn(this.splineMin.evaluate(e),this.splineMax.evaluate(e),t)*this.multiplier;case ine.TwoConstants:return hn(this.constantMin,this.constantMax,t)}},t.getMax=function(){switch(this.mode){default:case ine.Constant:return this.constant;case ine.Curve:return this.multiplier;case ine.TwoConstants:return this.constantMax;case ine.TwoCurves:return this.multiplier}},t._onBeforeSerialize=function(){return nne[this.mode]},Z(e,[{key:"curve",get:function(){return this._curve},set:function(e){this._curve=e,this.spline=e._internalCurve}},{key:"curveMin",get:function(){return this._curveMin},set:function(e){this._curveMin=e,this.splineMin=e._internalCurve}},{key:"curveMax",get:function(){return this._curveMax},set:function(e){this._curveMax=e,this.splineMax=e._internalCurve}}]),e}(),Nte.Mode=ine,Ate=le((Cte=Lte).prototype,"mode",[xte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ine.Constant}}),wte=le(Cte.prototype,"spline",[Ste],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ep()}}),Pte=le(Cte.prototype,"splineMin",[Tte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ep()}}),Rte=le(Cte.prototype,"splineMax",[bte],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Ep()}}),Ite=le(Cte.prototype,"constant",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dte=le(Cte.prototype,"constantMin",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ote=le(Cte.prototype,"constantMax",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Mte=le(Cte.prototype,"multiplier",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ete=Cte))||Ete));function one(e,t,n){switch(e.mode){case ine.Constant:return e.constant;case ine.Curve:return e.spline.evaluate(t)*e.multiplier;case ine.TwoCurves:return 0===n?e.splineMin.evaluate(t)*e.multiplier:e.splineMax.evaluate(t)*e.multiplier;case ine.TwoConstants:return 0===n?e.constantMin:e.constantMax;default:return 0}}function ane(e){switch(e.mode){case ine.TwoConstants:case ine.TwoCurves:return 2;default:return 1}}function sne(e,t,n){var i=new nv({width:t,height:n,_data:e,_compressed:!1,format:Mm.RGBA32F}),r=new Cv;return r.setFilters(Lm.NEAREST,Lm.NEAREST),r.setMipFilter(Lm.NONE),r.setWrapMode(Nm.CLAMP_TO_EDGE,Nm.CLAMP_TO_EDGE,Nm.CLAMP_TO_EDGE),r.image=i,r}function cne(e,t,n,i,r){for(var o=Math.max(ane(t),ane(n),ane(i)),a=new Float32Array(e*o*4),s=[t,n,i],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<3;u++)for(var h=s[u],f=0,_=0,p=0;p<e;p++){var d=one(h,c*p,l);_=r?d:(f+=d)/(p+1),a[4*p+u]=_}return sne(a,e,o)}var lne,une,hne,fne,_ne,pne,dne,mne,vne,gne,yne,xne,Sne,Tne,bne,Ene,Cne,Ane,wne,Pne,Rne,Ine,Dne,One,Mne,Nne,Lne,Bne,Fne,zne,Une,kne,Gne,Hne,Vne,Wne,jne,qne,Xne,Yne,Kne,Qne,Zne,Jne,$ne,eie,tie,nie,iie,rie,oie,aie,sie,cie,lie,uie=st({Blend:0,Fixed:1}),hie=(e("ColorKey",mc("cc.ColorKey")((zte=le((Fte=function(){ce(this,"color",zte,this),ce(this,"time",Ute,this)}).prototype,"color",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),Ute=le(Fte.prototype,"time",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bte=Fte))||Bte),e("AlphaKey",mc("cc.AlphaKey")((Hte=le((Gte=function(){ce(this,"alpha",Hte,this),ce(this,"time",Vte,this)}).prototype,"alpha",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Vte=le(Gte.prototype,"time",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),kte=Gte))||kte),e("Gradient",mc("cc.Gradient")((Qte=Kte=function(){function e(){ce(this,"colorKeys",qte,this),ce(this,"alphaKeys",Xte,this),ce(this,"mode",Yte,this),this._color=void 0,this._color=Pn.WHITE.clone()}var t=e.prototype;return t.setKeys=function(e,t){this.colorKeys=e,this.alphaKeys=t},t.sortKeys=function(){this.colorKeys.length>1&&this.colorKeys.sort((function(e,t){return e.time-t.time})),this.alphaKeys.length>1&&this.alphaKeys.sort((function(e,t){return e.time-t.time}))},t.evaluate=function(e){return this.getRGB(e),this._color._set_a_unsafe(this.getAlpha(e)),this._color},t.randomColor=function(){var e=this.colorKeys[Math.trunc(Math.random()*this.colorKeys.length)],t=this.alphaKeys[Math.trunc(Math.random()*this.alphaKeys.length)];return this._color.set(e.color),this._color._set_a_unsafe(t.alpha),this._color},t.getRGB=function(e){if(!(this.colorKeys.length>1))return 1===this.colorKeys.length?(this._color.set(this.colorKeys[0].color),this._color):(this._color.set(Pn.WHITE),this._color);e=Sn(e,1);for(var t=1;t<this.colorKeys.length;++t){var n=this.colorKeys[t-1].time,i=this.colorKeys[t].time;if(e>=n&&e<i){if(this.mode===uie.Fixed)return this.colorKeys[t].color;var r=(e-n)/(i-n);return Pn.lerp(this._color,this.colorKeys[t-1].color,this.colorKeys[t].color,r),this._color}}var o=this.colorKeys.length-1;e<this.colorKeys[0].time?Pn.lerp(this._color,Pn.BLACK,this.colorKeys[0].color,e/this.colorKeys[0].time):e>this.colorKeys[o].time&&Pn.lerp(this._color,this.colorKeys[o].color,Pn.BLACK,(e-this.colorKeys[o].time)/(1-this.colorKeys[o].time))},t.getAlpha=function(e){if(!(this.alphaKeys.length>1))return 1===this.alphaKeys.length?this.alphaKeys[0].alpha:255;e=Sn(e,1);for(var t=1;t<this.alphaKeys.length;++t){var n=this.alphaKeys[t-1].time,i=this.alphaKeys[t].time;if(e>=n&&e<i){if(this.mode===uie.Fixed)return this.alphaKeys[t].alpha;var r=(e-n)/(i-n);return hn(this.alphaKeys[t-1].alpha,this.alphaKeys[t].alpha,r)}}var o=this.alphaKeys.length-1;return e<this.alphaKeys[0].time?hn(0,this.alphaKeys[0].alpha,e/this.alphaKeys[0].time):e>this.alphaKeys[o].time?hn(this.alphaKeys[o].alpha,0,(e-this.alphaKeys[o].time)/(1-this.alphaKeys[o].time)):void 0},e}(),Kte.Mode=uie,qte=le((jte=Qte).prototype,"colorKeys",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Xte=le(jte.prototype,"alphaKeys",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Array}}),Yte=le(jte.prototype,"mode",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uie.Blend}}),Wte=jte))||Wte)),fie=st({Color:0,Gradient:1,TwoColors:2,TwoGradients:3,RandomColor:4}),_ie=e("GradientRange",(lne=mc("cc.GradientRange"),une=Zc(fie),hne=Zc(hie),fne=Zc(hie),_ne=Zc(hie),pne=Zc(fie),lne((Cne=Ene=function(){function e(){ce(this,"color",vne,this),ce(this,"colorMin",gne,this),ce(this,"colorMax",yne,this),ce(this,"gradient",xne,this),ce(this,"gradientMin",Sne,this),ce(this,"gradientMax",Tne,this),ce(this,"_mode",bne,this),this._color=Pn.WHITE.clone()}var t=e.prototype;return t.evaluate=function(e,t){switch(this._mode){case fie.Color:return this.color;case fie.TwoColors:return Pn.lerp(this._color,this.colorMin,this.colorMax,t),this._color;case fie.RandomColor:return this.gradient.randomColor();case fie.Gradient:return this.gradient.evaluate(e);case fie.TwoGradients:return Pn.lerp(this._color,this.gradientMin.evaluate(e),this.gradientMax.evaluate(e),t),this._color;default:return this.color}},t._onBeforeSerialize=function(){return(!1)[this._mode]},Z(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e}}]),e}(),Ene.Mode=fie,le((mne=Cne).prototype,"mode",[une],Object.getOwnPropertyDescriptor(mne.prototype,"mode"),mne.prototype),vne=le(mne.prototype,"color",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),gne=le(mne.prototype,"colorMin",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),yne=le(mne.prototype,"colorMax",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),xne=le(mne.prototype,"gradient",[hne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hie}}),Sne=le(mne.prototype,"gradientMin",[fne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hie}}),Tne=le(mne.prototype,"gradientMax",[_ne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new hie}}),bne=le(mne.prototype,"_mode",[pne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fie.Color}}),dne=mne))||dne));function pie(e,t,n){switch(e.mode){case fie.Color:return e.color;case fie.TwoColors:return 0===n?e.colorMin:e.colorMax;case fie.RandomColor:return e.gradient.randomColor();case fie.Gradient:return e.gradient.evaluate(t);case fie.TwoGradients:return 0===n?e.gradientMin.evaluate(t):e.gradientMax.evaluate(t);default:return e.color}}var die={parent:null,owner:null,subModelIdx:0},mie={CC_USE_WORLD_SPACE:!1},vie=function(t){return e({Line:t,LineComponent:t}),t}((Ane=mc("cc.Line"),wne=Oc(),Pne=Pc(),Rne=Zc(Cv),Ine=Zc(Cv),Dne=Vc(),One=Fc(),Mne=Vc(),Nne=Fc(),Lne=Zc([In]),Bne=Zc([In]),Fne=Vc(),zne=Fc(),Une=Zc(rne),kne=Zc(rne),Gne=zc(),Hne=Vc(),Vne=Fc(),Wne=Zc(Kn),jne=Vc(),qne=Fc(),Xne=Zc(Kn),Yne=Vc(),Kne=Fc(),Qne=Zc(_ie),Zne=Zc(_ie),Jne=Vc(),$ne=Fc(),Ane(eie=wne(eie=Pne(eie=wc((lie=function(e){function t(){var t;return ce(t=e.call(this)||this,"_texture",nie,oe(t)),t._material=null,t._materialInstance=null,ce(t,"_worldSpace",iie,oe(t)),ce(t,"_positions",rie,oe(t)),ce(t,"_width",oie,oe(t)),ce(t,"_tile",aie,oe(t)),ce(t,"_offset",sie,oe(t)),ce(t,"_color",cie,oe(t)),t._model=null,t._tile_offset=new $n,t}$(t,e);var n=t.prototype;return n.onLoad=function(){var e=this._model=u.director.root.createModel(tne);e.node=e.transform=this.node,null===this._material&&(this._material=new ug,this._material.copy(Nv.get("default-trail-material")),mie.CC_USE_WORLD_SPACE=this.worldSpace,die.parent=this._material,die.subModelIdx=0,this._materialInstance=new gT(die),die.parent=null,die.subModelIdx=0,this._materialInstance.recompileShaders(mie)),e.updateMaterial(this._materialInstance),e.setCapacity(100)},n.onEnable=function(){this._model&&(this._attachToScene(),this.texture=this._texture,this.tile=this._tile,this.offset=this._offset,this._model.addLineVertexData(this._positions,this._width,this._color))},n.onDisable=function(){this._model&&this._detachFromScene()},n._attachToScene=function(){this._model&&this.node&&this.node.scene&&(this._model.scene&&this._detachFromScene(),this._getRenderScene().addModel(this._model))},n._detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},Z(t,[{key:"texture",get:function(){return this._texture},set:function(e){this._texture=e,this._materialInstance&&this._materialInstance.setProperty("mainTexture",e)}},{key:"worldSpace",get:function(){return this._worldSpace},set:function(e){this._worldSpace=e,this._materialInstance&&(mie.CC_USE_WORLD_SPACE=this.worldSpace,this._materialInstance.recompileShaders(mie),this._model&&this._model.setSubModelMaterial(0,this._materialInstance))}},{key:"positions",get:function(){return this._positions},set:function(e){this._positions=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"width",get:function(){return this._width},set:function(e){this._width=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}},{key:"tile",get:function(){return this._tile},set:function(e){this._tile.set(e),this._materialInstance&&(this._tile_offset.x=this._tile.x,this._tile_offset.y=this._tile.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"offset",get:function(){return this._offset},set:function(e){this._offset.set(e),this._materialInstance&&(this._tile_offset.z=this._offset.x,this._tile_offset.w=this._offset.y,this._materialInstance.setProperty("mainTiling_Offset",this._tile_offset))}},{key:"color",get:function(){return this._color},set:function(e){this._color=e,this._model&&this._model.addLineVertexData(this._positions,this._width,this._color)}}]),t}(th),nie=le((tie=lie).prototype,"_texture",[Rne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(tie.prototype,"texture",[Ine,Dne,One],Object.getOwnPropertyDescriptor(tie.prototype,"texture"),tie.prototype),iie=le(tie.prototype,"_worldSpace",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(tie.prototype,"worldSpace",[Mne,Nne],Object.getOwnPropertyDescriptor(tie.prototype,"worldSpace"),tie.prototype),rie=le(tie.prototype,"_positions",[Lne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),le(tie.prototype,"positions",[Bne,Fne,zne],Object.getOwnPropertyDescriptor(tie.prototype,"positions"),tie.prototype),oie=le(tie.prototype,"_width",[Une],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),le(tie.prototype,"width",[kne,Gne,Hne,Vne],Object.getOwnPropertyDescriptor(tie.prototype,"width"),tie.prototype),aie=le(tie.prototype,"_tile",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(1,1)}}),le(tie.prototype,"tile",[Wne,jne,qne],Object.getOwnPropertyDescriptor(tie.prototype,"tile"),tie.prototype),sie=le(tie.prototype,"_offset",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Kn(0,0)}}),le(tie.prototype,"offset",[Xne,Yne,Kne],Object.getOwnPropertyDescriptor(tie.prototype,"offset"),tie.prototype),cie=le(tie.prototype,"_color",[Qne],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _ie}}),le(tie.prototype,"color",[Zne,Jne,$ne],Object.getOwnPropertyDescriptor(tie.prototype,"color"),tie.prototype),eie=tie))||eie)||eie)||eie)||eie)),gie=function(){function e(e){this.particleSystem=void 0,this.position=void 0,this.velocity=void 0,this.animatedVelocity=void 0,this.ultimateVelocity=void 0,this.angularVelocity=void 0,this.axisOfRotation=void 0,this.rotation=void 0,this.startEuler=void 0,this.startRotation=void 0,this.startRotated=void 0,this.deltaQuat=void 0,this.deltaMat=void 0,this.localMat=void 0,this.startSize=void 0,this.size=void 0,this.startColor=void 0,this.color=void 0,this.randomSeed=void 0,this.remainingLifetime=void 0,this.loopCount=void 0,this.lastLoop=void 0,this.trailDelay=void 0,this.startLifetime=void 0,this.emitAccumulator0=void 0,this.emitAccumulator1=void 0,this.frameIndex=void 0,this.startRow=void 0,this.particleSystem=e,this.position=new In(0,0,0),this.velocity=new In(0,0,0),this.animatedVelocity=new In(0,0,0),this.ultimateVelocity=new In(0,0,0),this.angularVelocity=new In(0,0,0),this.axisOfRotation=new In(0,0,0),this.rotation=new In(0,0,0),this.startEuler=new In(0,0,0),this.startRotation=new Fn,this.startRotated=!1,this.deltaQuat=new Fn,this.deltaMat=new jn,this.localMat=new jn,this.startSize=new In(0,0,0),this.size=new In(0,0,0),this.startColor=Pn.WHITE.clone(),this.color=Pn.WHITE.clone(),this.randomSeed=0,this.remainingLifetime=0,this.loopCount=0,this.lastLoop=0,this.trailDelay=0,this.startLifetime=0,this.emitAccumulator0=0,this.emitAccumulator1=0,this.frameIndex=0,this.startRow=0}return e.prototype.reset=function(){this.rotation.set(0,0,0),this.startEuler.set(0,0,0),this.startRotation.set(0,0,0,1),this.startRotated=!1,this.deltaQuat.set(0,0,0,1),this.deltaMat.identity(),this.localMat.identity()},e}();gie.INDENTIFY_NEG_QUAT=10,gie.R2D=180/Math.PI;var yie,xie,Sie,Tie,bie,Eie,Cie,Aie,wie,Pie,Rie,Iie,Die,Oie,Mie,Nie,Lie,Bie,Fie,zie,Uie,kie,Gie,Hie,Vie,Wie,jie,qie,Xie,Yie,Kie,Qie,Zie,Jie,$ie="colorModule",ere="rotationModule",tre="sizeModule",nre="textureModule",ire=["sizeModule","colorModule","forceModule","velocityModule","limitModule","rotationModule","textureModule"],rre=["_colorOverLifetimeModule","_shapeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule","_trailModule"],ore=function(){function e(){this.target=null,this.needUpdate=!1,this.needAnimate=!0,this.name=void 0}var t=e.prototype;return t.bindTarget=function(e){this.target=e},t.update=function(){},e}(),are=st({World:0,Local:1,Custom:2}),sre=st({Pause:0,PauseAndCatchup:1,AlwaysSimulate:2}),cre=st({World:0,Local:1,View:2}),lre=st({Billboard:0,StrecthedBillboard:1,HorizontalBillboard:2,VerticalBillboard:3,Mesh:4}),ure=st({Box:0,Circle:1,Cone:2,Sphere:3,Hemisphere:4}),hre=st({Base:0,Edge:1,Shell:2,Volume:3}),fre=st({Random:0,Loop:1,PingPong:2}),_re=st({Particles:0}),pre=st({Stretch:0}),dre=(yie=mc("cc.ColorOvertimeModule"),xie=Vc(),Sie=Zc(_ie),Tie=Vc(),yie((wie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_enable",Cie,oe(t)),ce(t,"color",Aie,oe(t)),t.name=$ie,t}return $(t,e),t.prototype.animate=function(e){e.color.set(e.startColor),e.color.multiply(this.color.evaluate(1-e.remainingLifetime/e.startLifetime,vn(e.randomSeed+91041)))},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(ore),Cie=le((Eie=wie).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(Eie.prototype,"enable",[xie],Object.getOwnPropertyDescriptor(Eie.prototype,"enable"),Eie.prototype),Aie=le(Eie.prototype,"color",[Sie,Tc,Tie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _ie}}),bie=Eie))||bie),mre=new In(0,0,-1);function vre(e,t,n,i){return t!==e?(e===are.World||jn.invert(n,n),jn.getRotation(i,n),!0):(Fn.set(i,0,0,0,1),!1)}function gre(e,t){Kn.set(e,Math.cos(t),Math.sin(t))}function yre(e){var t=dn(-1,1),n=dn(0,2*Math.PI),i=Math.sqrt(1-t*t),r=i*Math.cos(n),o=i*Math.sin(n);In.set(e,r,o,t)}function xre(e,t,n){yre(e),In.multiplyScalar(e,e,t+(n-t)*pn())}function Sre(e,t,n,i){gre(e,i),e.z=0,In.multiplyScalar(e,e,t+(n-t)*pn())}function Tre(e){for(var t=0;t<e.length;t++){var n=t+mn(0,e.length-t),i=e[n];e[n]=e[t],e[t]=i}}function bre(){var e=dn(-1,1);return 0===e&&e++,i(e)}var Ere,Cre,Are,wre,Pre,Rre,Ire,Dre,Ore,Mre,Nre,Lre,Bre,Fre,zre,Ure,kre,Gre,Hre,Vre,Wre,jre,qre,Xre,Yre,Kre,Qre,Zre,Jre,$re,eoe,toe,noe,ioe,roe,ooe,aoe,soe,coe,loe,uoe,hoe,foe,_oe,poe,doe,moe,voe,goe,yoe,xoe,Soe,Toe,boe,Eoe,Coe,Aoe,woe,Poe,Roe,Ioe=212165,Doe=new In,Ooe=(Pie=mc("cc.ForceOvertimeModule"),Rie=Vc(),Iie=Zc(rne),Die=zc(),Oie=Vc(),Mie=Fc(),Nie=Zc(rne),Lie=zc(),Bie=Vc(),Fie=Fc(),zie=Zc(rne),Uie=zc(),kie=Vc(),Gie=Fc(),Hie=Zc(are),Vie=Vc(),Wie=Fc(),Pie((Jie=function(e){function t(){var t;return ce(t=e.call(this)||this,"_enable",Xie,oe(t)),ce(t,"x",Yie,oe(t)),ce(t,"y",Kie,oe(t)),ce(t,"z",Qie,oe(t)),ce(t,"space",Zie,oe(t)),t.randomized=!1,t.rotation=void 0,t.needTransform=void 0,t.name="forceModule",t.rotation=new Fn,t.needTransform=!1,t.needUpdate=!0,t}$(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=vre(e,this.space,t,this.rotation)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=In.set(Doe,this.x.evaluate(n,vn(e.randomSeed+Ioe)),this.y.evaluate(n,vn(e.randomSeed+Ioe)),this.z.evaluate(n,vn(e.randomSeed+Ioe)));this.needTransform&&In.transformQuat(i,i,this.rotation),In.scaleAndAdd(e.velocity,e.velocity,i,t),In.copy(e.ultimateVelocity,e.velocity)},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(ore),Xie=le((qie=Jie).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(qie.prototype,"enable",[Rie],Object.getOwnPropertyDescriptor(qie.prototype,"enable"),qie.prototype),Yie=le(qie.prototype,"x",[Iie,Tc,Die,Oie,Mie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Kie=le(qie.prototype,"y",[Nie,Tc,Lie,Bie,Fie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Qie=le(qie.prototype,"z",[zie,Tc,Uie,kie,Gie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Zie=le(qie.prototype,"space",[Hie,Tc,Vie,Wie],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.Local}}),jie=qie))||jie),Moe=23541,Noe=new In,Loe=new In,Boe=(Ere=mc("cc.LimitVelocityOvertimeModule"),Cre=Vc(),Are=Zc(rne),wre=zc(),Pre=Vc(),Rre=Fc(),Ire=Zc(rne),Dre=zc(),Ore=Vc(),Mre=Fc(),Nre=Zc(rne),Lre=zc(),Bre=Vc(),Fre=Fc(),zre=Zc(rne),Ure=zc(),kre=Vc(),Gre=Fc(),Hre=Vc(),Vre=Fc(),Wre=Vc(),jre=Fc(),qre=Zc(are),Xre=Vc(),Yre=Fc(),Ere((ooe=function(e){function t(){var t;return ce(t=e.call(this)||this,"_enable",Zre,oe(t)),ce(t,"limitX",Jre,oe(t)),ce(t,"limitY",$re,oe(t)),ce(t,"limitZ",eoe,oe(t)),ce(t,"limit",toe,oe(t)),ce(t,"dampen",noe,oe(t)),ce(t,"separateAxes",ioe,oe(t)),ce(t,"space",roe,oe(t)),t.drag=null,t.multiplyDragByParticleSize=!1,t.multiplyDragByParticleVelocity=!1,t.name="limitModule",t.rotation=void 0,t.needTransform=void 0,t.rotation=new Fn,t.needTransform=!1,t.needUpdate=!0,t}$(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=vre(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=Noe;this.separateAxes?(In.set(Loe,this.limitX.evaluate(t,vn(e.randomSeed+Moe)),this.limitY.evaluate(t,vn(e.randomSeed+Moe)),this.limitZ.evaluate(t,vn(e.randomSeed+Moe))),this.needTransform&&In.transformQuat(Loe,Loe,this.rotation),In.set(n,Foe(e.ultimateVelocity.x,Loe.x,this.dampen),Foe(e.ultimateVelocity.y,Loe.y,this.dampen),Foe(e.ultimateVelocity.z,Loe.z,this.dampen))):(In.normalize(n,e.ultimateVelocity),In.multiplyScalar(n,n,Foe(e.ultimateVelocity.length(),this.limit.evaluate(t,vn(e.randomSeed+Moe)),this.dampen))),In.copy(e.ultimateVelocity,n)},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(ore),Zre=le((Qre=ooe).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(Qre.prototype,"enable",[Cre],Object.getOwnPropertyDescriptor(Qre.prototype,"enable"),Qre.prototype),Jre=le(Qre.prototype,"limitX",[Are,Tc,wre,Pre,Rre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),$re=le(Qre.prototype,"limitY",[Ire,Tc,Dre,Ore,Mre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),eoe=le(Qre.prototype,"limitZ",[Nre,Tc,Lre,Bre,Fre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),toe=le(Qre.prototype,"limit",[zre,Tc,Ure,kre,Gre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),noe=le(Qre.prototype,"dampen",[Tc,Hre,Vre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 3}}),ioe=le(Qre.prototype,"separateAxes",[Tc,Wre,jre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),roe=le(Qre.prototype,"space",[qre,Tc,Xre,Yre],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.Local}}),Kre=Qre))||Kre);function Foe(e,t,n){var i=Math.sign(e),r=Math.abs(e);return r>t&&(r=hn(r,t,n)),r*i}var zoe,Uoe,koe,Goe,Hoe,Voe,Woe,joe,qoe,Xoe,Yoe,Koe,Qoe,Zoe,Joe,$oe,eae,tae,nae,iae,rae,oae,aae,sae,cae,lae,uae,hae,fae,_ae,pae,dae,mae,vae,gae,yae,xae,Sae,Tae,bae,Eae,Cae,Aae,wae,Pae,Rae,Iae,Dae,Oae,Mae,Nae,Lae,Bae,Fae,zae,Uae,kae,Gae,Hae,Vae,Wae,jae,qae,Xae,Yae,Kae,Qae,Zae,Jae,$ae,ese,tse,nse,ise,rse,ose,ase,sse,cse,lse,use,hse,fse,_se,pse,dse,mse,vse,gse,yse,xse,Sse,Tse,bse,Ese,Cse,Ase,wse,Pse,Rse,Ise,Dse,Ose,Mse,Nse,Lse,Bse,Fse,zse,Use,kse,Gse,Hse,Vse,Wse,jse,qse,Xse,Yse,Kse,Qse,Zse,Jse,$se,ece,tce,nce,ice,rce,oce,ace,sce,cce,lce,uce,hce,fce,_ce,pce,dce,mce,vce,gce,yce,xce,Sce,Tce,bce,Ece,Cce,Ace,wce,Pce,Rce,Ice,Dce,Oce,Mce,Nce,Lce,Bce,Fce,zce,Uce,kce,Gce,Hce,Vce,Wce,jce,qce,Xce,Yce,Kce,Qce,Zce,Jce,$ce,ele,tle,nle,ile,rle=(aoe=mc("cc.RotationOvertimeModule"),soe=Vc(),coe=Vc(),loe=Fc(),uoe=Zc(rne),hoe=zc(),foe=Vc(),_oe=Fc(),poe=Zc(rne),doe=zc(),moe=Vc(),voe=Fc(),goe=Zc(rne),yoe=zc(),xoe=Vc(),Soe=Fc(),aoe((Roe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_enable",Eoe,oe(t)),ce(t,"_separateAxes",Coe,oe(t)),ce(t,"x",Aoe,oe(t)),ce(t,"y",woe,oe(t)),ce(t,"z",Poe,oe(t)),t.name=ere,t._startMat=new jn,t._matRot=new jn,t._quatRot=new Fn,t._otherEuler=new In,t}$(t,e);var n=t.prototype;return n._processRotation=function(e){var t=e.particleSystem.processor.getInfo().renderMode;t!==lre.Mesh&&t===lre.StrecthedBillboard&&this._quatRot.set(0,0,0,1),Fn.normalize(this._quatRot,this._quatRot),this._quatRot.w<0&&(this._quatRot.x+=gie.INDENTIFY_NEG_QUAT)},n.animate=function(e,t){var n=1-e.remainingLifetime/e.startLifetime,i=vn(e.randomSeed+125292),r=e.particleSystem.processor.getInfo().renderMode;this._separateAxes&&r!==lre.VerticalBillboard&&r!==lre.HorizontalBillboard?Fn.fromEuler(e.deltaQuat,this.x.evaluate(n,i)*t*gie.R2D,this.y.evaluate(n,i)*t*gie.R2D,this.z.evaluate(n,i)*t*gie.R2D):Fn.fromEuler(e.deltaQuat,0,0,this.z.evaluate(n,i)*t*gie.R2D),e.deltaMat=jn.fromQuat(e.deltaMat,e.deltaQuat),e.localMat=e.localMat.multiply(e.deltaMat),e.startRotated||(r!==lre.Mesh&&(r===lre.StrecthedBillboard?e.startEuler.set(0,0,0):r!==lre.Billboard&&e.startEuler.set(0,0,e.startEuler.z)),Fn.fromEuler(e.startRotation,e.startEuler.x*gie.R2D,e.startEuler.y*gie.R2D,e.startEuler.z*gie.R2D),e.startRotated=!0),this._startMat=jn.fromQuat(this._startMat,e.startRotation),this._matRot=this._startMat.multiply(e.localMat),jn.getRotation(this._quatRot,this._matRot),this._processRotation(e,gie.R2D),e.rotation.set(this._quatRot.x,this._quatRot.y,this._quatRot.z)},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}},{key:"separateAxes",get:function(){return this._separateAxes},set:function(e){this._separateAxes=e}}]),t}(ore),Eoe=le((boe=Roe).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(boe.prototype,"enable",[soe],Object.getOwnPropertyDescriptor(boe.prototype,"enable"),boe.prototype),Coe=le(boe.prototype,"_separateAxes",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(boe.prototype,"separateAxes",[coe,loe],Object.getOwnPropertyDescriptor(boe.prototype,"separateAxes"),boe.prototype),Aoe=le(boe.prototype,"x",[uoe,Tc,hoe,Wc,foe,_oe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),woe=le(boe.prototype,"y",[poe,Tc,doe,Wc,moe,voe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Poe=le(boe.prototype,"z",[goe,Tc,yoe,Wc,xoe,Soe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Toe=boe))||Toe),ole=(zoe=mc("cc.SizeOvertimeModule"),Uoe=Vc(),koe=Vc(),Goe=Fc(),Hoe=Zc(rne),Voe=zc(),Woe=Vc(),joe=Fc(),qoe=Zc(rne),Xoe=zc(),Yoe=Vc(),Koe=Fc(),Qoe=Zc(rne),Zoe=zc(),Joe=Vc(),$oe=Fc(),eae=Zc(rne),tae=zc(),nae=Vc(),iae=Fc(),zoe((fae=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_enable",aae,oe(t)),ce(t,"separateAxes",sae,oe(t)),ce(t,"size",cae,oe(t)),ce(t,"x",lae,oe(t)),ce(t,"y",uae,oe(t)),ce(t,"z",hae,oe(t)),t.name=tre,t}return $(t,e),t.prototype.animate=function(e){if(this.separateAxes){var t=1-e.remainingLifetime/e.startLifetime,n=vn(e.randomSeed+39825);e.size.x=e.startSize.x*this.x.evaluate(t,n),e.size.y=e.startSize.y*this.y.evaluate(t,n),e.size.z=e.startSize.z*this.z.evaluate(t,n)}else In.multiplyScalar(e.size,e.startSize,this.size.evaluate(1-e.remainingLifetime/e.startLifetime,vn(e.randomSeed+39825)))},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(ore),aae=le((oae=fae).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(oae.prototype,"enable",[Uoe],Object.getOwnPropertyDescriptor(oae.prototype,"enable"),oae.prototype),sae=le(oae.prototype,"separateAxes",[Tc,koe,Goe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),cae=le(oae.prototype,"size",[Hoe,Tc,Voe,Woe,joe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),lae=le(oae.prototype,"x",[qoe,Tc,Xoe,Yoe,Koe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),uae=le(oae.prototype,"y",[Qoe,Tc,Zoe,Joe,$oe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),hae=le(oae.prototype,"z",[eae,Tc,tae,nae,iae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),rae=oae))||rae),ale=90794,sle=st({Grid:0}),cle=st({WholeSheet:0,SingleRow:1}),lle=(_ae=mc("cc.TextureAnimationModule"),pae=bc("numTilesX"),dae=bc("numTilesY"),mae=Vc(),vae=Zc(sle),gae=Zc(sle),yae=Vc(),xae=Fc(),Sae=Vc(),Tae=Fc(),bae=Vc(),Eae=Fc(),Cae=Zc(cle),Aae=Vc(),wae=Fc(),Pae=Zc(rne),Rae=zc(),Iae=Vc(),Dae=Fc(),Oae=Zc(rne),Mae=zc(),Nae=Vc(),Lae=Fc(),Bae=Vc(),Fae=Fc(),zae=Vc(),Uae=Fc(),kae=Vc(),Gae=Fc(),_ae((ise=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_enable",Wae,oe(t)),ce(t,"_numTilesX",jae,oe(t)),ce(t,"_numTilesY",qae,oe(t)),ce(t,"_mode",Xae,oe(t)),ce(t,"animation",Yae,oe(t)),ce(t,"frameOverTime",Kae,oe(t)),ce(t,"startFrame",Qae,oe(t)),ce(t,"cycleCount",Zae,oe(t)),ce(t,"_flipU",Jae,oe(t)),ce(t,"_flipV",$ae,oe(t)),ce(t,"_uvChannelMask",ese,oe(t)),ce(t,"randomRow",tse,oe(t)),ce(t,"rowIndex",nse,oe(t)),t.name=nre,t}$(t,e);var n=t.prototype;return n.init=function(e){e.startRow=Math.floor(Math.random()*this.numTilesY)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=this.startFrame.evaluate(t,vn(e.randomSeed+ale))/(this.numTilesX*this.numTilesY);if(this.animation===cle.WholeSheet)e.frameIndex=Sn(this.cycleCount*(this.frameOverTime.evaluate(t,vn(e.randomSeed+ale))+n),1);else if(this.animation===cle.SingleRow){var i=1/this.numTilesY;if(this.randomRow){var r=Sn(this.cycleCount*(this.frameOverTime.evaluate(t,vn(e.randomSeed+ale))+n),1),o=e.startRow*i,a=o+i;e.frameIndex=hn(o,a,r)}else{var s=this.rowIndex*i,c=s+i;e.frameIndex=hn(s,c,Sn(this.cycleCount*(this.frameOverTime.evaluate(t,vn(e.randomSeed+ale))+n),1))}}},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&(this.target.updateMaterialParams(),this.target.enableModule(this.name,e,this)))}},{key:"mode",get:function(){return this._mode},set:function(e){e!==sle.Grid&&console.error("particle texture animation's sprites is not supported!")}},{key:"numTilesX",get:function(){return this._numTilesX},set:function(e){this._numTilesX!==e&&(this._numTilesX=e,this.target.updateMaterialParams())}},{key:"numTilesY",get:function(){return this._numTilesY},set:function(e){this._numTilesY!==e&&(this._numTilesY=e,this.target.updateMaterialParams())}},{key:"flipU",get:function(){return this._flipU},set:function(){console.error("particle texture animation's flipU is not supported!")}},{key:"flipV",get:function(){return this._flipV},set:function(){console.error("particle texture animation's flipV is not supported!")}},{key:"uvChannelMask",get:function(){return this._uvChannelMask},set:function(){console.error("particle texture animation's uvChannelMask is not supported!")}}]),t}(ore),Wae=le((Vae=ise).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),jae=le(Vae.prototype,"_numTilesX",[pae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qae=le(Vae.prototype,"_numTilesY",[dae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(Vae.prototype,"enable",[mae],Object.getOwnPropertyDescriptor(Vae.prototype,"enable"),Vae.prototype),Xae=le(Vae.prototype,"_mode",[vae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sle.Grid}}),le(Vae.prototype,"mode",[gae,yae,xae],Object.getOwnPropertyDescriptor(Vae.prototype,"mode"),Vae.prototype),le(Vae.prototype,"numTilesX",[Sae,Tae],Object.getOwnPropertyDescriptor(Vae.prototype,"numTilesX"),Vae.prototype),le(Vae.prototype,"numTilesY",[bae,Eae],Object.getOwnPropertyDescriptor(Vae.prototype,"numTilesY"),Vae.prototype),Yae=le(Vae.prototype,"animation",[Cae,Tc,Aae,wae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cle.WholeSheet}}),Kae=le(Vae.prototype,"frameOverTime",[Pae,Tc,Rae,Iae,Dae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Qae=le(Vae.prototype,"startFrame",[Oae,Tc,Mae,Nae,Lae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Zae=le(Vae.prototype,"cycleCount",[Tc,Bae,Fae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jae=le(Vae.prototype,"_flipU",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),$ae=le(Vae.prototype,"_flipV",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ese=le(Vae.prototype,"_uvChannelMask",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return-1}}),tse=le(Vae.prototype,"randomRow",[Tc,zae,Uae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),nse=le(Vae.prototype,"rowIndex",[Tc,kae,Gae],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Hae=Vae))||Hae),ule=197866,hle=new In,fle=(rse=mc("cc.VelocityOvertimeModule"),ose=Vc(),ase=Zc(rne),sse=zc(),cse=Vc(),lse=Fc(),use=Zc(rne),hse=zc(),fse=Vc(),_se=Fc(),pse=Zc(rne),dse=zc(),mse=Vc(),vse=Fc(),gse=Zc(rne),yse=zc(),xse=Vc(),Sse=Fc(),Tse=Zc(are),bse=Vc(),Ese=Fc(),rse((Mse=function(e){function t(){var t;return ce(t=e.call(this)||this,"_enable",wse,oe(t)),ce(t,"x",Pse,oe(t)),ce(t,"y",Rse,oe(t)),ce(t,"z",Ise,oe(t)),ce(t,"speedModifier",Dse,oe(t)),ce(t,"space",Ose,oe(t)),t.rotation=void 0,t.needTransform=void 0,t.name="velocityModule",t.rotation=new Fn,t.speedModifier.constant=1,t.needTransform=!1,t.needUpdate=!0,t}$(t,e);var n=t.prototype;return n.update=function(e,t){this.needTransform=vre(e,this.space,t,this.rotation)},n.animate=function(e){var t=1-e.remainingLifetime/e.startLifetime,n=In.set(hle,this.x.evaluate(t,vn(e.randomSeed^ule)),this.y.evaluate(t,vn(156497^e.randomSeed)),this.z.evaluate(t,vn(984136^e.randomSeed)));this.needTransform&&In.transformQuat(n,n,this.rotation),In.add(e.animatedVelocity,e.animatedVelocity,n),In.add(e.ultimateVelocity,e.velocity,e.animatedVelocity),In.multiplyScalar(e.ultimateVelocity,e.ultimateVelocity,this.speedModifier.evaluate(1-e.remainingLifetime/e.startLifetime,vn(e.randomSeed+ule)))},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable!==e&&(this._enable=e,this.target&&this.target.enableModule(this.name,e,this))}}]),t}(ore),wse=le((Ase=Mse).prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(Ase.prototype,"enable",[ose],Object.getOwnPropertyDescriptor(Ase.prototype,"enable"),Ase.prototype),Pse=le(Ase.prototype,"x",[ase,Tc,sse,cse,lse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Rse=le(Ase.prototype,"y",[use,Tc,hse,fse,_se],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Ise=le(Ase.prototype,"z",[pse,Tc,dse,mse,vse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Dse=le(Ase.prototype,"speedModifier",[gse,Tc,yse,xse,Sse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Ose=le(Ase.prototype,"space",[Tse,Tc,bse,Ese],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.Local}}),Cse=Ase))||Cse),_le=e("Burst",(Nse=mc("cc.Burst"),Lse=Zc(rne),Bse=zc(),Nse((Vse=function(){function e(){ce(this,"_time",Use,this),ce(this,"_repeatCount",kse,this),ce(this,"repeatInterval",Gse,this),ce(this,"count",Hse,this),this._remainingCount=void 0,this._curTime=void 0,this._remainingCount=0,this._curTime=0}var t=e.prototype;return t.update=function(e,t){if(0===this._remainingCount&&(this._remainingCount=this._repeatCount,this._curTime=this._time),this._remainingCount>0){var n=Sn(e._time-e.startDelay.evaluate(0,1),e.duration)-t;n=n>0?n:0;var i=Sn(e.time-e.startDelay.evaluate(0,1),e.duration);this._curTime>=n&&this._curTime<i&&(e.emit(this.count.evaluate(this._curTime/e.duration,1),t-(i-this._curTime)),this._curTime+=this.repeatInterval,--this._remainingCount)}},t.reset=function(){this._remainingCount=0,this._curTime=0},t.getMaxCount=function(e){return this.count.getMax()*Math.min(Math.ceil(e.duration/this.repeatInterval),this.repeatCount)},Z(e,[{key:"time",get:function(){return this._time},set:function(e){this._time=e,this._curTime=e}},{key:"repeatCount",get:function(){return this._repeatCount},set:function(e){this._repeatCount=e,this._remainingCount=e}}]),e}(),Use=le((zse=Vse).prototype,"_time",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(zse.prototype,"time",[Mc],Object.getOwnPropertyDescriptor(zse.prototype,"time"),zse.prototype),kse=le(zse.prototype,"_repeatCount",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),le(zse.prototype,"repeatCount",[Mc],Object.getOwnPropertyDescriptor(zse.prototype,"repeatCount"),zse.prototype),Gse=le(zse.prototype,"repeatInterval",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Hse=le(zse.prototype,"count",[Lse,Tc,Bse],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Fse=zse))||Fse)),ple=new In(0,0,0),dle=[],mle=new In(.5,.5,.5),vle=(Wse=mc("cc.ShapeModule"),jse=Vc(),qse=Fc(),Xse=Vc(),Yse=Fc(),Kse=Vc(),Qse=Fc(),Zse=Vc(),Jse=Fc(),$se=Vc(),ece=Fc(),tce=Vc(),nce=Zc(ure),ice=bc("shapeType"),rce=Vc(),oce=Zc(ure),ace=Fc(),sce=Zc(hre),cce=Vc(),lce=Fc(),uce=Vc(),hce=Fc(),fce=Vc(),_ce=Fc(),pce=Vc(),dce=Fc(),mce=Vc(),vce=Fc(),gce=Vc(),yce=Fc(),xce=Vc(),Sce=Fc(),Tce=Zc(fre),bce=Vc(),Ece=Fc(),Cce=Nc(),Ace=Vc(),wce=Fc(),Pce=Zc(rne),Rce=Nc(),Ice=zc(),Dce=Vc(),Oce=Fc(),Mce=Vc(),Nce=Fc(),Lce=Vc(),Bce=Fc(),Wse((le((zce=function(){function e(){ce(this,"_enable",Uce,this),ce(this,"_shapeType",kce,this),ce(this,"emitFrom",Gce,this),ce(this,"alignToDirection",Hce,this),ce(this,"randomDirectionAmount",Vce,this),ce(this,"sphericalDirectionAmount",Wce,this),ce(this,"randomPositionAmount",jce,this),ce(this,"radius",qce,this),ce(this,"radiusThickness",Xce,this),ce(this,"arcMode",Yce,this),ce(this,"arcSpread",Kce,this),ce(this,"arcSpeed",Qce,this),ce(this,"length",Zce,this),ce(this,"boxThickness",Jce,this),ce(this,"_position",$ce,this),ce(this,"_rotation",ele,this),ce(this,"_scale",tle,this),ce(this,"_arc",nle,this),ce(this,"_angle",ile,this),this.mat=void 0,this.quat=void 0,this.particleSystem=void 0,this.lastTime=void 0,this.totalAngle=void 0,this.mat=new jn,this.quat=new Fn,this.particleSystem=null,this.lastTime=0,this.totalAngle=0}var t=e.prototype;return t.onInit=function(e){this.particleSystem=e,this.constructMat(),this.lastTime=this.particleSystem._time},t.emit=function(e){switch(this.shapeType){case ure.Box:!function(e,t,n,i){switch(e){case hre.Volume:r=n,o=mle,In.set(r,dn(-o.x,o.x),dn(-o.y,o.y),dn(-o.z,o.z));break;case hre.Shell:dle.splice(0,dle.length),dle.push(dn(-.5,.5)),dle.push(dn(-.5,.5)),dle.push(.5*bre()),Tre(dle),gle(dle,t),In.set(n,dle[0],dle[1],dle[2]);break;case hre.Edge:dle.splice(0,dle.length),dle.push(dn(-.5,.5)),dle.push(.5*bre()),dle.push(.5*bre()),Tre(dle),gle(dle,t),In.set(n,dle[0],dle[1],dle[2]);break;default:console.warn(e+" is not supported for box emitter.")}var r,o;In.copy(i,mre)}(this.emitFrom,this.boxThickness,e.position,e.velocity);break;case ure.Circle:!function(e,t,n,i,r){Sre(i,e*(1-t),e,n),In.normalize(r,i)}(this.radius,this.radiusThickness,this.generateArcAngle(),e.position,e.velocity);break;case ure.Cone:!function(e,t,n,i,r,o,a,s){switch(e){case hre.Base:Sre(a,t*(1-n),t,i),Kn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,In.normalize(s,s),a.z=0;break;case hre.Shell:gre(a,i),Kn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r),In.normalize(s,s),Kn.multiplyScalar(a,a,t),a.z=0;break;case hre.Volume:Sre(a,t*(1-n),t,i),Kn.multiplyScalar(s,a,Math.sin(r)),s.z=-Math.cos(r)*t,In.normalize(s,s),a.z=0,In.add(a,a,In.multiplyScalar(ple,s,o*pn()/-s.z));break;default:console.warn(e+" is not supported for cone emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,this.generateArcAngle(),this._angle,this.length,e.position,e.velocity);break;case ure.Sphere:!function(e,t,n,i,r){switch(e){case hre.Volume:xre(i,t*(1-n),t),In.normalize(r,i);break;case hre.Shell:yre(i),In.multiplyScalar(i,i,t),In.normalize(r,i);break;default:console.warn(e+" is not supported for sphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;case ure.Hemisphere:!function(e,t,n,i,r){switch(e){case hre.Volume:xre(i,t*(1-n),t),i.z>0&&(i.z*=-1),In.normalize(r,i);break;case hre.Shell:yre(i),In.multiplyScalar(i,i,t),i.z>0&&(i.z*=-1),In.normalize(r,i);break;default:console.warn(e+" is not supported for hemisphere emitter.")}}(this.emitFrom,this.radius,this.radiusThickness,e.position,e.velocity);break;default:console.warn(this.shapeType+" shapeType is not supported by ShapeModule.")}if(this.randomPositionAmount>0&&(e.position.x+=dn(-this.randomPositionAmount,this.randomPositionAmount),e.position.y+=dn(-this.randomPositionAmount,this.randomPositionAmount),e.position.z+=dn(-this.randomPositionAmount,this.randomPositionAmount)),In.transformQuat(e.velocity,e.velocity,this.quat),In.transformMat4(e.position,e.position,this.mat),this.sphericalDirectionAmount>0){var t=In.normalize(ple,e.position);In.lerp(e.velocity,e.velocity,t,this.sphericalDirectionAmount)}this.lastTime=this.particleSystem._time},t.constructMat=function(){Fn.fromEuler(this.quat,this._rotation.x,this._rotation.y,this._rotation.z),jn.fromRTS(this.mat,this.quat,this._position,this._scale)},t.generateArcAngle=function(){if(this.arcMode===fre.Random)return dn(0,this._arc);var e=this.totalAngle+2*Math.PI*this.arcSpeed.evaluate(this.particleSystem._time,1)*(this.particleSystem._time-this.lastTime);switch(this.totalAngle=e,0!==this.arcSpread&&(e=Math.floor(e/(this._arc*this.arcSpread))*this._arc*this.arcSpread),this.arcMode){case fre.Loop:return Sn(e,this._arc);case fre.PingPong:return Tn(e,this._arc);default:return Sn(e,this._arc)}},Z(e,[{key:"position",get:function(){return this._position},set:function(e){this._position=e,this.constructMat()}},{key:"rotation",get:function(){return this._rotation},set:function(e){this._rotation=e,this.constructMat()}},{key:"scale",get:function(){return this._scale},set:function(e){this._scale=e,this.constructMat()}},{key:"arc",get:function(){return _n(this._arc)},set:function(e){this._arc=fn(e)}},{key:"angle",get:function(){return Math.round(100*_n(this._angle))/100},set:function(e){this._angle=fn(e)}},{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"shapeType",get:function(){return this._shapeType},set:function(e){switch(this._shapeType=e,this._shapeType){case ure.Box:this.emitFrom===hre.Base&&(this.emitFrom=hre.Volume);break;case ure.Cone:this.emitFrom===hre.Edge&&(this.emitFrom=hre.Base);break;case ure.Sphere:case ure.Hemisphere:this.emitFrom!==hre.Base&&this.emitFrom!==hre.Edge||(this.emitFrom=hre.Volume)}}}]),e}()).prototype,"position",[jse,qse],Object.getOwnPropertyDescriptor(zce.prototype,"position"),zce.prototype),le(zce.prototype,"rotation",[Xse,Yse],Object.getOwnPropertyDescriptor(zce.prototype,"rotation"),zce.prototype),le(zce.prototype,"scale",[Kse,Qse],Object.getOwnPropertyDescriptor(zce.prototype,"scale"),zce.prototype),le(zce.prototype,"arc",[Zse,Jse],Object.getOwnPropertyDescriptor(zce.prototype,"arc"),zce.prototype),le(zce.prototype,"angle",[$se,ece],Object.getOwnPropertyDescriptor(zce.prototype,"angle"),zce.prototype),Uce=le(zce.prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(zce.prototype,"enable",[tce],Object.getOwnPropertyDescriptor(zce.prototype,"enable"),zce.prototype),kce=le(zce.prototype,"_shapeType",[nce,ice,rce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ure.Cone}}),le(zce.prototype,"shapeType",[oce,ace],Object.getOwnPropertyDescriptor(zce.prototype,"shapeType"),zce.prototype),Gce=le(zce.prototype,"emitFrom",[sce,Tc,cce,lce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hre.Volume}}),Hce=le(zce.prototype,"alignToDirection",[Tc,uce,hce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Vce=le(zce.prototype,"randomDirectionAmount",[Tc,fce,_ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Wce=le(zce.prototype,"sphericalDirectionAmount",[Tc,pce,dce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),jce=le(zce.prototype,"randomPositionAmount",[Tc,mce,vce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qce=le(zce.prototype,"radius",[Tc,gce,yce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xce=le(zce.prototype,"radiusThickness",[Tc,xce,Sce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Yce=le(zce.prototype,"arcMode",[Tce,Tc,bce,Ece],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fre.Random}}),Kce=le(zce.prototype,"arcSpread",[Cce,Tc,Ace,wce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Qce=le(zce.prototype,"arcSpeed",[Pce,Rce,Ice,Tc,Dce,Oce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Zce=le(zce.prototype,"length",[Tc,Mce,Nce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),Jce=le(zce.prototype,"boxThickness",[Tc,Lce,Bce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,0,0)}}),$ce=le(zce.prototype,"_position",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,0,0)}}),ele=le(zce.prototype,"_rotation",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,0,0)}}),tle=le(zce.prototype,"_scale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(1,1,1)}}),nle=le(zce.prototype,"_arc",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fn(360)}}),ile=le(zce.prototype,"_angle",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fn(25)}}),Fce=zce))||Fce);function gle(e,t){t.x>0&&(e[0]+=.5*dn(-t.x,t.x),e[0]=ln(e[0],-.5,.5)),t.y>0&&(e[1]+=.5*dn(-t.y,t.y),e[1]=ln(e[1],-.5,.5)),t.z>0&&(e[2]+=.5*dn(-t.z,t.z),e[2]=ln(e[2],-.5,.5))}var yle,xle,Sle,Tle,ble,Ele,Cle,Ale,wle,Ple,Rle,Ile,Dle,Ole,Mle,Nle,Lle,Ble,Fle,zle,Ule,kle,Gle,Hle,Vle,Wle,jle,qle,Xle,Yle,Kle,Qle,Zle,Jle,$le=[0,0,1,0,0,1,1,1],eue=function(e){function t(){var t;return(t=e.call(this)||this)._capacity=void 0,t._vertAttrs=void 0,t._vertSize=void 0,t._vBuffer=void 0,t._vertAttrsFloatCount=void 0,t._vdataF32=void 0,t._vdataUint32=void 0,t._iaInfo=void 0,t._iaInfoBuffer=void 0,t._subMeshData=void 0,t._mesh=void 0,t._vertCount=0,t._indexCount=0,t._startTimeOffset=0,t._lifeTimeOffset=0,t._material=null,t.type=nT.PARTICLE_BATCH,t._capacity=0,t._vertAttrs=null,t._vertSize=0,t._vBuffer=null,t._vertAttrsFloatCount=0,t._vdataF32=null,t._vdataUint32=null,t._iaInfo=new vr([new dr]),t._iaInfoBuffer=t._device.createBuffer(new _r(vi.INDIRECT,xi.HOST|xi.DEVICE,ro,ro)),t._subMeshData=null,t._mesh=null,t}$(t,e);var n=t.prototype;return n.setCapacity=function(e){var t=this._capacity!==e;this._capacity=e,this._subMeshData&&t&&this.rebuild()},n.setVertexAttributes=function(e,t){if(this._mesh!==e||this._vertAttrs!==t){this._mesh=e,this._vertAttrs=t,this._vertSize=0;for(var n,i=se(this._vertAttrs);!(n=i()).done;){var r=n.value;r.offset=this._vertSize,this._vertSize+=eo[r.format].size}this._vertAttrsFloatCount=this._vertSize/4,this.rebuild()}},n.createSubMeshData=function(){this.destroySubMeshData(),this._vertCount=4,this._indexCount=6,this._mesh&&(this._vertCount=this._mesh.struct.vertexBundles[this._mesh.struct.primitives[0].vertexBundelIndices[0]].view.count,this._indexCount=this._mesh.struct.primitives[0].indexView.count);var e=this._device.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,this._vertSize*this._capacity*this._vertCount,this._vertSize)),t=new ArrayBuffer(this._vertSize*this._capacity*this._vertCount);if(this._mesh&&this._capacity>0){var n=this._vertAttrs[this._vertAttrs.findIndex((function(e){return e.name===Zi.ATTR_TEX_COORD}))].offset;this._mesh.copyAttribute(0,Zi.ATTR_TEX_COORD,t,this._vertSize,n);var i=this._vertAttrs.findIndex((function(e){return e.name===Zi.ATTR_TEX_COORD3}));if(n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Zi.ATTR_POSITION,t,this._vertSize,n),n=this._vertAttrs[i++].offset,this._mesh.copyAttribute(0,Zi.ATTR_NORMAL,t,this._vertSize,n),n=this._vertAttrs[i++].offset,!this._mesh.copyAttribute(0,Zi.ATTR_COLOR,t,this._vertSize,n))for(var r=new Uint32Array(t),o=0;o<this._vertCount;++o)r[o*this._vertAttrsFloatCount+n/4]=Pn.WHITE._val;for(var a=new Float32Array(t),s=1;s<this._capacity;s++)a.copyWithin(s*this._vertSize*this._vertCount/4,0,this._vertSize*this._vertCount/4)}e.update(t);var c=new Uint16Array(this._capacity*this._indexCount);if(this._mesh&&this._capacity>0){this._mesh.copyIndices(0,c);for(var l=1;l<this._capacity;l++)for(var u=0;u<this._indexCount;u++)c[l*this._indexCount+u]=c[u]+l*this._vertCount}else for(var h=0,f=0;f<this._capacity;++f){var _=4*f;c[h++]=_,c[h++]=_+1,c[h++]=_+2,c[h++]=_+3,c[h++]=_+2,c[h++]=_+1}var p=this._device.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,this._capacity*this._indexCount*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));return p.update(c),this._iaInfo.drawInfos[0].vertexCount=this._capacity*this._vertCount,this._iaInfo.drawInfos[0].indexCount=this._capacity*this._indexCount,this._iaInfoBuffer||(this._iaInfoBuffer=this._device.createBuffer(new _r(vi.INDIRECT,xi.HOST|xi.DEVICE,ro,ro))),this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new VA([e],this._vertAttrs,Ui.TRIANGLE_LIST,p,this._iaInfoBuffer),this.initSubModel(0,this._subMeshData,this._material),t},n.updateMaterial=function(e){this._material=e,this.setSubModelMaterial(0,e)},n.addParticleVertexData=function(e,t){if(this._mesh)for(var n=0;n<this._vertCount;n++){var i=(e*this._vertCount+n)*this._vertAttrsFloatCount;this._vdataF32[i++]=t[0].x,this._vdataF32[i++]=t[0].y,this._vdataF32[i++]=t[0].z,i+=2,this._vdataF32[i++]=t[1].z,this._vdataF32[i++]=t[2].x,this._vdataF32[i++]=t[2].y,this._vdataF32[i++]=t[2].z,this._vdataF32[i++]=t[3].x,this._vdataF32[i++]=t[3].y,this._vdataF32[i++]=t[3].z,this._vdataUint32[i++]=t[4]}else{var r=e*this._vertAttrsFloatCount;this._vdataF32[r++]=t[0].x,this._vdataF32[r++]=t[0].y,this._vdataF32[r++]=t[0].z,this._vdataF32[r++]=t[1].x,this._vdataF32[r++]=t[1].y,this._vdataF32[r++]=t[1].z,this._vdataF32[r++]=t[2].x,this._vdataF32[r++]=t[2].y,this._vdataF32[r++]=t[2].z,this._vdataF32[r++]=t[3].x,this._vdataF32[r++]=t[3].y,this._vdataF32[r++]=t[3].z,this._vdataUint32[r++]=t[4],t[5]&&(this._vdataF32[r++]=t[5].x,this._vdataF32[r++]=t[5].y,this._vdataF32[r++]=t[5].z)}},n.addGPUParticleVertexData=function(e,t,n){for(var i=t*this._vertAttrsFloatCount*this._vertCount,r=0;r<this._vertCount;r++){var o=i;this._vdataF32[o++]=e.position.x,this._vdataF32[o++]=e.position.y,this._vdataF32[o++]=e.position.z,this._vdataF32[o++]=n,this._vdataF32[o++]=e.startSize.x,this._vdataF32[o++]=e.startSize.y,this._vdataF32[o++]=e.startSize.z,this._vdataF32[o++]=$le[2*r],this._vdataF32[o++]=e.rotation.x,this._vdataF32[o++]=e.rotation.y,this._vdataF32[o++]=e.rotation.z,this._vdataF32[o++]=$le[2*r+1],this._vdataF32[o++]=e.startColor.r/255,this._vdataF32[o++]=e.startColor.g/255,this._vdataF32[o++]=e.startColor.b/255,this._vdataF32[o++]=e.startColor.a/255,this._vdataF32[o++]=e.velocity.x,this._vdataF32[o++]=e.velocity.y,this._vdataF32[o++]=e.velocity.z,this._vdataF32[o++]=e.startLifetime,this._vdataF32[o++]=e.randomSeed,i+=this._vertAttrsFloatCount}},n.updateGPUParticles=function(e,t,n){for(var i=this._vertAttrsFloatCount*this._vertCount,r=0,o=0,a=0,s=0;s<e;++s)r=s*i,o=this._vdataF32[r+this._startTimeOffset],this._vdataF32[r+this._lifeTimeOffset]-(t-o)<n&&(a=--e*i,this._vdataF32.copyWithin(r,a,a+i),s--);return e},n.constructAttributeIndex=function(){if(this._vertAttrs){var e=this._vertAttrs.findIndex((function(e){return"a_position_starttime"===e.name})),t=this._vertAttrs[e].offset;this._startTimeOffset=t/4+3,e=this._vertAttrs.findIndex((function(e){return"a_dir_life"===e.name})),t=this._vertAttrs[e].offset,this._lifeTimeOffset=t/4+3}},n.updateIA=function(e){e<=0||(this._subModels[0].inputAssembler.vertexBuffers[0].update(this._vdataF32),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=this._indexCount*e,this._iaInfoBuffer.update(this._iaInfo))},n.clear=function(){this._subModels[0].inputAssembler.indexCount=0},n.destroy=function(){e.prototype.destroy.call(this),this._vBuffer=null,this._vdataF32=null,this.destroySubMeshData(),this._iaInfoBuffer&&(this._iaInfoBuffer.destroy(),this._iaInfoBuffer=null)},n.rebuild=function(){this._vBuffer=this.createSubMeshData(),this._vdataF32=new Float32Array(this._vBuffer),this._vdataUint32=new Uint32Array(this._vBuffer)},n.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null,this._iaInfoBuffer=null)},t}(uT),tue=function(){function e(e){this._particleSystem=null,this._model=null,this._renderInfo=null,this._vertAttrs=[],this._renderInfo=e}var t=e.prototype;return t.getInfo=function(){return this._renderInfo},t.onInit=function(e){this._particleSystem=e},t.onEnable=function(){if(this._particleSystem){this.attachToScene();var e=this._model;e&&(e.node=e.transform=this._particleSystem.node)}},t.onDisable=function(){this.detachFromScene()},t.onDestroy=function(){this._model&&(u.director.root.destroyModel(this._model),this._model=null)},t.attachToScene=function(){this._model&&(this._model.scene&&this.detachFromScene(),this._particleSystem._getRenderScene().addModel(this._model))},t.detachFromScene=function(){this._model&&this._model.scene&&this._model.scene.removeModel(this._model)},t.setVertexAttributes=function(){this._model&&this._model.setVertexAttributes(this._renderInfo.renderMode===lre.Mesh?this._renderInfo.mesh:null,this._vertAttrs)},t.clear=function(){this._model&&(this._model.enabled=!1)},t.getModel=function(){return this._model},t._initModel=function(){this._model||(this._model=u.director.root.createModel(eue),this._model.setCapacity(this._particleSystem.capacity),this._model.visFlags=this._particleSystem.visibility)},t.updateTrailMaterial=function(){},t.getDefaultTrailMaterial=function(){return null},e}(),nue=new In,iue=new jn,rue=new Fn,oue=(new In,["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"]),aue=[0,0,1,0,0,1,1,1],sue=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD1,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD2,pi.RGB32F),new Ir(Zi.ATTR_COLOR,pi.RGBA8,!0)],cue=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD1,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD2,pi.RGB32F),new Ir(Zi.ATTR_COLOR,pi.RGBA8,!0),new Ir(Zi.ATTR_COLOR1,pi.RGB32F)],lue=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD1,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD2,pi.RGB32F),new Ir(Zi.ATTR_COLOR,pi.RGBA8,!0),new Ir(Zi.ATTR_TEX_COORD3,pi.RGB32F),new Ir(Zi.ATTR_NORMAL,pi.RGB32F),new Ir(Zi.ATTR_COLOR1,pi.RGBA8,!0)],uue={parent:null,owner:null,subModelIdx:0},hue=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._trailDefines=void 0,n._frameTile_velLenScale=void 0,n._tmp_velLenScale=void 0,n._defaultMat=null,n._node_scale=void 0,n._attrs=void 0,n._particles=null,n._defaultTrailMat=null,n._updateList=new Map,n._animateList=new Map,n._runAnimateList=new Array,n._fillDataFunc=null,n._uScaleHandle=0,n._uLenHandle=0,n._uNodeRotHandle=0,n._alignSpace=cre.View,n._inited=!1,n._localMat=new jn,n._gravity=new $n,n._model=null,n._frameTile_velLenScale=new $n(1,1,0,0),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new $n,n._attrs=new Array(5),n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1},n._trailDefines={CC_USE_WORLD_SPACE:!0},n}$(t,e);var n=t.prototype;return n.onInit=function(t){var n=this;e.prototype.onInit.call(this,t),this._particles=new Xl((function(){return new gie(n)}),16),this._setVertexAttrib(),this._setFillFunc(),this._initModuleList(),this._initModel(),this.updateMaterialParams(),this.updateTrailMaterial(),this.setVertexAttributes(),this._inited=!0},n.clear=function(){e.prototype.clear.call(this),this._particles.reset(),this._particleSystem._trailModule&&this._particleSystem._trailModule.clear(),this.updateRenderData(),this._model.enabled=!1},n.updateRenderMode=function(){this._setVertexAttrib(),this._setFillFunc(),this.updateMaterialParams(),this.setVertexAttributes()},n.getFreeParticle=function(){return this._particles.length>=this._particleSystem.capacity?null:this._particles.add()},n.getDefaultTrailMaterial=function(){return this._defaultTrailMat},n.setNewParticle=function(){},n._initModuleList=function(){var e=this;oue.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=ire.length;t<n;t++){var i=this._animateList[ire[t]];i&&this._runAnimateList.push(i)}},n.enableModule=function(e,t,n){t?(n.needUpdate&&(this._updateList[n.name]=n),n.needAnimate&&(this._animateList[n.name]=n)):(delete this._animateList[e],delete this._updateList[e]),this._runAnimateList.length=0;for(var i=0,r=ire.length;i<r;i++){var o=this._animateList[ire[i]];o&&this._runAnimateList.push(o)}this.updateMaterialParams()},n.updateAlignSpace=function(e){this._alignSpace=e},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(e){e&&this.doUpdateRotation(e)},n.doUpdateRotation=function(e){if(this._renderInfo.renderMode===lre.Mesh||this._alignSpace!==cre.View){if(this._alignSpace===cre.Local)this._particleSystem.node.getRotation(rue);else if(this._alignSpace===cre.World)this._particleSystem.node.getWorldRotation(rue);else if(this._alignSpace===cre.View){var t;rue.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Fn.fromViewUp(rue,r.forward);break}}}else rue.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,rue)}},n.updateScale=function(e){e&&this.doUpdateScale(e)},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case are.Local:this._particleSystem.node.getScale(this._node_scale);break;case are.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(this._uScaleHandle,this._node_scale)},n.updateParticles=function(e){var t=this,n=this._particleSystem;if(!n)return this._particles.length;n.node.getWorldMatrix(iue);var i=(n.getMaterialInstance(0)||this._defaultMat).passes[0];this.doUpdateScale(i),this.doUpdateRotation(i),this._updateList.forEach((function(e){e.update(n._simulationSpace,iue)}));var r=n._trailModule,o=r&&r.enable;if(o&&r.update(),n.simulationSpace===are.Local){var a=n.node.getRotation();jn.fromQuat(this._localMat,a),this._localMat.transpose()}for(var s=function(i){var a=t._particles.data[i];if(a.remainingLifetime-=e,In.set(a.animatedVelocity,0,0,0),a.remainingLifetime<0)return o&&r.removeParticle(a),t._particles.removeAt(i),--i,c=i,"continue";if(n.simulationSpace===are.Local){var s=9.8*-n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,vn(a.randomSeed))*e;t._gravity.x=0,t._gravity.y=s,t._gravity.z=0,t._gravity.w=1,t._gravity=t._gravity.transformMat4(t._localMat),a.velocity.x+=t._gravity.x,a.velocity.y+=t._gravity.y,a.velocity.z+=t._gravity.z}else a.velocity.y-=9.8*n.gravityModifier.evaluate(1-a.remainingLifetime/a.startLifetime,vn(a.randomSeed))*e;In.copy(a.ultimateVelocity,a.velocity),t._runAnimateList.forEach((function(t){t.animate(a,e)})),In.scaleAndAdd(a.position,a.position,a.ultimateVelocity,e),o&&r.animate(a,e),c=i},c=0;c<this._particles.length;++c)s(c);return this._model.enabled=this._particles.length>0,this._particles.length},n.updateRenderData=function(){for(var e=0,t=0;t<this._particles.length;++t){var n=this._particles.data[t],i=0,r=this._particleSystem._textureAnimationModule;r&&r.enable&&(i=n.frameIndex),e=4*t,this._fillDataFunc(n,e,i)}},n.beforeRender=function(){this._model.updateIA(this._particles.length)},n.getParticleCount=function(){return this._particles.length},n.onMaterialModified=function(e){this._inited&&(0===e?this.updateMaterialParams():this.updateTrailMaterial())},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t);var n=this._particleSystem._trailModule;n&&n._trailModel&&1===e&&n._trailModel.setSubModelMaterial(0,t)},n._setFillFunc=function(){this._renderInfo.renderMode===lre.Mesh?this._fillDataFunc=this._fillMeshData:this._renderInfo.renderMode===lre.StrecthedBillboard?this._fillDataFunc=this._fillStrecthedData:this._fillDataFunc=this._fillNormalData},n._fillMeshData=function(e,t,n){var i=t/4;this._attrs[0]=e.position,nue.z=n,this._attrs[1]=nue,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._model.addParticleVertexData(i,this._attrs)},n._fillStrecthedData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,nue.x=aue[2*i],nue.y=aue[2*i+1],nue.z=n,this._attrs[1]=nue,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=e.ultimateVelocity,this._attrs[6]=null,this._model.addParticleVertexData(t++,this._attrs)},n._fillNormalData=function(e,t,n){for(var i=0;i<4;++i)this._attrs[0]=e.position,nue.x=aue[2*i],nue.y=aue[2*i+1],nue.z=n,this._attrs[1]=nue,this._attrs[2]=e.size,this._attrs[3]=e.rotation,this._attrs[4]=e.color._val,this._attrs[5]=null,this._model.addParticleVertexData(t++,this._attrs)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case lre.StrecthedBillboard:this._vertAttrs=cue.slice();break;case lre.Mesh:this._vertAttrs=lue.slice();break;default:this._vertAttrs=sue.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!=t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1!==n.indexOf("particle")&&-1===n.indexOf("particle-gpu")||e.setMaterial(null,0)}null==e.sharedMaterial&&null==this._defaultMat&&(uue.parent=Nv.get("default-particle-material"),uue.owner=this._particleSystem,uue.subModelIdx=0,this._defaultMat=new gT(uue),uue.parent=null,uue.owner=null,uue.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e._simulationSpace===are.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=i.passes[0];this._uScaleHandle=r.getHandle("scale"),this._uLenHandle=r.getHandle("frameTile_velLenScale"),this._uNodeRotHandle=r.getHandle("nodeRotation");var o=this._renderInfo.renderMode,a=this._frameTile_velLenScale;o===lre.Billboard?this._defines.CC_RENDER_MODE=0:o===lre.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,a.z=this._renderInfo.velocityScale,a.w=this._renderInfo.lengthScale):o===lre.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:o===lre.VerticalBillboard?this._defines.CC_RENDER_MODE=3:o===lre.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+o+" not support.");var s=e._textureAnimationModule;s&&s.enable?($n.copy(this._tmp_velLenScale,a),Kn.set(this._tmp_velLenScale,s.numTilesX,s.numTilesY),r.setUniform(this._uLenHandle,this._tmp_velLenScale)):r.setUniform(this._uLenHandle,a);var c,l=this._particleSystem._rotationOvertimeModule;c=l&&l.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=c,i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},n.updateTrailMaterial=function(){if(this._particleSystem){var e=this._particleSystem,t=e._trailModule;if(t&&t.enable){e.simulationSpace===are.World||t.space===are.World?this._trailDefines.CC_USE_WORLD_SPACE=!0:this._trailDefines.CC_USE_WORLD_SPACE=!1;var n=e.getMaterialInstance(1);null===n&&null===this._defaultTrailMat&&(uue.parent=Nv.get("default-trail-material"),uue.owner=this._particleSystem,uue.subModelIdx=1,this._defaultTrailMat=new gT(uue),uue.parent=null,uue.owner=null,uue.subModelIdx=0),(n=n||this._defaultTrailMat).recompileShaders(this._trailDefines),t.updateMaterial()}}},t}(tue),fue=new jn,_ue=new $n,pue=new Fn,due=new Fn,mue=(new In,32),vue="a_position_starttime",gue="a_size_uv",yue="a_rotation_uv",xue="a_color",Sue="a_dir_life",Tue="a_rndSeed",bue=[new Ir(vue,pi.RGBA32F),new Ir(gue,pi.RGBA32F),new Ir(yue,pi.RGBA32F),new Ir(xue,pi.RGBA32F),new Ir(Sue,pi.RGBA32F),new Ir(Tue,pi.R32F)],Eue=[new Ir(vue,pi.RGBA32F),new Ir(gue,pi.RGBA32F),new Ir(yue,pi.RGBA32F),new Ir(xue,pi.RGBA32F),new Ir(Sue,pi.RGBA32F),new Ir(Tue,pi.R32F),new Ir(Zi.ATTR_TEX_COORD,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD3,pi.RGB32F),new Ir(Zi.ATTR_NORMAL,pi.RGB32F),new Ir(Zi.ATTR_COLOR1,pi.RGBA8,!0)],Cue={parent:null,owner:null,subModelIdx:0},Aue=function(e){function t(t){var n;return(n=e.call(this,t)||this)._defines=void 0,n._frameTile_velLenScale=void 0,n._unifrom_velLenScale=void 0,n._tmp_velLenScale=void 0,n._node_scale=void 0,n._vertAttrs=[],n._defaultMat=null,n._particleNum=0,n._tempParticle=null,n._colorTexture=null,n._forceTexture=null,n._velocityTexture=null,n._rotationTexture=null,n._sizeTexture=null,n._animTexture=null,n._uTimeHandle=0,n._uRotHandle=0,n._uNodeRotHandle=0,n._alignSpace=cre.View,n._inited=!1,n._frameTile_velLenScale=new $n(1,1,0,0),n._unifrom_velLenScale=n._frameTile_velLenScale.clone(),n._tmp_velLenScale=n._frameTile_velLenScale.clone(),n._node_scale=new $n,n._defines={CC_USE_WORLD_SPACE:!0,CC_USE_BILLBOARD:!0,CC_USE_STRETCHED_BILLBOARD:!1,CC_USE_HORIZONTAL_BILLBOARD:!1,CC_USE_VERTICAL_BILLBOARD:!1,COLOR_OVER_TIME_MODULE_ENABLE:!1},n._tempParticle=new gie(null),n._particleNum=0,n}$(t,e);var n=t.prototype;return n.onInit=function(t){e.prototype.onInit.call(this,t),this._setVertexAttrib(),this._initModel(),this.updateMaterialParams(),this.setVertexAttributes(),this._inited=!0},n.updateRenderMode=function(){this._setVertexAttrib(),this.updateMaterialParams(),this.setVertexAttributes()},n.setVertexAttributes=function(){e.prototype.setVertexAttributes.call(this),this._model.constructAttributeIndex()},n.clear=function(){e.prototype.clear.call(this),this._particleNum=0,this.updateRenderData()},n.onDestroy=function(){e.prototype.onDestroy.call(this),this._forceTexture&&this._forceTexture.destroy(),this._velocityTexture&&this._velocityTexture.destroy(),this._colorTexture&&this._colorTexture.destroy(),this._sizeTexture&&this._sizeTexture.destroy(),this._rotationTexture&&this._rotationTexture.destroy(),this._animTexture&&this._animTexture.destroy()},n.enableModule=function(){var e=this._particleSystem.getMaterialInstance(0)||this._defaultMat;e&&(this.initShaderUniform(e),e.recompileShaders(this._defines),this._model&&this._model.setSubModelMaterial(0,e))},n.getFreeParticle=function(){return this._particleNum>=this._particleSystem._capacity?null:this._tempParticle},n.setNewParticle=function(e){this._model.addGPUParticleVertexData(e,this._particleNum,this._particleSystem._time),this._particleNum++},n.getDefaultMaterial=function(){return this._defaultMat},n.updateRotation=function(e){e&&this.doUpdateRotation(e)},n.doUpdateRotation=function(e){if(this._renderInfo.renderMode===lre.Mesh||this._alignSpace!==cre.View){if(this._alignSpace===cre.Local)this._particleSystem.node.getRotation(due);else if(this._alignSpace===cre.World)this._particleSystem.node.getWorldRotation(due);else if(this._alignSpace===cre.View){var t;due.set(0,0,0,1);var n=null===(t=this._particleSystem.node.scene.renderScene)||void 0===t?void 0:t.cameras;if(void 0!==n)for(var i=0;i<(null==n?void 0:n.length);++i){var r=n[i];if((r.visibility&this._particleSystem.node.layer)===this._particleSystem.node.layer){Fn.fromViewUp(due,r.forward);break}}}else due.set(0,0,0,1);e.setUniform(this._uNodeRotHandle,due)}},n.updateScale=function(e){e&&this.doUpdateScale(e)},n.doUpdateScale=function(e){switch(this._particleSystem.scaleSpace){case are.Local:this._particleSystem.node.getScale(this._node_scale);break;case are.World:this._particleSystem.node.getWorldScale(this._node_scale)}e.setUniform(e.getHandle("scale"),this._node_scale)},n.updateParticles=function(e){return this._particleNum=this._model.updateGPUParticles(this._particleNum,this._particleSystem._time,e),this.updateShaderUniform(e),this._model.enabled=this._particleNum>0,this._particleNum},n.updateRenderData=function(){},n.beforeRender=function(){this._model.updateIA(this._particleNum)},n.updateAlignSpace=function(e){this._alignSpace=e},n.updateShaderUniform=function(e){var t=this._particleSystem.getMaterialInstance(0)||this._defaultMat;if(t){var n=t.passes[0];_ue.x=this._particleSystem._time,_ue.y=e,n.setUniform(this._uTimeHandle,_ue),this._particleSystem.node.getWorldRotation(pue),n.setUniform(this._uRotHandle,pue),this.doUpdateRotation(n)}},n.initShaderUniform=function(e){var t=e.passes[0];this._uTimeHandle=t.getHandle("u_timeDelta"),this._uRotHandle=t.getHandle("u_worldRot"),this._uNodeRotHandle=t.getHandle("nodeRotation"),this.doUpdateScale(t),t.setUniform(t.getHandle("frameTile_velLenScale"),this._unifrom_velLenScale),_ue.x=mue,_ue.y=.03125,t.setUniform(t.getHandle("u_sampleInfo"),_ue);var n=!1,i=this._particleSystem._forceOvertimeModule;if(n=i&&i.enable,this._defines.FORCE_OVER_TIME_MODULE_ENABLE=n,n){this._forceTexture&&this._forceTexture.destroy(),this._forceTexture=cne(mue,i.x,i.y,i.z);var r=t.getHandle("force_over_time_tex0"),o=Gv.getBindingFromHandle(r);t.bindSampler(o,this._forceTexture.getGFXSampler()),t.bindTexture(o,this._forceTexture.getGFXTexture());var a=t.getHandle("u_force_space");t.setUniform(a,i.space);var s=t.getHandle("u_force_mode");t.setUniform(s,this._forceTexture.height)}var c=this._particleSystem._velocityOvertimeModule;if(n=c&&c.enable,this._defines.VELOCITY_OVER_TIME_MODULE_ENABLE=n,n){this._velocityTexture&&this._velocityTexture.destroy(),this._velocityTexture=function(e,t,n,i,r){for(var o=Math.max(ane(t),ane(n),ane(i),ane(r)),a=new Float32Array(e*o*4),s=[t,n,i,r],c=1/(e-1),l=0;l<o;l++)for(var u=0;u<4;u++)for(var h=s[u],f=0,_=0,p=0;p<e;p++){var d=one(h,c*p,l);_=(f+=d)/(p+1),a[4*p+u]=_}return sne(a,e,o)}(mue,c.x,c.y,c.z,c.speedModifier);var l=t.getHandle("velocity_over_time_tex0"),h=Gv.getBindingFromHandle(l);t.bindSampler(h,this._velocityTexture.getGFXSampler()),t.bindTexture(h,this._velocityTexture.getGFXTexture());var f=t.getHandle("u_velocity_space");t.setUniform(f,c.space);var _=t.getHandle("u_velocity_mode");t.setUniform(_,this._velocityTexture.height)}var p=this._particleSystem._colorOverLifetimeModule;if(n=p&&p.enable,this._defines.COLOR_OVER_TIME_MODULE_ENABLE=n,n){this._colorTexture&&this._colorTexture.destroy(),this._colorTexture=function(e,t){for(var n=function(e){switch(e.mode){case fie.TwoColors:case fie.TwoGradients:return 2;default:return 1}}(t),i=new Uint8Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=pie(t,r*s,a);i[o]=c.r,i[o+1]=c.g,i[o+2]=c.b,i[o+3]=c.a,o+=4}var l=new Cv;return l.create(e,n,Mm.RGBA8888),l.setFilters(Lm.LINEAR,Lm.LINEAR),l.setWrapMode(Nm.CLAMP_TO_EDGE,Nm.CLAMP_TO_EDGE),l.uploadData(i),l}(mue,p.color);var d=t.getHandle("color_over_time_tex0"),m=Gv.getBindingFromHandle(d);t.bindSampler(m,this._colorTexture.getGFXSampler()),t.bindTexture(m,this._colorTexture.getGFXTexture());var v=t.getHandle("u_color_mode");t.setUniform(v,this._colorTexture.height)}var g=this._particleSystem._rotationOvertimeModule;if(n=g&&g.enable,this._defines.ROTATION_OVER_TIME_MODULE_ENABLE=n,n){this._rotationTexture&&this._rotationTexture.destroy(),g.separateAxes?this._rotationTexture=cne(mue,g.x,g.y,g.z):this._rotationTexture=function(e,t){for(var n=ane(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0;a<n;a++)for(var s=0;s<e;s++){var c=one(t,r*s,a);i[o+2]=c,o+=4}return sne(i,e,n)}(mue,g.z);var y=t.getHandle("rotation_over_time_tex0"),x=Gv.getBindingFromHandle(y);t.bindSampler(x,this._rotationTexture.getGFXSampler()),t.bindTexture(x,this._rotationTexture.getGFXTexture());var S=t.getHandle("u_rotation_mode");t.setUniform(S,this._rotationTexture.height)}var T=this._particleSystem._sizeOvertimeModule;if(n=T&&T.enable,this._defines.SIZE_OVER_TIME_MODULE_ENABLE=n,n){this._sizeTexture&&this._sizeTexture.destroy(),T.separateAxes?this._sizeTexture=cne(mue,T.x,T.y,T.z,!0):this._sizeTexture=function(e,t){for(var n=ane(t),i=new Float32Array(e*n*4),r=1/(e-1),o=0,a=0,s=0;s<n;s++){0;for(var c=0;c<e;c++){var l=one(t,r*c,s);o=l,i[a]=o,i[a+1]=o,i[a+2]=o,a+=4}}return sne(i,e,n)}(mue,T.size);var b=t.getHandle("size_over_time_tex0"),E=Gv.getBindingFromHandle(b);t.bindSampler(E,this._sizeTexture.getGFXSampler()),t.bindTexture(E,this._sizeTexture.getGFXTexture());var C=t.getHandle("u_size_mode");t.setUniform(C,this._sizeTexture.height)}var A=this._particleSystem._textureAnimationModule;if(n=A&&A.enable,this._defines.TEXTURE_ANIMATION_MODULE_ENABLE=n,n){this._animTexture&&this._animTexture.destroy(),this._animTexture=function(e,t,n){for(var i=Math.max(ane(t),ane(n)),r=new Float32Array(e*i*4),o=[t,n],a=1/(e-1),s=0;s<i;s++)for(var c=0;c<2;c++)for(var l=o[c],u=0,h=0,f=0;f<e;f++){var _=one(l,a*f,s);h=(u+=_)/(f+1),r[4*f+c]=h}return sne(r,e,i)}(mue,A.startFrame,A.frameOverTime);var w=t.getHandle("texture_animation_tex0"),P=Gv.getBindingFromHandle(w);t.bindSampler(P,this._animTexture.getGFXSampler()),t.bindTexture(P,this._animTexture.getGFXTexture());var R=t.getHandle("u_anim_info");_ue.x=this._animTexture.height,_ue.y=A.numTilesX*A.numTilesY,_ue.z=A.cycleCount,t.setUniform(R,_ue)}this._defines.USE_VK_SHADER=u.game._gfxDevice.gfxAPI===hi.VULKAN},n.getParticleCount=function(){return this._particleNum},n.onMaterialModified=function(){this._inited&&this.updateMaterialParams()},n.onRebuildPSO=function(e,t){this._model&&0===e&&this._model.setSubModelMaterial(0,t)},n._setVertexAttrib=function(){switch(this._renderInfo.renderMode){case lre.StrecthedBillboard:this._vertAttrs=bue.slice();break;case lre.Mesh:this._vertAttrs=Eue.slice();break;default:this._vertAttrs=bue.slice()}},n.updateMaterialParams=function(){if(this._particleSystem){var e=this._particleSystem,t=e.sharedMaterial;if(null!==t){var n=t._effectAsset._name;this._renderInfo.mainTexture=t.getProperty("mainTexture",0),-1===n.indexOf("particle-gpu")&&(this._renderInfo.mainTexture=t.getProperty("mainTexture",0),this._particleSystem.setMaterial(null,0))}null==e.sharedMaterial&&null==this._defaultMat&&(Cue.parent=Nv.get("default-particle-gpu-material"),Cue.owner=e,Cue.subModelIdx=0,this._defaultMat=new gT(Cue),Cue.parent=null,Cue.owner=null,Cue.subModelIdx=0,null!==this._renderInfo.mainTexture&&this._defaultMat.setProperty("mainTexture",this._renderInfo.mainTexture));var i=e.getMaterialInstance(0)||this._defaultMat;e.node.getWorldMatrix(fue),e._simulationSpace===are.World?this._defines.CC_USE_WORLD_SPACE=!0:this._defines.CC_USE_WORLD_SPACE=!1;var r=this._renderInfo.renderMode;r===lre.Billboard?this._defines.CC_RENDER_MODE=0:r===lre.StrecthedBillboard?(this._defines.CC_RENDER_MODE=1,this._frameTile_velLenScale.z=this._renderInfo.velocityScale,this._frameTile_velLenScale.w=this._renderInfo.lengthScale):r===lre.HorizontalBillboard?this._defines.CC_RENDER_MODE=2:r===lre.VerticalBillboard?this._defines.CC_RENDER_MODE=3:r===lre.Mesh?this._defines.CC_RENDER_MODE=4:console.warn("particle system renderMode "+r+" not support.");var o=e._textureAnimationModule;o&&o.enable?(Kn.set(this._frameTile_velLenScale,o.numTilesX,o.numTilesY),$n.copy(this._unifrom_velLenScale,this._frameTile_velLenScale)):(this._tmp_velLenScale.z=this._frameTile_velLenScale.z,this._tmp_velLenScale.w=this._frameTile_velLenScale.w,$n.copy(this._unifrom_velLenScale,this._tmp_velLenScale)),this.initShaderUniform(i),i.recompileShaders(this._defines),this._model&&this._model.updateMaterial(i)}},t}(tue);function wue(){var e=jM.root.device;return!!(e.capabilities.maxVertexTextureUnits>=8&&e.hasFeature(_i.TEXTURE_FLOAT))||(u.warn("Maybe the device has restrictions on vertex textures or does not support float textures."),!1)}var Pue,Rue,Iue,Due,Oue,Mue,Nue,Lue,Bue,Fue,zue,Uue,kue,Gue,Hue,Vue,Wue,jue,que,Xue,Yue,Kue,Que,Zue,Jue,$ue,ehe,the,nhe,ihe,rhe,ohe,ahe,she,che,lhe,uhe,hhe,fhe,_he,phe,dhe,mhe,vhe,ghe,yhe,xhe,She,The,bhe,Ehe,Che,Ahe,whe,Phe,Rhe,Ihe,Dhe,Ohe,Mhe,Nhe,Lhe,Bhe,Fhe,zhe,Uhe,khe,Ghe,Hhe,Vhe,Whe,jhe,qhe,Xhe,Yhe,Khe,Qhe,Zhe,Jhe,$he,efe,tfe,nfe,ife,rfe,ofe,afe,sfe,cfe,lfe,ufe,hfe,ffe,_fe,pfe,dfe,mfe,vfe,gfe,yfe,xfe,Sfe,Tfe,bfe,Efe,Cfe,Afe,wfe,Pfe,Rfe,Ife,Dfe,Ofe,Mfe,Nfe,Lfe,Bfe,Ffe,zfe,Ufe,kfe,Gfe,Hfe,Vfe,Wfe,jfe,qfe,Xfe,Yfe,Kfe,Qfe,Zfe,Jfe,$fe,e_e,t_e,n_e,i_e,r_e,o_e,a_e,s_e,c_e,l_e,u_e,h_e,f_e,__e,p_e,d_e,m_e,v_e,g_e,y_e,x_e,S_e,T_e,b_e,E_e,C_e,A_e,w_e,P_e,R_e,I_e,D_e,O_e,M_e,N_e,L_e,B_e,F_e,z_e,U_e,k_e,G_e,H_e,V_e,W_e,j_e,q_e,X_e,Y_e,K_e,Q_e,Z_e,J_e,$_e,epe,tpe,npe,ipe,rpe,ope,ape,spe,cpe,lpe,upe,hpe,fpe,_pe,ppe,dpe,mpe,vpe,gpe,ype,xpe,Spe,Tpe,bpe,Epe,Cpe,Ape,wpe,Ppe,Rpe,Ipe,Dpe,Ope,Mpe,Npe,Lpe,Bpe,Fpe,zpe,Upe,kpe,Gpe,Hpe,Vpe,Wpe,jpe,qpe=(yle=mc("cc.ParticleSystemRenderer"),xle=Zc(lre),Sle=Vc(),Tle=Fc(),ble=Vc(),Ele=Fc(),Cle=Vc(),Ale=Fc(),wle=Zc(lre),Ple=Zc(S4),Rle=Vc(),Ile=Fc(),Dle=Zc(ug),Ole=Vc(),Mle=Fc(),Nle=Zc(ug),Lle=Vc(),Ble=Fc(),Fle=Vc(),zle=Fc(),Ule=Zc(cre),kle=Vc(),Gle=Fc(),yle((Jle=Zle=function(){function e(){ce(this,"_renderMode",Wle,this),ce(this,"_velocityScale",jle,this),ce(this,"_lengthScale",qle,this),ce(this,"_mesh",Xle,this),ce(this,"_mainTexture",Yle,this),ce(this,"_useGPU",Kle,this),ce(this,"_alignSpace",Qle,this),this._particleSystem=null}var t=e.prototype;return t.create=function(e){null===this._particleSystem?this._particleSystem=e:this._particleSystem!==e&&M(6033)},t.onInit=function(e){if(this.create(e),this._particleSystem.processor)M(6034);else{var t=this._useGPU&&wue();this._particleSystem.processor=t?new Aue(this):new hue(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(e)}},t._switchProcessor=function(){this._particleSystem&&(this._particleSystem.processor&&(this._particleSystem.processor.detachFromScene(),this._particleSystem.processor.clear(),this._particleSystem.processor=null),this._particleSystem.processor=this._useGPU?new Aue(this):new hue(this),this._particleSystem.processor.updateAlignSpace(this.alignSpace),this._particleSystem.processor.onInit(this._particleSystem),this._particleSystem.processor.onEnable(),this._particleSystem.bindModule())},Z(e,[{key:"renderMode",get:function(){return this._renderMode},set:function(e){this._renderMode!==e&&(this._renderMode=e,this._particleSystem&&this._particleSystem.processor.updateRenderMode())}},{key:"velocityScale",get:function(){return this._velocityScale},set:function(e){this._velocityScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"lengthScale",get:function(){return this._lengthScale},set:function(e){this._lengthScale=e,this._particleSystem&&this._particleSystem.processor.updateMaterialParams()}},{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh=e,this._particleSystem&&this._particleSystem.processor.setVertexAttributes()}},{key:"particleMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(0):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,0)}},{key:"trailMaterial",get:function(){return this._particleSystem?this._particleSystem.getMaterial(1):null},set:function(e){this._particleSystem&&this._particleSystem.setMaterial(e,1)}},{key:"mainTexture",get:function(){return this._mainTexture},set:function(e){this._mainTexture=e}},{key:"useGPU",get:function(){return this._useGPU},set:function(e){this._useGPU!==e&&(wue()?this._useGPU=e:this._useGPU=!1,this._switchProcessor())}},{key:"alignSpace",get:function(){return this._alignSpace},set:function(e){this._alignSpace=e,this._particleSystem.processor.updateAlignSpace(this._alignSpace)}}]),e}(),Zle.AlignmentSpace=cre,le((Vle=Jle).prototype,"renderMode",[xle,Sle,Tle],Object.getOwnPropertyDescriptor(Vle.prototype,"renderMode"),Vle.prototype),le(Vle.prototype,"velocityScale",[ble,Ele],Object.getOwnPropertyDescriptor(Vle.prototype,"velocityScale"),Vle.prototype),le(Vle.prototype,"lengthScale",[Cle,Ale],Object.getOwnPropertyDescriptor(Vle.prototype,"lengthScale"),Vle.prototype),Wle=le(Vle.prototype,"_renderMode",[wle,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return lre.Billboard}}),jle=le(Vle.prototype,"_velocityScale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),qle=le(Vle.prototype,"_lengthScale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Xle=le(Vle.prototype,"_mesh",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(Vle.prototype,"mesh",[Ple,Rle,Ile],Object.getOwnPropertyDescriptor(Vle.prototype,"mesh"),Vle.prototype),le(Vle.prototype,"particleMaterial",[Dle,Ole,Mle],Object.getOwnPropertyDescriptor(Vle.prototype,"particleMaterial"),Vle.prototype),le(Vle.prototype,"trailMaterial",[Nle,Lle,Ble],Object.getOwnPropertyDescriptor(Vle.prototype,"trailMaterial"),Vle.prototype),Yle=le(Vle.prototype,"_mainTexture",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Kle=le(Vle.prototype,"_useGPU",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(Vle.prototype,"useGPU",[Fle,zle],Object.getOwnPropertyDescriptor(Vle.prototype,"useGPU"),Vle.prototype),le(Vle.prototype,"alignSpace",[Ule,kle,Gle],Object.getOwnPropertyDescriptor(Vle.prototype,"alignSpace"),Vle.prototype),Qle=le(Vle.prototype,"_alignSpace",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return cre.View}}),Hle=Vle))||Hle),Xpe=Math.cos(fn(100)),Ype={position:new In,velocity:new In},Kpe=new Fn,Qpe=new jn,Zpe=new In,Jpe=new In,$pe=new Pn,ede=function(){function e(e){for(this.start=void 0,this.end=void 0,this.trailElements=void 0,this.start=-1,this.end=-1,this.trailElements=[];e--;)this.trailElements.push({position:new In,lifetime:0,width:0,velocity:new In,direction:0,color:new Pn})}var t=e.prototype;return t.getElement=function(e){return-1===this.start?null:(e<0&&(e=(e+this.trailElements.length)%this.trailElements.length),e>=this.trailElements.length&&(e%=this.trailElements.length),this.trailElements[e])},t.addElement=function(){if(0===this.trailElements.length)return null;if(-1===this.start)return this.start=0,this.end=1,this.trailElements[0];this.start===this.end&&(this.trailElements.splice(this.end,0,{position:new In,lifetime:0,width:0,velocity:new In,direction:0,color:new Pn}),this.start++,this.start%=this.trailElements.length);var e=this.end++;return this.end%=this.trailElements.length,this.trailElements[e]},t.iterateElement=function(e,t,n,i){for(var r=this.start>=this.end?this.end+this.trailElements.length:this.end,o=this.start;o<r;o++)t(e,this.trailElements[o%this.trailElements.length],n,i)&&(this.start++,this.start%=this.trailElements.length);this.start===r&&(this.start=-1,this.end=-1)},t.count=function(){return this.start<this.end?this.end-this.start:this.trailElements.length+this.end-this.start},t.clear=function(){this.start=-1,this.end=-1},e}(),tde=(Pue=mc("cc.TrailModule"),Rue=Vc(),Iue=Zc(_re),Due=Vc(),Oue=Fc(),Mue=Zc(rne),Nue=zc(),Lue=Vc(),Bue=Fc(),Fue=Vc(),zue=Fc(),Uue=Zc(are),kue=Vc(),Gue=Fc(),Hue=Zc(pre),Vue=Vc(),Wue=Fc(),jue=Vc(),que=Fc(),Xue=Zc(rne),Yue=zc(),Kue=Vc(),Que=Fc(),Zue=Vc(),Jue=Fc(),$ue=Zc(_ie),ehe=Vc(),the=Fc(),nhe=Zc(_ie),ihe=Vc(),rhe=Fc(),ohe=Zc(are),Pue((le((she=function(){function e(){ce(this,"_enable",che,this),ce(this,"mode",lhe,this),ce(this,"lifeTime",uhe,this),ce(this,"_minParticleDistance",hhe,this),ce(this,"existWithParticles",fhe,this),ce(this,"textureMode",_he,this),ce(this,"widthFromParticle",phe,this),ce(this,"widthRatio",dhe,this),ce(this,"colorFromParticle",mhe,this),ce(this,"colorOverTrail",vhe,this),ce(this,"colorOvertime",ghe,this),ce(this,"_space",yhe,this),ce(this,"_particleSystem",xhe,this),this._minSquaredDistance=0,this._vertSize=void 0,this._trailNum=0,this._trailLifetime=0,this.vbOffset=0,this.ibOffset=0,this._trailSegments=null,this._particleTrail=void 0,this._trailModel=null,this._iaInfo=void 0,this._iaInfoBuffer=null,this._subMeshData=null,this._vertAttrs=void 0,this._vbF32=null,this._vbUint32=null,this._iBuffer=null,this._needTransform=!1,this._material=null,this._iaInfo=new vr([new dr]),this._vertAttrs=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RGBA32F),new Ir(Zi.ATTR_TEX_COORD1,pi.RGB32F),new Ir(Zi.ATTR_COLOR,pi.RGBA8,!0)],this._vertSize=0;for(var e,t=se(this._vertAttrs);!(e=t()).done;){var n=e.value;this._vertSize+=eo[n.format].size}this._particleTrail=new Map}var t=e.prototype;return t.onInit=function(e){this._particleSystem=e,this.minParticleDistance=this._minParticleDistance;for(var t=0,n=e.startLifetime.getMax(),i=e.rateOverTime.getMax(),r=e.duration,o=0,a=e.bursts.length;o<a;o++)t+=e.bursts[o].getMaxCount(e)*Math.ceil(n/r);this._trailNum=Math.ceil(n*this.lifeTime.getMax()*60*(i*r+t)),this._trailSegments=new ql((function(){return new ede(10)}),Math.ceil(i*r),(function(e){return e.trailElements.length=0})),this._enable&&(this.enable=this._enable)},t.onEnable=function(){this._attachToScene()},t.onDisable=function(){this._particleTrail.clear(),this._detachFromScene()},t._attachToScene=function(){this._trailModel&&(this._trailModel.scene&&this._detachFromScene(),this._particleSystem._getRenderScene().addModel(this._trailModel))},t._detachFromScene=function(){this._trailModel&&this._trailModel.scene&&this._trailModel.scene.removeModel(this._trailModel)},t.destroy=function(){this.destroySubMeshData(),this._trailModel&&(jM.root.destroyModel(this._trailModel),this._trailModel=null),this._trailSegments&&(this._trailSegments.destroy(),this._trailSegments=null)},t.play=function(){this._trailModel&&this._enable&&(this._trailModel.enabled=!0)},t.clear=function(){if(this.enable){for(var e=this._particleTrail.values(),t=e.next();!t.done;)t.value.clear(),t=e.next();this._particleTrail.clear(),this.updateRenderData(),this._trailModel&&(this._trailModel.enabled=!1)}},t.updateMaterial=function(){this._particleSystem&&(this._material=this._particleSystem.getMaterialInstance(1)||this._particleSystem.processor._defaultTrailMat,this._trailModel&&this._trailModel.setSubModelMaterial(0,this._material))},t.update=function(){this._trailLifetime=this.lifeTime.evaluate(this._particleSystem._time,1),this.space===are.World&&this._particleSystem._simulationSpace===are.Local?(this._needTransform=!0,this._particleSystem.node.getWorldMatrix(Qpe),this._particleSystem.node.getWorldRotation(Kpe)):this._needTransform=!1},t.animate=function(e,t){if(this._trailSegments)if(e.loopCount>e.lastLoop)e.trailDelay>1?(e.lastLoop=e.loopCount,e.trailDelay=0):e.trailDelay++;else{var n=this._particleTrail.get(e);if(!n)return n=this._trailSegments.alloc(),void this._particleTrail.set(e,n);var i=n.getElement(n.end-1);if(this._needTransform?In.transformMat4(Zpe,e.position,Qpe):In.copy(Zpe,e.position),!(i&&(n.iterateElement(this,this._updateTrailElement,e,t),In.squaredDistance(i.position,Zpe)<this._minSquaredDistance))&&(i=n.addElement())){In.copy(i.position,Zpe),i.lifetime=0,this.widthFromParticle?i.width=e.size.x*this.widthRatio.evaluate(0,1):i.width=this.widthRatio.evaluate(0,1);var r=n.count();if(2===r){var o=n.getElement(n.end-2);In.subtract(o.velocity,i.position,o.position)}else if(r>2){var a=n.getElement(n.end-2),s=n.getElement(n.end-3);In.subtract(Zpe,s.position,a.position),In.subtract(Jpe,i.position,a.position),In.subtract(a.velocity,Jpe,Zpe),In.equals(In.ZERO,a.velocity)&&In.copy(a.velocity,Zpe),In.normalize(a.velocity,a.velocity),this._checkDirectionReverse(a,s)}this.colorFromParticle?i.color.set(e.color):i.color.set(this.colorOvertime.evaluate(0,1))}}},t.removeParticle=function(e){var t=this._particleTrail.get(e);t&&this._trailSegments&&(t.clear(),this._trailSegments.free(t),this._particleTrail.delete(e))},t.updateRenderData=function(){this.vbOffset=0,this.ibOffset=0;for(var e,t=se(this._particleTrail.keys());!(e=t()).done;){var n=e.value,i=this._particleTrail.get(n);if(-1!==i.start){var r=4*this.vbOffset/this._vertSize,o=i.start>=i.end?i.end+i.trailElements.length:i.end,a=o-i.start,s=1/a,c=i.trailElements[i.start];this._fillVertexBuffer(c,this.colorOverTrail.evaluate(1,1),r,1,0,4);for(var l=i.start+1;l<o;l++){var u=i.trailElements[l%i.trailElements.length],h=l-i.start;this._fillVertexBuffer(u,this.colorOverTrail.evaluate(1-h/a,1),r,1-h*s,h,5)}this._needTransform?In.transformMat4(Ype.position,n.position,Qpe):In.copy(Ype.position,n.position);var f=this._trailModel;if(f&&f.node.invalidateChildren(oy.POSITION),1===a||2===a){var _=i.getElement(i.end-1);In.subtract(_.velocity,Ype.position,_.position),this._vbF32[this.vbOffset-this._vertSize/4-4]=_.velocity.x,this._vbF32[this.vbOffset-this._vertSize/4-3]=_.velocity.y,this._vbF32[this.vbOffset-this._vertSize/4-2]=_.velocity.z,this._vbF32[this.vbOffset-4]=_.velocity.x,this._vbF32[this.vbOffset-3]=_.velocity.y,this._vbF32[this.vbOffset-2]=_.velocity.z,In.subtract(Ype.velocity,Ype.position,_.position),this._checkDirectionReverse(Ype,_)}else if(a>2){var p=i.getElement(i.end-1),d=i.getElement(i.end-2);In.subtract(Zpe,d.position,p.position),In.subtract(Jpe,Ype.position,p.position),In.normalize(Zpe,Zpe),In.normalize(Jpe,Jpe),In.subtract(p.velocity,Jpe,Zpe),In.normalize(p.velocity,p.velocity),this._checkDirectionReverse(p,d),this.vbOffset-=this._vertSize/4*2,this.ibOffset-=6,this._fillVertexBuffer(p,this.colorOverTrail.evaluate(s,1),r,s,a-1,5),In.subtract(Ype.velocity,Ype.position,p.position),In.normalize(Ype.velocity,Ype.velocity),this._checkDirectionReverse(Ype,p)}this.widthFromParticle?Ype.width=n.size.x*this.widthRatio.evaluate(0,1):Ype.width=this.widthRatio.evaluate(0,1),Ype.color=n.color,In.equals(Ype.velocity,In.ZERO)?this.ibOffset-=3:this._fillVertexBuffer(Ype,this.colorOverTrail.evaluate(0,1),r,0,a,1)}}this._trailModel.enabled=this.ibOffset>0},t.updateIA=function(e){var t=this._trailModel&&this._trailModel.subModels;if(t&&t.length>0){var n=t[0];n.inputAssembler.vertexBuffers[0].update(this._vbF32),n.inputAssembler.indexBuffer.update(this._iBuffer),this._iaInfo.drawInfos[0].firstIndex=0,this._iaInfo.drawInfos[0].indexCount=e,this._iaInfoBuffer.update(this._iaInfo)}},t.beforeRender=function(){this.updateIA(this.ibOffset)},t._createModel=function(){this._trailModel||(this._trailModel=u.director.root.createModel(uT))},t.rebuild=function(){var e=jM.root.device,t=e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,this._vertSize*(this._trailNum+1)*2,this._vertSize)),n=new ArrayBuffer(this._vertSize*(this._trailNum+1)*2);this._vbF32=new Float32Array(n),this._vbUint32=new Uint32Array(n),t.update(n);var i=e.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.HOST|xi.DEVICE,6*Math.max(1,this._trailNum)*Uint16Array.BYTES_PER_ELEMENT,Uint16Array.BYTES_PER_ELEMENT));this._iBuffer=new Uint16Array(6*Math.max(1,this._trailNum)),i.update(this._iBuffer),this._iaInfoBuffer=e.createBuffer(new _r(vi.INDIRECT,xi.HOST|xi.DEVICE,ro,ro)),this._iaInfo.drawInfos[0].vertexCount=2*(this._trailNum+1),this._iaInfo.drawInfos[0].indexCount=6*this._trailNum,this._iaInfoBuffer.update(this._iaInfo),this._subMeshData=new VA([t],this._vertAttrs,Ui.TRIANGLE_LIST,i,this._iaInfoBuffer);var r=this._trailModel;r&&(r.node=r.transform=this._particleSystem.node,r.visFlags=this._particleSystem.visibility,r.initSubModel(0,this._subMeshData,this._material),r.enabled=!0)},t._updateTrailElement=function(e,t,n,i){return t.lifetime+=i,e.colorFromParticle?(t.color.set(n.color),t.color.multiply(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1))):t.color.set(e.colorOvertime.evaluate(1-n.remainingLifetime/n.startLifetime,1)),e.widthFromParticle?t.width=n.size.x*e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1):t.width=e.widthRatio.evaluate(t.lifetime/e._trailLifetime,1),t.lifetime>e._trailLifetime},t._fillVertexBuffer=function(e,t,n,i,r,o){this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=0,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,$pe.set(e.color),$pe.multiply(t),this._vbUint32[this.vbOffset++]=$pe._val,this._vbF32[this.vbOffset++]=e.position.x,this._vbF32[this.vbOffset++]=e.position.y,this._vbF32[this.vbOffset++]=e.position.z,this._vbF32[this.vbOffset++]=1-e.direction,this._vbF32[this.vbOffset++]=e.width,this._vbF32[this.vbOffset++]=i,this._vbF32[this.vbOffset++]=1,this._vbF32[this.vbOffset++]=e.velocity.x,this._vbF32[this.vbOffset++]=e.velocity.y,this._vbF32[this.vbOffset++]=e.velocity.z,this._vbUint32[this.vbOffset++]=$pe._val,1&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r-1,this._iBuffer[this.ibOffset++]=n+2*r+1),4&o&&(this._iBuffer[this.ibOffset++]=n+2*r,this._iBuffer[this.ibOffset++]=n+2*r+1,this._iBuffer[this.ibOffset++]=n+2*r+2)},t._checkDirectionReverse=function(e,t){In.dot(e.velocity,t.velocity)<Xpe?e.direction=1-t.direction:e.direction=t.direction},t.destroySubMeshData=function(){this._subMeshData&&(this._subMeshData.destroy(),this._subMeshData=null)},Z(e,[{key:"enable",get:function(){return this._enable},set:function(e){e===this._enable&&this._trailModel||(e&&!this._enable&&(this._enable=e,this._particleSystem.processor&&this._particleSystem.processor.updateTrailMaterial()),e&&!this._trailModel&&(this._createModel(),this.rebuild()),this._enable=e,this._trailModel&&(this._trailModel.enabled=e),e?this.onEnable():this.onDisable())}},{key:"minParticleDistance",get:function(){return this._minParticleDistance},set:function(e){this._minParticleDistance=e,this._minSquaredDistance=e*e}},{key:"space",get:function(){return this._space},set:function(e){this._space=e;var t=this._particleSystem;t&&t.processor&&t.processor.updateTrailMaterial()}}]),e}()).prototype,"enable",[Rue],Object.getOwnPropertyDescriptor(she.prototype,"enable"),she.prototype),che=le(she.prototype,"_enable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),lhe=le(she.prototype,"mode",[Iue,Tc,Due,Oue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _re.Particles}}),uhe=le(she.prototype,"lifeTime",[Mue,Tc,Nue,Lue,Bue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),hhe=le(she.prototype,"_minParticleDistance",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),le(she.prototype,"minParticleDistance",[Fue,zue],Object.getOwnPropertyDescriptor(she.prototype,"minParticleDistance"),she.prototype),le(she.prototype,"space",[Uue,kue,Gue],Object.getOwnPropertyDescriptor(she.prototype,"space"),she.prototype),fhe=le(she.prototype,"existWithParticles",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),_he=le(she.prototype,"textureMode",[Hue,Tc,Vue,Wue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pre.Stretch}}),phe=le(she.prototype,"widthFromParticle",[Tc,jue,que],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),dhe=le(she.prototype,"widthRatio",[Xue,Tc,Yue,Kue,Que],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),mhe=le(she.prototype,"colorFromParticle",[Tc,Zue,Jue],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vhe=le(she.prototype,"colorOverTrail",[$ue,Tc,ehe,the],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _ie}}),ghe=le(she.prototype,"colorOvertime",[nhe,Tc,ihe,rhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _ie}}),yhe=le(she.prototype,"_space",[ohe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.World}}),xhe=le(she.prototype,"_particleSystem",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ahe=she))||ahe),nde=new jn,ide=new Fn,rde=new In,ode=["_colorOverLifetimeModule","_sizeOvertimeModule","_velocityOvertimeModule","_forceOvertimeModule","_limitVelocityOvertimeModule","_rotationOvertimeModule","_textureAnimationModule"],ade=function(){function e(e){this._particleSystem=void 0,this._processor=void 0,this._node=void 0,this._particlesAll=void 0,this._updateList=new Map,this._animateList=new Map,this._runAnimateList=new Array,this._localMat=new jn,this._gravity=new $n,this.minPos=new In,this.maxPos=new In,this._nodePos=new In,this._nodeSize=new In,this._particleSystem=e,this._processor=this._particleSystem.processor,this._node=e.node,this._particlesAll=[],this._initModuleList()}var t=e.prototype;return t._updateBoundingNode=function(){this._nodeSize.set(this.maxPos.x-this.minPos.x,this.maxPos.y-this.minPos.y,this.maxPos.z-this.minPos.z),this._nodePos.set(this.minPos.x+.5*this._nodeSize.x,this.minPos.y+.5*this._nodeSize.y,this.minPos.z+.5*this._nodeSize.z)},t.setBoundingBoxSize=function(e){this.maxPos.x=this._nodePos.x+e.x,this.maxPos.y=this._nodePos.y+e.y,this.maxPos.z=this._nodePos.z+e.z,this.minPos.x=this._nodePos.x-e.x,this.minPos.y=this._nodePos.y-e.y,this.minPos.z=this._nodePos.z-e.z,this._updateBoundingNode()},t.setBoundingBoxCenter=function(e,t,n){this.maxPos.x=e+.5*this._nodeSize.x,this.maxPos.y=t+.5*this._nodeSize.y,this.maxPos.z=n+.5*this._nodeSize.z,this.minPos.x=e-.5*this._nodeSize.x,this.minPos.y=t-.5*this._nodeSize.y,this.minPos.z=n-.5*this._nodeSize.z,this._updateBoundingNode()},t._initModuleList=function(){var e=this;ode.forEach((function(t){var n=e._particleSystem[t];n&&n.enable&&(n.needUpdate&&(e._updateList[n.name]=n),n.needAnimate&&(e._animateList[n.name]=n))})),this._runAnimateList.length=0;for(var t=0,n=ire.length;t<n;t++){var i=this._animateList[ire[t]];i&&this._runAnimateList.push(i)}},t._emit=function(e,t,i){var r=this._particleSystem,o=this._node,a=r.time%r.duration/r.duration;o.invalidateChildren(oy.POSITION),r.simulationSpace===are.World&&(o.getWorldMatrix(nde),o.getWorldRotation(ide));for(var s=0;s<e;++s){var c=new gie(r);c.particleSystem=r,c.reset();var l=vn(mn(0,n));r._shapeModule&&r._shapeModule.enable?r._shapeModule.emit(c):(In.set(c.position,0,0,0),In.copy(c.velocity,mre)),r._textureAnimationModule&&r._textureAnimationModule.enable&&r._textureAnimationModule.init(c);var u=r.startSpeed.evaluate(a,l);In.multiplyScalar(c.velocity,c.velocity,u),r.simulationSpace===are.World&&(In.transformMat4(c.position,c.position,nde),In.transformQuat(c.velocity,c.velocity,ide)),In.copy(c.ultimateVelocity,c.velocity),In.set(c.rotation,0,0,0),r.startSize3D?In.set(c.startSize,r.startSizeX.evaluate(a,l),r.startSizeY.evaluate(a,l),r.startSizeZ.evaluate(a,l)):(In.set(c.startSize,r.startSizeX.evaluate(a,l),1,1),c.startSize.y=c.startSize.x),In.copy(c.size,c.startSize),c.startLifetime=r.startLifetime.evaluate(a,l)+t,c.remainingLifetime=c.startLifetime,i.push(c)}},t._updateParticles=function(e,t){var n=this,i=this._particleSystem;switch(i.node.getWorldMatrix(nde),i.scaleSpace){case are.Local:i.node.getScale(rde);break;case are.World:i.node.getWorldScale(rde)}if(this._updateList.forEach((function(e){e.update(i.simulationSpace,nde)})),i.simulationSpace===are.Local){var r=i.node.getRotation();jn.fromQuat(this._localMat,r),this._localMat.transpose()}for(var o=function(r){var o=t[r];if(o.remainingLifetime-=e,In.set(o.animatedVelocity,0,0,0),i.simulationSpace===are.Local){var a=9.8*-i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,vn(o.randomSeed))*e;n._gravity.x=0,n._gravity.y=a,n._gravity.z=0,n._gravity.w=1,n._gravity=n._gravity.transformMat4(n._localMat),o.velocity.x+=n._gravity.x,o.velocity.y+=n._gravity.y,o.velocity.z+=n._gravity.z}else o.velocity.y-=9.8*i.gravityModifier.evaluate(1-o.remainingLifetime/o.startLifetime,vn(o.randomSeed))*e;In.copy(o.ultimateVelocity,o.velocity),n._runAnimateList.forEach((function(t){t.animate(o,e)})),In.scaleAndAdd(o.position,o.position,o.ultimateVelocity,e)},a=0;a<t.length;++a)o(a)},t._calculateBounding=function(e){var t=new In,n=new In,i=new In,r=new In,o=new In(1,1,1);if(this._processor.getInfo().renderMode===lre.Mesh){var a=this._processor.getInfo().mesh;if(a&&a.struct.minPosition&&a.struct.maxPosition){var s=new Xs;Xs.fromPoints(s,a.struct.minPosition,a.struct.maxPosition);var c=Math.max(s.halfExtents.x,s.halfExtents.y,s.halfExtents.z);o.set(c,c,c)}}for(var l=0;l<this._particlesAll.length;++l){var u=this._particlesAll[l];In.multiply(t,rde,u.size),In.multiply(t,t,o),n.set(u.position),this._particleSystem.simulationSpace!==are.World&&In.transformMat4(n,n,this._particleSystem.node._mat),e&&0===l?(In.subtract(this.minPos,n,t),In.add(this.maxPos,n,t)):(In.subtract(i,n,t),In.add(r,n,t),In.min(this.minPos,this.minPos,i),In.max(this.maxPos,this.maxPos,r))}},t.calculatePositions=function(){this._emit(this._particleSystem.capacity,0,this._particlesAll);var e=vn(mn(0,n));this._updateParticles(0,this._particlesAll),this._calculateBounding(!0),this._updateParticles(this._particleSystem.startLifetime.evaluate(0,e),this._particlesAll),this._calculateBounding(!1),this._updateBoundingNode()},t.clear=function(){this._particlesAll.length=0},t.destroy=function(){},e}(),sde=new jn,cde=new Fn,lde=Object.getOwnPropertyDescriptor(dF.prototype,"sharedMaterials"),ude=function(t){return e({ParticleSystem:t,ParticleSystemComponent:t}),t}((She=mc("cc.ParticleSystem"),The=Oc(),bhe=Pc(),Ehe=gc(99),Che=zc(),Ahe=Vc(),whe=Fc(),Phe=Zc(_ie),Rhe=Vc(),Ihe=Fc(),Dhe=Zc(are),Ohe=Vc(),Mhe=Fc(),Nhe=Vc(),Lhe=Fc(),Bhe=bc("startSize"),Fhe=zc(),zhe=Zc(rne),Uhe=Vc(),khe=Fc(),Ghe=Zc(rne),Hhe=zc(),Vhe=Vc(),Whe=Fc(),jhe=Zc(rne),qhe=zc(),Xhe=Vc(),Yhe=Fc(),Khe=Zc(rne),Qhe=zc(),Zhe=Vc(),Jhe=Fc(),$he=Vc(),efe=Fc(),tfe=Zc(rne),nfe=zc(),ife=Vc(),rfe=Fc(),ofe=Zc(rne),afe=zc(),sfe=Vc(),cfe=Fc(),lfe=Zc(rne),ufe=bc("startRotation"),hfe=zc(),ffe=Vc(),_fe=Fc(),pfe=Zc(rne),dfe=zc(),mfe=Vc(),vfe=Fc(),gfe=Zc(rne),yfe=zc(),xfe=Vc(),Sfe=Fc(),Tfe=Vc(),bfe=Fc(),Efe=Vc(),Cfe=Fc(),Afe=Vc(),wfe=Fc(),Pfe=Zc(are),Rfe=Vc(),Ife=Fc(),Dfe=Vc(),Ofe=Fc(),Mfe=Vc(),Nfe=Fc(),Lfe=Zc(rne),Bfe=zc(),Ffe=Vc(),zfe=Fc(),Ufe=Zc(rne),kfe=zc(),Gfe=Vc(),Hfe=Fc(),Vfe=Zc(rne),Wfe=zc(),jfe=Vc(),qfe=Fc(),Xfe=Zc([_le]),Yfe=Vc(),Kfe=Fc(),Qfe=Zc(Boolean),Zfe=Vc(),Jfe=Fc(),$fe=Zc(sre),e_e=Vc(),t_e=Fc(),n_e=Zc(Number),i_e=Vc(),r_e=Fc(),o_e=Zc(Number),a_e=Vc(),s_e=Fc(),c_e=Zc(Number),l_e=Vc(),u_e=Fc(),h_e=Vc(),f_e=Fc(),__e=bc("enableCulling"),p_e=Nc(),d_e=Zc(ug),m_e=Bc(),v_e=Zc(dre),g_e=Zc(dre),y_e=Vc(),x_e=Fc(),S_e=Zc(vle),T_e=Zc(vle),b_e=Vc(),E_e=Fc(),C_e=Zc(ole),A_e=Zc(ole),w_e=Vc(),P_e=Fc(),R_e=Zc(fle),I_e=Zc(fle),D_e=Vc(),O_e=Fc(),M_e=Zc(Ooe),N_e=Zc(Ooe),L_e=Vc(),B_e=Fc(),F_e=Zc(Boe),z_e=Zc(Boe),U_e=Vc(),k_e=Fc(),G_e=Zc(rle),H_e=Zc(rle),V_e=Vc(),W_e=Fc(),j_e=Zc(lle),q_e=Zc(lle),X_e=Vc(),Y_e=Fc(),K_e=Zc(tde),Q_e=Zc(tde),Z_e=Vc(),J_e=Fc(),$_e=Zc(qpe),epe=Vc(),tpe=Fc(),She(npe=The(npe=bhe(npe=Ehe(npe=wc((jpe=Wpe=function(e){function t(){var t;return ce(t=e.call(this)||this,"startColor",rpe,oe(t)),ce(t,"scaleSpace",ope,oe(t)),ce(t,"startSize3D",ape,oe(t)),ce(t,"startSizeX",spe,oe(t)),ce(t,"startSizeY",cpe,oe(t)),ce(t,"startSizeZ",lpe,oe(t)),ce(t,"startSpeed",upe,oe(t)),ce(t,"startRotation3D",hpe,oe(t)),ce(t,"startRotationX",fpe,oe(t)),ce(t,"startRotationY",_pe,oe(t)),ce(t,"startRotationZ",ppe,oe(t)),ce(t,"startDelay",dpe,oe(t)),ce(t,"startLifetime",mpe,oe(t)),ce(t,"duration",vpe,oe(t)),ce(t,"loop",gpe,oe(t)),ce(t,"simulationSpeed",ype,oe(t)),ce(t,"playOnAwake",xpe,oe(t)),ce(t,"gravityModifier",Spe,oe(t)),ce(t,"rateOverTime",Tpe,oe(t)),ce(t,"rateOverDistance",bpe,oe(t)),ce(t,"bursts",Epe,oe(t)),ce(t,"_renderCulling",Cpe,oe(t)),ce(t,"_cullingMode",Ape,oe(t)),ce(t,"_aabbHalfX",wpe,oe(t)),ce(t,"_aabbHalfY",Ppe,oe(t)),ce(t,"_aabbHalfZ",Rpe,oe(t)),ce(t,"_dataCulling",Ipe,oe(t)),ce(t,"_colorOverLifetimeModule",Dpe,oe(t)),ce(t,"_shapeModule",Ope,oe(t)),ce(t,"_sizeOvertimeModule",Mpe,oe(t)),ce(t,"_velocityOvertimeModule",Npe,oe(t)),ce(t,"_forceOvertimeModule",Lpe,oe(t)),ce(t,"_limitVelocityOvertimeModule",Bpe,oe(t)),ce(t,"_rotationOvertimeModule",Fpe,oe(t)),ce(t,"_textureAnimationModule",zpe,oe(t)),ce(t,"_trailModule",Upe,oe(t)),ce(t,"renderer",kpe,oe(t)),t._isPlaying=void 0,t._isPaused=void 0,t._isStopped=void 0,t._isEmitting=void 0,t._needRefresh=void 0,t._time=void 0,t._emitRateTimeCounter=void 0,t._emitRateDistanceCounter=void 0,t._oldWPos=void 0,t._curWPos=void 0,t._boundingBox=void 0,t._culler=void 0,t._oldPos=void 0,t._curPos=void 0,t._isCulled=void 0,t._isSimulating=void 0,t._customData1=void 0,t._customData2=void 0,t._subEmitters=void 0,ce(t,"_prewarm",Gpe,oe(t)),ce(t,"_capacity",Hpe,oe(t)),ce(t,"_simulationSpace",Vpe,oe(t)),t.processor=null,t.rateOverTime.constant=10,t.startLifetime.constant=5,t.startSizeX.constant=1,t.startSpeed.constant=5,t._isPlaying=!1,t._isPaused=!1,t._isStopped=!0,t._isEmitting=!1,t._needRefresh=!0,t._time=0,t._emitRateTimeCounter=0,t._emitRateDistanceCounter=0,t._oldWPos=new In,t._curWPos=new In,t._boundingBox=null,t._culler=null,t._oldPos=null,t._curPos=null,t._isCulled=!1,t._isSimulating=!0,t._customData1=new Kn,t._customData2=new Kn,t._subEmitters=[],t}$(t,e);var i=t.prototype;return i.onFocusInEditor=function(){this.renderer.create(this)},i.onLoad=function(){this.renderer.onInit(this),this._shapeModule&&this._shapeModule.onInit(this),this._trailModule&&this._trailModule.onInit(this),this.bindModule(),this._resetPosition()},i._onMaterialModified=function(e,t){null!==this.processor&&this.processor.onMaterialModified(e,t)},i._onRebuildPSO=function(e,t){this.processor.onRebuildPSO(e,t)},i._collectModels=function(){return this._models.length=0,this._models.push(this.processor._model),this._trailModule&&this._trailModule.enable&&this._trailModule._trailModel&&this._models.push(this._trailModule._trailModel),this._models},i._attachToScene=function(){this.processor.attachToScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._attachToScene()},i._detachFromScene=function(){this.processor.detachFromScene(),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.bindModule=function(){this._colorOverLifetimeModule&&this._colorOverLifetimeModule.bindTarget(this.processor),this._sizeOvertimeModule&&this._sizeOvertimeModule.bindTarget(this.processor),this._rotationOvertimeModule&&this._rotationOvertimeModule.bindTarget(this.processor),this._forceOvertimeModule&&this._forceOvertimeModule.bindTarget(this.processor),this._limitVelocityOvertimeModule&&this._limitVelocityOvertimeModule.bindTarget(this.processor),this._velocityOvertimeModule&&this._velocityOvertimeModule.bindTarget(this.processor),this._textureAnimationModule&&this._textureAnimationModule.bindTarget(this.processor)},i.play=function(){if(this._isPaused&&(this._isPaused=!1),this._isStopped&&(this._isStopped=!1),this._isPlaying=!0,this._isEmitting=!0,this._resetPosition(),this._prewarm&&this._prewarmSystem(),this._trailModule&&this._trailModule.play(),this.processor){var e=this.processor.getModel();e&&(e.enabled=this.enabledInHierarchy)}},i.pause=function(){this._isStopped?console.warn("pause(): particle system is already stopped."):(this._isPlaying&&(this._isPlaying=!1),this._isPaused=!0)},i.stop=function(){(this._isPlaying||this._isPaused)&&this.clear(),this._isPlaying&&(this._isPlaying=!1),this._isPaused&&(this._isPaused=!1),this._time=0,this._emitRateTimeCounter=0,this._emitRateDistanceCounter=0,this._isStopped=!0,this._needRefresh=!0;for(var e,t=se(this.bursts);!(e=t()).done;)e.value.reset()},i.clear=function(){this.enabledInHierarchy&&(this.processor.clear(),this._trailModule&&this._trailModule.clear()),this._calculateBounding(!1)},i.getParticleCount=function(){return this.processor.getParticleCount()},i.setCustomData1=function(e,t){Kn.set(this._customData1,e,t)},i.setCustomData2=function(e,t){Kn.set(this._customData2,e,t)},i.onDestroy=function(){u.director.off(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDestroy(),this._trailModule&&this._trailModule.destroy(),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i.onEnable=function(){u.director.on(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.playOnAwake&&this.play(),this.processor.onEnable(),this._trailModule&&this._trailModule.onEnable()},i.onDisable=function(){u.director.off(u.Director.EVENT_BEFORE_COMMIT,this.beforeRender,this),this.processor.onDisable(),this._trailModule&&this._trailModule.onDisable(),this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null)},i._calculateBounding=function(e){this._boundingBox&&(this._culler||(this._culler=new ade(this)),this._culler.calculatePositions(),Xs.fromPoints(this._boundingBox,this._culler.minPos,this._culler.maxPos),e?(this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ=this._boundingBox.halfExtents.z):(this.aabbHalfX?this.setBoundingX(this.aabbHalfX):this.aabbHalfX=this._boundingBox.halfExtents.x,this.aabbHalfY?this.setBoundingY(this.aabbHalfY):this.aabbHalfY=this._boundingBox.halfExtents.y,this.aabbHalfZ?this.setBoundingZ(this.aabbHalfZ):this.aabbHalfZ=this._boundingBox.halfExtents.z),this._culler.clear())},i.update=function(e){var t=e*this.simulationSpeed;if(this.renderCulling){var n;if(this._boundingBox||(this._boundingBox=new Xs,this._calculateBounding(!1)),this._curPos||(this._curPos=new In),this.node.getWorldPosition(this._curPos),this._oldPos||(this._oldPos=new In,this._oldPos.set(this._curPos)),!this._curPos.equals(this._oldPos)&&this._boundingBox&&this._culler){var i=this._curPos.x-this._oldPos.x,r=this._curPos.y-this._oldPos.y,o=this._curPos.z-this._oldPos.z,a=this._boundingBox.center;a.x+=i,a.y+=r,a.z+=o,this._culler.setBoundingBoxCenter(a.x,a.y,a.z),this._oldPos.set(this._curPos)}var s=null===(n=this.node.scene.renderScene)||void 0===n?void 0:n.cameras,c=!0;if(void 0!==s&&this._boundingBox)for(var l=0;l<s.length;++l){var u=s[l];if((u.visibility&this.node.layer)===this.node.layer&&_s.aabbFrustum(this._boundingBox,u.frustum)){c=!1;break}}if(c){if(this._cullingMode!==sre.AlwaysSimulate&&(this._isSimulating=!1),this._isCulled||(this.processor.detachFromScene(),this._isCulled=!0),this._trailModule&&this._trailModule.enable&&this._trailModule._detachFromScene(),this._cullingMode===sre.PauseAndCatchup&&(this._time+=t),this._cullingMode!==sre.AlwaysSimulate)return}else this._isCulled&&(this._attachToScene(),this._isCulled=!1),this._isSimulating||(this._isSimulating=!0);if(!this._isSimulating)return}else this._boundingBox&&(this._boundingBox=null),this._culler&&(this._culler.clear(),this._culler.destroy(),this._culler=null),this._isSimulating=!0;if(this._isPlaying)this._time+=t,this._emit(t),0!==this.processor.updateParticles(t)||this._isEmitting||this.stop();else{var h=(this.getMaterialInstance(0)||this.processor.getDefaultMaterial()).passes[0];this.processor.updateRotation(h),this.processor.updateScale(h)}this.processor.updateRenderData(),this._trailModule&&this._trailModule.enable&&this._trailModule.updateRenderData()},i.beforeRender=function(){this._isPlaying&&(this.processor.beforeRender(),this._trailModule&&this._trailModule.enable&&this._trailModule.beforeRender())},i._onVisibilityChange=function(e){this.processor._model&&(this.processor._model.visFlags=e)},i.emit=function(e,t){var i=this._time%this.duration/this.duration;this._needRefresh&&(this.node.invalidateChildren(oy.POSITION),this._needRefresh=!1),this._simulationSpace===are.World&&(this.node.getWorldMatrix(sde),this.node.getWorldRotation(cde));for(var r=0;r<e;++r){var o=this.processor.getFreeParticle();if(null===o)return;o.particleSystem=this,o.reset();var a=vn(mn(0,n));this._shapeModule&&this._shapeModule.enable?this._shapeModule.emit(o):(In.set(o.position,0,0,0),In.copy(o.velocity,mre)),this._textureAnimationModule&&this._textureAnimationModule.enable&&this._textureAnimationModule.init(o);var s=this.startSpeed.evaluate(i,a);In.multiplyScalar(o.velocity,o.velocity,s),this._simulationSpace===are.World&&(In.transformMat4(o.position,o.position,sde),In.transformQuat(o.velocity,o.velocity,cde)),In.copy(o.ultimateVelocity,o.velocity),this.startRotation3D?o.startEuler.set(this.startRotationX.evaluate(i,a),this.startRotationY.evaluate(i,a),this.startRotationZ.evaluate(i,a)):o.startEuler.set(0,0,this.startRotationZ.evaluate(i,a)),o.rotation.set(o.startEuler),this.startSize3D?In.set(o.startSize,this.startSizeX.evaluate(i,a),this.startSizeY.evaluate(i,a),this.startSizeZ.evaluate(i,a)):(In.set(o.startSize,this.startSizeX.evaluate(i,a),1,1),o.startSize.y=o.startSize.x),In.copy(o.size,o.startSize),o.startColor.set(this.startColor.evaluate(i,a)),o.color.set(o.startColor),o.startLifetime=this.startLifetime.evaluate(i,a)+t,o.remainingLifetime=o.startLifetime,o.randomSeed=mn(0,233280),o.loopCount++,this.processor.setNewParticle(o)}},i._prewarmSystem=function(){this.startDelay.mode=ine.Constant,this.startDelay.constant=0;for(var e=this.duration/1,t=0;t<e;++t)this._time+=1,this._emit(1),this.processor.updateParticles(1)},i._emit=function(e){var t=this.startDelay.evaluate(0,1);if(this._time>t){if(this._time>this.duration+t&&!this.loop)return void(this._isEmitting=!1);if(this._emitRateTimeCounter+=this.rateOverTime.evaluate(this._time/this.duration,1)*e,this._emitRateTimeCounter>1&&this._isEmitting){var n=Math.floor(this._emitRateTimeCounter);this._emitRateTimeCounter-=n,this.emit(n,e)}this.node.getWorldPosition(this._curWPos);var i=In.distance(this._curWPos,this._oldWPos);if(In.copy(this._oldWPos,this._curWPos),this._emitRateDistanceCounter+=i*this.rateOverDistance.evaluate(this._time/this.duration,1),this._emitRateDistanceCounter>1&&this._isEmitting){var r=Math.floor(this._emitRateDistanceCounter);this._emitRateDistanceCounter-=r,this.emit(r,e)}for(var o,a=se(this.bursts);!(o=a()).done;)o.value.update(this,e)}},i._resetPosition=function(){this.node.getWorldPosition(this._oldWPos),In.copy(this._curWPos,this._oldWPos)},i.addSubEmitter=function(e){this._subEmitters.push(e)},i.removeSubEmitter=function(e){this._subEmitters.splice(this._subEmitters.indexOf(e),1)},i.addBurst=function(e){this.bursts.push(e)},i.removeBurst=function(e){this.bursts.splice(this.bursts.indexOf(e),1)},i.getBoundingX=function(){return this._aabbHalfX},i.getBoundingY=function(){return this._aabbHalfY},i.getBoundingZ=function(){return this._aabbHalfZ},i.setBoundingX=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.x=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfX=e)},i.setBoundingY=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.y=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfY=e)},i.setBoundingZ=function(e){this._boundingBox&&this._culler&&(this._boundingBox.halfExtents.z=e,this._culler.setBoundingBoxSize(this._boundingBox.halfExtents),this._aabbHalfZ=e)},i._onBeforeSerialize=function(e){var t=this;return this.dataCulling?e.filter((function(e){return!rre.includes(e)||t[e]&&t[e].enable})):e},Z(t,[{key:"capacity",get:function(){return this._capacity},set:function(e){this._capacity=Math.floor(e>0?e:0),this.processor&&this.processor._model&&this.processor._model.setCapacity(this._capacity)}},{key:"prewarm",get:function(){return this._prewarm},set:function(e){!0===e&&this.loop,this._prewarm=e}},{key:"simulationSpace",get:function(){return this._simulationSpace},set:function(e){e!==this._simulationSpace&&(this._simulationSpace=e,this.processor&&(this.processor.updateMaterialParams(),this.processor.updateTrailMaterial()))}},{key:"renderCulling",get:function(){return this._renderCulling},set:function(e){this._renderCulling=e,e&&(this._boundingBox||(this._boundingBox=new Xs,this._calculateBounding(!1)))}},{key:"cullingMode",get:function(){return this._cullingMode},set:function(e){this._cullingMode=e}},{key:"aabbHalfX",get:function(){return this.getBoundingX()||0},set:function(e){this.setBoundingX(e)}},{key:"aabbHalfY",get:function(){return this.getBoundingY()||0},set:function(e){this.setBoundingY(e)}},{key:"aabbHalfZ",get:function(){return this.getBoundingZ()||0},set:function(e){this.setBoundingZ(e)}},{key:"dataCulling",get:function(){return this._dataCulling},set:function(e){this._dataCulling=e}},{key:"sharedMaterials",get:function(){return lde.get.call(this)},set:function(e){lde.set.call(this,e)}},{key:"colorOverLifetimeModule",get:function(){return this._colorOverLifetimeModule},set:function(e){e&&(this._colorOverLifetimeModule=e)}},{key:"shapeModule",get:function(){return this._shapeModule},set:function(e){e&&(this._shapeModule=e)}},{key:"sizeOvertimeModule",get:function(){return this._sizeOvertimeModule},set:function(e){e&&(this._sizeOvertimeModule=e)}},{key:"velocityOvertimeModule",get:function(){return this._velocityOvertimeModule},set:function(e){e&&(this._velocityOvertimeModule=e)}},{key:"forceOvertimeModule",get:function(){return this._forceOvertimeModule},set:function(e){e&&(this._forceOvertimeModule=e)}},{key:"limitVelocityOvertimeModule",get:function(){return this._limitVelocityOvertimeModule},set:function(e){e&&(this._limitVelocityOvertimeModule=e)}},{key:"rotationOvertimeModule",get:function(){return this._rotationOvertimeModule},set:function(e){e&&(this._rotationOvertimeModule=e)}},{key:"textureAnimationModule",get:function(){return this._textureAnimationModule},set:function(e){e&&(this._textureAnimationModule=e)}},{key:"trailModule",get:function(){return this._trailModule},set:function(e){e&&(this._trailModule=e)}},{key:"isPlaying",get:function(){return this._isPlaying}},{key:"isPaused",get:function(){return this._isPaused}},{key:"isStopped",get:function(){return this._isStopped}},{key:"isEmitting",get:function(){return this._isEmitting}},{key:"time",get:function(){return this._time}}]),t}(dF),Wpe.CullingMode=sre,le((ipe=jpe).prototype,"capacity",[Che,Ahe,whe],Object.getOwnPropertyDescriptor(ipe.prototype,"capacity"),ipe.prototype),rpe=le(ipe.prototype,"startColor",[Phe,Tc,Rhe,Ihe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new _ie}}),ope=le(ipe.prototype,"scaleSpace",[Dhe,Tc,Ohe,Mhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.Local}}),ape=le(ipe.prototype,"startSize3D",[Tc,Nhe,Lhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),spe=le(ipe.prototype,"startSizeX",[Bhe,Fhe,zhe,Uhe,khe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),cpe=le(ipe.prototype,"startSizeY",[Ghe,Tc,Hhe,Vhe,Whe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),lpe=le(ipe.prototype,"startSizeZ",[jhe,Tc,qhe,Xhe,Yhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),upe=le(ipe.prototype,"startSpeed",[Khe,Tc,Qhe,Zhe,Jhe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),hpe=le(ipe.prototype,"startRotation3D",[Tc,$he,efe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),fpe=le(ipe.prototype,"startRotationX",[tfe,Tc,nfe,Wc,ife,rfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),_pe=le(ipe.prototype,"startRotationY",[ofe,Tc,afe,Wc,sfe,cfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),ppe=le(ipe.prototype,"startRotationZ",[lfe,ufe,hfe,Wc,ffe,_fe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),dpe=le(ipe.prototype,"startDelay",[pfe,Tc,dfe,mfe,vfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),mpe=le(ipe.prototype,"startLifetime",[gfe,Tc,yfe,xfe,Sfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),vpe=le(ipe.prototype,"duration",[Tc,Tfe,bfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 5}}),gpe=le(ipe.prototype,"loop",[Tc,Efe,Cfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le(ipe.prototype,"prewarm",[Afe,wfe],Object.getOwnPropertyDescriptor(ipe.prototype,"prewarm"),ipe.prototype),le(ipe.prototype,"simulationSpace",[Pfe,Tc,Rfe,Ife],Object.getOwnPropertyDescriptor(ipe.prototype,"simulationSpace"),ipe.prototype),ype=le(ipe.prototype,"simulationSpeed",[Tc,Dfe,Ofe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),xpe=le(ipe.prototype,"playOnAwake",[Tc,Mfe,Nfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Spe=le(ipe.prototype,"gravityModifier",[Lfe,Tc,Bfe,Ffe,zfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Tpe=le(ipe.prototype,"rateOverTime",[Ufe,Tc,kfe,Gfe,Hfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),bpe=le(ipe.prototype,"rateOverDistance",[Vfe,Tc,Wfe,jfe,qfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new rne}}),Epe=le(ipe.prototype,"bursts",[Xfe,Tc,Yfe,Kfe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),le(ipe.prototype,"renderCulling",[Qfe,Zfe,Jfe],Object.getOwnPropertyDescriptor(ipe.prototype,"renderCulling"),ipe.prototype),Cpe=le(ipe.prototype,"_renderCulling",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(ipe.prototype,"cullingMode",[$fe,e_e,t_e],Object.getOwnPropertyDescriptor(ipe.prototype,"cullingMode"),ipe.prototype),Ape=le(ipe.prototype,"_cullingMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return sre.Pause}}),le(ipe.prototype,"aabbHalfX",[n_e,i_e,r_e],Object.getOwnPropertyDescriptor(ipe.prototype,"aabbHalfX"),ipe.prototype),wpe=le(ipe.prototype,"_aabbHalfX",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(ipe.prototype,"aabbHalfY",[o_e,a_e,s_e],Object.getOwnPropertyDescriptor(ipe.prototype,"aabbHalfY"),ipe.prototype),Ppe=le(ipe.prototype,"_aabbHalfY",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(ipe.prototype,"aabbHalfZ",[c_e,l_e,u_e],Object.getOwnPropertyDescriptor(ipe.prototype,"aabbHalfZ"),ipe.prototype),Rpe=le(ipe.prototype,"_aabbHalfZ",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(ipe.prototype,"dataCulling",[h_e,f_e],Object.getOwnPropertyDescriptor(ipe.prototype,"dataCulling"),ipe.prototype),Ipe=le(ipe.prototype,"_dataCulling",[Tc,__e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(ipe.prototype,"sharedMaterials",[sl,p_e,d_e,Tc,m_e],Object.getOwnPropertyDescriptor(ipe.prototype,"sharedMaterials"),ipe.prototype),Dpe=le(ipe.prototype,"_colorOverLifetimeModule",[v_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"colorOverLifetimeModule",[g_e,y_e,x_e],Object.getOwnPropertyDescriptor(ipe.prototype,"colorOverLifetimeModule"),ipe.prototype),Ope=le(ipe.prototype,"_shapeModule",[S_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"shapeModule",[T_e,b_e,E_e],Object.getOwnPropertyDescriptor(ipe.prototype,"shapeModule"),ipe.prototype),Mpe=le(ipe.prototype,"_sizeOvertimeModule",[C_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"sizeOvertimeModule",[A_e,w_e,P_e],Object.getOwnPropertyDescriptor(ipe.prototype,"sizeOvertimeModule"),ipe.prototype),Npe=le(ipe.prototype,"_velocityOvertimeModule",[R_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"velocityOvertimeModule",[I_e,D_e,O_e],Object.getOwnPropertyDescriptor(ipe.prototype,"velocityOvertimeModule"),ipe.prototype),Lpe=le(ipe.prototype,"_forceOvertimeModule",[M_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"forceOvertimeModule",[N_e,L_e,B_e],Object.getOwnPropertyDescriptor(ipe.prototype,"forceOvertimeModule"),ipe.prototype),Bpe=le(ipe.prototype,"_limitVelocityOvertimeModule",[F_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"limitVelocityOvertimeModule",[z_e,U_e,k_e],Object.getOwnPropertyDescriptor(ipe.prototype,"limitVelocityOvertimeModule"),ipe.prototype),Fpe=le(ipe.prototype,"_rotationOvertimeModule",[G_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"rotationOvertimeModule",[H_e,V_e,W_e],Object.getOwnPropertyDescriptor(ipe.prototype,"rotationOvertimeModule"),ipe.prototype),zpe=le(ipe.prototype,"_textureAnimationModule",[j_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"textureAnimationModule",[q_e,X_e,Y_e],Object.getOwnPropertyDescriptor(ipe.prototype,"textureAnimationModule"),ipe.prototype),Upe=le(ipe.prototype,"_trailModule",[K_e],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),le(ipe.prototype,"trailModule",[Q_e,Z_e,J_e],Object.getOwnPropertyDescriptor(ipe.prototype,"trailModule"),ipe.prototype),kpe=le(ipe.prototype,"renderer",[$_e,Tc,epe,tpe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new qpe}}),Gpe=le(ipe.prototype,"_prewarm",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Hpe=le(ipe.prototype,"_capacity",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),Vpe=le(ipe.prototype,"_simulationSpace",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return are.Local}}),npe=ipe))||npe)||npe)||npe)||npe)||npe)),hde=e("ParticleUtils",function(){function e(){}return e.instantiate=function(e){return this.registeredSceneEvent||(jM.on(WM.EVENT_BEFORE_SCENE_LAUNCH,this.onSceneUnload,this),this.registeredSceneEvent=!0),this.particleSystemPool.has(e._uuid)||this.particleSystemPool.set(e._uuid,new ql((function(){return tf(e)||new qC}),1,(function(e){return e.destroy()}))),this.particleSystemPool.get(e._uuid).alloc()},e.destroy=function(e){this.particleSystemPool.has(e._prefab.asset._uuid)&&(this.stop(e),this.particleSystemPool.get(e._prefab.asset._uuid).free(e))},e.play=function(e){for(var t,n=se(e.getComponentsInChildren(ude));!(t=n()).done;)t.value.play()},e.stop=function(e){for(var t,n=se(e.getComponentsInChildren(ude));!(t=n()).done;)t.value.stop()},e.onSceneUnload=function(){this.particleSystemPool.forEach((function(e){return e.destroy()})),this.particleSystemPool.clear()},e}());function fde(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}hde.particleSystemPool=new Map,hde.registeredSceneEvent=!1,G(_le.prototype,"Burst.prototype",[{name:"minCount"},{name:"maxCount"}]),k(ude.prototype,"ParticleSystem.prototype",[{name:"enableCulling",newName:"dataCulling"}]),u.ParticleSystemComponent=ude,rt.setClassAlias(ude,"cc.ParticleSystemComponent"),u.BillboardComponent=Zte,rt.setClassAlias(Zte,"cc.BillboardComponent"),u.LineComponent=vie,rt.setClassAlias(vie,"cc.LineComponent"),u.ParticleUtils=hde;var _de,pde,dde,mde,vde,gde,yde,xde=function(e,t){return function(e){e.exports=function e(t,n,i){function r(a,s){if(!n[a]){if(!t[a]){if(!s&&fde)return fde();if(o)return o(a,!0);throw new Error("Cannot find module '"+a+"'")}var c=n[a]={exports:{}};t[a][0].call(c.exports,(function(e){return r(t[a][1][e]||e)}),c,c.exports,e,t,n,i)}return n[a].exports}for(var o=fde,a=0;a<i.length;a++)r(i[a]);return r}({1:[function(e,t){t.exports={name:"@cocos/cannon",version:"1.2.8",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/cocos-creator/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se), JayceLai",keywords:["cannon.js","cocos","creator","physics","engine","3d"],scripts:{build:"grunt && npm run preprocess && grunt addLicense && grunt addDate",preprocess:"node node_modules/uglify-js/bin/uglifyjs build/cannon.js -o build/cannon.min.js -c -m",postpublish:"cnpm sync @cocos/cannon"},main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/cocos-creator/cannon.js.git"},bugs:{url:"https://github.com/cocos-creator/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(e,t){t.exports={version:e("../package.json").version,AABB:e("./collision/AABB"),ArrayCollisionMatrix:e("./collision/ArrayCollisionMatrix"),Body:e("./objects/Body"),Box:e("./shapes/Box"),Broadphase:e("./collision/Broadphase"),Constraint:e("./constraints/Constraint"),ContactEquation:e("./equations/ContactEquation"),Narrowphase:e("./world/Narrowphase"),ConeTwistConstraint:e("./constraints/ConeTwistConstraint"),ContactMaterial:e("./material/ContactMaterial"),ConvexPolyhedron:e("./shapes/ConvexPolyhedron"),Cylinder:e("./shapes/Cylinder"),DistanceConstraint:e("./constraints/DistanceConstraint"),Equation:e("./equations/Equation"),EventTarget:e("./utils/EventTarget"),FrictionEquation:e("./equations/FrictionEquation"),GSSolver:e("./solver/GSSolver"),GridBroadphase:e("./collision/GridBroadphase"),Heightfield:e("./shapes/Heightfield"),HingeConstraint:e("./constraints/HingeConstraint"),LockConstraint:e("./constraints/LockConstraint"),Mat3:e("./math/Mat3"),Material:e("./material/Material"),NaiveBroadphase:e("./collision/NaiveBroadphase"),ObjectCollisionMatrix:e("./collision/ObjectCollisionMatrix"),Pool:e("./utils/Pool"),Particle:e("./shapes/Particle"),Plane:e("./shapes/Plane"),PointToPointConstraint:e("./constraints/PointToPointConstraint"),Quaternion:e("./math/Quaternion"),Ray:e("./collision/Ray"),RaycastVehicle:e("./objects/RaycastVehicle"),RaycastResult:e("./collision/RaycastResult"),RigidVehicle:e("./objects/RigidVehicle"),RotationalEquation:e("./equations/RotationalEquation"),RotationalMotorEquation:e("./equations/RotationalMotorEquation"),SAPBroadphase:e("./collision/SAPBroadphase"),SPHSystem:e("./objects/SPHSystem"),Shape:e("./shapes/Shape"),Solver:e("./solver/Solver"),Sphere:e("./shapes/Sphere"),SplitSolver:e("./solver/SplitSolver"),Spring:e("./objects/Spring"),Transform:e("./math/Transform"),Trimesh:e("./shapes/Trimesh"),Vec3:e("./math/Vec3"),Vec3Pool:e("./utils/Vec3Pool"),World:e("./world/World"),Octree:e("./utils/Octree")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":10,"./collision/RaycastResult":11,"./collision/SAPBroadphase":12,"./constraints/ConeTwistConstraint":13,"./constraints/Constraint":14,"./constraints/DistanceConstraint":15,"./constraints/HingeConstraint":16,"./constraints/LockConstraint":17,"./constraints/PointToPointConstraint":18,"./equations/ContactEquation":20,"./equations/Equation":21,"./equations/FrictionEquation":22,"./equations/RotationalEquation":23,"./equations/RotationalMotorEquation":24,"./material/ContactMaterial":25,"./material/Material":26,"./math/Mat3":28,"./math/Quaternion":29,"./math/Transform":30,"./math/Vec3":31,"./objects/Body":32,"./objects/RaycastVehicle":33,"./objects/RigidVehicle":34,"./objects/SPHSystem":35,"./objects/Spring":36,"./shapes/Box":38,"./shapes/ConvexPolyhedron":39,"./shapes/Cylinder":40,"./shapes/Heightfield":41,"./shapes/Particle":42,"./shapes/Plane":43,"./shapes/Shape":44,"./shapes/Sphere":45,"./shapes/Trimesh":46,"./solver/GSSolver":47,"./solver/Solver":48,"./solver/SplitSolver":49,"./utils/EventTarget":50,"./utils/Octree":51,"./utils/Pool":52,"./utils/Vec3Pool":55,"./world/Narrowphase":56,"./world/World":57}],3:[function(e,t){var n=e("../math/Vec3");function i(e){e=e||{},this.lowerBound=new n,e.lowerBound&&this.lowerBound.copy(e.lowerBound),this.upperBound=new n,e.upperBound&&this.upperBound.copy(e.upperBound)}e("../utils/Utils"),t.exports=i;var r=new n;i.prototype.setFromPoints=function(e,t,n,i){var o=this.lowerBound,a=this.upperBound,s=n;o.copy(e[0]),s&&s.vmult(o,o),a.copy(o);for(var c=1;c<e.length;c++){var l=e[c];s&&(s.vmult(l,r),l=r),l.x>a.x&&(a.x=l.x),l.x<o.x&&(o.x=l.x),l.y>a.y&&(a.y=l.y),l.y<o.y&&(o.y=l.y),l.z>a.z&&(a.z=l.z),l.z<o.z&&(o.z=l.z)}return t&&(t.vadd(o,o),t.vadd(a,a)),i&&(o.x-=i,o.y-=i,o.z-=i,a.x+=i,a.y+=i,a.z+=i),this},i.prototype.copy=function(e){return this.lowerBound.copy(e.lowerBound),this.upperBound.copy(e.upperBound),this},i.prototype.clone=function(){return(new i).copy(this)},i.prototype.extend=function(e){this.lowerBound.x=Math.min(this.lowerBound.x,e.lowerBound.x),this.upperBound.x=Math.max(this.upperBound.x,e.upperBound.x),this.lowerBound.y=Math.min(this.lowerBound.y,e.lowerBound.y),this.upperBound.y=Math.max(this.upperBound.y,e.upperBound.y),this.lowerBound.z=Math.min(this.lowerBound.z,e.lowerBound.z),this.upperBound.z=Math.max(this.upperBound.z,e.upperBound.z)},i.prototype.overlaps=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,r=e.upperBound,o=i.x<=n.x&&n.x<=r.x||t.x<=r.x&&r.x<=n.x,a=i.y<=n.y&&n.y<=r.y||t.y<=r.y&&r.y<=n.y,s=i.z<=n.z&&n.z<=r.z||t.z<=r.z&&r.z<=n.z;return o&&a&&s},i.prototype.volume=function(){var e=this.lowerBound,t=this.upperBound;return(t.x-e.x)*(t.y-e.y)*(t.z-e.z)},i.prototype.contains=function(e){var t=this.lowerBound,n=this.upperBound,i=e.lowerBound,r=e.upperBound;return t.x<=i.x&&n.x>=r.x&&t.y<=i.y&&n.y>=r.y&&t.z<=i.z&&n.z>=r.z},i.prototype.getCorners=function(e,t,n,i,r,o,a,s){var c=this.lowerBound,l=this.upperBound;e.copy(c),t.set(l.x,c.y,c.z),n.set(l.x,l.y,c.z),i.set(c.x,l.y,l.z),r.set(l.x,c.y,l.z),o.set(c.x,l.y,c.z),a.set(c.x,c.y,l.z),s.copy(l)};var o=[new n,new n,new n,new n,new n,new n,new n,new n];i.prototype.toLocalFrame=function(e,t){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var _=n[f];e.pointToLocal(_,_)}return t.setFromPoints(n)},i.prototype.toWorldFrame=function(e,t){var n=o,i=n[0],r=n[1],a=n[2],s=n[3],c=n[4],l=n[5],u=n[6],h=n[7];this.getCorners(i,r,a,s,c,l,u,h);for(var f=0;8!==f;f++){var _=n[f];e.pointToWorld(_,_)}return t.setFromPoints(n)},i.prototype.overlapsRay=function(e){var t=1/e._direction.x,n=1/e._direction.y,i=1/e._direction.z,r=(this.lowerBound.x-e.from.x)*t,o=(this.upperBound.x-e.from.x)*t,a=(this.lowerBound.y-e.from.y)*n,s=(this.upperBound.y-e.from.y)*n,c=(this.lowerBound.z-e.from.z)*i,l=(this.upperBound.z-e.from.z)*i,u=Math.max(Math.max(Math.min(r,o),Math.min(a,s)),Math.min(c,l)),h=Math.min(Math.min(Math.max(r,o),Math.max(a,s)),Math.max(c,l));return!(h<0||u>h)}},{"../math/Vec3":31,"../utils/Utils":54}],4:[function(e,t){function n(){this.matrix=[]}t.exports=n,n.prototype.get=function(e,t){if(e=e.index,(t=t.index)>e){var n=t;t=e,e=n}return this.matrix[(e*(e+1)>>1)+t-1]},n.prototype.set=function(e,t,n){if(e=e.index,(t=t.index)>e){var i=t;t=e,e=i}this.matrix[(e*(e+1)>>1)+t-1]=n?1:0},n.prototype.reset=function(){for(var e=0,t=this.matrix.length;e!==t;e++)this.matrix[e]=0},n.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(e,t){var n=e("../objects/Body"),i=e("../math/Vec3"),r=e("../math/Quaternion");function o(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}e("../shapes/Shape"),e("../shapes/Plane"),t.exports=o,o.prototype.collisionPairs=function(){throw new Error("collisionPairs not implemented for this BroadPhase class!")},o.prototype.needBroadphaseCollision=function(e,t){if(0==(e.collisionFilterGroup&t.collisionFilterMask)||0==(t.collisionFilterGroup&e.collisionFilterMask))return!1;var i=0!=(e.type&n.STATIC),r=0!=(t.type&n.STATIC);return!(i&&r||!e.hasTrigger&&!t.hasTrigger&&e.sleepState===n.SLEEPING&&t.sleepState===n.SLEEPING)},o.prototype.intersectionTest=function(e,t,n,i){this.useBoundingBoxes?this.doBoundingBoxBroadphase(e,t,n,i):this.doBoundingSphereBroadphase(e,t,n,i)};var a=new i;new i,new r,new i,o.prototype.doBoundingSphereBroadphase=function(e,t,n,i){var r=a;t.position.vsub(e.position,r);var o=Math.pow(e.boundingRadius+t.boundingRadius,2);r.norm2()<o&&(n.push(e),i.push(t))},o.prototype.doBoundingBoxBroadphase=function(e,t,n,i){e.aabbNeedsUpdate&&e.computeAABB(),t.aabbNeedsUpdate&&t.computeAABB(),e.aabb.overlaps(t.aabb)&&(n.push(e),i.push(t))};var s={keys:[]},c=[],l=[];o.prototype.makePairsUnique=function(e,t){for(var n=s,i=c,r=l,o=e.length,a=0;a!==o;a++)i[a]=e[a],r[a]=t[a];for(e.length=0,t.length=0,a=0;a!==o;a++){var u=i[a].id,h=r[a].id;n[f=u<h?u+","+h:h+","+u]=a,n.keys.push(f)}for(a=0;a!==n.keys.length;a++){var f=n.keys.pop(),_=n[f];e.push(i[_]),t.push(r[_]),delete n[f]}},o.prototype.setWorld=function(){};var u=new i;o.boundingSphereCheck=function(e,t){var n=u;return e.position.vsub(t.position,n),Math.pow(e.shape.boundingSphereRadius+t.shape.boundingSphereRadius,2)>n.norm2()},o.prototype.aabbQuery=function(){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Plane":43,"../shapes/Shape":44}],6:[function(e,t){t.exports=o;var n=e("./Broadphase"),i=e("../math/Vec3"),r=e("../shapes/Shape");function o(e,t,r,o,a){n.apply(this),this.nx=r||10,this.ny=o||10,this.nz=a||10,this.aabbMin=e||new i(100,100,100),this.aabbMax=t||new i(-100,-100,-100);var s=this.nx*this.ny*this.nz;if(s<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=s,this.binLengths.length=s;for(var c=0;c<s;c++)this.bins[c]=[],this.binLengths[c]=0}o.prototype=new n,o.prototype.constructor=o;var a=new i;new i,o.prototype.collisionPairs=function(e,t,n){for(var i=e.numObjects(),o=e.bodies,s=this.aabbMax,c=this.aabbMin,l=this.nx,u=this.ny,h=this.nz,f=u*h,_=h,p=1,d=s.x,m=s.y,v=s.z,g=c.x,y=c.y,x=c.z,S=l/(d-g),T=u/(m-y),b=h/(v-x),E=(d-g)/l,C=(m-y)/u,A=(v-x)/h,w=.5*Math.sqrt(E*E+C*C+A*A),P=r.types,R=P.SPHERE,I=P.PLANE,D=(P.BOX,P.COMPOUND,P.CONVEXPOLYHEDRON,this.bins),O=this.binLengths,M=this.bins.length,N=0;N!==M;N++)O[N]=0;var L=Math.ceil;function B(e,t,n,i,r,o,a){var s=(e-g)*S|0,c=(t-y)*T|0,d=(n-x)*b|0,m=L((i-g)*S),v=L((r-y)*T),E=L((o-x)*b);s<0?s=0:s>=l&&(s=l-1),c<0?c=0:c>=u&&(c=u-1),d<0?d=0:d>=h&&(d=h-1),m<0?m=0:m>=l&&(m=l-1),v<0?v=0:v>=u&&(v=u-1),E<0?E=0:E>=h&&(E=h-1),c*=_,d*=p,m*=f,v*=_,E*=p;for(var C=s*=f;C<=m;C+=f)for(var A=c;A<=v;A+=_)for(var w=d;w<=E;w+=p){var P=C+A+w;D[P][O[P]++]=a}}for(c=Math.min,s=Math.max,N=0;N!==i;N++){var F=(ne=o[N]).shape;switch(F.type){case R:var z=ne.position.x,U=ne.position.y,k=ne.position.z,G=F.radius;B(z-G,U-G,k-G,z+G,U+G,k+G,ne);break;case I:F.worldNormalNeedsUpdate&&F.computeWorldNormal(ne.quaternion);var H=F.worldNormal,V=g+.5*E-ne.position.x,W=y+.5*C-ne.position.y,j=x+.5*A-ne.position.z,q=a;q.set(V,W,j);for(var X=0,Y=0;X!==l;X++,Y+=f,q.y=W,q.x+=E)for(var K=0,Q=0;K!==u;K++,Q+=_,q.z=j,q.y+=C)for(var Z=0,J=0;Z!==h;Z++,J+=p,q.z+=A)if(q.dot(H)<w){var $=Y+Q+J;D[$][O[$]++]=ne}break;default:ne.aabbNeedsUpdate&&ne.computeAABB(),B(ne.aabb.lowerBound.x,ne.aabb.lowerBound.y,ne.aabb.lowerBound.z,ne.aabb.upperBound.x,ne.aabb.upperBound.y,ne.aabb.upperBound.z,ne)}}for(N=0;N!==M;N++){var ee=O[N];if(ee>1){var te=D[N];for(X=0;X!==ee;X++){var ne=te[X];for(K=0;K!==X;K++){var ie=te[K];this.needBroadphaseCollision(ne,ie)&&this.intersectionTest(ne,ie,t,n)}}}}this.makePairsUnique(t,n)}},{"../math/Vec3":31,"../shapes/Shape":44,"./Broadphase":5}],7:[function(e,t){t.exports=r;var n=e("./Broadphase"),i=e("./AABB");function r(){n.apply(this)}r.prototype=new n,r.prototype.constructor=r,r.prototype.collisionPairs=function(e,t,n){var i,r,o,a,s=e.bodies,c=s.length;for(i=0;i!==c;i++)for(r=0;r!==i;r++)o=s[i],a=s[r],this.needBroadphaseCollision(o,a)&&this.intersectionTest(o,a,t,n)},new i,r.prototype.aabbQuery=function(e,t,n){n=n||[];for(var i=0;i<e.bodies.length;i++){var r=e.bodies[i];r.aabbNeedsUpdate&&r.computeAABB(),r.aabb.overlaps(t)&&n.push(r)}return n}},{"./AABB":3,"./Broadphase":5}],8:[function(e,t){function n(){this.matrix={}}t.exports=n,n.prototype.get=function(e,t){if(e=e.id,(t=t.id)>e){var n=t;t=e,e=n}return e+"-"+t in this.matrix},n.prototype.set=function(e,t,n){if(e=e.id,(t=t.id)>e){var i=t;t=e,e=i}n?this.matrix[e+"-"+t]=!0:delete this.matrix[e+"-"+t]},n.prototype.reset=function(){this.matrix={}},n.prototype.setNumObjects=function(){}},{}],9:[function(e,t){function n(){this.current=[],this.previous=[]}function i(e,t){e.push((4294901760&t)>>16,65535&t)}t.exports=n,n.prototype.getKey=function(e,t){if(t<e){var n=t;t=e,e=n}return e<<16|t},n.prototype.set=function(e,t){for(var n=this.getKey(e,t),i=this.current,r=0;n>i[r];)r++;if(n!==i[r]){for(t=i.length-1;t>=r;t--)i[t+1]=i[t];i[r]=n}},n.prototype.tick=function(){var e=this.current;this.current=this.previous,this.previous=e,this.current.length=0},n.prototype.getDiff=function(e,t){for(var n=this.current,r=this.previous,o=n.length,a=r.length,s=0,c=0;c<o;c++){for(var l=n[c];l>r[s];)s++;l===r[s]||i(e,l)}for(s=0,c=0;c<a;c++){for(var u=r[c];u>n[s];)s++;n[s]===u||i(t,u)}}},{}],10:[function(e,t){t.exports=c;var n=e("../math/Vec3"),i=e("../math/Quaternion"),r=e("../math/Transform"),o=(e("../shapes/ConvexPolyhedron"),e("../shapes/Box"),e("../collision/RaycastResult")),a=e("../shapes/Shape"),s=e("../collision/AABB");function c(e,t){this.from=e?e.clone():new n,this.to=t?t.clone():new n,this._direction=new n,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=c.ANY,this.result=new o,this.hasHit=!1,this.callback=function(){}}c.prototype.constructor=c,c.CLOSEST=1,c.ANY=2,c.ALL=4;var l=new s,u=[];c.prototype.intersectWorld=function(e,t){return this.mode=t.mode||c.ANY,this.result=t.result||new o,this.skipBackfaces=!!t.skipBackfaces,this.checkCollisionResponse=!!t.checkCollisionResponse,this.collisionFilterMask=void 0!==t.collisionFilterMask?t.collisionFilterMask:-1,this.collisionFilterGroup=void 0!==t.collisionFilterGroup?t.collisionFilterGroup:-1,t.from&&this.from.copy(t.from),t.to&&this.to.copy(t.to),this.callback=t.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(l),u.length=0,e.broadphase.aabbQuery(e,l,u),this.intersectBodies(u),this.hasHit};var h=new n,f=new n;function _(e,t,n,i){i.vsub(t,B),n.vsub(t,h),e.vsub(t,f);var r,o,a=B.dot(B),s=B.dot(h),c=B.dot(f),l=h.dot(h),u=h.dot(f);return(r=l*c-s*u)>=0&&(o=a*u-s*c)>=0&&r+o<a*l-s*s}c.pointInTriangle=_;var p=new n,d=new i;c.prototype.intersectBody=function(e,t){if(t&&(this.result=t,this._updateDirection()),(!this.checkCollisionResponse||e.collisionResponse)&&c.perBodyFilter(this,e))for(var n=p,i=d,r=0,o=e.shapes.length;r<o;r++){var a=e.shapes[r];if(c.perShapeFilter(this,a)&&(e.quaternion.mult(e.shapeOrientations[r],i),e.quaternion.vmult(e.shapeOffsets[r],n),n.vadd(e.position,n),this.intersectShape(a,i,n,e),this.result._shouldStop))break}},c.prototype.intersectBodies=function(e,t){t&&(this.result=t,this._updateDirection());for(var n=0,i=e.length;!this.result._shouldStop&&n<i;n++)this.intersectBody(e[n])},c.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},c.prototype.intersectShape=function(e,t,n,i){if(!(z(this.from,this._direction,n)>e.boundingSphereRadius)){var r=this[e.type];r&&r.call(this,e,t,n,i,e)}},new n,new n;var m=new n,v=new n,g=new n,y=new n;new n,new o,c.prototype.intersectBox=function(e,t,n,i,r){return this.intersectConvex(e.convexPolyhedronRepresentation,t,n,i,r)},c.prototype[a.types.BOX]=c.prototype.intersectBox,c.prototype.intersectPlane=function(e,t,i,r,o){var a=this.from,s=this.to,c=this._direction,l=new n(0,0,1);t.vmult(l,l);var u=new n;a.vsub(i,u);var h=u.dot(l);if(s.vsub(i,u),!(h*u.dot(l)>0||a.distanceTo(s)<h)){var f=l.dot(c);if(!(Math.abs(f)<this.precision)){var _=new n,p=new n,d=new n;a.vsub(i,_);var m=-l.dot(_)/f;c.scale(m,p),a.vadd(p,d),this.reportIntersection(l,d,o,r,-1)}}},c.prototype[a.types.PLANE]=c.prototype.intersectPlane,c.prototype.getAABB=function(e){var t=this.to,n=this.from;e.lowerBound.x=Math.min(t.x,n.x),e.lowerBound.y=Math.min(t.y,n.y),e.lowerBound.z=Math.min(t.z,n.z),e.upperBound.x=Math.max(t.x,n.x),e.upperBound.y=Math.max(t.y,n.y),e.upperBound.z=Math.max(t.z,n.z)};var x={faceList:[0]},S=new n,T=new c,b=[];c.prototype.intersectHeightfield=function(e,t,n,i,o){e.data,e.elementSize;var a=T;a.from.copy(this.from),a.to.copy(this.to),r.pointToLocalFrame(n,t,a.from,a.from),r.pointToLocalFrame(n,t,a.to,a.to),a._updateDirection();var c,l,u,h,f=b;c=l=0,u=h=e.data.length-1;var _=new s;a.getAABB(_),e.getIndexOfPosition(_.lowerBound.x,_.lowerBound.y,f,!0),c=Math.max(c,f[0]),l=Math.max(l,f[1]),e.getIndexOfPosition(_.upperBound.x,_.upperBound.y,f,!0),u=Math.min(u,f[0]+1),h=Math.min(h,f[1]+1);for(var p=c;p<u;p++)for(var d=l;d<h;d++){if(this.result._shouldStop)return;if(e.getAabbAtIndex(p,d,_),_.overlapsRay(a)){if(e.getConvexTrianglePillar(p,d,!1),r.pointToWorldFrame(n,t,e.pillarOffset,S),this.intersectConvex(e.pillarConvex,t,S,i,o,x),this.result._shouldStop)return;e.getConvexTrianglePillar(p,d,!0),r.pointToWorldFrame(n,t,e.pillarOffset,S),this.intersectConvex(e.pillarConvex,t,S,i,o,x)}}},c.prototype[a.types.HEIGHTFIELD]=c.prototype.intersectHeightfield;var E=new n,C=new n;c.prototype.intersectSphere=function(e,t,n,i,r){var o=this.from,a=this.to,s=e.radius,c=Math.pow(a.x-o.x,2)+Math.pow(a.y-o.y,2)+Math.pow(a.z-o.z,2),l=2*((a.x-o.x)*(o.x-n.x)+(a.y-o.y)*(o.y-n.y)+(a.z-o.z)*(o.z-n.z)),u=Math.pow(o.x-n.x,2)+Math.pow(o.y-n.y,2)+Math.pow(o.z-n.z,2)-Math.pow(s,2),h=Math.pow(l,2)-4*c*u,f=E,_=C;if(!(h<0))if(0===h)o.lerp(a,h,f),f.vsub(n,_),_.normalize(),this.reportIntersection(_,f,r,i,-1);else{var p=(-l-Math.sqrt(h))/(2*c),d=(-l+Math.sqrt(h))/(2*c);if(p>=0&&p<=1&&(o.lerp(a,p,f),f.vsub(n,_),_.normalize(),this.reportIntersection(_,f,r,i,-1)),this.result._shouldStop)return;d>=0&&d<=1&&(o.lerp(a,d,f),f.vsub(n,_),_.normalize(),this.reportIntersection(_,f,r,i,-1))}},c.prototype[a.types.SPHERE]=c.prototype.intersectSphere;var A=new n,w=(new n,new n,new n);c.prototype.intersectConvex=function(e,t,n,i,r,o){for(var a=A,s=w,c=o&&o.faceList||null,l=e.faces,u=e.vertices,h=e.faceNormals,f=this._direction,p=this.from,d=this.to,x=p.distanceTo(d),S=c?c.length:l.length,T=this.result,b=0;!T._shouldStop&&b<S;b++){var E=c?c[b]:b,C=l[E],P=h[E],R=t,I=n;s.copy(u[C[0]]),R.vmult(s,s),s.vadd(I,s),s.vsub(p,s),R.vmult(P,a);var D=f.dot(a);if(!(Math.abs(D)<this.precision)){var O=a.dot(s)/D;if(!(O<0)){f.mult(O,m),m.vadd(p,m),v.copy(u[C[0]]),R.vmult(v,v),I.vadd(v,v);for(var M=1;!T._shouldStop&&M<C.length-1;M++){g.copy(u[C[M]]),y.copy(u[C[M+1]]),R.vmult(g,g),R.vmult(y,y),I.vadd(g,g),I.vadd(y,y);var N=m.distanceTo(p);!_(m,v,g,y)&&!_(m,g,v,y)||N>x||this.reportIntersection(a,m,r,i,E)}}}}},c.prototype[a.types.CONVEXPOLYHEDRON]=c.prototype.intersectConvex;var P=new n,R=new n,I=new n,D=new n,O=new n,M=new n,N=(new s,[]),L=new r;c.prototype.intersectTrimesh=function(e,t,n,i,o,a){var s=P,c=N,l=L,u=w,h=R,f=I,p=D,d=M,x=O,S=(a&&a.faceList,e.indices),T=(e.vertices,e.faceNormals,this.from),b=this.to,E=this._direction;l.position.copy(n),l.quaternion.copy(t),r.vectorToLocalFrame(n,t,E,h),r.pointToLocalFrame(n,t,T,f),r.pointToLocalFrame(n,t,b,p),p.x*=e.scale.x,p.y*=e.scale.y,p.z*=e.scale.z,f.x*=e.scale.x,f.y*=e.scale.y,f.z*=e.scale.z,p.vsub(f,h),h.normalize();var C=f.distanceSquared(p);e.tree.rayQuery(this,l,c);for(var A=0,B=c.length;!this.result._shouldStop&&A!==B;A++){var F=c[A];e.getNormal(F,s),e.getVertex(S[3*F],v),v.vsub(f,u);var z=h.dot(s),U=s.dot(u)/z;if(!(U<0)){h.scale(U,m),m.vadd(f,m),e.getVertex(S[3*F+1],g),e.getVertex(S[3*F+2],y);var k=m.distanceSquared(f);!_(m,g,v,y)&&!_(m,v,g,y)||k>C||(r.vectorToWorldFrame(t,s,x),r.pointToWorldFrame(n,t,m,d),this.reportIntersection(x,d,o,i,F))}}c.length=0},c.prototype[a.types.TRIMESH]=c.prototype.intersectTrimesh,c.prototype.reportIntersection=function(e,t,n,i,r){var o=this.from,a=this.to,s=o.distanceTo(t),l=this.result;if(!(this.skipBackfaces&&e.dot(this._direction)>0))switch(l.hitFaceIndex=void 0!==r?r:-1,this.mode){case c.ALL:this.hasHit=!0,l.set(o,a,e,t,n,i,s),l.hasHit=!0,this.callback(l);break;case c.CLOSEST:(s<l.distance||!l.hasHit)&&(this.hasHit=!0,l.hasHit=!0,l.set(o,a,e,t,n,i,s));break;case c.ANY:this.hasHit=!0,l.hasHit=!0,l.set(o,a,e,t,n,i,s),l._shouldStop=!0}};var B=new n,F=new n;function z(e,t,n){n.vsub(e,B);var i=B.dot(t);return t.mult(i,F),F.vadd(e,F),n.distanceTo(F)}c.perBodyFilter=function(e,t){return 0!=(e.collisionFilterGroup&t.collisionFilterMask)&&0!=(t.collisionFilterGroup&e.collisionFilterMask)},c.perShapeFilter=function(e,t){return!(e.checkCollisionResponse&&!t.collisionResponse)}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../shapes/Box":38,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44}],11:[function(e,t){var n=e("../math/Vec3");function i(){this.rayFromWorld=new n,this.rayToWorld=new n,this.hitNormalWorld=new n,this.hitPointWorld=new n,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}t.exports=i,i.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},i.prototype.abort=function(){this._shouldStop=!0},i.prototype.set=function(e,t,n,i,r,o,a){this.rayFromWorld.copy(e),this.rayToWorld.copy(t),this.hitNormalWorld.copy(n),this.hitPointWorld.copy(i),this.shape=r,this.body=o,this.distance=a}},{"../math/Vec3":31}],12:[function(e,t){e("../shapes/Shape");var n=e("../collision/Broadphase");function i(e){n.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var t=this.axisList;this._addBodyHandler=function(e){t.push(e.body)},this._removeBodyHandler=function(e){var n=t.indexOf(e.body);-1!==n&&t.splice(n,1)},e&&this.setWorld(e)}t.exports=i,i.prototype=new n,i.prototype.setWorld=function(e){this.axisList.length=0;for(var t=0;t<e.bodies.length;t++)this.axisList.push(e.bodies[t]);e.removeEventListener("addBody",this._addBodyHandler),e.removeEventListener("removeBody",this._removeBodyHandler),e.addEventListener("addBody",this._addBodyHandler),e.addEventListener("removeBody",this._removeBodyHandler),this.world=e,this.dirty=!0},i.insertionSortX=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.x<=i.aabb.lowerBound.x);r--)e[r+1]=e[r];e[r+1]=i}return e},i.insertionSortY=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.y<=i.aabb.lowerBound.y);r--)e[r+1]=e[r];e[r+1]=i}return e},i.insertionSortZ=function(e){for(var t=1,n=e.length;t<n;t++){for(var i=e[t],r=t-1;r>=0&&!(e[r].aabb.lowerBound.z<=i.aabb.lowerBound.z);r--)e[r+1]=e[r];e[r+1]=i}return e},i.prototype.collisionPairs=function(e,t,n){var r,o,a=this.axisList,s=a.length,c=this.axisIndex;for(this.dirty&&(this.sortList(),this.dirty=!1),r=0;r!==s;r++){var l=a[r];for(o=r+1;o<s;o++){var u=a[o];if(this.needBroadphaseCollision(l,u)){if(!i.checkBounds(l,u,c))break;this.intersectionTest(l,u,t,n)}}}},i.prototype.sortList=function(){for(var e=this.axisList,t=this.axisIndex,n=e.length,r=0;r!==n;r++){var o=e[r];o.aabbNeedsUpdate&&o.computeAABB()}0===t?i.insertionSortX(e):1===t?i.insertionSortY(e):2===t&&i.insertionSortZ(e)},i.checkBounds=function(e,t,n){var i,r;0===n?(i=e.position.x,r=t.position.x):1===n?(i=e.position.y,r=t.position.y):2===n&&(i=e.position.z,r=t.position.z);var o=e.boundingRadius;return r-t.boundingRadius<i+o},i.prototype.autoDetectAxis=function(){for(var e=0,t=0,n=0,i=0,r=0,o=0,a=this.axisList,s=a.length,c=1/s,l=0;l!==s;l++){var u=a[l],h=u.position.x;e+=h,t+=h*h;var f=u.position.y;n+=f,i+=f*f;var _=u.position.z;r+=_,o+=_*_}var p=t-e*e*c,d=i-n*n*c,m=o-r*r*c;this.axisIndex=p>d?p>m?0:2:d>m?1:2},i.prototype.aabbQuery=function(e,t,n){n=n||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,r="x";1===i&&(r="y"),2===i&&(r="z");for(var o=this.axisList,a=(t.lowerBound[r],t.upperBound[r],0);a<o.length;a++){var s=o[a];s.aabbNeedsUpdate&&s.computeAABB(),s.aabb.overlaps(t)&&n.push(s)}return n}},{"../collision/Broadphase":5,"../shapes/Shape":44}],13:[function(e,t){t.exports=a,e("./Constraint");var n=e("./PointToPointConstraint"),i=e("../equations/ConeEquation"),r=e("../equations/RotationalEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function a(e,t,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;this.axisA=a.axisA?a.axisA.clone():new o,this.axisB=a.axisB?a.axisB.clone():new o,n.call(this,e,c,t,l,s),this.collideConnected=!!a.collideConnected,this.angle=void 0!==a.angle?a.angle:0;var u=this.coneEquation=new i(e,t,a),h=this.twistEquation=new r(e,t,a);this.twistAngle=void 0!==a.twistAngle?a.twistAngle:0,u.maxForce=0,u.minForce=-s,h.maxForce=0,h.minForce=-s,this.equations.push(u,h)}a.prototype=new n,a.constructor=a,new o,new o,a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.coneEquation,r=this.twistEquation;n.prototype.update.call(this),e.vectorToWorldFrame(this.axisA,i.axisA),t.vectorToWorldFrame(this.axisB,i.axisB),this.axisA.tangents(r.axisA,r.axisA),e.vectorToWorldFrame(r.axisA,r.axisA),this.axisB.tangents(r.axisB,r.axisB),t.vectorToWorldFrame(r.axisB,r.axisB),i.angle=this.angle,r.maxAngle=this.twistAngle}},{"../equations/ConeEquation":19,"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],14:[function(e,t){t.exports=i;var n=e("../utils/Utils");function i(e,t,r){r=n.defaults(r,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=e,this.bodyB=t,this.id=i.idCounter++,this.collideConnected=r.collideConnected,r.wakeUpBodies&&(e&&e.wakeUp(),t&&t.wakeUp())}i.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},i.prototype.enable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!0},i.prototype.disable=function(){for(var e=this.equations,t=0;t<e.length;t++)e[t].enabled=!1},i.idCounter=0},{"../utils/Utils":54}],15:[function(e,t){t.exports=r;var n=e("./Constraint"),i=e("../equations/ContactEquation");function r(e,t,r,o){n.call(this,e,t),void 0===r&&(r=e.position.distanceTo(t.position)),void 0===o&&(o=1e6),this.distance=r;var a=this.distanceEquation=new i(e,t);this.equations.push(a),a.minForce=-o,a.maxForce=o}r.prototype=new n,r.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.distanceEquation,i=.5*this.distance,r=n.ni;t.position.vsub(e.position,r),r.normalize(),r.mult(i,n.ri),r.mult(-i,n.rj)}},{"../equations/ContactEquation":20,"./Constraint":14}],16:[function(e,t){t.exports=a,e("./Constraint");var n=e("./PointToPointConstraint"),i=e("../equations/RotationalEquation"),r=e("../equations/RotationalMotorEquation"),o=(e("../equations/ContactEquation"),e("../math/Vec3"));function a(e,t,a){var s=void 0!==(a=a||{}).maxForce?a.maxForce:1e6,c=a.pivotA?a.pivotA.clone():new o,l=a.pivotB?a.pivotB.clone():new o;n.call(this,e,c,t,l,s),(this.axisA=a.axisA?a.axisA.clone():new o(1,0,0)).normalize(),(this.axisB=a.axisB?a.axisB.clone():new o(1,0,0)).normalize();var u=this.rotationalEquation1=new i(e,t,a),h=this.rotationalEquation2=new i(e,t,a),f=this.motorEquation=new r(e,t,s);f.enabled=!1,this.equations.push(u,h,f)}a.prototype=new n,a.constructor=a,a.prototype.enableMotor=function(){this.motorEquation.enabled=!0},a.prototype.disableMotor=function(){this.motorEquation.enabled=!1},a.prototype.setMotorSpeed=function(e){this.motorEquation.targetVelocity=e},a.prototype.setMotorMaxForce=function(e){this.motorEquation.maxForce=e,this.motorEquation.minForce=-e};var s=new o,c=new o;a.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=this.motorEquation,r=this.rotationalEquation1,o=this.rotationalEquation2,a=s,l=c,u=this.axisA,h=this.axisB;n.prototype.update.call(this),e.quaternion.vmult(u,a),t.quaternion.vmult(h,l),a.tangents(r.axisA,o.axisA),r.axisB.copy(l),o.axisB.copy(l),this.motorEquation.enabled&&(e.quaternion.vmult(this.axisA,i.axisA),t.quaternion.vmult(this.axisB,i.axisB))}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],17:[function(e,t){t.exports=o,e("./Constraint");var n=e("./PointToPointConstraint"),i=e("../equations/RotationalEquation"),r=(e("../equations/RotationalMotorEquation"),e("../equations/ContactEquation"),e("../math/Vec3"));function o(e,t,o){var a=void 0!==(o=o||{}).maxForce?o.maxForce:1e6,s=new r,c=new r,l=new r;e.position.vadd(t.position,l),l.scale(.5,l),t.pointToLocalFrame(l,c),e.pointToLocalFrame(l,s),n.call(this,e,s,t,c,a),this.xA=e.vectorToLocalFrame(r.UNIT_X),this.xB=t.vectorToLocalFrame(r.UNIT_X),this.yA=e.vectorToLocalFrame(r.UNIT_Y),this.yB=t.vectorToLocalFrame(r.UNIT_Y),this.zA=e.vectorToLocalFrame(r.UNIT_Z),this.zB=t.vectorToLocalFrame(r.UNIT_Z);var u=this.rotationalEquation1=new i(e,t,o),h=this.rotationalEquation2=new i(e,t,o),f=this.rotationalEquation3=new i(e,t,o);this.equations.push(u,h,f)}o.prototype=new n,o.constructor=o,new r,new r,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,i=(this.motorEquation,this.rotationalEquation1),r=this.rotationalEquation2,o=this.rotationalEquation3;n.prototype.update.call(this),e.vectorToWorldFrame(this.xA,i.axisA),t.vectorToWorldFrame(this.yB,i.axisB),e.vectorToWorldFrame(this.yA,r.axisA),t.vectorToWorldFrame(this.zB,r.axisB),e.vectorToWorldFrame(this.zA,o.axisA),t.vectorToWorldFrame(this.xB,o.axisB)}},{"../equations/ContactEquation":20,"../equations/RotationalEquation":23,"../equations/RotationalMotorEquation":24,"../math/Vec3":31,"./Constraint":14,"./PointToPointConstraint":18}],18:[function(e,t){t.exports=o;var n=e("./Constraint"),i=e("../equations/ContactEquation"),r=e("../math/Vec3");function o(e,t,o,a,s){n.call(this,e,o),s=void 0!==s?s:1e6,this.pivotA=t?t.clone():new r,this.pivotB=a?a.clone():new r;var c=this.equationX=new i(e,o),l=this.equationY=new i(e,o),u=this.equationZ=new i(e,o);this.equations.push(c,l,u),c.minForce=l.minForce=u.minForce=-s,c.maxForce=l.maxForce=u.maxForce=s,c.ni.set(1,0,0),l.ni.set(0,1,0),u.ni.set(0,0,1)}o.prototype=new n,o.prototype.update=function(){var e=this.bodyA,t=this.bodyB,n=this.equationX,i=this.equationY,r=this.equationZ;e.quaternion.vmult(this.pivotA,n.ri),t.quaternion.vmult(this.pivotB,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),r.ri.copy(n.ri),r.rj.copy(n.rj)}},{"../equations/ContactEquation":20,"../math/Vec3":31,"./Constraint":14}],19:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));function r(e,t,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,e,t,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.angle=void 0!==r.angle?r.angle:0}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.angle)-i.dot(r))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],20:[function(e,t){t.exports=r;var n=e("./Equation"),i=e("../math/Vec3");function r(e,t,r){r=void 0!==r?r:1e6,n.call(this,e,t,0,r),this.si=null,this.sj=null,this.restitution=0,this.ri=new i,this.rj=new i,this.ni=new i}e("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i,s=new i;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.bi,r=this.bj,c=this.ri,l=this.rj,u=o,h=a,f=i.velocity,_=i.angularVelocity,p=(i.force,i.torque,r.velocity),d=r.angularVelocity,m=(r.force,r.torque,s),v=this.jacobianElementA,g=this.jacobianElementB,y=this.ni;c.cross(y,u),l.cross(y,h),y.negate(v.spatial),u.negate(v.rotational),g.spatial.copy(y),g.rotational.copy(h),m.copy(r.position),m.vadd(l,m),m.vsub(i.position,m),m.vsub(c,m);var x=y.dot(m),S=this.restitution+1;return-x*t-(S*p.dot(y)-S*f.dot(y)+d.dot(h)-_.dot(u))*n-e*this.computeGiMf()};var c=new i,l=new i,u=new i,h=new i,f=new i;r.prototype.getImpactVelocityAlongNormal=function(){var e=c,t=l,n=u,i=h,r=f;return this.bi.position.vadd(this.ri,n),this.bj.position.vadd(this.rj,i),this.bi.getVelocityAtWorldPoint(n,e),this.bj.getVelocityAtWorldPoint(i,t),e.vsub(t,r),this.ni.dot(r)}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],21:[function(e,t){t.exports=r;var n=e("../math/JacobianElement"),i=e("../math/Vec3");function r(e,t,i,o){this.id=r.id++,this.minForce=void 0===i?-1e6:i,this.maxForce=void 0===o?1e6:o,this.bi=e,this.bj=t,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new n,this.jacobianElementB=new n,this.enabled=!0,this.multiplier=0,this.setSpookParams(1e7,4,1/60)}r.prototype.constructor=r,r.id=0,r.prototype.setSpookParams=function(e,t,n){var i=t,r=e,o=n;this.a=4/(o*(1+4*i)),this.b=4*i/(1+4*i),this.eps=4/(o*o*r*(1+4*i))},r.prototype.computeB=function(e,t,n){var i=this.computeGW();return-this.computeGq()*e-i*t-this.computeGiMf()*n},r.prototype.computeGq=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.position,o=i.position;return e.spatial.dot(r)+t.spatial.dot(o)},new i,r.prototype.computeGW=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.velocity,o=i.velocity,a=n.angularVelocity,s=i.angularVelocity;return e.multiplyVectors(r,a)+t.multiplyVectors(o,s)},r.prototype.computeGWlambda=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.vlambda,o=i.vlambda,a=n.wlambda,s=i.wlambda;return e.multiplyVectors(r,a)+t.multiplyVectors(o,s)};var o=new i,a=new i,s=new i,c=new i;r.prototype.computeGiMf=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.force,l=n.torque,u=i.force,h=i.torque,f=n.invMassSolve,_=i.invMassSolve;return r.scale(f,o),u.scale(_,a),n.invInertiaWorldSolve.vmult(l,s),i.invInertiaWorldSolve.vmult(h,c),e.multiplyVectors(o,s)+t.multiplyVectors(a,c)};var l=new i;r.prototype.computeGiMGt=function(){var e=this.jacobianElementA,t=this.jacobianElementB,n=this.bi,i=this.bj,r=n.invMassSolve,o=i.invMassSolve,a=n.invInertiaWorldSolve,s=i.invInertiaWorldSolve,c=r+o;return a.vmult(e.rotational,l),c+=l.dot(e.rotational),s.vmult(t.rotational,l),c+l.dot(t.rotational)};var u=new i;new i,new i,new i,new i,new i,r.prototype.addToWlambda=function(e){var t=this.jacobianElementA,n=this.jacobianElementB,i=this.bi,r=this.bj,o=u;i.vlambda.addScaledVector(i.invMassSolve*e,t.spatial,i.vlambda),r.vlambda.addScaledVector(r.invMassSolve*e,n.spatial,r.vlambda),i.invInertiaWorldSolve.vmult(t.rotational,o),i.wlambda.addScaledVector(e,o,i.wlambda),r.invInertiaWorldSolve.vmult(n.rotational,o),r.wlambda.addScaledVector(e,o,r.wlambda)},r.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":27,"../math/Vec3":31}],22:[function(e,t){t.exports=r;var n=e("./Equation"),i=e("../math/Vec3");function r(e,t,r){n.call(this,e,t,-r,r),this.ri=new i,this.rj=new i,this.t=new i}e("../math/Mat3"),r.prototype=new n,r.prototype.constructor=r;var o=new i,a=new i;r.prototype.computeB=function(e){this.a;var t=this.b,n=(this.bi,this.bj,this.ri),i=this.rj,r=o,s=a,c=this.t;n.cross(c,r),i.cross(c,s);var l=this.jacobianElementA,u=this.jacobianElementB;return c.negate(l.spatial),r.negate(l.rotational),u.spatial.copy(c),u.rotational.copy(s),-this.computeGW()*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],23:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));function r(e,t,r){var o=void 0!==(r=r||{}).maxForce?r.maxForce:1e6;i.call(this,e,t,-o,o),this.axisA=r.axisA?r.axisA.clone():new n(1,0,0),this.axisB=r.axisB?r.axisB.clone():new n(0,1,0),this.maxAngle=Math.PI/2}r.prototype=new i,r.prototype.constructor=r;var o=new n,a=new n;r.prototype.computeB=function(e){var t=this.a,n=this.b,i=this.axisA,r=this.axisB,s=o,c=a,l=this.jacobianElementA,u=this.jacobianElementB;return i.cross(r,s),r.cross(i,c),l.rotational.copy(c),u.rotational.copy(s),-(Math.cos(this.maxAngle)-i.dot(r))*t-this.computeGW()*n-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],24:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=(e("../math/Mat3"),e("./Equation"));function r(e,t,r){r=void 0!==r?r:1e6,i.call(this,e,t,-r,r),this.axisA=new n,this.axisB=new n,this.targetVelocity=0}r.prototype=new i,r.prototype.constructor=r,r.prototype.computeB=function(e){this.a;var t=this.b,n=(this.bi,this.bj,this.axisA),i=this.axisB,r=this.jacobianElementA,o=this.jacobianElementB;return r.rotational.copy(n),i.negate(o.rotational),-(this.computeGW()-this.targetVelocity)*t-e*this.computeGiMf()}},{"../math/Mat3":28,"../math/Vec3":31,"./Equation":21}],25:[function(e,t){var n=e("../utils/Utils");function i(e,t,r){r=n.defaults(r,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=i.idCounter++,this.materials=[e,t],this.friction=r.friction,this.restitution=r.restitution,this.contactEquationStiffness=r.contactEquationStiffness,this.contactEquationRelaxation=r.contactEquationRelaxation,this.frictionEquationStiffness=r.frictionEquationStiffness,this.frictionEquationRelaxation=r.frictionEquationRelaxation}t.exports=i,i.idCounter=0},{"../utils/Utils":54}],26:[function(e,t){function n(e){var t="";"string"==typeof(e=e||{})?(t=e,e={}):"object"==typeof e&&(t=""),this.name=t,this.id=n.idCounter++,this.friction=void 0!==e.friction?e.friction:-1,this.restitution=void 0!==e.restitution?e.restitution:-1,this.correctInelastic=0}t.exports=n,n.idCounter=0},{}],27:[function(e,t){t.exports=i;var n=e("./Vec3");function i(){this.spatial=new n,this.rotational=new n}i.prototype.multiplyElement=function(e){return e.spatial.dot(this.spatial)+e.rotational.dot(this.rotational)},i.prototype.multiplyVectors=function(e,t){return e.dot(this.spatial)+t.dot(this.rotational)}},{"./Vec3":31}],28:[function(e,t){t.exports=i;var n=e("./Vec3");function i(e){this.elements=e||[0,0,0,0,0,0,0,0,0]}i.prototype.identity=function(){var e=this.elements;e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1},i.prototype.setZero=function(){var e=this.elements;e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=0,e[7]=0,e[8]=0},i.prototype.setTrace=function(e){var t=this.elements;t[0]=e.x,t[4]=e.y,t[8]=e.z},i.prototype.getTrace=function(e){e=e||new n;var t=this.elements;e.x=t[0],e.y=t[4],e.z=t[8]},i.prototype.vmult=function(e,t){t=t||new n;var i=this.elements,r=e.x,o=e.y,a=e.z;return t.x=i[0]*r+i[1]*o+i[2]*a,t.y=i[3]*r+i[4]*o+i[5]*a,t.z=i[6]*r+i[7]*o+i[8]*a,t},i.prototype.smult=function(e){for(var t=0;t<this.elements.length;t++)this.elements[t]*=e},i.prototype.mmult=function(e,t){for(var n=t||new i,r=0;r<3;r++)for(var o=0;o<3;o++){for(var a=0,s=0;s<3;s++)a+=e.elements[r+3*s]*this.elements[s+3*o];n.elements[r+3*o]=a}return n},i.prototype.scale=function(e,t){t=t||new i;for(var n=this.elements,r=t.elements,o=0;3!==o;o++)r[3*o+0]=e.x*n[3*o+0],r[3*o+1]=e.y*n[3*o+1],r[3*o+2]=e.z*n[3*o+2];return t},i.prototype.solve=function(e,t){t=t||new n;for(var i,r=3,o=4,a=[],s=0;s<r*o;s++)a.push(0);for(s=0;s<3;s++)for(i=0;i<3;i++)a[s+o*i]=this.elements[s+3*i];a[3]=e.x,a[7]=e.y,a[11]=e.z;var c,l,u=3,h=u,f=4;do{if(0===a[(s=h-u)+o*s])for(i=s+1;i<h;i++)if(0!==a[s+o*i]){c=f;do{a[(l=f-c)+o*s]+=a[l+o*i]}while(--c);break}if(0!==a[s+o*s])for(i=s+1;i<h;i++){var _=a[s+o*i]/a[s+o*s];c=f;do{a[(l=f-c)+o*i]=l<=s?0:a[l+o*i]-a[l+o*s]*_}while(--c)}}while(--u);if(t.z=a[2*o+3]/a[2*o+2],t.y=(a[1*o+3]-a[1*o+2]*t.z)/a[1*o+1],t.x=(a[0*o+3]-a[0*o+2]*t.z-a[0*o+1]*t.y)/a[0*o+0],isNaN(t.x)||isNaN(t.y)||isNaN(t.z)||t.x===1/0||t.y===1/0||t.z===1/0)throw"Could not solve equation! Got x=["+t.toString()+"], b=["+e.toString()+"], A=["+this.toString()+"]";return t},i.prototype.e=function(e,t,n){if(void 0===n)return this.elements[t+3*e];this.elements[t+3*e]=n},i.prototype.copy=function(e){for(var t=0;t<e.elements.length;t++)this.elements[t]=e.elements[t];return this},i.prototype.toString=function(){for(var e="",t=",",n=0;n<9;n++)e+=this.elements[n]+t;return e},i.prototype.reverse=function(e){e=e||new i;for(var t,n=3,r=6,o=[],a=0;a<n*r;a++)o.push(0);for(a=0;a<3;a++)for(t=0;t<3;t++)o[a+r*t]=this.elements[a+3*t];o[3]=1,o[9]=0,o[15]=0,o[4]=0,o[10]=1,o[16]=0,o[5]=0,o[11]=0,o[17]=1;var s,c,l=3,u=l,h=r;do{if(0===o[(a=u-l)+r*a])for(t=a+1;t<u;t++)if(0!==o[a+r*t]){s=h;do{o[(c=h-s)+r*a]+=o[c+r*t]}while(--s);break}if(0!==o[a+r*a])for(t=a+1;t<u;t++){var f=o[a+r*t]/o[a+r*a];s=h;do{o[(c=h-s)+r*t]=c<=a?0:o[c+r*t]-o[c+r*a]*f}while(--s)}}while(--l);a=2;do{t=a-1;do{f=o[a+r*t]/o[a+r*a],s=r;do{o[(c=r-s)+r*t]=o[c+r*t]-o[c+r*a]*f}while(--s)}while(t--)}while(--a);a=2;do{f=1/o[a+r*a],s=r;do{o[(c=r-s)+r*a]=o[c+r*a]*f}while(--s)}while(a--);a=2;do{t=2;do{if(c=o[n+t+r*a],isNaN(c)||c===1/0)throw"Could not reverse! A=["+this.toString()+"]";e.e(a,t,c)}while(t--)}while(a--);return e},i.prototype.setRotationFromQuaternion=function(e){var t=e.x,n=e.y,i=e.z,r=e.w,o=t+t,a=n+n,s=i+i,c=t*o,l=t*a,u=t*s,h=n*a,f=n*s,_=i*s,p=r*o,d=r*a,m=r*s,v=this.elements;return v[0]=1-(h+_),v[1]=l-m,v[2]=u+d,v[3]=l+m,v[4]=1-(c+_),v[5]=f-p,v[6]=u-d,v[7]=f+p,v[8]=1-(c+h),this},i.prototype.transpose=function(e){for(var t=(e=e||new i).elements,n=this.elements,r=0;3!==r;r++)for(var o=0;3!==o;o++)t[3*r+o]=n[3*o+r];return e}},{"./Vec3":31}],29:[function(e,t){t.exports=i;var n=e("./Vec3");function i(e,t,n,i){this.x=void 0!==e?e:0,this.y=void 0!==t?t:0,this.z=void 0!==n?n:0,this.w=void 0!==i?i:1}i.prototype.set=function(e,t,n,i){return this.x=e,this.y=t,this.z=n,this.w=i,this},i.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},i.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},i.prototype.setFromAxisAngle=function(e,t){var n=Math.sin(.5*t);return this.x=e.x*n,this.y=e.y*n,this.z=e.z*n,this.w=Math.cos(.5*t),this},i.prototype.toAxisAngle=function(e){e=e||new n,this.normalize();var t=2*Math.acos(this.w),i=Math.sqrt(1-this.w*this.w);return i<.001?(e.x=this.x,e.y=this.y,e.z=this.z):(e.x=this.x/i,e.y=this.y/i,e.z=this.z/i),[e,t]};var r=new n,o=new n;i.prototype.setFromVectors=function(e,t){if(e.isAntiparallelTo(t)){var n=r,i=o;e.tangents(n,i),this.setFromAxisAngle(n,Math.PI)}else{var a=e.cross(t);this.x=a.x,this.y=a.y,this.z=a.z,this.w=Math.sqrt(Math.pow(e.norm(),2)*Math.pow(t.norm(),2))+e.dot(t),this.normalize()}return this},new n,new n,new n,i.prototype.mult=function(e,t){t=t||new i;var n=this.x,r=this.y,o=this.z,a=this.w,s=e.x,c=e.y,l=e.z,u=e.w;return t.x=n*u+a*s+r*l-o*c,t.y=r*u+a*c+o*s-n*l,t.z=o*u+a*l+n*c-r*s,t.w=a*u-n*s-r*c-o*l,t},i.prototype.inverse=function(e){var t=this.x,n=this.y,r=this.z,o=this.w;e=e||new i,this.conjugate(e);var a=1/(t*t+n*n+r*r+o*o);return e.x*=a,e.y*=a,e.z*=a,e.w*=a,e},i.prototype.conjugate=function(e){return(e=e||new i).x=-this.x,e.y=-this.y,e.z=-this.z,e.w=this.w,e},i.prototype.normalize=function(){var e=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(e=1/e,this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},i.prototype.normalizeFast=function(){var e=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;return 0===e?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=e,this.y*=e,this.z*=e,this.w*=e),this},i.prototype.vmult=function(e,t){t=t||new n;var i=e.x,r=e.y,o=e.z,a=this.x,s=this.y,c=this.z,l=this.w,u=l*i+s*o-c*r,h=l*r+c*i-a*o,f=l*o+a*r-s*i,_=-a*i-s*r-c*o;return t.x=u*l+_*-a+h*-c-f*-s,t.y=h*l+_*-s+f*-a-u*-c,t.z=f*l+_*-c+u*-s-h*-a,t},i.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=e.w,this},i.prototype.toEuler=function(e,t){var n,i,r;t=t||"YZX";var o=this.x,a=this.y,s=this.z,c=this.w;switch(t){case"YZX":var l=o*a+s*c;if(l>.499&&(n=2*Math.atan2(o,c),i=Math.PI/2,r=0),l<-.499&&(n=-2*Math.atan2(o,c),i=-Math.PI/2,r=0),isNaN(n)){var u=o*o,h=a*a,f=s*s;n=Math.atan2(2*a*c-2*o*s,1-2*h-2*f),i=Math.asin(2*l),r=Math.atan2(2*o*c-2*a*s,1-2*u-2*f)}break;default:throw new Error("Euler order "+t+" not supported yet.")}e.y=n,e.z=i,e.x=r},i.prototype.setFromEuler=function(e,t,n,i){i=i||"XYZ";var r=Math.cos(e/2),o=Math.cos(t/2),a=Math.cos(n/2),s=Math.sin(e/2),c=Math.sin(t/2),l=Math.sin(n/2);return"XYZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"YXZ"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"ZXY"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a-s*c*l):"ZYX"===i?(this.x=s*o*a-r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a+s*c*l):"YZX"===i?(this.x=s*o*a+r*c*l,this.y=r*c*a+s*o*l,this.z=r*o*l-s*c*a,this.w=r*o*a-s*c*l):"XZY"===i&&(this.x=s*o*a-r*c*l,this.y=r*c*a-s*o*l,this.z=r*o*l+s*c*a,this.w=r*o*a+s*c*l),this},i.prototype.clone=function(){return new i(this.x,this.y,this.z,this.w)},i.prototype.slerp=function(e,t,n){n=n||new i;var r,o,a,s,c,l=this.x,u=this.y,h=this.z,f=this.w,_=e.x,p=e.y,d=e.z,m=e.w;return(o=l*_+u*p+h*d+f*m)<0&&(o=-o,_=-_,p=-p,d=-d,m=-m),1-o>1e-6?(r=Math.acos(o),a=Math.sin(r),s=Math.sin((1-t)*r)/a,c=Math.sin(t*r)/a):(s=1-t,c=t),n.x=s*l+c*_,n.y=s*u+c*p,n.z=s*h+c*d,n.w=s*f+c*m,n},i.prototype.integrate=function(e,t,n,r){r=r||new i;var o=e.x*n.x,a=e.y*n.y,s=e.z*n.z,c=this.x,l=this.y,u=this.z,h=this.w,f=.5*t;return r.x+=f*(o*h+a*u-s*l),r.y+=f*(a*h+s*c-o*u),r.z+=f*(s*h+o*l-a*c),r.w+=f*(-o*c-a*l-s*u),r},i.prototype.euqals=function(e){return this.x===e.x&&this.y===e.y&&this.z===e.z&&this.w===e.w}},{"./Vec3":31}],30:[function(e,t){var n=e("./Vec3"),i=e("./Quaternion");function r(e){e=e||{},this.position=new n,e.position&&this.position.copy(e.position),this.quaternion=new i,e.quaternion&&this.quaternion.copy(e.quaternion)}t.exports=r;var o=new i;r.pointToLocalFrame=function(e,t,i,r){return r=r||new n,i.vsub(e,r),t.conjugate(o),o.vmult(r,r),r},r.prototype.pointToLocal=function(e,t){return r.pointToLocalFrame(this.position,this.quaternion,e,t)},r.pointToWorldFrame=function(e,t,i,r){return r=r||new n,t.vmult(i,r),r.vadd(e,r),r},r.prototype.pointToWorld=function(e,t){return r.pointToWorldFrame(this.position,this.quaternion,e,t)},r.prototype.vectorToWorldFrame=function(e,t){return t=t||new n,this.quaternion.vmult(e,t),t},r.vectorToWorldFrame=function(e,t,n){return e.vmult(t,n),n},r.vectorToLocalFrame=function(e,t,i,r){return r=r||new n,t.w*=-1,t.vmult(i,r),t.w*=-1,r}},{"./Quaternion":29,"./Vec3":31}],31:[function(e,t){t.exports=i;var n=e("./Mat3");function i(e,t,n){this.x=e||0,this.y=t||0,this.z=n||0}i.ZERO=new i(0,0,0),i.UNIT_X=new i(1,0,0),i.UNIT_Y=new i(0,1,0),i.UNIT_Z=new i(0,0,1),i.prototype.cross=function(e,t){var n=e.x,r=e.y,o=e.z,a=this.x,s=this.y,c=this.z;return(t=t||new i).x=s*o-c*r,t.y=c*n-a*o,t.z=a*r-s*n,t},i.prototype.set=function(e,t,n){return this.x=e,this.y=t,this.z=n,this},i.prototype.setZero=function(){this.x=this.y=this.z=0},i.prototype.vadd=function(e,t){if(!t)return new i(this.x+e.x,this.y+e.y,this.z+e.z);t.x=e.x+this.x,t.y=e.y+this.y,t.z=e.z+this.z},i.prototype.vsub=function(e,t){if(!t)return new i(this.x-e.x,this.y-e.y,this.z-e.z);t.x=this.x-e.x,t.y=this.y-e.y,t.z=this.z-e.z},i.prototype.crossmat=function(){return new n([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},i.prototype.normalize=function(){var e=this.x,t=this.y,n=this.z,i=Math.sqrt(e*e+t*t+n*n);if(i>0){var r=1/i;this.x*=r,this.y*=r,this.z*=r}else this.x=0,this.y=0,this.z=0;return i},i.prototype.unit=function(e){e=e||new i;var t=this.x,n=this.y,r=this.z,o=Math.sqrt(t*t+n*n+r*r);return o>0?(o=1/o,e.x=t*o,e.y=n*o,e.z=r*o):(e.x=1,e.y=0,e.z=0),e},i.prototype.norm=function(){var e=this.x,t=this.y,n=this.z;return Math.sqrt(e*e+t*t+n*n)},i.prototype.length=i.prototype.norm,i.prototype.norm2=function(){return this.dot(this)},i.prototype.lengthSquared=i.prototype.norm2,i.prototype.distanceTo=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return Math.sqrt((r-t)*(r-t)+(o-n)*(o-n)+(a-i)*(a-i))},i.prototype.distanceSquared=function(e){var t=this.x,n=this.y,i=this.z,r=e.x,o=e.y,a=e.z;return(r-t)*(r-t)+(o-n)*(o-n)+(a-i)*(a-i)},i.prototype.mult=function(e,t){t=t||new i;var n=this.x,r=this.y,o=this.z;return t.x=e*n,t.y=e*r,t.z=e*o,t},i.prototype.vmul=function(e,t){return(t=t||new i).x=e.x*this.x,t.y=e.y*this.y,t.z=e.z*this.z,t},i.prototype.scale=i.prototype.mult,i.prototype.addScaledVector=function(e,t,n){return(n=n||new i).x=this.x+e*t.x,n.y=this.y+e*t.y,n.z=this.z+e*t.z,n},i.prototype.dot=function(e){return this.x*e.x+this.y*e.y+this.z*e.z},i.prototype.isZero=function(){return 0===this.x&&0===this.y&&0===this.z},i.prototype.negate=function(e){return(e=e||new i).x=-this.x,e.y=-this.y,e.z=-this.z,e};var r=new i,o=new i;i.prototype.tangents=function(e,t){var n=this.norm();if(n>0){var i=r,a=1/n;i.set(this.x*a,this.y*a,this.z*a);var s=o;Math.abs(i.x)<.9?(s.set(1,0,0),i.cross(s,e)):(s.set(0,1,0),i.cross(s,e)),i.cross(e,t)}else e.set(1,0,0),t.set(0,1,0)},i.prototype.toString=function(){return this.x+","+this.y+","+this.z},i.prototype.toArray=function(){return[this.x,this.y,this.z]},i.prototype.copy=function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},i.prototype.lerp=function(e,t,n){var i=this.x,r=this.y,o=this.z;n.x=i+(e.x-i)*t,n.y=r+(e.y-r)*t,n.z=o+(e.z-o)*t},i.prototype.almostEquals=function(e,t){return void 0===t&&(t=1e-6),!(Math.abs(this.x-e.x)>t||Math.abs(this.y-e.y)>t||Math.abs(this.z-e.z)>t)},i.prototype.almostZero=function(e){return void 0===e&&(e=1e-6),!(Math.abs(this.x)>e||Math.abs(this.y)>e||Math.abs(this.z)>e)};var a=new i;i.prototype.isAntiparallelTo=function(e,t){return this.negate(a),a.almostEquals(e,t)},i.prototype.clone=function(){return new i(this.x,this.y,this.z)}},{"./Mat3":28}],32:[function(e,t){t.exports=h;var n=e("../utils/EventTarget"),i=e("../shapes/Shape"),r=e("../math/Vec3"),o=e("../math/Mat3"),a=e("../math/Quaternion"),s=(e("../material/Material"),e("../collision/AABB")),c=e("../shapes/Box"),l=e("../collision/RaycastResult"),u=e("../world/World");function h(e){e=e||{},n.apply(this),this.id=h.idCounter++,this.world=null,this.preStep=null,this.ccdSpeedThreshold=void 0!==e.ccdSpeedThreshold?e.ccdSpeedThreshold:-1,this.ccdIterations=void 0!==e.ccdIterations?e.ccdIterations:5,this.postStep=null,this.vlambda=new r,this.collisionFilterGroup="number"==typeof e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask="number"==typeof e.collisionFilterMask?e.collisionFilterMask:-1,this.collisionResponse=!0,this.position=new r,this.previousPosition=new r,this.interpolatedPosition=new r,this.initPosition=new r,e.position&&(this.position.copy(e.position),this.previousPosition.copy(e.position),this.interpolatedPosition.copy(e.position),this.initPosition.copy(e.position)),this.velocity=new r,e.velocity&&this.velocity.copy(e.velocity),this.initVelocity=new r,this.force=new r;var t="number"==typeof e.mass?e.mass:0;this.mass=t,this.invMass=t>0?1/t:0,this.material=e.material||null,this.linearDamping="number"==typeof e.linearDamping?e.linearDamping:.01,this.type=t<=0?h.STATIC:h.DYNAMIC,typeof e.type==typeof h.STATIC&&(this.type=e.type),this.allowSleep=void 0===e.allowSleep||e.allowSleep,this.sleepState=0,this.sleepSpeedLimit=void 0!==e.sleepSpeedLimit?e.sleepSpeedLimit:.1,this.sleepTimeLimit=void 0!==e.sleepTimeLimit?e.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new r,this.quaternion=new a,this.initQuaternion=new a,this.previousQuaternion=new a,this.interpolatedQuaternion=new a,e.quaternion&&(this.quaternion.copy(e.quaternion),this.initQuaternion.copy(e.quaternion),this.previousQuaternion.copy(e.quaternion),this.interpolatedQuaternion.copy(e.quaternion)),this.angularVelocity=new r,e.angularVelocity&&this.angularVelocity.copy(e.angularVelocity),this.initAngularVelocity=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new r,this.invInertia=new r,this.invInertiaWorld=new o,this.invMassSolve=0,this.invInertiaSolve=new r,this.invInertiaWorldSolve=new o,this.fixedRotation=void 0!==e.fixedRotation&&e.fixedRotation,this.useGravity=!0,this.angularDamping=void 0!==e.angularDamping?e.angularDamping:.01,this.linearFactor=new r(1,1,1),e.linearFactor&&this.linearFactor.copy(e.linearFactor),this.angularFactor=new r(1,1,1),e.angularFactor&&this.angularFactor.copy(e.angularFactor),this.aabb=new s,this.aabbNeedsUpdate=!0,this.boundingRadius=0,this.wlambda=new r,e.shape&&this.addShape(e.shape),this.hasTrigger=!0,this.updateMassProperties()}h.prototype=new n,h.prototype.constructor=h,h.COLLIDE_EVENT_NAME="collide",h.DYNAMIC=1,h.STATIC=2,h.KINEMATIC=4,h.AWAKE=0,h.SLEEPY=1,h.SLEEPING=2,h.idCounter=0,h.wakeupEvent={type:"wakeup"},h.prototype.wakeUp=function(){var e=this.sleepState;this.sleepState=0,this._wakeUpAfterNarrowphase=!1,e===h.SLEEPING&&this.dispatchEvent(h.wakeupEvent)},h.prototype.sleep=function(){this.sleepState=h.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0),this._wakeUpAfterNarrowphase=!1},h.sleepyEvent={type:"sleepy"},h.sleepEvent={type:"sleep"},h.prototype.sleepTick=function(e){if(this.allowSleep){var t=this.sleepState,n=this.velocity.norm2()+this.angularVelocity.norm2(),i=Math.pow(this.sleepSpeedLimit,2);t===h.AWAKE&&n<i?(this.sleepState=h.SLEEPY,this.timeLastSleepy=e,this.dispatchEvent(h.sleepyEvent)):t===h.SLEEPY&&n>i?this.wakeUp():t===h.SLEEPY&&e-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(h.sleepEvent))}},h.prototype.updateSolveMassProperties=function(){this.sleepState===h.SLEEPING||this.type===h.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},h.prototype.pointToLocalFrame=function(e,t){return t=t||new r,e.vsub(this.position,t),this.quaternion.conjugate().vmult(t,t),t},h.prototype.vectorToLocalFrame=function(e,t){return t=t||new r,this.quaternion.conjugate().vmult(e,t),t},h.prototype.pointToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t.vadd(this.position,t),t},h.prototype.vectorToWorldFrame=function(e,t){return t=t||new r,this.quaternion.vmult(e,t),t};var f=new r,_=new a;h.prototype.addShape=function(e,t,n){var i=new r,o=new a;return t&&i.copy(t),n&&o.copy(n),this.shapes.push(e),this.shapeOffsets.push(i),this.shapeOrientations.push(o),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger(),u.idToShapeMap[e.id]=e,e.body=this,this},h.prototype.removeShape=function(e){var t=this.shapes.indexOf(e);-1!==t&&(this.shapes.splice(t,1),this.shapeOffsets.splice(t,1),this.shapeOrientations.splice(t,1),this.aabbNeedsUpdate=!0,this.updateMassProperties(),this.updateBoundingRadius(),this.updateHasTrigger())},h.prototype.updateBoundingRadius=function(){for(var e=this.shapes,t=this.shapeOffsets,n=e.length,i=0,r=0;r!==n;r++){var o=e[r];o.updateBoundingSphereRadius();var a=t[r].norm(),s=o.boundingSphereRadius;a+s>i&&(i=a+s)}this.boundingRadius=i};var p=new s;h.prototype.computeAABB=function(){for(var e=this.shapes,t=this.shapeOffsets,n=this.shapeOrientations,i=e.length,r=f,o=_,a=this.quaternion,s=this.aabb,c=p,l=0;l!==i;l++){var u=e[l];a.vmult(t[l],r),r.vadd(this.position,r),n[l].mult(a,o),u.calculateWorldAABB(r,o,c.lowerBound,c.upperBound),0===l?s.copy(c):s.extend(c)}this.aabbNeedsUpdate=!1};var d=new o,m=new o;new o,h.prototype.updateInertiaWorld=function(e){var t=this.invInertia;if(t.x!==t.y||t.y!==t.z||e){var n=d,i=m;n.setRotationFromQuaternion(this.quaternion),n.transpose(i),n.scale(t,n),n.mmult(i,this.invInertiaWorld)}},new r;var v=new r;h.prototype.applyForce=function(e,t){if(this.type===h.DYNAMIC){var n=v;t.cross(e,n),this.force.vadd(e,this.force),this.torque.vadd(n,this.torque)}};var g=new r,y=new r;h.prototype.applyLocalForce=function(e,t){if(this.type===h.DYNAMIC){var n=g,i=y;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,i),this.applyForce(n,i)}},new r;var x=new r,S=new r;h.prototype.applyImpulse=function(e,t){if(this.type===h.DYNAMIC){var n=t,i=x;i.copy(e),i.mult(this.invMass,i),this.velocity.vadd(i,this.velocity);var r=S;n.cross(e,r),this.invInertiaWorld.vmult(r,r),this.angularVelocity.vadd(r,this.angularVelocity)}};var T=new r,b=new r;h.prototype.applyLocalImpulse=function(e,t){if(this.type===h.DYNAMIC){var n=T,i=b;this.vectorToWorldFrame(e,n),this.vectorToWorldFrame(t,i),this.applyImpulse(n,i)}};var E=new r;h.prototype.updateMassProperties=function(){var e=E;this.invMass=this.mass>0?1/this.mass:0;var t=this.inertia,n=this.fixedRotation;this.computeAABB(),e.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),c.calculateInertia(e,this.mass,t),this.invInertia.set(t.x>0&&!n?1/t.x:0,t.y>0&&!n?1/t.y:0,t.z>0&&!n?1/t.z:0),this.updateInertiaWorld(!0)},h.prototype.getVelocityAtWorldPoint=function(e,t){var n=new r;return e.vsub(this.position,n),this.angularVelocity.cross(n,t),this.velocity.vadd(t,t),t},new r,new r;var C=new r,A=(new a,new a);h.prototype.integrate=function(e,t,n){if(this.previousPosition.copy(this.position),this.previousQuaternion.copy(this.quaternion),(this.type===h.DYNAMIC||u.integrateKinematic&&this.type===h.KINEMATIC)&&this.sleepState!==h.SLEEPING){var i=this.velocity,r=this.angularVelocity,o=this.position,a=this.force,s=this.torque,c=this.quaternion,l=this.invMass,f=this.invInertiaWorld,_=this.linearFactor,p=l*e;i.x+=a.x*p*_.x,i.y+=a.y*p*_.y,i.z+=a.z*p*_.z;var d=f.elements,m=this.angularFactor,v=s.x*m.x,g=s.y*m.y,y=s.z*m.z;r.x+=e*(d[0]*v+d[1]*g+d[2]*y),r.y+=e*(d[3]*v+d[4]*g+d[5]*y),r.z+=e*(d[6]*v+d[7]*g+d[8]*y),c.integrate(this.angularVelocity,e,this.angularFactor,c),t&&(n?c.normalizeFast():c.normalize()),this.type===h.DYNAMIC&&this.ccdSpeedThreshold>0&&this.velocity.length()>=Math.pow(this.ccdSpeedThreshold,2)&&this.integrateToTimeOfImpact(e)||(i.mult(e,C),o.vadd(C,o)),this.aabbNeedsUpdate=!0,this.updateInertiaWorld()}},h.prototype.updateKinematic=function(e){if(this.type===h.KINEMATIC&&0!==e){this.velocity.setZero(),this.angularVelocity.setZero();var t=1/e;this.previousPosition.almostEquals(this.position)||(this.position.vsub(this.previousPosition,this.velocity),this.velocity.mult(t,this.velocity),this.aabbNeedsUpdate=!0),this.previousQuaternion.euqals(this.quaternion)||(this.previousQuaternion.conjugate(A),A.mult(this.quaternion,A),A.toEuler(this.angularVelocity),this.angularVelocity.mult(t,this.angularVelocity),this.aabbNeedsUpdate=!0)}},h.prototype.applyGravity=function(e){if(this.type===h.DYNAMIC){if(1==this.linearDamping)this.force.setZero();else if(this.useGravity){var t=e.x,n=e.y,i=e.z,r=this.force,o=this.mass;r.x+=o*t,r.y+=o*n,r.z+=o*i}1==this.angularDamping&&this.torque.setZero()}};var w=new r,P=new r,R=new r,I=new r,D=new r,O=new r,M=new l,N=new l,L=new l,B=new r,F=new r,z=new r,U=new o;h.prototype.integrateToTimeOfImpact=function(e){w.copy(this.velocity),w.normalize(),this.velocity.mult(e,R),R.vadd(this.position,P),P.vsub(this.position,D);var t,n=D.length(),r=this.collisionFilterGroup;this.collisionFilterGroup=0;for(var o=1,a=0;a<this.shapes.length;a++){var s=this.shapes[a],c={collisionFilterMask:s.collisionFilterMask,collisionFilterGroup:s.collisionFilterGroup,skipBackfaces:!0};if(B.copy(this.position),B.vadd(D,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,M),t=M.body,s.type===i.types.SPHERE&&(o=s.radius,u.ccdSphereAdvance)){if(z.copy(this.velocity),z.y=0,z.normalize(),B.copy(z),U.identity(),U.elements[0]=B.x,U.elements[1]=-B.z,U.elements[3]=B.z,U.elements[4]=B.x,I.set(0,s.radius,0),U.vmult(I,I),I.z=I.y,I.y=0,I.vadd(this.position,B),R.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,N),I.negate(I),I.vadd(this.position,B),R.vadd(B,F),h.DrawLine(B,F),this.world.raycastClosest(B,F,c,L),N.hasHit){N.hitPointWorld.vsub(this.position,B);var l=w.dot(B);(!M.hasHit||M.distance>l)&&(M.hasHit=!0,M.distance=l,t=N.body,w.mult(l,B),B.vadd(this.position,M.hitPointWorld))}L.hasHit&&(L.hitPointWorld.vsub(this.position,B),l=w.dot(B),(!M.hasHit||M.distance>l)&&(M.hasHit=!0,M.distance=l,t=L.body,w.mult(l,B),B.vadd(this.position,M.hitPointWorld)))}if(t)break}if(this.collisionFilterGroup=r,!t)return!1;M.hasHit&&h.DrawSphere(M.hitPointWorld,.05),N.hasHit&&h.DrawSphere(N.hitPointWorld,.05),L.hasHit&&h.DrawSphere(L.hitPointWorld,.05);var f=1;(P=M.hitPointWorld).vsub(this.position,D),f=M.distance/n,O.copy(this.position);for(var _=0,p=0,d=f,m=1;m>=p&&_<this.ccdIterations;){_++,d=(m+p)/2,D.mult(d,C),O.vadd(C,this.position),this.computeAABB(),h.DrawSphere(this.position,o);var v=this.aabb.overlaps(t.aabb);if(v){var g=[];this.world.narrowphase.getContacts([this],[t],this.world,g,[],[],[]),v=g.length>0}v?m=d:p=d}return f=m,this.position.copy(O),D.mult(f,C),this.position.vadd(C,this.position),!0},h.DrawSphere=h.DrawLine=function(){},h.prototype.isSleeping=function(){return this.sleepState===h.SLEEPING},h.prototype.isSleepy=function(){return this.sleepState===h.SLEEPY},h.prototype.isAwake=function(){return this.sleepState===h.AWAKE},h.prototype.updateHasTrigger=function(){for(var e=this.shapes.length;e--&&(this.hasTrigger=!this.shapes[e].collisionResponse,!this.hasTrigger););}},{"../collision/AABB":3,"../collision/RaycastResult":11,"../material/Material":26,"../math/Mat3":28,"../math/Quaternion":29,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Shape":44,"../utils/EventTarget":50,"../world/World":57}],33:[function(e,t){e("./Body");var n=e("../math/Vec3"),i=e("../math/Quaternion"),r=(e("../collision/RaycastResult"),e("../collision/Ray")),o=e("../objects/WheelInfo");function a(e){this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:1,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:0,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:2}t.exports=a,new n,new n,new n;var s=new n,c=new n,l=new n;new r,a.prototype.addWheel=function(e){var t=new o(e=e||{}),n=this.wheelInfos.length;return this.wheelInfos.push(t),n},a.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},new n,a.prototype.applyEngineForce=function(e,t){this.wheelInfos[t].engineForce=e},a.prototype.setBrake=function(e,t){this.wheelInfos[t].brake=e},a.prototype.addToWorld=function(e){this.constraints,e.addBody(this.chassisBody);var t=this;this.preStepCallback=function(){t.updateVehicle(e.dt)},e.addEventListener("preStep",this.preStepCallback),this.world=e},a.prototype.getVehicleAxisWorld=function(e,t){t.set(0===e?1:0,1===e?1:0,2===e?1:0),this.chassisBody.vectorToWorldFrame(t,t)},a.prototype.updateVehicle=function(e){for(var t=this.wheelInfos,i=t.length,r=this.chassisBody,o=0;o<i;o++)this.updateWheelTransform(o);this.currentVehicleSpeedKmHour=3.6*r.velocity.norm();var a=new n;for(this.getVehicleAxisWorld(this.indexForwardAxis,a),a.dot(r.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1),o=0;o<i;o++)this.castRay(t[o]);this.updateSuspension(e);var s=new n,c=new n;for(o=0;o<i;o++){var l=(_=t[o]).suspensionForce;l>_.maxSuspensionForce&&(l=_.maxSuspensionForce),_.raycastResult.hitNormalWorld.scale(l*e,s),_.raycastResult.hitPointWorld.vsub(r.position,c),r.applyImpulse(s,c)}this.updateFriction(e);var u=new n,h=new n,f=new n;for(o=0;o<i;o++){var _=t[o];r.getVelocityAtWorldPoint(_.chassisConnectionPointWorld,f);var p=1;switch(this.indexUpAxis){case 1:p=-1}if(_.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,h);var d=h.dot(_.raycastResult.hitNormalWorld);_.raycastResult.hitNormalWorld.scale(d,u),h.vsub(u,h);var m=h.dot(f);_.deltaRotation=p*m*e/_.radius}!_.sliding&&_.isInContact||0===_.engineForce||!_.useCustomSlidingRotationalSpeed||(_.deltaRotation=(_.engineForce>0?1:-1)*_.customSlidingRotationalSpeed*e),Math.abs(_.brake)>Math.abs(_.engineForce)&&(_.deltaRotation=0),_.rotation+=_.deltaRotation,_.deltaRotation*=.99}},a.prototype.updateSuspension=function(){for(var e=this.chassisBody.mass,t=this.wheelInfos,n=t.length,i=0;i<n;i++){var r=t[i];if(r.isInContact){var o,a=r.suspensionRestLength-r.suspensionLength;o=r.suspensionStiffness*a*r.clippedInvContactDotSuspension;var s=r.suspensionRelativeVelocity;o-=(s<0?r.dampingCompression:r.dampingRelaxation)*s,r.suspensionForce=o*e,r.suspensionForce<0&&(r.suspensionForce=0)}else r.suspensionForce=0}},a.prototype.removeFromWorld=function(e){this.constraints,e.remove(this.chassisBody),e.removeEventListener("preStep",this.preStepCallback),this.world=null};var u=new n,h=new n;a.prototype.castRay=function(e){var t=u,i=h;this.updateWheelTransformWorld(e);var r=this.chassisBody,o=-1,a=e.suspensionRestLength+e.radius;e.directionWorld.scale(a,t);var s=e.chassisConnectionPointWorld;s.vadd(t,i);var c=e.raycastResult;c.reset();var l=r.collisionResponse;r.collisionResponse=!1,this.world.rayTest(s,i,c),r.collisionResponse=l;var f=c.body;if(e.raycastResult.groundObject=0,f){o=c.distance,e.raycastResult.hitNormalWorld=c.hitNormalWorld,e.isInContact=!0;var _=c.distance;e.suspensionLength=_-e.radius;var p=e.suspensionRestLength-e.maxSuspensionTravel,d=e.suspensionRestLength+e.maxSuspensionTravel;e.suspensionLength<p&&(e.suspensionLength=p),e.suspensionLength>d&&(e.suspensionLength=d,e.raycastResult.reset());var m=e.raycastResult.hitNormalWorld.dot(e.directionWorld),v=new n;r.getVelocityAtWorldPoint(e.raycastResult.hitPointWorld,v);var g=e.raycastResult.hitNormalWorld.dot(v);if(m>=-.1)e.suspensionRelativeVelocity=0,e.clippedInvContactDotSuspension=10;else{var y=-1/m;e.suspensionRelativeVelocity=g*y,e.clippedInvContactDotSuspension=y}}else e.suspensionLength=e.suspensionRestLength+0*e.maxSuspensionTravel,e.suspensionRelativeVelocity=0,e.directionWorld.scale(-1,e.raycastResult.hitNormalWorld),e.clippedInvContactDotSuspension=1;return o},a.prototype.updateWheelTransformWorld=function(e){e.isInContact=!1;var t=this.chassisBody;t.pointToWorldFrame(e.chassisConnectionPointLocal,e.chassisConnectionPointWorld),t.vectorToWorldFrame(e.directionLocal,e.directionWorld),t.vectorToWorldFrame(e.axleLocal,e.axleWorld)},a.prototype.updateWheelTransform=function(e){var t=s,n=c,r=l,o=this.wheelInfos[e];this.updateWheelTransformWorld(o),o.directionLocal.scale(-1,t),n.copy(o.axleLocal),t.cross(n,r),r.normalize(),n.normalize();var a=o.steering,u=new i;u.setFromAxisAngle(t,a);var h=new i;h.setFromAxisAngle(n,o.rotation);var f=o.worldTransform.quaternion;this.chassisBody.quaternion.mult(u,f),f.mult(h,f),f.normalize();var _=o.worldTransform.position;_.copy(o.directionWorld),_.scale(o.suspensionLength,_),_.vadd(o.chassisConnectionPointWorld,_)};var f=[new n(1,0,0),new n(0,1,0),new n(0,0,1)];a.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform};var _=new n,p=[],d=[],m=1;a.prototype.updateFriction=function(e){for(var t=_,i=this.wheelInfos,r=i.length,o=this.chassisBody,a=d,s=p,c=0;c<r;c++){var l=(D=i[c]).raycastResult.body;D.sideImpulse=0,D.forwardImpulse=0,a[c]||(a[c]=new n),s[c]||(s[c]=new n)}for(c=0;c<r;c++)if(l=(D=i[c]).raycastResult.body){var u=s[c];this.getWheelTransformWorld(c).vectorToWorldFrame(f[this.indexRightAxis],u);var h=D.raycastResult.hitNormalWorld,v=u.dot(h);h.scale(v,t),u.vsub(t,u),u.normalize(),h.cross(u,a[c]),a[c].normalize(),D.sideImpulse=R(o,D.raycastResult.hitPointWorld,l,D.raycastResult.hitPointWorld,u),D.sideImpulse*=m}var g=1,y=.5;for(this.sliding=!1,c=0;c<r;c++){l=(D=i[c]).raycastResult.body;var S=0;if(D.slipInfo=1,l){var T=0,b=D.brake?D.brake:T;S=x(o,l,D.raycastResult.hitPointWorld,a[c],b);var E=b/(S+=D.engineForce*e);D.slipInfo*=E}if(D.forwardImpulse=0,D.skidInfo=1,l){D.skidInfo=1;var C=D.suspensionForce*e*D.frictionSlip,A=C*C;D.forwardImpulse=S;var w=D.forwardImpulse*y,P=D.sideImpulse*g,I=w*w+P*P;D.sliding=!1,I>A&&(this.sliding=!0,D.sliding=!0,E=C/Math.sqrt(I),D.skidInfo*=E)}}if(this.sliding)for(c=0;c<r;c++)0!==(D=i[c]).sideImpulse&&D.skidInfo<1&&(D.forwardImpulse*=D.skidInfo,D.sideImpulse*=D.skidInfo);for(c=0;c<r;c++){var D=i[c],O=new n;if(D.raycastResult.hitPointWorld.vsub(o.position,O),0!==D.forwardImpulse){var M=new n;a[c].scale(D.forwardImpulse,M),o.applyImpulse(M,O)}if(0!==D.sideImpulse){l=D.raycastResult.body;var N=new n;D.raycastResult.hitPointWorld.vsub(l.position,N);var L=new n;s[c].scale(D.sideImpulse,L),o.vectorToLocalFrame(O,O),O["xyz"[this.indexUpAxis]]*=D.rollInfluence,o.vectorToWorldFrame(O,O),o.applyImpulse(L,O),L.scale(-1,L),l.applyImpulse(L,N)}}};var v=new n,g=new n,y=new n;function x(e,t,n,i,r){var o=0,a=n,s=v,c=g,l=y;return e.getVelocityAtWorldPoint(a,s),t.getVelocityAtWorldPoint(a,c),s.vsub(c,l),r<(o=-i.dot(l)*(1/(C(e,n,i)+C(t,n,i))))&&(o=r),o<-r&&(o=-r),o}var S=new n,T=new n,b=new n,E=new n;function C(e,t,n){var i=S,r=T,o=b,a=E;return t.vsub(e.position,i),i.cross(n,r),e.invInertiaWorld.vmult(r,a),a.cross(i,o),e.invMass+n.dot(o)}var A=new n,w=new n,P=new n;function R(e,t,n,i,r){if(r.norm2()>1.1)return 0;var o=A,a=w,s=P;return e.getVelocityAtWorldPoint(t,o),n.getVelocityAtWorldPoint(i,a),o.vsub(a,s),-.2*r.dot(s)*(1/(e.invMass+n.invMass))}},{"../collision/Ray":10,"../collision/RaycastResult":11,"../math/Quaternion":29,"../math/Vec3":31,"../objects/WheelInfo":37,"./Body":32}],34:[function(e,t){var n=e("./Body"),i=e("../shapes/Sphere"),r=e("../shapes/Box"),o=e("../math/Vec3"),a=e("../constraints/HingeConstraint");function s(e){if(this.wheelBodies=[],this.coordinateSystem=void 0===e.coordinateSystem?new o(1,2,3):e.coordinateSystem.clone(),this.chassisBody=e.chassisBody,!this.chassisBody){var t=new r(new o(5,2,.5));this.chassisBody=new n(1,t)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}t.exports=s,s.prototype.addWheel=function(e){var t=(e=e||{}).body;t||(t=new n(1,new i(1.2))),this.wheelBodies.push(t),this.wheelForces.push(0),new o;var r=void 0!==e.position?e.position.clone():new o,s=new o;this.chassisBody.pointToWorldFrame(r,s),t.position.set(s.x,s.y,s.z);var c=void 0!==e.axis?e.axis.clone():new o(0,1,0);this.wheelAxes.push(c);var l=new a(this.chassisBody,t,{pivotA:r,axisA:c,pivotB:o.ZERO,axisB:c,collideConnected:!1});return this.constraints.push(l),this.wheelBodies.length-1},s.prototype.setSteeringValue=function(e,t){var n=this.wheelAxes[t],i=Math.cos(e),r=Math.sin(e),o=n.x,a=n.y;this.constraints[t].axisA.set(i*o-r*a,r*o+i*a,0)},s.prototype.setMotorSpeed=function(e,t){var n=this.constraints[t];n.enableMotor(),n.motorTargetVelocity=e},s.prototype.disableMotor=function(e){this.constraints[e].disableMotor()};var c=new o;s.prototype.setWheelForce=function(e,t){this.wheelForces[t]=e},s.prototype.applyWheelForce=function(e,t){var n=this.wheelAxes[t],i=this.wheelBodies[t],r=i.torque;n.scale(e,c),i.vectorToWorldFrame(c,c),r.vadd(c,r)},s.prototype.addToWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.addBody(n[i]);for(i=0;i<t.length;i++)e.addConstraint(t[i]);e.addEventListener("preStep",this._update.bind(this))},s.prototype._update=function(){for(var e=this.wheelForces,t=0;t<e.length;t++)this.applyWheelForce(e[t],t)},s.prototype.removeFromWorld=function(e){for(var t=this.constraints,n=this.wheelBodies.concat([this.chassisBody]),i=0;i<n.length;i++)e.remove(n[i]);for(i=0;i<t.length;i++)e.removeConstraint(t[i])};var l=new o;s.prototype.getWheelSpeed=function(e){var t=this.wheelAxes[e],n=this.wheelBodies[e].angularVelocity;return this.chassisBody.vectorToWorldFrame(t,l),n.dot(l)}},{"../constraints/HingeConstraint":16,"../math/Vec3":31,"../shapes/Box":38,"../shapes/Sphere":45,"./Body":32}],35:[function(e,t){t.exports=i,e("../shapes/Shape");var n=e("../math/Vec3");function i(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e("../math/Quaternion"),e("../shapes/Particle"),e("../objects/Body"),e("../material/Material"),i.prototype.add=function(e){this.particles.push(e),this.neighbors.length<this.particles.length&&this.neighbors.push([])},i.prototype.remove=function(e){var t=this.particles.indexOf(e);-1!==t&&(this.particles.splice(t,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var r=new n;i.prototype.getNeighbors=function(e,t){for(var n=this.particles.length,i=e.id,o=this.smoothingRadius*this.smoothingRadius,a=r,s=0;s!==n;s++){var c=this.particles[s];c.position.vsub(e.position,a),i!==c.id&&a.norm2()<o&&t.push(c)}};var o=new n,a=new n,s=new n,c=new n,l=new n,u=new n;i.prototype.update=function(){for(var e=this.particles.length,t=o,n=this.speedOfSound,i=this.eps,r=0;r!==e;r++){var h=this.particles[r];(E=this.neighbors[r]).length=0,this.getNeighbors(h,E),E.push(this.particles[r]);for(var f=E.length,_=0,p=0;p!==f;p++){h.position.vsub(E[p].position,t);var d=t.norm(),m=this.w(d);_+=E[p].mass*m}this.densities[r]=_,this.pressures[r]=n*n*(this.densities[r]-this.density)}var v=a,g=s,y=c,x=l,S=u;for(r=0;r!==e;r++){var T,b,E,C=this.particles[r];for(v.set(0,0,0),g.set(0,0,0),f=(E=this.neighbors[r]).length,p=0;p!==f;p++){var A=E[p];C.position.vsub(A.position,x);var w=x.norm();T=-A.mass*(this.pressures[r]/(this.densities[r]*this.densities[r]+i)+this.pressures[p]/(this.densities[p]*this.densities[p]+i)),this.gradw(x,y),y.mult(T,y),v.vadd(y,v),A.velocity.vsub(C.velocity,S),S.mult(1/(1e-4+this.densities[r]*this.densities[p])*this.viscosity*A.mass,S),b=this.nablaw(w),S.mult(b,S),g.vadd(S,g)}g.mult(C.mass,g),v.mult(C.mass,v),C.force.vadd(g,C.force),C.force.vadd(v,C.force)}},i.prototype.w=function(e){var t=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(t,9))*Math.pow(t*t-e*e,3)},i.prototype.gradw=function(e,t){var n=e.norm(),i=this.smoothingRadius;e.mult(945/(32*Math.PI*Math.pow(i,9))*Math.pow(i*i-n*n,2),t)},i.prototype.nablaw=function(e){var t=this.smoothingRadius;return 945/(32*Math.PI*Math.pow(t,9))*(t*t-e*e)*(7*e*e-3*t*t)}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Particle":42,"../shapes/Shape":44}],36:[function(e,t){var n=e("../math/Vec3");function i(e,t,i){i=i||{},this.restLength="number"==typeof i.restLength?i.restLength:1,this.stiffness=i.stiffness||100,this.damping=i.damping||1,this.bodyA=e,this.bodyB=t,this.localAnchorA=new n,this.localAnchorB=new n,i.localAnchorA&&this.localAnchorA.copy(i.localAnchorA),i.localAnchorB&&this.localAnchorB.copy(i.localAnchorB),i.worldAnchorA&&this.setWorldAnchorA(i.worldAnchorA),i.worldAnchorB&&this.setWorldAnchorB(i.worldAnchorB)}t.exports=i,i.prototype.setWorldAnchorA=function(e){this.bodyA.pointToLocalFrame(e,this.localAnchorA)},i.prototype.setWorldAnchorB=function(e){this.bodyB.pointToLocalFrame(e,this.localAnchorB)},i.prototype.getWorldAnchorA=function(e){this.bodyA.pointToWorldFrame(this.localAnchorA,e)},i.prototype.getWorldAnchorB=function(e){this.bodyB.pointToWorldFrame(this.localAnchorB,e)};var r=new n,o=new n,a=new n,s=new n,c=new n,l=new n,u=new n,h=new n,f=new n,_=new n,p=new n;i.prototype.applyForce=function(){var e=this.stiffness,t=this.damping,n=this.restLength,i=this.bodyA,d=this.bodyB,m=r,v=o,g=a,y=s,x=p,S=c,T=l,b=u,E=h,C=f,A=_;this.getWorldAnchorA(S),this.getWorldAnchorB(T),S.vsub(i.position,b),T.vsub(d.position,E),T.vsub(S,m);var w=m.norm();v.copy(m),v.normalize(),d.velocity.vsub(i.velocity,g),d.angularVelocity.cross(E,x),g.vadd(x,g),i.angularVelocity.cross(b,x),g.vsub(x,g),v.mult(-e*(w-n)-t*g.dot(v),y),i.force.vsub(y,i.force),d.force.vadd(y,d.force),b.cross(y,C),E.cross(y,A),i.torque.vsub(C,i.torque),d.torque.vadd(A,d.torque)}},{"../math/Vec3":31}],37:[function(e,t){var n=e("../math/Vec3"),i=e("../math/Transform"),r=e("../collision/RaycastResult"),o=e("../utils/Utils");function a(e){e=o.defaults(e,{chassisConnectionPointLocal:new n,chassisConnectionPointWorld:new n,directionLocal:new n,directionWorld:new n,axleLocal:new n,axleWorld:new n,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=e.maxSuspensionTravel,this.customSlidingRotationalSpeed=e.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=e.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=e.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=e.chassisConnectionPointWorld.clone(),this.directionLocal=e.directionLocal.clone(),this.directionWorld=e.directionWorld.clone(),this.axleLocal=e.axleLocal.clone(),this.axleWorld=e.axleWorld.clone(),this.suspensionRestLength=e.suspensionRestLength,this.suspensionMaxLength=e.suspensionMaxLength,this.radius=e.radius,this.suspensionStiffness=e.suspensionStiffness,this.dampingCompression=e.dampingCompression,this.dampingRelaxation=e.dampingRelaxation,this.frictionSlip=e.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=e.rollInfluence,this.maxSuspensionForce=e.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=e.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new r,this.worldTransform=new i,this.isInContact=!1}t.exports=a;var s=new n,c=new n;s=new n,a.prototype.updateWheel=function(e){var t=this.raycastResult;if(this.isInContact){var n=t.hitNormalWorld.dot(t.directionWorld);t.hitPointWorld.vsub(e.position,c),e.getVelocityAtWorldPoint(c,s);var i=t.hitNormalWorld.dot(s);if(n>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/n;this.suspensionRelativeVelocity=i*r,this.clippedInvContactDotSuspension=r}}else t.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,t.directionWorld.scale(-1,t.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":11,"../math/Transform":30,"../math/Vec3":31,"../utils/Utils":54}],38:[function(e,t){t.exports=o;var n=e("./Shape"),i=e("../math/Vec3"),r=e("./ConvexPolyhedron");function o(e){n.call(this,{type:n.types.BOX}),this.halfExtents=e,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o,o.prototype.updateConvexPolyhedronRepresentation=function(){var e=this.halfExtents.x,t=this.halfExtents.y,n=this.halfExtents.z,o=i,a=[new o(-e,-t,-n),new o(e,-t,-n),new o(e,t,-n),new o(-e,t,-n),new o(-e,-t,n),new o(e,-t,n),new o(e,t,n),new o(-e,t,n)],s=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]],c=(new o(0,0,1),new o(0,1,0),new o(1,0,0),new r(a,s));this.convexPolyhedronRepresentation=c,c.material=this.material},o.prototype.calculateLocalInertia=function(e,t){return t=t||new i,o.calculateInertia(this.halfExtents,e,t),t},o.calculateInertia=function(e,t,n){var i=e;i.isZero()?(n.x=2/12*t,n.y=2/12*t,n.z=2/12*t):(n.x=1/12*t*(4*i.y*i.y+4*i.z*i.z),n.y=1/12*t*(4*i.x*i.x+4*i.z*i.z),n.z=1/12*t*(4*i.y*i.y+4*i.x*i.x))},o.prototype.getSideNormals=function(e,t){var n=e,i=this.halfExtents;if(n[0].set(i.x,0,0),n[1].set(0,i.y,0),n[2].set(0,0,i.z),n[3].set(-i.x,0,0),n[4].set(0,-i.y,0),n[5].set(0,0,-i.z),void 0!==t)for(var r=0;r!==n.length;r++)t.vmult(n[r],n[r]);return n},o.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},o.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var a=new i;new i,o.prototype.forEachWorldCorner=function(e,t,n){for(var i=this.halfExtents,r=[[i.x,i.y,i.z],[-i.x,i.y,i.z],[-i.x,-i.y,i.z],[-i.x,-i.y,-i.z],[i.x,-i.y,-i.z],[i.x,i.y,-i.z],[-i.x,i.y,-i.z],[i.x,-i.y,i.z]],o=0;o<r.length;o++)a.set(r[o][0],r[o][1],r[o][2]),t.vmult(a,a),e.vadd(a,a),n(a.x,a.y,a.z)};var s=[new i,new i,new i,new i,new i,new i,new i,new i];o.prototype.calculateWorldAABB=function(e,t,n,i){var r=this.halfExtents;s[0].set(r.x,r.y,r.z),s[1].set(-r.x,r.y,r.z),s[2].set(-r.x,-r.y,r.z),s[3].set(-r.x,-r.y,-r.z),s[4].set(r.x,-r.y,-r.z),s[5].set(r.x,r.y,-r.z),s[6].set(-r.x,r.y,-r.z),s[7].set(r.x,-r.y,r.z);var o=s[0];t.vmult(o,o),e.vadd(o,o),i.copy(o),n.copy(o);for(var a=1;a<8;a++){o=s[a],t.vmult(o,o),e.vadd(o,o);var c=o.x,l=o.y,u=o.z;c>i.x&&(i.x=c),l>i.y&&(i.y=l),u>i.z&&(i.z=u),c<n.x&&(n.x=c),l<n.y&&(n.y=l),u<n.z&&(n.z=u)}}},{"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],39:[function(e,t){t.exports=o;var n=e("./Shape"),i=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform"));function o(e,t,i){n.call(this,{type:n.types.CONVEXPOLYHEDRON}),this.vertices=e||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=t||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=i?i.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}o.prototype=new n,o.prototype.constructor=o;var a=new i;o.prototype.computeEdges=function(){var e=this.faces,t=this.vertices,n=(t.length,this.uniqueEdges);n.length=0;for(var i=a,r=0;r!==e.length;r++)for(var o=e[r],s=o.length,c=0;c!==s;c++){var l=(c+1)%s;t[o[c]].vsub(t[o[l]],i),i.normalize();for(var u=!1,h=0;h!==n.length;h++)if(n[h].almostEquals(i)||n[h].almostEquals(i)){u=!0;break}u||n.push(i.clone())}},o.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var e=0;e<this.faces.length;e++){for(var t=0;t<this.faces[e].length;t++)if(!this.vertices[this.faces[e][t]])throw new Error("Vertex "+this.faces[e][t]+" not found!");var n=this.faceNormals[e]||new i;this.getFaceNormal(e,n),n.negate(n),this.faceNormals[e]=n}};var s=new i,c=new i;o.computeNormal=function(e,t,n,i){t.vsub(e,c),n.vsub(t,s),s.cross(c,i),i.isZero()||i.normalize()},o.prototype.getFaceNormal=function(e,t){var n=this.faces[e],i=this.vertices[n[0]],r=this.vertices[n[1]],a=this.vertices[n[2]];return o.computeNormal(i,r,a,t)};var l=new i;o.prototype.clipAgainstHull=function(e,t,n,r,o,a,s,c,u){for(var h=l,f=-1,_=-Number.MAX_VALUE,p=0;p<n.faces.length;p++){h.copy(n.faceNormals[p]),o.vmult(h,h);var d=h.dot(a);d>_&&(_=d,f=p)}for(var m=[],v=n.faces[f],g=v.length,y=0;y<g;y++){var x=n.vertices[v[y]],S=new i;S.copy(x),o.vmult(S,S),r.vadd(S,S),m.push(S)}f>=0&&this.clipFaceAgainstHull(a,e,t,m,s,c,u)};var u=new i,h=new i,f=new i,_=new i,p=new i,d=new i;o.prototype.findSeparatingAxis=function(e,t,n,i,r,o,a,s){var c=u,l=h,m=f,v=_,g=p,y=d,x=Number.MAX_VALUE,S=this;if(S.uniqueAxes)for(b=0;b!==S.uniqueAxes.length;b++){if(n.vmult(S.uniqueAxes[b],c),!1===(A=S.testSepAxis(c,e,t,n,i,r)))return!1;A<x&&(x=A,o.copy(c))}else for(var T=a?a.length:S.faces.length,b=0;b<T;b++){var E=a?a[b]:b;if(c.copy(S.faceNormals[E]),n.vmult(c,c),!1===(A=S.testSepAxis(c,e,t,n,i,r)))return!1;A<x&&(x=A,o.copy(c))}if(e.uniqueAxes)for(b=0;b!==e.uniqueAxes.length;b++){if(r.vmult(e.uniqueAxes[b],l),!1===(A=S.testSepAxis(l,e,t,n,i,r)))return!1;A<x&&(x=A,o.copy(l))}else{var C=s?s.length:e.faces.length;for(b=0;b<C;b++){var A;if(E=s?s[b]:b,l.copy(e.faceNormals[E]),r.vmult(l,l),!1===(A=S.testSepAxis(l,e,t,n,i,r)))return!1;A<x&&(x=A,o.copy(l))}}for(var w=0;w!==S.uniqueEdges.length;w++){n.vmult(S.uniqueEdges[w],v);for(var P=0;P!==e.uniqueEdges.length;P++)if(r.vmult(e.uniqueEdges[P],g),v.cross(g,y),!y.almostZero()){y.normalize();var R=S.testSepAxis(y,e,t,n,i,r);if(!1===R)return!1;R<x&&(x=R,o.copy(y))}}return i.vsub(t,m),m.dot(o)>0&&o.negate(o),!0};var m=[],v=[];o.prototype.testSepAxis=function(e,t,n,i,r,a){var s=this;o.project(s,e,n,i,m),o.project(t,e,r,a,v);var c=m[0],l=m[1],u=v[0],h=v[1];if(c<h||u<l)return!1;var f=c-h,_=u-l;return f<_?f:_};var g=new i,y=new i;o.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(g,y);var n=y.x-g.x,i=y.y-g.y,r=y.z-g.z;t.x=1/12*e*(4*i*i+4*r*r),t.y=1/12*e*(4*n*n+4*r*r),t.z=1/12*e*(4*i*i+4*n*n)},o.prototype.getPlaneConstantOfFace=function(e){var t=this.faces[e],n=this.faceNormals[e],i=this.vertices[t[0]];return-n.dot(i)};var x=new i,S=new i,T=new i,b=new i,E=new i,C=new i,A=new i,w=new i;o.prototype.clipFaceAgainstHull=function(e,t,n,i,r,o,a){for(var s=x,c=S,l=T,u=b,h=E,f=C,_=A,p=w,d=this,m=i,v=[],g=-1,y=Number.MAX_VALUE,P=0;P<d.faces.length;P++){s.copy(d.faceNormals[P]),n.vmult(s,s);var R=s.dot(e);R<y&&(y=R,g=P)}if(!(g<0)){var I=d.faces[g];I.connectedFaces=[];for(var D=0;D<d.faces.length;D++)for(var O=0;O<d.faces[D].length;O++)-1!==I.indexOf(d.faces[D][O])&&D!==g&&-1===I.connectedFaces.indexOf(D)&&I.connectedFaces.push(D);m.length;for(var M=I.length,N=0;N<M;N++){var L=d.vertices[I[N]],B=d.vertices[I[(N+1)%M]];L.vsub(B,c),l.copy(c),n.vmult(l,l),t.vadd(l,l),u.copy(this.faceNormals[g]),n.vmult(u,u),t.vadd(u,u),l.cross(u,h),h.negate(h),f.copy(L),n.vmult(f,f),t.vadd(f,f),f.dot(h);var F=I.connectedFaces[N];_.copy(this.faceNormals[F]);var z=this.getPlaneConstantOfFace(F);p.copy(_),n.vmult(p,p);var U=z-p.dot(t);for(this.clipFaceAgainstPlane(m,v,p,U);m.length;)m.shift();for(;v.length;)m.push(v.shift())}for(_.copy(this.faceNormals[g]),z=this.getPlaneConstantOfFace(g),p.copy(_),n.vmult(p,p),U=z-p.dot(t),D=0;D<m.length;D++){var k=p.dot(m[D])+U;if(k<=r&&(k=r),k<=o){var G=m[D];if(k<=0){var H={point:G,normal:p,depth:k};a.push(H)}}}}},o.prototype.clipFaceAgainstPlane=function(e,t,n,r){var o,a,s=e.length;if(s<2)return t;var c=e[e.length-1],l=e[0];o=n.dot(c)+r;for(var u=0;u<s;u++){if(l=e[u],a=n.dot(l)+r,o<0)if(a<0)(h=new i).copy(l),t.push(h);else{var h=new i;c.lerp(l,o/(o-a),h),t.push(h)}else a<0&&(h=new i,c.lerp(l,o/(o-a),h),t.push(h),t.push(l));c=l,o=a}return t},o.prototype.computeWorldVertices=function(e,t){for(var n=this.vertices.length;this.worldVertices.length<n;)this.worldVertices.push(new i);for(var r=this.vertices,o=this.worldVertices,a=0;a!==n;a++)t.vmult(r[a],o[a]),e.vadd(o[a],o[a]);this.worldVerticesNeedsUpdate=!1},new i,o.prototype.computeLocalAABB=function(e,t){var n=this.vertices.length,i=this.vertices;e.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),t.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var r=0;r<n;r++){var o=i[r];o.x<e.x?e.x=o.x:o.x>t.x&&(t.x=o.x),o.y<e.y?e.y=o.y:o.y>t.y&&(t.y=o.y),o.z<e.z?e.z=o.z:o.z>t.z&&(t.z=o.z)}},o.prototype.computeWorldFaceNormals=function(e){for(var t=this.faceNormals.length;this.worldFaceNormals.length<t;)this.worldFaceNormals.push(new i);for(var n=this.faceNormals,r=this.worldFaceNormals,o=0;o!==t;o++)e.vmult(n[o],r[o]);this.worldFaceNormalsNeedsUpdate=!1},o.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=0,i=t.length;n!==i;n++){var r=t[n].norm2();r>e&&(e=r)}this.boundingSphereRadius=Math.sqrt(e)};var P=new i;o.prototype.calculateWorldAABB=function(e,t,n,i){for(var r,o,a,s,c,l,u=this.vertices.length,h=this.vertices,f=0;f<u;f++){P.copy(h[f]),t.vmult(P,P),e.vadd(P,P);var _=P;(_.x<r||void 0===r)&&(r=_.x),(_.x>s||void 0===s)&&(s=_.x),(_.y<o||void 0===o)&&(o=_.y),(_.y>c||void 0===c)&&(c=_.y),(_.z<a||void 0===a)&&(a=_.z),(_.z>l||void 0===l)&&(l=_.z)}n.set(r,o,a),i.set(s,c,l)},o.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},o.prototype.getAveragePointLocal=function(e){e=e||new i;for(var t=this.vertices.length,n=this.vertices,r=0;r<t;r++)e.vadd(n[r],e);return e.mult(1/t,e),e},o.prototype.transformAllPoints=function(e,t){var n=this.vertices.length,i=this.vertices;if(t){for(var r=0;r<n;r++){var o=i[r];t.vmult(o,o)}for(r=0;r<this.faceNormals.length;r++)o=this.faceNormals[r],t.vmult(o,o)}if(e)for(r=0;r<n;r++)(o=i[r]).vadd(e,o)};var R=new i,I=new i,D=new i;o.prototype.pointIsInside=function(e){var t=this.vertices.length,n=this.vertices,i=this.faces,r=this.faceNormals,o=this.faces.length,a=R;this.getAveragePointLocal(a);for(var s=0;s<o;s++){this.faces[s].length,t=r[s];var c=n[i[s][0]],l=I;e.vsub(c,l);var u=t.dot(l),h=D;a.vsub(c,h);var f=t.dot(h);if(u<0&&f>0||u>0&&f<0)return!1}return-1},new i;var O=new i,M=new i;o.project=function(e,t,n,i,o){var a=e.vertices.length,s=O,c=0,l=0,u=M,h=e.vertices;u.setZero(),r.vectorToLocalFrame(n,i,t,s),r.pointToLocalFrame(n,i,u,u);var f=u.dot(s);l=c=h[0].dot(s);for(var _=1;_<a;_++){var p=h[_].dot(s);p>c&&(c=p),p<l&&(l=p)}if((l-=f)>(c-=f)){var d=l;l=c,c=d}o[0]=c,o[1]=l}},{"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"./Shape":44}],40:[function(e,t){t.exports=r,e("./Shape");var n=e("../math/Vec3"),i=(e("../math/Quaternion"),e("./ConvexPolyhedron"));function r(e,t,r,o,a){if(a){for(var s=o,c=Math.cos,l=Math.sin,u=r/2,h=[],f=[],_=[0],p=[1],d=[],m=2*Math.PI/s,v=0;v<s;v++)h.push(new n(e*c(m*v),u,e*l(m*v))),h.push(new n(e*c(m*v),-u,e*l(m*v))),v<s-1?(f.push([2*v+2,2*v+3,2*v+1,2*v]),_.push(2*v+2),p.push(2*v+3)):f.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&d.push(new n(c(m*(v+.5)),0,l(m*(v+.5))));f.push(p);var g=[];for(v=0;v<_.length;v++)g.push(_[_.length-v-1]);return f.push(g),d.push(new n(0,1,0)),void i.call(this,h,f,d)}s=o;var y=[],x=(d=[],[]),S=[],T=[];for(c=Math.cos,l=Math.sin,y.push(new n(t*c(0),t*l(0),.5*-r)),S.push(0),y.push(new n(e*c(0),e*l(0),.5*r)),T.push(1),v=0;v<s;v++){m=2*Math.PI/s*(v+1);var b=2*Math.PI/s*(v+.5);v<s-1?(y.push(new n(t*c(m),t*l(m),.5*-r)),S.push(2*v+2),y.push(new n(e*c(m),e*l(m),.5*r)),T.push(2*v+3),x.push([2*v+2,2*v+3,2*v+1,2*v])):x.push([0,1,2*v+1,2*v]),(s%2==1||v<s/2)&&d.push(new n(c(b),l(b),0))}for(x.push(T),d.push(new n(0,0,1)),g=[],v=0;v<S.length;v++)g.push(S[S.length-v-1]);x.push(g),i.call(this,y,x,d)}r.prototype=new i},{"../math/Quaternion":29,"../math/Vec3":31,"./ConvexPolyhedron":39,"./Shape":44}],41:[function(e,t){var n=e("./Shape"),i=e("./ConvexPolyhedron"),r=e("../math/Vec3"),o=e("../utils/Utils");function a(e,t){t=o.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=e,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,null===t.minValue&&this.updateMinValue(),null===t.maxValue&&this.updateMaxValue(),this.cacheEnabled=!0,n.call(this,{type:n.types.HEIGHTFIELD}),this.pillarConvex=new i,this.pillarOffset=new r,this.updateBoundingSphereRadius(),this._cachedPillars={}}t.exports=a,a.prototype=new n,a.prototype.update=function(){this._cachedPillars={}},a.prototype.updateMinValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var r=e[n][i];r<t&&(t=r)}this.minValue=t},a.prototype.updateMaxValue=function(){for(var e=this.data,t=e[0][0],n=0;n!==e.length;n++)for(var i=0;i!==e[n].length;i++){var r=e[n][i];r>t&&(t=r)}this.maxValue=t},a.prototype.setHeightValueAtIndex=function(e,t,n){this.data[e][t]=n,this.clearCachedConvexTrianglePillar(e,t,!1),e>0&&(this.clearCachedConvexTrianglePillar(e-1,t,!0),this.clearCachedConvexTrianglePillar(e-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(e,t-1,!0),this.clearCachedConvexTrianglePillar(e,t-1,!1)),t>0&&e>0&&this.clearCachedConvexTrianglePillar(e-1,t-1,!0)},a.prototype.getRectMinMax=function(e,t,n,i,r){r=r||[];for(var o=this.data,a=this.minValue,s=e;s<=n;s++)for(var c=t;c<=i;c++){var l=o[s][c];l>a&&(a=l)}r[0]=this.minValue,r[1]=a},a.prototype.getIndexOfPosition=function(e,t,n,i){var r=this.elementSize,o=this.data,a=Math.floor(e/r),s=Math.floor(t/r);return n[0]=a,n[1]=s,i&&(a<0&&(a=0),s<0&&(s=0),a>=o.length-1&&(a=o.length-1),s>=o[0].length-1&&(s=o[0].length-1)),!(a<0||s<0||a>=o.length-1||s>=o[0].length-1)};var s=[],c=new r,l=new r,u=new r,h=new r;a.prototype.getTriangleAt=function(e,t,n,i,r,o){var a=s;this.getIndexOfPosition(e,t,a,n);var c=a[0],l=a[1],u=this.data;n&&(c=Math.min(u.length-2,Math.max(0,c)),l=Math.min(u[0].length-2,Math.max(0,l)));var h=this.elementSize,f=Math.pow(e/h-c,2)+Math.pow(t/h-l,2)>Math.pow(e/h-(c+1),2)+Math.pow(t/h-(l+1),2);return this.getTriangle(c,l,f,i,r,o),f};var f=new r,_=new r,p=new r,d=new r,m=new r;function v(e,t,n,i,r,o,a,s,c){c.x=((o-s)*(e-a)+(a-r)*(t-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.y=((s-i)*(e-a)+(n-a)*(t-s))/((o-s)*(n-a)+(a-r)*(i-s)),c.z=1-c.x-c.y}a.prototype.getNormalAt=function(e,t,n,i){var r=f,o=_,a=p,s=d,c=m;this.getTriangleAt(e,t,n,r,o,a),o.vsub(r,s),a.vsub(r,c),s.cross(c,i),i.normalize()},a.prototype.getAabbAtIndex=function(e,t,n){var i=this.data,r=this.elementSize;n.lowerBound.set(e*r,t*r,i[e][t]),n.upperBound.set((e+1)*r,(t+1)*r,i[e+1][t+1])},a.prototype.getHeightAt=function(e,t,n){var i=this.data,r=l,o=u,a=h,f=s;this.getIndexOfPosition(e,t,f,n);var _=f[0],p=f[1];n&&(_=Math.min(i.length-2,Math.max(0,_)),p=Math.min(i[0].length-2,Math.max(0,p)));var d=this.getTriangleAt(e,t,n,r,o,a);v(e,t,r.x,r.y,o.x,o.y,a.x,a.y,c);var m=c;return d?i[_+1][p+1]*m.x+i[_][p+1]*m.y+i[_+1][p]*m.z:i[_][p]*m.x+i[_+1][p]*m.y+i[_][p+1]*m.z},a.prototype.getCacheConvexTrianglePillarKey=function(e,t,n){return e+"_"+t+"_"+(n?1:0)},a.prototype.getCachedConvexTrianglePillar=function(e,t,n){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},a.prototype.setCachedConvexTrianglePillar=function(e,t,n,i,r){this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]={convex:i,offset:r}},a.prototype.clearCachedConvexTrianglePillar=function(e,t,n){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(e,t,n)]},a.prototype.getTriangle=function(e,t,n,i,r,o){var a=this.data,s=this.elementSize;n?(i.set((e+1)*s,(t+1)*s,a[e+1][t+1]),r.set(e*s,(t+1)*s,a[e][t+1]),o.set((e+1)*s,t*s,a[e+1][t])):(i.set(e*s,t*s,a[e][t]),r.set((e+1)*s,t*s,a[e+1][t]),o.set(e*s,(t+1)*s,a[e][t+1]))},a.prototype.getConvexTrianglePillar=function(e,t,n){var o=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){if(s=this.getCachedConvexTrianglePillar(e,t,n))return this.pillarConvex=s.convex,void(this.pillarOffset=s.offset);o=new i,a=new r,this.pillarConvex=o,this.pillarOffset=a}var s=this.data,c=this.elementSize,l=o.faces;o.vertices.length=6;for(var u=0;u<6;u++)o.vertices[u]||(o.vertices[u]=new r);for(l.length=5,u=0;u<5;u++)l[u]||(l[u]=[]);var h=o.vertices,f=(Math.min(s[e][t],s[e+1][t],s[e][t+1],s[e+1][t+1])-this.minValue)/2+this.minValue;n?(a.set((e+.75)*c,(t+.75)*c,f),h[0].set(.25*c,.25*c,s[e+1][t+1]-f),h[1].set(-.75*c,.25*c,s[e][t+1]-f),h[2].set(.25*c,-.75*c,s[e+1][t]-f),h[3].set(.25*c,.25*c,-f-1),h[4].set(-.75*c,.25*c,-f-1),h[5].set(.25*c,-.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=2,l[2][1]=5,l[2][2]=3,l[2][3]=0,l[3][0]=3,l[3][1]=4,l[3][2]=1,l[3][3]=0,l[4][0]=1,l[4][1]=4,l[4][2]=5,l[4][3]=2):(a.set((e+.25)*c,(t+.25)*c,f),h[0].set(-.25*c,-.25*c,s[e][t]-f),h[1].set(.75*c,-.25*c,s[e+1][t]-f),h[2].set(-.25*c,.75*c,s[e][t+1]-f),h[3].set(-.25*c,-.25*c,-f-1),h[4].set(.75*c,-.25*c,-f-1),h[5].set(-.25*c,.75*c,-f-1),l[0][0]=0,l[0][1]=1,l[0][2]=2,l[1][0]=5,l[1][1]=4,l[1][2]=3,l[2][0]=0,l[2][1]=2,l[2][2]=5,l[2][3]=3,l[3][0]=1,l[3][1]=0,l[3][2]=3,l[3][3]=4,l[4][0]=4,l[4][1]=5,l[4][2]=2,l[4][3]=1),o.computeNormals(),o.computeEdges(),o.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(e,t,n,o,a)},a.prototype.calculateLocalInertia=function(e,t){return(t=t||new r).set(0,0,0),t},a.prototype.volume=function(){return Number.MAX_VALUE},a.prototype.calculateWorldAABB=function(e,t,n,i){n.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),i.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},a.prototype.updateBoundingSphereRadius=function(){var e=this.data,t=this.elementSize;this.boundingSphereRadius=new r(e.length*t,e[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()},a.prototype.setHeightsFromImage=function(e,t){var n=document.createElement("canvas");n.width=e.width,n.height=e.height;var i=n.getContext("2d");i.drawImage(e,0,0);var r=i.getImageData(0,0,e.width,e.height),o=this.data;o.length=0,this.elementSize=Math.abs(t.x)/r.width;for(var a=0;a<r.height;a++){for(var s=[],c=0;c<r.width;c++){var l=(r.data[4*(a*r.height+c)]+r.data[4*(a*r.height+c)+1]+r.data[4*(a*r.height+c)+2])/4/255*t.z;t.x<0?s.push(l):s.unshift(l)}t.y<0?o.unshift(s):o.push(s)}this.updateMaxValue(),this.updateMinValue(),this.update()}},{"../math/Vec3":31,"../utils/Utils":54,"./ConvexPolyhedron":39,"./Shape":44}],42:[function(e,t){t.exports=r;var n=e("./Shape"),i=e("../math/Vec3");function r(){n.call(this,{type:n.types.PARTICLE})}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){return(t=t||new i).set(0,0,0),t},r.prototype.volume=function(){return 0},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},r.prototype.calculateWorldAABB=function(e,t,n,i){n.copy(e),i.copy(e)}},{"../math/Vec3":31,"./Shape":44}],43:[function(e,t){t.exports=r;var n=e("./Shape"),i=e("../math/Vec3");function r(){n.call(this,{type:n.types.PLANE}),this.worldNormal=new i,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}r.prototype=new n,r.prototype.constructor=r,r.prototype.computeWorldNormal=function(e){var t=this.worldNormal;t.set(0,0,1),e.vmult(t,t),this.worldNormalNeedsUpdate=!1},r.prototype.calculateLocalInertia=function(e,t){return t||new i},r.prototype.volume=function(){return Number.MAX_VALUE};var o=new i;r.prototype.calculateWorldAABB=function(e,t,n,i){o.set(0,0,1),t.vmult(o,o);var r=Number.MAX_VALUE;n.set(-r,-r,-r),i.set(r,r,r),1===o.x&&(i.x=e.x),1===o.y&&(i.y=e.y),1===o.z&&(i.z=e.z),-1===o.x&&(n.x=e.x),-1===o.y&&(n.y=e.y),-1===o.z&&(n.z=e.z)},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":31,"./Shape":44}],44:[function(e,t){t.exports=i;var n=e("../utils/EventTarget"),i=e("./Shape");function i(e){e=e||{},n.apply(this),this.id=i.idCounter++,this.type=e.type||0,this.boundingSphereRadius=0,this.collisionResponse=!e.collisionResponse||e.collisionResponse,this.collisionFilterGroup=void 0!==e.collisionFilterGroup?e.collisionFilterGroup:1,this.collisionFilterMask=void 0!==e.collisionFilterMask?e.collisionFilterMask:-1,this.material=e.material?e.material:null,this.body=null}e("../math/Vec3"),e("../math/Quaternion"),e("../material/Material"),i.prototype=new n,i.prototype.constructor=i,i.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},i.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},i.prototype.calculateLocalInertia=function(){throw"calculateLocalInertia() not implemented for shape type "+this.type},i.idCounter=0,i.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../utils/EventTarget":50,"./Shape":44}],45:[function(e,t){t.exports=r;var n=e("./Shape"),i=e("../math/Vec3");function r(e){if(n.call(this,{type:n.types.SPHERE}),this.radius=void 0!==e?e:1,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}r.prototype=new n,r.prototype.constructor=r,r.prototype.calculateLocalInertia=function(e,t){t=t||new i;var n=2*e*this.radius*this.radius/5;return t.x=n,t.y=n,t.z=n,t},r.prototype.volume=function(){return 4*Math.PI*this.radius/3},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},r.prototype.calculateWorldAABB=function(e,t,n,i){for(var r=this.radius,o=["x","y","z"],a=0;a<o.length;a++){var s=o[a];n[s]=e[s]-r,i[s]=e[s]+r}}},{"../math/Vec3":31,"./Shape":44}],46:[function(e,t){t.exports=s;var n=e("./Shape"),i=e("../math/Vec3"),r=(e("../math/Quaternion"),e("../math/Transform")),o=e("../collision/AABB"),a=e("../utils/Octree");function s(e,t){n.call(this,{type:n.types.TRIMESH}),this.vertices=new Float32Array(e),this.indices=new Int16Array(t),this.normals=new Float32Array(t.length),this.aabb=new o,this.edges=null,this.scale=new i(1,1,1),this.tree=new a,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}s.prototype=new n,s.prototype.constructor=s;var c=new i;s.prototype.updateTree=function(){var e=this.tree;e.reset(),e.aabb.copy(this.aabb);var t=this.scale;e.aabb.lowerBound.x*=1/t.x,e.aabb.lowerBound.y*=1/t.y,e.aabb.lowerBound.z*=1/t.z,e.aabb.upperBound.x*=1/t.x,e.aabb.upperBound.y*=1/t.y,e.aabb.upperBound.z*=1/t.z;for(var n=new o,r=new i,a=new i,s=new i,c=[r,a,s],l=0;l<this.indices.length/3;l++){var u=3*l;this._getUnscaledVertex(this.indices[u],r),this._getUnscaledVertex(this.indices[u+1],a),this._getUnscaledVertex(this.indices[u+2],s),n.setFromPoints(c),e.insert(n,l)}e.removeEmptyNodes()};var l=new o;s.prototype.getTrianglesInAABB=function(e,t){l.copy(e);var n=this.scale,i=n.x,r=n.y,o=n.z,a=l.lowerBound,s=l.upperBound;return a.x/=i,a.y/=r,a.z/=o,s.x/=i,s.y/=r,s.z/=o,this.tree.aabbQuery(l,t)},s.prototype.setScale=function(e){var t=this.scale.x===this.scale.y===this.scale.z,n=e.x===e.y===e.z;t&&n||this.updateNormals(),this.scale.copy(e),this.updateAABB(),this.updateBoundingSphereRadius()},s.prototype.updateNormals=function(){for(var e=c,t=this.normals,n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1],a=this.indices[i+2];this.getVertex(r,p),this.getVertex(o,d),this.getVertex(a,m),s.computeNormal(d,p,m,e),t[i]=e.x,t[i+1]=e.y,t[i+2]=e.z}},s.prototype.updateEdges=function(){for(var e={},t=function(){e[r<o?r+"_"+o:o+"_"+r]=!0},n=0;n<this.indices.length/3;n++){var i=3*n,r=this.indices[i],o=this.indices[i+1];this.indices[i+2],t(),t(),t()}var a=Object.keys(e);for(this.edges=new Int16Array(2*a.length),n=0;n<a.length;n++){var s=a[n].split("_");this.edges[2*n]=parseInt(s[0],10),this.edges[2*n+1]=parseInt(s[1],10)}},s.prototype.getEdgeVertex=function(e,t,n){var i=this.edges[2*e+(t?1:0)];this.getVertex(i,n)};var u=new i,h=new i;s.prototype.getEdgeVector=function(e,t){var n=u,i=h;this.getEdgeVertex(e,0,n),this.getEdgeVertex(e,1,i),i.vsub(n,t)};var f=new i,_=new i;s.computeNormal=function(e,t,n,i){t.vsub(e,_),n.vsub(t,f),f.cross(_,i),i.isZero()||i.normalize()};var p=new i,d=new i,m=new i;s.prototype.getVertex=function(e,t){var n=this.scale;return this._getUnscaledVertex(e,t),t.x*=n.x,t.y*=n.y,t.z*=n.z,t},s.prototype._getUnscaledVertex=function(e,t){var n=3*e,i=this.vertices;return t.set(i[n],i[n+1],i[n+2])},s.prototype.getWorldVertex=function(e,t,n,i){return this.getVertex(e,i),r.pointToWorldFrame(t,n,i,i),i},s.prototype.getTriangleVertices=function(e,t,n,i){var r=3*e;this.getVertex(this.indices[r],t),this.getVertex(this.indices[r+1],n),this.getVertex(this.indices[r+2],i)},s.prototype.getNormal=function(e,t){var n=3*e;return t.set(this.normals[n],this.normals[n+1],this.normals[n+2])};var v=new o;s.prototype.calculateLocalInertia=function(e,t){this.computeLocalAABB(v);var n=v.upperBound.x-v.lowerBound.x,i=v.upperBound.y-v.lowerBound.y,r=v.upperBound.z-v.lowerBound.z;return t.set(1/12*e*(4*i*i+4*r*r),1/12*e*(4*n*n+4*r*r),1/12*e*(4*i*i+4*n*n))};var g=new i;s.prototype.computeLocalAABB=function(e){var t=e.lowerBound,n=e.upperBound,i=this.vertices.length/3,r=g;if(0!==i){this.getVertex(0,r),t.copy(r),n.copy(r);for(var o=0;o!==i;o++)this.getVertex(o,r),r.x<t.x?t.x=r.x:r.x>n.x&&(n.x=r.x),r.y<t.y?t.y=r.y:r.y>n.y&&(n.y=r.y),r.z<t.z?t.z=r.z:r.z>n.z&&(n.z=r.z)}},s.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},s.prototype.updateBoundingSphereRadius=function(){for(var e=0,t=this.vertices,n=new i,r=0,o=t.length/3;r!==o;r++){this.getVertex(r,n);var a=n.norm2();a>e&&(e=a)}this.boundingSphereRadius=Math.sqrt(e)},new i;var y=new r,x=new o;s.prototype.calculateWorldAABB=function(e,t,n,i){var r=y,o=x;r.position=e,r.quaternion=t,this.aabb.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)},s.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},s.createTorus=function(e,t,n,i,r){e=e||1,t=t||.5,n=n||8,i=i||6,r=r||2*Math.PI;for(var o=[],a=[],c=0;c<=n;c++)for(var l=0;l<=i;l++){var u=l/i*r,h=c/n*Math.PI*2,f=(e+t*Math.cos(h))*Math.cos(u),_=(e+t*Math.cos(h))*Math.sin(u),p=t*Math.sin(h);o.push(f,_,p)}for(c=1;c<=n;c++)for(l=1;l<=i;l++){var d=(i+1)*c+l-1,m=(i+1)*(c-1)+l-1,v=(i+1)*(c-1)+l,g=(i+1)*c+l;a.push(d,m,g),a.push(m,v,g)}return new s(o,a)}},{"../collision/AABB":3,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../utils/Octree":51,"./Shape":44}],47:[function(e,t){t.exports=i,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver");function i(){n.call(this),this.iterations=10,this.tolerance=1e-7}i.prototype=new n;var r=[],o=[],a=[];i.prototype.solve=function(e,t){var n,i,s,c,l,u=0,h=this.iterations,f=this.tolerance*this.tolerance,_=this.equations,p=_.length,d=t.bodies,m=d.length,v=e;if(0!==p)for(var g=0;g!==m;g++)d[g].updateSolveMassProperties();var y=o,x=a,S=r;for(y.length=p,x.length=p,S.length=p,g=0;g!==p;g++){var T=_[g];S[g]=0,x[g]=T.computeB(v),y[g]=1/T.computeC()}if(0!==p){for(g=0;g!==m;g++){var b=(A=d[g]).vlambda,E=A.wlambda;b.set(0,0,0),E.set(0,0,0)}for(u=0;u!==h;u++){c=0;for(var C=0;C!==p;C++)T=_[C],n=x[C],i=y[C],(l=S[C])+(s=i*(n-T.computeGWlambda()-T.eps*l))<T.minForce?s=T.minForce-l:l+s>T.maxForce&&(s=T.maxForce-l),S[C]+=s,c+=s>0?s:-s,T.addToWlambda(s);if(c*c<f)break}for(g=0;g!==m;g++){var A,w=(A=d[g]).velocity,P=A.angularVelocity;A.vlambda.vmul(A.linearFactor,A.vlambda),w.vadd(A.vlambda,w),A.wlambda.vmul(A.angularFactor,A.wlambda),P.vadd(A.wlambda,P)}for(var R=_.length,I=1/v;R--;)_[R].multiplier=S[R]*I}return u}},{"../math/Quaternion":29,"../math/Vec3":31,"./Solver":48}],48:[function(e,t){function n(){this.equations=[]}t.exports=n,n.prototype.solve=function(){return 0},n.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},n.prototype.removeEquation=function(e){var t=this.equations,n=t.indexOf(e);-1!==n&&t.splice(n,1)},n.prototype.removeAllEquations=function(){this.equations.length=0}},{}],49:[function(e,t){t.exports=r,e("../math/Vec3"),e("../math/Quaternion");var n=e("./Solver"),i=e("../objects/Body");function r(e){for(n.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=e,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}r.prototype=new n;var o=[],a=[],s={bodies:[]},c=i.STATIC;function l(e){for(var t=e.length,n=0;n!==t;n++){var i=e[n];if(!(i.visited||i.body.type&c))return i}return!1}var u=[];function h(e,t,n,i){for(u.push(e),e.visited=!0,t(e,n,i);u.length;)for(var r,o=u.pop();r=l(o.children);)r.visited=!0,t(r,n,i),u.push(r)}function f(e,t,n){t.push(e.body);for(var i=e.eqs.length,r=0;r!==i;r++){var o=e.eqs[r];-1===n.indexOf(o)&&n.push(o)}}function _(e,t){return t.id-e.id}r.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},r.prototype.solve=function(e,t){for(var n=o,i=this.nodePool,r=t.bodies,c=this.equations,u=c.length,p=r.length,d=this.subsolver;i.length<p;)i.push(this.createNode());n.length=p;for(var m=0;m<p;m++)n[m]=i[m];for(m=0;m!==p;m++){var v=n[m];v.body=r[m],v.children.length=0,v.eqs.length=0,v.visited=!1}for(var g=0;g!==u;g++){var y=c[g],x=(m=r.indexOf(y.bi),r.indexOf(y.bj)),S=n[m],T=n[x];S.children.push(T),S.eqs.push(y),T.children.push(S),T.eqs.push(y)}var b,E=0,C=a;d.tolerance=this.tolerance,d.iterations=this.iterations;for(var A=s;b=l(n);){C.length=0,A.bodies.length=0,h(b,f,A.bodies,C);var w=C.length;for(C=C.sort(_),m=0;m!==w;m++)d.addEquation(C[m]);d.solve(e,A),d.removeAllEquations(),E++}return E}},{"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"./Solver":48}],50:[function(e,t){var n=function(){};t.exports=n,n.prototype={constructor:n,addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var n=this._listeners;return void 0===n[e]&&(n[e]=[]),-1===n[e].indexOf(t)&&n[e].push(t),this},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var n=this._listeners;return void 0!==n[e]&&-1!==n[e].indexOf(t)},hasAnyEventListener:function(e){return void 0!==this._listeners&&void 0!==this._listeners[e]},removeEventListener:function(e,t){if(void 0===this._listeners)return this;var n=this._listeners;if(void 0===n[e])return this;var i=n[e].indexOf(t);return-1!==i&&n[e].splice(i,1),this},dispatchEvent:function(e){if(void 0===this._listeners)return this;var t=this._listeners[e.type];if(void 0!==t){e.target=this;for(var n=0,i=t.length;n<i;n++)t[n].call(this,e)}return this}}},{}],51:[function(e,t){var n=e("../collision/AABB"),i=e("../math/Vec3");function r(e){e=e||{},this.root=e.root||null,this.aabb=e.aabb?e.aabb.clone():new n,this.data=[],this.children=[]}function o(e,t){(t=t||{}).root=null,t.aabb=e,r.call(this,t),this.maxDepth=void 0!==t.maxDepth?t.maxDepth:8}t.exports=o,o.prototype=new r,r.prototype.reset=function(){this.children.length=this.data.length=0},r.prototype.insert=function(e,t,n){var i=this.data;if(n=n||0,!this.aabb.contains(e))return!1;var r=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var o=!1;r.length||(this.subdivide(),o=!0);for(var a=0;8!==a;a++)if(r[a].insert(e,t,n+1))return!0;o&&(r.length=0)}return i.push(t),!0};var a=new i;r.prototype.subdivide=function(){var e=this.aabb,t=e.lowerBound,o=e.upperBound,s=this.children;s.push(new r({aabb:new n({lowerBound:new i(0,0,0)})}),new r({aabb:new n({lowerBound:new i(1,0,0)})}),new r({aabb:new n({lowerBound:new i(1,1,0)})}),new r({aabb:new n({lowerBound:new i(1,1,1)})}),new r({aabb:new n({lowerBound:new i(0,1,1)})}),new r({aabb:new n({lowerBound:new i(0,0,1)})}),new r({aabb:new n({lowerBound:new i(1,0,1)})}),new r({aabb:new n({lowerBound:new i(0,1,0)})})),o.vsub(t,a),a.scale(.5,a);for(var c=this.root||this,l=0;8!==l;l++){var u=s[l];u.root=c;var h=u.aabb.lowerBound;h.x*=a.x,h.y*=a.y,h.z*=a.z,h.vadd(t,h),h.vadd(a,u.aabb.upperBound)}},r.prototype.aabbQuery=function(e,t){this.data,this.children;for(var n=[this];n.length;){var i=n.pop();i.aabb.overlaps(e)&&Array.prototype.push.apply(t,i.data),Array.prototype.push.apply(n,i.children)}return t};var s=new n;r.prototype.rayQuery=function(e,t,n){return e.getAABB(s),s.toLocalFrame(t,s),this.aabbQuery(s,n),n},r.prototype.removeEmptyNodes=function(){for(var e=this.children.length-1;e>=0;e--)this.children[e].removeEmptyNodes(),this.children[e].children.length||this.children[e].data.length||this.children.splice(e,1)}},{"../collision/AABB":3,"../math/Vec3":31}],52:[function(e,t){function n(){this.objects=[],this.type=Object}t.exports=n,n.prototype.release=function(){for(var e=arguments.length,t=0;t!==e;t++)this.objects.push(arguments[t]);return this},n.prototype.get=function(){return 0===this.objects.length?this.constructObject():this.objects.pop()},n.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")},n.prototype.resize=function(e){for(var t=this.objects;t.length>e;)t.pop();for(;t.length<e;)t.push(this.constructObject());return this}},{}],53:[function(e,t){function n(){this.data={keys:[]}}t.exports=n,n.prototype.get=function(e,t){if(e>t){var n=t;t=e,e=n}return this.data[e+"-"+t]},n.prototype.set=function(e,t,n){if(e>t){var i=t;t=e,e=i}var r=e+"-"+t;return this.get(e,t)||this.data.keys.push(r),this.data[r]=n,this.data[r]},n.prototype.del=function(e,t){if(e>t){var n=t;t=e,e=n}var i=e+"-"+t,r=this.data.keys.indexOf(i);return r>=0&&(this.data.keys.splice(r,1),delete this.data[i],!0)},n.prototype.reset=function(){this.data={keys:[]}},n.prototype.getLength=function(){return this.data.keys.length},n.prototype.getKeyByIndex=function(e){return this.data.keys[e]},n.prototype.getDataByKey=function(e){return this.data[e]}},{}],54:[function(e,t){function n(){}t.exports=n,n.defaults=function(e,t){for(var n in e=e||{},t)n in e||(e[n]=t[n]);return e}},{}],55:[function(e,t){t.exports=r;var n=e("../math/Vec3"),i=e("./Pool");function r(){i.call(this),this.type=n}r.prototype=new i,r.prototype.constructObject=function(){return new n}},{"../math/Vec3":31,"./Pool":52}],56:[function(e,t){t.exports=h;var n=e("../collision/AABB"),i=(e("../objects/Body"),e("../shapes/Shape")),r=e("../collision/Ray"),o=e("../math/Vec3"),a=e("../math/Transform"),s=(e("../shapes/ConvexPolyhedron"),e("../math/Quaternion")),c=(e("../solver/Solver"),e("../utils/Vec3Pool")),l=e("../equations/ContactEquation"),u=e("../equations/FrictionEquation");function h(e){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new c,this.world=e,this.currentContactMaterial=null,this.enableFrictionReduction=!1}h.prototype.createContactEquation=function(e,t,n,i,r,o){var a;this.contactPointPool.length?((a=this.contactPointPool.pop()).bi=e,a.bj=t):a=new l(e,t),a.enabled=e.collisionResponse&&t.collisionResponse&&n.collisionResponse&&i.collisionResponse;var s=this.currentContactMaterial,c=s.contactEquationRelaxation;a.restitution=s.restitution;var u=n.material||e.material,h=i.material||t.material;if(u&&h){u.restitution>=0&&h.restitution>=0&&(a.restitution=u.restitution*h.restitution);var f=u.correctInelastic||h.correctInelastic;f&&(c*=f)}return a.setSpookParams(s.contactEquationStiffness,c,this.world.dt),a.si=r||n,a.sj=o||i,a},h.prototype.createFrictionEquationsFromContact=function(e,t){var n=e.bi,i=e.bj,r=e.si,o=e.sj,a=this.world,s=this.currentContactMaterial,c=s.friction,l=r.material||n.material,h=o.material||i.material;if(l&&h&&l.friction>=0&&h.friction>=0&&(c=l.friction*h.friction),c>0){var f=c*a.gravity.length(),_=n.invMass+i.invMass;_>0&&(_=1/_);var p=this.frictionEquationPool,d=p.length?p.pop():new u(n,i,f*_),m=p.length?p.pop():new u(n,i,f*_);return d.bi=m.bi=n,d.bj=m.bj=i,d.minForce=m.minForce=-f*_,d.maxForce=m.maxForce=f*_,d.ri.copy(e.ri),d.rj.copy(e.rj),m.ri.copy(e.ri),m.rj.copy(e.rj),e.ni.tangents(d.t,m.t),d.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),m.setSpookParams(s.frictionEquationStiffness,s.frictionEquationRelaxation,a.dt),d.enabled=m.enabled=e.enabled,t.push(d,m),!0}return!1};var f=new o,_=new o,p=new o;h.prototype.createFrictionFromAverage=function(e){var t=this.result[this.result.length-1];if(this.createFrictionEquationsFromContact(t,this.frictionResult)&&1!==e){var n=this.frictionResult[this.frictionResult.length-2],i=this.frictionResult[this.frictionResult.length-1];f.setZero(),_.setZero(),p.setZero();for(var r=t.bi,o=(t.bj,0);o!==e;o++)(t=this.result[this.result.length-1-o]).bodyA!==r?(f.vadd(t.ni,f),_.vadd(t.ri,_),p.vadd(t.rj,p)):(f.vsub(t.ni,f),_.vadd(t.rj,_),p.vadd(t.ri,p));var a=1/e;_.scale(a,n.ri),p.scale(a,n.rj),i.ri.copy(n.ri),i.rj.copy(n.rj),f.normalize(),f.tangents(n.t,i.t)}};var d=new o,m=new o,v=new s,g=new s;h.prototype.getContacts=function(e,t,n,i,r,o,a){this.contactPointPool=r,this.frictionEquationPool=a,this.result=i,this.frictionResult=o;for(var s=v,c=g,l=d,u=m,h=0,f=e.length;h!==f;h++){var _=e[h],p=t[h],y=null;_.material&&p.material&&(y=n.getContactMaterial(_.material,p.material)||null);for(var x=0==_.collisionResponse||0==p.collisionResponse,S=0;S<_.shapes.length;S++){_.quaternion.mult(_.shapeOrientations[S],s),_.quaternion.vmult(_.shapeOffsets[S],l),l.vadd(_.position,l);for(var T=_.shapes[S],b=0;b<p.shapes.length;b++){p.quaternion.mult(p.shapeOrientations[b],c),p.quaternion.vmult(p.shapeOffsets[b],u),u.vadd(p.position,u);var E=p.shapes[b];if(T.collisionFilterMask&E.collisionFilterGroup&&E.collisionFilterMask&T.collisionFilterGroup&&!(l.distanceTo(u)>T.boundingSphereRadius+E.boundingSphereRadius)){x|=0==T.collisionResponse||0==E.collisionResponse;var C=null;T.material&&E.material&&(C=n.getContactMaterial(T.material,E.material)||null),this.currentContactMaterial=C||y||n.defaultContactMaterial;var A=this[T.type|E.type];if(A&&(T.type<E.type?A.call(this,T,E,l,u,s,c,_,p,T,E,x):A.call(this,E,T,u,l,c,s,p,_,T,E,x))&&x){n.shapeOverlapKeeper.set(T.id,E.id),n.bodyOverlapKeeper.set(_.id,p.id);var w={si:T,sj:E};n.triggerDic.set(T.id,E.id,w),n.oldTriggerDic.set(T.id,E.id,w)}}}}}},h.prototype[i.types.BOX|i.types.BOX]=h.prototype.boxBox=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,t.convexPolyhedronRepresentation.material=t.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t.convexPolyhedronRepresentation,n,i,r,o,a,s,e,t,u)},h.prototype[i.types.BOX|i.types.CONVEXPOLYHEDRON]=h.prototype.boxConvex=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexConvex(e.convexPolyhedronRepresentation,t,n,i,r,o,a,s,e,t,u)},h.prototype[i.types.BOX|i.types.PARTICLE]=h.prototype.boxParticle=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexParticle(e.convexPolyhedronRepresentation,t,n,i,r,o,a,s,e,t,u)},h.prototype[i.types.SPHERE]=h.prototype.sphereSphere=function(e,t,n,i,r,o,a,s,c,l,u){if(u)return n.distanceSquared(i)<Math.pow(e.radius+t.radius,2);var h=this.createContactEquation(a,s,e,t,c,l);i.vsub(n,h.ni),h.ni.normalize(),h.ri.copy(h.ni),h.rj.copy(h.ni),h.ri.mult(e.radius,h.ri),h.rj.mult(-t.radius,h.rj),h.ri.vadd(n,h.ri),h.ri.vsub(a.position,h.ri),h.rj.vadd(i,h.rj),h.rj.vsub(s.position,h.rj),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)};var y=new o,x=new o,S=new o;h.prototype[i.types.PLANE|i.types.TRIMESH]=h.prototype.planeTrimesh=function(e,t,n,i,r,s,c,l,u,h,f){var _=new o,p=y;p.set(0,0,1),r.vmult(p,p);for(var d=0;d<t.vertices.length/3;d++){t.getVertex(d,_);var m=new o;m.copy(_),a.pointToWorldFrame(i,s,m,_);var v=x;if(_.vsub(n,v),p.dot(v)<=0){if(f)return!0;var g=this.createContactEquation(c,l,e,t,u,h);g.ni.copy(p);var T=S;p.scale(v.dot(p),T),_.vsub(T,T),g.ri.copy(T),g.ri.vsub(c.position,g.ri),g.rj.copy(_),g.rj.vsub(l.position,g.rj),this.result.push(g),this.createFrictionEquationsFromContact(g,this.frictionResult)}}};var T=new o,b=new o,E=(new o,new o),C=new o,A=new o,w=new o,P=new o,R=new o,I=new o,D=new o,O=new o,M=new o,N=new o,L=new n,B=[];h.prototype[i.types.SPHERE|i.types.TRIMESH]=h.prototype.sphereTrimesh=function(e,t,n,i,o,s,c,l,u,h,f){var _=A,p=w,d=P,m=R,v=I,g=D,y=L,x=C,S=b,F=B;a.pointToLocalFrame(i,s,n,v);var z=e.radius;y.lowerBound.set(v.x-z,v.y-z,v.z-z),y.upperBound.set(v.x+z,v.y+z,v.z+z),t.getTrianglesInAABB(y,F);for(var U=E,k=e.radius*e.radius,G=0;G<F.length;G++)for(var H=0;H<3;H++)if(t.getVertex(t.indices[3*F[G]+H],U),U.vsub(v,S),S.norm2()<=k){if(x.copy(U),a.pointToWorldFrame(i,s,x,U),U.vsub(n,S),f)return!0;(j=this.createContactEquation(c,l,e,t,u,h)).ni.copy(S),j.ni.normalize(),j.ri.copy(j.ni),j.ri.scale(e.radius,j.ri),j.ri.vadd(n,j.ri),j.ri.vsub(c.position,j.ri),j.rj.copy(U),j.rj.vsub(l.position,j.rj),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}for(G=0;G<F.length;G++)for(H=0;H<3;H++){t.getVertex(t.indices[3*F[G]+H],_),t.getVertex(t.indices[3*F[G]+(H+1)%3],p),p.vsub(_,d),v.vsub(p,g);var V=g.dot(d);v.vsub(_,g);var W=g.dot(d);if(W>0&&V<0&&(v.vsub(_,g),m.copy(d),m.normalize(),W=g.dot(m),m.scale(W,g),g.vadd(_,g),(Z=g.distanceTo(v))<e.radius)){if(f)return!0;var j=this.createContactEquation(c,l,e,t,u,h);g.vsub(v,j.ni),j.ni.normalize(),j.ni.scale(e.radius,j.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,j.rj),a.vectorToWorldFrame(s,j.ni,j.ni),a.vectorToWorldFrame(s,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}for(var q=O,X=M,Y=N,K=T,Q=(G=0,F.length);G!==Q;G++){t.getTriangleVertices(F[G],q,X,Y),t.getNormal(F[G],K),v.vsub(q,g);var Z=g.dot(K);if(K.scale(Z,g),v.vsub(g,g),Z=g.distanceTo(v),r.pointInTriangle(g,q,X,Y)&&Z<e.radius){if(f)return!0;j=this.createContactEquation(c,l,e,t,u,h),g.vsub(v,j.ni),j.ni.normalize(),j.ni.scale(e.radius,j.ri),a.pointToWorldFrame(i,s,g,g),g.vsub(l.position,j.rj),a.vectorToWorldFrame(s,j.ni,j.ni),a.vectorToWorldFrame(s,j.ri,j.ri),this.result.push(j),this.createFrictionEquationsFromContact(j,this.frictionResult)}}F.length=0};var F=new o,z=new o,U=new o,k=new o,G=new o;h.prototype[i.types.SPHERE|i.types.PLANE]=h.prototype.spherePlane=function(e,t,n,i,r,o,a,s,c,l,u){if(U.set(0,0,1),o.vmult(U,U),U.negate(U),U.normalize(),U.mult(e.radius,k),n.vsub(i,F),U.mult(U.dot(F),z),F.vsub(z,G),-F.dot(U)<=e.radius){if(u)return!0;var h=this.createContactEquation(a,s,e,t,c,l);h.ni.copy(U),h.ri.copy(k),h.rj.copy(G);var f=h.ri,_=h.rj;f.vadd(n,f),f.vsub(a.position,f),_.vadd(i,_),_.vsub(s.position,_),this.result.push(h),this.createFrictionEquationsFromContact(h,this.frictionResult)}return!1};var H=new o,V=new o,W=new o;function j(e,t,n){for(var i=null,r=e.length,o=0;o!==r;o++){var a=e[o],s=H;e[(o+1)%r].vsub(a,s);var c=V;s.cross(t,c);var l=W;n.vsub(a,l);var u=c.dot(l);if(!(null===i||u>0&&!0===i||u<=0&&!1===i))return!1;null===i&&(i=u>0)}return!0}var q=new o,X=new o,Y=new o,K=new o,Q=[new o,new o,new o,new o,new o,new o],Z=new o,J=new o,$=new o,ee=new o;h.prototype[i.types.SPHERE|i.types.BOX]=h.prototype.sphereBox=function(e,t,n,i,r,o,a,s,c,l,u){var h=this.v3pool,f=Q;n.vsub(i,q),t.getSideNormals(f,o);for(var _=e.radius,p=!1,d=J,m=$,v=ee,g=null,y=0,x=0,S=0,T=null,b=0,E=f.length;b!==E&&!1===p;b++){var C=X;C.copy(f[b]);var A=C.norm();C.normalize();var w=q.dot(C);if(w<A+_&&w>0){var P=Y,R=K;P.copy(f[(b+1)%3]),R.copy(f[(b+2)%3]);var I=P.norm(),D=R.norm();P.normalize(),R.normalize();var O=q.dot(P),M=q.dot(R);if(O<I&&O>-I&&M<D&&M>-D){var N=Math.abs(w-A-_);if((null===T||N<T)&&(T=N,x=O,S=M,g=A,d.copy(C),m.copy(P),v.copy(R),y++,u))return!0}}}if(y){p=!0;var L=this.createContactEquation(a,s,e,t,c,l);d.mult(-_,L.ri),L.ni.copy(d),L.ni.negate(L.ni),d.mult(g,d),m.mult(x,m),d.vadd(m,d),v.mult(S,v),d.vadd(v,L.rj),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}for(var B=h.get(),F=Z,z=0;2!==z&&!p;z++)for(var U=0;2!==U&&!p;U++)for(var k=0;2!==k&&!p;k++)if(B.set(0,0,0),z?B.vadd(f[0],B):B.vsub(f[0],B),U?B.vadd(f[1],B):B.vsub(f[1],B),k?B.vadd(f[2],B):B.vsub(f[2],B),i.vadd(B,F),F.vsub(n,F),F.norm2()<_*_){if(u)return!0;p=!0,(L=this.createContactEquation(a,s,e,t,c,l)).ri.copy(F),L.ri.normalize(),L.ni.copy(L.ri),L.ri.mult(_,L.ri),L.rj.copy(B),L.ri.vadd(n,L.ri),L.ri.vsub(a.position,L.ri),L.rj.vadd(i,L.rj),L.rj.vsub(s.position,L.rj),this.result.push(L),this.createFrictionEquationsFromContact(L,this.frictionResult)}h.release(B),B=null;var G=h.get(),H=h.get(),V=(L=h.get(),h.get()),W=(N=h.get(),f.length);for(z=0;z!==W&&!p;z++)for(U=0;U!==W&&!p;U++)if(z%3!=U%3){f[U].cross(f[z],G),G.normalize(),f[z].vadd(f[U],H),L.copy(n),L.vsub(H,L),L.vsub(i,L);var j=L.dot(G);for(G.mult(j,V),k=0;k===z%3||k===U%3;)k++;N.copy(n),N.vsub(V,N),N.vsub(H,N),N.vsub(i,N);var te=Math.abs(j),ne=N.norm();if(te<f[k].norm()&&ne<_){if(u)return!0;p=!0;var ie=this.createContactEquation(a,s,e,t,c,l);H.vadd(V,ie.rj),ie.rj.copy(ie.rj),N.negate(ie.ni),ie.ni.normalize(),ie.ri.copy(ie.rj),ie.ri.vadd(i,ie.ri),ie.ri.vsub(n,ie.ri),ie.ri.normalize(),ie.ri.mult(_,ie.ri),ie.ri.vadd(n,ie.ri),ie.ri.vsub(a.position,ie.ri),ie.rj.vadd(i,ie.rj),ie.rj.vsub(s.position,ie.rj),this.result.push(ie),this.createFrictionEquationsFromContact(ie,this.frictionResult)}}h.release(G,H,L,V,N)};var te=new o,ne=new o,ie=new o,re=new o,oe=new o,ae=new o,se=new o,ce=new o,le=new o,ue=new o;h.prototype[i.types.SPHERE|i.types.CONVEXPOLYHEDRON]=h.prototype.sphereConvex=function(e,t,n,i,r,o,a,s,c,l,u){var h=this.v3pool;n.vsub(i,te);for(var f=t.faceNormals,_=t.faces,p=t.vertices,d=e.radius,m=0;m!==p.length;m++){var v=p[m],g=oe;o.vmult(v,g),i.vadd(g,g);var y=re;if(g.vsub(n,y),y.norm2()<d*d)return!!u||(x=!0,(N=this.createContactEquation(a,s,e,t,c,l)).ri.copy(y),N.ri.normalize(),N.ni.copy(N.ri),N.ri.mult(d,N.ri),g.vsub(i,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),this.result.push(N),void this.createFrictionEquationsFromContact(N,this.frictionResult))}for(var x=!1,S=(m=0,_.length);m!==S&&!1===x;m++){var T=f[m],b=_[m],E=ae;o.vmult(T,E);var C=se;o.vmult(p[b[0]],C),C.vadd(i,C);var A=ce;E.mult(-d,A),n.vadd(A,A);var w=le;A.vsub(C,w);var P=w.dot(E),R=ue;if(n.vsub(C,R),P<0&&R.dot(E)>0){for(var I=[],D=0,O=b.length;D!==O;D++){var M=h.get();o.vmult(p[b[D]],M),i.vadd(M,M),I.push(M)}if(j(I,E,n)){if(u)return!0;x=!0;var N=this.createContactEquation(a,s,e,t,c,l);E.mult(-d,N.ri),E.negate(N.ni);var L=h.get();E.mult(-P,L);var B=h.get();E.mult(-d,B),n.vsub(i,N.rj),N.rj.vadd(B,N.rj),N.rj.vadd(L,N.rj),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),h.release(L),h.release(B),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),D=0;for(var F=I.length;D!==F;D++)h.release(I[D]);return}for(D=0;D!==b.length;D++){var z=h.get(),U=h.get();o.vmult(p[b[(D+1)%b.length]],z),o.vmult(p[b[(D+2)%b.length]],U),i.vadd(z,z),i.vadd(U,U);var k=ne;U.vsub(z,k);var G=ie;k.unit(G);var H=h.get(),V=h.get();n.vsub(z,V);var W=V.dot(G);G.mult(W,H),H.vadd(z,H);var q=h.get();if(H.vsub(n,q),W>0&&W*W<k.norm2()&&q.norm2()<d*d){if(u)return!0;for(N=this.createContactEquation(a,s,e,t,c,l),H.vsub(i,N.rj),H.vsub(n,N.ni),N.ni.normalize(),N.ni.mult(d,N.ri),N.rj.vadd(i,N.rj),N.rj.vsub(s.position,N.rj),N.ri.vadd(n,N.ri),N.ri.vsub(a.position,N.ri),this.result.push(N),this.createFrictionEquationsFromContact(N,this.frictionResult),D=0,F=I.length;D!==F;D++)h.release(I[D]);return h.release(z),h.release(U),h.release(H),h.release(q),void h.release(V)}h.release(z),h.release(U),h.release(H),h.release(q),h.release(V)}for(D=0,F=I.length;D!==F;D++)h.release(I[D])}}},new o,new o,h.prototype[i.types.PLANE|i.types.BOX]=h.prototype.planeBox=function(e,t,n,i,r,o,a,s,c,l,u){return t.convexPolyhedronRepresentation.material=t.material,t.convexPolyhedronRepresentation.collisionResponse=t.collisionResponse,t.convexPolyhedronRepresentation.id=t.id,this.planeConvex(e,t.convexPolyhedronRepresentation,n,i,r,o,a,s,e,t,u)};var he=new o,fe=new o,_e=new o,pe=new o;h.prototype[i.types.PLANE|i.types.CONVEXPOLYHEDRON]=h.prototype.planeConvex=function(e,t,n,i,r,o,a,s,c,l,u){var h=he,f=fe;f.set(0,0,1),r.vmult(f,f);for(var _=0,p=_e,d=0;d!==t.vertices.length;d++)if(h.copy(t.vertices[d]),o.vmult(h,h),i.vadd(h,h),h.vsub(n,p),f.dot(p)<=0){if(u)return!0;var m=this.createContactEquation(a,s,e,t,c,l),v=pe;f.mult(f.dot(p),v),h.vsub(v,v),v.vsub(n,m.ri),m.ni.copy(f),h.vsub(i,m.rj),m.ri.vadd(n,m.ri),m.ri.vsub(a.position,m.ri),m.rj.vadd(i,m.rj),m.rj.vsub(s.position,m.rj),this.result.push(m),_++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(m,this.frictionResult)}this.enableFrictionReduction&&_&&this.createFrictionFromAverage(_)};var de=new o,me=new o;h.prototype[i.types.CONVEXPOLYHEDRON]=h.prototype.convexConvex=function(e,t,n,i,r,o,a,s,c,l,u,h,f){var _=de;if(!(n.distanceTo(i)>e.boundingSphereRadius+t.boundingSphereRadius)&&e.findSeparatingAxis(t,n,r,i,o,_,h,f)){var p=[],d=me;e.clipAgainstHull(n,r,t,i,o,_,-100,100,p);for(var m=0,v=0;v!==p.length;v++){if(u)return!0;var g=this.createContactEquation(a,s,e,t,c,l),y=g.ri,x=g.rj;_.negate(g.ni),p[v].normal.negate(d),d.mult(p[v].depth,d),p[v].point.vadd(d,y),x.copy(p[v].point),y.vsub(n,y),x.vsub(i,x),y.vadd(n,y),y.vsub(a.position,y),x.vadd(i,x),x.vsub(s.position,x),this.result.push(g),m++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(g,this.frictionResult)}this.enableFrictionReduction&&m&&this.createFrictionFromAverage(m)}};var ve=new o,ge=new o,ye=new o;h.prototype[i.types.PLANE|i.types.PARTICLE]=h.prototype.planeParticle=function(e,t,n,i,r,o,a,s,c,l,u){var h=ve;h.set(0,0,1),a.quaternion.vmult(h,h);var f=ge;if(i.vsub(a.position,f),h.dot(f)<=0){if(u)return!0;var _=this.createContactEquation(s,a,t,e,c,l);_.ni.copy(h),_.ni.negate(_.ni),_.ri.set(0,0,0);var p=ye;h.mult(h.dot(i),p),i.vsub(p,p),_.rj.copy(p),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult)}};var xe=new o;h.prototype[i.types.PARTICLE|i.types.SPHERE]=h.prototype.sphereParticle=function(e,t,n,i,r,o,a,s,c,l,u){var h=xe;if(h.set(0,0,1),i.vsub(n,h),h.norm2()<=e.radius*e.radius){if(u)return!0;var f=this.createContactEquation(s,a,t,e,c,l);h.normalize(),f.rj.copy(h),f.rj.mult(e.radius,f.rj),f.ni.copy(h),f.ni.negate(f.ni),f.ri.set(0,0,0),this.result.push(f),this.createFrictionEquationsFromContact(f,this.frictionResult)}};var Se=new s,Te=new o,be=(new o,new o),Ee=new o,Ce=new o;h.prototype[i.types.PARTICLE|i.types.CONVEXPOLYHEDRON]=h.prototype.convexParticle=function(e,t,n,i,r,o,a,s,c,l,u){var h=-1,f=be,_=Ce,p=null,d=Te;if(d.copy(i),d.vsub(n,d),r.conjugate(Se),Se.vmult(d,d),e.pointIsInside(d)){e.worldVerticesNeedsUpdate&&e.computeWorldVertices(n,r),e.worldFaceNormalsNeedsUpdate&&e.computeWorldFaceNormals(r);for(var m=0,v=e.faces.length;m!==v;m++){var g=[e.worldVertices[e.faces[m][0]]],y=e.worldFaceNormals[m];i.vsub(g[0],Ee);var x=-y.dot(Ee);if(null===p||Math.abs(x)<Math.abs(p)){if(u)return!0;p=x,h=m,f.copy(y)}}if(-1!==h){var S=this.createContactEquation(s,a,t,e,c,l);f.mult(p,_),_.vadd(i,_),_.vsub(n,_),S.rj.copy(_),f.negate(S.ni),S.ri.set(0,0,0);var T=S.ri,b=S.rj;T.vadd(i,T),T.vsub(s.position,T),b.vadd(n,b),b.vsub(a.position,b),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},h.prototype[i.types.BOX|i.types.HEIGHTFIELD]=h.prototype.boxHeightfield=function(e,t,n,i,r,o,a,s,c,l,u){return e.convexPolyhedronRepresentation.material=e.material,e.convexPolyhedronRepresentation.collisionResponse=e.collisionResponse,this.convexHeightfield(e.convexPolyhedronRepresentation,t,n,i,r,o,a,s,e,t,u)};var Ae=new o,we=new o,Pe=[0];h.prototype[i.types.CONVEXPOLYHEDRON|i.types.HEIGHTFIELD]=h.prototype.convexHeightfield=function(e,t,n,i,r,o,s,c,l,u,h){var f=t.data,_=t.elementSize,p=e.boundingSphereRadius,d=we,m=Pe,v=Ae;a.pointToLocalFrame(i,o,n,v);var g=Math.floor((v.x-p)/_)-1,y=Math.ceil((v.x+p)/_)+1,x=Math.floor((v.y-p)/_)-1,S=Math.ceil((v.y+p)/_)+1;if(!(y<0||S<0||g>f.length||x>f[0].length)){g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),S<0&&(S=0),g>=f.length&&(g=f.length-1),y>=f.length&&(y=f.length-1),S>=f[0].length&&(S=f[0].length-1),x>=f[0].length&&(x=f[0].length-1);var T=[];t.getRectMinMax(g,x,y,S,T);var b=T[0],E=T[1];if(!(v.z-p>E||v.z+p<b))for(var C=g;C<y;C++)for(var A=x;A<S;A++){var w=!1;if(t.getConvexTrianglePillar(C,A,!1),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,n,d,r,o,s,c,l,u,h,m,null)),h&&w)return!0;if(t.getConvexTrianglePillar(C,A,!0),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(w=this.convexConvex(e,t.pillarConvex,n,d,r,o,s,c,l,u,h,m,null)),h&&w)return!0}}};var Re=new o,Ie=new o;h.prototype[i.types.SPHERE|i.types.HEIGHTFIELD]=h.prototype.sphereHeightfield=function(e,t,n,i,r,o,s,c,l,u,h){var f=t.data,_=e.radius,p=t.elementSize,d=Ie,m=Re;a.pointToLocalFrame(i,o,n,m);var v=Math.floor((m.x-_)/p)-1,g=Math.ceil((m.x+_)/p)+1,y=Math.floor((m.y-_)/p)-1,x=Math.ceil((m.y+_)/p)+1;if(!(g<0||x<0||v>f.length||y>f[0].length)){v<0&&(v=0),g<0&&(g=0),y<0&&(y=0),x<0&&(x=0),v>=f.length&&(v=f.length-1),g>=f.length&&(g=f.length-1),x>=f[0].length&&(x=f[0].length-1),y>=f[0].length&&(y=f[0].length-1);var S=[];t.getRectMinMax(v,y,g,x,S);var T=S[0],b=S[1];if(!(m.z-_>b||m.z+_<T))for(var E=this.result,C=v;C<g;C++)for(var A=y;A<x;A++){var w=E.length,P=!1;if(t.getConvexTrianglePillar(C,A,!1),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(P=this.sphereConvex(e,t.pillarConvex,n,d,r,o,s,c,e,t,h)),h&&P)return!0;if(t.getConvexTrianglePillar(C,A,!0),a.pointToWorldFrame(i,o,t.pillarOffset,d),n.distanceTo(d)<t.pillarConvex.boundingSphereRadius+e.boundingSphereRadius&&(P=this.sphereConvex(e,t.pillarConvex,n,d,r,o,s,c,e,t,h)),h&&P)return!0;if(E.length-w>2)return}}}},{"../collision/AABB":3,"../collision/Ray":10,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../math/Quaternion":29,"../math/Transform":30,"../math/Vec3":31,"../objects/Body":32,"../shapes/ConvexPolyhedron":39,"../shapes/Shape":44,"../solver/Solver":48,"../utils/Vec3Pool":55}],57:[function(e,t){t.exports=g,e("../shapes/Shape");var n=e("../math/Vec3"),i=e("../math/Quaternion"),r=e("../solver/GSSolver"),o=(e("../equations/ContactEquation"),e("../equations/FrictionEquation"),e("./Narrowphase")),a=e("../utils/EventTarget"),s=e("../collision/ArrayCollisionMatrix"),c=e("../collision/ObjectCollisionMatrix"),l=e("../collision/OverlapKeeper"),u=e("../material/Material"),h=e("../material/ContactMaterial"),f=e("../objects/Body"),_=e("../utils/TupleDictionary"),p=e("../collision/RaycastResult"),d=e("../collision/AABB"),m=e("../collision/Ray"),v=e("../collision/NaiveBroadphase");function g(e){e=e||{},a.apply(this),this.dt=-1,this.allowSleep=!!e.allowSleep,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=void 0!==e.quatNormalizeSkip?e.quatNormalizeSkip:0,this.quatNormalizeFast=void 0!==e.quatNormalizeFast&&e.quatNormalizeFast,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new n,e.gravity&&this.gravity.copy(e.gravity),this.broadphase=void 0!==e.broadphase?e.broadphase:new v,this.bodies=[],this.solver=void 0!==e.solver?e.solver:new r,this.constraints=[],this.narrowphase=new o(this),this.collisionMatrix=new s,this.collisionMatrixPrevious=new s,this.bodyOverlapKeeper=new l,this.shapeOverlapKeeper=new l,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new _,this.defaultMaterial=new u("default"),this.defaultContactMaterial=new h(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.accumulator=0,this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null},this.idToBodyMap={},this.broadphase.setWorld(this),this.substeps=0,this.cm=new c,this.tm=new c,this.triggerDic=new _,this.oldTriggerDic=new _,this.contactsDic=new _,this.oldContactsDic=new _}g.idToBodyMap={},g.idToShapeMap={},g.integrateKinematic=!1,g.ccdSphereAdvance=!1,g.prototype=new a,new d;var y=new m;if(g.prototype.getContactMaterial=function(e,t){return this.contactMaterialTable.get(e.id,t.id)},g.prototype.numObjects=function(){return this.bodies.length},g.prototype.collisionMatrixTick=function(){var e=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=e,this.collisionMatrix.reset(),this.bodyOverlapKeeper.tick(),this.shapeOverlapKeeper.tick()},g.prototype.add=g.prototype.addBody=function(e){-1===this.bodies.indexOf(e)&&(e.index=this.bodies.length,this.bodies.push(e),e.world=this,e.initPosition.copy(e.position),e.initVelocity.copy(e.velocity),e.timeLastSleepy=this.time,e instanceof f&&(e.initAngularVelocity.copy(e.angularVelocity),e.initQuaternion.copy(e.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=e,this.cm.setNumObjects(this.bodies.length),g.idToBodyMap[e.id]=e,this.dispatchEvent(this.addBodyEvent))},g.prototype.addConstraint=function(e){this.constraints.push(e)},g.prototype.removeConstraint=function(e){var t=this.constraints.indexOf(e);-1!==t&&this.constraints.splice(t,1)},g.prototype.rayTest=function(e,t,n){n instanceof p?this.raycastClosest(e,t,{skipBackfaces:!0},n):this.raycastAll(e,t,{skipBackfaces:!0},n)},g.prototype.raycastAll=function(e,t,n,i){return n.mode=m.ALL,n.from=e,n.to=t,n.callback=i,y.intersectWorld(this,n)},g.prototype.raycastAny=function(e,t,n,i){return n.mode=m.ANY,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},g.prototype.raycastClosest=function(e,t,n,i){return n.mode=m.CLOSEST,n.from=e,n.to=t,n.result=i,y.intersectWorld(this,n)},g.prototype.remove=function(e){e.world=null;var t=this.bodies.length-1,n=this.bodies,i=n.indexOf(e);if(-1!==i){n.splice(i,1);for(var r=0;r!==n.length;r++)n[r].index=r;this.collisionMatrix.setNumObjects(t),this.removeBodyEvent.body=e,delete g.idToBodyMap[e.id],this.cm.setNumObjects(t),this.dispatchEvent(this.removeBodyEvent)}},g.prototype.removeBody=g.prototype.remove,g.prototype.getBodyById=function(e){return g.idToBodyMap[e]},g.prototype.getShapeById=function(e){return g.idToShapeMap[e]},g.prototype.addMaterial=function(e){this.materials.push(e)},g.prototype.addContactMaterial=function(e){this.contactmaterials.push(e),this.contactMaterialTable.set(e.materials[0].id,e.materials[1].id,e)},"undefined"==typeof performance&&(performance={}),!performance.now){var x=Date.now();performance.timing&&performance.timing.navigationStart&&(x=performance.timing.navigationStart),performance.now=function(){return Date.now()-x}}g.prototype.saveKinematicAndApplyGravity=function(e){for(var t=this.bodies,n=this.bodies.length,i=0;i!==n;i++){var r=t[i];r.type===f.DYNAMIC?r.applyGravity(this.gravity):r.type===f.KINEMATIC&&r.updateKinematic(e)}},g.prototype.step=function(e,t,n){if(n=n||10,0===(t=t||0))this.saveKinematicAndApplyGravity(e),this.internalStep(e),this.time+=e,this.substeps=1;else{for(this.saveKinematicAndApplyGravity(t),this.accumulator+=t,this.substeps=0;this.accumulator>=e&&this.substeps<n;)this.internalStep(e),this.accumulator-=e,this.substeps++;for(var i=this.accumulator%e/e,r=0;r!==this.bodies.length;r++){var o=this.bodies[r];o.previousPosition.lerp(o.position,i,o.interpolatedPosition),o.previousQuaternion.slerp(o.quaternion,i,o.interpolatedQuaternion),o.previousQuaternion.normalize()}this.time+=t}this.clearForces()};var S,T,b,E,C,A,w={type:"postStep"},P={type:"preStep"},R={type:"collide",body:null,contact:null},I=[],D=[],O=[],M=[];new n,new n,new n,new n,new n,new n,new n,new n,new n,new i,new i,new i,new n,g.prototype.internalStep=function(e){this.dt=e;var t,n=this.contacts,i=O,r=M,o=this.numObjects(),a=this.bodies,s=this.solver,c=this.doProfiling,l=this.profile,u=f.DYNAMIC,h=this.constraints,_=D,p=0;c&&(t=performance.now()),p=0;for(var d=this.subsystems.length;p!==d;p++)this.subsystems[p].update();c&&(t=performance.now()),i.length=0,r.length=0,this.broadphase.collisionPairs(this,i,r),c&&(l.broadphase=performance.now()-t);var m=h.length;for(p=0;p!==m;p++)if(!(N=h[p]).collideConnected)for(var v=i.length-1;v>=0;v-=1)(N.bodyA===i[v]&&N.bodyB===r[v]||N.bodyB===i[v]&&N.bodyA===r[v])&&(i.splice(v,1),r.splice(v,1));this.collisionMatrixTick(),c&&(t=performance.now());var g=I,y=n.length;for(p=0;p!==y;p++)g.push(n[p]);n.length=0;var x=this.frictionEquations.length;for(p=0;p!==x;p++)_.push(this.frictionEquations[p]);for(this.frictionEquations.length=0,this.narrowphase.getContacts(i,r,this,n,g,this.frictionEquations,_),c&&(l.narrowphase=performance.now()-t),c&&(t=performance.now()),p=0;p<this.frictionEquations.length;p++)s.addEquation(this.frictionEquations[p]);for(var S=n.length,T=0;T!==S;T++){var b=(N=n[T]).bi,E=N.bj,C=N.si,A=N.sj;C.material&&A.material?C.material.restitution>=0&&A.material.restitution>=0&&(N.restitution=C.material.restitution*A.material.restitution):b.material&&E.material&&b.material.restitution>=0&&E.material.restitution>=0&&(N.restitution=b.material.restitution*E.material.restitution),s.addEquation(N),b.allowSleep&&b.type===f.DYNAMIC&&b.sleepState===f.SLEEPING&&E.sleepState===f.AWAKE&&E.type!==f.STATIC&&E.velocity.norm2()+E.angularVelocity.norm2()>=2*Math.pow(E.sleepSpeedLimit,2)&&(b._wakeUpAfterNarrowphase=!0),E.allowSleep&&E.type===f.DYNAMIC&&E.sleepState===f.SLEEPING&&b.sleepState===f.AWAKE&&b.type!==f.STATIC&&b.velocity.norm2()+b.angularVelocity.norm2()>=2*Math.pow(b.sleepSpeedLimit,2)&&(E._wakeUpAfterNarrowphase=!0),this.collisionMatrix.set(b,E,!0),this.collisionMatrixPrevious.get(b,E)||(R.body=E,R.contact=N,b.dispatchEvent(R),R.body=b,E.dispatchEvent(R)),this.bodyOverlapKeeper.set(b.id,E.id),this.shapeOverlapKeeper.set(C.id,A.id)}for(this.emitContactEvents(),c&&(l.makeContactConstraints=performance.now()-t,t=performance.now()),p=0;p!==o;p++)(b=a[p])._wakeUpAfterNarrowphase&&(b.wakeUp(),b._wakeUpAfterNarrowphase=!1);for(m=h.length,p=0;p!==m;p++){var N;(N=h[p]).update(),v=0;for(var L=N.equations.length;v!==L;v++){var B=N.equations[v];s.addEquation(B)}}for(s.solve(e,this),c&&(l.solve=performance.now()-t),s.removeAllEquations(),this.dispatchEvent(P),p=0;p!==o;p++)(b=a[p]).preStep&&b.preStep.call(b);c&&(t=performance.now());var F=this.stepnumber%(this.quatNormalizeSkip+1)==0,z=this.quatNormalizeFast;for(p=0;p!==o;p++)a[p].integrate(e,F,z);var U=Math.pow;for(p=0;p!==o;p++)if((b=a[p]).type&u){var k=U(1-b.linearDamping,e),G=b.velocity;G.mult(k,G);var H=b.angularVelocity;if(H){var V=U(1-b.angularDamping,e);H.mult(V,H)}}for(this.broadphase.dirty=!0,c&&(l.integrate=performance.now()-t),this.time+=e,this.stepnumber+=1,this.dispatchEvent(w),p=0;p!==o;p++){var W=(b=a[p]).postStep;W&&W.call(b)}if(this.allowSleep)for(p=0;p!==o;p++)a[p].sleepTick(this.time)},g.prototype.emitContactEvents=(S=[],T=[],b={type:"beginContact",bodyA:null,bodyB:null},E={type:"endContact",bodyA:null,bodyB:null},C={type:"beginShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},A={type:"endShapeContact",bodyA:null,bodyB:null,shapeA:null,shapeB:null},function(){var e=this.hasAnyEventListener("beginContact"),t=this.hasAnyEventListener("endContact");if((e||t)&&this.bodyOverlapKeeper.getDiff(S,T),e){for(var n=0,i=S.length;n<i;n+=2)b.bodyA=this.getBodyById(S[n]),b.bodyB=this.getBodyById(S[n+1]),this.dispatchEvent(b);b.bodyA=b.bodyB=null}if(t){for(n=0,i=T.length;n<i;n+=2)E.bodyA=this.getBodyById(T[n]),E.bodyB=this.getBodyById(T[n+1]),this.dispatchEvent(E);E.bodyA=E.bodyB=null}S.length=T.length=0;var r=this.hasAnyEventListener("beginShapeContact"),o=this.hasAnyEventListener("endShapeContact");if((r||o)&&this.shapeOverlapKeeper.getDiff(S,T),r){for(n=0,i=S.length;n<i;n+=2){var a=this.getShapeById(S[n]),s=this.getShapeById(S[n+1]);C.shapeA=a,C.shapeB=s,C.bodyA=a.body,C.bodyB=s.body,this.dispatchEvent(C)}C.bodyA=C.bodyB=C.shapeA=C.shapeB=null}if(o){for(n=0,i=T.length;n<i;n+=2)a=this.getShapeById(T[n]),s=this.getShapeById(T[n+1]),A.shapeA=a,A.shapeB=s,A.bodyA=a.body,A.bodyB=s.body,this.dispatchEvent(A);A.bodyA=A.bodyB=A.shapeA=A.shapeB=null}}),g.prototype.clearForces=function(){for(var e=this.bodies,t=e.length,n=0;n!==t;n++){var i=e[n];i.force,i.torque,i.force.set(0,0,0),i.torque.set(0,0,0)}};var N={type:"cc-trigger",event:"",selfBody:null,otherBody:null,selfShape:null,otherShape:null},L={type:"cc-collide",event:"",body:null,selfShape:null,otherShape:null,contacts:null},B=[];g.prototype.emitTriggeredEvents=function(){if(0!=this.substeps){for(var e,t,n=this.triggerDic.getLength();n--;)if(e=this.triggerDic.getKeyByIndex(n),null!=(t=this.triggerDic.getDataByKey(e))){var i=t.si,r=t.sj;this.tm.get(i,r)?N.event="onTriggerStay":(this.tm.set(i,r,!0),N.event="onTriggerEnter"),N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N)}for(n=this.oldTriggerDic.getLength();n>0;)n--,e=this.oldTriggerDic.getKeyByIndex(n),null==this.triggerDic.getDataByKey(e)&&null!=(t=this.oldTriggerDic.getDataByKey(e))&&(i=t.si,r=t.sj,this.tm.set(i,r,!1),this.oldTriggerDic.del(i.id,r.id)&&n--,N.event="onTriggerExit",N.selfShape=i,N.otherShape=r,N.selfBody=i.body,N.otherBody=r.body,i.dispatchEvent(N),N.selfShape=r,N.otherShape=i,N.selfBody=r.body,N.otherBody=i.body,r.dispatchEvent(N));this.triggerDic.reset()}},g.prototype.emitCollisionEvents=function(){if(0!=this.substeps){for(var e,t,n=this.contacts,i=this.contacts.length;i--;){var r=(u=n[i]).si,o=u.sj,a=this.contactsDic.get(r.id,o.id);null==a&&(a=this.contactsDic.set(r.id,o.id,[])),a.push(u)}for(i=this.contactsDic.getLength();i--;)if(e=this.contactsDic.getKeyByIndex(i),null!=(t=this.contactsDic.getDataByKey(e))){r=t[0].si,o=t[0].sj;var s=r.body,c=o.body;this.cm.get(s,c)?L.event="onCollisionStay":(this.cm.set(s,c,!0),L.event="onCollisionEnter"),L.bi=s,L.contact=t[0],L.contacts=t,L.body=c,L.selfShape=r,L.otherShape=o,s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L)}var l=B;for(i=l.length;i--;){var u;r=(u=l[i]).si,o=u.sj,null==this.oldContactsDic.get(r.id,o.id)&&this.oldContactsDic.set(r.id,o.id,u)}for(i=this.oldContactsDic.getLength();i--;)e=this.oldContactsDic.getKeyByIndex(i),null==this.contactsDic.getDataByKey(e)&&(r=(t=this.oldContactsDic.getDataByKey(e)).si,o=t.sj,s=r.body,c=o.body,this.cm.get(s,c)&&(s.isSleeping()&&c.isSleeping()||(this.cm.set(s,c,!1),L.bi=s,L.contact=t,L.event="onCollisionExit",L.body=c,L.selfShape=r,L.otherShape=o,L.contacts.length=0,L.contacts.push(t),s.dispatchEvent(L),L.body=s,L.selfShape=o,L.otherShape=r,c.dispatchEvent(L))));this.contactsDic.reset(),this.oldContactsDic.reset(),I=B,B=this.contacts.slice(),this.contacts.length=0}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/ObjectCollisionMatrix":8,"../collision/OverlapKeeper":9,"../collision/Ray":10,"../collision/RaycastResult":11,"../equations/ContactEquation":20,"../equations/FrictionEquation":22,"../material/ContactMaterial":25,"../material/Material":26,"../math/Quaternion":29,"../math/Vec3":31,"../objects/Body":32,"../shapes/Shape":44,"../solver/GSSolver":47,"../utils/EventTarget":50,"../utils/TupleDictionary":53,"./Narrowphase":56}]},{},[2])(2)}(t={exports:{}}),t.exports}();function Sde(e){u._global.CC_PHYSICS_BUILTIN="builtin"===e,u._global.CC_PHYSICS_CANNON="cannon.js"===e,u._global.CC_PHYSICS_AMMO="ammo.js"===e}!function(e){e[e.DYNAMIC=1]="DYNAMIC",e[e.STATIC=2]="STATIC",e[e.KINEMATIC=4]="KINEMATIC"}(_de||(_de=e("ERigidBodyType",{}))),st(_de),function(e){e[e.X_AXIS=0]="X_AXIS",e[e.Y_AXIS=1]="Y_AXIS",e[e.Z_AXIS=2]="Z_AXIS"}(pde||(pde=e("EAxisDirection",{}))),st(pde),function(e){e[e.VERTEX=1]="VERTEX",e[e.LINE=2]="LINE",e[e.TRIANGLE=3]="TRIANGLE",e[e.TETRAHEDRON=4]="TETRAHEDRON"}(dde||(dde={})),st(dde),function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CAPSULE=2]="CAPSULE",e[e.CYLINDER=3]="CYLINDER",e[e.CONE=4]="CONE",e[e.MESH=5]="MESH",e[e.PLANE=6]="PLANE",e[e.SIMPLEX=7]="SIMPLEX",e[e.TERRAIN=8]="TERRAIN"}(mde||(mde={})),st(mde),function(e){e[e.POINT_TO_POINT=0]="POINT_TO_POINT",e[e.HINGE=1]="HINGE",e[e.CONE_TWIST=2]="CONE_TWIST"}(vde||(vde={})),st(vde),function(e){e[e.DEFAULT=1]="DEFAULT"}(gde||(gde={})),st(gde);var Tde,bde={id:"",switchTo:function(e){if(bde.runInEditor){var t=bde;if(bde.physicsWorld&&e!==bde.id&&null!=bde.backend[e]?(bde.physicsWorld.destroy(),console.info("[PHYSICS]: switch from "+bde.id+" to "+e+"."),Sde(e),t.id=e,t.wrapper=bde.backend[e],t.physicsWorld=wde()):(console.info("[PHYSICS]: using "+e+"."),t.physicsWorld=wde()),yde){var n=t.physicsWorld;n.setGravity(yde.gravity),n.setAllowSleep(yde.allowSleep),n.setDefaultMaterial(yde.defaultMaterial)}}},register:function(e,t){if(console.info("[PHYSICS]: register "+e+"."),bde.backend[e]=t,!bde.physicsWorld||bde.id===e){Sde(e);var n=bde;n.id=e,n.wrapper=t}},wrapper:{},backend:{},physicsWorld:null,runInEditor:!0},Ede=function(){return 0},Cde={impl:null,setGravity:Ede,setAllowSleep:Ede,setDefaultMaterial:Ede,step:Ede,syncAfterEvents:Ede,syncSceneToPhysics:Ede,raycast:Ede,raycastClosest:Ede,emitEvents:Ede,destroy:Ede};function Ade(e,t){return null==e&&(bde.id?S(bde.id+" physics does not support "+Tde[t]):M(9600),!0)}function wde(){return Ade(bde.wrapper.PhysicsWorld,Tde.World)?Cde:new bde.wrapper.PhysicsWorld}!function(e){e[e.World=0]="World",e[e.RigidBody=1]="RigidBody",e[e.BoxCollider=2]="BoxCollider",e[e.SphereCollider=3]="SphereCollider",e[e.CapsuleCollider=4]="CapsuleCollider",e[e.MeshCollider=5]="MeshCollider",e[e.CylinderCollider=6]="CylinderCollider",e[e.ConeCollider=7]="ConeCollider",e[e.TerrainCollider=8]="TerrainCollider",e[e.SimplexCollider=9]="SimplexCollider",e[e.PlaneCollider=10]="PlaneCollider",e[e.PointToPointConstraint=11]="PointToPointConstraint",e[e.HingeConstraint=12]="HingeConstraint",e[e.ConeTwistConstraint=13]="ConeTwistConstraint"}(Tde||(Tde={}));var Pde={impl:null,rigidBody:null,isAwake:!1,isSleepy:!1,isSleeping:!1,initialize:Ede,onEnable:Ede,onDisable:Ede,onDestroy:Ede,setType:Ede,setMass:Ede,setLinearDamping:Ede,setAngularDamping:Ede,useGravity:Ede,setLinearFactor:Ede,setAngularFactor:Ede,setAllowSleep:Ede,wakeUp:Ede,sleep:Ede,clearState:Ede,clearForces:Ede,clearVelocity:Ede,setSleepThreshold:Ede,getSleepThreshold:Ede,getLinearVelocity:Ede,setLinearVelocity:Ede,getAngularVelocity:Ede,setAngularVelocity:Ede,applyForce:Ede,applyLocalForce:Ede,applyImpulse:Ede,applyLocalImpulse:Ede,applyTorque:Ede,applyLocalTorque:Ede,setGroup:Ede,getGroup:Ede,addGroup:Ede,removeGroup:Ede,setMask:Ede,getMask:Ede,addMask:Ede,removeMask:Ede,isUsingCCD:Ede,useCCD:Ede},Rde={INITED:!1},Ide={impl:null,collider:null,attachedRigidBody:null,initialize:Ede,onLoad:Ede,onEnable:Ede,onDisable:Ede,onDestroy:Ede,setGroup:Ede,getGroup:Ede,addGroup:Ede,removeGroup:Ede,setMask:Ede,getMask:Ede,addMask:Ede,removeMask:Ede,setMaterial:Ede,setAsTrigger:Ede,setCenter:Ede,getAABB:Ede,getBoundingSphere:Ede,updateSize:Ede,updateRadius:Ede,setRadius:Ede,setCylinderHeight:Ede,setDirection:Ede,setHeight:Ede,setShapeType:Ede,setVertices:Ede,setMesh:Ede,setTerrain:Ede,setNormal:Ede,setConstant:Ede,updateEventListener:Ede};var Dde,Ode,Mde,Nde,Lde,Bde,Fde,zde,Ude={INITED:!1},kde={impl:null,initialize:Ede,onLoad:Ede,onEnable:Ede,onDisable:Ede,onDestroy:Ede,setEnableCollision:Ede,setConnectedBody:Ede,setPivotA:Ede,setPivotB:Ede,setAxis:Ede};var Gde=function(t){return e({PhysicsMaterial:t,PhysicMaterial:t}),t}(mc("cc.PhysicsMaterial")((zde=Fde=function(e){function t(){var n;return(n=e.call(this)||this).id=void 0,ce(n,"_friction",Mde,oe(n)),ce(n,"_rollingFriction",Nde,oe(n)),ce(n,"_spinningFriction",Lde,oe(n)),ce(n,"_restitution",Bde,oe(n)),t.allMaterials.push(oe(n)),n.id=t._idCounter++,n._uuid||(n._uuid="pm_"+n.id),n}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t;return e._friction=this._friction,e._restitution=this._restitution,e._rollingFriction=this._rollingFriction,e._spinningFriction=this._spinningFriction,e},n.destroy=function(){if(e.prototype.destroy.call(this)){var n=t.allMaterials.indexOf(this);return n>=0&&t.allMaterials.splice(n,1),!0}return!1},n.setValues=function(e,n,i,r){var o=this._friction!==e||this._rollingFriction!==n||this._spinningFriction!==i||this._restitution!==r;this._friction=e,this._rollingFriction=n,this._spinningFriction=i,this._restitution=r,o&&this.emit(t.EVENT_UPDATE)},Z(t,[{key:"friction",get:function(){return this._friction},set:function(e){sn(this._friction,e)||(this._friction=e,this.emit(t.EVENT_UPDATE))}},{key:"rollingFriction",get:function(){return this._rollingFriction},set:function(e){sn(this._rollingFriction,e)||(this._rollingFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"spinningFriction",get:function(){return this._spinningFriction},set:function(e){sn(this._spinningFriction,e)||(this._spinningFriction=e,this.emit(t.EVENT_UPDATE))}},{key:"restitution",get:function(){return this._restitution},set:function(e){sn(this._restitution,e)||(this._restitution=e,this.emit(t.EVENT_UPDATE))}}]),t}(Nu),Fde.allMaterials=[],Fde.EVENT_UPDATE="event_update",Fde._idCounter=0,le((Ode=zde).prototype,"friction",[Mc],Object.getOwnPropertyDescriptor(Ode.prototype,"friction"),Ode.prototype),le(Ode.prototype,"rollingFriction",[Mc],Object.getOwnPropertyDescriptor(Ode.prototype,"rollingFriction"),Ode.prototype),le(Ode.prototype,"spinningFriction",[Mc],Object.getOwnPropertyDescriptor(Ode.prototype,"spinningFriction"),Ode.prototype),le(Ode.prototype,"restitution",[Mc],Object.getOwnPropertyDescriptor(Ode.prototype,"restitution"),Ode.prototype),Mde=le(Ode.prototype,"_friction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.6}}),Nde=le(Ode.prototype,"_rollingFriction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Lde=le(Ode.prototype,"_spinningFriction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Bde=le(Ode.prototype,"_restitution",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Dde=Ode))||Dde),Hde=e("PhysicsRayResult",function(){function e(){this._hitPoint=new In,this._hitNormal=new In,this._distance=0,this._collider=null}var t=e.prototype;return t._assign=function(e,t,n,i){In.copy(this._hitPoint,e),In.copy(this._hitNormal,i),this._distance=t,this._collider=n},t.clone=function(){var t=new e;return In.copy(t._hitPoint,this._hitPoint),In.copy(t._hitNormal,this._hitNormal),t._distance=this._distance,t._collider=this._collider,t},Z(e,[{key:"hitPoint",get:function(){return this._hitPoint}},{key:"distance",get:function(){return this._distance}},{key:"collider",get:function(){return this._collider}},{key:"hitNormal",get:function(){return this._hitNormal}}]),e}()),Vde=function(e){if(1===e){for(var t=this,n=function(e){var n="_"+(1<<e);t[n]=0,t.updateArray=[],Object.defineProperty(t,1<<e,{get:function(){return this[n]},set:function(t){this[n]!==t&&(this[n]=t,this.updateArray.indexOf(e)<0&&this.updateArray.push(e))}})},i=0;i<32;i++)n(i);this._1=gde.DEFAULT}else{for(var r=0;r<32;r++)this[""+(1<<r)]=0;this[1]=gde.DEFAULT}};u.internal.PhysicsGroup=gde;var Wde,jde,qde,Xde,Yde,Kde,Qde,Zde,Jde,$de,eme,tme,nme,ime,rme,ome,ame,sme,cme,lme,ume,hme,fme,_me,pme,dme,mme,vme,gme,yme,xme,Sme,Tme,bme,Eme,Cme,Ame,wme,Pme,Rme,Ime,Dme,Ome,Mme,Nme=e("PhysicsSystem",function(e){function t(){var t;return(t=e.call(this)||this).raycastClosestResult=new Hde,t.raycastResults=[],t.collisionMatrix=new Vde(1),t.minVolumeSize=1e-5,t.useNodeChains=!1,t._enable=!0,t._allowSleep=!0,t._maxSubSteps=1,t._subStepCount=0,t._fixedTimeStep=1/60,t._autoSimulation=!0,t._accumulator=0,t._sleepThreshold=.1,t._gravity=new In(0,-10,0),t._material=new Gde,t.raycastOptions={group:-1,mask:-1,queryTrigger:!0,maxDistance:1e7},t.raycastResultPool=new Xl((function(){return new Hde}),1),t._material.on(Gde.EVENT_UPDATE,t._updateMaterial,oe(t)),t}$(t,e);var n=t.prototype;return n.postUpdate=function(e){if(this.physicsWorld)if(this._enable){if(this._autoSimulation){for(this._subStepCount=0,this._accumulator+=e,jM.emit(WM.EVENT_BEFORE_PHYSICS);this._subStepCount<this._maxSubSteps;){if(!(this._accumulator>=this._fixedTimeStep)){this.physicsWorld.syncSceneToPhysics();break}this.physicsWorld.syncSceneToPhysics(),this.physicsWorld.step(this._fixedTimeStep),this.physicsWorld.emitEvents(),this.physicsWorld.syncAfterEvents(),this._accumulator-=this._fixedTimeStep,this._subStepCount++}jM.emit(WM.EVENT_AFTER_PHYSICS)}}else this.physicsWorld.syncSceneToPhysics()},n.resetConfiguration=function(e){var t=e||(VM.config?VM.config.physics:null);if(t){if("boolean"==typeof t.allowSleep&&(this._allowSleep=t.allowSleep),"number"==typeof t.fixedTimeStep&&(this._fixedTimeStep=t.fixedTimeStep),"number"==typeof t.maxSubSteps&&(this._maxSubSteps=t.maxSubSteps),"number"==typeof t.sleepThreshold&&(this._sleepThreshold=t.sleepThreshold),"boolean"==typeof t.autoSimulation&&(this.autoSimulation=t.autoSimulation),t.gravity&&In.copy(this._gravity,t.gravity),t.defaultMaterial&&this._material.setValues(t.defaultMaterial.friction,t.defaultMaterial.rollingFriction,t.defaultMaterial.spinningFriction,t.defaultMaterial.restitution),t.collisionMatrix)for(var n in t.collisionMatrix)this.collisionMatrix[""+(1<<parseInt(n))]=t.collisionMatrix[n];if(t.collisionGroups){var i=t.collisionGroups;i instanceof Array&&(i.forEach((function(e){gde[e.name]=1<<e.index})),st.update(gde))}}this.physicsWorld&&(this.physicsWorld.setGravity(this._gravity),this.physicsWorld.setAllowSleep(this._allowSleep),this.physicsWorld.setDefaultMaterial(this._material))},n.resetAccumulator=function(e){void 0===e&&(e=0),this._accumulator=e},n.step=function(e,t,n){this.physicsWorld&&this.physicsWorld.step(e,t,n)},n.syncSceneToPhysics=function(){this.physicsWorld&&this.physicsWorld.syncSceneToPhysics()},n.emitEvents=function(){this.physicsWorld&&this.physicsWorld.emitEvents()},n.raycast=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastResultPool.reset(),this.raycastResults.length=0,this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycast(e,this.raycastOptions,this.raycastResultPool,this.raycastResults))},n.raycastClosest=function(e,t,n,i){return void 0===t&&(t=4294967295),void 0===n&&(n=1e7),void 0===i&&(i=!0),!!this.physicsWorld&&(this.raycastOptions.mask=t>>>0,this.raycastOptions.maxDistance=n,this.raycastOptions.queryTrigger=i,this.physicsWorld.raycastClosest(e,this.raycastOptions,this.raycastClosestResult))},n._updateMaterial=function(){this.physicsWorld&&this.physicsWorld.setDefaultMaterial(this._material)},t.constructAndRegister=function(){if(!t._instance){var e=new t;e.resetConfiguration(),function(e){if(yde||(yde=e),bde.runInEditor&&!bde.physicsWorld){console.info("[PHYSICS]: using "+bde.id+".");var t=bde.physicsWorld=wde();t.setGravity(yde.gravity),t.setAllowSleep(yde.allowSleep),t.setDefaultMaterial(yde.defaultMaterial)}}(e),t._instance=e,jM.registerSystem(t.ID,e,e.priority)}},Z(t,[{key:"enable",get:function(){return this._enable},set:function(e){this._enable=e}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this.physicsWorld&&this.physicsWorld.setAllowSleep(e)}},{key:"maxSubSteps",get:function(){return this._maxSubSteps},set:function(e){this._maxSubSteps=e}},{key:"fixedTimeStep",get:function(){return this._fixedTimeStep},set:function(e){this._fixedTimeStep=e}},{key:"gravity",get:function(){return this._gravity},set:function(e){this._gravity.set(e),this.physicsWorld&&this.physicsWorld.setGravity(e)}},{key:"sleepThreshold",get:function(){return this._sleepThreshold},set:function(e){this._sleepThreshold=e}},{key:"autoSimulation",get:function(){return this._autoSimulation},set:function(e){this._autoSimulation=e}},{key:"defaultMaterial",get:function(){return this._material}},{key:"physicsWorld",get:function(){return bde.physicsWorld}}],[{key:"PHYSICS_NONE",get:function(){return!bde.id}},{key:"PHYSICS_BUILTIN",get:function(){return"builtin"===bde.id}},{key:"PHYSICS_CANNON",get:function(){return"cannon.js"===bde.id}},{key:"PHYSICS_BULLET",get:function(){return"bullet"===bde.id}},{key:"PHYSICS_PHYSX",get:function(){return"physx"===bde.id}},{key:"PhysicsGroup",get:function(){return gde}},{key:"instance",get:function(){return t._instance}}]),t}(DM));Nme.ID="PHYSICS",Nme._instance=null,jM.once(WM.EVENT_INIT,(function(){Nme.constructAndRegister()}));var Lme,Bme,Fme,zme,Ume,kme,Gme,Hme,Vme,Wme,jme,qme,Xme,Yme,Kme,Qme,Zme,Jme,$me,eve,tve,nve,ive=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}((Wde=mc("cc.RigidBody"),jde=Oc(),qde=Pc(),Xde=gc(-1),Yde=Zc(Nme.PhysicsGroup),Kde=Vc(),Qde=Fc(),Zde=Zc(_de),Jde=Vc(),$de=Fc(),eme=Nc(),tme=Vc(),nme=Fc(),ime=Nc(),rme=Vc(),ome=Fc(),ame=Nc(),sme=Vc(),cme=Fc(),lme=Nc(),ume=Vc(),hme=Fc(),fme=Nc(),_me=Vc(),pme=Fc(),dme=Nc(),mme=Vc(),vme=Fc(),gme=Nc(),yme=Vc(),xme=Fc(),Wde(Sme=jde(Sme=qde(Sme=wc(Sme=yc(Sme=Xde((Mme=Ome=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._body=null,ce(t,"_group",bme,oe(t)),ce(t,"_type",Eme,oe(t)),ce(t,"_mass",Cme,oe(t)),ce(t,"_allowSleep",Ame,oe(t)),ce(t,"_linearDamping",wme,oe(t)),ce(t,"_angularDamping",Pme,oe(t)),ce(t,"_useGravity",Rme,oe(t)),ce(t,"_linearFactor",Ime,oe(t)),ce(t,"_angularFactor",Dme,oe(t)),t}$(t,e);var n=t.prototype;return n.onLoad=function(){bde.runInEditor&&(this._body=Ade(bde.wrapper.RigidBody,Tde.RigidBody)?Pde:new bde.wrapper.RigidBody,this._body.initialize(this))},n.onEnable=function(){this._body&&this._body.onEnable()},n.onDisable=function(){this._body&&this._body.onDisable()},n.onDestroy=function(){this._body&&this._body.onDestroy()},n.applyForce=function(e,t){this._isInitialized&&this._body.applyForce(e,t)},n.applyLocalForce=function(e,t){this._isInitialized&&this._body.applyLocalForce(e,t)},n.applyImpulse=function(e,t){this._isInitialized&&this._body.applyImpulse(e,t)},n.applyLocalImpulse=function(e,t){this._isInitialized&&this._body.applyLocalImpulse(e,t)},n.applyTorque=function(e){this._isInitialized&&this._body.applyTorque(e)},n.applyLocalTorque=function(e){this._isInitialized&&this._body.applyLocalTorque(e)},n.wakeUp=function(){this._isInitialized&&this._body.wakeUp()},n.sleep=function(){this._isInitialized&&this._body.sleep()},n.clearState=function(){this._isInitialized&&this._body.clearState()},n.clearForces=function(){this._isInitialized&&this._body.clearForces()},n.clearVelocity=function(){this._isInitialized&&this._body.clearVelocity()},n.getLinearVelocity=function(e){this._isInitialized&&this._body.getLinearVelocity(e)},n.setLinearVelocity=function(e){this._isInitialized&&this._body.setLinearVelocity(e)},n.getAngularVelocity=function(e){this._isInitialized&&this._body.getAngularVelocity(e)},n.setAngularVelocity=function(e){this._isInitialized&&this._body.setAngularVelocity(e)},n.getGroup=function(){return this._isInitialized?this._body.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._body.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._body.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._body.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._body.getMask():0},n.setMask=function(e){this._isInitialized&&this._body.setMask(e)},n.addMask=function(e){this._isInitialized&&this._body.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._body.removeMask(e)},Z(t,[{key:"group",get:function(){return this._group},set:function(e){this._group=e,this._body&&this._body.getGroup()!==e&&this._body.setGroup(e)}},{key:"type",get:function(){return this._type},set:function(e){this._type!==e&&(this._type=e,this._body&&this._body.setType(e))}},{key:"mass",get:function(){return this._mass},set:function(e){this._mass!==e&&(e=e<=0?1e-4:e,this._mass=e,this._body&&this._body.setMass(e))}},{key:"allowSleep",get:function(){return this._allowSleep},set:function(e){this._allowSleep=e,this._body&&this._body.setAllowSleep(e)}},{key:"linearDamping",get:function(){return this._linearDamping},set:function(e){this._linearDamping=e,this._body&&this._body.setLinearDamping(e)}},{key:"angularDamping",get:function(){return this._angularDamping},set:function(e){this._angularDamping=e,this._body&&this._body.setAngularDamping(e)}},{key:"useGravity",get:function(){return this._useGravity},set:function(e){this._useGravity=e,this._body&&this._body.useGravity(e)}},{key:"linearFactor",get:function(){return this._linearFactor},set:function(e){In.copy(this._linearFactor,e),this._body&&this._body.setLinearFactor(this._linearFactor)}},{key:"angularFactor",get:function(){return this._angularFactor},set:function(e){In.copy(this._angularFactor,e),this._body&&this._body.setAngularFactor(this._angularFactor)}},{key:"sleepThreshold",get:function(){return this._isInitialized?this._body.getSleepThreshold():.1},set:function(e){this._isInitialized&&this._body.setSleepThreshold(e)}},{key:"useCCD",get:function(){return!!this._isInitialized&&this._body.isUsingCCD()},set:function(e){this._isInitialized&&this._body.useCCD(e)}},{key:"isAwake",get:function(){return!!this._isInitialized&&this._body.isAwake}},{key:"isSleepy",get:function(){return!!this._isInitialized&&this._body.isSleepy}},{key:"isSleeping",get:function(){return!!this._isInitialized&&this._body.isSleeping}},{key:"isStatic",get:function(){return this._type===_de.STATIC},set:function(e){e&&this.isStatic||!e&&!this.isStatic||(this.type=e?_de.STATIC:_de.DYNAMIC)}},{key:"isDynamic",get:function(){return this._type===_de.DYNAMIC},set:function(e){e&&this.isDynamic||!e&&!this.isDynamic||(this.type=e?_de.DYNAMIC:_de.KINEMATIC)}},{key:"isKinematic",get:function(){return this._type===_de.KINEMATIC},set:function(e){e&&this.isKinematic||!e&&!this.isKinematic||(this.type=e?_de.KINEMATIC:_de.DYNAMIC)}},{key:"body",get:function(){return this._body}},{key:"_isInitialized",get:function(){var e=null===this._body;return e&&T("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(th),Ome.Type=_de,le((Tme=Mme).prototype,"group",[Yde,Kde,Qde],Object.getOwnPropertyDescriptor(Tme.prototype,"group"),Tme.prototype),le(Tme.prototype,"type",[Zde,Jde,$de],Object.getOwnPropertyDescriptor(Tme.prototype,"type"),Tme.prototype),le(Tme.prototype,"mass",[eme,tme,nme],Object.getOwnPropertyDescriptor(Tme.prototype,"mass"),Tme.prototype),le(Tme.prototype,"allowSleep",[ime,rme,ome],Object.getOwnPropertyDescriptor(Tme.prototype,"allowSleep"),Tme.prototype),le(Tme.prototype,"linearDamping",[ame,sme,cme],Object.getOwnPropertyDescriptor(Tme.prototype,"linearDamping"),Tme.prototype),le(Tme.prototype,"angularDamping",[lme,ume,hme],Object.getOwnPropertyDescriptor(Tme.prototype,"angularDamping"),Tme.prototype),le(Tme.prototype,"useGravity",[fme,_me,pme],Object.getOwnPropertyDescriptor(Tme.prototype,"useGravity"),Tme.prototype),le(Tme.prototype,"linearFactor",[dme,mme,vme],Object.getOwnPropertyDescriptor(Tme.prototype,"linearFactor"),Tme.prototype),le(Tme.prototype,"angularFactor",[gme,yme,xme],Object.getOwnPropertyDescriptor(Tme.prototype,"angularFactor"),Tme.prototype),bme=le(Tme.prototype,"_group",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Nme.PhysicsGroup.DEFAULT}}),Eme=le(Tme.prototype,"_type",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _de.DYNAMIC}}),Cme=le(Tme.prototype,"_mass",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Ame=le(Tme.prototype,"_allowSleep",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),wme=le(Tme.prototype,"_linearDamping",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Pme=le(Tme.prototype,"_angularDamping",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),Rme=le(Tme.prototype,"_useGravity",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Ime=le(Tme.prototype,"_linearFactor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(1,1,1)}}),Dme=le(Tme.prototype,"_angularFactor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(1,1,1)}}),Sme=Tme))||Sme)||Sme)||Sme)||Sme)||Sme)||Sme));ive||(ive=function(t){return e({RigidBody:t,RigidBodyComponent:t}),t}({}));var rve=function(t){return e({Collider:t,ColliderComponent:t}),t}((Lme=mc("cc.Collider"),Bme=Zc(ive),Fme=Bc(),zme=Vc(),Ume=Fc(),kme=Zc(Gde),Gme=Bc(),Hme=Vc(),Vme=Fc(),Wme=Vc(),jme=Fc(),qme=Zc(In),Xme=Vc(),Yme=Fc(),Kme=Zc(Gde),Lme((nve=tve=function(e){function t(t){var n;return(n=e.call(this)||this).type=void 0,n._shape=null,n._aabb=null,n._boundingSphere=null,n._isSharedMaterial=!0,n._needTriggerEvent=!1,n._needCollisionEvent=!1,ce(n,"_material",Jme,oe(n)),ce(n,"_isTrigger",$me,oe(n)),ce(n,"_center",eve,oe(n)),n.type=t,n}$(t,e);var n=t.prototype;return n.on=function(t,n,i,r){var o=e.prototype.on.call(this,t,n,i,r);return this._updateNeedEvent(t),o},n.off=function(t,n,i){e.prototype.off.call(this,t,n,i),this._updateNeedEvent()},n.once=function(t,n,i){var r=e.prototype.once.call(this,t,n,i);return this._updateNeedEvent(t),r},n.removeAll=function(t){e.prototype.removeAll.call(this,t),this._updateNeedEvent()},n.getGroup=function(){return this._isInitialized?this._shape.getGroup():0},n.setGroup=function(e){this._isInitialized&&this._shape.setGroup(e)},n.addGroup=function(e){this._isInitialized&&this._shape.addGroup(e)},n.removeGroup=function(e){this._isInitialized&&this._shape.removeGroup(e)},n.getMask=function(){return this._isInitialized?this._shape.getMask():0},n.setMask=function(e){this._isInitialized&&this._shape.setMask(e)},n.addMask=function(e){this._isInitialized&&this._shape.addMask(e)},n.removeMask=function(e){this._isInitialized&&this._shape.removeMask(e)},n.onLoad=function(){bde.runInEditor&&(this.sharedMaterial=null==this._material?Nme.instance.defaultMaterial:this._material,this._shape=function(e){return Rde.INITED||(Rde.INITED=!0,Rde[mde.BOX]=function(){return Ade(bde.wrapper.BoxShape,Tde.BoxCollider)?Ide:new bde.wrapper.BoxShape},Rde[mde.SPHERE]=function(){return Ade(bde.wrapper.SphereShape,Tde.SphereCollider)?Ide:new bde.wrapper.SphereShape},Rde[mde.CAPSULE]=function(){return Ade(bde.wrapper.CapsuleShape,Tde.CapsuleCollider)?Ide:new bde.wrapper.CapsuleShape},Rde[mde.CYLINDER]=function(){return Ade(bde.wrapper.CylinderShape,Tde.CylinderCollider)?Ide:new bde.wrapper.CylinderShape},Rde[mde.CONE]=function(){return Ade(bde.wrapper.ConeShape,Tde.ConeCollider)?Ide:new bde.wrapper.ConeShape},Rde[mde.MESH]=function(){return Ade(bde.wrapper.TrimeshShape,Tde.MeshCollider)?Ide:new bde.wrapper.TrimeshShape},Rde[mde.TERRAIN]=function(){return Ade(bde.wrapper.TerrainShape,Tde.TerrainCollider)?Ide:new bde.wrapper.TerrainShape},Rde[mde.SIMPLEX]=function(){return Ade(bde.wrapper.SimplexShape,Tde.SimplexCollider)?Ide:new bde.wrapper.SimplexShape},Rde[mde.PLANE]=function(){return Ade(bde.wrapper.PlaneShape,Tde.PlaneCollider)?Ide:new bde.wrapper.PlaneShape}),Rde[e]()}(this.type),this._shape.initialize(this),this._shape.onLoad())},n.onEnable=function(){this._shape&&this._shape.onEnable()},n.onDisable=function(){this._shape&&this._shape.onDisable()},n.onDestroy=function(){this._shape&&(this._needTriggerEvent=!1,this._needCollisionEvent=!1,this._shape.updateEventListener(),this._material&&this._material.off(Gde.EVENT_UPDATE,this._updateMaterial,this),this._shape.onDestroy()),this._boundingSphere&&this._boundingSphere.destroy()},n._updateMaterial=function(){this._shape&&this._shape.setMaterial(this._material)},n._updateNeedEvent=function(e){this.isValid&&(void 0!==e?("onCollisionEnter"!==e&&"onCollisionStay"!==e&&"onCollisionExit"!==e||(this._needCollisionEvent=!0),"onTriggerEnter"!==e&&"onTriggerStay"!==e&&"onTriggerExit"!==e||(this._needTriggerEvent=!0)):(this.hasEventListener("onTriggerEnter")||this.hasEventListener("onTriggerStay")||this.hasEventListener("onTriggerExit")||(this._needTriggerEvent=!1),this.hasEventListener("onCollisionEnter")||this.hasEventListener("onCollisionStay")||this.hasEventListener("onCollisionExit")||(this._needCollisionEvent=!1)),this._shape&&this._shape.updateEventListener())},Z(t,[{key:"attachedRigidBody",get:function(){return e=this.node,(t=e.getComponent(ive))&&t.isValid?t:null;var e,t}},{key:"sharedMaterial",get:function(){return this._material},set:function(e){this.material=e}},{key:"material",get:function(){return this._isSharedMaterial&&this._material&&(this._material.off(Gde.EVENT_UPDATE,this._updateMaterial,this),this._material=this._material.clone(),this._material.on(Gde.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1),this._material},set:function(e){this._shape?(e&&this._material?this._material.id!==e.id&&(this._material.off(Gde.EVENT_UPDATE,this._updateMaterial,this),e.on(Gde.EVENT_UPDATE,this._updateMaterial,this),this._isSharedMaterial=!1,this._material=e):e&&!this._material?(e.on(Gde.EVENT_UPDATE,this._updateMaterial,this),this._material=e):!e&&this._material&&(this._material.off(Gde.EVENT_UPDATE,this._updateMaterial,this),this._material=e),this._updateMaterial()):this._material=e}},{key:"isTrigger",get:function(){return this._isTrigger},set:function(e){this._isTrigger=e,this._shape&&this._shape.setAsTrigger(this._isTrigger)}},{key:"center",get:function(){return this._center},set:function(e){In.copy(this._center,e),this._shape&&this._shape.setCenter(this._center)}},{key:"shape",get:function(){return this._shape}},{key:"worldBounds",get:function(){return null==this._aabb&&(this._aabb=new Xs),this._shape&&this._shape.getAABB(this._aabb),this._aabb}},{key:"boundingSphere",get:function(){return null==this._boundingSphere&&(this._boundingSphere=new la),this._shape&&this._shape.getBoundingSphere(this._boundingSphere),this._boundingSphere}},{key:"needTriggerEvent",get:function(){return this._needTriggerEvent}},{key:"needCollisionEvent",get:function(){return this._needCollisionEvent}},{key:"_isInitialized",get:function(){var e=null===this._shape;return e&&T("[Physics]: This component has not been call onLoad yet, please make sure the node has been added to the scene."),!e}}]),t}(nu(th)),tve.Type=mde,tve.Axis=pde,le((Zme=nve).prototype,"attachedRigidBody",[Bme,Lc,Fme,zme,Ume],Object.getOwnPropertyDescriptor(Zme.prototype,"attachedRigidBody"),Zme.prototype),le(Zme.prototype,"sharedMaterial",[kme,Gme,Hme,Vme],Object.getOwnPropertyDescriptor(Zme.prototype,"sharedMaterial"),Zme.prototype),le(Zme.prototype,"isTrigger",[Wme,jme],Object.getOwnPropertyDescriptor(Zme.prototype,"isTrigger"),Zme.prototype),le(Zme.prototype,"center",[qme,Xme,Yme],Object.getOwnPropertyDescriptor(Zme.prototype,"center"),Zme.prototype),Jme=le(Zme.prototype,"_material",[Kme],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$me=le(Zme.prototype,"_isTrigger",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),eve=le(Zme.prototype,"_center",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),Qme=Zme))||Qme));function ove(e){return void 0===(e=e||{}).includeNormal&&(e.includeNormal=!0),void 0===e.includeUV&&(e.includeUV=!0),e}rve||(rve=function(t){return e({Collider:t,ColliderComponent:t}),t}({}));var ave=new In,sve=new In,cve=new In,lve=new In,uve=new In,hve=new In,fve=new In,_ve=new In,pve=new In,dve=new In,mve=new In,vve=new In,gve=new In(0,0,0),yve=new In(0,0,0);function xve(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=.5*n,o=i.radialSegments||32,a=i.heightSegments||1,s=void 0===i.capped||i.capped,c=i.arc||2*Math.PI,l=0;s||(e>0&&l++,t>0&&l++);var u=(o+1)*(a+1);s&&(u+=(o+1)*l+o*l);var h=o*a*6;s&&(h+=o*l*3);var f=new Array(h),_=new Array(3*u),p=new Array(3*u),d=new Array(2*u),m=Math.max(e,t),v=new In(-m,-r,-m),g=new In(m,r,m),y=Math.sqrt(m*m+r*r),x=0,S=0;return function(){for(var i=[],s=e-t,l=s*s/n*Math.sign(s),u=0;u<=a;u++){for(var h=[],m=u/a,v=m*s+t,g=0;g<=o;++g){var y=g/o,T=y*c,b=Math.sin(T),E=Math.cos(T);_[3*x]=v*b,_[3*x+1]=m*n-r,_[3*x+2]=v*E,In.normalize(gve,In.set(yve,b,-l,E)),p[3*x]=gve.x,p[3*x+1]=gve.y,p[3*x+2]=gve.z,d[2*x]=2*(1-y)%1,d[2*x+1]=m,h.push(x),++x}i.push(h)}for(var C=0;C<a;++C)for(var A=0;A<o;++A){var w=i[C][A],P=i[C+1][A],R=i[C+1][A+1],I=i[C][A+1];f[S]=w,++S,f[S]=I,++S,f[S]=P,++S,f[S]=I,++S,f[S]=R,++S,f[S]=P,++S}}(),s&&(t>0&&T(!1),e>0&&T(!0)),{positions:_,normals:p,uvs:d,indices:f,minPos:v,maxPos:g,boundingRadius:y};function T(n){for(var i=n?e:t,a=n?1:-1,s=x,l=1;l<=o;++l)_[3*x]=0,_[3*x+1]=r*a,_[3*x+2]=0,p[3*x]=0,p[3*x+1]=a,p[3*x+2]=0,d[2*x]=.5,d[2*x+1]=.5,++x;for(var u=x,h=0;h<=o;++h){var m=h/o*c,v=Math.cos(m),g=Math.sin(m);_[3*x]=i*g,_[3*x+1]=r*a,_[3*x+2]=i*v,p[3*x]=0,p[3*x+1]=a,p[3*x+2]=0,d[2*x]=.5-.5*g*a,d[2*x+1]=.5+.5*v,++x}for(var y=0;y<o;++y){var T=s+y,b=u+y;n?(f[S]=b+1,++S,f[S]=T,++S,f[S]=b,++S):(f[S]=T,++S,f[S]=b+1,++S,f[S]=b,++S)}}}var Sve=new In(0,0,0),Tve=new In(0,0,0),bve=new In(0,0,0),Eve=new In(0,0,0),Cve=new In(0,0,0),Ave=new In(0,0,0),wve=new In(0,0,0),Pve=new In(0,0,0),Rve=new In(0,0,0),Ive=Object.freeze({__proto__:null,box:function(e){var t=(e=e||{}).widthSegments||1,n=e.heightSegments||1,i=e.lengthSegments||1,r=(e.width||1)/2,o=(e.height||1)/2,a=(e.length||1)/2,s=[In.set(uve,-r,-o,a),In.set(hve,r,-o,a),In.set(fve,r,o,a),In.set(_ve,-r,o,a),In.set(pve,r,-o,-a),In.set(dve,-r,-o,-a),In.set(mve,-r,o,-a),In.set(vve,r,o,-a)],c=[[2,3,1],[4,5,7],[7,6,2],[1,0,4],[1,4,2],[5,0,6]],l=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],u=[[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[-1,0,0,1],[0,0,-1,1],[0,0,1,1]],h=[],f=[],_=[],p=[],d=[],m=new In(-r,-o,-a),v=new In(r,o,a),g=Math.sqrt(r*r+o*o+a*a);function y(e,t,n){var i,r,o,a,m=h.length/3,v=c[e],g=l[e],y=u[e];for(a=0;a<=n;a++)for(o=0;o<=t;o++)if(i=o/t,r=a/n,In.lerp(ave,s[v[0]],s[v[1]],i),In.lerp(sve,s[v[0]],s[v[2]],r),In.subtract(cve,sve,s[v[0]]),In.add(lve,ave,cve),h.push(lve.x,lve.y,lve.z),f.push(g[0],g[1],g[2]),_.push(i,r),p.push(y[0],y[1],y[2],y[3]),o<t&&a<n){var x=t+1,S=o+a*x,T=o+(a+1)*x,b=o+1+(a+1)*x,E=o+1+a*x;d.push(m+S,m+E,m+T),d.push(m+T,m+E,m+b)}}return y(0,t,n),y(4,i,n),y(1,t,n),y(5,i,n),y(3,t,i),y(2,t,i),{positions:h,normals:f,uvs:_,tangents:p,indices:d,minPos:m,maxPos:v,boundingRadius:g}},cone:function(e,t,n){return void 0===e&&(e=.5),void 0===t&&(t=1),void 0===n&&(n={}),xve(0,e,t,n)},cylinder:xve,plane:function(e){var t=function(e){return(e=ove(e)).width=e.width||10,e.length=e.length||10,e.widthSegments=e.widthSegments||10,e.lengthSegments=e.lengthSegments||10,e}(e),n=t.width,i=t.length,r=t.widthSegments,o=t.lengthSegments,a=.5*n,s=.5*i,c=[],l=[],u=[],h=new In(-a,0,-s),f=new In(a,0,s),_=Math.sqrt(n*n+i*i);In.set(Cve,-a,0,s),In.set(Ave,a,0,s),In.set(wve,-a,0,-s);for(var p=0;p<=o;p++)for(var d=0;d<=r;d++){var m=d/r,v=p/o;if(In.lerp(Sve,Cve,Ave,m),In.lerp(Tve,Cve,wve,v),In.subtract(bve,Tve,Cve),In.add(Eve,Sve,bve),c.push(Eve.x,Eve.y,Eve.z),t.includeUV&&l.push(m,v),d<r&&p<o){var g=r+1,y=d+p*g,x=d+(p+1)*g,S=d+1+(p+1)*g,T=d+1+p*g;u.push(y,T,x),u.push(T,S,x)}}var b={positions:c,indices:u,minPos:h,maxPos:f,boundingRadius:_};if(t.includeNormal){var E=(o+1)*(r+1),C=new Array(3*E);b.normals=C;for(var A=0;A<E;++A)C[3*A+0]=0,C[3*A+1]=1,C[3*A+2]=0}return t.includeUV&&(b.uvs=l),b},quad:function(e){var t=ove(e),n={positions:[-.5,-.5,0,-.5,.5,0,.5,.5,0,.5,-.5,0],indices:[0,3,1,3,2,1],minPos:{x:-.5,y:-.5,z:0},maxPos:{x:.5,y:.5,z:0},boundingRadius:Math.sqrt(.5)};return!1!==t.includeNormal&&(n.normals=[0,0,1,0,0,1,0,0,1,0,0,1]),!1!==t.includeUV&&(n.uvs=[0,0,0,1,1,1,1,0]),n},sphere:function(e,t){void 0===e&&(e=.5),void 0===t&&(t={});for(var n=void 0!==t.segments?t.segments:32,i=[],r=[],o=[],a=[],s=new In(-e,-e,-e),c=new In(e,e,e),l=e,u=0;u<=n;++u)for(var h=u*Math.PI/n,f=Math.sin(h),_=-Math.cos(h),p=0;p<=n;++p){var d=2*p*Math.PI/n-Math.PI/2,m=Math.sin(d)*f,v=_,g=Math.cos(d)*f,y=p/n,x=u/n;if(i.push(m*e,v*e,g*e),r.push(m,v,g),o.push(y,x),u<n&&p<n){var S=n+1,T=S*u+p,b=S*(u+1)+p,E=S*(u+1)+p+1,C=S*u+p+1;a.push(T,C,b),a.push(C,E,b)}}return{positions:i,indices:a,normals:r,uvs:o,minPos:s,maxPos:c,boundingRadius:l}},torus:function(e,t,n){void 0===e&&(e=.4),void 0===t&&(t=.1),void 0===n&&(n={});for(var i=n.radialSegments||32,r=n.tubularSegments||32,o=n.arc||2*Math.PI,a=[],s=[],c=[],l=[],u=new In(-e-t,-t,-e-t),h=new In(e+t,t,e+t),f=e+t,_=0;_<=i;_++)for(var p=0;p<=r;p++){var d=p/r,m=_/i,v=d*o,g=m*Math.PI*2,y=(e+t*Math.cos(g))*Math.sin(v),x=t*Math.sin(g),S=(e+t*Math.cos(g))*Math.cos(v),T=Math.sin(v)*Math.cos(g),b=Math.sin(g),E=Math.cos(v)*Math.cos(g);if(a.push(y,x,S),s.push(T,b,E),c.push(d,m),p<r&&_<i){var C=r+1,A=C*_+p,w=C*(_+1)+p,P=C*(_+1)+p+1,R=C*_+p+1;l.push(A,R,w),l.push(R,P,w)}}return{positions:a,normals:s,uvs:c,indices:l,minPos:u,maxPos:h,boundingRadius:f}},capsule:function(e,t,n,i){void 0===e&&(e=.5),void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i={});var r=n-e-t,o=i.sides||32,a=i.heightSegments||32,s=t/n,c=r/n,l=e/n,u=Math.floor(a*s),h=Math.floor(a*l),f=Math.floor(a*c),_=r+t-n/2,p=t-n/2,d=t-n/2,m=i.arc||2*Math.PI,v=[],g=[],y=[],x=[],S=Math.max(e,t),T=new In(-S,-n/2,-S),b=new In(S,n/2,S),E=n/2,C=0,A=[];return function(){for(var e=0;e<=u;++e)for(var n=e*Math.PI/u/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,l=Math.sin(c)*i,h=r,f=Math.cos(c)*i,_=s/o,p=e/a;if(v.push(l*t,h*t+d,f*t),g.push(l,h,f),y.push(_,p),e<u&&s<o){var m=o+1,S=m*e+s,T=m*(e+1)+s,b=m*(e+1)+s+1,E=m*e+s+1;x.push(S,E,T),x.push(E,b,T)}++C}}(),function(){for(var n=(e-t)/r,i=0;i<=f;i++){for(var a=[],l=i/f,u=l*(e-t)+t,h=0;h<=o;++h){var _=h/o,d=l*c+s,S=_*m-m/4,T=Math.sin(S),b=Math.cos(S);v.push(u*T),v.push(l*r+p),v.push(u*b),In.normalize(Pve,In.set(Rve,T,-n,b)),g.push(Pve.x),g.push(Pve.y),g.push(Pve.z),y.push(_,d),a.push(C),++C}A.push(a)}for(var E=0;E<f;++E)for(var w=0;w<o;++w){var P=A[E][w],R=A[E+1][w],I=A[E+1][w+1],D=A[E][w+1];x.push(P),x.push(D),x.push(R),x.push(D),x.push(I),x.push(R)}}(),function(){for(var t=0;t<=h;++t)for(var n=t*Math.PI/h/2+Math.PI/2,i=Math.sin(n),r=-Math.cos(n),s=0;s<=o;++s){var c=2*s*Math.PI/o-Math.PI/2,u=Math.sin(c)*i,p=r,d=Math.cos(c)*i,m=s/o,S=t/a+(1-l);if(v.push(u*e,p*e+_,d*e),g.push(u,p,d),y.push(m,S),t<h&&s<o){var T=o+1,b=T*t+s+A[f][o]+1,E=T*(t+1)+s+A[f][o]+1,C=T*(t+1)+s+1+A[f][o]+1,w=T*t+s+1+A[f][o]+1;x.push(b,w,E),x.push(w,C,E)}}}(),{positions:v,normals:g,uvs:y,indices:x,minPos:T,maxPos:b,boundingRadius:E}},circle:function(e){var t=function(e){return(e=ove(e)).segments=64,e}(e).segments,n=new Array(3*(t+1));n[0]=0,n[1]=0,n[2]=0;var i=new Array(1+2*t);i[0]=0;for(var r=2*Math.PI/t,o=0;o<t;++o){var a=r*o,s=Math.cos(a),c=Math.sin(a),l=3*(o+1);n[l+0]=s,n[l+1]=c,n[l+2]=0;var u=2*o;i[1+u]=o+1,i[1+(u+1)]=o+2}return t>0&&(i[i.length-1]=1),{positions:n,indices:i,minPos:{x:1,y:1,z:0},maxPos:{x:-1,y:-1,z:0},boundingRadius:1,primitiveMode:Ui.TRIANGLE_FAN}},translate:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]+=n,e.positions[c]+=i,e.positions[l]+=r}return e.minPos&&(e.minPos.x+=n,e.minPos.y+=i,e.minPos.z+=r),e.maxPos&&(e.maxPos.x+=n,e.maxPos.y+=i,e.maxPos.z+=r),e},scale:function(e,t){for(var n=t.x||0,i=t.y||0,r=t.z||0,o=Math.floor(e.positions.length/3),a=0;a<o;++a){var s=3*a,c=3*a+1,l=3*a+2;e.positions[s]*=n,e.positions[c]*=i,e.positions[l]*=r}return e.minPos&&(e.minPos.x*=n,e.minPos.y*=i,e.minPos.z*=r),e.maxPos&&(e.maxPos.x*=n,e.maxPos.y*=i,e.maxPos.z*=r),e.boundingRadius=Math.max(Math.max(n,i),r),e},wireframed:function(e){var t=e.indices;if(!t)return e;if(e.primitiveMode&&e.primitiveMode!==Ui.TRIANGLE_LIST)return e;for(var n=[[0,1],[1,2],[2,0]],i=[],r={},o=0;o<t.length;o+=3)for(var a=0;a<3;++a){var s=t[o+n[a][0]],c=t[o+n[a][1]],l=s>c?c<<16|s:s<<16|c;void 0===r[l]&&(r[l]=0,i.push(s,c))}return e.indices=i,e.primitiveMode=Ui.LINE_LIST,e},wireframe:function(e){for(var t=[[0,1],[1,2],[2,0]],n=[],i={},r=0;r<e.length;r+=3)for(var o=0;o<3;++o){var a=e[r+t[o][0]],s=e[r+t[o][1]],c=a>s?s<<16|a:a<<16|s;void 0===i[c]&&(i[c]=0,n.push(a,s))}return n},invWinding:function(e){for(var t=[],n=0;n<e.length;n+=3)t.push(e[n],e[n+2],e[n+1]);return t},toWavefrontOBJ:function(e,t){if(void 0===t&&(t=1),!e.indices||!e.uvs||!e.normals||void 0!==e.primitiveMode&&e.primitiveMode!==Ui.TRIANGLE_LIST)return"";for(var n=e.positions,i=e.uvs,r=e.normals,o=e.indices,a=function(e){return o[e]+1+"/"+(o[e]+1)+"/"+(o[e]+1)},s="",c=0;c<n.length;c+=3)s+="v "+n[c]*t+" "+n[c+1]*t+" "+n[c+2]*t+"\n";for(var l=0;l<i.length;l+=2)s+="vt "+i[l]+" "+i[l+1]+"\n";for(var u=0;u<r.length;u+=3)s+="vn "+r[u]+" "+r[u+1]+" "+r[u+2]+"\n";for(var h=0;h<o.length;h+=3)s+="f "+a(h)+" "+a(h+1)+" "+a(h+2)+"\n";return s},normals:function(e,t,n){void 0===n&&(n=1);for(var i=new Array(2*e.length),r=0;r<e.length/3;++r){var o=3*r,a=6*r;i[a+0]=e[o+0],i[a+1]=e[o+1],i[a+2]=e[o+2],i[a+3]=e[o+0]+t[o+0]*n,i[a+4]=e[o+1]+t[o+1]*n,i[a+5]=e[o+2]+t[o+2]*n}return i},applyDefaultGeometryOptions:ove});function Dve(e,t){e.__cc_wrapper__=t}function Ove(e){return e.__cc_wrapper__}e("primitives",Ive);var Mve=new In;function Nve(e){return e.x=Math.abs(e.x),e.y=Math.abs(e.y),e.z=Math.abs(e.z),e}var Lve,Bve,Fve,zve,Uve,kve,Gve,Hve,Vve,Wve,jve,qve,Xve,Yve,Kve,Qve,Zve,Jve,$ve,ege,tge,nge,ige,rge,oge,age,sge,cge,lge,uge,hge,fge,_ge,pge,dge,mge,vge,gge,yge,xge,Sge,Tge,bge,Ege,Cge,Age,wge,Pge,Rge,Ige,Dge,Oge,Mge,Nge,Lge,Bge,Fge,zge,Uge,kge,Gge,Hge,Vge,Wge,jge,qge,Xge,Yge,Kge,Qge,Zge,Jge,$ge,eye,tye,nye,iye,rye,oye,aye,sye,cye,lye,uye,hye,fye,_ye,pye,dye,mye,vye,gye,yye,xye,Sye,Tye,bye,Eye,Cye,Aye,wye,Pye,Rye,Iye,Dye,Oye,Mye,Nye,Lye,Bye,Fye,zye,Uye,kye,Gye,Hye,Vye,Wye,jye,qye,Xye,Yye,Kye,Qye,Zye,Jye,$ye,exe,txe,nxe=Object.freeze({__proto__:null,setWrap:Dve,getWrap:Ove,maxComponent:function(e){return Math.max(e.x,Math.max(e.y,e.z))},VEC3_0:Mve,TriggerEventObject:{type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},CollisionEventObject:{type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},shrinkPositions:function(e){var t=[];if(e.length>=3){t[0]=e[0],t[1]=e[1],t[2]=e[2];for(var n=e.length,i=3;i<n;i+=3){for(var r=e[i],o=e[i+1],a=e[i+2],s=t.length,c=!0,l=0;l<s;l+=3)if(sn(r,t[l])&&sn(o,t[l+1])&&sn(a,t[l+2])){c=!1;break}c&&(t.push(r),t.push(o),t.push(a))}}return t},absolute:Nve,cylinder:xve}),ixe=function(t){return e({BoxCollider:t,BoxColliderComponent:t}),t}((Lve=mc("cc.BoxCollider"),Bve=Oc(),Fve=Pc(),zve=Zc(In),Uve=Fc(),Lve(kve=Bve(kve=Fve(kve=wc((le((Gve=function(e){function t(){var t;return ce(t=e.call(this,mde.BOX)||this,"_size",Hve,oe(t)),t}return $(t,e),Z(t,[{key:"size",get:function(){return this._size},set:function(e){In.strictEquals(this._size,e)||(In.copy(this._size,e),Nve(this._size),this._shape&&this.shape.updateSize())}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"size",[zve,Uve],Object.getOwnPropertyDescriptor(Gve.prototype,"size"),Gve.prototype),Hve=le(Gve.prototype,"_size",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(1,1,1)}}),kve=Gve))||kve)||kve)||kve)||kve)),rxe=function(t){return e({SphereCollider:t,SphereColliderComponent:t}),t}((Vve=mc("cc.SphereCollider"),Wve=Oc(),jve=Pc(),qve=Fc(),Vve(Xve=Wve(Xve=jve(Xve=wc((le((Yve=function(e){function t(){var t;return ce(t=e.call(this,mde.SPHERE)||this,"_radius",Kve,oe(t)),t}return $(t,e),Z(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.updateRadius())}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"radius",[qve],Object.getOwnPropertyDescriptor(Yve.prototype,"radius"),Yve.prototype),Kve=le(Yve.prototype,"_radius",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Xve=Yve))||Xve)||Xve)||Xve)||Xve)),oxe=function(t){return e({CapsuleCollider:t,CapsuleColliderComponent:t}),t}((Qve=mc("cc.CapsuleCollider"),Zve=Oc(),Jve=Pc(),$ve=Fc(),ege=Fc(),tge=Zc(pde),nge=Fc(),Qve(ige=Zve(ige=Jve(ige=wc((le((rge=function(e){function t(){var t;return ce(t=e.call(this,mde.CAPSULE)||this,"_radius",oge,oe(t)),ce(t,"_cylinderHeight",age,oe(t)),ce(t,"_direction",sge,oe(t)),t}$(t,e);var n=t.prototype;return n._getRadiusScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===pde.Y_AXIS?Math.abs(Cn(e.x,e.z)):this._direction===pde.X_AXIS?Math.abs(Cn(e.y,e.z)):Math.abs(Cn(e.x,e.y))},n._getHeightScale=function(){if(null==this.node)return 1;var e=this.node.worldScale;return this._direction===pde.Y_AXIS?Math.abs(e.y):this._direction===pde.X_AXIS?Math.abs(e.x):Math.abs(e.z)},Z(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"cylinderHeight",get:function(){return this._cylinderHeight},set:function(e){this._cylinderHeight!==e&&(this._cylinderHeight=Math.abs(e),this._shape&&this.shape.setCylinderHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){(e=Math.floor(e))<pde.X_AXIS||e>pde.Z_AXIS||this._direction!==e&&(this._direction=e,this._shape&&this.shape.setDirection(e))}},{key:"height",get:function(){return 2*this._radius+this._cylinderHeight},set:function(e){var t=e-2*this._radius;t<0&&(t=0),this.cylinderHeight=t}},{key:"worldHeight",get:function(){return 2*this._radius*this._getRadiusScale()+this._cylinderHeight*this._getHeightScale()}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"radius",[$ve],Object.getOwnPropertyDescriptor(rge.prototype,"radius"),rge.prototype),le(rge.prototype,"cylinderHeight",[ege],Object.getOwnPropertyDescriptor(rge.prototype,"cylinderHeight"),rge.prototype),le(rge.prototype,"direction",[tge,nge],Object.getOwnPropertyDescriptor(rge.prototype,"direction"),rge.prototype),oge=le(rge.prototype,"_radius",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),age=le(rge.prototype,"_cylinderHeight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),sge=le(rge.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pde.Y_AXIS}}),ige=rge))||ige)||ige)||ige)||ige)),axe=function(t){return e({CylinderCollider:t,CylinderColliderComponent:t}),t}((cge=mc("cc.CylinderCollider"),lge=Oc(),uge=Pc(),hge=Fc(),fge=Fc(),_ge=Zc(pde),pge=Fc(),cge(dge=lge(dge=uge(dge=wc((le((mge=function(e){function t(){var t;return ce(t=e.call(this,mde.CYLINDER)||this,"_radius",vge,oe(t)),ce(t,"_height",gge,oe(t)),ce(t,"_direction",yge,oe(t)),t}return $(t,e),Z(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(this._height=Math.abs(e),this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<pde.X_AXIS||e>pde.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"radius",[hge],Object.getOwnPropertyDescriptor(mge.prototype,"radius"),mge.prototype),le(mge.prototype,"height",[fge],Object.getOwnPropertyDescriptor(mge.prototype,"height"),mge.prototype),le(mge.prototype,"direction",[_ge,pge],Object.getOwnPropertyDescriptor(mge.prototype,"direction"),mge.prototype),vge=le(mge.prototype,"_radius",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),gge=le(mge.prototype,"_height",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),yge=le(mge.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pde.Y_AXIS}}),dge=mge))||dge)||dge)||dge)||dge)),sxe=e("ConeCollider",(xge=mc("cc.ConeCollider"),Sge=Oc(),Tge=Pc(),bge=Fc(),Ege=Fc(),Cge=Zc(pde),Age=Fc(),xge(wge=Sge(wge=Tge(wge=wc((le((Pge=function(e){function t(){var t;return ce(t=e.call(this,mde.CONE)||this,"_radius",Rge,oe(t)),ce(t,"_height",Ige,oe(t)),ce(t,"_direction",Dge,oe(t)),t}return $(t,e),Z(t,[{key:"radius",get:function(){return this._radius},set:function(e){this._radius!==e&&(this._radius=Math.abs(e),this._shape&&this.shape.setRadius(e))}},{key:"height",get:function(){return this._height},set:function(e){this._height!==e&&(e<0&&(e=0),this._height=e,this._shape&&this.shape.setHeight(e))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(e<pde.X_AXIS||e>pde.Z_AXIS||(this._direction=e,this._shape&&this.shape.setDirection(e)))}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"radius",[bge],Object.getOwnPropertyDescriptor(Pge.prototype,"radius"),Pge.prototype),le(Pge.prototype,"height",[Ege],Object.getOwnPropertyDescriptor(Pge.prototype,"height"),Pge.prototype),le(Pge.prototype,"direction",[Cge,Age],Object.getOwnPropertyDescriptor(Pge.prototype,"direction"),Pge.prototype),Rge=le(Pge.prototype,"_radius",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),Ige=le(Pge.prototype,"_height",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),Dge=le(Pge.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return pde.Y_AXIS}}),wge=Pge))||wge)||wge)||wge)||wge)),cxe=function(t){return e({MeshCollider:t,MeshColliderComponent:t}),t}((Oge=mc("cc.MeshCollider"),Mge=Oc(),Nge=Pc(),Lge=Zc(S4),Bge=Fc(),Fge=Fc(),Oge(zge=Mge(zge=Nge(zge=wc((le((Uge=function(e){function t(){var t;return ce(t=e.call(this,mde.MESH)||this,"_mesh",kge,oe(t)),ce(t,"_convex",Gge,oe(t)),t}return $(t,e),Z(t,[{key:"mesh",get:function(){return this._mesh},set:function(e){this._mesh!==e&&(this._mesh=e,this._shape&&this.shape.setMesh(this._mesh))}},{key:"convex",get:function(){return this._convex},set:function(e){this._convex!==e&&(this._convex=e)}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"mesh",[Lge,Bge],Object.getOwnPropertyDescriptor(Uge.prototype,"mesh"),Uge.prototype),le(Uge.prototype,"convex",[Mc,Fge],Object.getOwnPropertyDescriptor(Uge.prototype,"convex"),Uge.prototype),kge=le(Uge.prototype,"_mesh",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Gge=le(Uge.prototype,"_convex",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),zge=Uge))||zge)||zge)||zge)||zge)),lxe=e("ConstantForce",(Hge=mc("cc.ConstantForce"),Vge=Oc(),Wge=vc(ive),jge=Pc(),qge=Vc(),Xge=Fc(),Yge=Vc(),Kge=Fc(),Qge=Vc(),Zge=Fc(),Jge=Vc(),$ge=Fc(),Hge(eye=Vge(eye=Wge(eye=jge(eye=yc(eye=wc((aye=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._rigidBody=null,ce(t,"_force",nye,oe(t)),ce(t,"_localForce",iye,oe(t)),ce(t,"_torque",rye,oe(t)),ce(t,"_localTorque",oye,oe(t)),t._mask=0,t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._rigidBody=this.node.getComponent(ive),this._maskUpdate(this._force,1),this._maskUpdate(this._localForce,2),this._maskUpdate(this._torque,4),this._maskUpdate(this._localTorque,8)},n.lateUpdate=function(){null!=this._rigidBody&&0!==this._mask&&(1&this._mask&&this._rigidBody.applyForce(this._force),2&this._mask&&this._rigidBody.applyLocalForce(this.localForce),4&this._mask&&this._rigidBody.applyTorque(this._torque),8&this._mask&&this._rigidBody.applyLocalTorque(this._localTorque))},n._maskUpdate=function(e,t){e.strictEquals(In.ZERO)?this._mask&=~t:this._mask|=t},Z(t,[{key:"force",get:function(){return this._force},set:function(e){In.copy(this._force,e),this._maskUpdate(this._force,1)}},{key:"localForce",get:function(){return this._localForce},set:function(e){In.copy(this._localForce,e),this._maskUpdate(this.localForce,2)}},{key:"torque",get:function(){return this._torque},set:function(e){In.copy(this._torque,e),this._maskUpdate(this._torque,4)}},{key:"localTorque",get:function(){return this._localTorque},set:function(e){In.copy(this._localTorque,e),this._maskUpdate(this._localTorque,8)}}]),t}(th),nye=le((tye=aye).prototype,"_force",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),iye=le(tye.prototype,"_localForce",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),rye=le(tye.prototype,"_torque",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),oye=le(tye.prototype,"_localTorque",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),le(tye.prototype,"force",[qge,Xge],Object.getOwnPropertyDescriptor(tye.prototype,"force"),tye.prototype),le(tye.prototype,"localForce",[Yge,Kge],Object.getOwnPropertyDescriptor(tye.prototype,"localForce"),tye.prototype),le(tye.prototype,"torque",[Qge,Zge],Object.getOwnPropertyDescriptor(tye.prototype,"torque"),tye.prototype),le(tye.prototype,"localTorque",[Jge,$ge],Object.getOwnPropertyDescriptor(tye.prototype,"localTorque"),tye.prototype),eye=tye))||eye)||eye)||eye)||eye)||eye)||eye)),uxe=(e("TERRAIN_MAX_LEVELS",4),e("TERRAIN_MAX_BLEND_LAYERS",4)),hxe=e("TERRAIN_MAX_LAYER_COUNT",256),fxe=e("TERRAIN_BLOCK_TILE_COMPLEXITY",32),_xe=e("TERRAIN_BLOCK_VERTEX_COMPLEXITY",33),pxe=e("TERRAIN_BLOCK_VERTEX_SIZE",8),dxe=e("TERRAIN_HEIGHT_BASE",32768),mxe=e("TERRAIN_HEIGHT_FACTORY",1/512),vxe=e("TERRAIN_HEIGHT_FMIN",-dxe*mxe),gxe=e("TERRAIN_HEIGHT_FMAX",(65535-dxe)*mxe),yxe=(e("TERRAIN_NORTH_INDEX",0),e("TERRAIN_SOUTH_INDEX",1),e("TERRAIN_WEST_INDEX",2),e("TERRAIN_EAST_INDEX",3),e("TERRAIN_DATA_VERSION",16842753)),xxe=e("TERRAIN_DATA_VERSION2",16842754),Sxe=e("TERRAIN_DATA_VERSION3",16842755),Txe=e("TERRAIN_DATA_VERSION4",16842756),bxe=e("TERRAIN_DATA_VERSION5",16842757),Exe=e("TERRAIN_DATA_VERSION_DEFAULT",16843025),Cxe=function(){function e(){this.length=0,this.buffer=new Uint8Array(2048),this._buffView=new DataView(this.buffer.buffer),this._seekPos=0}var t=e.prototype;return t.reserve=function(e){if(!(this.buffer.byteLength>e)){for(var t=this.buffer.byteLength;t<e;)t+=t;for(var n=new Uint8Array(t),i=0;i<this.length;++i)n[i]=this.buffer[i];this.buffer=n,this._buffView=new DataView(this.buffer.buffer)}},t.assign=function(e){this.buffer=e,this.length=e.length,this._seekPos=e.byteOffset,this._buffView=new DataView(e.buffer)},t.writeInt8=function(e){this.reserve(this.length+1),this._buffView.setInt8(this.length,e),this.length+=1},t.writeInt16=function(e){this.reserve(this.length+2),this._buffView.setInt16(this.length,e,!0),this.length+=2},t.writeInt32=function(e){this.reserve(this.length+4),this._buffView.setInt32(this.length,e,!0),this.length+=4},t.writeIntArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setInt32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeFloat=function(e){this.reserve(this.length+4),this._buffView.setFloat32(this.length,e,!0),this.length+=4},t.writeFloatArray=function(e){this.reserve(this.length+4*e.length);for(var t=0;t<e.length;++t)this._buffView.setFloat32(this.length+4*t,e[t],!0);this.length+=4*e.length},t.writeString=function(e){this.reserve(this.length+e.length+4),this._buffView.setInt32(this.length,e.length,!0);for(var t=0;t<e.length;++t)this._buffView.setInt8(this.length+4+t,e.charCodeAt(t));this.length+=e.length+4},t.readInt8=function(){var e=this._buffView.getInt8(this._seekPos);return this._seekPos+=1,e},t.readInt16=function(){var e=this._buffView.getInt16(this._seekPos,!0);return this._seekPos+=2,e},t.readInt=function(){var e=this._buffView.getInt32(this._seekPos,!0);return this._seekPos+=4,e},t.readIntArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getInt32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readFloat=function(){var e=this._buffView.getFloat32(this._seekPos,!0);return this._seekPos+=4,e},t.readFloatArray=function(e){for(var t=0;t<e.length;++t)e[t]=this._buffView.getFloat32(this._seekPos+4*t,!0);return this._seekPos+=4*e.length,e},t.readString=function(){for(var e=this.readInt(),t="",n=0;n<e;++n)t+=String.fromCharCode(this.readInt8());return t},e}(),Axe=e("TerrainLayerInfo",mc("cc.TerrainLayerInfo")((lye=le((cye=function(){ce(this,"slot",lye,this),ce(this,"tileSize",uye,this),ce(this,"detailMap",hye,this),ce(this,"normalMap",fye,this),ce(this,"roughness",_ye,this),ce(this,"metallic",pye,this)}).prototype,"slot",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),uye=le(cye.prototype,"tileSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),hye=le(cye.prototype,"detailMap",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),fye=le(cye.prototype,"normalMap",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_ye=le(cye.prototype,"roughness",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),pye=le(cye.prototype,"metallic",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),sye=cye))||sye),wxe=e("TerrainLayerBinaryInfo",mc("cc.TerrainLayerBinaryInfo")(dye=function(){this.slot=0,this.tileSize=1,this.roughness=1,this.metallic=0,this.detailMapId="",this.normalMapId=""})||dye),Pxe=e("TerrainAsset",mc("cc.TerrainAsset")((yye=function(e){function t(){var t;return(t=e.call(this)||this)._version=0,t._data=null,t._tileSize=1,t._blockCount=[1,1],t._weightMapSize=128,t._lightMapSize=128,t._heights=new Uint16Array,t._weights=new Uint8Array,t._layerBuffer=[-1,-1,-1,-1],t._layerBinaryInfos=[],ce(t,"_layerInfos",gye,oe(t)),t}$(t,e);var n=t.prototype;return n.getLayer=function(e,t,n){var i=4*(t*this.blockCount[0]+e)+n;return e<this.blockCount[0]&&t<this.blockCount[1]&&i<this._layerBuffer.length?this._layerBuffer[i]:-1},n.getHeight=function(e,t){var n=this._blockCount[0]*fxe+1;return(this._heights[t*n+e]-dxe)*mxe},n.getVertexCountI=function(){return this._blockCount.length<1?0:this._blockCount[0]*fxe+1},n.getVertexCountJ=function(){return this._blockCount.length<2?0:this._blockCount[1]*fxe+1},n._setNativeData=function(e){this._data=e},n._loadNativeData=function(e){if(!e||0===e.length)return!1;var t=new Cxe;if(t.assign(e),this._version=t.readInt(),this._version===Exe)return!0;if(this._version!==yxe&&this._version!==xxe&&this._version!==Sxe&&this._version!==Txe&&this._version!==bxe)return!1;this.tileSize=t.readFloat(),t.readIntArray(this._blockCount),this.weightMapSize=t.readInt16(),this.lightMapSize=t.readInt16();var n=t.readInt();this.heights=new Uint16Array(n);for(var i=0;i<this.heights.length;++i)this.heights[i]=t.readInt16();var r=t.readInt();this.weights=new Uint8Array(r);for(var o=0;o<this.weights.length;++o)this.weights[o]=t.readInt8();if(this._version>=xxe){var a=t.readInt();this.layerBuffer=new Array(a);for(var s=0;s<this.layerBuffer.length;++s)this.layerBuffer[s]=t.readInt16()}if(this._version>=Sxe){var c=t.readInt();this._layerBinaryInfos=new Array(c);for(var l=0;l<this._layerBinaryInfos.length;++l)this._layerBinaryInfos[l]=new wxe,this._layerBinaryInfos[l].slot=t.readInt(),this._layerBinaryInfos[l].tileSize=t.readFloat(),this._layerBinaryInfos[l].detailMapId=t.readString(),this._version>=Txe&&(this._layerBinaryInfos[l].normalMapId=t.readString(),this._layerBinaryInfos[l].roughness=t.readFloat(),this._layerBinaryInfos[l].metallic=t.readFloat())}return!0},n._exportNativeData=function(){var e=new Cxe;e.writeInt32(bxe),e.writeFloat(this.tileSize),e.writeIntArray(this._blockCount),e.writeInt16(this.weightMapSize),e.writeInt16(this.lightMapSize),e.writeInt32(this.heights.length);for(var t=0;t<this.heights.length;++t)e.writeInt16(this.heights[t]);e.writeInt32(this.weights.length);for(var n=0;n<this.weights.length;++n)e.writeInt8(this.weights[n]);e.writeInt32(this.layerBuffer.length);for(var i=0;i<this.layerBuffer.length;++i)e.writeInt16(this.layerBuffer[i]);var r=[];r.length=this.layerInfos.length;for(var o=0;o<r.length;++o){var a=this.layerInfos[o],s=new wxe;s.slot=o,s.tileSize=a.tileSize,s.detailMapId=a.detailMap?a.detailMap._uuid:"",s.normalMapId=a.normalMap?a.normalMap._uuid:"",s.metallic=a.metallic,s.roughness=a.roughness,r[o]=s}e.writeInt32(r.length);for(var c=0;c<r.length;++c)e.writeInt32(r[c].slot),e.writeFloat(r[c].tileSize),e.writeString(r[c].detailMapId),e.writeString(r[c].normalMapId),e.writeFloat(r[c].roughness),e.writeFloat(r[c].metallic);return e.buffer},n._exportDefaultNativeData=function(){var e=new Cxe;return e.writeInt32(Exe),e.buffer},Z(t,[{key:"_nativeAsset",get:function(){return this._data.buffer},set:function(e){this._data&&this._data.byteLength===e.byteLength?this._data.set(new Uint8Array(e)):this._data=new Uint8Array(e),this._loadNativeData(this._data)}},{key:"version",get:function(){return this._version}},{key:"tileSize",get:function(){return this._tileSize},set:function(e){this._tileSize=e}},{key:"blockCount",get:function(){return this._blockCount},set:function(e){this._blockCount=e}},{key:"lightMapSize",get:function(){return this._lightMapSize},set:function(e){this._lightMapSize=e}},{key:"weightMapSize",get:function(){return this._weightMapSize},set:function(e){this._weightMapSize=e}},{key:"heights",get:function(){return this._heights},set:function(e){this._heights=e}},{key:"weights",get:function(){return this._weights},set:function(e){this._weights=e}},{key:"layerBuffer",get:function(){return this._layerBuffer},set:function(e){this._layerBuffer=e}},{key:"layerInfos",get:function(){return this._layerInfos},set:function(e){this._layerInfos=e}},{key:"layerBinaryInfos",get:function(){return this._layerBinaryInfos}}]),t}(Nu),gye=le((vye=yye).prototype,"_layerInfos",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mye=vye))||mye),Rxe=e("TerrainCollider",(xye=mc("cc.TerrainCollider"),Sye=Oc(),Tye=Pc(),bye=Zc(Pxe),Eye=Fc(),xye(Cye=Sye(Cye=Tye(Cye=wc((le((Aye=function(e){function t(){var t;return ce(t=e.call(this,mde.TERRAIN)||this,"_terrain",wye,oe(t)),t}return $(t,e),Z(t,[{key:"terrain",get:function(){return this._terrain},set:function(e){this._terrain=e,this._shape&&this.shape.setTerrain(this._terrain)}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"terrain",[bye,Eye],Object.getOwnPropertyDescriptor(Aye.prototype,"terrain"),Aye.prototype),wye=le(Aye.prototype,"_terrain",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Cye=Aye))||Cye)||Cye)||Cye)||Cye)),Ixe=e("SimplexCollider",(Pye=mc("cc.SimplexCollider"),Rye=Oc(),Iye=Pc(),Dye=Zc(dde),Oye=Fc(),Mye=Fc(),Nye=Nc(),Lye=Fc(),Bye=Nc(),Fye=Fc(),zye=Nc(),Uye=Fc(),Pye(kye=Rye(kye=Iye(kye=wc((jye=Wye=function(e){function t(){var t;return ce(t=e.call(this,mde.SIMPLEX)||this,"_shapeType",Hye,oe(t)),ce(t,"_vertices",Vye,oe(t)),t}return $(t,e),t.prototype.updateVertices=function(){this._shape&&this.shape.setVertices(this._vertices)},Z(t,[{key:"shapeType",get:function(){return this._shapeType},set:function(e){this._shapeType=e,this._shape&&this.shape.setShapeType(e)}},{key:"vertex0",get:function(){return this._vertices[0]},set:function(e){In.copy(this._vertices[0],e),this.updateVertices()}},{key:"vertex1",get:function(){return this._vertices[1]},set:function(e){In.copy(this._vertices[1],e),this.updateVertices()}},{key:"vertex2",get:function(){return this._vertices[2]},set:function(e){In.copy(this._vertices[2],e),this.updateVertices()}},{key:"vertex3",get:function(){return this._vertices[3]},set:function(e){In.copy(this._vertices[3],e),this.updateVertices()}},{key:"shape",get:function(){return this._shape}},{key:"vertices",get:function(){return this._vertices}}]),t}(rve),Wye.ESimplexType=dde,le((Gye=jye).prototype,"shapeType",[Dye,Oye],Object.getOwnPropertyDescriptor(Gye.prototype,"shapeType"),Gye.prototype),le(Gye.prototype,"vertex0",[Mc,Mye],Object.getOwnPropertyDescriptor(Gye.prototype,"vertex0"),Gye.prototype),le(Gye.prototype,"vertex1",[Nye,Lye],Object.getOwnPropertyDescriptor(Gye.prototype,"vertex1"),Gye.prototype),le(Gye.prototype,"vertex2",[Bye,Fye],Object.getOwnPropertyDescriptor(Gye.prototype,"vertex2"),Gye.prototype),le(Gye.prototype,"vertex3",[zye,Uye],Object.getOwnPropertyDescriptor(Gye.prototype,"vertex3"),Gye.prototype),Hye=le(Gye.prototype,"_shapeType",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return dde.TETRAHEDRON}}),Vye=le(Gye.prototype,"_vertices",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[new In(0,0,0),new In(0,0,1),new In(1,0,0),new In(0,1,0)]}}),kye=Gye))||kye)||kye)||kye)||kye));Ixe||(Ixe=e("SimplexCollider",{}));var Dxe,Oxe,Mxe,Nxe,Lxe,Bxe,Fxe,zxe,Uxe,kxe,Gxe,Hxe,Vxe,Wxe,jxe,qxe,Xxe,Yxe,Kxe,Qxe,Zxe,Jxe,$xe,eSe,tSe,nSe,iSe,rSe,oSe=e("PlaneCollider",(qye=mc("cc.PlaneCollider"),Xye=Oc(),Yye=Pc(),Kye=Zc(In),Qye=Fc(),Zye=Fc(),qye(Jye=Xye(Jye=Yye(Jye=wc((le(($ye=function(e){function t(){var t;return ce(t=e.call(this,mde.PLANE)||this,"_normal",exe,oe(t)),ce(t,"_constant",txe,oe(t)),t}return $(t,e),Z(t,[{key:"normal",get:function(){return this._normal},set:function(e){In.strictEquals(this._normal,e)||(In.copy(this._normal,e),this._shape&&this.shape.setNormal(this._normal))}},{key:"constant",get:function(){return this._constant},set:function(e){this._constant!==e&&(this._constant=e,this._shape&&this.shape.setConstant(this._constant))}},{key:"shape",get:function(){return this._shape}}]),t}(rve)).prototype,"normal",[Kye,Qye],Object.getOwnPropertyDescriptor($ye.prototype,"normal"),$ye.prototype),le($ye.prototype,"constant",[Mc,Zye],Object.getOwnPropertyDescriptor($ye.prototype,"constant"),$ye.prototype),exe=le($ye.prototype,"_normal",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In(0,1,0)}}),txe=le($ye.prototype,"_constant",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Jye=$ye))||Jye)||Jye)||Jye)||Jye)),aSe=e("Constraint",(Dxe=mc("cc.Constraint"),Oxe=vc(ive),Mxe=Zc(ive),Nxe=Vc(),Lxe=Zc(ive),Bxe=Vc(),Fxe=Vc(),zxe=Zc(ive),Dxe(Uxe=Oxe((Wxe=Vxe=function(e){function t(t){var n;return(n=e.call(this)||this).TYPE=void 0,ce(n,"_enableCollision",Gxe,oe(n)),ce(n,"_connectedBody",Hxe,oe(n)),n._constraint=null,n.TYPE=t,n}$(t,e);var n=t.prototype;return n.onLoad=function(){bde.runInEditor&&(this._constraint=function(e){return Ude.INITED||(Ude.INITED=!0,Ude[vde.POINT_TO_POINT]=function(){return Ade(bde.wrapper.PointToPointConstraint,Tde.PointToPointConstraint)?kde:new bde.wrapper.PointToPointConstraint},Ude[vde.HINGE]=function(){return Ade(bde.wrapper.HingeConstraint,Tde.HingeConstraint)?kde:new bde.wrapper.HingeConstraint},Ude[vde.CONE_TWIST]=function(){return Ade(bde.wrapper.ConeTwistConstraint,Tde.ConeTwistConstraint)?kde:new bde.wrapper.ConeTwistConstraint}),Ude[e]()}(this.TYPE),this._constraint.initialize(this))},n.onEnable=function(){this._constraint&&this._constraint.onEnable()},n.onDisable=function(){this._constraint&&this._constraint.onDisable()},n.onDestroy=function(){this._constraint&&this._constraint.onDestroy()},Z(t,[{key:"attachedBody",get:function(){return this.getComponent(ive)}},{key:"connectedBody",get:function(){return this._connectedBody},set:function(e){this._connectedBody=e,this._constraint&&this._constraint.setConnectedBody(e)}},{key:"enableCollision",get:function(){return this._enableCollision},set:function(e){this._enableCollision=e,this._constraint&&this._constraint.setEnableCollision(e)}}]),t}(nu(th)),Vxe.Type=vde,le((kxe=Wxe).prototype,"attachedBody",[Mxe,Lc,Nxe],Object.getOwnPropertyDescriptor(kxe.prototype,"attachedBody"),kxe.prototype),le(kxe.prototype,"connectedBody",[Lxe,Bxe],Object.getOwnPropertyDescriptor(kxe.prototype,"connectedBody"),kxe.prototype),le(kxe.prototype,"enableCollision",[Fxe],Object.getOwnPropertyDescriptor(kxe.prototype,"enableCollision"),kxe.prototype),Gxe=le(kxe.prototype,"_enableCollision",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),Hxe=le(kxe.prototype,"_connectedBody",[zxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),Uxe=kxe))||Uxe)||Uxe));aSe||(aSe=e("Constraint",{}));var sSe,cSe,lSe,uSe,hSe,fSe,_Se,pSe,dSe,mSe=e("HingeConstraint",(jxe=mc("cc.HingeConstraint"),qxe=Oc(),Xxe=Pc(),Yxe=Zc(In),Kxe=Zc(In),Qxe=Zc(In),Zxe=bc("axisA"),Jxe=bc("pivotA"),$xe=bc("pivotB"),jxe(eSe=qxe(eSe=Xxe((le((tSe=function(e){function t(){var t;return ce(t=e.call(this,vde.HINGE)||this,"_axis",nSe,oe(t)),ce(t,"_pivotA",iSe,oe(t)),ce(t,"_pivotB",rSe,oe(t)),t}return $(t,e),Z(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){In.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){In.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"axis",get:function(){return this._axis},set:function(e){In.copy(this._axis,e),this.constraint.setAxis(this._axis)}},{key:"constraint",get:function(){return this._constraint}}]),t}(aSe)).prototype,"pivotA",[Yxe],Object.getOwnPropertyDescriptor(tSe.prototype,"pivotA"),tSe.prototype),le(tSe.prototype,"pivotB",[Kxe],Object.getOwnPropertyDescriptor(tSe.prototype,"pivotB"),tSe.prototype),le(tSe.prototype,"axis",[Qxe],Object.getOwnPropertyDescriptor(tSe.prototype,"axis"),tSe.prototype),nSe=le(tSe.prototype,"_axis",[Tc,Zxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),iSe=le(tSe.prototype,"_pivotA",[Tc,Jxe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),rSe=le(tSe.prototype,"_pivotB",[Tc,$xe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),eSe=tSe))||eSe)||eSe)||eSe)),vSe=e("PointToPointConstraint",(sSe=mc("cc.PointToPointConstraint"),cSe=Oc(),lSe=Pc(),uSe=Zc(In),hSe=Zc(In),sSe(fSe=cSe(fSe=lSe((le((_Se=function(e){function t(){var t;return ce(t=e.call(this,vde.POINT_TO_POINT)||this,"_pivotA",pSe,oe(t)),ce(t,"_pivotB",dSe,oe(t)),t}return $(t,e),Z(t,[{key:"pivotA",get:function(){return this._pivotA},set:function(e){In.copy(this._pivotA,e),this.constraint.setPivotA(this._pivotA)}},{key:"pivotB",get:function(){return this._pivotB},set:function(e){In.copy(this._pivotB,e),this.constraint.setPivotB(this._pivotB)}},{key:"constraint",get:function(){return this._constraint}}]),t}(aSe)).prototype,"pivotA",[uSe],Object.getOwnPropertyDescriptor(_Se.prototype,"pivotA"),_Se.prototype),le(_Se.prototype,"pivotB",[hSe],Object.getOwnPropertyDescriptor(_Se.prototype,"pivotB"),_Se.prototype),pSe=le(_Se.prototype,"_pivotA",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),dSe=le(_Se.prototype,"_pivotB",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new In}}),fSe=_Se))||fSe)||fSe)||fSe));u.PhysicsSystem=Nme,u.PhysicsMaterial=Gde,u.PhysicsRayResult=Hde,u.ConstantForce=lxe;var gSe=Object.freeze({__proto__:null,PhysicsSystem:Nme,PhysicsRayResult:Hde,get Collider(){return rve},BoxCollider:ixe,SphereCollider:rxe,CapsuleCollider:oxe,MeshCollider:cxe,CylinderCollider:axe,ConeCollider:sxe,TerrainCollider:Rxe,get SimplexCollider(){return Ixe},PlaneCollider:oSe,get Constraint(){return aSe},HingeConstraint:mSe,PointToPointConstraint:vSe,get RigidBody(){return ive},PhysicsMaterial:Gde,ConstantForce:lxe,selector:bde,utils:nxe,get ERigidBodyType(){return _de},get EAxisDirection(){return pde},get ESimplexType(){return dde},get EColliderType(){return mde},get EConstraintType(){return vde},get PhysicsGroup(){return gde}});e("physics",gSe);var ySe=new xde.Vec3,xSe=new xde.Vec3,SSe=function(){function e(){this._isEnabled=!1}var t=e.prototype;return t.setAllowSleep=function(e){this.impl.type===xde.Body.DYNAMIC&&(this.impl.allowSleep=e,this._wakeUpIfSleep())},t.setMass=function(e){this.impl.type===xde.Body.DYNAMIC&&(this.impl.mass=e,this.impl.updateMassProperties(),this._wakeUpIfSleep())},t.setType=function(e){switch(e){case _de.DYNAMIC:this.impl.type=xde.Body.DYNAMIC,this.impl.allowSleep=this._rigidBody.allowSleep,this.setMass(this._rigidBody.mass);break;case _de.KINEMATIC:this.impl.type=xde.Body.KINEMATIC,this.impl.mass=0,this.impl.allowSleep=!1,this.impl.sleepState=xde.Body.AWAKE,this.impl.updateMassProperties();break;case _de.STATIC:default:this.impl.type=xde.Body.STATIC,this.impl.mass=0,this.impl.allowSleep=!0,this.impl.updateMassProperties(),this.clearState()}},t.setLinearDamping=function(e){this.impl.linearDamping=e},t.setAngularDamping=function(e){this.impl.angularDamping=e},t.useGravity=function(e){this.impl.useGravity=e,this._wakeUpIfSleep()},t.useCCD=function(e){this.impl.ccdSpeedThreshold=e?.01:-1},t.isUsingCCD=function(){return-1!==this.impl.ccdSpeedThreshold},t.setLinearFactor=function(e){In.copy(this.impl.linearFactor,e),this._wakeUpIfSleep()},t.setAngularFactor=function(e){In.copy(this.impl.angularFactor,e);var t=In.equals(this.impl.angularFactor,In.ZERO);t!==this.impl.fixedRotation&&(this.impl.fixedRotation=t,this.impl.updateMassProperties()),this._wakeUpIfSleep()},t.initialize=function(e){this._rigidBody=e,this._sharedBody=Nme.instance.physicsWorld.getSharedBody(this._rigidBody.node,this),this._sharedBody.reference=!0,this._sharedBody.wrappedBody=this},t.onLoad=function(){},t.onEnable=function(){this._isEnabled=!0,this.setType(this._rigidBody.type),this.setMass(this._rigidBody.mass),this.setAllowSleep(this._rigidBody.allowSleep),this.setLinearDamping(this._rigidBody.linearDamping),this.setAngularDamping(this._rigidBody.angularDamping),this.useGravity(this._rigidBody.useGravity),this.setLinearFactor(this._rigidBody.linearFactor),this.setAngularFactor(this._rigidBody.angularFactor),this._sharedBody.enabled=!0},t.onDisable=function(){this._isEnabled=!1,this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._rigidBody=null,this._sharedBody=null},t.clearVelocity=function(){this.impl.velocity.setZero(),this.impl.angularVelocity.setZero()},t.clearForces=function(){this.impl.force.setZero(),this.impl.torque.setZero()},t.clearState=function(){this.clearVelocity(),this.clearForces()},t.wakeUp=function(){return this.impl.wakeUp()},t.sleep=function(){return this.impl.sleep()},t.setSleepThreshold=function(e){this.impl.sleepSpeedLimit=e,this._wakeUpIfSleep()},t.getSleepThreshold=function(){return this.impl.sleepSpeedLimit},t.getLinearVelocity=function(e){return In.copy(e,this.impl.velocity),e},t.setLinearVelocity=function(e){this._wakeUpIfSleep(),In.copy(this.impl.velocity,e)},t.getAngularVelocity=function(e){return In.copy(e,this.impl.angularVelocity),e},t.setAngularVelocity=function(e){this._wakeUpIfSleep(),In.copy(this.impl.angularVelocity,e)},t.applyForce=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=In.ZERO),this.impl.applyForce(In.copy(ySe,e),In.copy(xSe,t))},t.applyImpulse=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=In.ZERO),this.impl.applyImpulse(In.copy(ySe,e),In.copy(xSe,t))},t.applyLocalForce=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=In.ZERO),this.impl.applyLocalForce(In.copy(ySe,e),In.copy(xSe,t))},t.applyLocalImpulse=function(e,t){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),null==t&&(t=In.ZERO),this.impl.applyLocalImpulse(In.copy(ySe,e),In.copy(xSe,t))},t.applyTorque=function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),In.add(this.impl.torque,this.impl.torque,e)},t.applyLocalTorque=function(e){this._sharedBody.syncSceneToPhysics(),this._wakeUpIfSleep(),In.copy(ySe,e),this.impl.vectorToWorldFrame(ySe,ySe),In.add(this.impl.torque,this.impl.torque,ySe)},t.getGroup=function(){return this.impl.collisionFilterGroup},t.setGroup=function(e){this.impl.collisionFilterGroup=e,this._wakeUpIfSleep()},t.addGroup=function(e){this.impl.collisionFilterGroup|=e,this._wakeUpIfSleep()},t.removeGroup=function(e){this.impl.collisionFilterGroup&=~e,this._wakeUpIfSleep()},t.getMask=function(){return this.impl.collisionFilterMask},t.setMask=function(e){this.impl.collisionFilterMask=e,this._wakeUpIfSleep()},t.addMask=function(e){this.impl.collisionFilterMask|=e,this._wakeUpIfSleep()},t.removeMask=function(e){this.impl.collisionFilterMask&=~e,this._wakeUpIfSleep()},t._wakeUpIfSleep=function(){this.impl.isAwake()||this.impl.wakeUp()},Z(e,[{key:"isAwake",get:function(){return this.impl.isAwake()}},{key:"isSleepy",get:function(){return this.impl.isSleepy()}},{key:"isSleeping",get:function(){return this.impl.isSleeping()}},{key:"impl",get:function(){return this._sharedBody.body}},{key:"rigidBody",get:function(){return this._rigidBody}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"isEnabled",get:function(){return this._isEnabled}}]),e}();function TSe(e,t){e.checkCollisionResponse=!t.queryTrigger,e.collisionFilterGroup=-1,e.collisionFilterMask=t.mask}function bSe(e,t){e._assign(t.hitPointWorld,t.distance,Ove(t.shape).collider,t.hitNormalWorld)}function ESe(e){e.aabbNeedsUpdate=!0,e.updateMassProperties(),e.updateBoundingRadius()}var CSe={type:"onTriggerEnter",selfCollider:null,otherCollider:null,impl:null},ASe=new xde.Quaternion,wSe=new xde.Vec3,PSe=new xde.Vec3,RSe=function(){function e(){this._offset=new xde.Vec3,this._orient=new xde.Quaternion,this._index=-1,this.onTriggerListener=this._onTrigger.bind(this),this._isBinding=!1}var t=e.prototype;return t.updateEventListener=function(){},t.setMaterial=function(t){if(null==t)this._shape.material=null;else{null==e.idToMaterial[t.id]&&(e.idToMaterial[t.id]=new xde.Material(t.id)),this._shape.material=e.idToMaterial[t.id];var n=this._shape.material;n.friction=t.friction,n.restitution=t.restitution;var i=xde.CC_CONFIG.correctInelastic;n.correctInelastic=0===n.restitution?i:0}},t.setAsTrigger=function(e){this._shape.collisionResponse=!e,this._index>=0&&this._body.updateHasTrigger()},t.setCenter=function(e){this._setCenter(e),this._index>=0&&ESe(this._body)},t.setAttachedBody=function(e){if(e){if(this._sharedBody){if(this._sharedBody.wrappedBody===e.body)return;this._sharedBody.reference=!1}this._sharedBody=Nme.instance.physicsWorld.getSharedBody(e.node),this._sharedBody.reference=!0}else this._sharedBody&&(this._sharedBody.reference=!1),this._sharedBody=Nme.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0},t.getAABB=function(e){Fn.copy(ASe,this._collider.node.worldRotation),this._shape.calculateWorldAABB(xde.Vec3.ZERO,ASe,wSe,PSe),In.subtract(e.halfExtents,PSe,wSe),In.multiplyScalar(e.halfExtents,e.halfExtents,.5),In.add(e.center,this._collider.node.worldPosition,this._collider.center)},t.getBoundingSphere=function(e){e.radius=this._shape.boundingSphereRadius,In.add(e.center,this._collider.node.worldPosition,this._collider.center)},t.initialize=function(e){this._collider=e,this._isBinding=!0,this._sharedBody=Nme.instance.physicsWorld.getSharedBody(this._collider.node),this._sharedBody.reference=!0,this.onComponentSet(),Dve(this._shape,this),this._shape.addEventListener("cc-trigger",this.onTriggerListener)},t.onComponentSet=function(){},t.onLoad=function(){this.setMaterial(this._collider.sharedMaterial),this.setCenter(this._collider.center),this.setAsTrigger(this._collider.isTrigger)},t.onEnable=function(){this._sharedBody.addShape(this),this._sharedBody.enabled=!0},t.onDisable=function(){this._sharedBody.removeShape(this),this._sharedBody.enabled=!1},t.onDestroy=function(){this._sharedBody.reference=!1,this._shape.removeEventListener("cc-trigger",this.onTriggerListener),delete xde.World.idToShapeMap[this._shape.id],this._sharedBody=null,Dve(this._shape,null),this._offset=null,this._orient=null,this._shape=null,this._collider=null,this.onTriggerListener=null},t.getGroup=function(){return this._body.collisionFilterGroup},t.setGroup=function(e){this._body.collisionFilterGroup=e,this._body.isAwake()||this._body.wakeUp()},t.addGroup=function(e){this._body.collisionFilterGroup|=e,this._body.isAwake()||this._body.wakeUp()},t.removeGroup=function(e){this._body.collisionFilterGroup&=~e,this._body.isAwake()||this._body.wakeUp()},t.getMask=function(){return this._body.collisionFilterMask},t.setMask=function(e){this._body.collisionFilterMask=e,this._body.isAwake()||this._body.wakeUp()},t.addMask=function(e){this._body.collisionFilterMask|=e,this._body.isAwake()||this._body.wakeUp()},t.removeMask=function(e){this._body.collisionFilterMask&=~e,this._body.isAwake()||this._body.wakeUp()},t.setScale=function(){this._setCenter(this._collider.center)},t.setIndex=function(e){this._index=e},t.setOffsetAndOrient=function(e,t){In.copy(e,this._offset),Fn.copy(t,this._orient),this._offset=e,this._orient=t},t._setCenter=function(e){var t=this._offset;In.subtract(t,this._sharedBody.node.worldPosition,this._collider.node.worldPosition),In.add(t,t,e),In.multiply(t,t,this._collider.node.worldScale)},t._onTrigger=function(e){CSe.type=e.event;var t=Ove(e.selfShape),n=Ove(e.otherShape);t&&t.collider.needTriggerEvent&&(CSe.selfCollider=t.collider,CSe.otherCollider=n?n.collider:null,CSe.impl=e,this._collider.emit(CSe.type,CSe))},Z(e,[{key:"impl",get:function(){return this._shape}},{key:"collider",get:function(){return this._collider}},{key:"attachedRigidBody",get:function(){return this._sharedBody.wrappedBody?this._sharedBody.wrappedBody.rigidBody:null}},{key:"sharedBody",get:function(){return this._sharedBody}},{key:"_body",get:function(){return this._sharedBody.body}}]),e}();RSe.idToMaterial={},k(Nme,"PhysicsSystem",[{name:"ins",newName:"instance"},{name:"PHYSICS_AMMO",newName:"PHYSICS_BULLET"}]),k(Nme.prototype,"PhysicsSystem.prototype",[{name:"deltaTime",newName:"fixedTimeStep"},{name:"maxSubStep",newName:"maxSubSteps"}]),G(Nme.prototype,"PhysicsSystem.prototype",[{name:"useFixedTime"},{name:"useCollisionMatrix"},{name:"updateCollisionMatrix"},{name:"resetCollisionMatrix"},{name:"isCollisionGroup"},{name:"setCollisionGroup"}]),k(rve.prototype,"Collider.prototype",[{name:"attachedRigidbody",newName:"attachedRigidBody"},{name:"TYPE",newName:"type"}]),k(rve,"Collider",[{name:"EColliderType",newName:"Type"},{name:"EAxisDirection",newName:"Axis"}]),k(aSe,"Constraint",[{name:"EConstraintType",newName:"Type"}]),k(ixe.prototype,"BoxCollider.prototype",[{name:"boxShape",newName:"shape"}]),k(rxe.prototype,"SphereCollider.prototype",[{name:"sphereShape",newName:"shape"}]),k(oxe.prototype,"CapsuleCollider.prototype",[{name:"capsuleShape",newName:"shape"}]),k(ive.prototype,"RigidBody.prototype",[{name:"rigidBody",newName:"body"}]),k(ive,"RigidBody",[{name:"ERigidBodyType",newName:"Type"}]),G(ive.prototype,"RigidBody.prototype",[{name:"fixedRotation"}]),u.RigidBodyComponent=ive,rt.setClassAlias(ive,"cc.RigidBodyComponent"),u.ColliderComponent=rve,rt.setClassAlias(rve,"cc.ColliderComponent"),u.BoxColliderComponent=ixe,rt.setClassAlias(ixe,"cc.BoxColliderComponent"),u.SphereColliderComponent=rxe,rt.setClassAlias(rxe,"cc.SphereColliderComponent"),rt.setClassAlias(oxe,"cc.CapsuleColliderComponent"),rt.setClassAlias(cxe,"cc.MeshColliderComponent"),rt.setClassAlias(axe,"cc.CylinderColliderComponent"),u.PhysicMaterial=Gde,rt.setClassAlias(Gde,"cc.PhysicMaterial"),u.physics=gSe;var ISe=new Fn,DSe=function(){function e(e){this.impl=null,this.event=void 0,this.event=e}var t=e.prototype;return t.getLocalPointOnA=function(e){this.impl&&In.copy(e,this.impl.rj)},t.getLocalPointOnB=function(e){this.impl&&In.copy(e,this.impl.ri)},t.getWorldPointOnA=function(e){this.impl&&In.add(e,this.impl.rj,this.impl.bj.position)},t.getWorldPointOnB=function(e){this.impl&&In.add(e,this.impl.ri,this.impl.bi.position)},t.getLocalNormalOnA=function(e){this.impl&&(this.getWorldNormalOnA(e),Fn.conjugate(ISe,this.impl.bi.quaternion),In.transformQuat(e,e,ISe))},t.getLocalNormalOnB=function(e){this.impl&&(Fn.conjugate(ISe,this.impl.bj.quaternion),In.transformQuat(e,this.impl.ni,ISe))},t.getWorldNormalOnA=function(e){this.impl&&(this.getWorldNormalOnB(e),this.isBodyA||In.negate(e,e))},t.getWorldNormalOnB=function(e){this.impl&&In.copy(e,this.impl.ni)},Z(e,[{key:"isBodyA",get:function(){if(this.impl){var e=this.event.selfCollider.shape.impl,t=this.impl.bj;return e.body.id===t.id}return!1}}]),e}(),OSe=new In,MSe=new Fn,NSe=[],LSe={type:"onCollisionEnter",selfCollider:null,otherCollider:null,contacts:[],impl:null},BSe=function(){function e(e,t){this.node=void 0,this.wrappedWorld=void 0,this.body=void 0,this.wrappedShapes=[],this.wrappedJoints0=[],this.wrappedJoints1=[],this.wrappedBody=null,this.index=-1,this.ref=0,this.onCollidedListener=this.onCollided.bind(this),this.wrappedWorld=t,this.node=e,this.body=new xde.Body,Dve(this.body,this),this.body.collisionFilterGroup=Nme.PhysicsGroup.DEFAULT,this.body.sleepSpeedLimit=Nme.instance.sleepThreshold,this.body.material=this.wrappedWorld.impl.defaultMaterial,this.body.addEventListener("cc-collide",this.onCollidedListener)}e.getSharedBody=function(t,n,i){var r,o=t.uuid;if(e.sharedBodesMap.has(o))r=e.sharedBodesMap.get(o);else{r=new e(t,n);var a=gde.DEFAULT,s=Nme.instance.collisionMatrix[a];r.body.collisionFilterGroup=a,r.body.collisionFilterMask=s,e.sharedBodesMap.set(t.uuid,r)}if(i){r.wrappedBody=i;var c=i.rigidBody.group,l=Nme.instance.collisionMatrix[c];r.body.collisionFilterGroup=c,r.body.collisionFilterMask=l}return r};var t=e.prototype;return t.addShape=function(e){if(this.wrappedShapes.indexOf(e)<0){var t=this.body.shapes.length;this.body.addShape(e.impl),this.wrappedShapes.push(e),e.setIndex(t);var n=this.body.shapeOffsets[t],i=this.body.shapeOrientations[t];e.setOffsetAndOrient(n,i),this.body.isSleeping()&&this.body.wakeUp()}},t.removeShape=function(e){var t=this.wrappedShapes.indexOf(e);t>=0&&(fe(this.wrappedShapes,t),this.body.removeShape(e.impl),e.setIndex(-1),this.body.isSleeping()&&this.body.wakeUp())},t.addJoint=function(e,t){t?this.wrappedJoints1.indexOf(e)<0&&this.wrappedJoints1.push(e):this.wrappedJoints0.indexOf(e)<0&&this.wrappedJoints0.push(e)},t.removeJoint=function(e,t){if(t){var n=this.wrappedJoints1.indexOf(e);n>=0&&fe(this.wrappedJoints1,n)}else{var i=this.wrappedJoints0.indexOf(e);i>=0&&fe(this.wrappedJoints0,i)}},t.syncSceneToPhysics=function(){var e=this.node,t=this.body;e.hasChangedFlags&&(t.isSleeping()&&t.wakeUp(),In.copy(t.position,e.worldPosition),Fn.copy(t.quaternion,e.worldRotation),t.aabbNeedsUpdate=!0,e.hasChangedFlags&oy.SCALE&&this.syncScale())},t.syncPhysicsToScene=function(){var e=this.node,t=this.body;t.type===_de.DYNAMIC&&(t.isSleeping()||(In.copy(OSe,t.position),Fn.copy(MSe,t.quaternion),e.worldPosition=OSe,e.worldRotation=MSe))},t.syncInitial=function(){var e=this.node,t=this.body;In.copy(t.position,e.worldPosition),Fn.copy(t.quaternion,e.worldRotation),In.copy(t.previousPosition,e.worldPosition),Fn.copy(t.previousQuaternion,e.worldRotation),t.aabbNeedsUpdate=!0,this.syncScale(),t.isSleeping()&&t.wakeUp()},t.syncScale=function(){for(var e=0;e<this.wrappedShapes.length;e++)this.wrappedShapes[e].setScale(this.node.worldScale);for(var t=0;t<this.wrappedJoints0.length;t++)this.wrappedJoints0[t].updateScale0();for(var n=0;n<this.wrappedJoints1.length;n++)this.wrappedJoints1[n].updateScale1();ESe(this.body)},t.destroy=function(){Dve(this.body,null),this.body.removeEventListener("cc-collide",this.onCollidedListener),e.sharedBodesMap.delete(this.node.uuid),delete xde.World.idToBodyMap[this.body.id],this.node=null,this.wrappedWorld=null,this.body=null,this.wrappedShapes=null,this.wrappedJoints0=null,this.wrappedJoints1=null,this.onCollidedListener=null},t.onCollided=function(e){LSe.type=e.event;var t=Ove(e.selfShape),n=Ove(e.otherShape);if(t&&t.collider.needCollisionEvent){NSe.push.apply(NSe,LSe.contacts),LSe.contacts.length=0,LSe.impl=e,LSe.selfCollider=t.collider,LSe.otherCollider=n?n.collider:null;var i=0;if("onCollisionExit"!==LSe.type)for(i=0;i<e.contacts.length;i++){var r=e.contacts[i];if(NSe.length>0){var o=NSe.pop();o.impl=r,LSe.contacts.push(o)}else{var a=new DSe(LSe);a.impl=r,LSe.contacts.push(a)}}for(i=0;i<this.wrappedShapes.length;i++)this.wrappedShapes[i].collider.emit(LSe.type,LSe)}},Z(e,[{key:"enabled",set:function(e){e?this.index<0&&(this.index=this.wrappedWorld.bodies.length,this.wrappedWorld.addSharedBody(this),this.syncInitial()):this.index>=0&&(0===this.wrappedShapes.length&&null==this.wrappedBody||0===this.wrappedShapes.length&&null!=this.wrappedBody&&!this.wrappedBody.isEnabled)&&(this.body.sleep(),this.index=-1,this.wrappedWorld.removeSharedBody(this))}},{key:"reference",set:function(e){e?this.ref++:this.ref--,0===this.ref&&this.destroy()}}]),e}();BSe.sharedBodesMap=new Map;var FSe=function(){var e=t.prototype;function t(){this.bodies=[],this.constraints=[],this._world=void 0,this._world=new xde.World,this._world.broadphase=new xde.NaiveBroadphase,this._world.solver.iterations=10,this._world.solver.tolerance=1e-4,this._world.defaultContactMaterial.contactEquationStiffness=1e6,this._world.defaultContactMaterial.frictionEquationStiffness=1e6,this._world.defaultContactMaterial.contactEquationRelaxation=3,this._world.defaultContactMaterial.frictionEquationRelaxation=3}return e.setDefaultMaterial=function(e){this._world.defaultMaterial.friction=e.friction,this._world.defaultMaterial.restitution=e.restitution,null!=RSe.idToMaterial[e.id]&&(RSe.idToMaterial[e.id]=this._world.defaultMaterial)},e.setAllowSleep=function(e){this._world.allowSleep=e},e.setGravity=function(e){In.copy(this._world.gravity,e)},e.destroy=function(){(this.constraints.length||this.bodies.length)&&T("You should destroy all physics component first."),this._world.broadphase=null,this._world=null},e.emitEvents=function(){this._world.emitTriggeredEvents(),this._world.emitCollisionEvents()},e.syncSceneToPhysics=function(){for(var e=0;e<this.bodies.length;e++)this.bodies[e].syncSceneToPhysics()},e.syncAfterEvents=function(){this.syncSceneToPhysics()},e.step=function(e,t,n){if(0!==this.bodies.length){this._world.step(e,t,n);for(var i=0;i<this.bodies.length;i++)this.bodies[i].syncPhysicsToScene()}},e.raycastClosest=function(e,n,i){kSe(e,n.maxDistance),TSe(GSe,n);var r=this._world.raycastClosest(zSe,USe,GSe,t.rayResult);return r&&bSe(i,t.rayResult),r},e.raycast=function(e,t,n,i){return kSe(e,t.maxDistance),TSe(GSe,t),this._world.raycastAll(zSe,USe,GSe,(function(e){var t=n.add();bSe(t,e),i.push(t)}))},e.getSharedBody=function(e,t){return BSe.getSharedBody(e,this,t)},e.addSharedBody=function(e){this.bodies.indexOf(e)<0&&(this.bodies.push(e),this._world.addBody(e.body))},e.removeSharedBody=function(e){var t=this.bodies.indexOf(e);t>=0&&(fe(this.bodies,t),this._world.remove(e.body))},e.addConstraint=function(e){this.constraints.indexOf(e)<0&&(this.constraints.push(e),this._world.addConstraint(e.impl))},e.removeConstraint=function(e){var t=this.constraints.indexOf(e);t>=0&&(fe(this.constraints,t),this._world.removeConstraint(e.impl))},Z(t,[{key:"impl",get:function(){return this._world}}]),t}();FSe.rayResult=new xde.RaycastResult;var zSe=new xde.Vec3,USe=new xde.Vec3;function kSe(e,t){In.copy(zSe,e.o),e.computeHit(USe,t)}var GSe={checkCollisionResponse:!1,collisionFilterGroup:-1,collisionFilterMask:-1,skipBackfaces:!0},HSe=function(e){function t(){var t;return(t=e.call(this)||this).halfExtent=void 0,t.halfExtent=new xde.Vec3(.5,.5,.5),t._shape=new xde.Box(t.halfExtent.clone()),t}$(t,e);var n=t.prototype;return n.updateSize=function(){In.multiplyScalar(this.halfExtent,this.collider.size,.5);var e=Nve(Mve.set(this.collider.node.worldScale)),t=this.halfExtent.x*e.x,n=this.halfExtent.y*e.y,i=this.halfExtent.z*e.z,r=Nme.instance.minVolumeSize;this.impl.halfExtents.x=ln(t,r,Number.MAX_VALUE),this.impl.halfExtents.y=ln(n,r,Number.MAX_VALUE),this.impl.halfExtents.z=ln(i,r,Number.MAX_VALUE),this.impl.updateConvexPolyhedronRepresentation(),-1!==this._index&&ESe(this._body)},n.onLoad=function(){e.prototype.onLoad.call(this),this.updateSize()},n.setScale=function(t){e.prototype.setScale.call(this,t),this.updateSize()},Z(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(RSe),VSe=function(e){$(n,e);var t=n.prototype;function n(t){var n;return void 0===t&&(t=.5),(n=e.call(this)||this)._shape=new xde.Sphere(t),n}return t.updateRadius=function(){var e=Math.abs(En(this.collider.node.worldScale));this.impl.radius=ln(this.collider.radius*Math.abs(e),Nme.instance.minVolumeSize,Number.MAX_VALUE),this.impl.updateBoundingSphereRadius(),-1!==this._index&&ESe(this._body)},t.onLoad=function(){e.prototype.onLoad.call(this),this.updateRadius()},t.setScale=function(t){e.prototype.setScale.call(this,t),this.updateRadius()},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(RSe),WSe=new xde.Vec3,jSe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.setMesh=function(e){if(this._isBinding){var t=e;if(null!=this._shape)if(t&&t.renderingSubMeshes.length>0){var n=t.renderingSubMeshes[0].geometricInfo.positions,i=t.renderingSubMeshes[0].geometricInfo.indices;this.updateProperties(n,i)}else this.updateProperties(new Float32Array,new Uint16Array);else if(t&&t.renderingSubMeshes.length>0){var r=t.renderingSubMeshes[0].geometricInfo.positions,o=t.renderingSubMeshes[0].geometricInfo.indices;this._shape=new xde.Trimesh(r,o)}else this._shape=new xde.Trimesh(new Float32Array,new Uint16Array)}},n.onComponentSet=function(){this.setMesh(this.collider.mesh)},n.onLoad=function(){e.prototype.onLoad.call(this),this.setMesh(this.collider.mesh)},n.setScale=function(t){e.prototype.setScale.call(this,t),In.copy(WSe,t),this.impl.setScale(WSe)},n.updateProperties=function(e,t){this.impl.vertices=new Float32Array(e),this.impl.indices=new Int16Array(t),this.impl.normals=new Float32Array(t.length),this.impl.aabb=new xde.AABB,this.impl.edges=[],this.impl.tree=new xde.Octree(new xde.AABB),this.impl.updateEdges(),this.impl.updateNormals(),this.impl.updateAABB(),this.impl.updateBoundingSphereRadius(),this.impl.updateTree(),this.impl.setScale(this.impl.scale),this._index>=0&&ESe(this._body)},Z(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(RSe),qSe=function(e){$(n,e);var t=n.prototype;function n(t,n,i){var r;return void 0===t&&(t=.5),void 0===n&&(n=2),void 0===i&&(i=pde.Y_AXIS),(r=e.call(this)||this)._shape=new xde.Cylinder(t,t,n,xde.CC_CONFIG.numSegmentsCylinder,i===pde.Y_AXIS),r}return t.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,xde.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&ESe(this._body)},t.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,xde.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&ESe(this._body)},t.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,xde.CC_CONFIG.numSegmentsCylinder,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&ESe(this._body)},t.onLoad=function(){e.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},t.setScale=function(t){e.prototype.setScale.call(this,t),this.setRadius(this.collider.radius)},t.updateProperties=function(e,t,n,i,r){var o=t,a=e,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*t,a=u(l(r.x),l(r.z))*e):2===i?(o=l(r.z)*t,a=u(l(r.x),l(r.y))*e):(o=l(r.x)*t,a=u(l(r.y),l(r.z))*e);var h=n,f=o/2,_=[],p=[],d=[],m=2*Math.PI/h;if(1===i){for(var v=[1],g=[0],y=0;y<h;y++){var x=a*s(m*y),S=a*c(m*y);_.push(new xde.Vec3(x,f,S)),_.push(new xde.Vec3(x,-f,S)),y<h-1?(p.push([2*y+2,2*y+3,2*y+1,2*y]),g.push(2*y+2),v.push(2*y+3)):p.push([0,1,2*y+1,2*y]),(h%2==1||y<h/2)&&d.push(new xde.Vec3(s(m*(y+.5)),0,c(m*(y+.5))))}p.push(v);for(var T=[],b=0;b<g.length;b++)T.push(g[g.length-b-1]);p.push(T),d.push(new xde.Vec3(0,1,0))}else if(2===i){for(var E=[0],C=[1],A=0;A<h;A++){var w=a*s(m*A),P=a*c(m*A);_.push(new xde.Vec3(w,P,f)),_.push(new xde.Vec3(w,P,-f)),A<h-1?(p.push([2*A,2*A+1,2*A+3,2*A+2]),E.push(2*A+2),C.push(2*A+3)):p.push([2*A,2*A+1,0,1]),(h%2==1||A<h/2)&&d.push(new xde.Vec3(s(m*(A+.5)),c(m*(A+.5)),0))}p.push(E);for(var R=[],I=0;I<C.length;I++)R.push(C[C.length-I-1]);p.push(R),d.push(new xde.Vec3(0,0,1))}else{for(var D=[0],O=[1],M=0;M<h;M++){var N=a*s(m*M),L=a*c(m*M);_.push(new xde.Vec3(f,N,L)),_.push(new xde.Vec3(-f,N,L)),M<h-1?(p.push([2*M,2*M+1,2*M+3,2*M+2]),D.push(2*M+2),O.push(2*M+3)):p.push([2*M,2*M+1,0,1]),(h%2==1||M<h/2)&&d.push(new xde.Vec3(0,s(m*(M+.5)),c(m*(M+.5))))}p.push(D);for(var B=[],F=0;F<O.length;F++)B.push(O[O.length-F-1]);p.push(B),d.push(new xde.Vec3(1,0,0))}this.impl.vertices=_,this.impl.faces=p,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(RSe),XSe=new In,YSe=new In,KSe=function(e){$(n,e);var t=n.prototype;function n(t,n,i){var r;return void 0===t&&(t=.5),void 0===n&&(n=1),void 0===i&&(i=pde.Y_AXIS),(r=e.call(this)||this)._shape=new xde.Cylinder(0,t,n,xde.CC_CONFIG.numSegmentsCone,i===pde.Y_AXIS),r}return t.setRadius=function(){this.updateProperties(this.collider.radius,this.collider.height,xde.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&ESe(this._body)},t.setHeight=function(){this.updateProperties(this.collider.radius,this.collider.height,xde.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&ESe(this._body)},t.setDirection=function(){this.updateProperties(this.collider.radius,this.collider.height,xde.CC_CONFIG.numSegmentsCone,this.collider.direction,this.collider.node.worldScale),-1!==this._index&&ESe(this._body)},t.onLoad=function(){e.prototype.onLoad.call(this),this.setRadius(this.collider.radius)},t.setScale=function(t){e.prototype.setScale.call(this,t),this.setRadius(this.collider.radius)},t.updateProperties=function(e,t,n,i,r){var o=t,a=e,s=Math.cos,c=Math.sin,l=Math.abs,u=Math.max;1===i?(o=l(r.y)*t,a=u(l(r.x),l(r.z))*e):2===i?(o=l(r.z)*t,a=u(l(r.x),l(r.y))*e):(o=l(r.x)*t,a=u(l(r.y),l(r.z))*e);var h=n,f=o/2,_=[],p=[],d=[],m=2*Math.PI/h;if(1===i){var v=[];p.push(v),_.push(new xde.Vec3(0,f,0));for(var g=0;g<h;g++){var y=a*s(m*g),x=a*c(m*g);_.push(new xde.Vec3(y,-f,x))}for(var S=0;S<h;S++){0!==S&&v.push(S);var T;T=S<h-1?[0,S+2,S+1]:[0,1,S+1],p.push(T),In.subtract(XSe,_[0],_[T[1]]),In.subtract(YSe,_[T[2]],_[T[1]]),In.cross(XSe,YSe,XSe),XSe.normalize(),d.push(new xde.Vec3(XSe.x,XSe.y,XSe.z))}d.push(new xde.Vec3(0,-1,0))}else if(2===i){var b=[];p.push(b),_.push(new xde.Vec3(0,0,f));for(var E=0;E<h;E++){var C=a*s(m*E),A=a*c(m*E);_.push(new xde.Vec3(C,A,-f))}for(var w=0;w<h;w++){0!==w&&b.push(h-w);var P;P=w<h-1?[0,w+1,w+2]:[0,w+1,1],p.push(P),In.subtract(XSe,_[0],_[P[1]]),In.subtract(YSe,_[P[2]],_[P[1]]),In.cross(XSe,XSe,YSe),XSe.normalize(),d.push(new xde.Vec3(XSe.x,XSe.y,XSe.z))}d.push(new xde.Vec3(0,0,-1))}else{var R=[];p.push(R),_.push(new xde.Vec3(f,0,0));for(var I=0;I<h;I++){var D=a*s(m*I),O=a*c(m*I);_.push(new xde.Vec3(-f,D,O))}for(var M=0;M<h;M++){0!==M&&R.push(h-M);var N;N=M<h-1?[0,M+1,M+2]:[0,M+1,1],p.push(N),In.subtract(XSe,_[0],_[N[1]]),In.subtract(YSe,_[N[2]],_[N[1]]),In.cross(XSe,XSe,YSe),XSe.normalize(),d.push(new xde.Vec3(XSe.x,XSe.y,XSe.z))}d.push(new xde.Vec3(-1,0,0))}this.impl.vertices=_,this.impl.faces=p,this.impl.uniqueAxes=d,this.impl.worldVerticesNeedsUpdate=!0,this.impl.worldFaceNormalsNeedsUpdate=!0,this.impl.computeNormals(),this.impl.computeEdges(),this.impl.updateBoundingSphereRadius()},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(RSe),QSe=new xde.AABB,ZSe=new xde.AABB,JSe=new xde.Transform;xde.Heightfield.prototype.calculateWorldAABB=function(e,t,n,i){var r=JSe,o=ZSe;In.copy(r.position,e),Fn.copy(r.quaternion,t);var a=this.elementSize,s=this.data;QSe.lowerBound.set(0,0,this.minValue),QSe.upperBound.set((s.length-1)*a,(s[0].length-1)*a,this.maxValue),QSe.toWorldFrame(r,o),n.copy(o.lowerBound),i.copy(o.upperBound)};var $Se,eTe=function(e){$(n,e);var t=n.prototype;function n(){var t;return(t=e.call(this)||this).data=void 0,t.options=void 0,t._terrainID=void 0,t.data=[[]],t.options={elementSize:0},t._terrainID="",t}return t.setTerrain=function(e){if(e){if(this._terrainID!==e._uuid){var t=e,n=t.getVertexCountI(),i=t.getVertexCountJ();this._terrainID=t._uuid,this.data.length=n-1;for(var r=0;r<n;r++){null==this.data[r]&&(this.data[r]=[]),this.data[r].length=i-1;for(var o=0;o<i;o++)this.data[r][o]=t.getHeight(r,i-1-o)}this.options.elementSize=t.tileSize,this.updateProperties(this.data,this.options.elementSize)}}else""!==this._terrainID&&(this._terrainID="",this.data.length=1,this.data[0]=this.data[0]||[],this.data[0].length=0,this.options.elementSize=0,this.updateProperties(this.data,this.options.elementSize))},t.onComponentSet=function(){var e=this.collider.terrain;if(e){for(var t=e.getVertexCountI(),n=e.getVertexCountJ(),i=0;i<t;i++){null==this.data[i]&&(this.data[i]=[]);for(var r=0;r<n;r++)this.data[i][r]=e.getHeight(i,n-1-r)}this.options.elementSize=e.tileSize,this._terrainID=e._uuid}this._shape=new xde.Heightfield(this.data,this.options)},t.onLoad=function(){e.prototype.onLoad.call(this),this.setTerrain(this.collider.terrain)},t.updateProperties=function(e,t){var n=this.impl;n.data=e,n.elementSize=t,n.updateMinValue(),n.updateMaxValue(),n.updateBoundingSphereRadius(),n.update(),this._index>=0&&ESe(this._body)},t._setCenter=function(e){var t=this.collider.terrain;if(t){Fn.fromEuler(this._orient,-90,0,0);var n=this._offset;In.set(n,0,0,(t.getVertexCountJ()-1)*t.tileSize),In.add(n,n,e)}},Z(n,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),n}(RSe),tTe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).vertices=[],t}$(t,e);var n=t.prototype;return n.setShapeType=function(){this._isBinding},n.setVertices=function(e){var t=this.vertices.length;if(4===t){for(var n=this._collider.node.worldScale,i=0;i<t;i++)In.multiply(this.vertices[i],n,e[i]);var r=this.impl;r.computeNormals(),r.computeEdges(),r.updateBoundingSphereRadius()}-1!==this._index&&ESe(this._body)},n.onComponentSet=function(){if(this.collider.shapeType===Ixe.ESimplexType.TETRAHEDRON){for(var e=0;e<4;e++)this.vertices[e]=new xde.Vec3(0,0,0);this._shape=nTe(this.vertices)}else Ixe.ESimplexType.VERTEX,this._shape=new xde.Particle},n.onLoad=function(){e.prototype.onLoad.call(this),this.collider.updateVertices()},n.setScale=function(t){e.prototype.setScale.call(this,t),this.collider.updateVertices()},Z(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(RSe),nTe=($Se=[[0,3,2],[0,1,3],[0,2,1],[1,2,3]],function(e){return new xde.ConvexPolyhedron(e,$Se)}),iTe=function(e){function t(){var t;return(t=e.call(this)||this)._shape=new xde.Plane,t}$(t,e);var n=t.prototype;return n.setNormal=function(e){Fn.rotationTo(this._orient,In.UNIT_Z,e),-1!==this._index&&ESe(this._body)},n.setConstant=function(e){In.scaleAndAdd(this._offset,this._collider.center,this.collider.normal,e)},n.onLoad=function(){e.prototype.onLoad.call(this),this.setConstant(this.collider.constant),this.setNormal(this.collider.normal)},n._setCenter=function(t){e.prototype._setCenter.call(this,t),this.setConstant(this.collider.constant)},Z(t,[{key:"collider",get:function(){return this._collider}},{key:"impl",get:function(){return this._shape}}]),t}(RSe);xde.World.staticBody=new xde.Body,xde.World.idToConstraintMap={};var rTe,oTe,aTe,sTe,cTe,lTe,uTe,hTe,fTe,_Te=function(){function e(){}var t=e.prototype;return t.setConnectedBody=function(e){var t=Ove(this.impl.bodyB);t&&t.removeJoint(this,1),e?(this._impl.bodyB=e.body.impl,e.body.sharedBody.addJoint(this,1)):this._impl.bodyB=xde.World.staticBody;var n=this._impl.bodyB;this._impl.equations.forEach((function(e){e.bj=n}))},t.setEnableCollision=function(e){this._impl.collideConnected=e},t.initialize=function(e){this._com=e,this._rigidBody=e.attachedBody,this.onComponentSet(),this.setEnableCollision(e.enableCollision),xde.World.idToConstraintMap[this._impl.id]=this._impl},t.onComponentSet=function(){},t.updateScale0=function(){},t.updateScale1=function(){},t.onEnable=function(){var e=this._rigidBody.body.sharedBody;e.wrappedWorld.addConstraint(this),e.addJoint(this,0);var t=this.constraint.connectedBody;t&&t.body.sharedBody.addJoint(this,1)},t.onDisable=function(){var e=this._rigidBody.body.sharedBody;e.wrappedWorld.removeConstraint(this),e.removeJoint(this,0);var t=this.constraint.connectedBody;t&&t.body.sharedBody.removeJoint(this,1)},t.onDestroy=function(){delete xde.World.idToConstraintMap[this._impl.id],this._com=null,this._rigidBody=null,this._impl=null},Z(e,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),e}(),pTe=new In,dTe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.setPivotA=function(){var e=this.constraint;In.multiply(this.impl.pivotA,e.node.worldScale,e.pivotA),e.connectedBody||this.setPivotB(e.pivotB)},n.setPivotB=function(){var e=this.constraint,t=e.connectedBody;if(t)In.multiply(this.impl.pivotB,t.node.worldScale,e.pivotB);else{var n=e.node;In.multiply(pTe,n.worldScale,e.pivotA),In.add(pTe,pTe,n.worldPosition),In.add(pTe,pTe,e.pivotB),In.copy(this.impl.pivotB,pTe)}},n.onComponentSet=function(){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,n=xde.World.staticBody;t&&(n=t.body.impl),this._impl=new xde.PointToPointConstraint(e,null,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},Z(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(_Te),mTe=new In,vTe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.setPivotA=function(){var e=this.constraint;In.multiply(this.impl.pivotA,this.constraint.node.worldScale,e.pivotA),e.connectedBody||this.setPivotB(e.pivotB)},n.setPivotB=function(){var e=this.constraint,t=e.connectedBody;if(t)In.multiply(this.impl.pivotB,t.node.worldScale,e.pivotB);else{var n=this.constraint.node;In.multiply(mTe,n.worldScale,e.pivotA),In.add(mTe,mTe,n.worldPosition),In.add(mTe,mTe,e.pivotB),In.copy(this.impl.pivotB,mTe)}},n.setAxis=function(e){In.copy(this.impl.axisA,e),In.copy(this.impl.equations[3].axisA,e),In.copy(this.impl.equations[4].axisA,e),In.copy(this.impl.equations[5].axisA,e),this.constraint.connectedBody?(In.copy(this.impl.axisB,e),In.copy(this.impl.equations[3].axisB,e),In.copy(this.impl.equations[4].axisB,e),In.copy(this.impl.equations[5].axisB,e)):(In.transformQuat(this.impl.axisB,e,this.constraint.node.worldRotation),In.copy(this.impl.equations[3].axisB,this.impl.axisB),In.copy(this.impl.equations[4].axisB,this.impl.axisB),In.copy(this.impl.equations[5].axisB,this.impl.axisB))},n.onComponentSet=function(){var e=this._rigidBody.body.impl,t=this.constraint.connectedBody,n=xde.World.staticBody;t&&(n=t.body.impl),this._impl=new xde.HingeConstraint(e,n),this.setPivotA(this.constraint.pivotA),this.setPivotB(this.constraint.pivotB),this.setAxis(this.constraint.axis)},n.updateScale0=function(){this.setPivotA(this.constraint.pivotA)},n.updateScale1=function(){this.setPivotB(this.constraint.pivotB)},Z(t,[{key:"impl",get:function(){return this._impl}},{key:"constraint",get:function(){return this._com}}]),t}(_Te);VM.once(HM.EVENT_ENGINE_INITED,(function(){bde.register("cannon.js",{PhysicsWorld:FSe,RigidBody:SSe,BoxShape:HSe,SphereShape:VSe,TrimeshShape:jSe,CylinderShape:qSe,ConeShape:KSe,TerrainShape:eTe,SimplexShape:tTe,PlaneShape:iTe,PointToPointConstraint:dTe,HingeConstraint:vTe})})),window&&(window.CANNON=xde),xde.CC_CONFIG={numSegmentsCone:12,numSegmentsCylinder:12,ignoreSelfBody:!0,correctInelastic:3},xde.ArrayCollisionMatrix.prototype.reset=function(){for(var e in this.matrix)delete this.matrix[e]},xde.Ray.perBodyFilter=function(e,t){return 0!=(e.collisionFilterMask&t.collisionFilterGroup)},function(e){e[e.BOX=0]="BOX",e[e.SPHERE=1]="SPHERE",e[e.CYLINDER=2]="CYLINDER",e[e.CONE=3]="CONE",e[e.CAPSULE=4]="CAPSULE",e[e.TORUS=5]="TORUS",e[e.PLANE=6]="PLANE",e[e.QUAD=7]="QUAD"}(fTe||(fTe={})),ut(fTe);var gTe=e("Primitive",(rTe=mc("cc.Primitive"),oTe=Zc(fTe),rTe((hTe=uTe=function(e){function t(t){var n;return void 0===t&&(t=fTe.BOX),ce(n=e.call(this)||this,"type",cTe,oe(n)),ce(n,"info",lTe,oe(n)),n.type=t,n}return $(t,e),t.prototype.onLoaded=function(){R4(Ive[fTe[this.type].toLowerCase()](this.info),this)},t}(S4),uTe.PrimitiveType=fTe,cTe=le((sTe=hTe).prototype,"type",[oTe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fTe.BOX}}),lTe=le(sTe.prototype,"info",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return{}}}),aTe=sTe))||aTe));u.Primitive=gTe,u.primitives=Ive;var yTe,xTe=function(){function e(e,t,n){this._id=void 0,this._opts=void 0,this._accumStart=void 0,this._total=0,this._value=0,this._averageValue=0,this._accumValue=0,this._accumSamples=0,this._id=e,this._opts=t,this._accumStart=n}var t=e.prototype;return t.sample=function(e){this._average(this._value,e)},t.human=function(){var e=this._opts,t=e.average,n=e.isInteger,i=t?this._averageValue:this._value;return n?Math.round(i):Math.round(100*i)/100},t.alarm=function(){return this._opts.below&&this._value<this._opts.below||this._opts.over&&this._value>this._opts.over},t._average=function(e,t){if(void 0===t&&(t=0),this._opts.average){this._accumValue+=e,++this._accumSamples;var n=t;n-this._accumStart>=this._opts.average&&(this._averageValue=this._accumValue/this._accumSamples,this._accumValue=0,this._accumStart=n,this._accumSamples=0)}},Z(e,[{key:"value",get:function(){return this._value},set:function(e){this._value=e}}]),e}(),STe=mc("cc.PerfCounter")(yTe=function(e){function t(t,n,i){var r;return(r=e.call(this,t,n,i)||this)._time=void 0,r._time=i,r}$(t,e);var n=t.prototype;return n.start=function(e){void 0===e&&(e=0),this._time=e},n.end=function(e){void 0===e&&(e=0),this._value=e-this._time,this._average(this._value)},n.tick=function(){this.end(),this.start()},n.frame=function(e){var t=e,n=t-this._time;this._total++,n>(this._opts.average||1e3)&&(this._value=1e3*this._total/n,this._total=0,this._time=t,this._average(this._value))},t}(xTe))||yTe,TTe="0123456789. ",bTe=500,ETe={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,".":10},CTe={fps:{desc:"Framerate (FPS)",below:30,average:bTe,isInteger:!0},draws:{desc:"Draw call",isInteger:!0},frame:{desc:"Frame time (ms)",min:0,max:50,average:bTe},instances:{desc:"Instance Count",isInteger:!0},tricount:{desc:"Triangle",isInteger:!0},logic:{desc:"Game Logic (ms)",min:0,max:50,average:bTe,color:"#080"},physics:{desc:"Physics (ms)",min:0,max:50,average:bTe},render:{desc:"Renderer (ms)",min:0,max:50,average:bTe,color:"#f90"},textureMemory:{desc:"GFX Texture Mem(M)"},bufferMemory:{desc:"GFX Buffer Mem(M)"}},ATe=e("Profiler",function(){function e(){this._stats=null,this.id="__Profiler__",this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer=null,this._canvas=null,this._ctx=null,this._texture=null,this._region=new sr,this._canvasArr=[],this._regionArr=[this._region],this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(CTe).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0,this._canvas=document.createElement("canvas"),this._ctx=this._canvas.getContext("2d"),this._canvasArr.push(this._canvas)}var t=e.prototype;return t.reset=function(){this._stats=null,this._showFPS=!1,this._rootNode=null,this._device=null,this._swapchain=null,this._pipeline=null,this._meshRenderer&&this._meshRenderer.destroy(),this._meshRenderer=null,this.digitsData=null,this.offsetData=null,this.pass=null,this._canvasDone=!1,this._statsDone=!1,this._inited=!1,this._lineHeight=256/(Object.keys(CTe).length+1),this._wordHeight=0,this._eachNumWidth=0,this._totalLines=0,this.lastTime=0},t.isShowingStats=function(){return this._showFPS},t.hideStats=function(){this._showFPS&&(this._rootNode&&(this._rootNode.active=!1),u.director.off(u.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),u.director.off(u.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),u.director.off(u.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),u.director.off(u.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),u.director.off(u.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),u.director.off(u.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!1,this._pipeline.profiler=null,u.game.config.showFPS=!1)},t.showStats=function(){if(!this._showFPS){if(!this._device){var e=u.director.root;this._device=e.device,this._swapchain=e.mainWindow.swapchain,this._pipeline=e.pipeline}this.generateCanvas(),this.generateStats(),u.game.once(u.Game.EVENT_ENGINE_INITED,this.generateNode,this),this._rootNode&&(this._rootNode.active=!0),u.director.on(u.Director.EVENT_BEFORE_UPDATE,this.beforeUpdate,this),u.director.on(u.Director.EVENT_AFTER_UPDATE,this.afterUpdate,this),u.director.on(u.Director.EVENT_BEFORE_PHYSICS,this.beforePhysics,this),u.director.on(u.Director.EVENT_AFTER_PHYSICS,this.afterPhysics,this),u.director.on(u.Director.EVENT_BEFORE_DRAW,this.beforeDraw,this),u.director.on(u.Director.EVENT_AFTER_DRAW,this.afterDraw,this),this._showFPS=!0,this._canvasDone=!0,this._statsDone=!0,u.game.config.showFPS=!0}},t.generateCanvas=function(){if(!this._canvasDone){this._ctx&&this._canvas&&(this._canvas.width=256,this._canvas.height=256,this._canvas.style.width=""+this._canvas.width,this._canvas.style.height=""+this._canvas.height,this._ctx.font="23px Arial",this._ctx.textBaseline="top",this._ctx.fillStyle="#fff",this._texture=this._device.createTexture(new gr(Si.TEX2D,Ti.SAMPLED|Ti.TRANSFER_DST,pi.RGBA8,256,256)),this._region.texExtent.width=256,this._region.texExtent.height=256)}},t.generateStats=function(){if(!this._statsDone&&this._ctx&&this._canvas){this._stats=null;var e=performance.now();this._ctx.textAlign="left";var t=0;for(var n in CTe){var i=CTe[n];this._ctx.fillText(i.desc,0,t*this._lineHeight),i.counter=new STe(n,i,e),t++}this._totalLines=t,this._wordHeight=this._totalLines*this._lineHeight/this._canvas.height;for(var r=0;r<TTe.length;++r){var o=this._ctx.measureText(TTe[r]).width;this._eachNumWidth=Math.max(this._eachNumWidth,o)}for(var a=0;a<TTe.length;++a)this._ctx.fillText(TTe[a],a*this._eachNumWidth,this._totalLines*this._lineHeight);this._eachNumWidth/=this._canvas.width,this._stats=CTe,this._canvasArr[0]=this._canvas,this._device.copyTexImagesToTexture(this._canvasArr,this._texture,this._regionArr)}},t.generateNode=function(){if(!this._rootNode||!this._rootNode.isValid){this._rootNode=new qC("PROFILER_NODE"),u.game.addPersistRootNode(this._rootNode);var e=new qC("Profiler_Root");e.parent=this._rootNode;for(var t=.4,n=t/this._totalLines,i=t/this._wordHeight,r=n/23,o=this._eachNumWidth*this._canvas.width*r,a=[0,t,0,i,t,0,i,0,0,0,0,0],s=[0,2,1,0,3,2],c=[0,0,-1,0,1,0,-1,0,1,this._wordHeight,-1,0,0,this._wordHeight,-1,0],l=0,h=0;h<this._totalLines;h++)for(var f=0;f<8;f++){a.push(i+f*o,t-h*n,0),a.push(i+(f+1)*o,t-h*n,0),a.push(i+(f+1)*o,t-(h+1)*n,0),a.push(i+f*o,t-(h+1)*n,0),l=4*(8*h+f+1),s.push(0+l,2+l,1+l,0+l,3+l,2+l);var _=8*h+f,p=Math.floor(_/4),d=_-4*p;c.push(0,this._wordHeight,p,d),c.push(this._eachNumWidth,this._wordHeight,p,d),c.push(this._eachNumWidth,1,p,d),c.push(0,1,p,d)}this._meshRenderer=e.addComponent(S3),this._meshRenderer.mesh=R4({positions:a,indices:s,colors:c});var m=new ug;m.initialize({effectName:"profiler"});var v=this.pass=m.passes[0],g=v.getBinding("mainTexture"),y=v.getBinding("digits"),x=v.getBinding("offset");v.bindTexture(g,this._texture),this.digitsData=v.blocks[y],this.offsetData=v.blocks[x],this.offsetData[3]=-1,this._meshRenderer.material=m,this._meshRenderer.node.layer=Fp.Enum.PROFILER,this._inited=!0}},t.beforeUpdate=function(){if(this._stats){var e=performance.now();this._stats.frame.counter.start(e),this._stats.logic.counter.start(e)}},t.afterUpdate=function(){if(this._stats){var e=performance.now();u.director.isPaused()?this._stats.frame.counter.start(e):this._stats.logic.counter.end(e)}},t.beforePhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.start(e)}},t.afterPhysics=function(){if(this._stats){var e=performance.now();this._stats.physics.counter.end(e)}},t.beforeDraw=function(){if(this._stats&&this._inited){var e=this._swapchain.surfaceTransform,t=this._device.capabilities.clipSpaceSignY;if(e!==this.offsetData[3]){var n=Wn[e],i=-.9*t;this.offsetData[0]=-.9*n[0]+i*n[2],this.offsetData[1]=-.9*n[1]+i*n[3],this.offsetData[2]=this._eachNumWidth,this.offsetData[3]=e}this.pass._setRootBufferDirty(!0),this._meshRenderer.model&&(this._pipeline.profiler=this._meshRenderer.model);var r=performance.now();this._stats.render.counter.start(r)}},t.afterDraw=function(){if(this._stats&&this._inited){var e=performance.now();if(this._stats.frame.counter.end(e),this._stats.fps.counter.frame(e),this._stats.render.counter.end(e),!(e-this.lastTime<bTe)){this.lastTime=e;var t=this._device;this._stats.draws.counter.value=t.numDrawCalls,this._stats.instances.counter.value=t.numInstances,this._stats.bufferMemory.counter.value=t.memoryStatus.bufferSize/1048576,this._stats.textureMemory.counter.value=t.memoryStatus.textureSize/1048576,this._stats.tricount.counter.value=t.numTris;var n=0,i=this.digitsData;for(var r in this._stats){var o=this._stats[r];o.counter.sample(e);for(var a=o.counter.human().toString(),s=7;s>=0;s--){var c=8*n+s,l=a[a.length-(8-s)],u=ETe[l];void 0===u&&(u=11),i[c]=u}n++}}}},e}()),wTe=e("profiler",new ATe);u.profiler=wTe,e("HeightField",function(){function e(e,t){this.data=new Uint16Array,this.w=0,this.h=0,this.w=e,this.h=t,this.data=new Uint16Array(e*t);for(var n=0;n<e*t;++n)this.data[n]=0}var t=e.prototype;return t.set=function(e,t,n){this.data[t*this.w+e]=n},t.get=function(e,t){return this.data[t*this.w+e]},t.getClamp=function(e,t){return e=ln(e,0,this.w-1),t=ln(t,0,this.h-1),this.get(e,t)},t.getAt=function(e,t){var n=e,i=t,r=Math.floor(n),o=Math.floor(i),a=r+1,s=o+1,c=n-r,l=i-o;r=ln(r,0,this.w-1),o=ln(o,0,this.h-1),a=ln(a,0,this.w-1),s=ln(s,0,this.h-1);var u=this.get(r,o),h=this.get(a,o),f=this.get(r,s),_=this.get(a,s),p=.5*(h+f);return c+l<=1?_=p+(p-u):u=p+(p-_),(u*(1-c)+h*c)*(1-l)+(f*(1-c)+_*c)*l},e}());var PTe,RTe,ITe,DTe,OTe,MTe,NTe,LTe,BTe,FTe,zTe,UTe,kTe,GTe,HTe,VTe,WTe,jTe,qTe,XTe,YTe,KTe,QTe,ZTe,JTe,$Te,ebe,tbe,nbe,ibe,rbe,obe,abe,sbe,cbe,lbe,ube,hbe,fbe,_be,pbe,dbe,mbe,vbe,gbe,ybe,xbe,Sbe,Tbe=33,bbe=1e14,Ebe=function(){function e(){this.level=0,this.north=0,this.south=0,this.west=0,this.east=0}return e.prototype.equals=function(e){return this.level===e.level&&this.north===e.north&&this.south===e.south&&this.west===e.west&&this.east===e.east},e}(),Cbe=function(){this.size=0,this.indices=null},Abe=function(){this.key=new Ebe,this.start=0,this.size=0,this.buffer=null,this.primCount=0},wbe=function(){function e(){this._bodyIndexPool=void 0,this._connecterIndexPool=void 0,this._indexMap=[],this._indexBuffer=new Uint16Array,this._bodyIndexPool=new Array(4);for(var t=0;t<4;++t)this._bodyIndexPool[t]=new Cbe;this._connecterIndexPool=new Array(64);for(var n=0;n<4;++n)for(var i=0;i<4;++i)for(var r=0;r<4;++r)this._connecterIndexPool[e.mapIndex(n,i,r)]=new Cbe;for(var o=0;o<4;++o)this._genBodyIndex(o);for(var a=0;a<4;++a)for(var s=0;s<4;++s)this._genConnecterIndexNorth(a,s),this._genConnecterIndexSouth(a,s),this._genConnecterIndexWest(a,s),this._genConnecterIndexEast(a,s);for(var c=0;c<4;++c)for(var l=0;l<4;++l)if(!(l<c))for(var u=0;u<4;++u)if(!(u<c))for(var h=0;h<4;++h)if(!(h<c))for(var f=0;f<4;++f)if(!(f<c)){var _=new Ebe;_.level=c,_.north=l,_.south=u,_.west=h,_.east=f,this._genIndexData(_)}}e.mapIndex=function(e,t,n){return 16*e+4*t+n};var t=e.prototype;return t.getIndexData=function(e){for(var t=0;t<this._indexMap.length;++t)if(this._indexMap[t].key.equals(e))return this._indexMap[t];return null},t._genBodyIndex=function(e){var t=1<<e,n=32>>e,i=0;if(e<3&&(n-=2,i=t*Tbe+t),0!==n&&0!==n){var r=n*n*6;this._bodyIndexPool[e].indices=new Uint16Array(r);for(var o=0,a=new Uint16Array(r),s=i,c=s+Tbe*t,l=0;l<n;++l){for(var u=0;u<n;++u)a[o++]=c+u*t,a[o++]=c+(u+1)*t,a[o++]=s+u*t,a[o++]=c+(u+1)*t,a[o++]=s+(u+1)*t,a[o++]=s+u*t;s+=Tbe*t,c+=Tbe*t}this._bodyIndexPool[e].size=o,this._bodyIndexPool[e].indices=a}},t._genConnecterIndexNorth=function(t,n){var i=e.mapIndex(t,n,0);if(n<t||3===t)return this._connecterIndexPool[i].size=0,void(this._connecterIndexPool[i].indices=null);var r=1<<t,o=1<<n,a=32>>t,s=0,c=new Uint16Array(2*a+2);c[s++]=0,c[s++]=0;for(var l=1;l<a;++l){var u=l*r,h=r*Tbe+u,f=(r-r)*Tbe+u/o*o;c[s++]=h,c[s++]=f}c[s++]=32,c[s++]=32,this._connecterIndexPool[i].size=s,this._connecterIndexPool[i].indices=c},t._genConnecterIndexSouth=function(t,n){var i=e.mapIndex(t,n,1);if(n<t||3===t)return this._connecterIndexPool[i].size=0,void(this._connecterIndexPool[i].indices=null);var r=1<<t,o=1<<n,a=32>>t,s=0,c=new Uint16Array(2*a+2);c[s++]=1056,c[s++]=1056;for(var l=1;l<a;++l){var u=l*r,h=32-r,f=(h+r)*Tbe+u/o*o,_=h*Tbe+u;c[s++]=f,c[s++]=_}c[s++]=1088,c[s++]=1088,this._connecterIndexPool[i].size=s,this._connecterIndexPool[i].indices=c},t._genConnecterIndexWest=function(t,n){var i=e.mapIndex(t,n,2);if(n<t||3===t)return this._connecterIndexPool[i].size=0,void(this._connecterIndexPool[i].indices=null);var r=1<<t,o=1<<n,a=32>>t,s=0,c=new Uint16Array(2*a+2);c[s++]=0,c[s++]=0;for(var l=1;l<a;++l){var u=l*r/o*o*Tbe+0,h=l*r*Tbe+r;c[s++]=u,c[s++]=h}c[s++]=1056,c[s++]=1056,this._connecterIndexPool[i].size=s,this._connecterIndexPool[i].indices=c},t._genConnecterIndexEast=function(t,n){var i=e.mapIndex(t,n,3);if(n<t||3===t)return this._connecterIndexPool[i].size=0,void(this._connecterIndexPool[i].indices=null);var r=1<<t,o=1<<n,a=32>>t,s=0,c=new Uint16Array(2*a+2);c[s++]=32,c[s++]=32;for(var l=1;l<a;++l){var u=l*r*Tbe+(32-r),h=l*r/o*o*Tbe+32;c[s++]=u,c[s++]=h}c[s++]=1088,c[s++]=1088,this._connecterIndexPool[i].size=s,this._connecterIndexPool[i].indices=c},t._getConnenterIndex=function(t,n,i){return this._connecterIndexPool[e.mapIndex(t,n,i)]},t._genIndexData=function(e){var t=this.getIndexData(e);if(null!=t)return t;var n=this._bodyIndexPool[e.level],i=this._getConnenterIndex(e.level,e.north,0),r=this._getConnenterIndex(e.level,e.south,1),o=this._getConnenterIndex(e.level,e.west,2),a=this._getConnenterIndex(e.level,e.east,3);if((t=new Abe).size=0,t.primCount=0,null!=n.indices&&(t.size+=n.size),i.indices&&(t.size+=3*(i.size-2)),r.indices&&(t.size+=3*(r.size-2)),o.indices&&(t.size+=3*(o.size-2)),a.indices&&(t.size+=3*(a.size-2)),0===t.size)return null;var s=0;if(t.buffer=new Uint16Array(t.size),t.key.level=e.level,t.key.east=e.east,t.key.west=e.west,t.key.north=e.north,t.key.south=e.south,n.indices)for(var c=0;c<n.size;++c)t.buffer[s++]=n.indices[c];if(i.indices)for(var l=0;l<i.size-2;l+=2){var u=i.indices[l+0],h=i.indices[l+1],f=i.indices[l+2],_=i.indices[l+3];t.buffer[s++]=u,t.buffer[s++]=f,t.buffer[s++]=h,t.buffer[s++]=f,t.buffer[s++]=_,t.buffer[s++]=h}if(r.indices)for(var p=0;p<r.size-2;p+=2){var d=r.indices[p+0],m=r.indices[p+1],v=r.indices[p+2],g=r.indices[p+3];t.buffer[s++]=d,t.buffer[s++]=v,t.buffer[s++]=m,t.buffer[s++]=v,t.buffer[s++]=g,t.buffer[s++]=m}if(o.indices)for(var y=0;y<o.size-2;y+=2){var x=o.indices[y+0],S=o.indices[y+1],T=o.indices[y+2],b=o.indices[y+3];t.buffer[s++]=x,t.buffer[s++]=T,t.buffer[s++]=S,t.buffer[s++]=T,t.buffer[s++]=b,t.buffer[s++]=S}if(a.indices)for(var E=0;E<a.size-2;E+=2){var C=a.indices[E+0],A=a.indices[E+1],w=a.indices[E+2],P=a.indices[E+3];t.buffer[s++]=C,t.buffer[s++]=w,t.buffer[s++]=A,t.buffer[s++]=w,t.buffer[s++]=P,t.buffer[s++]=A}t.primCount=s/3,t.start=this._indexBuffer.length,this._indexMap.push(t);var R=new Uint16Array(t.start+t.size);return R.set(this._indexBuffer,0),R.set(t.buffer,t.start),this._indexBuffer=R,t},e}(),Pbe=e("TerrainInfo",mc("cc.TerrainInfo")((NTe=function(){function e(){ce(this,"tileSize",ITe,this),ce(this,"blockCount",DTe,this),ce(this,"weightMapSize",OTe,this),ce(this,"lightMapSize",MTe,this)}return Z(e,[{key:"size",get:function(){var e=new ni(0,0);return e.width=this.blockCount[0]*fxe*this.tileSize,e.height=this.blockCount[1]*fxe*this.tileSize,e}},{key:"tileCount",get:function(){var e=[0,0];return e[0]=this.blockCount[0]*fxe,e[1]=this.blockCount[1]*fxe,e}},{key:"vertexCount",get:function(){var e=this.tileCount;return e[0]+=1,e[1]+=1,e}}]),e}(),ITe=le((RTe=NTe).prototype,"tileSize",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),DTe=le(RTe.prototype,"blockCount",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[1,1]}}),OTe=le(RTe.prototype,"weightMapSize",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),MTe=le(RTe.prototype,"lightMapSize",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 128}}),PTe=RTe))||PTe),Rbe=e("TerrainLayer",mc("cc.TerrainLayer")((FTe=le((BTe=function(){ce(this,"detailMap",FTe,this),ce(this,"normalMap",zTe,this),ce(this,"tileSize",UTe,this),ce(this,"metallic",kTe,this),ce(this,"roughness",GTe,this)}).prototype,"detailMap",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zTe=le(BTe.prototype,"normalMap",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),UTe=le(BTe.prototype,"tileSize",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),kTe=le(BTe.prototype,"metallic",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GTe=le(BTe.prototype,"roughness",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),LTe=BTe))||LTe),Ibe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._model=null,t._meshData=null,t._brushPass=null,t._brushMaterial=null,t._currentMaterial=null,t._currentMaterialLayers=0,t}$(t,e);var n=t.prototype;return n.destroy=function(){return null!=this._model&&(u.director.root.destroyModel(this._model),this._model=null),e.prototype.destroy.call(this)},n._destroyModel=function(){null!=this._model&&(u.director.root.destroyModel(this._model),this._model=null)},n._invalidMaterial=function(){null!=this._currentMaterial&&(this._clearMaterials(),this._brushPass=null,this._currentMaterial=null,null!=this._model&&(this._model.enabled=!1))},n._updateMaterial=function(e,t){if(null!=this._meshData&&null!=this._model){var n=e.getMaxLayer();if(null==this._currentMaterial||n!==this._currentMaterialLayers){if(this._currentMaterial=new ug,this._currentMaterial.initialize({effectAsset:e.getTerrain().getEffectAsset(),defines:e._getMaterialDefines(n)}),null!==this._brushMaterial){var i=new ug;i.copy(this._brushMaterial),this._brushPass=null,null!==i.passes&&i.passes.length>0&&(this._brushPass=i.passes[0],this._currentMaterial.passes.push(this._brushPass),i.passes.pop())}t&&this._model.initSubModel(0,this._meshData,this._currentMaterial),this.setMaterial(this._currentMaterial,0),this._currentMaterialLayers=n,this._model.enabled=!0,this._model.receiveShadow=e.getTerrain().receiveShadow}}},n._onMaterialModified=function(e,t){null!=this._model&&this._onRebuildPSO(e,t||this._getBuiltinMaterial())},n._onRebuildPSO=function(e,t){this._model&&this._model.setSubModelMaterial(e,t)},n._clearMaterials=function(){null!=this._model&&this._onMaterialModified(0,null)},n._getBuiltinMaterial=function(){return Nv.get("missing-material")},t}(dF),Dbe=e("TerrainBlockLightmapInfo",mc("cc.TerrainBlockLightmapInfo")((WTe=le((VTe=function(){ce(this,"texture",WTe,this),ce(this,"UOff",jTe,this),ce(this,"VOff",qTe,this),ce(this,"UScale",XTe,this),ce(this,"VScale",YTe,this)}).prototype,"texture",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jTe=le(VTe.prototype,"UOff",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),qTe=le(VTe.prototype,"VOff",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),XTe=le(VTe.prototype,"UScale",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),YTe=le(VTe.prototype,"VScale",[Tc,Mc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HTe=VTe))||HTe),Obe=e("TerrainBlock",function(){function e(e,t,n){this._terrain=void 0,this._node=void 0,this._renderable=void 0,this._index=[1,1],this._weightMap=null,this._lightmapInfo=null,this._lodLevel=0,this._lodKey=new Ebe,this._errorMetrics=[0,0,0,0],this._LevelDistances=[bbe,bbe,bbe,bbe],this._bbMin=new In,this._bbMax=new In,this._terrain=e,this._index[0]=t,this._index[1]=n,this._lightmapInfo=e._getLightmapInfo(t,n),this._node=new qC("TerrainBlock"),this._node.setParent(this._terrain.node),this._node.hideFlags|=ml.Flags.DontSave|ml.Flags.HideInHierarchy,this._node.layer=this._terrain.node.layer,this._renderable=this._node.addComponent(Ibe)}var t=e.prototype;return t.build=function(){var e=jM.root.device,t=new Float32Array(pxe*_xe*_xe);this._buildVertexData(t);var n=e.createBuffer(new _r(vi.VERTEX|vi.TRANSFER_DST,xi.DEVICE,pxe*Float32Array.BYTES_PER_ELEMENT*_xe*_xe,pxe*Float32Array.BYTES_PER_ELEMENT));n.update(t),this._buildBoundingBox();var i=[new Ir(Zi.ATTR_POSITION,pi.RGB32F),new Ir(Zi.ATTR_NORMAL,pi.RGB32F),new Ir(Zi.ATTR_TEX_COORD,pi.RG32F)];this._renderable._meshData=new VA([n],i,Ui.TRIANGLE_LIST,this._terrain._getSharedIndexBuffer()),this._renderable._model=u.director.root.createModel(uT),this._renderable._model.createBoundingShape(this._bbMin,this._bbMax),this._renderable._model.node=this._renderable._model.transform=this._node,null!=this._renderable.node.scene&&(this.visible=!0),this._updateWeightMap(),this._updateMaterial(!0),this._updateLodBuffer(t),this._updateIndexBuffer()},t.rebuild=function(){this._updateHeight(),this._updateWeightMap(),this._renderable._invalidMaterial(),this._updateMaterial(!1)},t.destroy=function(){this.visible=!1,this._renderable._destroyModel(),null!=this._node&&this._node.isValid&&this._node.destroy(),null!=this._weightMap&&this._weightMap.destroy()},t.update=function(){this._updateMaterial(!1);var e=this._terrain.useNormalMap,t=this._terrain.usePBR,n=function(e){return null!==e?e.detailMap:null},i=function(e){var t=null!==e?e.normalMap:null;return null===t&&(t=u.builtinResMgr.get("normal-texture")),t},r=this._renderable._currentMaterial;if(null!==r){var o=this.getMaxLayer(),a=new $n(1,1,1,1),s=new $n(1,1,1,1),c=new $n(0,0,0,0);if(0===o)if(-1!==this.layers[0]){var l=this._terrain.getLayer(this.layers[0]);null!==l&&(a.x=1/l.tileSize,s.x=l.roughness,c.x=l.metallic),r.setProperty("detailMap0",n(l)),e&&r.setProperty("normalMap0",i(l))}else r.setProperty("detailMap0",u.builtinResMgr.get("default-texture")),e&&r.setProperty("normalMap0",u.builtinResMgr.get("normal-texture"));else if(1===o){var h=this._terrain.getLayer(this.layers[0]),f=this._terrain.getLayer(this.layers[1]);null!==h&&(a.x=1/h.tileSize,s.x=h.roughness,c.x=h.metallic),null!==f&&(a.y=1/f.tileSize,s.y=f.roughness,c.y=f.metallic),r.setProperty("weightMap",this._weightMap),r.setProperty("detailMap0",n(h)),r.setProperty("detailMap1",n(f)),e&&(r.setProperty("normalMap0",i(h)),r.setProperty("normalMap1",i(f)))}else if(2===o){var _=this._terrain.getLayer(this.layers[0]),p=this._terrain.getLayer(this.layers[1]),d=this._terrain.getLayer(this.layers[2]);null!==_&&(a.x=1/_.tileSize,s.x=_.roughness,c.x=_.metallic),null!==p&&(a.y=1/p.tileSize,s.y=p.roughness,c.y=p.metallic),null!==d&&(a.z=1/d.tileSize,s.z=d.roughness,c.z=d.metallic),r.setProperty("weightMap",this._weightMap),r.setProperty("detailMap0",n(_)),r.setProperty("detailMap1",n(p)),r.setProperty("detailMap2",n(d)),e&&(r.setProperty("normalMap0",i(_)),r.setProperty("normalMap1",i(p)),r.setProperty("normalMap2",i(d)))}else if(3===o){var m=this._terrain.getLayer(this.layers[0]),v=this._terrain.getLayer(this.layers[1]),g=this._terrain.getLayer(this.layers[2]),y=this._terrain.getLayer(this.layers[3]);null!==m&&(a.x=1/m.tileSize,s.x=m.roughness,c.x=m.metallic),null!==v&&(a.y=1/v.tileSize,s.y=v.roughness,c.y=v.metallic),null!==g&&(a.z=1/g.tileSize,s.z=g.roughness,c.z=g.metallic),null!==y&&(a.w=1/y.tileSize,s.w=y.roughness,c.w=y.metallic),r.setProperty("weightMap",this._weightMap),r.setProperty("detailMap0",n(m)),r.setProperty("detailMap1",n(v)),r.setProperty("detailMap2",n(g)),r.setProperty("detailMap3",n(y)),e&&(r.setProperty("normalMap0",i(m)),r.setProperty("normalMap1",i(v)),r.setProperty("normalMap2",i(g)),r.setProperty("normalMap3",i(y)))}r.setProperty("UVScale",a),t&&(r.setProperty("roughness",s),r.setProperty("metallic",c)),null!==this.lightmap&&(r.setProperty("lightMap",this.lightmap),r.setProperty("lightMapUVParam",this.lightmapUVParam))}},t._updateLevel=function(e){var t=new In,n=new In;In.add(t,this._bbMin,this._terrain.node.getWorldPosition()),In.add(n,this._bbMax,this._terrain.node.getWorldPosition());var i=In.distance(t,e),r=In.distance(n,e),o=Math.min(i,r);for(o-=this._terrain.LodBias,this._lodLevel=0;this._lodLevel<3&&!(o<=this._LevelDistances[this._lodLevel+1]);)++this._lodLevel},t.setBrushMaterial=function(e){this._renderable._brushMaterial!==e&&(this._renderable._invalidMaterial(),this._renderable._brushMaterial=e)},t._getBrushMaterial=function(){return this._renderable?this._renderable._brushMaterial:null},t._getBrushPass=function(){return this._renderable?this._renderable._brushPass:null},t.getTerrain=function(){return this._terrain},t.getIndex=function(){return this._index},t.getRect=function(){var e=new ri;return e.x=this._index[0]*fxe,e.y=this._index[1]*fxe,e.width=fxe,e.height=fxe,e},t.setLayer=function(e,t){this.layers[e]!==t&&(this._terrain.setBlockLayer(this._index[0],this._index[1],e,t),this._renderable._invalidMaterial(),this._updateMaterial(!1))},t.getLayer=function(e){return this.layers[e]},t.getMaxLayer=function(){return this.layers[3]>=0?3:this.layers[2]>=0?2:this.layers[1]>=0?1:0},t._getMaterialDefines=function(e){return{LAYERS:e+1,USE_LIGHTMAP:null!==this.lightmap?1:0,USE_NORMALMAP:this._terrain.useNormalMap?1:0,USE_PBR:this._terrain.usePBR?1:0}},t._invalidMaterial=function(){this._renderable._invalidMaterial()},t._updateMaterial=function(e){this._renderable._updateMaterial(this,e)},t._updateHeight=function(){if(null!=this._renderable._meshData){var e=new Float32Array(pxe*_xe*_xe);this._buildVertexData(e),this._renderable._meshData.vertexBuffers[0].update(e),this._buildBoundingBox(),this._renderable._model.createBoundingShape(this._bbMin,this._bbMax),this._renderable._model.updateWorldBound(),this._updateLodBuffer(e),this._updateIndexBuffer()}},t._updateWeightMap=function(){if(0!==this.getMaxLayer()){null==this._weightMap&&(this._weightMap=new Cv,this._weightMap.create(this._terrain.weightMapSize,this._terrain.weightMapSize,Mm.RGBA8888),this._weightMap.setFilters(Lm.LINEAR,Lm.LINEAR),this._weightMap.setWrapMode(Nm.CLAMP_TO_EDGE,Nm.CLAMP_TO_EDGE));for(var e=new Uint8Array(this._terrain.weightMapSize*this._terrain.weightMapSize*4),t=0,n=0;n<this._terrain.weightMapSize;++n)for(var i=0;i<this._terrain.weightMapSize;++i){var r=this._index[0]*this._terrain.weightMapSize+i,o=this._index[1]*this._terrain.weightMapSize+n,a=this._terrain.getWeight(r,o);e[4*t+0]=Math.floor(255*a.x),e[4*t+1]=Math.floor(255*a.y),e[4*t+2]=Math.floor(255*a.z),e[4*t+3]=Math.floor(255*a.w),t+=1}this._weightMap.uploadData(e)}else null!=this._weightMap&&(this._weightMap.destroy(),this._weightMap=null)},t._updateLightmap=function(e){this._lightmapInfo=e,this._invalidMaterial()},t._updateLod=function(){var e=new Ebe;if(e.level=this._lodLevel,e.north=this._lodLevel,e.south=this._lodLevel,e.west=this._lodLevel,e.east=this._lodLevel,this._index[0]>0){var t=this.getTerrain().getBlock(this._index[0]-1,this._index[1]);e.west=t._lodLevel,e.west<this._lodLevel&&(e.west=this._lodLevel)}if(this._index[0]<this._terrain.info.blockCount[0]-1){var n=this.getTerrain().getBlock(this._index[0]+1,this._index[1]);e.east=n._lodLevel,e.east<this._lodLevel&&(e.east=this._lodLevel)}if(this._index[1]>0){var i=this.getTerrain().getBlock(this._index[0],this._index[1]-1);e.north=i._lodLevel,e.north<this._lodLevel&&(e.north=this._lodLevel)}if(this._index[1]<this._terrain.info.blockCount[1]-1){var r=this.getTerrain().getBlock(this._index[0],this._index[1]+1);e.south=r._lodLevel,e.south<this._lodLevel&&(e.south=this._lodLevel)}this._lodKey.equals(e)||(this._lodKey=e,this._updateIndexBuffer())},t._resetLod=function(){var e=new Ebe;e.level=0,e.north=0,e.south=0,e.west=0,e.east=0,this._lodKey.equals(e)||(this._lodKey=e,this._updateIndexBuffer())},t._updateIndexBuffer=function(){if(null!==this._renderable._meshData&&null!==this._renderable._model&&0!==this._renderable._model.subModels.length){var e=this._terrain._getIndexData(this._lodKey);if(null!==e){var t=this._renderable._model.subModels[0];t.inputAssembler.firstIndex=e.start,t.inputAssembler.indexCount=e.size}}},t._getHeight=function(e,t,n){return n[(_xe*t+e)*pxe+1]},t._updateLodBuffer=function(e){this._lodLevel=0,this._lodKey=new Ebe,this._calcErrorMetrics(e),this._calcLevelDistances(e)},t._calcErrorMetrics=function(e){this._errorMetrics[0]=0;for(var t=1;t<4;++t)this._errorMetrics[t]=this._calcErrorMetric(t,e);for(var n=2;n<4;++n)this._errorMetrics[n]=Math.max(this._errorMetrics[n],this._errorMetrics[n-1])},t._calcErrorMetric=function(e,t){for(var n=0,i=1<<e,r=_xe,o=_xe,a=r-1>>e,s=o-1>>e,c=0;c<o;c+=i)for(var l=0;l<a;++l){var u=l*i,h=u+i,f=(h+u)/2,_=this._getHeight(u,c,t),p=this._getHeight(h,c,t),d=this._getHeight(f,c,t),m=(_+p)/2,v=Math.abs(d-m);n=Math.max(n,v)}for(var g=0;g<r;g+=i)for(var y=0;y<s;++y){var x=y*i,S=x+i,T=(x+S)/2,b=this._getHeight(g,x,t),E=this._getHeight(g,S,t),C=this._getHeight(g,T,t),A=(b+E)/2,w=Math.abs(C-A);n=Math.max(n,w)}for(var P=0;P<s;++P)for(var R=P*i,I=R+i,D=(R+I)/2,O=0;O<a;++O){var M=O*i,N=M+i,L=(M+N)/2,B=this._getHeight(M,R,t),F=this._getHeight(N,I,t),z=this._getHeight(L,D,t),U=(B+F)/2,k=Math.abs(z-U);n=Math.max(n,k)}return n},t._calcLevelDistances=function(){for(var e=1;e<4;++e){var t=96*this._errorMetrics[e];this._LevelDistances[e]=t}},t._buildVertexData=function(e){for(var t=0,n=0;n<_xe;++n)for(var i=0;i<_xe;++i){var r=this._index[0]*fxe+i,o=this._index[1]*fxe+n,a=this._terrain.getPosition(r,o),s=this._terrain.getNormal(r,o),c=new Kn(i/fxe,n/fxe);e[t++]=a.x,e[t++]=a.y,e[t++]=a.z,e[t++]=s.x,e[t++]=s.y,e[t++]=s.z,e[t++]=c.x,e[t++]=c.y}},t._buildBoundingBox=function(){this._bbMin.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this._bbMax.set(Number.MIN_VALUE,Number.MIN_VALUE,Number.MIN_VALUE);for(var e=0;e<_xe;++e)for(var t=0;t<_xe;++t){var n=this._index[0]*fxe+t,i=this._index[1]*fxe+e,r=this._terrain.getPosition(n,i);In.min(this._bbMin,this._bbMin,r),In.max(this._bbMax,this._bbMax,r)}},Z(e,[{key:"valid",get:function(){if(null===this._terrain)return!1;for(var e=this._terrain.getBlocks(),t=0;t<e.length;++t)if(e[t]===this)return!0;return!1}},{key:"material",get:function(){return this._renderable?this._renderable._currentMaterial:null}},{key:"layers",get:function(){return this._terrain.getBlockLayers(this._index[0],this._index[1])}},{key:"weightmap",get:function(){return this._weightMap}},{key:"lightmap",get:function(){return this._lightmapInfo?this._lightmapInfo.texture:null}},{key:"lightmapUVParam",get:function(){return null!=this._lightmapInfo?new $n(this._lightmapInfo.UOff,this._lightmapInfo.VOff,this._lightmapInfo.UScale,this._lightmapInfo.VScale):new $n(0,0,0,0)}},{key:"visible",get:function(){return null!==this._renderable._model&&null!==this._renderable._model.scene},set:function(e){null!==this._renderable._model&&(e?null!=this._terrain.node&&null!=this._terrain.node.scene&&null!=this._terrain.node.scene.renderScene&&null==this._renderable._model.scene&&this._terrain.node.scene.renderScene.addModel(this._renderable._model):null!==this._renderable._model.scene&&this._renderable._model.scene.removeModel(this._renderable._model))}}]),e}()),Mbe=(e("Terrain",(KTe=mc("cc.Terrain"),QTe=Oc(),ZTe=Zc(Pxe),JTe=Zc(Om),$Te=Nc(),ebe=Zc(Dbe),tbe=Zc(Bt),nbe=Zc(Bt),ibe=Zc(Bt),rbe=Zc(Bt),obe=Zc(Lt),abe=Zc(Pxe),sbe=Nc(),cbe=Zc(Om),lbe=Nc(),ube=Zc(Pbe),KTe(hbe=QTe(hbe=wc(hbe=yc((Sbe=function(e){function t(){var t;ce(t=e.call(this)||this,"__asset",_be,oe(t)),ce(t,"_effectAsset",pbe,oe(t)),ce(t,"_lightmapInfos",dbe,oe(t)),ce(t,"_receiveShadow",mbe,oe(t)),ce(t,"_useNormalmap",vbe,oe(t)),ce(t,"_usePBR",gbe,oe(t)),ce(t,"_lodEnable",ybe,oe(t)),ce(t,"_lodBias",xbe,oe(t)),t._buitinAsset=null,t._tileSize=1,t._blockCount=[1,1],t._weightMapSize=128,t._lightMapSize=128,t._heights=new Uint16Array,t._weights=new Uint8Array,t._normals=[],t._layerList=[],t._layerBuffer=[],t._blocks=[],t._lod=new wbe,t._sharedIndexBuffer=null;for(var n=0;n<hxe;++n)t._layerList.push(null);return t}$(t,e);var n=t.prototype;return n.build=function(e){return this._tileSize=e.tileSize,this._blockCount[0]=e.blockCount[0],this._blockCount[1]=e.blockCount[1],this._weightMapSize=e.weightMapSize,this._lightMapSize=e.lightMapSize,this._buildImp()},n.rebuild=function(e){for(var t=0;t<this._blocks.length;++t)this._blocks[t].destroy();this._blocks=[],this._rebuildLayerBuffer(e),this._rebuildHeights(e),this._rebuildWeights(e),this._tileSize=e.tileSize,this._blockCount[0]=e.blockCount[0],this._blockCount[1]=e.blockCount[1],this._weightMapSize=e.weightMapSize,this._lightMapSize=e.lightMapSize,this._buildNormals();for(var n=0;n<this._blockCount[1];++n)for(var i=0;i<this._blockCount[0];++i)this._blocks.push(new Obe(this,i,n));for(var r=0;r<this._blocks.length;++r)this._blocks[r].build()},n.importHeightField=function(e,t){for(var n=0,i=0;i<this.vertexCount[1];++i)for(var r=0;r<this.vertexCount[0];++r){var o=r/this.tileCount[0],a=i/this.tileCount[1],s=e.getAt(o*e.w,a*e.h)*t;this._heights[n++]=s}this._buildNormals();for(var c=0;c<this._blocks.length;++c)this._blocks[c]._updateHeight()},n.exportHeightField=function(e,t){for(var n=0,i=0;i<e.h;++i)for(var r=0;r<e.w;++r){var o=r/(e.w-1),a=i/(e.h-1),s=o*this.size.width,c=a*this.size.height,l=this.getHeightAt(s,c);null!=l&&(e.data[n++]=l*t)}},n.exportAsset=function(){var e=new Pxe;e.tileSize=this.tileSize,e.blockCount=this.blockCount,e.lightMapSize=this.lightMapSize,e.weightMapSize=this.weightMapSize,e.heights=this.heights,e.weights=this.weights,e.layerBuffer=new Array(4*this._blocks.length);for(var t=0;t<this._blocks.length;++t)e.layerBuffer[4*t+0]=this._blocks[t].layers[0],e.layerBuffer[4*t+1]=this._blocks[t].layers[1],e.layerBuffer[4*t+2]=this._blocks[t].layers[2],e.layerBuffer[4*t+3]=this._blocks[t].layers[3];for(var n=0;n<this._layerList.length;++n){var i=this._layerList[n];if(i&&i.detailMap&&gl(i.detailMap)){var r=new Axe;r.slot=n,r.tileSize=i.tileSize,r.detailMap=i.detailMap,r.normalMap=i.normalMap,r.metallic=i.metallic,r.roughness=i.roughness,e.layerInfos.push(r)}}return e},n.getEffectAsset=function(){return null===this._effectAsset?u.EffectAsset.get("terrain"):this._effectAsset},n.onEnable=function(){0===this._blocks.length&&this._buildImp();for(var e=0;e<this._blocks.length;++e)this._blocks[e].visible=!0;u.director.root.pipeline.on(Vy.RENDER_CAMERA_BEGIN,this.onUpdateFromCamera,this)},n.onDisable=function(){u.director.root.pipeline.off(Vy.RENDER_CAMERA_BEGIN,this.onUpdateFromCamera,this);for(var e=0;e<this._blocks.length;++e)this._blocks[e].visible=!1},n.onDestroy=function(){for(var e=0;e<this._blocks.length;++e)this._blocks[e].destroy();this._blocks=[];for(var t=0;t<this._layerList.length;++t)this._layerList[t]=null;null!=this._sharedIndexBuffer&&this._sharedIndexBuffer.destroy()},n.onRestore=function(){this.onEnable(),this._buildImp(!0)},n.update=function(){for(var e=0;e<this._blocks.length;++e)this._blocks[e].update()},n.onUpdateFromCamera=function(e){if(this.lodEnable&&e.scene===this._getRenderScene()){for(var t=0;t<this._blocks.length;++t)this._blocks[t]._updateLevel(e.position);for(var n=0;n<this._blocks.length;++n)this._blocks[n]._updateLod()}},n.addLayer=function(e){for(var t=0;t<this._layerList.length;++t){var n;if(null===this._layerList[t]||this._layerList[t]&&null===(null===(n=this._layerList[t])||void 0===n?void 0:n.detailMap))return this._layerList[t]=e,t}return-1},n.setLayer=function(e,t){this._layerList[e]=t},n.removeLayer=function(e){this._layerList[e]=null},n.getLayer=function(e){return-1===e?null:this._layerList[e]},n.getPosition=function(e,t){var n=e*this._tileSize,i=t*this._tileSize,r=this.getHeight(e,t);return new In(n,r,i)},n.getHeightField=function(){return this._heights},n.setHeight=function(e,t,n){n=ln(n,vxe,gxe),this._heights[t*this.vertexCount[0]+e]=dxe+n/mxe},n.getHeight=function(e,t){return(this._heights[t*this.vertexCount[0]+e]-dxe)*mxe},n.getHeightClamp=function(e,t){return e=ln(e,0,this.vertexCount[0]-1),t=ln(t,0,this.vertexCount[1]-1),this.getHeight(e,t)},n.getHeightAt=function(e,t){var n=e/this.tileSize,i=t/this.tileSize,r=Math.floor(n),o=Math.floor(i),a=r+1,s=o+1,c=n-r,l=i-o;if(r<0||r>this.vertexCount[0]-1||o<0||o>this.vertexCount[1]-1)return null;r=ln(r,0,this.vertexCount[0]-1),o=ln(o,0,this.vertexCount[1]-1),a=ln(a,0,this.vertexCount[0]-1),s=ln(s,0,this.vertexCount[1]-1);var u=this.getHeight(r,o),h=this.getHeight(a,o),f=this.getHeight(r,s),_=this.getHeight(a,s),p=.5*(h+f);return c+l<=1?_=p+(p-u):u=p+(p-_),(u*(1-c)+h*c)*(1-l)+(f*(1-c)+_*c)*l},n._setNormal=function(e,t,n){var i=t*this.vertexCount[0]+e;this._normals[3*i+0]=n.x,this._normals[3*i+1]=n.y,this._normals[3*i+2]=n.z},n.getNormal=function(e,t){var n=t*this.vertexCount[0]+e,i=new In;return i.x=this._normals[3*n+0],i.y=this._normals[3*n+1],i.z=this._normals[3*n+2],i},n.getNormalAt=function(e,t){var n=e/this.tileSize,i=t/this.tileSize,r=Math.floor(n),o=Math.floor(i),a=r+1,s=o+1,c=n-r,l=i-o;if(r<0||r>this.vertexCount[0]-1||o<0||o>this.vertexCount[1]-1)return null;r=ln(r,0,this.vertexCount[0]-1),o=ln(o,0,this.vertexCount[1]-1),a=ln(a,0,this.vertexCount[0]-1),s=ln(s,0,this.vertexCount[1]-1);var u=this.getNormal(r,o),h=this.getNormal(a,o),f=this.getNormal(r,s),_=this.getNormal(a,s),p=new In;In.add(p,h,f).multiplyScalar(.5),c+l<=1?(_.set(p),_.subtract(u),_.add(p)):(u.set(p),u.subtract(_),u.add(p));var d=new In,m=new In,v=new In;return In.lerp(d,u,h,c),In.lerp(m,f,_,c),In.lerp(v,d,m,l),v},n.setWeight=function(e,t,n){var i=t*this._weightMapSize*this._blockCount[0]+e;this._weights[4*i+0]=255*n.x,this._weights[4*i+1]=255*n.y,this._weights[4*i+2]=255*n.z,this._weights[4*i+3]=255*n.w},n.getWeight=function(e,t){var n=t*this._weightMapSize*this._blockCount[0]+e,i=new $n;return i.x=this._weights[4*n+0]/255,i.y=this._weights[4*n+1]/255,i.z=this._weights[4*n+2]/255,i.w=this._weights[4*n+3]/255,i},n.getWeightAt=function(e,t){var n=this.weightMapSize*this.blockCount[0],i=this.weightMapSize*this.blockCount[1];if(0===n||0===i)return null;var r=e/n,o=t/i,a=Math.floor(r),s=Math.floor(o),c=a+1,l=s+1,u=r-a,h=o-s;if(a<0||a>n-1||s<0||s>i-1)return null;a=ln(a,0,n-1),s=ln(s,0,i-1),c=ln(c,0,n-1),l=ln(l,0,i-1);var f=this.getWeight(a,s),_=this.getWeight(c,s),p=this.getWeight(a,l),d=this.getWeight(c,l),m=new $n;$n.add(m,_,p).multiplyScalar(.5),u+h<=1?(d=new $n,$n.subtract(d,m,f).add(m)):(f=new $n,$n.subtract(f,m,d).add(m));var v=new $n,g=new $n,y=new $n;return $n.lerp(v,f,_,u),$n.lerp(g,p,d,u),$n.lerp(y,v,g,h),y},n.getMaxWeightLayerAt=function(e,t){var n=this.weightMapSize*this.blockCount[0],i=this.weightMapSize*this.blockCount[1];if(0===n||0===i)return null;var r=e/n,o=t/i,a=Math.floor(r),s=Math.floor(o);if(a<0||a>n-1||s<0||s>i-1)return null;var c=this.getWeight(a,s),l=Math.floor(e/this.weightMapSize),u=Math.floor(t/this.weightMapSize),h=this.getBlock(l,u),f=0;return c.y>c[f]&&-1!==h.getLayer(1)&&(f=1),c.y>c[f]&&-1!==h.getLayer(2)&&(f=2),c.z>c[f]&&-1!==h.getLayer(3)&&(f=3),f=h.getLayer(f),this.getLayer(f)},n.getBlockLayers=function(e,t){var n=(t*this._blockCount[0]+e)*uxe;return[this._layerBuffer[n],this._layerBuffer[n+1],this._layerBuffer[n+2],this._layerBuffer[n+3]]},n.getBlockLayer=function(e,t,n){var i=(t*this._blockCount[0]+e)*uxe;return this._layerBuffer[i+n]},n.setBlockLayer=function(e,t,n,i){var r=(t*this._blockCount[0]+e)*uxe;this._layerBuffer[r+n]=i},n.getBlock=function(e,t){return this._blocks[t*this._blockCount[0]+e]},n.getBlocks=function(){return this._blocks},n.rayCheck=function(e,t,n,i){void 0===i&&(i=!0);var r=e;i&&In.subtract(r,e,this.node.getWorldPosition());var o=new In;o.set(t),o.multiplyScalar(n);var a=null;if(t.equals(new In(0,1,0))){var s=this.getHeightAt(r.x,r.z);null!=s&&r.y<=s&&(a=new In(r.x,s,r.z))}else if(t.equals(new In(0,-1,0))){var c=this.getHeightAt(r.x,r.z);null!=c&&r.y>=c&&(a=new In(r.x,c,r.z))}else{for(var l=0;l++<2e3;){var u=this.getHeightAt(r.x,r.z);if(null!=u&&r.y<=u)break;r.add(t)}for(;l++<2e3;){var h=this.getHeightAt(r.x,r.z);if(null!=h&&r.y<=h){a=new In(r.x,h,r.z);break}r.add(o)}}return a},n._getSharedIndexBuffer=function(){if(null==this._sharedIndexBuffer){var e=u.director.root.device;this._sharedIndexBuffer=e.createBuffer(new _r(vi.INDEX|vi.TRANSFER_DST,xi.DEVICE,Uint16Array.BYTES_PER_ELEMENT*this._lod._indexBuffer.length,Uint16Array.BYTES_PER_ELEMENT)),this._sharedIndexBuffer.update(this._lod._indexBuffer)}return this._sharedIndexBuffer},n._getIndexData=function(e){return this._lod.getIndexData(e)},n._resetLightmap=function(e){if(this._lightmapInfos.length=0,e)for(var t=0;t<this._blockCount[0]*this._blockCount[1];++t)this._lightmapInfos.push(new Dbe)},n._updateLightmap=function(e,t,n,i,r,o){this._lightmapInfos[e].texture=t,this._lightmapInfos[e].UOff=n,this._lightmapInfos[e].VOff=i,this._lightmapInfos[e].UScale=r,this._lightmapInfos[e].VScale=o,this._blocks[e]._updateLightmap(this._lightmapInfos[e])},n._getLightmapInfo=function(e,t){var n=t*this._blockCount[0]+e;return n<this._lightmapInfos.length?this._lightmapInfos[n]:null},n._calcNormal=function(e,t){var n,i,r=1,o=this.getPosition(e,t);e<this.vertexCount[0]-1?n=this.getPosition(e+1,t):(r*=-1,n=this.getPosition(e-1,t)),t<this.vertexCount[1]-1?i=this.getPosition(e,t+1):(r*=-1,i=this.getPosition(e,t-1)),n.subtract(o),i.subtract(o);var a=new In;return a.set(i),a.cross(n),a.multiplyScalar(r),a.normalize(),a},n._buildNormals=function(){for(var e=0,t=0;t<this.vertexCount[1];++t)for(var n=0;n<this.vertexCount[0];++n){var i=this._calcNormal(n,t);this._normals[3*e+0]=i.x,this._normals[3*e+1]=i.y,this._normals[3*e+2]=i.z,e+=1}},n._buildImp=function(e){var t=this;if(void 0===e&&(e=!1),!this.valid){var n=this.__asset;if(this._buitinAsset!=n&&(this._buitinAsset=n),!e&&null!==n){this._tileSize=n.tileSize,this._blockCount=n.blockCount,this._weightMapSize=n.weightMapSize,this._lightMapSize=n.lightMapSize,this._heights=n.heights,this._weights=n.weights,this._layerBuffer=n.layerBuffer;for(var i=0;i<this._layerList.length;++i)this._layerList[i]=null;if(n.version<bxe)for(var r=function(e){var i=new Rbe,r=n.layerBinaryInfos[e];i.tileSize=r.tileSize,u.assetManager.loadAny(r.detailMapId,(function(e,t){i.detailMap=t})),""!==r.normalMapId&&u.assetManager.loadAny(r.normalMapId,(function(e,t){i.normalMap=t})),i.roughness=r.roughness,i.metallic=r.metallic,t._layerList[r.slot]=i},o=0;o<n.layerBinaryInfos.length;++o)r(o);else for(var a=0;a<n.layerInfos.length;++a){var s=new Rbe,c=n.layerInfos[a];s.tileSize=c.tileSize,s.detailMap=c.detailMap,s.normalMap=c.normalMap,s.roughness=c.roughness,s.metallic=c.metallic,this._layerList[c.slot]=s}}if(0!==this._blockCount[0]&&0!==this._blockCount[1]){var l=this.vertexCount[0]*this.vertexCount[1];if(null===this._heights||this._heights.length!==l){this._heights=new Uint16Array(l),this._normals=new Array(3*l);for(var h=0;h<l;++h)this._heights[h]=dxe,this._normals[3*h+0]=0,this._normals[3*h+1]=1,this._normals[3*h+2]=0}else this._normals=new Array(3*l),this._buildNormals();var f=this.blockCount[0]*this.blockCount[1]*uxe;if(null===this._layerBuffer||this._layerBuffer.length!==f){this._layerBuffer=new Array(f);for(var _=0;_<f;++_)this._layerBuffer[_]=-1}var p=this._weightMapSize*this._blockCount[0],d=this._weightMapSize*this._blockCount[1];if(this._weights.length!==p*d*4){this._weights=new Uint8Array(p*d*4);for(var m=0;m<p*d;++m)this._weights[4*m+0]=255,this._weights[4*m+1]=0,this._weights[4*m+2]=0,this._weights[4*m+3]=0}for(var v=0;v<this._blockCount[1];++v)for(var g=0;g<this._blockCount[0];++g)this._blocks.push(new Obe(this,g,v));for(var y=0;y<this._blocks.length;++y)this._blocks[y].build()}}},n._rebuildHeights=function(e){if(this.vertexCount[0]===e.vertexCount[0]&&this.vertexCount[1]===e.vertexCount[1])return!1;for(var t=new Uint16Array(e.vertexCount[0]*e.vertexCount[1]),n=0;n<t.length;++n)t[n]=dxe;for(var i=Math.min(this.vertexCount[0],e.vertexCount[0]),r=Math.min(this.vertexCount[1],e.vertexCount[1]),o=0;o<r;++o)for(var a=0;a<i;++a){var s=o*e.vertexCount[0]+a,c=o*this.vertexCount[0]+a;t[s]=this._heights[c]}return this._heights=t,!0},n._rebuildLayerBuffer=function(e){if(this.blockCount[0]===e.blockCount[0]&&this.blockCount[1]===e.blockCount[1])return!1;var t=[];t.length=e.blockCount[0]*e.blockCount[1]*uxe;for(var n=0;n<t.length;++n)t[n]=-1;for(var i=Math.min(this.blockCount[0],e.blockCount[0]),r=Math.min(this.blockCount[1],e.blockCount[1]),o=0;o<r;++o)for(var a=0;a<i;++a)for(var s=o*e.blockCount[0]+a,c=o*this.blockCount[0]+a,l=0;l<uxe;++l)t[s*uxe+l]=this._layerBuffer[c*uxe+l];return this._layerBuffer=t,!0},n._rebuildWeights=function(e){var t=this,n=this._weightMapSize,i=this._weightMapSize*this._blockCount[0],r=this._weightMapSize*this._blockCount[1],o=e.weightMapSize*e.blockCount[0],a=e.weightMapSize*e.blockCount[1];if(o===i&&a===r)return!1;for(var s=new Uint8Array(o*a*4),c=0;c<o*a;++c)s[4*c+0]=255,s[4*c+1]=0,s[4*c+2]=0,s[4*c+3]=0;for(var l=Math.min(e.blockCount[0],this._blockCount[0]),u=Math.min(e.blockCount[1],this._blockCount[1]),h=function(e,t,n){var r=t*i+e,o=new $n;return o.x=n[4*r+0]/255,o.y=n[4*r+1]/255,o.z=n[4*r+2]/255,o.w=n[4*r+3]/255,o},f=function(e,n,i,r){var o=Math.floor(e),a=Math.floor(n),s=o+1,c=a+1,l=e-o,u=n-a,f=h(o+i,a+r,t._weights),_=h(s+i,a+r,t._weights),p=h(o+i,c+r,t._weights),d=h(s+i,c+r,t._weights),m=new $n;$n.add(m,_,p).multiplyScalar(.5),l+u<=1?(d.set(m),d.subtract(f),d.add(m)):(f.set(m),f.subtract(d),f.add(m));var v=new $n,g=new $n,y=new $n;return $n.lerp(v,f,_,l),$n.lerp(g,p,d,l),$n.lerp(y,v,g,u),y},_=0;_<u;++_)for(var p=0;p<l;++p)for(var d=p*n,m=_*n,v=0;v<e.weightMapSize;++v)for(var g=0;g<e.weightMapSize;++g){var y=void 0;y=e.weightMapSize===n?h(g+d,v+m,this._weights):f(g/(e.weightMapSize-1)*(n-1),v/(e.weightMapSize-1)*(n-1),d,m,this._weights);var x=p*e.weightMapSize+g,S=(_*e.weightMapSize+v)*o+x;s[4*S+0]=255*y.x,s[4*S+1]=255*y.y,s[4*S+2]=255*y.z,s[4*S+3]=255*y.w}return this._weights=s,!0},Z(t,[{key:"_asset",get:function(){return this.__asset},set:function(e){if(this.__asset=e,this._buitinAsset!==this.__asset){this._buitinAsset=this.__asset;for(var t=0;t<this._blocks.length;++t)this._blocks[t].destroy();if(this._blocks=[],null===this.__asset){this._effectAsset=null,this._lightmapInfos=[],this._receiveShadow=!1,this._useNormalmap=!1,this._usePBR=!1,this._tileSize=1,this._blockCount=[1,1],this._weightMapSize=128,this._lightMapSize=128,this._heights=new Uint16Array,this._weights=new Uint8Array,this._normals=[],this._layerBuffer=[],this._blocks=[],this._layerList=[];for(var n=0;n<hxe;++n)this._layerList.push(null)}u.director.root.device&&this._buildImp()}}},{key:"effectAsset",get:function(){return this._effectAsset},set:function(e){if(this._effectAsset!==e){this._effectAsset=e;for(var t=0;t<this._blocks.length;++t)this._blocks[t]._invalidMaterial()}}},{key:"receiveShadow",get:function(){return this._receiveShadow},set:function(e){this._receiveShadow=e;for(var t=0;t<this._blocks.length;t++)this._blocks[t]._invalidMaterial()}},{key:"useNormalMap",get:function(){return this._useNormalmap},set:function(e){this._useNormalmap=e;for(var t=0;t<this._blocks.length;t++)this._blocks[t]._invalidMaterial()}},{key:"usePBR",get:function(){return this._usePBR},set:function(e){this._usePBR=e;for(var t=0;t<this._blocks.length;t++)this._blocks[t]._invalidMaterial()}},{key:"lodEnable",get:function(){return this._lodEnable},set:function(e){if(this._lodEnable=e,!this._lodEnable)for(var t=0;t<this._blocks.length;t++)this._blocks[t]._resetLod()}},{key:"LodBias",get:function(){return this._lodBias},set:function(e){this._lodBias=e}},{key:"size",get:function(){var e=new ni(0,0);return e.width=this.blockCount[0]*fxe*this.tileSize,e.height=this.blockCount[1]*fxe*this.tileSize,e}},{key:"tileSize",get:function(){return this._tileSize}},{key:"tileCount",get:function(){return[this.blockCount[0]*fxe,this.blockCount[1]*fxe]}},{key:"vertexCount",get:function(){var e=this.tileCount;return e[0]+=1,e[1]+=1,e}},{key:"blockCount",get:function(){return this._blockCount}},{key:"lightMapSize",get:function(){return this._lightMapSize}},{key:"weightMapSize",get:function(){return this._weightMapSize}},{key:"heights",get:function(){return this._heights}},{key:"weights",get:function(){return this._weights}},{key:"valid",get:function(){return this._blocks.length>0}},{key:"info",get:function(){var e=new Pbe;return e.tileSize=this.tileSize,e.blockCount[0]=this.blockCount[0],e.blockCount[1]=this.blockCount[1],e.weightMapSize=this.weightMapSize,e.lightMapSize=this.lightMapSize,e}}]),t}(th),_be=le((fbe=Sbe).prototype,"__asset",[ZTe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),pbe=le(fbe.prototype,"_effectAsset",[JTe,Tc,qc,$Te],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),dbe=le(fbe.prototype,"_lightmapInfos",[ebe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),mbe=le(fbe.prototype,"_receiveShadow",[tbe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),vbe=le(fbe.prototype,"_useNormalmap",[nbe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),gbe=le(fbe.prototype,"_usePBR",[ibe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),ybe=le(fbe.prototype,"_lodEnable",[rbe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),xbe=le(fbe.prototype,"_lodBias",[obe,Tc,qc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),le(fbe.prototype,"_asset",[abe,sbe],Object.getOwnPropertyDescriptor(fbe.prototype,"_asset"),fbe.prototype),le(fbe.prototype,"effectAsset",[cbe,lbe],Object.getOwnPropertyDescriptor(fbe.prototype,"effectAsset"),fbe.prototype),le(fbe.prototype,"receiveShadow",[Mc],Object.getOwnPropertyDescriptor(fbe.prototype,"receiveShadow"),fbe.prototype),le(fbe.prototype,"useNormalMap",[Mc],Object.getOwnPropertyDescriptor(fbe.prototype,"useNormalMap"),fbe.prototype),le(fbe.prototype,"usePBR",[Mc],Object.getOwnPropertyDescriptor(fbe.prototype,"usePBR"),fbe.prototype),le(fbe.prototype,"lodEnable",[Mc],Object.getOwnPropertyDescriptor(fbe.prototype,"lodEnable"),fbe.prototype),le(fbe.prototype,"LodBias",[Mc],Object.getOwnPropertyDescriptor(fbe.prototype,"LodBias"),fbe.prototype),le(fbe.prototype,"info",[ube],Object.getOwnPropertyDescriptor(fbe.prototype,"info"),fbe.prototype),hbe=fbe))||hbe)||hbe)||hbe)||hbe)),function(){function e(){this.originalTarget=null,this.target=null,this.tag=e.TAG_INVALID}var t=e.prototype;return t.clone=function(){var t=new e;return t.originalTarget=null,t.target=null,t.tag=this.tag,t},t.isDone=function(){return!0},t.startWithTarget=function(e){this.originalTarget=e,this.target=e},t.stop=function(){this.target=null},t.step=function(){R(1006)},t.update=function(){R(1007)},t.getTarget=function(){return this.target},t.setTarget=function(e){this.target=e},t.getOriginalTarget=function(){return this.originalTarget},t.setOriginalTarget=function(e){this.originalTarget=e},t.getTag=function(){return this.tag},t.setTag=function(e){this.tag=e},t.reverse=function(){return R(1008),null},t.retain=function(){},t.release=function(){},e}());Mbe.TAG_INVALID=-1;var Nbe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._duration=0,t._timesForRepeat=1,t}$(t,e);var n=t.prototype;return n.getDuration=function(){return this._duration*(this._timesForRepeat||1)},n.setDuration=function(e){this._duration=e},n.clone=function(){return new t},t}(Mbe),Lbe=(function(e){function t(t,n){var i;return void 0===n&&(n=1),(i=e.call(this)||this)._speed=0,i._innerAction=null,t&&i.initWithAction(t,n),i}$(t,e);var n=t.prototype;n.getSpeed=function(){return this._speed},n.setSpeed=function(e){this._speed=e},n.initWithAction=function(e,t){return e?(this._innerAction=e,this._speed=t,!0):(M(1021),!1)},n.clone=function(){var e=new t;return e.initWithAction(this._innerAction.clone(),this._speed),e},n.startWithTarget=function(e){Mbe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Mbe.prototype.stop.call(this)},n.step=function(e){this._innerAction.step(e*this._speed)},n.isDone=function(){return this._innerAction.isDone()},n.reverse=function(){return new t(this._innerAction.reverse(),this._speed)},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction}}(Mbe),0),Bbe=function(){this.actions=[],this.target=null,this.actionIndex=0,this.currentAction=null,this.paused=!1,this.lock=!1},Fbe=function(){function e(){this._hashTargets=new Map,this._arrayTargets=[],this._elementPool=[]}var t=e.prototype;return t._searchElementByTarget=function(e,t){for(var n=0;n<e.length;n++)if(t===e[n].target)return e[n];return null},t._getElement=function(e,t){var n=this._elementPool.pop();return n||(n=new Bbe),n.target=e,n.paused=!!t,n},t._putElement=function(e){e.actions.length=0,e.actionIndex=0,e.currentAction=null,e.paused=!1,e.target=null,e.lock=!1,this._elementPool.push(e)},t.addAction=function(e,t,n){if(e&&t){null==t.uuid&&(t.uuid="_TWEEN_UUID_"+Lbe++);var i=this._hashTargets.get(t);i?i.actions||(i.actions=[]):(i=this._getElement(t,n),this._hashTargets.set(t,i),this._arrayTargets.push(i)),i.target=t,i.actions.push(e),e.startWithTarget(t)}else M(1e3)},t.removeAllActions=function(){for(var e=this._arrayTargets,t=0;t<e.length;t++){var n=e[t];n&&this._putElement(n)}this._arrayTargets.length=0,this._hashTargets=new Map},t.removeAllActionsFromTarget=function(e){if(null!=e){var t=this._hashTargets.get(e);t&&(t.actions.length=0,this._deleteHashElement(t))}},t.removeAction=function(e){if(null!=e){var t=e.getOriginalTarget(),n=this._hashTargets.get(t);if(n)for(var i=0;i<n.actions.length;i++)if(n.actions[i]===e){n.actions.splice(i,1),n.actionIndex>=i&&n.actionIndex--;break}}},t._removeActionByTag=function(e,t,n){for(var i=0,r=t.actions.length;i<r;++i){var o=t.actions[i];if(o&&o.getTag()===e){if(n&&o.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t);break}}},t._removeAllActionsByTag=function(e,t,n){for(var i=t.actions.length-1;i>=0;--i){var r=t.actions[i];if(r&&r.getTag()===e){if(n&&r.getOriginalTarget()!==n)continue;this._removeActionAtIndex(i,t)}}},t.removeActionByTag=function(e,t){var n=this;e===Mbe.TAG_INVALID&&R(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeActionByTag(e,r,t)}else i.forEach((function(t){n._removeActionByTag(e,t)}))},t.removeAllActionsByTag=function(e,t){var n=this;e===Mbe.TAG_INVALID&&R(1002);var i=this._hashTargets;if(t){var r=i.get(t);r&&this._removeAllActionsByTag(e,r,t)}else i.forEach((function(t){n._removeAllActionsByTag(e,t)}))},t.getActionByTag=function(e,t){e===Mbe.TAG_INVALID&&R(1004);var n=this._hashTargets.get(t);if(n){if(null!=n.actions)for(var i=0;i<n.actions.length;++i){var r=n.actions[i];if(r&&r.getTag()===e)return r}R(1005,e)}return null},t.getNumberOfRunningActionsInTarget=function(e){var t=this._hashTargets.get(e);return t&&t.actions?t.actions.length:0},t.pauseTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!0)},t.resumeTarget=function(e){var t=this._hashTargets.get(e);t&&(t.paused=!1)},t.pauseAllRunningActions=function(){for(var e=[],t=this._arrayTargets,n=0;n<t.length;n++){var i=t[n];i&&!i.paused&&(i.paused=!0,e.push(i.target))}return e},t.resumeTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.resumeTarget(e[t])},t.pauseTargets=function(e){if(e)for(var t=0;t<e.length;t++)e[t]&&this.pauseTarget(e[t])},t.purgeSharedManager=function(){u.director.getScheduler().unscheduleUpdate(this)},t._removeActionAtIndex=function(e,t){t.actions[e],t.actions.splice(e,1),t.actionIndex>=e&&t.actionIndex--,0===t.actions.length&&this._deleteHashElement(t)},t._deleteHashElement=function(e){var t=!1;if(e&&!e.lock&&this._hashTargets.get(e.target)){this._hashTargets.delete(e.target);for(var n=this._arrayTargets,i=0,r=n.length;i<r;i++)if(n[i]===e){n.splice(i,1);break}this._putElement(e),t=!0}return t},t.update=function(e){for(var t,n=this._arrayTargets,i=0;i<n.length;i++){this._currentTarget=n[i];var r=(t=this._currentTarget).target;if(r instanceof ml&&!r.isValid)this.removeAllActionsFromTarget(r),i--;else{if(!t.paused&&t.actions){for(t.lock=!0,t.actionIndex=0;t.actionIndex<t.actions.length;t.actionIndex++)if(t.currentAction=t.actions[t.actionIndex],t.currentAction){if(t.currentAction.step(e*(t.currentAction._speedMethod?t.currentAction._speed:1)),t.currentAction&&t.currentAction.isDone()){t.currentAction.stop();var o=t.currentAction;t.currentAction=null,this.removeAction(o)}t.currentAction=null}t.lock=!1}0===t.actions.length&&this._deleteHashElement(t)&&i--}}},e}(),zbe=e("TweenSystem",function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this).actionMgr=new Fbe,t}return $(t,e),t.prototype.update=function(e){this.actionMgr.update(e)},Z(t,[{key:"ActionManager",get:function(){return this.actionMgr}}]),t}(DM));zbe.ID="TWEEN",zbe.instance=void 0,jM.on(WM.EVENT_INIT,(function(){var e=new zbe;zbe.instance=e,jM.registerSystem(zbe.ID,e,DM.Priority.MEDIUM)}));var Ube=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.isDone=function(){return!0},n.step=function(){this.update(1)},n.update=function(){},n.reverse=function(){return this.clone()},n.clone=function(){return new t},t}(Nbe),kbe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(dF),t=0;t<e.length;++t)e[t].enabled=!0},n.reverse=function(){return new Gbe},n.clone=function(){return new t},t}(Ube),Gbe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.update=function(){for(var e=this.target.getComponentsInChildren(dF),t=0;t<e.length;++t)e[t].enabled=!1},n.reverse=function(){return new kbe},n.clone=function(){return new t},t}(Ube);!function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;n.update=function(){for(var e=this.target.getComponentsInChildren(dF),t=0;t<e.length;++t){var n=e[t];n.enabled=!n.enabled}},n.reverse=function(){return new t},n.clone=function(){return new t}}(Ube);var Hbe=function(e){function t(t){var n;return(n=e.call(this)||this)._isNeedCleanUp=!0,void 0!==t&&n.init(t),n}$(t,e);var n=t.prototype;return n.update=function(){this.target.removeFromParent(),this._isNeedCleanUp&&this.target.destroy()},n.init=function(e){return this._isNeedCleanUp=e,!0},n.reverse=function(){return new t(this._isNeedCleanUp)},n.clone=function(){return new t(this._isNeedCleanUp)},t}(Ube),Vbe=function(e){function t(t,n,i){var r;return(r=e.call(this)||this)._selectorTarget=null,r._function=null,r._data=null,r.initWithFunction(t,n,i),r}$(t,e);var n=t.prototype;return n.initWithFunction=function(e,t,n){return e&&(this._function=e),t&&(this._selectorTarget=t),void 0!==n&&(this._data=n),!0},n.execute=function(){this._function&&this._function.call(this._selectorTarget,this.target,this._data)},n.update=function(){this.execute()},n.getTargetCallback=function(){return this._selectorTarget},n.setTargetCallback=function(e){e!==this._selectorTarget&&(this._selectorTarget&&(this._selectorTarget=null),this._selectorTarget=e)},n.clone=function(){var e=new t;return e.initWithFunction(this._function,this._selectorTarget,this._data),e},t}(Ube),Wbe=function(e){function t(t){var n;return(n=e.call(this)||this).MAX_VALUE=2,n._elapsed=0,n._firstTick=!1,n._easeList=[],n._speed=1,n._repeatForever=!1,n._repeatMethod=!1,n._speedMethod=!1,void 0===t||isNaN(t)||n.initWithDuration(t),n}$(t,e);var n=t.prototype;return n.getElapsed=function(){return this._elapsed},n.initWithDuration=function(e){return this._duration=0===e?ft.FLT_EPSILON:e,this._elapsed=0,this._firstTick=!0,!0},n.isDone=function(){return this._elapsed>=this._duration},n._cloneDecoration=function(e){e._repeatForever=this._repeatForever,e._speed=this._speed,e._timesForRepeat=this._timesForRepeat,e._easeList=this._easeList,e._speedMethod=this._speedMethod,e._repeatMethod=this._repeatMethod},n._reverseEaseList=function(e){if(this._easeList){e._easeList=[];for(var t=0;t<this._easeList.length;t++)e._easeList.push(this._easeList[t])}},n.clone=function(){var e=new t(this._duration);return this._cloneDecoration(e),e},n.easing=function(e){this._easeList?this._easeList.length=0:this._easeList=[];for(var t=0;t<arguments.length;t++)this._easeList.push(arguments[t]);return this},n._computeEaseTime=function(e){return e},n.step=function(e){this._firstTick?(this._firstTick=!1,this._elapsed=0):this._elapsed+=e;var t=this._elapsed/(this._duration>1.192092896e-7?this._duration:1.192092896e-7);t=t<1?t:1,this.update(t>0?t:0),this._repeatMethod&&this._timesForRepeat>1&&this.isDone()&&(this._repeatForever||this._timesForRepeat--,this.startWithTarget(this.target),this.step(this._elapsed-this._duration))},n.startWithTarget=function(e){Mbe.prototype.startWithTarget.call(this,e),this._elapsed=0,this._firstTick=!0},n.reverse=function(){return R(1010),this},n.setAmplitudeRate=function(){R(1011)},n.getAmplitudeRate=function(){return R(1012),0},n.speed=function(e){return e<=0?(R(1013),this):(this._speedMethod=!0,this._speed*=e,this)},n.getSpeed=function(){return this._speed},n.setSpeed=function(e){return this._speed=e,this},n.repeat=function(e){return e=Math.round(e),isNaN(e)||e<1?(R(1014),this):(this._repeatMethod=!0,this._timesForRepeat*=e,this)},n.repeatForever=function(){return this._repeatMethod=!0,this._timesForRepeat=this.MAX_VALUE,this._repeatForever=!0,this},t}(Nbe),jbe=function(e){function t(n){var i;(i=e.call(this)||this)._actions=[],i._split=0,i._last=0,i._reversed=!1;var r=n instanceof Array?n:arguments;if(1===r.length)return M(1019),oe(i);var o=r.length-1;if(o>=0&&null==r[o]&&R(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}$(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return M(1025),!1;var n=e._duration,i=t._duration,r=(n*=e._repeatMethod?e._timesForRepeat:1)+(i*=t._repeatMethod?t._timesForRepeat:1);return this.initWithDuration(r),this._actions[0]=e,this._actions[1]=t,!0},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._actions[0].clone(),this._actions[1].clone()),e},n.startWithTarget=function(e){Wbe.prototype.startWithTarget.call(this,e),this._split=this._actions[0]._duration/this._duration,this._split*=this._actions[0]._repeatMethod?this._actions[0]._timesForRepeat:1,this._last=-1},n.stop=function(){-1!==this._last&&this._actions[this._last].stop(),Mbe.prototype.stop.call(this)},n.update=function(e){var t,n,i=0,r=this._split,o=this._actions,a=this._last;(e=this._computeEaseTime(e))<r?(t=0!==r?e/r:1,0===i&&1===a&&this._reversed&&(o[1].update(0),o[1].stop())):(i=1,t=1===r?1:(e-r)/(1-r),-1===a&&(o[0].startWithTarget(this.target),o[0].update(1),o[0].stop()),0===a&&(o[0].update(1),o[0].stop())),n=o[i],a===i&&n.isDone()||(a!==i&&n.startWithTarget(this.target),t*=n._timesForRepeat,n.update(t>1?t%1:t),this._last=i)},n.reverse=function(){var e=t._actionOneTwo(this._actions[1].reverse(),this._actions[0].reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e._reversed=!0,e},t}(Wbe);function qbe(e){var t=e instanceof Array?e:arguments;if(1===t.length)return M(1019),null;var n=t.length-1;n>=0&&null==t[n]&&R(1015);var i=null;if(n>=0){i=t[0];for(var r=1;r<=n;r++)t[r]&&(i=jbe._actionOneTwo(i,t[r]))}return i}jbe._actionOneTwo=function(e,t){var n=new jbe;return n.initWithTwoActions(e,t),n};var Xbe=function(e){function t(t,n){var i;return(i=e.call(this)||this)._times=0,i._total=0,i._nextDt=0,i._actionInstant=!1,i._innerAction=null,void 0!==n&&i.initWithAction(t,n),i}$(t,e);var n=t.prototype;return n.initWithAction=function(e,t){var n=e._duration*t;return!!this.initWithDuration(n)&&(this._times=t,this._innerAction=e,e instanceof Ube&&(this._actionInstant=!0,this._times-=1),this._total=0,!0)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone(),this._times),e},n.startWithTarget=function(e){this._total=0,this._nextDt=this._innerAction._duration/this._duration,Wbe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.stop=function(){this._innerAction.stop(),Mbe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e);var t=this._innerAction,n=this._duration,i=this._times,r=this._nextDt;if(e>=r){for(;e>r&&this._total<i;)t.update(1),this._total++,t.stop(),t.startWithTarget(this.target),r+=t._duration/n,this._nextDt=r>1?1:r;e>=1&&this._total<i&&(t.update(1),this._total++),this._actionInstant||(this._total===i?t.stop():t.update(e-(r-t._duration/n)))}else t.update(e*i%1)},n.isDone=function(){return this._total===this._times},n.reverse=function(){var e=new t(this._innerAction.reverse(),this._times);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Wbe),Ybe=function(e){function t(t){var n;return(n=e.call(this)||this)._innerAction=null,t&&n.initWithAction(t),n}$(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?(this._innerAction=e,!0):(M(1026),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._innerAction.clone()),e},n.startWithTarget=function(e){Wbe.prototype.startWithTarget.call(this,e),this._innerAction.startWithTarget(e)},n.step=function(e){var t=this._innerAction;t.step(e),t.isDone()&&(t.startWithTarget(this.target),t.step(t.getElapsed()-t._duration))},n.isDone=function(){return!1},n.reverse=function(){var e=new t(this._innerAction.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},n.setInnerAction=function(e){this._innerAction!==e&&(this._innerAction=e)},n.getInnerAction=function(){return this._innerAction},t}(Wbe),Kbe=function(e){function t(n){var i;(i=e.call(this)||this)._one=null,i._two=null;var r=n instanceof Array?n:arguments;if(1===r.length)return M(1020),oe(i);var o=r.length-1;if(o>=0&&null==r[o]&&R(1015),o>=0){for(var a,s=r[0],c=1;c<o;c++)r[c]&&(a=s,s=t._actionOneTwo(a,r[c]));i.initWithTwoActions(s,r[o])}return i}$(t,e);var n=t.prototype;return n.initWithTwoActions=function(e,t){if(!e||!t)return M(1027),!1;var n=!1,i=e._duration,r=t._duration;return this.initWithDuration(Math.max(i,r))&&(this._one=e,this._two=t,i>r?this._two=jbe._actionOneTwo(t,Jbe(i-r)):i<r&&(this._one=jbe._actionOneTwo(e,Jbe(r-i))),n=!0),n},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithTwoActions(this._one.clone(),this._two.clone()),e},n.startWithTarget=function(e){Wbe.prototype.startWithTarget.call(this,e),this._one.startWithTarget(e),this._two.startWithTarget(e)},n.stop=function(){this._one.stop(),this._two.stop(),Mbe.prototype.stop.call(this)},n.update=function(e){e=this._computeEaseTime(e),this._one&&this._one.update(e),this._two&&this._two.update(e)},n.reverse=function(){var e=t._actionOneTwo(this._one.reverse(),this._two.reverse());return this._cloneDecoration(e),this._reverseEaseList(e),e},t}(Wbe);function Qbe(e){var t=e instanceof Array?e:arguments;if(1===t.length)return M(1020),null;t.length>0&&null==t[t.length-1]&&R(1015);for(var n=t[0],i=1;i<t.length;i++)null!=t[i]&&(n=Kbe._actionOneTwo(n,t[i]));return n}Kbe._actionOneTwo=function(e,t){var n=new Kbe;return n.initWithTwoActions(e,t),n};var Zbe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.update=function(){},n.reverse=function(){var e=new t(this._duration);return this._cloneDecoration(e),this._reverseEaseList(e),e},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithDuration(this._duration),e},t}(Wbe);function Jbe(e){return new Zbe(e)}var $be,eEe,tEe,nEe,iEe,rEe,oEe,aEe,sEe,cEe,lEe,uEe,hEe,fEe,_Ee,pEe,dEe,mEe,vEe,gEe,yEe,xEe,SEe,TEe,bEe,EEe,CEe,AEe,wEe,PEe,REe,IEe,DEe,OEe,MEe,NEe,LEe,BEe,FEe,zEe,UEe,kEe,GEe,HEe,VEe,WEe,jEe,qEe,XEe,YEe,KEe,QEe,ZEe,JEe,$Ee,eCe,tCe,nCe,iCe,rCe,oCe=function(e){function t(t){var n;return(n=e.call(this)||this)._other=null,t&&n.initWithAction(t),n}$(t,e);var n=t.prototype;return n.initWithAction=function(e){return e?e===this._other?(M(1029),!1):!!Wbe.prototype.initWithDuration.call(this,e._duration)&&(this._other=e,!0):(M(1028),!1)},n.clone=function(){var e=new t;return this._cloneDecoration(e),e.initWithAction(this._other.clone()),e},n.startWithTarget=function(e){Wbe.prototype.startWithTarget.call(this,e),this._other.startWithTarget(e)},n.update=function(e){e=this._computeEaseTime(e),this._other&&this._other.update(1-e)},n.reverse=function(){return this._other.clone()},n.stop=function(){this._other.stop(),Mbe.prototype.stop.call(this)},t}(Wbe),aCe=e("TweenAction",function(e){function t(t,n,i){var r;if((r=e.call(this)||this)._opts=void 0,r._props=void 0,r._originProps=void 0,null==i)i=Object.create(null);else if(function(e){var t=" [Tween:] ",n=" option is not support in v + "+h,i=e;i.delay&&S(t+"delay"+n),i.repeat&&S(t+"repeat"+n),i.repeatDelay&&S(t+"repeatDelay"+n),i.interpolation&&S(t+"interpolation"+n),i.onStop&&S(t+"onStop"+n)}(i),i.easing&&"string"==typeof i.easing&&(i.easing=function(e){var t=e.charAt(0);if(/[A-Z]/.test(t)){var n=(e=e.replace(t,t.toLowerCase())).split("-");if(2===n.length){var i=n[0];if("linear"===i)e="linear";else{var r=n[1];switch(i){case"quadratic":e="quad"+r;break;case"quartic":e="quart"+r;break;case"quintic":e="quint"+r;break;case"sinusoidal":e="sine"+r;break;case"exponential":e="expo"+r;break;case"circular":e="circ"+r;break;default:e=i+r}}}}return e}(i.easing)),i.progress||(i.progress=r.progress),i.easing&&"string"==typeof i.easing){var o=i.easing;i.easing=i_[o],i.easing||D(1031,o)}for(var a in r._opts=i,r._props=Object.create(null),n)if(n.hasOwnProperty(a)){var s=n[a];if("function"==typeof s&&(s=s()),null!=s&&"string"!=typeof s){var c=void 0,l=void 0;void 0!==s.value&&(s.easing||s.progress)&&("string"==typeof s.easing?(c=i_[s.easing])||D(1031,s.easing):c=s.easing,l=s.progress,s=s.value);var u=Object.create(null);u.value=s,u.easing=c,u.progress=l,r._props[a]=u}}return r._originProps=n,r.initWithDuration(t),r}$(t,e);var n=t.prototype;return n.clone=function(){var e=new t(this._duration,this._originProps,this._opts);return this._cloneDecoration(e),e},n.startWithTarget=function(e){Wbe.prototype.startWithTarget.call(this,e);var t=!!this._opts.relative,n=this._props;for(var i in n){var r=e[i];if(void 0!==r){var o=n[i],a=o.value;if("number"==typeof r)o.start=r,o.current=r,o.end=t?r+a:a;else if("object"==typeof r)for(var s in null==o.start&&(o.start={},o.current={},o.end={}),a)isNaN(r[s])||(o.start[s]=r[s],o.current[s]=r[s],o.end[s]=t?r[s]+a[s]:a[s])}}this._opts.onStart&&this._opts.onStart(this.target)},n.update=function(e){var t=this.target;if(t){var n=this._props,i=this._opts,r=e;i.easing&&(r=i.easing(e));var o=i.progress;for(var a in n){var s=n[a],c=s.easing?s.easing(e):r,l=s.progress?s.progress:o,u=s.start,h=s.end;if("number"==typeof u)s.current=l(u,h,s.current,c);else if("object"==typeof u)for(var f in u)s.current[f]=l(u[f],h[f],s.current[f],c);t[a]=s.current}i.onUpdate&&i.onUpdate(this.target,e),1===e&&i.onComplete&&i.onComplete(this.target)}},n.progress=function(e,t,n,i){return e+(t-e)*i},t}(Wbe)),sCe=function(e){function t(t){var n;return(n=e.call(this)||this)._props=void 0,n._props={},void 0!==t&&n.init(t),n}$(t,e);var n=t.prototype;return n.init=function(e){for(var t in e)this._props[t]=e[t];return!0},n.update=function(){var e=this._props,t=this.target;for(var n in e)t[n]=e[n]},n.clone=function(){var e=new t;return e.init(this._props),e},t}(Ube),cCe=e("Tween",function(){function e(e){this._actions=[],this._finalAction=null,this._target=null,this._tag=Mbe.TAG_INVALID,this._target=void 0===e?null:e}var t=e.prototype;return t.tag=function(e){return this._tag=e,this},t.then=function(e){return e instanceof Mbe?this._actions.push(e.clone()):this._actions.push(e._union()),this},t.target=function(e){return this._target=e,this},t.start=function(){return this._target?(this._finalAction&&zbe.instance.ActionManager.removeAction(this._finalAction),this._finalAction=this._union(),this._finalAction.setTag(this._tag),zbe.instance.ActionManager.addAction(this._finalAction,this._target,!1),this):(S("Please set target to tween first"),this)},t.stop=function(){return this._finalAction&&zbe.instance.ActionManager.removeAction(this._finalAction),this},t.clone=function(e){var t=this._union();return lCe(e).then(t.clone())},t.union=function(){var e=this._union();return this._actions.length=0,this._actions.push(e),this},t.to=function(e,t,n){(n=n||Object.create(null)).relative=!1;var i=new aCe(e,t,n);return this._actions.push(i),this},t.by=function(e,t,n){(n=n||Object.create(null)).relative=!0;var i=new aCe(e,t,n);return this._actions.push(i),this},t.set=function(e){var t=new sCe(e);return this._actions.push(t),this},t.delay=function(e){var t=Jbe(e);return this._actions.push(t),this},t.call=function(e){var t=function(e){return new Vbe(e,void 0,void 0)}(e);return this._actions.push(t),this},t.sequence=function(){var t=e._wrappedSequence.apply(e,arguments);return this._actions.push(t),this},t.parallel=function(){var t=e._wrappedParallel.apply(e,arguments);return this._actions.push(t),this},t.repeat=function(t,n){if(t===1/0)return this.repeatForever(n);var i,r=this._actions;return i=n instanceof e?n._union():r.pop(),r.push(function(e,t){return new Xbe(e,t)}(i,t)),this},t.repeatForever=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new Ybe(e)}(n)),this},t.reverseTime=function(t){var n,i=this._actions;return n=t instanceof e?t._union():i.pop(),i.push(function(e){return new oCe(e)}(n)),this},t.hide=function(){var e=new Gbe;return this._actions.push(e),this},t.show=function(){var e=new kbe;return this._actions.push(e),this},t.removeSelf=function(){var e=new Hbe(!1);return this._actions.push(e),this},e.stopAll=function(){zbe.instance.ActionManager.removeAllActions()},e.stopAllByTag=function(e,t){zbe.instance.ActionManager.removeAllActionsByTag(e,t)},e.stopAllByTarget=function(e){zbe.instance.ActionManager.removeAllActionsFromTarget(e)},t._union=function(){var e=this._actions;return 1===e.length?e[0]:qbe(e)},t._destroy=function(){this.stop()},e._wrappedSequence=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return qbe.apply(qbe,t)},e._wrappedParallel=function(){var t=e._tmp_args;t.length=0;for(var n=arguments.length,i=0;i<n;i++){var r=t[i]=i<0||arguments.length<=i?void 0:arguments[i];r instanceof e&&(t[i]=r._union())}return Qbe.apply(Qbe,t)},e}());function lCe(e){return new cCe(e)}function uCe(e){return S("tweenUtil' is deprecated, please use 'tween' instead "),new cCe(e)}cCe._tmp_args=[],u.Tween=cCe,u.tween=lCe,u.tweenUtil=uCe;var hCe,fCe,_Ce,pCe=new Pn;!function(e){e[e.NONE=0]="NONE",e[e.COLOR=1]="COLOR",e[e.SPRITE=2]="SPRITE",e[e.SCALE=3]="SCALE"}(hCe||(hCe={})),ut(hCe),function(e){e.NORMAL="normal",e.HOVER="hover",e.PRESSED="pressed",e.DISABLED="disabled"}(fCe||(fCe={})),function(e){e.CLICK="click"}(_Ce||(_Ce={}));var dCe=function(t){return e({Button:t,ButtonComponent:t}),t}(($be=mc("cc.Button"),eEe=Oc(),tEe=gc(110),nEe=Pc(),iEe=vc(RX),rEe=Zc(qC),oEe=Vc(),aEe=Fc(),sEe=Vc(),cEe=Fc(),lEe=Zc(hCe),uEe=Vc(),hEe=Fc(),fEe=Vc(),_Ee=Fc(),pEe=Vc(),dEe=Fc(),mEe=Vc(),vEe=Fc(),gEe=Vc(),yEe=Fc(),xEe=Uc(),SEe=kc(),TEe=Vc(),bEe=Fc(),EEe=Vc(),CEe=Fc(),AEe=Zc(nq),wEe=Vc(),PEe=Fc(),REe=Zc(nq),IEe=Vc(),DEe=Fc(),OEe=Zc(nq),MEe=Vc(),NEe=Fc(),LEe=Zc(nq),BEe=Vc(),FEe=Fc(),zEe=Zc([kB]),UEe=Vc(),kEe=Fc(),$be(GEe=eEe(GEe=tEe(GEe=nEe(GEe=iEe(GEe=wc((rCe=iCe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"clickEvents",VEe,oe(t)),ce(t,"_interactable",WEe,oe(t)),ce(t,"_transition",jEe,oe(t)),ce(t,"_normalColor",qEe,oe(t)),ce(t,"_hoverColor",XEe,oe(t)),ce(t,"_pressedColor",YEe,oe(t)),ce(t,"_disabledColor",KEe,oe(t)),ce(t,"_normalSprite",QEe,oe(t)),ce(t,"_hoverSprite",ZEe,oe(t)),ce(t,"_pressedSprite",JEe,oe(t)),ce(t,"_disabledSprite",$Ee,oe(t)),ce(t,"_duration",eCe,oe(t)),ce(t,"_zoomScale",tCe,oe(t)),ce(t,"_target",nCe,oe(t)),t._pressed=!1,t._hovered=!1,t._fromColor=new Pn,t._toColor=new Pn,t._time=0,t._transitionFinished=!0,t._fromScale=new In,t._toScale=new In,t._originalScale=null,t._sprite=null,t._targetScale=new In,t}$(t,e);var n=t.prototype;return n.__preload=function(){this.target||(this.target=this.node);var e=this.node.getComponent(nJ);e&&(this._normalSprite=e.spriteFrame),this._applyTarget(),this._resetState()},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._resetState(),this._unregisterNodeEvent()},n.onDestroy=function(){this.target.isValid&&this._unregisterTargetEvent(this.target)},n.update=function(e){var t=this.target;if(!this._transitionFinished&&t&&(this._transition===hCe.COLOR||this._transition===hCe.SCALE)){this._time+=e;var n=1;if(this._duration>0&&(n=this._time/this._duration),n>=1&&(n=1),this._transition===hCe.COLOR){var i=t._uiProps.uiComp;Pn.lerp(pCe,this._fromColor,this._toColor,n),i&&(i.color=pCe)}else this.transition===hCe.SCALE&&(t.getScale(this._targetScale),this._targetScale.x=hn(this._fromScale.x,this._toScale.x,n),this._targetScale.y=hn(this._fromScale.y,this._toScale.y,n),t.setScale(this._targetScale));1===n&&(this._transitionFinished=!0)}},n._resizeNodeToTargetNode=function(){this.target&&this.target._uiProps.uiTransformComp},n._resetState=function(){this._pressed=!1,this._hovered=!1;var e=this.target;if(e){var t=this._transition;if(t===hCe.COLOR&&this._interactable){var n=e.getComponent(_K);n&&(n.color=this._normalColor)}else t===hCe.SCALE&&this._originalScale&&e.setScale(this._originalScale);this._transitionFinished=!0}},n._registerNodeEvent=function(){this.node.on(Wb.TOUCH_START,this._onTouchBegan,this),this.node.on(Wb.TOUCH_MOVE,this._onTouchMove,this),this.node.on(Wb.TOUCH_END,this._onTouchEnded,this),this.node.on(Wb.TOUCH_CANCEL,this._onTouchCancel,this),this.node.on(Wb.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.on(Wb.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._registerTargetEvent=function(e){e.on(Wb.TRANSFORM_CHANGED,this._onTargetTransformChanged,this)},n._unregisterNodeEvent=function(){this.node.off(Wb.TOUCH_START,this._onTouchBegan,this),this.node.off(Wb.TOUCH_MOVE,this._onTouchMove,this),this.node.off(Wb.TOUCH_END,this._onTouchEnded,this),this.node.off(Wb.TOUCH_CANCEL,this._onTouchCancel,this),this.node.off(Wb.MOUSE_ENTER,this._onMouseMoveIn,this),this.node.off(Wb.MOUSE_LEAVE,this._onMouseMoveOut,this)},n._unregisterTargetEvent=function(e){e.off(Wb.TRANSFORM_CHANGED)},n._getTargetSprite=function(e){var t=null;return e&&(t=e.getComponent(nJ)),t},n._applyTarget=function(){this.target&&(this._sprite=this._getTargetSprite(this.target),this._originalScale||(this._originalScale=new In),In.copy(this._originalScale,this.target.getScale()),this._registerTargetEvent(this.target))},n._onTargetSpriteFrameChanged=function(e){this._transition===hCe.SPRITE&&this._setCurrentStateSpriteFrame(e.spriteFrame)},n._setCurrentStateSpriteFrame=function(e){if(e)switch(this._getButtonState()){case fCe.NORMAL:this._normalSprite=e;break;case fCe.HOVER:this._hoverSprite=e;break;case fCe.PRESSED:this._pressedSprite=e;break;case fCe.DISABLED:this._disabledSprite=e}},n._onTargetColorChanged=function(e){this._transition===hCe.COLOR&&this._setCurrentStateColor(e)},n._setCurrentStateColor=function(e){switch(this._getButtonState()){case fCe.NORMAL:this._normalColor=e;break;case fCe.HOVER:this._hoverColor=e;break;case fCe.PRESSED:this._pressedColor=e;break;case fCe.DISABLED:this._disabledColor=e}},n._onTargetTransformChanged=function(e){e&oy.SCALE&&this._originalScale&&this._transition===hCe.SCALE&&this._transitionFinished&&In.copy(this._originalScale,this.target.getScale())},n._onTouchBegan=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed=!0,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchMove=function(e){if(this._interactable&&this.enabledInHierarchy&&this._pressed&&e){var t=e.touch;if(t){var n,i=this.node._uiProps.uiTransformComp.isHit(t.getUILocation());this._transition===hCe.SCALE&&this.target&&this._originalScale?i?(In.copy(this._fromScale,this._originalScale),In.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._transitionFinished=!1):(this._time=0,this._transitionFinished=!0,this.target.setScale(this._originalScale)):(n=i?fCe.PRESSED:fCe.NORMAL,this._applyTransition(n)),e&&(e.propagationStopped=!0)}}},n._onTouchEnded=function(e){this._interactable&&this.enabledInHierarchy&&(this._pressed&&(kB.emitEvents(this.clickEvents,e),this.node.emit(_Ce.CLICK,this)),this._pressed=!1,this._updateState(),e&&(e.propagationStopped=!0))},n._onTouchCancel=function(){this._interactable&&this.enabledInHierarchy&&(this._pressed=!1,this._updateState())},n._onMouseMoveIn=function(){!this._pressed&&this.interactable&&this.enabledInHierarchy&&(this._transition!==hCe.SPRITE||this._hoverSprite)&&(this._hovered||(this._hovered=!0,this._updateState()))},n._onMouseMoveOut=function(){this._hovered&&(this._hovered=!1,this._updateState())},n._updateState=function(){var e=this._getButtonState();this._applyTransition(e)},n._getButtonState=function(){var e=fCe.NORMAL;return this._interactable?this._pressed?e=fCe.PRESSED:this._hovered&&(e=fCe.HOVER):e=fCe.DISABLED,e.toString()},n._updateColorTransition=function(e){var t,n=this[e+"Color"],i=null===(t=this.target)||void 0===t?void 0:t.getComponent(_K);i&&(e===fCe.DISABLED?i.color=n:(this._fromColor=i.color.clone(),this._toColor=n,this._time=0,this._transitionFinished=!1))},n._updateSpriteTransition=function(e){var t=this[e+"Sprite"];this._sprite&&t&&(this._sprite.spriteFrame=t)},n._updateScaleTransition=function(e){this._interactable&&(e===fCe.PRESSED?this._zoomUp():this._zoomBack())},n._zoomUp=function(){this._originalScale&&(In.copy(this._fromScale,this._originalScale),In.multiplyScalar(this._toScale,this._originalScale,this._zoomScale),this._time=0,this._transitionFinished=!1)},n._zoomBack=function(){this.target&&this._originalScale&&(In.copy(this._fromScale,this.target.getScale()),In.copy(this._toScale,this._originalScale),this._time=0,this._transitionFinished=!1)},n._applyTransition=function(e){var t=this._transition;t===hCe.COLOR?this._updateColorTransition(e):t===hCe.SPRITE?this._updateSpriteTransition(e):t===hCe.SCALE&&this._updateScaleTransition(e)},Z(t,[{key:"target",get:function(){return this._target||this.node},set:function(e){this._target!==e&&(this._target&&this._unregisterTargetEvent(this._target),this._target=e,this._applyTarget())}},{key:"interactable",get:function(){return this._interactable},set:function(e){this._interactable=e,this._updateState(),this._interactable||this._resetState()}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"transition",get:function(){return this._transition},set:function(e){this._transition!==e&&(this._transition===hCe.COLOR?this._updateColorTransition(fCe.NORMAL):this._transition===hCe.SPRITE&&this._updateSpriteTransition(fCe.NORMAL),this._transition=e,this._updateState())}},{key:"normalColor",get:function(){return this._normalColor},set:function(e){this._normalColor!==e&&(this._normalColor.set(e),this._updateState())}},{key:"pressedColor",get:function(){return this._pressedColor},set:function(e){this._pressedColor!==e&&this._pressedColor.set(e)}},{key:"hoverColor",get:function(){return this._hoverColor},set:function(e){this._hoverColor!==e&&this._hoverColor.set(e)}},{key:"disabledColor",get:function(){return this._disabledColor},set:function(e){this._disabledColor!==e&&(this._disabledColor.set(e),this._updateState())}},{key:"duration",get:function(){return this._duration},set:function(e){this._duration!==e&&(this._duration=e)}},{key:"zoomScale",get:function(){return this._zoomScale},set:function(e){this._zoomScale!==e&&(this._zoomScale=e)}},{key:"normalSprite",get:function(){return this._normalSprite},set:function(e){if(this._normalSprite!==e){this._normalSprite=e;var t=this.node.getComponent(nJ);t&&(t.spriteFrame=e),this._updateState()}}},{key:"pressedSprite",get:function(){return this._pressedSprite},set:function(e){this._pressedSprite!==e&&(this._pressedSprite=e,this._updateState())}},{key:"hoverSprite",get:function(){return this._hoverSprite},set:function(e){this._hoverSprite!==e&&(this._hoverSprite=e,this._updateState())}},{key:"disabledSprite",get:function(){return this._disabledSprite},set:function(e){this._disabledSprite!==e&&(this._disabledSprite=e,this._updateState())}}]),t}(th),iCe.Transition=hCe,iCe.EventType=_Ce,le((HEe=rCe).prototype,"target",[rEe,oEe,aEe],Object.getOwnPropertyDescriptor(HEe.prototype,"target"),HEe.prototype),le(HEe.prototype,"interactable",[sEe,cEe],Object.getOwnPropertyDescriptor(HEe.prototype,"interactable"),HEe.prototype),le(HEe.prototype,"transition",[lEe,uEe,hEe],Object.getOwnPropertyDescriptor(HEe.prototype,"transition"),HEe.prototype),le(HEe.prototype,"normalColor",[fEe,_Ee],Object.getOwnPropertyDescriptor(HEe.prototype,"normalColor"),HEe.prototype),le(HEe.prototype,"pressedColor",[pEe,dEe],Object.getOwnPropertyDescriptor(HEe.prototype,"pressedColor"),HEe.prototype),le(HEe.prototype,"hoverColor",[mEe,vEe],Object.getOwnPropertyDescriptor(HEe.prototype,"hoverColor"),HEe.prototype),le(HEe.prototype,"disabledColor",[gEe,yEe],Object.getOwnPropertyDescriptor(HEe.prototype,"disabledColor"),HEe.prototype),le(HEe.prototype,"duration",[xEe,SEe,TEe,bEe],Object.getOwnPropertyDescriptor(HEe.prototype,"duration"),HEe.prototype),le(HEe.prototype,"zoomScale",[EEe,CEe],Object.getOwnPropertyDescriptor(HEe.prototype,"zoomScale"),HEe.prototype),le(HEe.prototype,"normalSprite",[AEe,wEe,PEe],Object.getOwnPropertyDescriptor(HEe.prototype,"normalSprite"),HEe.prototype),le(HEe.prototype,"pressedSprite",[REe,IEe,DEe],Object.getOwnPropertyDescriptor(HEe.prototype,"pressedSprite"),HEe.prototype),le(HEe.prototype,"hoverSprite",[OEe,MEe,NEe],Object.getOwnPropertyDescriptor(HEe.prototype,"hoverSprite"),HEe.prototype),le(HEe.prototype,"disabledSprite",[LEe,BEe,FEe],Object.getOwnPropertyDescriptor(HEe.prototype,"disabledSprite"),HEe.prototype),VEe=le(HEe.prototype,"clickEvents",[zEe,Tc,UEe,kEe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WEe=le(HEe.prototype,"_interactable",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),jEe=le(HEe.prototype,"_transition",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return hCe.NONE}}),qEe=le(HEe.prototype,"_normalColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),XEe=le(HEe.prototype,"_hoverColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(211,211,211,255)}}),YEe=le(HEe.prototype,"_pressedColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Pn.WHITE.clone()}}),KEe=le(HEe.prototype,"_disabledColor",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new Pn(124,124,124,255)}}),QEe=le(HEe.prototype,"_normalSprite",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ZEe=le(HEe.prototype,"_hoverSprite",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),JEe=le(HEe.prototype,"_pressedSprite",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),$Ee=le(HEe.prototype,"_disabledSprite",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eCe=le(HEe.prototype,"_duration",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),tCe=le(HEe.prototype,"_zoomScale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1.2}}),nCe=le(HEe.prototype,"_target",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),GEe=HEe))||GEe)||GEe)||GEe)||GEe)||GEe)||GEe));u.Button=dCe;var mCe,vCe,gCe,yCe=function(){function e(){}return e.add=function(e){var t=this._tabIndexList;-1===t.indexOf(e)&&t.push(e)},e.remove=function(e){var t=this._tabIndexList,n=t.indexOf(e);-1!==n&&t.splice(n,1)},e.resort=function(){this._tabIndexList.sort((function(e,t){return e._delegate.tabIndex-t._delegate.tabIndex}))},e.next=function(e){var t=this._tabIndexList,n=t.indexOf(e);if(e.setFocus(!1),-1!==n){var i=t[n+1];i&&i._delegate.tabIndex>=0&&i.setFocus(!0)}},e}();yCe._tabIndexList=[],function(e){e[e.DEFAULT=0]="DEFAULT",e[e.DONE=1]="DONE",e[e.SEND=2]="SEND",e[e.SEARCH=3]="SEARCH",e[e.GO=4]="GO",e[e.NEXT=5]="NEXT"}(mCe||(mCe={})),st(mCe),function(e){e[e.ANY=0]="ANY",e[e.EMAIL_ADDR=1]="EMAIL_ADDR",e[e.NUMERIC=2]="NUMERIC",e[e.PHONE_NUMBER=3]="PHONE_NUMBER",e[e.URL=4]="URL",e[e.DECIMAL=5]="DECIMAL",e[e.SINGLE_LINE=6]="SINGLE_LINE"}(vCe||(vCe={})),st(vCe),function(e){e[e.PASSWORD=0]="PASSWORD",e[e.SENSITIVE=1]="SENSITIVE",e[e.INITIAL_CAPS_WORD=2]="INITIAL_CAPS_WORD",e[e.INITIAL_CAPS_SENTENCE=3]="INITIAL_CAPS_SENTENCE",e[e.INITIAL_CAPS_ALL_CHARACTERS=4]="INITIAL_CAPS_ALL_CHARACTERS",e[e.DEFAULT=5]="DEFAULT"}(gCe||(gCe={})),st(gCe);var xCe,SCe,TCe,bCe,ECe,CCe,ACe,wCe,PCe,RCe,ICe,DCe,OCe,MCe,NCe,LCe,BCe,FCe,zCe,UCe,kCe,GCe,HCe,VCe,WCe,jCe,qCe,XCe,YCe,KCe,QCe,ZCe,JCe,$Ce,eAe,tAe,nAe,iAe,rAe,oAe,aAe,sAe,cAe,lAe,uAe,hAe,fAe,_Ae,pAe,dAe,mAe,vAe,gAe,yAe,xAe,SAe,TAe,bAe,EAe,CAe,AAe,wAe=function(){function e(){this._editing=!1,this._delegate=null}var t=e.prototype;return t.init=function(){},t.onEnable=function(){},t.update=function(){},t.onDisable=function(){this._editing&&this.endEditing()},t.clear=function(){this._delegate=null},t.setTabIndex=function(){},t.setSize=function(){},t.setFocus=function(e){e?this.beginEditing():this.endEditing()},t.isFocused=function(){return this._editing},t.beginEditing=function(){},t.endEditing=function(){},e}(),PAe=new jn,RAe=new jn,IAe=new In,DAe=null,OAe=0,MAe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._delegate=null,t._inputMode=-1,t._inputFlag=-1,t._returnType=-1,t.__eventListeners={},t.__autoResize=!1,t.__orientationChanged=void 0,t._edTxt=null,t._isTextArea=!1,t._textLabelFont=null,t._textLabelFontSize=null,t._textLabelFontColor=null,t._textLabelAlign=null,t._placeholderLabelFont=null,t._placeholderLabelFontSize=null,t._placeholderLabelFontColor=null,t._placeholderLabelAlign=null,t._placeholderLineHeight=null,t._placeholderStyleSheet=null,t._domId="EditBoxId_"+ ++OAe,t}$(t,e);var n=t.prototype;return n.init=function(e){e&&(this._delegate=e,e.inputMode===vCe.ANY?this._createTextArea():this._createInput(),yCe.add(this),this.setTabIndex(e.tabIndex),this._initStyleSheet(),this._registerEventListeners(),this._addDomToGameContainer())},n.clear=function(){this._removeEventListeners(),this._removeDomFromGameContainer(),yCe.remove(this),DAe===this&&(DAe=null),this._delegate=null},n.update=function(){this._updateMatrix()},n.setTabIndex=function(e){this._edTxt.tabIndex=e,yCe.resort()},n.setSize=function(e,t){var n=this._edTxt;n&&(n.style.width=e+"px",n.style.height=t+"px")},n.beginEditing=function(){DAe&&DAe!==this&&DAe.setFocus(!1),this._editing=!0,DAe=this,this._delegate._editBoxEditingDidBegan(),this._showDom(),this._edTxt.focus()},n.endEditing=function(){this._edTxt.blur()},n._createInput=function(){this._isTextArea=!1,this._edTxt=document.createElement("input")},n._createTextArea=function(){this._isTextArea=!0,this._edTxt=document.createElement("textarea")},n._addDomToGameContainer=function(){u.GAME_VIEW&&this._edTxt?(u.gameView.container.appendChild(this._edTxt),u.gameView.head.appendChild(this._placeholderStyleSheet)):VM.container&&this._edTxt&&(VM.container.appendChild(this._edTxt),document.head.appendChild(this._placeholderStyleSheet))},n._removeDomFromGameContainer=function(){(u.GAME_VIEW?xt(u.gameView.container,this._edTxt):xt(VM.container,this._edTxt))&&this._edTxt&&(u.GAME_VIEW?u.gameView.container.removeChild(this._edTxt):VM.container.removeChild(this._edTxt)),(u.GAME_VIEW?xt(u.gameView.head,this._placeholderStyleSheet):xt(document.head,this._placeholderStyleSheet))&&(u.GAME_VIEW?u.gameView.head.removeChild(this._placeholderStyleSheet):document.head.removeChild(this._placeholderStyleSheet)),this._edTxt=null,this._placeholderStyleSheet=null},n._showDom=function(){this._updateMaxLength(),this._updateInputType(),this._updateStyleSheet(),this._edTxt&&this._delegate&&(this._edTxt.style.display="",this._delegate._hideLabels()),hh.isMobile&&this._showDomOnMobile()},n._hideDom=function(){var e=this._edTxt;e&&this._delegate&&(e.style.display="none",this._delegate._showLabels()),hh.isMobile&&this._hideDomOnMobile()},n._showDomOnMobile=function(){hh.os!==cu.ANDROID&&hh.os!==cu.OHOS||(ch.handleResizeEvent=!1,this._adjustWindowScroll())},n._hideDomOnMobile=function(){hh.os!==cu.ANDROID&&hh.os!==cu.OHOS||(ch.handleResizeEvent=!0),this._scrollBackWindow()},n._adjustWindowScroll=function(){var e=this;setTimeout((function(){window.scrollY<40&&e._edTxt.scrollIntoView({block:"start",inline:"nearest",behavior:"smooth"})}),400)},n._scrollBackWindow=function(){setTimeout((function(){hh.browserType!==ou.WECHAT||hh.os!==cu.IOS?window.scrollTo(0,0):window.top&&window.top.scrollTo(0,0)}),400)},n._updateMatrix=function(){if(this._edTxt){var e=this._delegate.node,t=tN.getScaleX(),n=tN.getScaleY(),i=1,r=1;u.GAME_VIEW&&(i=u.gameView.canvas.width/u.game.canvas.width,r=u.gameView.canvas.height/u.game.canvas.height),t*=i,n*=r;var o=tN.getViewportRect(),a=ch.devicePixelRatio;e.getWorldMatrix(PAe);var s=e._uiProps.uiTransformComp;if(s&&In.set(IAe,-s.anchorX*s.width,-s.anchorY*s.height,IAe.z),jn.transform(PAe,PAe,IAe),e._uiProps.uiTransformComp){var c=jM.root.batcher2D.getFirstRenderCamera(e);if(c){c.node.getWorldRT(RAe);var l=RAe.m12,h=RAe.m13,f=YM.center;RAe.m12=f.x-(RAe.m00*l+RAe.m04*h),RAe.m13=f.y-(RAe.m01*l+RAe.m05*h),jn.multiply(RAe,RAe,PAe),t/=a,n/=a;var _=u.GAME_VIEW?u.gameView.container:VM.container,p=RAe.m00*t,d=PAe.m01,m=PAe.m04,v=RAe.m05*n,g=parseInt(_&&_.style.paddingLeft||"0");g+=o.x*i/a;var y=parseInt(_&&_.style.paddingBottom||"0");y+=o.y/a;var x="matrix("+p+","+-d+","+-m+","+v+","+(RAe.m12*t+g)+","+-(RAe.m13*n+y)+")";this._edTxt.style.transform=x,this._edTxt.style["-webkit-transform"]=x,this._edTxt.style["transform-origin"]="0px 100% 0px",this._edTxt.style["-webkit-transform-origin"]="0px 100% 0px"}}}},n._updateInputType=function(){var e=this._delegate,t=e.inputMode,n=e.inputFlag,i=e.returnType,r=this._edTxt;if(this._inputMode!==t||this._inputFlag!==n||this._returnType!==i){if(this._inputMode=t,this._inputFlag=n,this._returnType=i,this._isTextArea){var o="none";return n===gCe.INITIAL_CAPS_ALL_CHARACTERS?o="uppercase":n===gCe.INITIAL_CAPS_WORD&&(o="capitalize"),void(r.style.textTransform=o)}if(r=r,n===gCe.PASSWORD)return r.type="password",void(r.style.textTransform="none");var a=r.type;t===vCe.EMAIL_ADDR?a="email":t===vCe.NUMERIC||t===vCe.DECIMAL?a="number":t===vCe.PHONE_NUMBER?(a="number",r.pattern="[0-9]*",r.addEventListener("wheel",(function(){return!1}))):t===vCe.URL?a="url":(a="text",i===mCe.SEARCH&&(a="search")),r.type=a;var s="none";n===gCe.INITIAL_CAPS_ALL_CHARACTERS?s="uppercase":n===gCe.INITIAL_CAPS_WORD&&(s="capitalize"),r.style.textTransform=s}},n._updateMaxLength=function(){var e=this._delegate.maxLength;e<0&&(e=65535),this._edTxt.maxLength=e},n._initStyleSheet=function(){if(this._edTxt){var e=this._edTxt;e.style.color="#000000",e.style.border="0px",e.style.background="transparent",e.style.width="100%",e.style.height="100%",e.style.outline="medium",e.style.padding="0",e.style.textTransform="none",e.style.display="none",e.style.position="absolute",e.style.bottom="0px",e.style.left="2px",e.className="cocosEditBox",e.style.fontFamily="Arial",e.id=this._domId,this._isTextArea?(e.style.resize="none",e.style.overflowY="scroll"):((e=e).type="text",e.style["-moz-appearance"]="textfield"),this._placeholderStyleSheet=document.createElement("style")}},n._updateStyleSheet=function(){var e=this._delegate,t=this._edTxt;t&&e&&(t.value=e.string,t.placeholder=e.placeholder,this._updateTextLabel(e.textLabel),this._updatePlaceholderLabel(e.placeholderLabel))},n._updateTextLabel=function(e){if(e){var t=e.font;t=!t||t instanceof bq?e.fontFamily:t._fontFamily;var n=e.fontSize*e.node.scale.y;if((this._textLabelFont!==t||this._textLabelFontSize!==n||this._textLabelFontColor!==e.fontColor||this._textLabelAlign!==e.horizontalAlign)&&(this._textLabelFont=t,this._textLabelFontSize=n,this._textLabelFontColor=e.fontColor,this._textLabelAlign=e.horizontalAlign,this._edTxt)){var i=this._edTxt;switch(i.style.fontSize=n+"px",i.style.color=e.color.toCSS(),i.style.fontFamily=t,e.horizontalAlign){case pK.HorizontalAlign.LEFT:i.style.textAlign="left";break;case pK.HorizontalAlign.CENTER:i.style.textAlign="center";break;case pK.HorizontalAlign.RIGHT:i.style.textAlign="right"}}}},n._updatePlaceholderLabel=function(e){if(e){var t=e.font;t=!t||t instanceof bq?e.fontFamily:e.font._fontFamily;var n=e.fontSize*e.node.scale.y;if(this._placeholderLabelFont!==t||this._placeholderLabelFontSize!==n||this._placeholderLabelFontColor!==e.fontColor||this._placeholderLabelAlign!==e.horizontalAlign||this._placeholderLineHeight!==e.fontSize){this._placeholderLabelFont=t,this._placeholderLabelFontSize=n,this._placeholderLabelFontColor=e.fontColor,this._placeholderLabelAlign=e.horizontalAlign,this._placeholderLineHeight=e.fontSize;var i=this._placeholderStyleSheet,r=e.color.toCSS(),o=e.fontSize,a="";switch(e.horizontalAlign){case pK.HorizontalAlign.LEFT:a="left";break;case pK.HorizontalAlign.CENTER:a="center";break;case pK.HorizontalAlign.RIGHT:a="right"}i.innerHTML="#"+this._domId+"::-webkit-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-moz-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}#"+this._domId+"::-ms-input-placeholder{text-transform: initial;-family: "+t+";font-size: "+n+"px;color: "+r+";line-height: "+o+"px;text-align: "+a+";}",hh.browserType===ou.EDGE&&(i.innerHTML+="#"+this._domId+"::-ms-clear{display: none;}")}}},n._registerEventListeners=function(){var e=this;if(this._edTxt){var t=this._edTxt,n=!1,i=this.__eventListeners;i.compositionStart=function(){n=!0},i.compositionEnd=function(){n=!1,e._delegate._editBoxTextChanged(t.value)},i.onInput=function(){if(!n){var i=e._delegate,r=i.maxLength;r>=0&&(t.value=t.value.slice(0,r)),i._editBoxTextChanged(t.value)}},i.onClick=function(){e._editing&&hh.isMobile&&e._adjustWindowScroll()},i.onKeydown=function(n){n.keyCode===QI.ENTER?(n.propagationStopped=!0,e._delegate._editBoxEditingReturn(),e._isTextArea||t.blur()):n.keyCode===QI.TAB&&(n.propagationStopped=!0,n.preventDefault(),yCe.next(e))},i.onBlur=function(){hh.isMobile&&n&&i.compositionEnd(),e._editing=!1,DAe=null,e._hideDom(),e._delegate._editBoxEditingDidEnded()},t.addEventListener("compositionstart",i.compositionStart),t.addEventListener("compositionend",i.compositionEnd),t.addEventListener("input",i.onInput),t.addEventListener("keydown",i.onKeydown),t.addEventListener("blur",i.onBlur),t.addEventListener("touchstart",i.onClick)}},n._removeEventListeners=function(){if(this._edTxt){var e=this._edTxt,t=this.__eventListeners;e.removeEventListener("compositionstart",t.compositionStart),e.removeEventListener("compositionend",t.compositionEnd),e.removeEventListener("input",t.onInput),e.removeEventListener("keydown",t.onKeydown),e.removeEventListener("blur",t.onBlur),e.removeEventListener("touchstart",t.onClick),t.compositionStart=null,t.compositionEnd=null,t.onInput=null,t.onKeydown=null,t.onBlur=null,t.onClick=null}},t}(wAe);!function(e){e.EDITING_DID_BEGAN="editing-did-began",e.EDITING_DID_ENDED="editing-did-ended",e.TEXT_CHANGED="text-changed",e.EDITING_RETURN="editing-return"}(AAe||(AAe={}));var NAe,LAe,BAe,FAe,zAe,UAe,kAe,GAe,HAe,VAe,WAe,jAe,qAe,XAe,YAe,KAe,QAe,ZAe,JAe,$Ae,ewe,twe,nwe,iwe,rwe,owe,awe,swe,cwe,lwe,uwe,hwe,fwe,_we,pwe,dwe,mwe,vwe,gwe,ywe,xwe,Swe,Twe,bwe,Ewe,Cwe,Awe,wwe,Pwe,Rwe,Iwe,Dwe,Owe,Mwe,Nwe,Lwe,Bwe,Fwe,zwe,Uwe,kwe,Gwe=function(t){return e({EditBox:t,EditBoxComponent:t}),t}((xCe=mc("cc.EditBox"),SCe=Oc(),TCe=gc(110),bCe=Pc(),ECe=vc(RX),CCe=Vc(),ACe=Fc(),wCe=Vc(),PCe=Fc(),RCe=Zc(pK),ICe=Vc(),DCe=Fc(),OCe=Zc(pK),MCe=Vc(),NCe=Fc(),LCe=Zc(nq),BCe=Vc(),FCe=Fc(),zCe=Zc(gCe),UCe=Vc(),kCe=Fc(),GCe=Zc(vCe),HCe=Vc(),VCe=Fc(),WCe=Zc(mCe),jCe=Vc(),qCe=Fc(),XCe=Vc(),YCe=Fc(),KCe=Vc(),QCe=Fc(),ZCe=Zc([kB]),JCe=Vc(),$Ce=Fc(),eAe=Zc([kB]),tAe=Vc(),nAe=Fc(),iAe=Zc([kB]),rAe=Vc(),oAe=Fc(),aAe=Zc([kB]),sAe=Vc(),cAe=Fc(),xCe(lAe=SCe(lAe=TCe(lAe=bCe(lAe=ECe(lAe=wc((CAe=EAe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"editingDidBegan",hAe,oe(t)),ce(t,"textChanged",fAe,oe(t)),ce(t,"editingDidEnded",_Ae,oe(t)),ce(t,"editingReturn",pAe,oe(t)),t._impl=null,t._background=null,ce(t,"_textLabel",dAe,oe(t)),ce(t,"_placeholderLabel",mAe,oe(t)),ce(t,"_returnType",vAe,oe(t)),ce(t,"_string",gAe,oe(t)),ce(t,"_tabIndex",yAe,oe(t)),ce(t,"_backgroundImage",xAe,oe(t)),ce(t,"_inputFlag",SAe,oe(t)),ce(t,"_inputMode",TAe,oe(t)),ce(t,"_maxLength",bAe,oe(t)),t._isLabelVisible=!1,t}$(t,e);var n=t.prototype;return n.__preload=function(){this._init()},n.onEnable=function(){this._registerEvent(),this._ensureBackgroundSprite(),this._impl&&this._impl.onEnable()},n.update=function(){this._impl&&this._impl.update()},n.onDisable=function(){this._unregisterEvent(),this._unregisterBackgroundEvent(),this._impl&&this._impl.onDisable()},n.onDestroy=function(){this._impl&&this._impl.clear()},n.setFocus=function(){this._impl&&this._impl.setFocus(!0)},n.focus=function(){this._impl&&this._impl.setFocus(!0)},n.blur=function(){this._impl&&this._impl.setFocus(!1)},n.isFocused=function(){return!!this._impl&&this._impl.isFocused()},n._editBoxEditingDidBegan=function(){kB.emitEvents(this.editingDidBegan,this),this.node.emit(AAe.EDITING_DID_BEGAN,this)},n._editBoxEditingDidEnded=function(){kB.emitEvents(this.editingDidEnded,this),this.node.emit(AAe.EDITING_DID_ENDED,this)},n._editBoxTextChanged=function(e){e=this._updateLabelStringStyle(e,!0),this.string=e,kB.emitEvents(this.textChanged,e,this),this.node.emit(AAe.TEXT_CHANGED,this)},n._editBoxEditingReturn=function(){kB.emitEvents(this.editingReturn,this),this.node.emit(AAe.EDITING_RETURN,this)},n._showLabels=function(){this._isLabelVisible=!0,this._updateLabels()},n._hideLabels=function(){this._isLabelVisible=!1,this._textLabel&&(this._textLabel.node.active=!1),this._placeholderLabel&&(this._placeholderLabel.node.active=!1)},n._onTouchBegan=function(e){e.propagationStopped=!0},n._onTouchCancel=function(e){e.propagationStopped=!0},n._onTouchEnded=function(e){this._impl&&this._impl.beginEditing(),e.propagationStopped=!0},n._init=function(){this._updatePlaceholderLabel(),this._updateTextLabel(),this._isLabelVisible=!0,this.node.on(Wb.SIZE_CHANGED,this._resizeChildNodes,this),(this._impl=new t._EditBoxImpl).init(this),this._updateString(this._string),this._syncSize()},n._ensureBackgroundSprite=function(){if(!this._background){var e=this.node.getComponent(nJ);e||(e=this.node.addComponent(nJ)),e!==this._background&&(e.type=nJ.Type.SLICED,e.spriteFrame=this._backgroundImage,this._background=e,this._registerBackgroundEvent())}},n._updateTextLabel=function(){var e=this._textLabel;if(!e){var t=this.node.getChildByName("TEXT_LABEL");t||((t=new qC("TEXT_LABEL")).layer=this.node.layer),(e=t.getComponent(pK))||(e=t.addComponent(pK)),t.parent=this.node,this._textLabel=e}this._textLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=pK.Overflow.CLAMP,this._inputMode===vCe.ANY?(e.verticalAlign=uK.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this._updateLabelStringStyle(this._string)},n._updatePlaceholderLabel=function(){var e=this._placeholderLabel;if(!e){var t=this.node.getChildByName("PLACEHOLDER_LABEL");t||((t=new qC("PLACEHOLDER_LABEL")).layer=this.node.layer),(e=t.getComponent(pK))||(e=t.addComponent(pK)),t.parent=this.node,this._placeholderLabel=e}this._placeholderLabel.node._uiProps.uiTransformComp.setAnchorPoint(0,1),e.overflow=pK.Overflow.CLAMP,this._inputMode===vCe.ANY?(e.verticalAlign=uK.TOP,e.enableWrapText=!0):e.enableWrapText=!1,e.string=this.placeholder},n._syncSize=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(this._background){var n=this._background.node._uiProps.uiTransformComp;n.anchorPoint=e.anchorPoint,n.setContentSize(t)}this._updateLabelPosition(t),this._impl&&this._impl.setSize(t.width,t.height)},n._updateLabels=function(){if(this._isLabelVisible){var e=this._string;this._textLabel&&(this._textLabel.node.active=""!==e),this._placeholderLabel&&(this._placeholderLabel.node.active=""===e)}},n._updateString=function(e){var t=this._textLabel;if(t){var n=e;n&&(n=this._updateLabelStringStyle(n)),t.string=n,this._updateLabels()}},n._updateLabelStringStyle=function(e,t){void 0===t&&(t=!1);var n,i=this._inputFlag;if(t||i!==gCe.PASSWORD)i===gCe.INITIAL_CAPS_ALL_CHARACTERS?e=e.toUpperCase():i===gCe.INITIAL_CAPS_WORD?e=e.replace(/(?:^|\s)\S/g,(function(e){return e.toUpperCase()})):i===gCe.INITIAL_CAPS_SENTENCE&&(e=(n=e).charAt(0).toUpperCase()+n.slice(1));else{for(var r="",o=e.length,a=0;a<o;++a)r+="";e=r}return e},n._registerEvent=function(){this.node.on(Wb.TOUCH_START,this._onTouchBegan,this),this.node.on(Wb.TOUCH_END,this._onTouchEnded,this)},n._unregisterEvent=function(){this.node.off(Wb.TOUCH_START,this._onTouchBegan,this),this.node.off(Wb.TOUCH_END,this._onTouchEnded,this)},n._onBackgroundSpriteFrameChanged=function(){this._background&&(this.backgroundImage=this._background.spriteFrame)},n._registerBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.on(nJ.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._unregisterBackgroundEvent=function(){var e=this._background&&this._background.node;null==e||e.off(nJ.EventType.SPRITE_FRAME_CHANGED,this._onBackgroundSpriteFrameChanged,this)},n._updateLabelPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=-t.anchorX*t.width,i=-t.anchorY*t.height,r=this._placeholderLabel,o=this._textLabel;o&&(o.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),o.node.setPosition(n+2,i+e.height,o.node.position.z),this._inputMode===vCe.ANY&&(o.verticalAlign=uK.TOP),o.enableWrapText=this._inputMode===vCe.ANY),r&&(r.node._uiProps.uiTransformComp.setContentSize(e.width-2,e.height),r.lineHeight=e.height,r.node.setPosition(n+2,i+e.height,r.node.position.z),this._inputMode===vCe.ANY&&(r.verticalAlign=uK.TOP),r.enableWrapText=this._inputMode===vCe.ANY)},n._resizeChildNodes=function(){var e=this.node._uiProps.uiTransformComp,t=this._textLabel&&this._textLabel.node;t&&(t.setPosition(-e.width/2,e.height/2,t.position.z),t._uiProps.uiTransformComp.setContentSize(e.contentSize));var n=this._placeholderLabel&&this._placeholderLabel.node;n&&(n.setPosition(-e.width/2,e.height/2,n.position.z),n._uiProps.uiTransformComp.setContentSize(e.contentSize));var i=this._background&&this._background.node;i&&i._uiProps.uiTransformComp.setContentSize(e.contentSize),this._syncSize()},Z(t,[{key:"string",get:function(){return this._string},set:function(e){this._maxLength>=0&&e.length>=this._maxLength&&(e=e.slice(0,this._maxLength)),this._string=e,this._updateString(e)}},{key:"placeholder",get:function(){return this._placeholderLabel?this._placeholderLabel.string:""},set:function(e){this._placeholderLabel&&(this._placeholderLabel.string=e)}},{key:"textLabel",get:function(){return this._textLabel},set:function(e){this._textLabel!==e&&(this._textLabel=e,this._textLabel&&(this._updateTextLabel(),this._updateLabels()))}},{key:"placeholderLabel",get:function(){return this._placeholderLabel},set:function(e){this._placeholderLabel!==e&&(this._placeholderLabel=e,this._placeholderLabel&&(this._updatePlaceholderLabel(),this._updateLabels()))}},{key:"backgroundImage",get:function(){return this._backgroundImage},set:function(e){this._backgroundImage!==e&&(this._backgroundImage=e,this._ensureBackgroundSprite(),this._background.spriteFrame=e)}},{key:"inputFlag",get:function(){return this._inputFlag},set:function(e){this._inputFlag=e,this._updateString(this._string)}},{key:"inputMode",get:function(){return this._inputMode},set:function(e){this._inputMode!==e&&(this._inputMode=e,this._updateTextLabel(),this._updatePlaceholderLabel())}},{key:"returnType",get:function(){return this._returnType},set:function(e){this._returnType=e}},{key:"maxLength",get:function(){return this._maxLength},set:function(e){this._maxLength=e}},{key:"tabIndex",get:function(){return this._tabIndex},set:function(e){this._tabIndex!==e&&(this._tabIndex=e,this._impl&&this._impl.setTabIndex(e))}}]),t}(th),EAe._EditBoxImpl=wAe,EAe.KeyboardReturnType=mCe,EAe.InputFlag=gCe,EAe.InputMode=vCe,EAe.EventType=AAe,le((uAe=CAe).prototype,"string",[CCe,ACe],Object.getOwnPropertyDescriptor(uAe.prototype,"string"),uAe.prototype),le(uAe.prototype,"placeholder",[wCe,PCe],Object.getOwnPropertyDescriptor(uAe.prototype,"placeholder"),uAe.prototype),le(uAe.prototype,"textLabel",[RCe,ICe,DCe],Object.getOwnPropertyDescriptor(uAe.prototype,"textLabel"),uAe.prototype),le(uAe.prototype,"placeholderLabel",[OCe,MCe,NCe],Object.getOwnPropertyDescriptor(uAe.prototype,"placeholderLabel"),uAe.prototype),le(uAe.prototype,"backgroundImage",[LCe,BCe,FCe],Object.getOwnPropertyDescriptor(uAe.prototype,"backgroundImage"),uAe.prototype),le(uAe.prototype,"inputFlag",[zCe,UCe,kCe],Object.getOwnPropertyDescriptor(uAe.prototype,"inputFlag"),uAe.prototype),le(uAe.prototype,"inputMode",[GCe,HCe,VCe],Object.getOwnPropertyDescriptor(uAe.prototype,"inputMode"),uAe.prototype),le(uAe.prototype,"returnType",[WCe,jCe,qCe],Object.getOwnPropertyDescriptor(uAe.prototype,"returnType"),uAe.prototype),le(uAe.prototype,"maxLength",[XCe,YCe],Object.getOwnPropertyDescriptor(uAe.prototype,"maxLength"),uAe.prototype),le(uAe.prototype,"tabIndex",[KCe,QCe],Object.getOwnPropertyDescriptor(uAe.prototype,"tabIndex"),uAe.prototype),hAe=le(uAe.prototype,"editingDidBegan",[ZCe,Tc,JCe,$Ce],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fAe=le(uAe.prototype,"textChanged",[eAe,Tc,tAe,nAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),_Ae=le(uAe.prototype,"editingDidEnded",[iAe,Tc,rAe,oAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),pAe=le(uAe.prototype,"editingReturn",[aAe,Tc,sAe,cAe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),dAe=le(uAe.prototype,"_textLabel",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),mAe=le(uAe.prototype,"_placeholderLabel",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),vAe=le(uAe.prototype,"_returnType",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return mCe.DEFAULT}}),gAe=le(uAe.prototype,"_string",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),yAe=le(uAe.prototype,"_tabIndex",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),xAe=le(uAe.prototype,"_backgroundImage",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),SAe=le(uAe.prototype,"_inputFlag",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gCe.DEFAULT}}),TAe=le(uAe.prototype,"_inputMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return vCe.ANY}}),bAe=le(uAe.prototype,"_maxLength",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 20}}),lAe=uAe))||lAe)||lAe)||lAe)||lAe)||lAe)||lAe));"object"==typeof window&&"object"==typeof document&&(Gwe._EditBoxImpl=MAe),u.internal.EditBox=Gwe,function(e){e[e.NONE=0]="NONE",e[e.HORIZONTAL=1]="HORIZONTAL",e[e.VERTICAL=2]="VERTICAL",e[e.GRID=3]="GRID"}(Lwe||(Lwe={})),ut(Lwe),function(e){e[e.NONE=0]="NONE",e[e.CONTAINER=1]="CONTAINER",e[e.CHILDREN=2]="CHILDREN"}(Bwe||(Bwe={})),ut(Bwe),function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(Fwe||(Fwe={})),ut(Fwe),function(e){e[e.BOTTOM_TO_TOP=0]="BOTTOM_TO_TOP",e[e.TOP_TO_BOTTOM=1]="TOP_TO_BOTTOM"}(zwe||(zwe={})),ut(zwe),function(e){e[e.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",e[e.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Uwe||(Uwe={})),ut(Uwe),function(e){e[e.NONE=0]="NONE",e[e.FIXED_ROW=1]="FIXED_ROW",e[e.FIXED_COL=2]="FIXED_COL"}(kwe||(kwe={})),ut(kwe);var Hwe,Vwe,Wwe,jwe,qwe,Xwe,Ywe,Kwe,Qwe,Zwe,Jwe,$we,ePe,tPe,nPe,iPe,rPe,oPe,aPe,sPe,cPe,lPe,uPe,hPe=new In,fPe=function(t){return e({Layout:t,LayoutComponent:t}),t}((NAe=mc("cc.Layout"),LAe=Oc(),BAe=gc(110),FAe=Pc(),zAe=vc(RX),UAe=Nc(),kAe=Fc(),GAe=Nc(),HAe=Fc(),VAe=Zc(Lwe),WAe=Vc(),jAe=Fc(),qAe=Zc(Bwe),XAe=Nc(),YAe=Fc(),KAe=Nc(),QAe=Fc(),ZAe=Zc(Fwe),JAe=Fc(),$Ae=Fc(),ewe=Fc(),twe=Fc(),nwe=Fc(),iwe=Fc(),rwe=Fc(),owe=Zc(zwe),awe=Fc(),swe=Zc(Uwe),cwe=Fc(),lwe=Zc(kwe),uwe=Nc(),hwe=Fc(),fwe=Nc(),_we=Fc(),pwe=Fc(),NAe(dwe=LAe(dwe=BAe(dwe=FAe(dwe=zAe(dwe=wc((Nwe=Mwe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_resizeMode",vwe,oe(t)),ce(t,"_layoutType",gwe,oe(t)),ce(t,"_cellSize",ywe,oe(t)),ce(t,"_startAxis",xwe,oe(t)),ce(t,"_paddingLeft",Swe,oe(t)),ce(t,"_paddingRight",Twe,oe(t)),ce(t,"_paddingTop",bwe,oe(t)),ce(t,"_paddingBottom",Ewe,oe(t)),ce(t,"_spacingX",Cwe,oe(t)),ce(t,"_spacingY",Awe,oe(t)),ce(t,"_verticalDirection",wwe,oe(t)),ce(t,"_horizontalDirection",Pwe,oe(t)),ce(t,"_constraint",Rwe,oe(t)),ce(t,"_constraintNum",Iwe,oe(t)),ce(t,"_affectedByScale",Dwe,oe(t)),ce(t,"_isAlign",Owe,oe(t)),t._layoutSize=new ni(300,200),t._layoutDirty=!0,t._childrenDirty=!1,t._usefulLayoutObj=[],t._init=!1,t}$(t,e);var n=t.prototype;return n.updateLayout=function(e){void 0===e&&(e=!1),(this._layoutDirty||e)&&this.node.children.length>0&&(this._doLayout(),this._layoutDirty=!1)},n.onEnable=function(){this._addEventListeners();var e=this.node._uiProps.uiTransformComp;e.contentSize.equals(ni.ZERO)&&e.setContentSize(this._layoutSize),this._childrenChanged()},n.onDisable=function(){this._usefulLayoutObj.length=0,this._removeEventListeners()},n._checkUsefulObj=function(){this._usefulLayoutObj.length=0;for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t],i=n._uiProps.uiTransformComp;n.activeInHierarchy&&i&&this._usefulLayoutObj.push(i)}},n._addEventListeners=function(){jM.on(WM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.on(Wb.SIZE_CHANGED,this._resized,this),this.node.on(Wb.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.on(Wb.CHILD_ADDED,this._childAdded,this),this.node.on(Wb.CHILD_REMOVED,this._childRemoved,this),this.node.on(Wb.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.on("childrenSiblingOrderChanged",this.updateLayout,this),this._addChildrenEventListeners()},n._removeEventListeners=function(){jM.off(WM.EVENT_AFTER_UPDATE,this.updateLayout,this),this.node.off(Wb.SIZE_CHANGED,this._resized,this),this.node.off(Wb.ANCHOR_CHANGED,this._doLayoutDirty,this),this.node.off(Wb.CHILD_ADDED,this._childAdded,this),this.node.off(Wb.CHILD_REMOVED,this._childRemoved,this),this.node.off(Wb.SIBLING_ORDER_CHANGED,this._childrenChanged,this),this.node.off("childrenSiblingOrderChanged",this.updateLayout,this),this._removeChildrenEventListeners()},n._addChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.on(Wb.SIZE_CHANGED,this._doLayoutDirty,this),n.on(Wb.TRANSFORM_CHANGED,this._transformDirty,this),n.on(Wb.ANCHOR_CHANGED,this._doLayoutDirty,this),n.on(Wb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._removeChildrenEventListeners=function(){for(var e=this.node.children,t=0;t<e.length;++t){var n=e[t];n.off(Wb.SIZE_CHANGED,this._doLayoutDirty,this),n.off(Wb.TRANSFORM_CHANGED,this._transformDirty,this),n.off(Wb.ANCHOR_CHANGED,this._doLayoutDirty,this),n.off(Wb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this)}},n._childAdded=function(e){e.on(Wb.SIZE_CHANGED,this._doLayoutDirty,this),e.on(Wb.TRANSFORM_CHANGED,this._transformDirty,this),e.on(Wb.ANCHOR_CHANGED,this._doLayoutDirty,this),e.on(Wb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._childRemoved=function(e){e.off(Wb.SIZE_CHANGED,this._doLayoutDirty,this),e.off(Wb.TRANSFORM_CHANGED,this._transformDirty,this),e.off(Wb.ANCHOR_CHANGED,this._doLayoutDirty,this),e.off(Wb.ACTIVE_IN_HIERARCHY_CHANGED,this._childrenChanged,this),this._childrenChanged()},n._resized=function(){this._layoutSize.set(this.node._uiProps.uiTransformComp.contentSize),this._doLayoutDirty()},n._doLayoutHorizontally=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingLeft;this._horizontalDirection===Uwe.RIGHT_TO_LEFT&&(a=-1,s=this._paddingRight);var c=(this._horizontalDirection-r.x)*e+a*s,l=c-a*this._spacingX,u=0,h=0,f=0,_=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.width,v=this._getPaddingH();this._layoutType!==Lwe.GRID&&this._resizeMode===Bwe.CHILDREN&&(m=(e-v-(d-1)*this._spacingX)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,b=this._getUsedScaleValue(T.x),E=this._getUsedScaleValue(T.y);this._resizeMode===Bwe.CHILDREN&&(x.width=m/b,this._layoutType===Lwe.GRID&&(x.height=this._cellSize.height/E));var C=Math.abs(this._horizontalDirection-x.anchorX),A=x.width*b,w=x.height*E;w>f&&(_=Math.max(f,_),h=f||w,f=w),l+=a*(C*A+this._spacingX);var P=a*(1-C)*A;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(h=f>w?f:h);else if(A>e-v)l>c+a*C*A&&(p=!0);else{var R=(1-this._horizontalDirection-r.x)*e,I=l+P+a*(a>0?this._paddingRight:this._paddingLeft);p=Math.abs(I)>Math.abs(R)}p&&(l=c+a*C*A,w!==f&&(h=f),u+=h+this._spacingY,h=f=w)}var D=n(S,x,u);i&&S.setPosition(l,D),l+=P}return h=Math.max(h,f),Math.max(_,u+h)+this._getPaddingV()},n._doLayoutVertically=function(e,t,n,i){var r=this.node._uiProps.uiTransformComp.anchorPoint,o=this._getFixedBreakingNum(),a=1,s=this._paddingBottom;this._verticalDirection===zwe.TOP_TO_BOTTOM&&(a=-1,s=this._paddingTop);var c=(this._verticalDirection-r.y)*e+a*s,l=c-a*this._spacingY,u=0,h=0,f=0,_=0,p=!1,d=this._usefulLayoutObj.length,m=this._cellSize.height,v=this._getPaddingV();this._layoutType!==Lwe.GRID&&this._resizeMode===Bwe.CHILDREN&&(m=(e-v-(d-1)*this._spacingY)/d);for(var g=this._usefulLayoutObj,y=0;y<g.length;++y){var x=g[y],S=x.node,T=S.scale,b=this._getUsedScaleValue(T.x),E=this._getUsedScaleValue(T.y);this._resizeMode===Bwe.CHILDREN&&(x.height=m/E,this._layoutType===Lwe.GRID&&(x.width=this._cellSize.width/b));var C=Math.abs(this._verticalDirection-x.anchorY),A=x.width*b,w=x.height*E;A>u&&(h=Math.max(u,h),f=u||A,u=A),l+=a*(C*w+this._spacingY);var P=a*(1-C)*w;if(t){if(o>0)(p=y/o>0&&y%o==0)&&(f=u>w?u:f);else if(w>e-v)l>c+a*C*w&&(p=!0);else{var R=(1-this._verticalDirection-r.y)*e,I=l+P+a*(a>0?this._paddingTop:this._paddingBottom);p=Math.abs(I)>Math.abs(R)}p&&(l=c+a*C*w,A!==u&&(f=u),_+=f+this._spacingX,f=u=A)}var D=n(S,x,_);i&&(S.getPosition(hPe),S.setPosition(D,l,hPe.z)),l+=P}return f=Math.max(f,u),Math.max(h,_+f)+this._getPaddingH()},n._doLayoutGridAxisHorizontal=function(e,t){var n=this,i=t.width,r=1,o=-e.y*t.height,a=this._paddingBottom;this._verticalDirection===zwe.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*t.height,a=this._paddingTop);var s=function(e,t,i){return o+r*(i+(1-t.anchorY)*t.height*n._getUsedScaleValue(e.scale.y)+a)},c=0;this._resizeMode===Bwe.CONTAINER&&(c=this._doLayoutHorizontally(i,!0,s,!1),o=-e.y*c,this._verticalDirection===zwe.TOP_TO_BOTTOM&&(r=-1,o=(1-e.y)*c)),this._doLayoutHorizontally(i,!0,s,!0),this._resizeMode===Bwe.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(i,c)},n._doLayoutGridAxisVertical=function(e,t){var n=this,i=t.height,r=1,o=-e.x*t.width,a=this._paddingLeft;this._horizontalDirection===Uwe.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*t.width,a=this._paddingRight);var s=function(e,t,i){return o+r*(i+(1-t.anchorX)*t.width*n._getUsedScaleValue(e.scale.x)+a)},c=0;this._resizeMode===Bwe.CONTAINER&&(c=this._doLayoutVertically(i,!0,s,!1),o=-e.x*c,this._horizontalDirection===Uwe.RIGHT_TO_LEFT&&(r=-1,o=(1-e.x)*c)),this._doLayoutVertically(i,!0,s,!0),this._resizeMode===Bwe.CONTAINER&&this.node._uiProps.uiTransformComp.setContentSize(c,i)},n._doLayoutGrid=function(){var e=this.node._uiProps.uiTransformComp,t=e.anchorPoint,n=e.contentSize;this.startAxis===Fwe.HORIZONTAL?this._doLayoutGridAxisHorizontal(t,n):this.startAxis===Fwe.VERTICAL&&this._doLayoutGridAxisVertical(t,n)},n._getHorizontalBaseWidth=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Bwe.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.width*this._getUsedScaleValue(o.x)}t+=(n-1)*this._spacingX+this._getPaddingH()}else t=this.node._uiProps.uiTransformComp.width;return t},n._getVerticalBaseHeight=function(){var e=this._usefulLayoutObj,t=0,n=e.length;if(this._resizeMode===Bwe.CONTAINER){for(var i=0;i<e.length;++i){var r=e[i],o=r.node.scale;t+=r.height*this._getUsedScaleValue(o.y)}t+=(n-1)*this._spacingY+this._getPaddingV()}else t=this.node._uiProps.uiTransformComp.height;return t},n._doLayout=function(){var e=this;if(this._init&&!this._childrenDirty||(this._checkUsefulObj(),this._init=!0,this._childrenDirty=!1),this._layoutType===Lwe.HORIZONTAL){var t=this._getHorizontalBaseWidth();this._doLayoutHorizontally(t,!1,(function(t){return(e._isAlign?In.ZERO:t.position).y}),!0),this.node._uiProps.uiTransformComp.width=t}else if(this._layoutType===Lwe.VERTICAL){var n=this._getVerticalBaseHeight();this._doLayoutVertically(n,!1,(function(t){return(e._isAlign?In.ZERO:t.position).x}),!0),this.node._uiProps.uiTransformComp.height=n}else this._layoutType===Lwe.GRID&&this._doLayoutGrid()},n._getUsedScaleValue=function(e){return this._affectedByScale?Math.abs(e):1},n._transformDirty=function(e){e&oy.SCALE&&e&oy.POSITION&&this._affectedByScale&&this._doLayoutDirty()},n._doLayoutDirty=function(){this._layoutDirty=!0},n._childrenChanged=function(){this._childrenDirty=!0,this._doLayoutDirty()},n._getPaddingH=function(){return this._paddingLeft+this._paddingRight},n._getPaddingV=function(){return this._paddingTop+this._paddingBottom},n._getFixedBreakingNum=function(){if(this._layoutType!==Lwe.GRID||this._constraint===kwe.NONE||this._constraintNum<=0)return 0;var e=this._constraint===kwe.FIXED_ROW?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum;return this._startAxis===Fwe.VERTICAL&&(e=this._constraint===kwe.FIXED_COL?Math.ceil(this._usefulLayoutObj.length/this._constraintNum):this._constraintNum),e},Z(t,[{key:"alignHorizontal",get:function(){return this._isAlign},set:function(e){this._layoutType===Lwe.HORIZONTAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"alignVertical",get:function(){return this._isAlign},set:function(e){this._layoutType===Lwe.VERTICAL&&(this._isAlign=e,this._doLayoutDirty())}},{key:"type",get:function(){return this._layoutType},set:function(e){this._layoutType=e,this._doLayoutDirty()}},{key:"resizeMode",get:function(){return this._resizeMode},set:function(e){this._layoutType!==Lwe.NONE&&(this._resizeMode=e,this._doLayoutDirty())}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize.set(e),this._doLayoutDirty())}},{key:"startAxis",get:function(){return this._startAxis},set:function(e){this._startAxis!==e&&(this._startAxis=e,this._doLayoutDirty())}},{key:"paddingLeft",get:function(){return this._paddingLeft},set:function(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._doLayoutDirty())}},{key:"paddingRight",get:function(){return this._paddingRight},set:function(e){this._paddingRight!==e&&(this._paddingRight=e,this._doLayoutDirty())}},{key:"paddingTop",get:function(){return this._paddingTop},set:function(e){this._paddingTop!==e&&(this._paddingTop=e,this._doLayoutDirty())}},{key:"paddingBottom",get:function(){return this._paddingBottom},set:function(e){this._paddingBottom!==e&&(this._paddingBottom=e,this._doLayoutDirty())}},{key:"spacingX",get:function(){return this._spacingX},set:function(e){this._spacingX!==e&&(this._spacingX=e,this._doLayoutDirty())}},{key:"spacingY",get:function(){return this._spacingY},set:function(e){this._spacingY!==e&&(this._spacingY=e,this._doLayoutDirty())}},{key:"verticalDirection",get:function(){return this._verticalDirection},set:function(e){this._verticalDirection!==e&&(this._verticalDirection=e,this._doLayoutDirty())}},{key:"horizontalDirection",get:function(){return this._horizontalDirection},set:function(e){this._horizontalDirection!==e&&(this._horizontalDirection=e,this._doLayoutDirty())}},{key:"padding",get:function(){return this._paddingLeft},set:function(e){this.paddingLeft===e&&this._paddingRight===e&&this._paddingTop===e&&this._paddingBottom===e||(this._paddingLeft=this._paddingRight=this._paddingTop=this._paddingBottom=e,this._doLayoutDirty())}},{key:"constraint",get:function(){return this._constraint},set:function(e){this._layoutType!==Lwe.NONE&&this._constraint!==e&&(this._constraint=e,this._doLayoutDirty())}},{key:"constraintNum",get:function(){return this._constraintNum},set:function(e){this._constraint!==kwe.NONE&&this._constraintNum!==e&&(e<=0&&S("Limit values to be greater than 0"),this._constraintNum=e,this._doLayoutDirty())}},{key:"affectedByScale",get:function(){return this._affectedByScale},set:function(e){this._affectedByScale=e,this._doLayoutDirty()}}]),t}(th),Mwe.Type=Lwe,Mwe.VerticalDirection=zwe,Mwe.HorizontalDirection=Uwe,Mwe.ResizeMode=Bwe,Mwe.AxisDirection=Fwe,Mwe.Constraint=kwe,le((mwe=Nwe).prototype,"alignHorizontal",[UAe,kAe],Object.getOwnPropertyDescriptor(mwe.prototype,"alignHorizontal"),mwe.prototype),le(mwe.prototype,"alignVertical",[GAe,HAe],Object.getOwnPropertyDescriptor(mwe.prototype,"alignVertical"),mwe.prototype),le(mwe.prototype,"type",[VAe,WAe,jAe],Object.getOwnPropertyDescriptor(mwe.prototype,"type"),mwe.prototype),le(mwe.prototype,"resizeMode",[qAe,XAe,YAe],Object.getOwnPropertyDescriptor(mwe.prototype,"resizeMode"),mwe.prototype),le(mwe.prototype,"cellSize",[KAe,QAe],Object.getOwnPropertyDescriptor(mwe.prototype,"cellSize"),mwe.prototype),le(mwe.prototype,"startAxis",[ZAe,JAe],Object.getOwnPropertyDescriptor(mwe.prototype,"startAxis"),mwe.prototype),le(mwe.prototype,"paddingLeft",[$Ae],Object.getOwnPropertyDescriptor(mwe.prototype,"paddingLeft"),mwe.prototype),le(mwe.prototype,"paddingRight",[ewe],Object.getOwnPropertyDescriptor(mwe.prototype,"paddingRight"),mwe.prototype),le(mwe.prototype,"paddingTop",[twe],Object.getOwnPropertyDescriptor(mwe.prototype,"paddingTop"),mwe.prototype),le(mwe.prototype,"paddingBottom",[nwe],Object.getOwnPropertyDescriptor(mwe.prototype,"paddingBottom"),mwe.prototype),le(mwe.prototype,"spacingX",[iwe],Object.getOwnPropertyDescriptor(mwe.prototype,"spacingX"),mwe.prototype),le(mwe.prototype,"spacingY",[rwe],Object.getOwnPropertyDescriptor(mwe.prototype,"spacingY"),mwe.prototype),le(mwe.prototype,"verticalDirection",[owe,awe],Object.getOwnPropertyDescriptor(mwe.prototype,"verticalDirection"),mwe.prototype),le(mwe.prototype,"horizontalDirection",[swe,cwe],Object.getOwnPropertyDescriptor(mwe.prototype,"horizontalDirection"),mwe.prototype),le(mwe.prototype,"constraint",[lwe,uwe,hwe],Object.getOwnPropertyDescriptor(mwe.prototype,"constraint"),mwe.prototype),le(mwe.prototype,"constraintNum",[fwe,_we],Object.getOwnPropertyDescriptor(mwe.prototype,"constraintNum"),mwe.prototype),le(mwe.prototype,"affectedByScale",[pwe],Object.getOwnPropertyDescriptor(mwe.prototype,"affectedByScale"),mwe.prototype),vwe=le(mwe.prototype,"_resizeMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Bwe.NONE}}),gwe=le(mwe.prototype,"_layoutType",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Lwe.NONE}}),ywe=le(mwe.prototype,"_cellSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(40,40)}}),xwe=le(mwe.prototype,"_startAxis",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Fwe.HORIZONTAL}}),Swe=le(mwe.prototype,"_paddingLeft",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Twe=le(mwe.prototype,"_paddingRight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),bwe=le(mwe.prototype,"_paddingTop",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Ewe=le(mwe.prototype,"_paddingBottom",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Cwe=le(mwe.prototype,"_spacingX",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),Awe=le(mwe.prototype,"_spacingY",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wwe=le(mwe.prototype,"_verticalDirection",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zwe.TOP_TO_BOTTOM}}),Pwe=le(mwe.prototype,"_horizontalDirection",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return Uwe.LEFT_TO_RIGHT}}),Rwe=le(mwe.prototype,"_constraint",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return kwe.NONE}}),Iwe=le(mwe.prototype,"_constraintNum",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 2}}),Dwe=le(mwe.prototype,"_affectedByScale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),Owe=le(mwe.prototype,"_isAlign",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),dwe=mwe))||dwe)||dwe)||dwe)||dwe)||dwe)||dwe));u.Layout=fPe,function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL",e[e.FILLED=2]="FILLED"}(uPe||(uPe={})),st(uPe);var _Pe,pPe,dPe,mPe,vPe,gPe,yPe,xPe,SPe,TPe,bPe,EPe,CPe,APe,wPe,PPe,RPe,IPe,DPe,OPe,MPe,NPe,LPe,BPe,FPe=function(t){return e({ProgressBar:t,ProgressBarComponent:t}),t}((Hwe=mc("cc.ProgressBar"),Vwe=Oc(),Wwe=gc(110),jwe=Pc(),qwe=vc(RX),Xwe=Zc(nJ),Ywe=Fc(),Kwe=Zc(uPe),Qwe=Fc(),Zwe=Fc(),Jwe=zc(),$we=Fc(),ePe=Fc(),Hwe(tPe=Vwe(tPe=Wwe(tPe=jwe(tPe=qwe((lPe=cPe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_barSprite",iPe,oe(t)),ce(t,"_mode",rPe,oe(t)),ce(t,"_totalLength",oPe,oe(t)),ce(t,"_progress",aPe,oe(t)),ce(t,"_reverse",sPe,oe(t)),t}$(t,e);var n=t.prototype;return n._initBarSprite=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=e._uiProps.uiTransformComp.contentSize;if(this._barSprite.fillType===nJ.FillType.RADIAL&&(this._mode=uPe.FILLED),this._mode===uPe.HORIZONTAL?this.totalLength=r.width:this._mode===uPe.VERTICAL?this.totalLength=r.height:this.totalLength=this._barSprite.fillRange,e.parent===this.node){var o=-n.width*i.x;e.setPosition(o,0,0)}}},n._updateBarStatus=function(){if(this._barSprite){var e=this._barSprite.node;if(!e)return;var t=e._uiProps.uiTransformComp,n=t.anchorPoint,i=t.contentSize,r=e.getPosition(),o=new Kn(0,.5),a=un(this._progress),s=this._totalLength*a,c=i,l=0,u=0;switch(this._mode){case uPe.HORIZONTAL:this._reverse&&(o=new Kn(1,.5)),c=new ni(s,i.height),l=this._totalLength,u=i.height;break;case uPe.VERTICAL:o=this._reverse?new Kn(.5,1):new Kn(.5,0),c=new ni(i.width,s),l=i.width,u=this._totalLength}if(this._mode===uPe.FILLED)this._barSprite.type!==nJ.Type.FILLED?S("ProgressBar FILLED mode only works when barSprite's Type is FILLED!"):(this._reverse&&(s*=-1),this._barSprite.fillRange=s);else if(this._barSprite.type!==nJ.Type.FILLED){var h=o.x-n.x,f=o.y-n.y,_=new In(l*h,u*f,0);e.setPosition(r.x+_.x,r.y+_.y,r.z),t.setAnchorPoint(o),t.setContentSize(c)}else S("ProgressBar non-FILLED mode only works when barSprite's Type is non-FILLED!")}},Z(t,[{key:"barSprite",get:function(){return this._barSprite},set:function(e){this._barSprite!==e&&(this._barSprite=e,this._initBarSprite())}},{key:"mode",get:function(){return this._mode},set:function(e){if(this._mode!==e&&(this._mode=e,this._barSprite)){var t=this._barSprite.node;if(!t)return;var n=t._uiProps.uiTransformComp.contentSize;this._mode===uPe.HORIZONTAL?this.totalLength=n.width:this._mode===uPe.VERTICAL?this.totalLength=n.height:this._mode===uPe.FILLED&&(this.totalLength=this._barSprite.fillRange)}}},{key:"totalLength",get:function(){return this._totalLength},set:function(e){this._mode===uPe.FILLED&&(e=un(e)),this._totalLength=e,this._updateBarStatus()}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateBarStatus())}},{key:"reverse",get:function(){return this._reverse},set:function(e){this._reverse!==e&&(this._reverse=e,this._barSprite&&(this._barSprite.fillStart=1-this._barSprite.fillStart),this._updateBarStatus())}}]),t}(th),cPe.Mode=uPe,le((nPe=lPe).prototype,"barSprite",[Xwe,Ywe],Object.getOwnPropertyDescriptor(nPe.prototype,"barSprite"),nPe.prototype),le(nPe.prototype,"mode",[Kwe,Qwe],Object.getOwnPropertyDescriptor(nPe.prototype,"mode"),nPe.prototype),le(nPe.prototype,"totalLength",[Zwe],Object.getOwnPropertyDescriptor(nPe.prototype,"totalLength"),nPe.prototype),le(nPe.prototype,"progress",[Jwe,Hc,$we],Object.getOwnPropertyDescriptor(nPe.prototype,"progress"),nPe.prototype),le(nPe.prototype,"reverse",[ePe],Object.getOwnPropertyDescriptor(nPe.prototype,"reverse"),nPe.prototype),iPe=le(nPe.prototype,"_barSprite",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),rPe=le(nPe.prototype,"_mode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return uPe.HORIZONTAL}}),oPe=le(nPe.prototype,"_totalLength",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),aPe=le(nPe.prototype,"_progress",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),sPe=le(nPe.prototype,"_reverse",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),tPe=nPe))||tPe)||tPe)||tPe)||tPe)||tPe));u.ProgressBar=FPe;var zPe,UPe=new In,kPe=new In,GPe=new In,HPe=new Kn,VPe=new Pn,WPe=new Kn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(zPe||(zPe={})),ut(zPe);var jPe,qPe=function(t){return e({ScrollBar:t,ScrollBarComponent:t}),t}((_Pe=mc("cc.ScrollBar"),pPe=Oc(),dPe=gc(110),mPe=Pc(),vPe=vc(RX),gPe=Zc(nJ),yPe=Vc(),xPe=Fc(),SPe=Zc(zPe),TPe=Vc(),bPe=Fc(),EPe=Vc(),CPe=Fc(),APe=Vc(),wPe=Fc(),_Pe(PPe=pPe(PPe=dPe(PPe=mPe(PPe=vPe((BPe=LPe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_scrollView",IPe,oe(t)),ce(t,"_handle",DPe,oe(t)),ce(t,"_direction",OPe,oe(t)),ce(t,"_enableAutoHide",MPe,oe(t)),ce(t,"_autoHideTime",NPe,oe(t)),t._touching=!1,t._opacity=255,t._autoHideRemainingTime=0,t}$(t,e);var n=t.prototype;return n.hide=function(){this._autoHideRemainingTime=0,this._setOpacity(0)},n.show=function(){this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity)},n.onScroll=function(e){if(this._scrollView){var t=this._scrollView.content;if(t){var n=t._uiProps.uiTransformComp.contentSize,i=this._scrollView.node._uiProps.uiTransformComp.contentSize,r=this.node._uiProps.uiTransformComp.contentSize;if(!this._conditionalDisableScrollBar(n,i)){this._enableAutoHide&&(this._autoHideRemainingTime=this._autoHideTime,this._setOpacity(this._opacity));var o=0,a=0,s=0,c=0,l=0,u=WPe;u.set(0,0),this._direction===zPe.HORIZONTAL?(o=n.width,a=i.width,l=r.width,s=e.x,this._convertToScrollViewSpace(u,t),c=-u.x):this._direction===zPe.VERTICAL&&(o=n.height,a=i.height,l=r.height,s=e.y,this._convertToScrollViewSpace(u,t),c=-u.y);var h=this._calculateLength(o,a,l,s),f=WPe;this._calculatePosition(f,o,a,l,c,s,h),this._updateLength(h),this._updateHandlerPosition(f)}}}},n.setScrollView=function(e){this._scrollView=e},n.onTouchBegan=function(){this._enableAutoHide&&(this._touching=!0)},n.onTouchEnded=function(){if(this._enableAutoHide&&(this._touching=!1,!(this._autoHideTime<=0))){if(this._scrollView){var e=this._scrollView.content;if(e){var t=e._uiProps.uiTransformComp.contentSize,n=this._scrollView.node._uiProps.uiTransformComp.contentSize;if(this._conditionalDisableScrollBar(t,n))return}}this._autoHideRemainingTime=this._autoHideTime}},n.onEnable=function(){var e=this.node.getComponent(nJ);e&&(this._opacity=e.color.a)},n.start=function(){this._enableAutoHide&&this._setOpacity(0)},n.update=function(e){this._processAutoHide(e)},n._convertToScrollViewSpace=function(e,t){var n=this._scrollView&&this._scrollView.node._uiProps.uiTransformComp,i=t._uiProps.uiTransformComp;if(n&&i){UPe.set(-i.anchorX*i.width,-i.anchorY*i.height,0),i.convertToWorldSpaceAR(UPe,kPe);var r=n.convertToNodeSpaceAR(kPe);r.x+=n.anchorX*n.width,r.y+=n.anchorY*n.height,e.set(r.x,r.y)}else e.set(Kn.ZERO)},n._setOpacity=function(e){if(this._handle){var t=this.node.getComponent(nJ);t&&(VPe.set(t.color),VPe.a=e,t.color=VPe),(t=this._handle.getComponent(nJ))&&(VPe.set(t.color),VPe.a=e,t.color=VPe)}},n._updateHandlerPosition=function(e){if(this._handle){var t=GPe;this._fixupHandlerPosition(t),this._handle.node.setPosition(e.x+t.x,e.y+t.y,t.z)}},n._fixupHandlerPosition=function(e){var t=this.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint,r=this.handle.node._uiProps.uiTransformComp.contentSize,o=this.handle.node.parent;In.set(UPe,-n.width*i.x,-n.height*i.y,0);var a=this.node._uiProps.uiTransformComp.convertToWorldSpaceAR(UPe,kPe),s=e;s.set(0,0,0),o._uiProps.uiTransformComp.convertToNodeSpaceAR(a,s),this.direction===zPe.HORIZONTAL?s.set(s.x,s.y+(n.height-r.height)/2,s.z):this.direction===zPe.VERTICAL&&s.set(s.x+(n.width-r.width)/2,s.y,s.z),this.handle.node.setPosition(s)},n._conditionalDisableScrollBar=function(e,t){return e.width<=t.width&&this._direction===zPe.HORIZONTAL||e.height<=t.height&&this._direction===zPe.VERTICAL},n._calculateLength=function(e,t,n,i){var r=e;return i&&(r+=20*(i>0?i:-i)),n*(t/r)},n._calculatePosition=function(e,t,n,i,r,o,a){var s=t-n;o&&(s+=Math.abs(o));var c=0;s&&(c=un(c=r/s));var l=(i-a)*c;this._direction===zPe.VERTICAL?e.set(0,l):e.set(l,0)},n._updateLength=function(e){if(this._handle){var t=this._handle.node._uiProps.uiTransformComp,n=t.contentSize,i=t.anchorPoint;i.x===HPe.x&&i.y===HPe.y||t.setAnchorPoint(HPe),this._direction===zPe.HORIZONTAL?t.setContentSize(e,n.height):t.setContentSize(n.width,e)}},n._processAutoHide=function(e){if(this._enableAutoHide&&!(this._autoHideRemainingTime<=0)&&!this._touching&&(this._autoHideRemainingTime-=e,this._autoHideRemainingTime<=this._autoHideTime)){this._autoHideRemainingTime=Math.max(0,this._autoHideRemainingTime);var t=this._opacity*(this._autoHideRemainingTime/this._autoHideTime);this._setOpacity(t)}},Z(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e,this.onScroll(Kn.ZERO))}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this.onScroll(Kn.ZERO))}},{key:"enableAutoHide",get:function(){return this._enableAutoHide},set:function(e){this._enableAutoHide!==e&&(this._enableAutoHide=e,this._enableAutoHide&&this._setOpacity(0))}},{key:"autoHideTime",get:function(){return this._autoHideTime},set:function(e){this._autoHideTime!==e&&(this._autoHideTime=e)}}]),t}(th),LPe.Direction=zPe,le((RPe=BPe).prototype,"handle",[gPe,yPe,xPe],Object.getOwnPropertyDescriptor(RPe.prototype,"handle"),RPe.prototype),le(RPe.prototype,"direction",[SPe,TPe,bPe],Object.getOwnPropertyDescriptor(RPe.prototype,"direction"),RPe.prototype),le(RPe.prototype,"enableAutoHide",[EPe,CPe],Object.getOwnPropertyDescriptor(RPe.prototype,"enableAutoHide"),RPe.prototype),le(RPe.prototype,"autoHideTime",[APe,wPe],Object.getOwnPropertyDescriptor(RPe.prototype,"autoHideTime"),RPe.prototype),IPe=le(RPe.prototype,"_scrollView",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),DPe=le(RPe.prototype,"_handle",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OPe=le(RPe.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return zPe.HORIZONTAL}}),MPe=le(RPe.prototype,"_enableAutoHide",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),NPe=le(RPe.prototype,"_autoHideTime",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),PPe=RPe))||PPe)||PPe)||PPe)||PPe)||PPe));u.ScrollBar=qPe;var XPe,YPe,KPe,QPe,ZPe,JPe,$Pe,eRe,tRe,nRe,iRe,rRe,oRe,aRe,sRe,cRe,lRe,uRe,hRe,fRe,_Re,pRe,dRe,mRe,vRe,gRe,yRe,xRe,SRe,TRe,bRe,ERe,CRe,ARe,wRe,PRe,RRe,IRe,DRe,ORe,MRe,NRe,LRe,BRe,FRe,zRe,URe,kRe,GRe=e("ViewGroup",mc("cc.ViewGroup")(jPe=gc(110)(jPe=function(e){function t(){return e.apply(this,arguments)||this}return $(t,e),t}(th))||jPe)||jPe);u.ViewGroup=GRe;var HRe,VRe=1e-4,WRe=new In,jRe=new In,qRe=new Kn,XRe=new Kn,YRe=function(){return(new Date).getMilliseconds()},KRe={"scroll-to-top":0,"scroll-to-bottom":1,"scroll-to-left":2,"scroll-to-right":3,scrolling:4,"bounce-bottom":6,"bounce-left":7,"bounce-right":8,"bounce-top":5,"scroll-ended":9,"touch-up":10,"scroll-ended-with-threshold":11,"scroll-began":12};!function(e){e.SCROLL_TO_TOP="scroll-to-top",e.SCROLL_TO_BOTTOM="scroll-to-bottom",e.SCROLL_TO_LEFT="scroll-to-left",e.SCROLL_TO_RIGHT="scroll-to-right",e.SCROLL_BEGAN="scroll-began",e.SCROLL_ENDED="scroll-ended",e.BOUNCE_TOP="bounce-top",e.BOUNCE_BOTTOM="bounce-bottom",e.BOUNCE_LEFT="bounce-left",e.BOUNCE_RIGHT="bounce-right",e.SCROLLING="scrolling",e.SCROLL_ENG_WITH_THRESHOLD="scroll-ended-with-threshold",e.TOUCH_UP="touch-up"}(HRe||(HRe={}));var QRe,ZRe,JRe,$Re,eIe,tIe,nIe,iIe,rIe,oIe,aIe,sIe,cIe,lIe,uIe,hIe,fIe,_Ie,pIe,dIe,mIe,vIe=function(t){return e({ScrollView:t,ScrollViewComponent:t}),t}((XPe=mc("cc.ScrollView"),YPe=Oc(),KPe=gc(110),QPe=Pc(),ZPe=vc(RX),JPe=zc(),$Pe=Vc(),eRe=Fc(),tRe=zc(),nRe=Vc(),iRe=Fc(),rRe=Vc(),oRe=Fc(),aRe=Vc(),sRe=Fc(),cRe=Zc(qC),lRe=Vc(),uRe=Fc(),hRe=Vc(),fRe=Fc(),_Re=Zc(qPe),pRe=Vc(),dRe=Fc(),mRe=Vc(),vRe=Fc(),gRe=Zc(qPe),yRe=Vc(),xRe=Fc(),SRe=Vc(),TRe=Fc(),bRe=Zc([kB]),ERe=Vc(),CRe=Fc(),XPe(ARe=YPe(ARe=KPe(ARe=QPe(ARe=ZPe((kRe=URe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"bounceDuration",PRe,oe(t)),ce(t,"brake",RRe,oe(t)),ce(t,"elastic",IRe,oe(t)),ce(t,"inertia",DRe,oe(t)),ce(t,"horizontal",ORe,oe(t)),ce(t,"vertical",MRe,oe(t)),ce(t,"cancelInnerEvents",NRe,oe(t)),ce(t,"scrollEvents",LRe,oe(t)),t._autoScrolling=!1,t._scrolling=!1,ce(t,"_content",BRe,oe(t)),ce(t,"_horizontalScrollBar",FRe,oe(t)),ce(t,"_verticalScrollBar",zRe,oe(t)),t._topBoundary=0,t._bottomBoundary=0,t._leftBoundary=0,t._rightBoundary=0,t._touchMoveDisplacements=[],t._touchMoveTimeDeltas=[],t._touchMovePreviousTimestamp=0,t._touchMoved=!1,t._autoScrollAttenuate=!1,t._autoScrollStartPosition=new In,t._autoScrollTargetDelta=new In,t._autoScrollTotalTime=0,t._autoScrollAccumulatedTime=0,t._autoScrollCurrentlyOutOfBoundary=!1,t._autoScrollBraking=!1,t._autoScrollBrakingStartPosition=new In,t._outOfBoundaryAmount=new In,t._outOfBoundaryAmountDirty=!0,t._stopMouseWheel=!1,t._mouseWheelEventElapsedTime=0,t._isScrollEndedWithThresholdEventFired=!1,t._scrollEventEmitMask=0,t._isBouncing=!1,t._contentPos=new In,t._deltaPos=new In,t}$(t,e);var n=t.prototype;return n.scrollToBottom=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(0,0),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n,!0)},n.scrollToTop=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(0,1),applyToHorizontal:!1,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(0,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(1,0),applyToHorizontal:!0,applyToVertical:!1});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(0,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToTopRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(1,1),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomLeft=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(0,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToBottomRight=function(e,t){void 0===t&&(t=!0);var n=this._calculateMovePercentDelta({anchor:new Kn(1,0),applyToHorizontal:!0,applyToVertical:!0});e?this._startAutoScroll(n,e,!1!==t):this._moveContent(n)},n.scrollToOffset=function(e,t,n){void 0===n&&(n=!0);var i=this.getMaxScrollOffset(),r=new Kn(0,0);0===i.x?r.x=0:r.x=e.x/i.x,0===i.y?r.y=1:r.y=(i.y-e.y)/i.y,this.scrollTo(r,t,n)},n.getScrollOffset=function(){var e=this._getContentTopBoundary()-this._topBoundary,t=this._getContentLeftBoundary()-this._leftBoundary;return new Kn(t,e)},n.getMaxScrollOffset=function(){if(!this._content||!this.view)return Kn.ZERO;var e=this._content._uiProps.uiTransformComp.contentSize,t=e.width-this.view.width,n=e.height-this.view.height;return new Kn(t=t>=0?t:0,n=n>=0?n:0)},n.scrollToPercentHorizontal=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Kn(e,0),applyToHorizontal:!0,applyToVertical:!1});t?this._startAutoScroll(i,t,!1!==n):this._moveContent(i)},n.scrollTo=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Kn(e),applyToHorizontal:!0,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.scrollToPercentVertical=function(e,t,n){var i=this._calculateMovePercentDelta({anchor:new Kn(0,e),applyToHorizontal:!1,applyToVertical:!0});t?this._startAutoScroll(i,t,n):this._moveContent(i)},n.stopAutoScroll=function(){this._autoScrolling=!1,this._autoScrollAccumulatedTime=this._autoScrollTotalTime},n.setContentPosition=function(e){this._setContentPosition(e)},n._setContentPosition=function(e){if(this._content){var t=this._getContentPosition();Math.abs(e.x-t.x)<VRe&&Math.abs(e.y-t.y)<VRe||(this._content.setPosition(e),this._outOfBoundaryAmountDirty=!0)}},n.getContentPosition=function(){return this._getContentPosition()},n._getContentPosition=function(){return this._content?(this._contentPos.set(this._content.position),this._contentPos):In.ZERO.clone()},n.isScrolling=function(){return this._scrolling},n.isAutoScrolling=function(){return this._autoScrolling},n.getScrollEndedEventTiming=function(){return VRe},n.start=function(){this._calculateBoundary(),this._content&&jM.once(WM.EVENT_BEFORE_DRAW,this._adjustContentOutOfBoundary,this)},n.onEnable=function(){this._registerEvent(),this._content&&(this._content.on(Wb.SIZE_CHANGED,this._calculateBoundary,this),this._content.on(Wb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.on(Wb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.on(Wb.SIZE_CHANGED,this._calculateBoundary,this))),this._calculateBoundary(),this._updateScrollBarState()},n.update=function(e){this._autoScrolling&&this._processAutoScrolling(e)},n.onDisable=function(){this._unregisterEvent(),this._content&&(this._content.off(Wb.SIZE_CHANGED,this._calculateBoundary,this),this._content.off(Wb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view&&(this.view.node.off(Wb.TRANSFORM_CHANGED,this._scaleChanged,this),this.view.node.off(Wb.SIZE_CHANGED,this._calculateBoundary,this))),this._hideScrollBar(),this.stopAutoScroll()},n._registerEvent=function(){this.node.on(Wb.TOUCH_START,this._onTouchBegan,this,!0),this.node.on(Wb.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.on(Wb.TOUCH_END,this._onTouchEnded,this,!0),this.node.on(Wb.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.on(Wb.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._unregisterEvent=function(){this.node.off(Wb.TOUCH_START,this._onTouchBegan,this,!0),this.node.off(Wb.TOUCH_MOVE,this._onTouchMoved,this,!0),this.node.off(Wb.TOUCH_END,this._onTouchEnded,this,!0),this.node.off(Wb.TOUCH_CANCEL,this._onTouchCancelled,this,!0),this.node.off(Wb.MOUSE_WHEEL,this._onMouseWheel,this,!0)},n._onMouseWheel=function(e,t){if(this.enabledInHierarchy&&!this._hasNestedViewGroup(e,t)){var n=new In,i=e.getScrollY();this.vertical?n.set(0,-.1*i,0):this.horizontal&&n.set(-.1*i,0,0),this._mouseWheelEventElapsedTime=0,this._processDeltaMove(n),this._stopMouseWheel||(this._handlePressLogic(),this.schedule(this._checkMouseWheel,1/60,NaN,0),this._stopMouseWheel=!0),this._stopPropagationIfTargetIsMe(e)}},n._onTouchBegan=function(e,t){this.enabledInHierarchy&&this._content&&(this._hasNestedViewGroup(e,t)||(this._handlePressLogic(),this._touchMoved=!1,this._stopPropagationIfTargetIsMe(e)))},n._onTouchMoved=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){var n=e.touch;if(this._handleMoveLogic(n),this.cancelInnerEvents){var i=n.getUILocation(qRe);if(i.subtract(n.getUIStartLocation(XRe)),i.length()>7&&!this._touchMoved&&e.target!==this.node){var r=new KI(e.getTouches(),e.bubbles,GA.TOUCH_CANCEL);r.touch=e.touch,r.simulate=!0,e.target.dispatchEvent(r),this._touchMoved=!0}this._stopPropagationIfTargetIsMe(e)}}},n._onTouchEnded=function(e,t){if(this.enabledInHierarchy&&this._content&&e&&!this._hasNestedViewGroup(e,t)){this._dispatchEvent(HRe.TOUCH_UP);var n=e.touch;this._handleReleaseLogic(n),this._touchMoved?e.propagationStopped=!0:this._stopPropagationIfTargetIsMe(e)}},n._onTouchCancelled=function(e,t){if(this.enabledInHierarchy&&this._content&&!this._hasNestedViewGroup(e,t)){if(e&&!e.simulate){var n=e.touch;this._handleReleaseLogic(n)}this._stopPropagationIfTargetIsMe(e)}},n._calculateBoundary=function(){if(this._content&&this.view){var e=this._content.getComponent(fPe);e&&e.enabledInHierarchy&&e.updateLayout();var t=this.view,n=t.width*t.anchorX,i=t.height*t.anchorY;this._leftBoundary=-n,this._bottomBoundary=-i,this._rightBoundary=this._leftBoundary+t.width,this._topBoundary=this._bottomBoundary+t.height,this._moveContentToTopLeft(t.contentSize)}},n._hasNestedViewGroup=function(e,t){if(!e||e.eventPhase!==WI.CAPTURING_PHASE)return!1;if(t)for(var n,i=se(t);!(n=i()).done;){var r=n.value;if(this.node===r)return!(!e.target||!e.target.getComponent(GRe));if(r.getComponent(GRe))return!0}return!1},n._startInertiaScroll=function(e){var t=new In(e);t.multiplyScalar(.7),this._startAttenuatingAutoScroll(t,e)},n._calculateAttenuatedFactor=function(e){return this.brake<=0?1-this.brake:(1-this.brake)*(1/(1+14e-6*e+e*e*8e-9))},n._startAttenuatingAutoScroll=function(e,t){var n=e.clone();if(n.normalize(),this._content&&this.view){var i=this._content._uiProps.uiTransformComp.contentSize,r=this.view.contentSize,o=i.width-r.width,a=i.height-r.height,s=this._calculateAttenuatedFactor(o),c=this._calculateAttenuatedFactor(a);n.x=n.x*o*(1-this.brake)*s,n.y=n.y*a*c*(1-this.brake),n.z=0}var l=e.length(),u=n.length()/l;if(n.add(e),this.brake>0&&u>7){u=Math.sqrt(u);var h=e.clone();h.multiplyScalar(u),n.set(h),n.add(e)}var f=this._calculateAutoScrollTimeByInitialSpeed(t.length());this.brake>0&&u>3&&(f*=u=3),0===this.brake&&u>1&&(f*=u),this._startAutoScroll(n,f,!0)},n._calculateAutoScrollTimeByInitialSpeed=function(e){return Math.sqrt(Math.sqrt(e/5))},n._startAutoScroll=function(e,t,n){void 0===n&&(n=!1);var i=this._flattenVectorByDirection(e);this._autoScrolling=!0,this._autoScrollTargetDelta=i,this._autoScrollAttenuate=n,In.copy(this._autoScrollStartPosition,this._getContentPosition()),this._autoScrollTotalTime=t,this._autoScrollAccumulatedTime=0,this._autoScrollBraking=!1,this._isScrollEndedWithThresholdEventFired=!1,this._autoScrollBrakingStartPosition.set(0,0,0),this._getHowMuchOutOfBoundary().equals(In.ZERO,VRe)||(this._autoScrollCurrentlyOutOfBoundary=!0)},n._calculateTouchMoveVelocity=function(){var e=new In,t=0;if((t=this._touchMoveTimeDeltas.reduce((function(e,t){return e+t}),t))<=0||t>=.5)e.set(In.ZERO);else{var n=new In;n=this._touchMoveDisplacements.reduce((function(e,t){return e.add(t),e}),n),e.set(n.x*(1-this.brake)/t,n.y*(1-this.brake)/t,n.z)}return e},n._flattenVectorByDirection=function(e){var t=e;return t.x=this.horizontal?t.x:0,t.y=this.vertical?t.y:0,t},n._moveContent=function(e,t){var n=this._flattenVectorByDirection(e);WRe.set(this._getContentPosition()),WRe.add(n),WRe.set(Math.round(1e4*WRe.x)*VRe,Math.round(1e4*WRe.y)*VRe,WRe.z),this._setContentPosition(WRe);var i=this._getHowMuchOutOfBoundary();qRe.set(i.x,i.y),this._updateScrollBar(qRe),this.elastic&&t&&this._startBounceBackIfNeeded()},n._getContentLeftBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.x-t.anchorX*t.width},n._getContentRightBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentLeftBoundary()+e.width},n._getContentTopBoundary=function(){if(!this._content)return-1;var e=this._content._uiProps.uiTransformComp;return this._getContentBottomBoundary()+e.height},n._getContentBottomBoundary=function(){if(!this._content)return-1;var e=this._getContentPosition(),t=this._content._uiProps.uiTransformComp;return e.y-t.anchorY*t.height},n._getHowMuchOutOfBoundary=function(e){if((e=e||new In).equals(In.ZERO,VRe)&&!this._outOfBoundaryAmountDirty)return this._outOfBoundaryAmount;var t=new In,n=this._getContentLeftBoundary(),i=this._getContentRightBoundary();n+e.x>this._leftBoundary?t.x=this._leftBoundary-(n+e.x):i+e.x<this._rightBoundary&&(t.x=this._rightBoundary-(i+e.x));var r=this._getContentTopBoundary(),o=this._getContentBottomBoundary();return r+e.y<this._topBoundary?t.y=this._topBoundary-(r+e.y):o+e.y>this._bottomBoundary&&(t.y=this._bottomBoundary-(o+e.y)),e.equals(In.ZERO,VRe)&&(this._outOfBoundaryAmount=t,this._outOfBoundaryAmountDirty=!1),this._clampDelta(t),t},n._updateScrollBar=function(e){this._horizontalScrollBar&&this._horizontalScrollBar.onScroll(e),this.verticalScrollBar&&this.verticalScrollBar.onScroll(e)},n._onScrollBarTouchBegan=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchBegan(),this.verticalScrollBar&&this.verticalScrollBar.onTouchBegan()},n._onScrollBarTouchEnded=function(){this._horizontalScrollBar&&this._horizontalScrollBar.onTouchEnded(),this.verticalScrollBar&&this.verticalScrollBar.onTouchEnded()},n._dispatchEvent=function(e){if(e===HRe.SCROLL_ENDED)this._scrollEventEmitMask=0;else if(e===HRe.SCROLL_TO_TOP||e===HRe.SCROLL_TO_BOTTOM||e===HRe.SCROLL_TO_LEFT||e===HRe.SCROLL_TO_RIGHT){var t=1<<KRe[e];if(this._scrollEventEmitMask&t)return;this._scrollEventEmitMask|=t}kB.emitEvents(this.scrollEvents,this,KRe[e]),this.node.emit(e,this)},n._adjustContentOutOfBoundary=function(){if(this._content&&(this._outOfBoundaryAmountDirty=!0,this._isOutOfBoundary())){var e=this._getHowMuchOutOfBoundary();WRe.set(this._getContentPosition()),WRe.add(e),this._content.setPosition(WRe),this._updateScrollBar(Kn.ZERO)}},n._hideScrollBar=function(){this._horizontalScrollBar&&this._horizontalScrollBar.hide(),this._verticalScrollBar&&this._verticalScrollBar.hide()},n._updateScrollBarState=function(){if(this._content&&this.view){var e=this.view,t=this._content._uiProps.uiTransformComp;this.verticalScrollBar&&(t.height<e.height?this.verticalScrollBar.hide():this.verticalScrollBar.show()),this.horizontalScrollBar&&(t.width<e.width?this.horizontalScrollBar.hide():this.horizontalScrollBar.show())}},n._stopPropagationIfTargetIsMe=function(e){e.eventPhase===WI.AT_TARGET&&e.target===this.node&&(e.propagationStopped=!0)},n._processDeltaMove=function(e){this._scrollChildren(e),this._gatherTouchMove(e)},n._handleMoveLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._processDeltaMove(this._deltaPos)},n._handleReleaseLogic=function(e){this._getLocalAxisAlignDelta(this._deltaPos,e),this._gatherTouchMove(this._deltaPos),this._processInertiaScroll(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(HRe.SCROLL_ENDED))},n._getLocalAxisAlignDelta=function(e,t){var n=this.node._uiProps.uiTransformComp,i=new In;n&&(t.getUILocation(qRe),t.getUIPreviousLocation(XRe),WRe.set(qRe.x,qRe.y,0),jRe.set(XRe.x,XRe.y,0),n.convertToNodeSpaceAR(WRe,WRe),n.convertToNodeSpaceAR(jRe,jRe),In.subtract(i,WRe,jRe)),e.set(i)},n._scrollChildren=function(e){this._clampDelta(e);var t,n=e;this.elastic&&(t=this._getHowMuchOutOfBoundary(),n.x*=0===t.x?1:.5,n.y*=0===t.y?1:.5),this.elastic||(t=this._getHowMuchOutOfBoundary(n),n.add(t));var i="",r="";if(this._content){var o=this._content._uiProps.uiTransformComp,a=o.anchorX,s=o.anchorY,c=o.width,l=o.height,u=this._content.position||In.ZERO;this.vertical&&(n.y>0?u.y-s*l+n.y>=this._bottomBoundary&&(i=HRe.SCROLL_TO_BOTTOM):n.y<0&&u.y-s*l+l+n.y<=this._topBoundary&&(i=HRe.SCROLL_TO_TOP)),this.horizontal&&(n.x<0?u.x-a*c+c+n.x<=this._rightBoundary&&(r=HRe.SCROLL_TO_RIGHT):n.x>0&&u.x-a*c+n.x>=this._leftBoundary&&(r=HRe.SCROLL_TO_LEFT))}this._moveContent(n,!1),(this.horizontal&&0!==n.x||this.vertical&&0!==n.y)&&(this._scrolling||(this._scrolling=!0,this._dispatchEvent(HRe.SCROLL_BEGAN)),this._dispatchEvent(HRe.SCROLLING)),""!==i&&this._dispatchEvent(i),""!==r&&this._dispatchEvent(r)},n._handlePressLogic=function(){this._autoScrolling&&this._dispatchEvent(HRe.SCROLL_ENDED),this._autoScrolling=!1,this._isBouncing=!1,this._touchMovePreviousTimestamp=YRe(),this._touchMoveDisplacements.length=0,this._touchMoveTimeDeltas.length=0,this._onScrollBarTouchBegan()},n._clampDelta=function(e){if(this._content&&this.view){var t=this.view.contentSize,n=this._content._uiProps.uiTransformComp;n.width<t.width&&(e.x=0),n.height<t.height&&(e.y=0)}},n._gatherTouchMove=function(e){var t=e.clone();for(this._clampDelta(t);this._touchMoveDisplacements.length>=5;)this._touchMoveDisplacements.shift(),this._touchMoveTimeDeltas.shift();this._touchMoveDisplacements.push(t);var n=YRe();this._touchMoveTimeDeltas.push((n-this._touchMovePreviousTimestamp)/1e3),this._touchMovePreviousTimestamp=n},n._startBounceBackIfNeeded=function(){if(!this.elastic)return!1;var e=this._getHowMuchOutOfBoundary();if(this._clampDelta(e),e.equals(In.ZERO,VRe))return!1;var t=Math.max(this.bounceDuration,0);return this._startAutoScroll(e,t,!0),this._isBouncing||(e.y>0&&this._dispatchEvent(HRe.BOUNCE_TOP),e.y<0&&this._dispatchEvent(HRe.BOUNCE_BOTTOM),e.x>0&&this._dispatchEvent(HRe.BOUNCE_RIGHT),e.x<0&&this._dispatchEvent(HRe.BOUNCE_LEFT),this._isBouncing=!0),!0},n._processInertiaScroll=function(){if(!this._startBounceBackIfNeeded()&&this.inertia){var e=this._calculateTouchMoveVelocity();!e.equals(WRe,VRe)&&this.brake<1&&this._startInertiaScroll(e)}this._onScrollBarTouchEnded()},n._isOutOfBoundary=function(){return!this._getHowMuchOutOfBoundary().equals(In.ZERO,VRe)},n._isNecessaryAutoScrollBrake=function(){if(this._autoScrollBraking)return!0;if(this._isOutOfBoundary()){if(!this._autoScrollCurrentlyOutOfBoundary)return this._autoScrollCurrentlyOutOfBoundary=!0,this._autoScrollBraking=!0,this._autoScrollBrakingStartPosition=this._getContentPosition(),!0}else this._autoScrollCurrentlyOutOfBoundary=!1;return!1},n._processAutoScrolling=function(e){var t=this._isNecessaryAutoScrollBrake(),n=t?.05:1;this._autoScrollAccumulatedTime+=e*(1/n);var i,r=Math.min(1,this._autoScrollAccumulatedTime/this._autoScrollTotalTime);this._autoScrollAttenuate&&(i=r,r=(i-=1)*i*i*i*i+1);var o=this._autoScrollTargetDelta.clone();o.multiplyScalar(r);var a=this._autoScrollStartPosition.clone();a.add(o);var s=Math.abs(r-1)<=VRe;if(Math.abs(r-1)<=this.getScrollEndedEventTiming()&&!this._isScrollEndedWithThresholdEventFired&&(this._dispatchEvent(HRe.SCROLL_ENG_WITH_THRESHOLD),this._isScrollEndedWithThresholdEventFired=!0),this.elastic){var c=a.clone();c.subtract(this._autoScrollBrakingStartPosition),t&&c.multiplyScalar(n),a.set(this._autoScrollBrakingStartPosition),a.add(c)}else{var l=a.clone();l.subtract(this.getContentPosition());var u=this._getHowMuchOutOfBoundary(l);u.equals(In.ZERO,VRe)||(a.add(u),s=!0)}s&&(this._autoScrolling=!1);var h=a.clone();h.subtract(this._getContentPosition()),this._clampDelta(h),this._moveContent(h,s),this._dispatchEvent(HRe.SCROLLING),this._autoScrolling||(this._isBouncing=!1,this._scrolling=!1,this._dispatchEvent(HRe.SCROLL_ENDED))},n._checkMouseWheel=function(e){if(!this._getHowMuchOutOfBoundary().equals(In.ZERO,VRe))return this._processInertiaScroll(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(HRe.SCROLL_ENDED),void(this._stopMouseWheel=!1);this._mouseWheelEventElapsedTime+=e,this._mouseWheelEventElapsedTime>.1&&(this._onScrollBarTouchEnded(),this.unschedule(this._checkMouseWheel),this._dispatchEvent(HRe.SCROLL_ENDED),this._stopMouseWheel=!1)},n._calculateMovePercentDelta=function(e){var t=e.anchor,n=e.applyToHorizontal,i=e.applyToVertical;this._calculateBoundary(),t.clampf(Kn.ZERO,Kn.ONE);var r=this._getContentBottomBoundary()-this._bottomBoundary;r=-r;var o=this._getContentLeftBoundary()-this._leftBoundary;o=-o;var a=new In;if(this._content&&this.view){var s=0,c=this._content._uiProps.uiTransformComp.contentSize,l=this.view.contentSize;n&&(s=c.width-l.width,a.x=o-s*t.x),i&&(s=c.height-l.height,a.y=r-s*t.y)}return a},n._moveContentToTopLeft=function(e){var t=this._getContentBottomBoundary()-this._bottomBoundary;t=-t;var n=new In,i=0,r=this._getContentLeftBoundary()-this._leftBoundary;if(r=-r,this._content){var o=this._content._uiProps.uiTransformComp.contentSize;o.height<e.height&&(i=o.height-e.height,n.y=t-i),o.width<e.width&&(i=o.width-e.width,n.x=r)}this._updateScrollBarState(),this._moveContent(n),this._adjustContentOutOfBoundary()},n._scaleChanged=function(e){e===oy.SCALE&&this._calculateBoundary()},Z(t,[{key:"content",get:function(){return this._content},set:function(e){if(this._content!==e){var t=e&&e.parent&&e.parent._uiProps.uiTransformComp;!e||e&&t?(this._content=e,this._calculateBoundary()):R(4302)}}},{key:"horizontalScrollBar",get:function(){return this._horizontalScrollBar},set:function(e){this._horizontalScrollBar!==e&&(this._horizontalScrollBar=e,this._horizontalScrollBar&&(this._horizontalScrollBar.setScrollView(this),this._updateScrollBar(Kn.ZERO)))}},{key:"verticalScrollBar",get:function(){return this._verticalScrollBar},set:function(e){this._verticalScrollBar!==e&&(this._verticalScrollBar=e,this._verticalScrollBar&&(this._verticalScrollBar.setScrollView(this),this._updateScrollBar(Kn.ZERO)))}},{key:"view",get:function(){var e=this._content&&this._content.parent;return e?e._uiProps.uiTransformComp:null}}]),t}(GRe),URe.EventType=HRe,PRe=le((wRe=kRe).prototype,"bounceDuration",[Tc,JPe,$Pe,eRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),RRe=le(wRe.prototype,"brake",[Tc,tRe,nRe,iRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),IRe=le(wRe.prototype,"elastic",[Tc,rRe,oRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),DRe=le(wRe.prototype,"inertia",[Tc,aRe,sRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le(wRe.prototype,"content",[cRe,lRe,uRe],Object.getOwnPropertyDescriptor(wRe.prototype,"content"),wRe.prototype),ORe=le(wRe.prototype,"horizontal",[Tc,hRe,fRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le(wRe.prototype,"horizontalScrollBar",[_Re,pRe,dRe],Object.getOwnPropertyDescriptor(wRe.prototype,"horizontalScrollBar"),wRe.prototype),MRe=le(wRe.prototype,"vertical",[Tc,mRe,vRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le(wRe.prototype,"verticalScrollBar",[gRe,yRe,xRe],Object.getOwnPropertyDescriptor(wRe.prototype,"verticalScrollBar"),wRe.prototype),NRe=le(wRe.prototype,"cancelInnerEvents",[Tc,SRe,TRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LRe=le(wRe.prototype,"scrollEvents",[bRe,Tc,ERe,CRe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),BRe=le(wRe.prototype,"_content",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),FRe=le(wRe.prototype,"_horizontalScrollBar",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),zRe=le(wRe.prototype,"_verticalScrollBar",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),ARe=wRe))||ARe)||ARe)||ARe)||ARe)||ARe));u.ScrollView=vIe;var gIe,yIe=new In;!function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(gIe||(gIe={})),ut(gIe);var xIe,SIe,TIe,bIe,EIe,CIe,AIe,wIe,PIe,RIe,IIe,DIe,OIe,MIe,NIe,LIe,BIe,FIe,zIe,UIe,kIe=function(t){return e({Slider:t,SliderComponent:t}),t}((QRe=mc("cc.Slider"),ZRe=Oc(),JRe=gc(110),$Re=Pc(),eIe=vc(RX),tIe=Zc(nJ),nIe=Fc(),iIe=Zc(gIe),rIe=Fc(),oIe=zc(),aIe=Fc(),sIe=Zc([kB]),cIe=Fc(),QRe(lIe=ZRe(lIe=JRe(lIe=$Re(lIe=eIe((mIe=dIe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"slideEvents",hIe,oe(t)),ce(t,"_handle",fIe,oe(t)),ce(t,"_direction",_Ie,oe(t)),ce(t,"_progress",pIe,oe(t)),t._offset=new In,t._dragging=!1,t._touchHandle=!1,t._handleLocalPos=new In,t._touchPos=new In,t}$(t,e);var n=t.prototype;return n.__preload=function(){this._updateHandlePosition()},n.onEnable=function(){this._updateHandlePosition(),this.node.on(Wb.TOUCH_START,this._onTouchBegan,this),this.node.on(Wb.TOUCH_MOVE,this._onTouchMoved,this),this.node.on(Wb.TOUCH_END,this._onTouchEnded,this),this.node.on(Wb.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.on(Wb.TOUCH_START,this._onHandleDragStart,this),this._handle.node.on(Wb.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.on(Wb.TOUCH_END,this._onTouchEnded,this))},n.onDisable=function(){this.node.off(Wb.TOUCH_START,this._onTouchBegan,this),this.node.off(Wb.TOUCH_MOVE,this._onTouchMoved,this),this.node.off(Wb.TOUCH_END,this._onTouchEnded,this),this.node.off(Wb.TOUCH_CANCEL,this._onTouchCancelled,this),this._handle&&this._handle.isValid&&(this._handle.node.off(Wb.TOUCH_START,this._onHandleDragStart,this),this._handle.node.off(Wb.TOUCH_MOVE,this._onTouchMoved,this),this._handle.node.off(Wb.TOUCH_END,this._onTouchEnded,this))},n._onHandleDragStart=function(e){if(e&&this._handle&&this._handle.node._uiProps.uiTransformComp){this._dragging=!0,this._touchHandle=!0;var t=e.touch.getUILocation();In.set(this._touchPos,t.x,t.y,0),this._handle.node._uiProps.uiTransformComp.convertToNodeSpaceAR(this._touchPos,this._offset),e.propagationStopped=!0}},n._onTouchBegan=function(e){this._handle&&e&&(this._dragging=!0,this._touchHandle||this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchMoved=function(e){this._dragging&&e&&(this._handleSliderLogic(e.touch),e.propagationStopped=!0)},n._onTouchEnded=function(e){this._dragging=!1,this._touchHandle=!1,this._offset=new In,e&&(e.propagationStopped=!0)},n._onTouchCancelled=function(e){this._dragging=!1,e&&(e.propagationStopped=!0)},n._handleSliderLogic=function(e){this._updateProgress(e),this._emitSlideEvent()},n._emitSlideEvent=function(){kB.emitEvents(this.slideEvents,this),this.node.emit("slide",this)},n._updateProgress=function(e){if(this._handle&&e){var t=e.getUILocation();In.set(this._touchPos,t.x,t.y,0);var n=this.node._uiProps.uiTransformComp,i=n.convertToNodeSpaceAR(this._touchPos,yIe);this.direction===gIe.Horizontal?this.progress=un(.5+(i.x-this._offset.x)/n.width):this.progress=un(.5+(i.y-this._offset.y)/n.height)}},n._updateHandlePosition=function(){if(this._handle){this._handleLocalPos.set(this._handle.node.getPosition());var e=this.node._uiProps.uiTransformComp;this._direction===gIe.Horizontal?this._handleLocalPos.x=-e.width*e.anchorX+this.progress*e.width:this._handleLocalPos.y=-e.height*e.anchorY+this.progress*e.height,this._handle.node.setPosition(this._handleLocalPos)}},n._changeLayout=function(){var e=this.node._uiProps.uiTransformComp,t=e.contentSize;if(e.setContentSize(t.height,t.width),this._handle){var n=this._handle.node.position;this._direction===gIe.Horizontal?this._handle.node.setPosition(n.x,0,n.z):this._handle.node.setPosition(0,n.y,n.z),this._updateHandlePosition()}},Z(t,[{key:"handle",get:function(){return this._handle},set:function(e){this._handle!==e&&(this._handle=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._changeLayout())}},{key:"progress",get:function(){return this._progress},set:function(e){this._progress!==e&&(this._progress=e,this._updateHandlePosition())}}]),t}(th),dIe.Direction=gIe,le((uIe=mIe).prototype,"handle",[tIe,nIe],Object.getOwnPropertyDescriptor(uIe.prototype,"handle"),uIe.prototype),le(uIe.prototype,"direction",[iIe,rIe],Object.getOwnPropertyDescriptor(uIe.prototype,"direction"),uIe.prototype),le(uIe.prototype,"progress",[Hc,oIe,aIe],Object.getOwnPropertyDescriptor(uIe.prototype,"progress"),uIe.prototype),hIe=le(uIe.prototype,"slideEvents",[sIe,Tc,cIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),fIe=le(uIe.prototype,"_handle",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_Ie=le(uIe.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return gIe.Horizontal}}),pIe=le(uIe.prototype,"_progress",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),lIe=uIe))||lIe)||lIe)||lIe)||lIe)||lIe));function GIe(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return Object.assign.apply(Object,[{}].concat(t))}u.Slider=kIe,function(e){e.TOGGLE="toggle"}(UIe||(UIe={}));var HIe,VIe,WIe,jIe,qIe,XIe,YIe,KIe,QIe,ZIe,JIe,$Ie,eDe=function(t){return e({Toggle:t,ToggleComponent:t}),t}((xIe=mc("cc.Toggle"),SIe=Oc(),TIe=gc(110),bIe=Pc(),EIe=vc(RX),CIe=Vc(),AIe=Fc(),wIe=Zc(nJ),PIe=Vc(),RIe=Fc(),IIe=Zc([kB]),DIe=Fc(),xIe(OIe=SIe(OIe=TIe(OIe=bIe(OIe=EIe((zIe=FIe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"checkEvents",NIe,oe(t)),ce(t,"_isChecked",LIe,oe(t)),ce(t,"_checkMark",BIe,oe(t)),t}$(t,e);var n=t.prototype;return n._internalToggle=function(){this.isChecked=!this.isChecked},n._set=function(e,t){if(void 0===t&&(t=!0),this._isChecked!=e){this._isChecked=e;var n=this._toggleContainer;n&&n.enabled&&this.enabled&&(e||!n.anyTogglesChecked()&&!n.allowSwitchOff)&&(this._isChecked=!0,n.notifyToggleCheck(this,t)),this.playEffect(),t&&this._emitToggleEvents()}},n.playEffect=function(){this._checkMark&&(this._checkMark.node.active=this._isChecked)},n.setIsCheckedWithoutNotify=function(e){this._set(e,!1)},n.onEnable=function(){e.prototype.onEnable.call(this),this.playEffect(),this.node.on(t.EventType.CLICK,this._internalToggle,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(t.EventType.CLICK,this._internalToggle,this)},n.OnDestroy=function(){var e=this._toggleContainer;e&&e.ensureValidState()},n._emitToggleEvents=function(){this.node.emit(t.EventType.TOGGLE,this),this.checkEvents&&kB.emitEvents(this.checkEvents,this)},Z(t,[{key:"isChecked",get:function(){return this._isChecked},set:function(e){this._set(e)}},{key:"checkMark",get:function(){return this._checkMark},set:function(e){this._checkMark!==e&&(this._checkMark=e)}},{key:"_resizeToTarget",set:function(e){e&&this._resizeNodeToTargetNode()}},{key:"_toggleContainer",get:function(){var e=this.node.parent;return u.Node.isNode(e)?e.getComponent("cc.ToggleContainer"):null}}]),t}(dCe),FIe.EventType=GIe(UIe,_Ce),le((MIe=zIe).prototype,"isChecked",[CIe,AIe],Object.getOwnPropertyDescriptor(MIe.prototype,"isChecked"),MIe.prototype),le(MIe.prototype,"checkMark",[wIe,PIe,RIe],Object.getOwnPropertyDescriptor(MIe.prototype,"checkMark"),MIe.prototype),NIe=le(MIe.prototype,"checkEvents",[IIe,Tc,DIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),LIe=le(MIe.prototype,"_isChecked",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),BIe=le(MIe.prototype,"_checkMark",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),OIe=MIe))||OIe)||OIe)||OIe)||OIe)||OIe));u.Toggle=eDe;var tDe,nDe,iDe,rDe,oDe,aDe,sDe,cDe,lDe,uDe,hDe,fDe,_De,pDe,dDe,mDe,vDe,gDe,yDe,xDe,SDe,TDe,bDe,EDe,CDe,ADe,wDe,PDe,RDe,IDe,DDe,ODe,MDe,NDe,LDe,BDe,FDe,zDe,UDe,kDe,GDe,HDe,VDe,WDe,jDe,qDe=function(t){return e({ToggleContainer:t,ToggleContainerComponent:t}),t}((HIe=mc("cc.ToggleContainer"),VIe=Oc(),WIe=gc(110),jIe=Pc(),qIe=Fc(),XIe=Zc([kB]),YIe=Fc(),HIe(KIe=VIe(KIe=WIe(KIe=jIe(KIe=wc(($Ie=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_allowSwitchOff",ZIe,oe(t)),ce(t,"checkEvents",JIe,oe(t)),t}$(t,e);var n=t.prototype;return n.onEnable=function(){this.ensureValidState(),this.node.on(Wb.CHILD_ADDED,this.ensureValidState,this),this.node.on(Wb.CHILD_REMOVED,this.ensureValidState,this)},n.onDisable=function(){this.node.off(Wb.CHILD_ADDED,this.ensureValidState,this),this.node.off(Wb.CHILD_REMOVED,this.ensureValidState,this)},n.activeToggles=function(){return this.toggleItems.filter((function(e){return e.isChecked}))},n.anyTogglesChecked=function(){return!!this.toggleItems.find((function(e){return e.isChecked}))},n.notifyToggleCheck=function(e,t){if(void 0===t&&(t=!0),this.enabledInHierarchy){for(var n=0;n<this.toggleItems.length;n++){var i=this.toggleItems[n];i!==e&&(t?i.isChecked=!1:i.setIsCheckedWithoutNotify(!1))}this.checkEvents&&u.Component.EventHandler.emitEvents(this.checkEvents,e)}},n.ensureValidState=function(){var e=this.toggleItems;if(!this._allowSwitchOff&&!this.anyTogglesChecked()&&0!==e.length){var t=e[0];t.isChecked=!0,this.notifyToggleCheck(t)}var n=this.activeToggles();if(n.length>1)for(var i=n[0],r=0;r<n.length;++r){var o=n[r];o!==i&&(o.isChecked=!1)}},Z(t,[{key:"allowSwitchOff",get:function(){return this._allowSwitchOff},set:function(e){this._allowSwitchOff=e}},{key:"toggleItems",get:function(){return this.node.children.map((function(e){var t=e.getComponent("cc.Toggle");return t&&t.enabled?t:null})).filter(Boolean)}}]),t}(th),ZIe=le((QIe=$Ie).prototype,"_allowSwitchOff",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),le(QIe.prototype,"allowSwitchOff",[qIe],Object.getOwnPropertyDescriptor(QIe.prototype,"allowSwitchOff"),QIe.prototype),JIe=le(QIe.prototype,"checkEvents",[XIe,Tc,YIe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KIe=QIe))||KIe)||KIe)||KIe)||KIe)||KIe));u.ToggleContainer=qDe;var XDe,YDe,KDe=new Kn;function QDe(e){return e instanceof bD?YM:e._uiProps.uiTransformComp?e._uiProps.uiTransformComp.contentSize:ni.ZERO}function ZDe(e,t,n,i){e.parent?KDe.set(e.parent.getScale().x,e.parent.getScale().y):KDe.set(0,0);for(var r=KDe.x,o=KDe.y,a=0,s=0,c=e.parent;;){if(!c)return n.x=n.y=0,void(i.x=i.y=1);var l=c.getPosition();if(a+=l.x,s+=l.y,(c=c.parent)===t)break;c?KDe.set(c.getScale().x,c.getScale().y):KDe.set(0,0);var u=KDe.x,h=KDe.y;a*=u,s*=h,r*=u,o*=h}i.x=0!==r?1/r:1,i.y=0!==o?1/o:1,n.x=-a,n.y=-s}!function(e){e[e.ONCE=0]="ONCE",e[e.ALWAYS=1]="ALWAYS",e[e.ON_WINDOW_RESIZE=2]="ON_WINDOW_RESIZE"}(XDe||(XDe={})),ut(XDe),function(e){e[e.TOP=1]="TOP",e[e.MID=2]="MID",e[e.BOT=4]="BOT",e[e.LEFT=8]="LEFT",e[e.CENTER=16]="CENTER",e[e.RIGHT=32]="RIGHT",e[e.HORIZONTAL=56]="HORIZONTAL",e[e.VERTICAL=7]="VERTICAL"}(YDe||(YDe={}));var JDe,$De,eOe,tOe,nOe,iOe,rOe,oOe,aOe,sOe,cOe,lOe,uOe,hOe,fOe,_Oe,pOe,dOe,mOe,vOe=YDe.TOP|YDe.BOT,gOe=YDe.LEFT|YDe.RIGHT,yOe=function(t){return e({Widget:t,WidgetComponent:t}),t}((tDe=mc("cc.Widget"),nDe=Oc(),iDe=gc(110),rDe=Pc(),oDe=vc(RX),aDe=Zc(qC),sDe=Fc(),cDe=Fc(),lDe=Fc(),uDe=Fc(),hDe=Fc(),fDe=Fc(),_De=Fc(),pDe=Nc(),dDe=Nc(),mDe=Fc(),vDe=Fc(),gDe=Fc(),yDe=Fc(),xDe=Fc(),SDe=Fc(),TDe=Zc(XDe),bDe=Fc(),tDe(EDe=nDe(EDe=iDe(EDe=rDe(EDe=oDe(EDe=wc((jDe=WDe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return(t=e.call.apply(e,[this].concat(i))||this)._lastPos=new In,t._lastSize=new ni,t._dirty=!0,t._hadAlignOnce=!1,ce(t,"_alignFlags",ADe,oe(t)),ce(t,"_target",wDe,oe(t)),ce(t,"_left",PDe,oe(t)),ce(t,"_right",RDe,oe(t)),ce(t,"_top",IDe,oe(t)),ce(t,"_bottom",DDe,oe(t)),ce(t,"_horizontalCenter",ODe,oe(t)),ce(t,"_verticalCenter",MDe,oe(t)),ce(t,"_isAbsLeft",NDe,oe(t)),ce(t,"_isAbsRight",LDe,oe(t)),ce(t,"_isAbsTop",BDe,oe(t)),ce(t,"_isAbsBottom",FDe,oe(t)),ce(t,"_isAbsHorizontalCenter",zDe,oe(t)),ce(t,"_isAbsVerticalCenter",UDe,oe(t)),ce(t,"_originalWidth",kDe,oe(t)),ce(t,"_originalHeight",GDe,oe(t)),ce(t,"_alignMode",HDe,oe(t)),ce(t,"_lockFlags",VDe,oe(t)),t}$(t,e);var n=t.prototype;return n.updateAlignment=function(){u._widgetManager.updateAlignment(this.node)},n._validateTargetInDEV=function(){},n.setDirty=function(){this._recursiveDirty()},n.onEnable=function(){this.node.getPosition(this._lastPos),this._lastSize.set(this.node._uiProps.uiTransformComp.contentSize),u._widgetManager.add(this),this._hadAlignOnce=!1,this._registerEvent(),this._registerTargetEvents()},n.onDisable=function(){u._widgetManager.remove(this),this._unregisterEvent(),this._unregisterTargetEvents()},n.onDestroy=function(){this._removeParentEvent()},n._adjustWidgetToAllowMovingInEditor=function(){},n._adjustWidgetToAllowResizingInEditor=function(){},n._adjustWidgetToAnchorChanged=function(){this.setDirty()},n._adjustTargetToParentChanged=function(e){e&&this._unregisterOldParentEvents(e),this.node.getParent()&&this._registerTargetEvents(),this._setDirtyByMode()},n._registerEvent=function(){this.node.on(Wb.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.on(Wb.SIZE_CHANGED,this._setDirtyByMode,this),this.node.on(Wb.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this),this.node.on(Wb.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._unregisterEvent=function(){this.node.off(Wb.TRANSFORM_CHANGED,this._setDirtyByMode,this),this.node.off(Wb.SIZE_CHANGED,this._setDirtyByMode,this),this.node.off(Wb.ANCHOR_CHANGED,this._adjustWidgetToAnchorChanged,this)},n._removeParentEvent=function(){this.node.off(Wb.PARENT_CHANGED,this._adjustTargetToParentChanged,this)},n._autoChangedValue=function(e,t){if((this._alignFlags&e)>0){var n=this.node.parent&&this.node.parent._uiProps,i=n&&n.uiTransformComp,r=i?i.contentSize:YM;this.isAlignLeft&&e===YDe.LEFT?this._left=t?this._left*r.width:this._left/r.width:this.isAlignRight&&e===YDe.RIGHT?this._right=t?this._right*r.width:this._right/r.width:this.isAlignHorizontalCenter&&e===YDe.CENTER?this._horizontalCenter=t?this._horizontalCenter*r.width:this._horizontalCenter/r.width:this.isAlignTop&&e===YDe.TOP?this._top=t?this._top*r.height:this._top/r.height:this.isAlignBottom&&e===YDe.BOT?this._bottom=t?this._bottom*r.height:this._bottom/r.height:this.isAbsoluteVerticalCenter&&e===YDe.MID&&(this._verticalCenter=this._verticalCenter/r.height),this._recursiveDirty()}},n._registerTargetEvents=function(){var e=this._target||this.node.parent;e&&e.getComponent(RX)&&(e.on(Wb.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.on(Wb.SIZE_CHANGED,this._setDirtyByMode,this),e.on(Wb.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterTargetEvents=function(){var e=this._target||this.node.parent;e&&(e.off(Wb.TRANSFORM_CHANGED,this._setDirtyByMode,this),e.off(Wb.SIZE_CHANGED,this._setDirtyByMode,this),e.off(Wb.ANCHOR_CHANGED,this._setDirtyByMode,this))},n._unregisterOldParentEvents=function(e){var t=this._target||e;t&&(t.off(Wb.TRANSFORM_CHANGED,this._setDirtyByMode,this),t.off(Wb.SIZE_CHANGED,this._setDirtyByMode,this))},n._setDirtyByMode=function(){this.alignMode===XDe.ALWAYS&&this._recursiveDirty()},n._setAlign=function(e,t){if(t!==(this._alignFlags&e)>0){var n=(e&gOe)>0,i=this.node._uiProps.uiTransformComp;t?(this._alignFlags|=e,n?(this.isAlignHorizontalCenter=!1,this.isStretchWidth&&(this._originalWidth=i.width)):(this.isAlignVerticalCenter=!1,this.isStretchHeight&&(this._originalHeight=i.height))):(n?this.isStretchWidth&&(i.width=this._originalWidth):this.isStretchHeight&&(i.height=this._originalHeight),this._alignFlags&=~e)}},n._recursiveDirty=function(){this._dirty||(this._dirty=!0)},Z(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._unregisterTargetEvents(),this._target=e,this._registerTargetEvents(),this._validateTargetInDEV(),this._recursiveDirty())}},{key:"isAlignTop",get:function(){return(this._alignFlags&YDe.TOP)>0},set:function(e){this._setAlign(YDe.TOP,e),this._recursiveDirty()}},{key:"isAlignBottom",get:function(){return(this._alignFlags&YDe.BOT)>0},set:function(e){this._setAlign(YDe.BOT,e),this._recursiveDirty()}},{key:"isAlignLeft",get:function(){return(this._alignFlags&YDe.LEFT)>0},set:function(e){this._setAlign(YDe.LEFT,e),this._recursiveDirty()}},{key:"isAlignRight",get:function(){return(this._alignFlags&YDe.RIGHT)>0},set:function(e){this._setAlign(YDe.RIGHT,e),this._recursiveDirty()}},{key:"isAlignVerticalCenter",get:function(){return(this._alignFlags&YDe.MID)>0},set:function(e){e?(this.isAlignTop=!1,this.isAlignBottom=!1,this._alignFlags|=YDe.MID):this._alignFlags&=~YDe.MID,this._recursiveDirty()}},{key:"isAlignHorizontalCenter",get:function(){return(this._alignFlags&YDe.CENTER)>0},set:function(e){e?(this.isAlignLeft=!1,this.isAlignRight=!1,this._alignFlags|=YDe.CENTER):this._alignFlags&=~YDe.CENTER,this._recursiveDirty()}},{key:"isStretchWidth",get:function(){return(this._alignFlags&gOe)===gOe}},{key:"isStretchHeight",get:function(){return(this._alignFlags&vOe)===vOe}},{key:"top",get:function(){return this._top},set:function(e){this._top=e,this._recursiveDirty()}},{key:"editorTop",get:function(){return this._isAbsTop?this._top:100*this._top},set:function(e){this._top=this._isAbsTop?e:e/100,this._recursiveDirty()}},{key:"bottom",get:function(){return this._bottom},set:function(e){this._bottom=e,this._recursiveDirty()}},{key:"editorBottom",get:function(){return this._isAbsBottom?this._bottom:100*this._bottom},set:function(e){this._bottom=this._isAbsBottom?e:e/100,this._recursiveDirty()}},{key:"left",get:function(){return this._left},set:function(e){this._left=e,this._recursiveDirty()}},{key:"editorLeft",get:function(){return this._isAbsLeft?this._left:100*this._left},set:function(e){this._left=this._isAbsLeft?e:e/100,this._recursiveDirty()}},{key:"right",get:function(){return this._right},set:function(e){this._right=e,this._recursiveDirty()}},{key:"editorRight",get:function(){return this._isAbsRight?this._right:100*this._right},set:function(e){this._right=this._isAbsRight?e:e/100,this._recursiveDirty()}},{key:"horizontalCenter",get:function(){return this._horizontalCenter},set:function(e){this._horizontalCenter=e,this._recursiveDirty()}},{key:"editorHorizontalCenter",get:function(){return this._isAbsHorizontalCenter?this._horizontalCenter:100*this._horizontalCenter},set:function(e){this._horizontalCenter=this._isAbsHorizontalCenter?e:e/100,this._recursiveDirty()}},{key:"verticalCenter",get:function(){return this._verticalCenter},set:function(e){this._verticalCenter=e,this._recursiveDirty()}},{key:"editorVerticalCenter",get:function(){return this._isAbsVerticalCenter?this._verticalCenter:100*this._verticalCenter},set:function(e){this._verticalCenter=this._isAbsVerticalCenter?e:e/100,this._recursiveDirty()}},{key:"isAbsoluteTop",get:function(){return this._isAbsTop},set:function(e){this._isAbsTop!==e&&(this._isAbsTop=e,this._autoChangedValue(YDe.TOP,this._isAbsTop))}},{key:"isAbsoluteBottom",get:function(){return this._isAbsBottom},set:function(e){this._isAbsBottom!==e&&(this._isAbsBottom=e,this._autoChangedValue(YDe.BOT,this._isAbsBottom))}},{key:"isAbsoluteLeft",get:function(){return this._isAbsLeft},set:function(e){this._isAbsLeft!==e&&(this._isAbsLeft=e,this._autoChangedValue(YDe.LEFT,this._isAbsLeft))}},{key:"isAbsoluteRight",get:function(){return this._isAbsRight},set:function(e){this._isAbsRight!==e&&(this._isAbsRight=e,this._autoChangedValue(YDe.RIGHT,this._isAbsRight))}},{key:"isAbsoluteHorizontalCenter",get:function(){return this._isAbsHorizontalCenter},set:function(e){this._isAbsHorizontalCenter!==e&&(this._isAbsHorizontalCenter=e,this._autoChangedValue(YDe.CENTER,this._isAbsHorizontalCenter))}},{key:"isAbsoluteVerticalCenter",get:function(){return this._isAbsVerticalCenter},set:function(e){this._isAbsVerticalCenter!==e&&(this._isAbsVerticalCenter=e,this._autoChangedValue(YDe.MID,this._isAbsVerticalCenter))}},{key:"alignMode",get:function(){return this._alignMode},set:function(e){this._alignMode=e,this._recursiveDirty()}},{key:"alignFlags",get:function(){return this._alignFlags},set:function(e){this._alignFlags!==e&&(this._alignFlags=e,this._recursiveDirty())}}]),t}(th),WDe.AlignMode=XDe,le((CDe=jDe).prototype,"target",[aDe,sDe],Object.getOwnPropertyDescriptor(CDe.prototype,"target"),CDe.prototype),le(CDe.prototype,"isAlignTop",[cDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isAlignTop"),CDe.prototype),le(CDe.prototype,"isAlignBottom",[lDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isAlignBottom"),CDe.prototype),le(CDe.prototype,"isAlignLeft",[uDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isAlignLeft"),CDe.prototype),le(CDe.prototype,"isAlignRight",[hDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isAlignRight"),CDe.prototype),le(CDe.prototype,"isAlignVerticalCenter",[fDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isAlignVerticalCenter"),CDe.prototype),le(CDe.prototype,"isAlignHorizontalCenter",[_De],Object.getOwnPropertyDescriptor(CDe.prototype,"isAlignHorizontalCenter"),CDe.prototype),le(CDe.prototype,"isStretchWidth",[pDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isStretchWidth"),CDe.prototype),le(CDe.prototype,"isStretchHeight",[dDe],Object.getOwnPropertyDescriptor(CDe.prototype,"isStretchHeight"),CDe.prototype),le(CDe.prototype,"top",[mDe],Object.getOwnPropertyDescriptor(CDe.prototype,"top"),CDe.prototype),le(CDe.prototype,"editorTop",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"editorTop"),CDe.prototype),le(CDe.prototype,"bottom",[vDe],Object.getOwnPropertyDescriptor(CDe.prototype,"bottom"),CDe.prototype),le(CDe.prototype,"editorBottom",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"editorBottom"),CDe.prototype),le(CDe.prototype,"left",[gDe],Object.getOwnPropertyDescriptor(CDe.prototype,"left"),CDe.prototype),le(CDe.prototype,"editorLeft",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"editorLeft"),CDe.prototype),le(CDe.prototype,"right",[yDe],Object.getOwnPropertyDescriptor(CDe.prototype,"right"),CDe.prototype),le(CDe.prototype,"editorRight",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"editorRight"),CDe.prototype),le(CDe.prototype,"horizontalCenter",[xDe],Object.getOwnPropertyDescriptor(CDe.prototype,"horizontalCenter"),CDe.prototype),le(CDe.prototype,"editorHorizontalCenter",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"editorHorizontalCenter"),CDe.prototype),le(CDe.prototype,"verticalCenter",[SDe],Object.getOwnPropertyDescriptor(CDe.prototype,"verticalCenter"),CDe.prototype),le(CDe.prototype,"editorVerticalCenter",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"editorVerticalCenter"),CDe.prototype),le(CDe.prototype,"isAbsoluteTop",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"isAbsoluteTop"),CDe.prototype),le(CDe.prototype,"isAbsoluteBottom",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"isAbsoluteBottom"),CDe.prototype),le(CDe.prototype,"isAbsoluteLeft",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"isAbsoluteLeft"),CDe.prototype),le(CDe.prototype,"isAbsoluteRight",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"isAbsoluteRight"),CDe.prototype),le(CDe.prototype,"isAbsoluteHorizontalCenter",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"isAbsoluteHorizontalCenter"),CDe.prototype),le(CDe.prototype,"isAbsoluteVerticalCenter",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"isAbsoluteVerticalCenter"),CDe.prototype),le(CDe.prototype,"alignMode",[TDe,bDe],Object.getOwnPropertyDescriptor(CDe.prototype,"alignMode"),CDe.prototype),le(CDe.prototype,"alignFlags",[Mc],Object.getOwnPropertyDescriptor(CDe.prototype,"alignFlags"),CDe.prototype),ADe=le(CDe.prototype,"_alignFlags",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),wDe=le(CDe.prototype,"_target",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),PDe=le(CDe.prototype,"_left",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),RDe=le(CDe.prototype,"_right",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),IDe=le(CDe.prototype,"_top",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),DDe=le(CDe.prototype,"_bottom",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),ODe=le(CDe.prototype,"_horizontalCenter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),MDe=le(CDe.prototype,"_verticalCenter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),NDe=le(CDe.prototype,"_isAbsLeft",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),LDe=le(CDe.prototype,"_isAbsRight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),BDe=le(CDe.prototype,"_isAbsTop",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),FDe=le(CDe.prototype,"_isAbsBottom",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),zDe=le(CDe.prototype,"_isAbsHorizontalCenter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),UDe=le(CDe.prototype,"_isAbsVerticalCenter",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),kDe=le(CDe.prototype,"_originalWidth",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),GDe=le(CDe.prototype,"_originalHeight",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),HDe=le(CDe.prototype,"_alignMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return XDe.ON_WINDOW_RESIZE}}),VDe=le(CDe.prototype,"_lockFlags",[Tc,Ec],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),EDe=CDe))||EDe)||EDe)||EDe)||EDe)||EDe)||EDe));u.internal.computeInverseTransForTarget=ZDe,u.internal.getReadonlyNodeSize=QDe,u.Widget=yOe;var xOe,SOe=new Pn;!function(e){e[e.HORIZONTAL=0]="HORIZONTAL",e[e.VERTICAL=1]="VERTICAL"}(xOe||(xOe={})),ut(xOe);var TOe,bOe,EOe,COe,AOe,wOe,POe,ROe,IOe,DOe,OOe,MOe,NOe,LOe,BOe,FOe,zOe,UOe,kOe,GOe,HOe,VOe,WOe,jOe,qOe,XOe,YOe,KOe,QOe,ZOe,JOe,$Oe,eMe,tMe,nMe,iMe,rMe,oMe,aMe,sMe,cMe,lMe,uMe,hMe=function(t){return e({PageViewIndicator:t,PageViewIndicatorComponent:t}),t}((JDe=mc("cc.PageViewIndicator"),$De=Oc(),eOe=gc(110),tOe=Pc(),nOe=Zc(nq),iOe=Fc(),rOe=Zc(xOe),oOe=Fc(),aOe=Zc(ni),sOe=Fc(),cOe=Fc(),JDe(lOe=$De(lOe=eOe(lOe=tOe((mOe=dOe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"spacing",hOe,oe(t)),ce(t,"_spriteFrame",fOe,oe(t)),ce(t,"_direction",_Oe,oe(t)),ce(t,"_cellSize",pOe,oe(t)),t._layout=null,t._pageView=null,t._indicators=[],t}$(t,e);var n=t.prototype;return n.onLoad=function(){this._updateLayout()},n.setPageView=function(e){this._pageView=e,this._refresh()},n._updateLayout=function(){this._layout=this.getComponent(fPe),this._layout||(this._layout=this.addComponent(fPe));var e=this._layout;this.direction===xOe.HORIZONTAL?(e.type=fPe.Type.HORIZONTAL,e.spacingX=this.spacing):this.direction===xOe.VERTICAL&&(e.type=fPe.Type.VERTICAL,e.spacingY=this.spacing),e.resizeMode=fPe.ResizeMode.CONTAINER},n._createIndicator=function(){var e=new qC;e.layer=this.node.layer;var t=e.addComponent(nJ);return t.spriteFrame=this.spriteFrame,t.sizeMode=nJ.SizeMode.CUSTOM,e.parent=this.node,e._uiProps.uiTransformComp.setContentSize(this._cellSize),e},n._changedState=function(){var e=this._indicators;if(0!==e.length&&this._pageView){var t=this._pageView.curPageIdx;if(!(t>=e.length)){for(var n=0;n<e.length;++n){var i=e[n];if(i._uiProps.uiComp){var r=i._uiProps.uiComp;SOe.set(r.color),SOe.a=127.5,r.color=SOe}}if(e[t]._uiProps.uiComp){var o=e[t]._uiProps.uiComp;SOe.set(o.color),SOe.a=255,o.color=SOe}}}},n._refresh=function(){if(this._pageView){var e=this._indicators,t=this._pageView.getPages();if(t.length!==e.length){var n=0;if(t.length>e.length)for(n=0;n<t.length;++n)e[n]||(e[n]=this._createIndicator());else for(n=e.length-t.length;n>0;--n){var i=e[n-1];this.node.removeChild(i),e.splice(n-1,1)}this._layout&&this._layout.enabledInHierarchy&&this._layout.updateLayout(),this._changedState()}}},Z(t,[{key:"spriteFrame",get:function(){return this._spriteFrame},set:function(e){this._spriteFrame!==e&&(this._spriteFrame=e)}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e)}},{key:"cellSize",get:function(){return this._cellSize},set:function(e){this._cellSize!==e&&(this._cellSize=e)}}]),t}(th),dOe.Direction=xOe,le((uOe=mOe).prototype,"spriteFrame",[nOe,iOe],Object.getOwnPropertyDescriptor(uOe.prototype,"spriteFrame"),uOe.prototype),le(uOe.prototype,"direction",[rOe,oOe],Object.getOwnPropertyDescriptor(uOe.prototype,"direction"),uOe.prototype),le(uOe.prototype,"cellSize",[aOe,sOe],Object.getOwnPropertyDescriptor(uOe.prototype,"cellSize"),uOe.prototype),hOe=le(uOe.prototype,"spacing",[Tc,cOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),fOe=le(uOe.prototype,"_spriteFrame",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),_Oe=le(uOe.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return xOe.HORIZONTAL}}),pOe=le(uOe.prototype,"_cellSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(20,20)}}),lOe=uOe))||lOe)||lOe)||lOe)||lOe));u.PageViewIndicator=hMe;var fMe,_Me,pMe,dMe=new Kn;!function(e){e[e.Unified=0]="Unified",e[e.Free=1]="Free"}(fMe||(fMe={})),ut(fMe),function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical"}(_Me||(_Me={})),ut(_Me),function(e){e.PAGE_TURNING="page-turning"}(pMe||(pMe={}));var mMe=function(t){return e({PageView:t,PageViewComponent:t}),t}((TOe=mc("cc.PageView"),bOe=Oc(),EOe=gc(110),COe=Pc(),AOe=Zc(fMe),wOe=Fc(),POe=Zc(_Me),ROe=Fc(),IOe=zc(),DOe=Fc(),OOe=zc(),MOe=Fc(),NOe=Zc(hMe),LOe=Fc(),BOe=Fc(),FOe=Zc(qPe),zOe=Nc(),UOe=Zc(qPe),kOe=Nc(),GOe=Nc(),HOe=Nc(),VOe=Nc(),WOe=Zc([kB]),jOe=Nc(),qOe=Fc(),XOe=Zc([kB]),YOe=Fc(),TOe(KOe=bOe(KOe=EOe(KOe=COe((uMe=lMe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"autoPageTurningThreshold",ZOe,oe(t)),ce(t,"horizontal",JOe,oe(t)),ce(t,"vertical",$Oe,oe(t)),ce(t,"cancelInnerEvents",eMe,oe(t)),ce(t,"scrollEvents",tMe,oe(t)),ce(t,"pageTurningSpeed",nMe,oe(t)),ce(t,"pageEvents",iMe,oe(t)),ce(t,"_sizeMode",rMe,oe(t)),ce(t,"_direction",oMe,oe(t)),ce(t,"_scrollThreshold",aMe,oe(t)),ce(t,"_pageTurningEventTiming",sMe,oe(t)),ce(t,"_indicator",cMe,oe(t)),t._curPageIdx=0,t._lastPageIdx=0,t._pages=[],t._initContentPos=new In,t._scrollCenterOffsetX=[],t._scrollCenterOffsetY=[],t._touchBeganPosition=new Kn,t._touchEndPosition=new Kn,t}$(t,e);var n=t.prototype;return n.onEnable=function(){e.prototype.onEnable.call(this),this.node.on(Wb.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.on(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onDisable=function(){e.prototype.onDisable.call(this),this.node.off(Wb.SIZE_CHANGED,this._updateAllPagesSize,this),this.node.off(t.EventType.SCROLL_ENG_WITH_THRESHOLD,this._dispatchPageTurningEvent,this)},n.onLoad=function(){this._initPages(),this.indicator&&this.indicator.setPageView(this)},n.getCurrentPageIndex=function(){return this._curPageIdx},n.setCurrentPageIndex=function(e){this.scrollToPage(e,1)},n.getPages=function(){return this._pages},n.addPage=function(e){e&&-1===this._pages.indexOf(e)&&this.content&&(e._uiProps.uiTransformComp?(this.content.addChild(e),this._pages.push(e),this._updatePageView()):R(4301))},n.insertPage=function(e,t){if(!(t<0)&&e&&-1===this._pages.indexOf(e)&&this.content)if(t>=this._pages.length)this.addPage(e);else{if(!e._uiProps.uiTransformComp)return void R(4301);this._pages.splice(t,0,e),this.content.insertChild(e,t),this._updatePageView()}},n.removePage=function(e){if(e&&this.content){var t=this._pages.indexOf(e);-1!==t?this.removePageAtIndex(t):D(4300,e.name)}},n.removePageAtIndex=function(e){var t=this._pages;if(!(e<0||e>=t.length)){var n=t[e];n&&this.content&&(this.content.removeChild(n),t.splice(e,1),this._updatePageView())}},n.removeAllPages=function(){if(this.content){for(var e=this._pages,t=0,n=e.length;t<n;t++)this.content.removeChild(e[t]);this._pages.length=0,this._updatePageView()}},n.scrollToPage=function(e,t){void 0===t&&(t=.3),e<0||e>=this._pages.length||(this._curPageIdx=e,this.scrollToOffset(this._moveOffsetValue(e),t,!0),this.indicator&&this.indicator._changedState())},n.getScrollEndedEventTiming=function(){return this.pageTurningEventTiming},n._updatePageView=function(){if(this.content){var e=this.content.getComponent(fPe);e&&e.enabled&&e.updateLayout();var t=this._pages.length;this._curPageIdx>=t&&(this._curPageIdx=0===t?0:t-1,this._lastPageIdx=this._curPageIdx);for(var n=this._initContentPos,i=0;i<t;++i){var r=this._pages[i].position;this.direction===_Me.Horizontal?this._scrollCenterOffsetX[i]=Math.abs(n.x+r.x):this._scrollCenterOffsetY[i]=Math.abs(n.y+r.y)}this.indicator&&this.indicator._refresh()}},n._updateAllPagesSize=function(){var e=this.view;if(this.content&&e&&this._sizeMode===fMe.Unified)for(var t=this._pages,n=e.contentSize,i=0,r=t.length;i<r;i++)t[i]._uiProps.uiTransformComp.setContentSize(n)},n._handleReleaseLogic=function(){this._autoScrollToPage(),this._scrolling&&(this._scrolling=!1,this._autoScrolling||this._dispatchEvent(t.EventType.SCROLL_ENDED))},n._onTouchBegan=function(t,n){t.touch.getUILocation(dMe),Kn.set(this._touchBeganPosition,dMe.x,dMe.y),e.prototype._onTouchBegan.call(this,t,n)},n._onTouchMoved=function(t,n){e.prototype._onTouchMoved.call(this,t,n)},n._onTouchEnded=function(t,n){t.touch.getUILocation(dMe),Kn.set(this._touchEndPosition,dMe.x,dMe.y),e.prototype._onTouchEnded.call(this,t,n)},n._onTouchCancelled=function(t,n){t.touch.getUILocation(dMe),Kn.set(this._touchEndPosition,dMe.x,dMe.y),e.prototype._onTouchCancelled.call(this,t,n)},n._onMouseWheel=function(){},n._syncScrollDirection=function(){this.horizontal=this.direction===_Me.Horizontal,this.vertical=this.direction===_Me.Vertical},n._syncSizeMode=function(){var e=this.view;if(this.content&&e){var t=this.content.getComponent(fPe);if(t){if(this._sizeMode===fMe.Free&&this._pages.length>0){var n=this._pages[0]._uiProps.uiTransformComp,i=this._pages[this._pages.length-1]._uiProps.uiTransformComp;this.direction===_Me.Horizontal?(t.paddingLeft=(e.width-n.width)/2,t.paddingRight=(e.width-i.width)/2):this.direction===_Me.Vertical&&(t.paddingTop=(e.height-n.height)/2,t.paddingBottom=(e.height-i.height)/2)}t.updateLayout()}}},n._initPages=function(){if(this.content){this._initContentPos=this.content.position;for(var e=this.content.children,t=0;t<e.length;++t){var n=e[t];this._pages.indexOf(n)>=0||this._pages.push(n)}this._syncScrollDirection(),this._syncSizeMode(),this._updatePageView()}},n._dispatchPageTurningEvent=function(){this._lastPageIdx!==this._curPageIdx&&(this._lastPageIdx=this._curPageIdx,kB.emitEvents(this.pageEvents,this,pMe.PAGE_TURNING),this.node.emit(pMe.PAGE_TURNING,this))},n._isQuicklyScrollable=function(e){if(this.direction===_Me.Horizontal){if(Math.abs(e.x)>this.autoPageTurningThreshold)return!0}else if(this.direction===_Me.Vertical&&Math.abs(e.y)>this.autoPageTurningThreshold)return!0;return!1},n._moveOffsetValue=function(e){var t=new Kn;if(this._sizeMode===fMe.Free)this.direction===_Me.Horizontal?t.x=this._scrollCenterOffsetX[e]:this.direction===_Me.Vertical&&(t.y=this._scrollCenterOffsetY[e]);else{var n=this.view;if(!n)return t;this.direction===_Me.Horizontal?t.x=e*n.width:this.direction===_Me.Vertical&&(t.y=e*n.height)}return t},n._getDragDirection=function(e){return this._direction===_Me.Horizontal?0===e.x?0:e.x>0?1:-1:0===e.y?0:e.y<0?1:-1},n._isScrollable=function(e,t,n){if(this._sizeMode===fMe.Free){var i=0,r=0;if(this.direction===_Me.Horizontal)return i=this._scrollCenterOffsetX[t],r=this._scrollCenterOffsetX[n],Math.abs(e.x)>=Math.abs(i-r)*this.scrollThreshold;if(this.direction===_Me.Vertical)return i=this._scrollCenterOffsetY[t],r=this._scrollCenterOffsetY[n],Math.abs(e.y)>=Math.abs(i-r)*this.scrollThreshold}else{var o=this.view;if(!o)return!1;if(this.direction===_Me.Horizontal)return Math.abs(e.x)>=o.width*this.scrollThreshold;if(this.direction===_Me.Vertical)return Math.abs(e.y)>=o.height*this.scrollThreshold}return!1},n._autoScrollToPage=function(){if(this._startBounceBackIfNeeded()){var e=this._getHowMuchOutOfBoundary();this._clampDelta(e),(e.x>0||e.y<0)&&(this._curPageIdx=0===this._pages.length?0:this._pages.length-1),(e.x<0||e.y>0)&&(this._curPageIdx=0),this.indicator&&this.indicator._changedState()}else{var t=new Kn;Kn.subtract(t,this._touchBeganPosition,this._touchEndPosition);var n=this._curPageIdx,i=n+this._getDragDirection(t),r=this.pageTurningSpeed*Math.abs(n-i);if(i<this._pages.length){if(this._isScrollable(t,n,i))return void this.scrollToPage(i,r);var o=this._calculateTouchMoveVelocity();if(this._isQuicklyScrollable(o))return void this.scrollToPage(i,r)}this.scrollToPage(n,r)}},Z(t,[{key:"sizeMode",get:function(){return this._sizeMode},set:function(e){this._sizeMode!==e&&(this._sizeMode=e,this._syncSizeMode())}},{key:"direction",get:function(){return this._direction},set:function(e){this._direction!==e&&(this._direction=e,this._syncScrollDirection())}},{key:"scrollThreshold",get:function(){return this._scrollThreshold},set:function(e){this._scrollThreshold!==e&&(this._scrollThreshold=e)}},{key:"pageTurningEventTiming",get:function(){return this._pageTurningEventTiming},set:function(e){this._pageTurningEventTiming!==e&&(this._pageTurningEventTiming=e)}},{key:"indicator",get:function(){return this._indicator},set:function(e){this._indicator!==e&&(this._indicator=e,this.indicator&&this.indicator.setPageView(this))}},{key:"curPageIdx",get:function(){return this._curPageIdx}},{key:"verticalScrollBar",get:function(){return e.prototype.verticalScrollBar},set:function(e){this.verticalScrollBar=e}},{key:"horizontalScrollBar",get:function(){return e.prototype.horizontalScrollBar},set:function(e){this.horizontalScrollBar=e}}]),t}(vIe),lMe.SizeMode=fMe,lMe.Direction=_Me,lMe.EventType=GIe(pMe,HRe),le((QOe=uMe).prototype,"sizeMode",[AOe,wOe],Object.getOwnPropertyDescriptor(QOe.prototype,"sizeMode"),QOe.prototype),le(QOe.prototype,"direction",[POe,ROe],Object.getOwnPropertyDescriptor(QOe.prototype,"direction"),QOe.prototype),le(QOe.prototype,"scrollThreshold",[Hc,IOe,DOe],Object.getOwnPropertyDescriptor(QOe.prototype,"scrollThreshold"),QOe.prototype),le(QOe.prototype,"pageTurningEventTiming",[Hc,OOe,MOe],Object.getOwnPropertyDescriptor(QOe.prototype,"pageTurningEventTiming"),QOe.prototype),le(QOe.prototype,"indicator",[NOe,LOe],Object.getOwnPropertyDescriptor(QOe.prototype,"indicator"),QOe.prototype),ZOe=le(QOe.prototype,"autoPageTurningThreshold",[Tc,BOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 100}}),le(QOe.prototype,"verticalScrollBar",[FOe,sl,zOe],Object.getOwnPropertyDescriptor(QOe.prototype,"verticalScrollBar"),QOe.prototype),le(QOe.prototype,"horizontalScrollBar",[UOe,sl,kOe],Object.getOwnPropertyDescriptor(QOe.prototype,"horizontalScrollBar"),QOe.prototype),JOe=le(QOe.prototype,"horizontal",[sl,Tc,GOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),$Oe=le(QOe.prototype,"vertical",[sl,Tc,HOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),eMe=le(QOe.prototype,"cancelInnerEvents",[sl,Tc,VOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tMe=le(QOe.prototype,"scrollEvents",[WOe,Tc,sl,jOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),nMe=le(QOe.prototype,"pageTurningSpeed",[Tc,Mc,qOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.3}}),iMe=le(QOe.prototype,"pageEvents",[XOe,Tc,YOe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),rMe=le(QOe.prototype,"_sizeMode",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return fMe.Unified}}),oMe=le(QOe.prototype,"_direction",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return _Me.Horizontal}}),aMe=le(QOe.prototype,"_scrollThreshold",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.5}}),sMe=le(QOe.prototype,"_pageTurningEventTiming",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return.1}}),cMe=le(QOe.prototype,"_indicator",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),KOe=QOe))||KOe)||KOe)||KOe)||KOe));u.PageView=mMe;var vMe=new In,gMe=new Kn,yMe=new Kn,xMe=new Kn(1,1),SMe=new Kn,TMe=new Kn;function bMe(e,t){if(!t._hadAlignOnce){t.alignMode===XDe.ONCE&&(t._hadAlignOnce=!0);var n,i=t.target,r=yMe,o=xMe;i?ZDe(e,n=i,r,o):n=e.parent;var a=QDe(n),s=n instanceof bD||!n.getComponent(RX),c=s?gMe:n.getComponent(RX).anchorPoint,l=s;e.getPosition(vMe);var u=e._uiProps.uiTransformComp,h=vMe.x,f=vMe.y,_=u.anchorPoint,p=e.getScale();if(t.alignFlags&YDe.HORIZONTAL){var d=0,m=0,v=a.width;l?(d=YM.left.x,m=YM.right.x):m=(d=-c.x*v)+v,d+=t.isAbsoluteLeft?t.left:t.left*v,m-=t.isAbsoluteRight?t.right:t.right*v,i&&(d+=r.x,d*=o.x,m+=r.x,m*=o.x);var g=0,y=_.x,x=p.x;if(x<0&&(y=1-y,x=-x),t.isStretchWidth)g=m-d,0!==x&&(u.width=g/x),h=d+y*g;else if(g=u.width*x,t.isAlignHorizontalCenter){var S=t.isAbsoluteHorizontalCenter?t.horizontalCenter:t.horizontalCenter*v,T=(.5-c.x)*a.width;i&&(S*=o.x,T+=r.x,T*=o.x),h=T+(y-.5)*g+S}else h=t.isAlignLeft?d+y*g:m+(y-1)*g;t._lastSize.width=g}if(t.alignFlags&YDe.VERTICAL){var b=0,E=0,C=a.height;l?(E=YM.bottom.y,b=YM.top.y):b=(E=-c.y*C)+C,E+=t.isAbsoluteBottom?t.bottom:t.bottom*C,b-=t.isAbsoluteTop?t.top:t.top*C,i&&(E+=r.y,E*=o.y,b+=r.y,b*=o.y);var A=0,w=_.y,P=p.y;if(P<0&&(w=1-w,P=-P),t.isStretchHeight)A=b-E,0!==P&&(u.height=A/P),f=E+w*A;else if(A=u.height*P,t.isAlignVerticalCenter){var R=t.isAbsoluteVerticalCenter?t.verticalCenter:t.verticalCenter*C,I=(.5-c.y)*a.height;i&&(R*=o.y,I+=r.y,I*=o.y),f=I+(w-.5)*A+R}else f=t.isAlignBottom?E+w*A:b+(w-1)*A;t._lastSize.height=A}e.setPosition(h,f,vMe.z),In.set(t._lastPos,h,f,vMe.z)}}function EMe(e){var t=e.getComponent(yOe);if(t&&t.enabled){if(!u.isValid(e,!0))return;wMe.push(t)}for(var n,i=se(e.children);!(n=i()).done;){var r=n.value;r.active&&EMe(r)}}function CMe(){var e=jM.getScene();if(e){PMe.isAligning=!0,PMe._nodesOrderDirty&&(wMe.length=0,EMe(e),PMe._nodesOrderDirty=!1);var t=null,n=PMe._activeWidgetsIterator;for(n.i=0;n.i<wMe.length;++n.i)(t=wMe[n.i])._dirty&&(bMe(t.node,t),t._dirty=!1);PMe.isAligning=!1}}var AMe,wMe=[],PMe=e("widgetManager",u._widgetManager={isAligning:!1,_nodesOrderDirty:!1,_activeWidgetsIterator:new it.MutableForwardIterator(wMe),animationState:null,init:function(){jM.on(WM.EVENT_AFTER_SCENE_LAUNCH,CMe),jM.on(WM.EVENT_AFTER_UPDATE,CMe),ZM.instance.on("design-resolution-changed",this.onResized,this);var e=this.onResized.bind(this);ZM.instance.on("canvas-resize",e),ch.on("orientation-change",e)},add:function(){this._nodesOrderDirty=!0},remove:function(e){this._activeWidgetsIterator.remove(e)},onResized:function(){var e=jM.getScene();e&&this.refreshWidgetOnResized(e)},refreshWidgetOnResized:function(e){var t=qC.isNode(e)&&e.getComponent(yOe);t&&t.enabled&&(t.alignMode===XDe.ON_WINDOW_RESIZE||t.alignMode===XDe.ALWAYS)&&t.setDirty();for(var n,i=se(e.children);!(n=i()).done;){var r=n.value;this.refreshWidgetOnResized(r)}},updateOffsetsToStayPut:function(e,t){function n(e,t){return Math.abs(e-t)>1e-10?t:e}var i=e.node,r=i.parent;if(r){var o=SMe;o.set(0,0);var a=TMe;if(a.set(1,1),e.target&&ZDe(i,r=e.target,o,a),!t)return;var s=r._uiProps&&r._uiProps.uiTransformComp,c=s?s.anchorPoint:gMe,l=i._uiProps.uiTransformComp,u=QDe(r),h=l.anchorPoint,f=i.getPosition(),_=YDe,p=i.getScale(),d=0;if(t&_.LEFT){var m=-c.x*u.width;m+=o.x,m*=a.x,d=f.x-h.x*l.width*p.x-m,e.isAbsoluteLeft||(d/=u.width),d/=a.x,e.left=n(e.left,d)}if(t&_.RIGHT){var v=(1-c.x)*u.width;v+=o.x,d=(v*=a.x)-(f.x+(1-h.x)*l.width*p.x),e.isAbsoluteRight||(d/=u.width),d/=a.x,e.right=n(e.right,d)}if(t&_.TOP){var g=(1-c.y)*u.height;g+=o.y,d=(g*=a.y)-(f.y+(1-h.y)*l.height*p.y),e.isAbsoluteTop||(d/=u.height),d/=a.y,e.top=n(e.top,d)}if(t&_.BOT){var y=-c.y*u.height;y+=o.y,y*=a.y,d=f.y-h.y*l.height*p.y-y,e.isAbsoluteBottom||(d/=u.height),d/=a.y,e.bottom=n(e.bottom,d)}}},updateAlignment:function e(t){var n=t.parent;n&&qC.isNode(n)&&e(n);var i=t.getComponent(yOe);i&&n&&bMe(t,i)},AlignMode:XDe,AlignFlags:YDe});jM.on(WM.EVENT_INIT,(function(){PMe.init()}));var RMe,IMe,DMe,OMe,MMe,NMe,LMe,BMe,FMe,zMe,UMe,kMe,GMe,HMe,VMe,WMe,jMe,qMe,XMe,YMe=function(t){return e({SafeArea:t,SafeAreaComponent:t}),t}(mc("cc.SafeArea")(AMe=Oc()(AMe=gc(110)(AMe=wc(AMe=Pc()(AMe=vc(yOe)(AMe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.onEnable=function(){this.updateArea(),ch.on("window-resize",this.updateArea,this),ch.on("orientation-change",this.updateArea,this)},n.onDisable=function(){ch.off("window-resize",this.updateArea,this),ch.off("orientation-change",this.updateArea,this)},n.updateArea=function(){var e=this.node.getComponent(yOe),t=this.node.getComponent(RX);if(e&&t){e.updateAlignment();var n=this.node.position.clone(),i=t.anchorPoint.clone();e.isAlignTop=e.isAlignBottom=e.isAlignLeft=e.isAlignRight=!0;var r=tN.getVisibleSize(),o=r.width,a=r.height,s=hh.getSafeAreaRect();e.top=a-s.y-s.height,e.bottom=s.y,e.left=s.x,e.right=o-s.x-s.width,e.updateAlignment();var c=this.node.position.clone(),l=i.x-(c.x-n.x)/t.width,u=i.y-(c.y-n.y)/t.height;t.setAnchorPoint(l,u),PMe.add(e)}},t}(th))||AMe)||AMe)||AMe)||AMe)||AMe)||AMe);u.SafeArea=YMe;var KMe,QMe=function(t){return e({UICoordinateTracker:t,UICoordinateTrackerComponent:t}),t}((RMe=mc("cc.UICoordinateTracker"),IMe=Oc(),DMe=Pc(),OMe=gc(110),MMe=Zc(qC),NMe=Fc(),LMe=Zc(oF),BMe=Fc(),FMe=Fc(),zMe=Fc(),UMe=Zc([kB]),kMe=Fc(),RMe(GMe=IMe(GMe=DMe(GMe=OMe((le((HMe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"syncEvents",VMe,oe(t)),ce(t,"_target",WMe,oe(t)),ce(t,"_camera",jMe,oe(t)),ce(t,"_useScale",qMe,oe(t)),ce(t,"_distance",XMe,oe(t)),t._transformPos=new In,t._viewPos=new In,t._canMove=!0,t._lastWPos=new In,t._lastCameraPos=new In,t}$(t,e);var n=t.prototype;return n.onEnable=function(){this._checkCanMove()},n.update=function(){var e=this.node.worldPosition,t=this._camera;if(this._canMove&&t&&t.camera&&(!this._lastWPos.equals(e)||!this._lastCameraPos.equals(t.node.worldPosition))&&(this._lastWPos.set(e),this._lastCameraPos.set(t.node.worldPosition),t.camera.update(),t.convertToUINode(e,this._target,this._transformPos),this._useScale&&In.transformMat4(this._viewPos,this.node.worldPosition,t.camera.matView),this.syncEvents.length>0)){var n=this._distance/Math.abs(this._viewPos.z);kB.emitEvents(this.syncEvents,this._transformPos,n)}},n._checkCanMove=function(){this._canMove=!(!this._camera||!this._target)},Z(t,[{key:"target",get:function(){return this._target},set:function(e){this._target!==e&&(this._target=e,this._checkCanMove())}},{key:"camera",get:function(){return this._camera},set:function(e){this._camera!==e&&(this._camera=e,this._checkCanMove())}},{key:"useScale",get:function(){return this._useScale},set:function(e){this._useScale!==e&&(this._useScale=e)}},{key:"distance",get:function(){return this._distance},set:function(e){this._distance!==e&&(this._distance=e)}}]),t}(th)).prototype,"target",[MMe,NMe],Object.getOwnPropertyDescriptor(HMe.prototype,"target"),HMe.prototype),le(HMe.prototype,"camera",[LMe,BMe],Object.getOwnPropertyDescriptor(HMe.prototype,"camera"),HMe.prototype),le(HMe.prototype,"useScale",[FMe],Object.getOwnPropertyDescriptor(HMe.prototype,"useScale"),HMe.prototype),le(HMe.prototype,"distance",[zMe],Object.getOwnPropertyDescriptor(HMe.prototype,"distance"),HMe.prototype),VMe=le(HMe.prototype,"syncEvents",[UMe,Tc,kMe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),WMe=le(HMe.prototype,"_target",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),jMe=le(HMe.prototype,"_camera",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),qMe=le(HMe.prototype,"_useScale",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),XMe=le(HMe.prototype,"_distance",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),GMe=HMe))||GMe)||GMe)||GMe)||GMe)),ZMe=[Wb.TOUCH_START,Wb.TOUCH_END,Wb.TOUCH_MOVE,Wb.MOUSE_DOWN,Wb.MOUSE_MOVE,Wb.MOUSE_UP,Wb.MOUSE_ENTER,Wb.MOUSE_LEAVE,Wb.MOUSE_WHEEL];function JMe(e){e.propagationStopped=!0}var $Me,eNe,tNe,nNe,iNe,rNe,oNe,aNe,sNe,cNe,lNe,uNe,hNe=function(t){return e({BlockInputEvents:t,BlockInputEventsComponent:t}),t}(mc("cc.BlockInputEvents")(KMe=Oc()(KMe=Pc()(KMe=function(e){function t(){return e.apply(this,arguments)||this}$(t,e);var n=t.prototype;return n.onEnable=function(){for(var e=0;e<ZMe.length;e++)this.node.on(ZMe[e],JMe,this)},n.onDisable=function(){for(var e=0;e<ZMe.length;e++)this.node.off(ZMe[e],JMe,this)},t}(th))||KMe)||KMe)||KMe),fNe={},_Ne=e("SubContextView",($Me=mc("cc.SubContextView"),eNe=Oc(),tNe=gc(110),nNe=vc(RX),iNe=Pc(),rNe=Fc(),oNe=Fc(),$Me(aNe=eNe(aNe=tNe(aNe=nNe(aNe=iNe((le((sNe=function(e){function t(){var t;return ce(t=e.call(this)||this,"_fps",cNe,oe(t)),t._sprite=void 0,t._imageAsset=void 0,t._texture=void 0,t._updatedTime=0,t._updateInterval=0,t._openDataContext=void 0,t._content=void 0,ce(t,"_designResolutionSize",lNe,oe(t)),t._content=new qC("content"),t._content.hideFlags|=ml.Flags.DontSave|ml.Flags.HideInHierarchy,t._sprite=null,t._imageAsset=new nv,t._openDataContext=null,t._updatedTime=performance.now(),t._texture=new Cv,t}$(t,e);var n=t.prototype;return n.onLoad=function(){fNe.getOpenDataContext?(this._updateInterval=1e3/this._fps,this._openDataContext=fNe.getOpenDataContext(),this._initSharedCanvas(),this._initContentNode(),this._updateSubContextView(),this._updateContentLayer()):this.enabled=!1},n.onEnable=function(){this._registerNodeEvent()},n.onDisable=function(){this._unregisterNodeEvent()},n._initSharedCanvas=function(){if(this._openDataContext){var e=this._openDataContext.canvas;e.width=this._designResolutionSize.width,e.height=this._designResolutionSize.height}},n._initContentNode=function(){if(this._openDataContext){var e=this._openDataContext.canvas,t=this._imageAsset;if(t.reset(e),this._texture.image=t,this._texture.create(e.width,e.height),this._sprite=this._content.getComponent(nJ),this._sprite||(this._sprite=this._content.addComponent(nJ)),this._sprite.spriteFrame)this._sprite.spriteFrame.texture=this._texture;else{var n=new nq;n.texture=this._texture,this._sprite.spriteFrame=n}this._content.parent=this.node}},n._updateSubContextView=function(){if(this._openDataContext){var e=this.node.getComponent(RX),t=this._content.getComponent(RX),n=e.width/t.width,i=e.height/t.height,r=n>i?i:n;t.width*=r,t.height*=r;var o=tN.getViewportRect(),a=t.getBoundingBoxToWorld(),s=tN.getVisibleSize(),c=ch.devicePixelRatio,l=(o.width*(a.x/s.width)+o.x)/c,u=(o.height*(a.y/s.height)+o.y)/c,h=o.width*(a.width/s.width)/c,f=o.height*(a.height/s.height)/c;this._openDataContext.postMessage({fromEngine:!0,type:"engine",event:"viewport",x:l,y:u,width:h,height:f})}},n._updateSubContextTexture=function(){var e=this._imageAsset;if(e&&this._openDataContext&&!(e.width<=0||e.height<=0)){var t=this._openDataContext.canvas;e.reset(t),(t.width>e.width||t.height>e.height)&&this._texture.create(t.width,t.height),this._texture.uploadData(t)}},n._registerNodeEvent=function(){this.node.on(Wb.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.on(Wb.SIZE_CHANGED,this._updateSubContextView,this),this.node.on(Wb.LAYER_CHANGED,this._updateContentLayer,this)},n._unregisterNodeEvent=function(){this.node.off(Wb.TRANSFORM_CHANGED,this._updateSubContextView,this),this.node.off(Wb.SIZE_CHANGED,this._updateSubContextView,this),this.node.off(Wb.LAYER_CHANGED,this._updateContentLayer,this)},n._updateContentLayer=function(){this._content.layer=this.node.layer},n.update=function(e){void 0===e?this._updateSubContextTexture():performance.now()-this._updatedTime>=this._updateInterval&&(this._updatedTime+=this._updateInterval,this._updateSubContextTexture())},n.onDestroy=function(){this._content.destroy(),this._texture.destroy(),this._sprite&&this._sprite.destroy(),this._imageAsset.destroy(),this._openDataContext=null},Z(t,[{key:"designResolutionSize",get:function(){return this._designResolutionSize},set:function(){}},{key:"fps",get:function(){return this._fps},set:function(e){this._fps!==e&&(this._fps=e,this._updateInterval=1e3/e)}}]),t}(th)).prototype,"designResolutionSize",[rNe],Object.getOwnPropertyDescriptor(sNe.prototype,"designResolutionSize"),sNe.prototype),le(sNe.prototype,"fps",[oNe],Object.getOwnPropertyDescriptor(sNe.prototype,"fps"),sNe.prototype),cNe=le(sNe.prototype,"_fps",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 60}}),lNe=le(sNe.prototype,"_designResolutionSize",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return new ni(640,960)}}),aNe=sNe))||aNe)||aNe)||aNe)||aNe)||aNe));u.SubContextView=_Ne;var pNe,dNe,mNe,vNe,gNe=e("UIReorderComponent",mc("cc.UIReorderComponent")(uNe=function(){D(1408,"UIReorderComponent")})||uNe);u.UIReorderComponent=gNe,u.ButtonComponent=dCe,rt.setClassAlias(dCe,"cc.ButtonComponent"),u.EditBoxComponent=Gwe,rt.setClassAlias(Gwe,"cc.EditBoxComponent"),u.LayoutComponent=fPe,rt.setClassAlias(fPe,"cc.LayoutComponent"),u.ProgressBarComponent=FPe,rt.setClassAlias(FPe,"cc.ProgressBarComponent"),u.ScrollViewComponent=vIe,rt.setClassAlias(vIe,"cc.ScrollViewComponent"),u.ScrollBarComponent=qPe,rt.setClassAlias(qPe,"cc.ScrollBarComponent"),u.SliderComponent=kIe,rt.setClassAlias(kIe,"cc.SliderComponent"),u.ToggleComponent=eDe,rt.setClassAlias(eDe,"cc.ToggleComponent"),u.ToggleContainerComponent=qDe,rt.setClassAlias(qDe,"cc.ToggleContainerComponent"),u.WidgetComponent=yOe,rt.setClassAlias(yOe,"cc.WidgetComponent"),u.PageViewComponent=mMe,rt.setClassAlias(mMe,"cc.PageViewComponent"),u.PageViewIndicatorComponent=hMe,rt.setClassAlias(hMe,"cc.PageViewIndicatorComponent"),u.SafeAreaComponent=YMe,rt.setClassAlias(YMe,"cc.SafeAreaComponent"),rt.setClassAlias(QMe,"cc.UICoordinateTrackerComponent"),u.BlockInputEventsComponent=hNe,rt.setClassAlias(hNe,"cc.BlockInputEventsComponent");var yNe=e("VideoClip",mc("cc.VideoClip")((vNe=function(e){function t(){var t;return ce(t=e.call(this)||this,"_duration",mNe,oe(t)),t._video=null,t}return $(t,e),Z(t,[{key:"_nativeAsset",get:function(){return this._video},set:function(e){this._video=e,this._duration=e?e.duration:0}}]),t}(Nu),mNe=le((dNe=vNe).prototype,"_duration",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 0}}),pNe=dNe))||pNe);function xNe(e,t,n){var i=document.createElement("video"),r=document.createElement("source");i.appendChild(r);var o=new XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200===this.status||0===this.status?(r.src=URL.createObjectURL(this.response),n(null,i)):n(new Error(o.status+"(no response)"))},o.onerror=function(){var t="load video failure - "+e;x(t),n(new Error(t))},o.send()}function SNe(e,t,n,i){var r=new yNe;r._nativeUrl=e,r._nativeAsset=t,i(null,r)}LN.register({".mp4":xNe,".avi":xNe,".mov":xNe,".mpg":xNe,".mpeg":xNe,".rm":xNe,".rmvb":xNe}),HN.register({".mp4":SNe,".avi":SNe,".mov":SNe,".mpg":SNe,".mpeg":SNe,".rm":SNe,".rmvb":SNe});var TNe,bNe,ENe=st({REMOTE:0,LOCAL:1});!function(e){e.NONE="none",e.PLAYING="playing",e.PAUSED="paused",e.STOPPED="stopped",e.COMPLETED="completed",e.META_LOADED="meta-loaded",e.READY_TO_PLAY="ready-to-play",e.ERROR="error",e.CLICKED="clicked"}(TNe||(TNe={})),function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(bNe||(bNe={}));var CNe=function(){function e(e){var t=this;this._componentEventList=new Map,this._state=TNe.NONE,this._video=null,this._onHide=void 0,this._onShow=void 0,this._interrupted=!1,this._loaded=!1,this._loadedMeta=!1,this._ignorePause=!1,this._fullScreenOnAwake=!1,this._visible=!0,this._playing=!1,this._cachedCurrentTime=-1,this._waitingFullscreen=!1,this._waitingPlay=!1,this._keepAspectRatio=!1,this._component=null,this._uiTrans=null,this._node=null,this._stayOnBottom=!1,this._dirty=!1,this._forceUpdate=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=e,this._node=e.node,this._uiTrans=e.node.getComponent(RX),this._onHide=function(){t.video&&t._state===TNe.PLAYING&&(t.video.pause(),t._interrupted=!0)},this._onShow=function(){t._interrupted&&t.video&&(t.video.play(),t._interrupted=!1)},u.game.on(u.Game.EVENT_HIDE,this._onHide),u.game.on(u.Game.EVENT_SHOW,this._onShow)}var t=e.prototype;return t.onLoadedMetadata=function(e){this._loadedMeta=!0,this._forceUpdate=!0,this._visible?this.enable():this.disable(),this.dispatchEvent(TNe.META_LOADED);var t=e.target;this._keepAspectRatio&&t&&this.syncUITransform(t.videoWidth,t.videoHeight),this.delayedFullScreen(),this.delayedPlay()},t.onCanPlay=function(){this._loaded=!0,this.dispatchEvent(TNe.READY_TO_PLAY)},t.onPlay=function(){this._playing=!0,this.dispatchEvent(TNe.PLAYING)},t.onPlaying=function(){this.dispatchEvent(TNe.PLAYING)},t.onPause=function(){this._ignorePause?this._ignorePause=!1:(this._playing=!1,this.dispatchEvent(TNe.PAUSED))},t.onStoped=function(){this._playing=!1,this._ignorePause=!1,this.dispatchEvent(TNe.STOPPED)},t.onEnded=function(){this.dispatchEvent(TNe.COMPLETED)},t.onClick=function(){this.dispatchEvent(TNe.CLICKED)},t.onError=function(e){this.dispatchEvent(TNe.ERROR);var t=e.target;t&&t.error&&T("Error "+t.error.code+"; details: "+t.error.message)},t.play=function(){this._loadedMeta||this._loaded?this.canPlay():this._waitingPlay=!0},t.delayedPlay=function(){this._waitingPlay&&(this.canPlay(),this._waitingPlay=!1)},t.syncFullScreenOnAwake=function(e){this._fullScreenOnAwake=e,this._loadedMeta||this._loaded?this.canFullScreen(e):this._waitingFullscreen=!0},t.delayedFullScreen=function(){this._waitingFullscreen&&(this.canFullScreen(this._fullScreenOnAwake),this._waitingFullscreen=!1)},t.dispatchEvent=function(e){var t=this._componentEventList.get(e);t&&(this._state=e,t.call(this))},t.syncUITransform=function(e,t){this._uiTrans&&(this._uiTrans.width=e,this._uiTrans.height=t)},t.syncCurrentTime=function(){this.video&&-1!==this._cachedCurrentTime&&this.video.currentTime!==this._cachedCurrentTime&&(this.seekTo(this._cachedCurrentTime),this._cachedCurrentTime=-1)},t.destroy=function(){this.removeVideoPlayer(),this._componentEventList.clear(),u.game.off(u.Game.EVENT_HIDE,this._onHide),u.game.off(u.Game.EVENT_SHOW,this._onShow)},Z(e,[{key:"fullScreenOnAwake",get:function(){return this._fullScreenOnAwake}},{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"video",get:function(){return this._video}},{key:"state",get:function(){return this._state}},{key:"isPlaying",get:function(){return this._playing}},{key:"UICamera",get:function(){return jM.root.batcher2D.getFirstRenderCamera(this._node)}}]),e}();u.internal.VideoPlayerImpl=CNe;var ANe,wNe,PNe,RNe,INe,DNe,ONe,MNe,NNe,LNe,BNe,FNe,zNe,UNe,kNe,GNe,HNe,VNe,WNe,jNe,qNe,XNe,YNe,KNe,QNe,ZNe,JNe,$Ne,eLe,tLe,nLe,iLe,rLe,oLe,aLe,sLe,cLe,lLe,uLe,hLe=-Math.pow(2,15),fLe=Yn(),_Le=function(e){function t(t){var n;return(n=e.call(this,t)||this)._eventList=new Map,n._clearColorA=-1,n._clearFlag=void 0,n}$(t,e);var n=t.prototype;return n.addListener=function(e,t){this._video&&(this._eventList.set(e,t),this._video.addEventListener(e,t))},n.removeAllListeners=function(){var e=this;this._eventList.forEach((function(t,n){e._video&&e._video.removeEventListener(n,t)})),this._eventList.clear()},n.canPlay=function(){var e=this;if(this.video){var t=this.video.play();window.Promise&&t instanceof Promise&&t.catch((function(){})).then((function(){e.syncCurrentTime()}))}},n.pause=function(){this.video&&(this.video.pause(),this._cachedCurrentTime=this.video.currentTime)},n.resume=function(){this.play()},n.stop=function(){var e=this;this.video&&(this._ignorePause=!0,this.video.currentTime=0,this.video.pause(),this._cachedCurrentTime=0,setTimeout((function(){e._ignorePause=!1,e.dispatchEvent(TNe.STOPPED)}),0))},n.syncClip=function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e.nativeUrl)},n.syncURL=function(e){this.removeVideoPlayer(),e&&this.createVideoPlayer(e)},n.syncPlaybackRate=function(e){hh.browserType!==ou.UC?this.video&&(this.video.playbackRate=e):S("playbackRate is not supported by the uc mobile browser.")},n.syncVolume=function(e){this.video&&(this.video.volume=e)},n.syncMute=function(e){this.video&&(this.video.muted=e)},n.syncLoop=function(e){this.video&&(this.video.loop=e)},n.getDuration=function(){return this.video?this.video.duration:0},n.getCurrentTime=function(){return this.video?this.video.currentTime:-1},n.seekTo=function(e){this.video&&(this.video.currentTime=e)},n.canFullScreen=function(e){var t=this,n=this._video;if(n&&n.readyState===bNe.HAVE_ENOUGH_DATA)return hh.os===cu.IOS&&hh.isBrowser?(e?n.webkitEnterFullscreen&&n.webkitEnterFullscreen():n.webkitExitFullscreen&&n.webkitExitFullscreen(),void(this._fullScreenOnAwake=n.webkitDisplayingFullscreen)):uh.supportsFullScreen?void(e?(hh.browserType===ou.IE&&(n.style.transform=""),n.setAttribute("x5-video-player-fullscreen","true"),uh.requestFullScreen(n,(function(e){var i=hh.browserType===ou.IE?e.msFullscreenElement:e.fullscreenElement;t._fullScreenOnAwake=i===n}),(function(){t._fullScreenOnAwake=!1}))):(n.removeAttribute("x5-video-player-fullscreen"),uh.exitFullScreen())):(this._fullScreenOnAwake=e,this._forceUpdate=!0,void this.syncMatrix())},n.syncStayOnBottom=function(e){this._video&&(this._video.style["z-index"]=e?hLe:0,this._stayOnBottom=e),this._dirty=!0},n.syncKeepAspectRatio=function(e){this._keepAspectRatio=e,e&&this._loadedMeta&&this._video&&this.syncUITransform(this._video.videoWidth,this._video.videoHeight)},n.removeVideoPlayer=function(){var e=this._video;e&&xt(VM.container,e)&&(VM.container.removeChild(e),this.removeAllListeners()),this._cachedCurrentTime=0,this._playing=!1,this._loaded=!1,this._loadedMeta=!1,this._video=null},n.createVideoPlayer=function(e){var t=this._video=document.createElement("video");t.className="cocosVideo",t.style.visibility="hidden",t.style.position="absolute",t.style.bottom="0px",t.style.left="0px",t.style["transform-origin"]="0px 100% 0px",t.style["-webkit-transform-origin"]="0px 100% 0px",t.setAttribute("preload","auto"),t.setAttribute("webkit-playsinline",""),t.setAttribute("x5-playsinline",""),t.setAttribute("playsinline",""),this._bindDomEvent(),VM.container.appendChild(t);var n=document.createElement("source");t.appendChild(n),n.src=e},n._bindDomEvent=function(){this._video,this.addListener("loadedmetadata",this.onLoadedMetadata.bind(this)),this.addListener("canplay",this.onCanPlay.bind(this)),this.addListener("canplaythrough",this.onCanPlay.bind(this)),this.addListener("play",this.onPlay.bind(this)),this.addListener("playing",this.onPlaying.bind(this)),this.addListener("pause",this.onPause.bind(this)),this.addListener("click",this.onClick.bind(this)),this.addListener("ended",this.onEnded.bind(this)),this.addListener("error",this.onError.bind(this))},n.onCanPlay=function(t){var n=t.target;if(!this._loaded||!n)switch(n.readyState){case bNe.HAVE_METADATA:case bNe.HAVE_ENOUGH_DATA:e.prototype.onCanPlay.call(this,t)}},n.enable=function(){if(this._video){if(this._visible=!0,"visible"===this._video.style.visibility)return;this._video.style.visibility="visible"}},n.disable=function(e){if(this._video){if(!e&&this._playing&&this._video.pause(),this._visible=!1,"hidden"===this._video.style.visibility)return;this._video.style.visibility="hidden"}},n.syncMatrix=function(){if(this._video&&this._visible&&this._component){var e=this.UICamera;if(e&&!uh.fullScreen()){this._dirty&&(this._dirty=!1,this._stayOnBottom?(this._clearColorA=e.clearColor.w,this._clearFlag=e.clearFlag,e.clearColor.w=0,e.clearFlag=Ki.ALL):this._clearFlag&&(e.clearColor.w=this._clearColorA,e.clearFlag=this._clearFlag,this._clearColorA=-1,this._clearFlag=null)),this._component.node.getWorldMatrix(fLe),e.update(!0),e.worldMatrixToScreen(fLe,fLe,VM.canvas.width,VM.canvas.height);var t=0,n=0;if(this._fullScreenOnAwake?(t=YM.width,n=YM.height):(t=this._uiTrans.contentSize.width,n=this._uiTrans.contentSize.height),this._forceUpdate||this._m00!==fLe.m00||this._m01!==fLe.m01||this._m04!==fLe.m04||this._m05!==fLe.m05||this._m12!==fLe.m12||this._m13!==fLe.m13||this._w!==t||this._h!==n){this._m00=fLe.m00,this._m01=fLe.m01,this._m04=fLe.m04,this._m05=fLe.m05,this._m12=fLe.m12,this._m13=fLe.m13,this._w=t,this._h=n;var i=ch.devicePixelRatio,r=1/i,o=1/i,a=VM.container,s=fLe.m00*r,c=fLe.m01,l=fLe.m04,u=fLe.m05*o;this._video.style.width=this._w+"px",this._video.style.height=this._h+"px",hh.browserType!==ou.MOBILE_QQ?this._video.style.objectFit=this._keepAspectRatio?"none":"fill":S("keepAspectRatio is not supported by the qq mobile browser.");var h=this._w*r,f=this._h*o,_=this._uiTrans.anchorPoint,p=_.x,d=_.y,m=h*fLe.m00*p,v=f*fLe.m05*d,g=a&&a.style.paddingLeft?parseInt(a.style.paddingLeft):0,y=a&&a.style.paddingBottom?parseInt(a.style.paddingBottom):0,x="matrix("+s+","+-c+","+-l+","+u+","+(fLe.m12*r-m+g)+","+-(fLe.m13*o-v+y)+")";this._video.style.transform=x,this._video.style["-webkit-transform"]=x,hh.browserType!==ou.IE&&(this._forceUpdate=!1)}}}},t}(CNe),pLe=function(){function e(){}return e.getImpl=function(e){return new _Le(e)},e}();u.internal.VideoPlayerImplManager=pLe;var dLe,mLe=e("VideoPlayer",(ANe=mc("cc.VideoPlayer"),wNe=Oc(),PNe=Pc(),RNe=vc(RX),INe=Zc(yNe),DNe=Zc(ENe),ONe=Fc(),MNe=Fc(),NNe=Zc(yNe),LNe=Fc(),BNe=Fc(),FNe=zc(),zNe=Fc(),UNe=zc(),kNe=Fc(),GNe=Fc(),HNe=Fc(),VNe=Fc(),WNe=Fc(),jNe=Fc(),qNe=Zc([kB]),XNe=Vc(),YNe=Fc(),ANe(KNe=wNe(KNe=PNe(KNe=RNe(KNe=wc((uLe=lLe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_resourceType",ZNe,oe(t)),ce(t,"_remoteURL",JNe,oe(t)),ce(t,"_clip",$Ne,oe(t)),ce(t,"_playOnAwake",eLe,oe(t)),ce(t,"_volume",tLe,oe(t)),ce(t,"_mute",nLe,oe(t)),ce(t,"_playbackRate",iLe,oe(t)),ce(t,"_loop",rLe,oe(t)),ce(t,"_fullScreenOnAwake",oLe,oe(t)),ce(t,"_stayOnBottom",aLe,oe(t)),ce(t,"_keepAspectRatio",sLe,oe(t)),t._impl=null,t._cachedCurrentTime=0,ce(t,"videoPlayerEvent",cLe,oe(t)),t}$(t,e);var n=t.prototype;return n.syncSource=function(){this._impl&&(this._resourceType===ENe.REMOTE?this._impl.syncURL(this._remoteURL):this._impl.syncClip(this._clip))},n.__preload=function(){this._impl=pLe.getImpl(this),this.syncSource(),this._impl.syncLoop(this._loop),this._impl.syncVolume(this._volume),this._impl.syncMute(this._mute),this._impl.seekTo(this._cachedCurrentTime),this._impl.syncPlaybackRate(this._playbackRate),this._impl.syncStayOnBottom(this._stayOnBottom),this._impl.syncKeepAspectRatio(this._keepAspectRatio),this._impl.syncFullScreenOnAwake(this._fullScreenOnAwake),this._impl.componentEventList.set(TNe.META_LOADED,this.onMetaLoaded.bind(this)),this._impl.componentEventList.set(TNe.READY_TO_PLAY,this.onReadyToPlay.bind(this)),this._impl.componentEventList.set(TNe.PLAYING,this.onPlaying.bind(this)),this._impl.componentEventList.set(TNe.PAUSED,this.onPaused.bind(this)),this._impl.componentEventList.set(TNe.STOPPED,this.onStopped.bind(this)),this._impl.componentEventList.set(TNe.COMPLETED,this.onCompleted.bind(this)),this._impl.componentEventList.set(TNe.ERROR,this.onError.bind(this)),this._playOnAwake&&this._impl.loaded&&this.play()},n.onEnable=function(){this._impl&&this._impl.enable()},n.onDisable=function(){this._impl&&this._impl.disable()},n.onDestroy=function(){this._impl&&(this._impl.destroy(),this._impl=null)},n.update=function(){this._impl&&this._impl.syncMatrix()},n.onMetaLoaded=function(){kB.emitEvents(this.videoPlayerEvent,this,TNe.META_LOADED),this.node.emit("meta-loaded",this)},n.onReadyToPlay=function(){this._playOnAwake&&!this.isPlaying&&this.play(),kB.emitEvents(this.videoPlayerEvent,this,TNe.READY_TO_PLAY),this.node.emit(TNe.READY_TO_PLAY,this)},n.onPlaying=function(){kB.emitEvents(this.videoPlayerEvent,this,TNe.PLAYING),this.node.emit(TNe.PLAYING,this)},n.onPaused=function(){kB.emitEvents(this.videoPlayerEvent,this,TNe.PAUSED),this.node.emit(TNe.PAUSED,this)},n.onStopped=function(){kB.emitEvents(this.videoPlayerEvent,this,TNe.STOPPED),this.node.emit(TNe.STOPPED,this)},n.onCompleted=function(){kB.emitEvents(this.videoPlayerEvent,this,TNe.COMPLETED),this.node.emit(TNe.COMPLETED,this)},n.onError=function(){kB.emitEvents(this.videoPlayerEvent,this,TNe.ERROR),this.node.emit(TNe.ERROR,this)},n.play=function(){this._impl&&this._impl.play()},n.resume=function(){this._impl&&this._impl.resume()},n.pause=function(){this._impl&&this._impl.pause()},n.stop=function(){this._impl&&this._impl.stop()},Z(t,[{key:"resourceType",get:function(){return this._resourceType},set:function(e){this._resourceType!==e&&(this._resourceType=e,this.syncSource())}},{key:"remoteURL",get:function(){return this._remoteURL},set:function(e){this._remoteURL!==e&&(this._remoteURL=e,this.syncSource())}},{key:"clip",get:function(){return this._clip},set:function(e){this._clip!==e&&(this._clip=e,this.syncSource())}},{key:"playOnAwake",get:function(){return this._playOnAwake},set:function(e){this._playOnAwake=e}},{key:"playbackRate",get:function(){return this._playbackRate},set:function(e){this._playbackRate=e,this._impl&&this._impl.syncPlaybackRate(e)}},{key:"volume",get:function(){return this._volume},set:function(e){this._volume=e,this._impl&&this._impl.syncVolume(e)}},{key:"mute",get:function(){return this._mute},set:function(e){this._mute=e,this._impl&&this._impl.syncMute(e)}},{key:"loop",get:function(){return this._loop},set:function(e){this._loop=e,this._impl&&this._impl.syncLoop(e)}},{key:"keepAspectRatio",get:function(){return this._keepAspectRatio},set:function(e){this._keepAspectRatio!==e&&(this._keepAspectRatio=e,this._impl&&this._impl.syncKeepAspectRatio(e))}},{key:"fullScreenOnAwake",get:function(){return this._impl?(this._fullScreenOnAwake=this._impl.fullScreenOnAwake,this._fullScreenOnAwake):this._fullScreenOnAwake},set:function(e){this._fullScreenOnAwake!==e&&(this._fullScreenOnAwake=e,this._impl&&this._impl.syncFullScreenOnAwake(e))}},{key:"stayOnBottom",get:function(){return this._stayOnBottom},set:function(e){this._stayOnBottom!==e&&(this._stayOnBottom=e,this._impl&&this._impl.syncStayOnBottom(e))}},{key:"nativeVideo",get:function(){return this._impl&&this._impl.video||null}},{key:"currentTime",get:function(){return this._impl?this._impl.getCurrentTime():this._cachedCurrentTime},set:function(e){Number.isNaN(e)?S("illegal video time! value:"+e):(e=ln(e,0,this.duration),this._cachedCurrentTime=e,this._impl&&this._impl.seekTo(e))}},{key:"duration",get:function(){return this._impl?this._impl.getDuration():0}},{key:"state",get:function(){return this._impl?this._impl.state:TNe.NONE}},{key:"isPlaying",get:function(){return!!this._impl&&this._impl.isPlaying}}]),t}(th),lLe.EventType=TNe,lLe.ResourceType=ENe,ZNe=le((QNe=uLe).prototype,"_resourceType",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return ENe.LOCAL}}),JNe=le(QNe.prototype,"_remoteURL",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return""}}),$Ne=le(QNe.prototype,"_clip",[INe,Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return null}}),eLe=le(QNe.prototype,"_playOnAwake",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),tLe=le(QNe.prototype,"_volume",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),nLe=le(QNe.prototype,"_mute",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),iLe=le(QNe.prototype,"_playbackRate",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return 1}}),rLe=le(QNe.prototype,"_loop",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),oLe=le(QNe.prototype,"_fullScreenOnAwake",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),aLe=le(QNe.prototype,"_stayOnBottom",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),sLe=le(QNe.prototype,"_keepAspectRatio",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!0}}),le(QNe.prototype,"resourceType",[DNe,ONe],Object.getOwnPropertyDescriptor(QNe.prototype,"resourceType"),QNe.prototype),le(QNe.prototype,"remoteURL",[MNe],Object.getOwnPropertyDescriptor(QNe.prototype,"remoteURL"),QNe.prototype),le(QNe.prototype,"clip",[NNe,LNe],Object.getOwnPropertyDescriptor(QNe.prototype,"clip"),QNe.prototype),le(QNe.prototype,"playOnAwake",[BNe],Object.getOwnPropertyDescriptor(QNe.prototype,"playOnAwake"),QNe.prototype),le(QNe.prototype,"playbackRate",[Hc,FNe,zNe],Object.getOwnPropertyDescriptor(QNe.prototype,"playbackRate"),QNe.prototype),le(QNe.prototype,"volume",[Hc,UNe,kNe],Object.getOwnPropertyDescriptor(QNe.prototype,"volume"),QNe.prototype),le(QNe.prototype,"mute",[GNe],Object.getOwnPropertyDescriptor(QNe.prototype,"mute"),QNe.prototype),le(QNe.prototype,"loop",[HNe],Object.getOwnPropertyDescriptor(QNe.prototype,"loop"),QNe.prototype),le(QNe.prototype,"keepAspectRatio",[VNe],Object.getOwnPropertyDescriptor(QNe.prototype,"keepAspectRatio"),QNe.prototype),le(QNe.prototype,"fullScreenOnAwake",[WNe],Object.getOwnPropertyDescriptor(QNe.prototype,"fullScreenOnAwake"),QNe.prototype),le(QNe.prototype,"stayOnBottom",[jNe],Object.getOwnPropertyDescriptor(QNe.prototype,"stayOnBottom"),QNe.prototype),cLe=le(QNe.prototype,"videoPlayerEvent",[Tc,qNe,XNe,YNe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),KNe=QNe))||KNe)||KNe)||KNe)||KNe)||KNe));u.internal.VideoPlayer=mLe,k(mLe.prototype,"VideoPlayer.prototype",[{name:"onPasued",newName:"onPaused"}]),function(e){e.NONE="none",e.LOADING="loading",e.LOADED="loaded",e.ERROR="error"}(dLe||(dLe={}));var vLe=function(){function e(e){this._componentEventList=new Map,this._state=dLe.NONE,this._wrapper=void 0,this._webview=null,this._loaded=!1,this._forceUpdate=!1,this._component=null,this._uiTrans=null,this._node=null,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._component=e,this._node=e.node,this._uiTrans=e.node.getComponent(RX),this.reset(),this.createWebView()}var t=e.prototype;return t.reset=function(){this._wrapper=null,this._webview=null,this._loaded=!1,this._w=0,this._h=0,this._m00=0,this._m01=0,this._m04=0,this._m05=0,this._m12=0,this._m13=0,this._state=dLe.NONE,this._forceUpdate=!1},t.dispatchEvent=function(e){var t=this._componentEventList.get(e);if(t){this._state=e;for(var n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];t.call(this,i)}},t.destroy=function(){this.removeWebView(),this._wrapper=null,this._webview=null,this._loaded=!1,this._component=null,this._uiTrans=null,this._forceUpdate=!1,this._componentEventList.clear()},Z(e,[{key:"loaded",get:function(){return this._loaded}},{key:"componentEventList",get:function(){return this._componentEventList}},{key:"webview",get:function(){return this._webview}},{key:"state",get:function(){return this._state}},{key:"UICamera",get:function(){return jM.root.batcher2D.getFirstRenderCamera(this._node)}}]),e}();u.internal.WebViewImpl=vLe;var gLe,yLe,xLe,SLe,TLe,bLe,ELe,CLe,ALe,wLe,PLe,RLe,ILe,DLe,OLe=Yn(),MLe=function(e){function t(t){return e.call(this,t)||this}$(t,e);var n=t.prototype;return n._bindDomEvent=function(){var e=this;this.webview&&this.webview.addEventListener("load",(function(t){e._forceUpdate=!0,e.dispatchEvent(dLe.LOADED);var n=t.target,i=n.contentDocument&&n.contentDocument.body;i&&i.innerHTML.includes("404")&&e.dispatchEvent(dLe.ERROR,i.innerHTML)}))},n.loadURL=function(e){this.webview&&(this.webview.src=e,this.dispatchEvent(dLe.LOADING))},n.createWebView=function(){var e=document.createElement("div");this._wrapper=e,e.id="webview-wrapper",e.style["-webkit-overflow"]="auto",e.style["-webkit-overflow-scrolling"]="touch",e.style.position="absolute",e.style.bottom="0px",e.style.left="0px",e.style.transformOrigin="0px 100% 0px",e.style["-webkit-transform-origin"]="0px 100% 0px",VM.container.appendChild(e);var t=document.createElement("iframe");this._webview=t,t.id="webview",t.style.border="none",t.style.width="100%",t.style.height="100%",e.appendChild(t),this._bindDomEvent()},n.removeWebView=function(){var e=this._wrapper;xt(VM.container,e)&&VM.container.removeChild(e),this.reset()},n.enable=function(){this._wrapper&&(this._wrapper.style.visibility="visible")},n.disable=function(){this._wrapper&&(this._wrapper.style.visibility="hidden")},n.evaluateJS=function(e){if(this.webview){var t=this.webview.contentWindow;if(t)try{t.eval(e)}catch(e){this.dispatchEvent(dLe.ERROR,e),T(e)}}},n.setOnJSCallback=function(){S("The platform does not support")},n.setJavascriptInterfaceScheme=function(){S("The platform does not support")},n.syncMatrix=function(){if(this._wrapper&&this._uiTrans&&this._component&&"hidden"!==this._wrapper.style.visibility){var e=this.UICamera;if(e){this._component.node.getWorldMatrix(OLe),e.update(!0),e.worldMatrixToScreen(OLe,OLe,VM.canvas.width,VM.canvas.height);var t=this._uiTrans.contentSize,n=t.width,i=t.height;if(this._forceUpdate||this._m00!==OLe.m00||this._m01!==OLe.m01||this._m04!==OLe.m04||this._m05!==OLe.m05||this._m12!==OLe.m12||this._m13!==OLe.m13||this._w!==n||this._h!==i){this._m00=OLe.m00,this._m01=OLe.m01,this._m04=OLe.m04,this._m05=OLe.m05,this._m12=OLe.m12,this._m13=OLe.m13,this._w=n,this._h=i;var r=ch.devicePixelRatio,o=1/r,a=1/r,s=VM.container,c=OLe.m00*o,l=OLe.m01,u=OLe.m04,h=OLe.m05*a;this._wrapper.style.width=n+"px",this._wrapper.style.height=i+"px";var f=this._w*o,_=this._h*a,p=f*OLe.m00*this._uiTrans.anchorX,d=_*OLe.m05*this._uiTrans.anchorY,m=s&&s.style.paddingLeft?parseInt(s.style.paddingLeft):0,v=s&&s.style.paddingBottom?parseInt(s.style.paddingBottom):0,g="matrix("+c+","+-l+","+-u+","+h+","+(OLe.m12*o-p+m)+","+-(OLe.m13*a-d+v)+")";this._wrapper.style.transform=g,this._wrapper.style["-webkit-transform"]=g,this._forceUpdate=!1}}}},t}(vLe),NLe=function(){function e(){}return e.getImpl=function(e){return new MLe(e)},e}();u.internal.WebViewImplManager=NLe;var LLe=e("WebView",(gLe=mc("cc.WebView"),yLe=Oc(),xLe=Pc(),SLe=vc(RX),TLe=Fc(),bLe=Zc([kB]),ELe=Vc(),CLe=Fc(),gLe(ALe=yLe(ALe=xLe(ALe=SLe(ALe=wc((DLe=ILe=function(e){function t(){for(var t,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return ce(t=e.call.apply(e,[this].concat(i))||this,"_url",PLe,oe(t)),t._impl=null,ce(t,"webviewEvents",RLe,oe(t)),t}$(t,e);var n=t.prototype;return n.setJavascriptInterfaceScheme=function(e){this._impl&&this._impl.setJavascriptInterfaceScheme(e)},n.setOnJSCallback=function(e){this._impl&&this._impl.setOnJSCallback(e)},n.evaluateJS=function(e){this._impl&&this._impl.evaluateJS(e)},n.__preload=function(){this._impl=NLe.getImpl(this),this._impl.componentEventList.set(dLe.LOADING,this.onLoading.bind(this)),this._impl.componentEventList.set(dLe.LOADED,this.onLoaded.bind(this)),this._impl.componentEventList.set(dLe.ERROR,this.onError.bind(this)),this._impl.loadURL(this._url)},n.onLoading=function(){kB.emitEvents(this.webviewEvents,this,dLe.LOADING),this.node.emit(dLe.LOADING,this)},n.onLoaded=function(){kB.emitEvents(this.webviewEvents,this,dLe.LOADED),this.node.emit(dLe.LOADED,this)},n.onError=function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];kB.emitEvents(this.webviewEvents,this,dLe.ERROR,t),this.node.emit(dLe.ERROR,this,t)},n.onEnable=function(){this._impl&&this._impl.enable()},n.onDisable=function(){this._impl&&this._impl.disable()},n.onDestroy=function(){this._impl&&(this._impl.destroy(),this._impl=null)},n.update=function(){this._impl&&this._impl.syncMatrix()},Z(t,[{key:"url",get:function(){return this._url},set:function(e){this._url=e,this._impl&&this._impl.loadURL(e)}},{key:"nativeWebView",get:function(){return this._impl&&this._impl.webview||null}},{key:"state",get:function(){return this._impl?this._impl.state:dLe.NONE}}]),t}(th),ILe.EventType=dLe,PLe=le((wLe=DLe).prototype,"_url",[Tc],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return"https://cocos.com"}}),le(wLe.prototype,"url",[TLe],Object.getOwnPropertyDescriptor(wLe.prototype,"url"),wLe.prototype),RLe=le(wLe.prototype,"webviewEvents",[Tc,bLe,ELe,CLe],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return[]}}),ALe=wLe))||ALe)||ALe)||ALe)||ALe)||ALe));u.internal.WebView=LLe}}}));
